<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestra | Structured Trading Intelligence Platform</title>
    <meta name="description" content="Vestra is a professional trading simulation platform. Practice with $100,000 virtual cash, real-time market data, strategy analysis, and competitive leaderboards â€” all with zero financial risk.">
    <meta name="keywords" content="trading simulator, stock market practice, paper trading, trading education, investment simulation">
    <meta name="robots" content="index, follow">
    <meta name="author" content="Vestra">
    <!-- Open Graph -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="Vestra | Structured Trading Simulation Platform">
    <meta property="og:description" content="Practice trading with $100,000 virtual cash. Real stocks, real data, zero risk. Build your edge before it costs you a cent.">
    <meta property="og:site_name" content="Vestra">
    <meta property="og:image" content="https://vestra.app/og-image.png">
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Vestra | Structured Trading Simulation Platform">
    <meta name="twitter:description" content="Practice trading with real stocks and zero risk. Build strategies, compete, improve.">
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a0a0f'/><text y='.9em' font-size='80' x='10'>ğŸ“ˆ</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%230a0a0f'/><text y='.9em' font-size='80' x='10'>ğŸ“ˆ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --v-bg: #0a0a0f;
            --v-surface: #111118;
            --v-card: #1a1a24;
            --v-border: rgba(255,255,255,0.12);
            --v-gold: #d4a84b;
            --v-gold-light: #f0c96a;
            --v-green: #22c55e;
            --v-red: #ef4444;
            --v-text: #f5f5fa;
            --v-muted: #a0a0b8;
            --v-serif: 'DM Serif Display', serif;
            --v-sans: 'DM Sans', sans-serif;
            --v-mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; }
        body { font-family: var(--v-sans); background: var(--v-bg); color: var(--v-text); overflow-x: hidden; }
        .vestra-brand { font-family: var(--v-serif); }

        /* â”€â”€ Homepage â”€â”€ */
        #homePage { display: block; }
        #appPage  { display: none; }

        /* Hero gradient orbs */
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); pointer-events: none;
        }

        /* Nav */
        .home-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            padding: 0 48px; height: 72px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(10,10,15,0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .home-nav .logo { font-family: var(--v-serif); font-size: 1.75rem; color: #ffffff; }
        .nav-btn {
            padding: 9px 22px; border-radius: 8px; font-family: var(--v-sans);
            font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
            border: none;
        }
        .nav-btn-ghost { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2) !important; color: #e0e0f0; }
        .nav-btn-ghost:hover { background: rgba(255,255,255,0.12); border-color: var(--v-gold) !important; color: var(--v-gold); }
        .nav-btn-gold { background: var(--v-gold); color: #0a0a0f; font-weight: 700; }
        .nav-btn-gold:hover { background: var(--v-gold-light); }

        /* Sections */
        section { position: relative; z-index: 1; }

        /* Feature cards */
        .feat-card {
            background: #1e1e2a; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 32px; transition: all 0.3s;
        }
        .feat-card h3 { color: #ffffff; }
        .feat-card p  { color: #b0b0c8; }
        .feat-card:hover { border-color: rgba(212,168,75,0.4); transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

        /* Ticker tape */
        .ticker-wrap { overflow: hidden; background: #0e0e16; border-top: 1px solid rgba(255,255,255,0.08); border-bottom: 1px solid rgba(255,255,255,0.08); }
        .ticker { display: flex; animation: tickerScroll 40s linear infinite; white-space: nowrap; }
        .ticker:hover { animation-play-state: paused; }
        @keyframes tickerScroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }

        /* Stats counter */
        .stat-num { font-family: var(--v-serif); font-size: 3rem; color: var(--v-gold); line-height: 1; }
        .stat-label { color: #9090aa; margin-top: 8px; font-size: 0.9rem; }

        /* Step circles */
        .step-num {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(212,168,75,0.1);
            border: 1.5px solid var(--v-gold); color: var(--v-gold);
            font-family: var(--v-serif); font-size: 1.25rem;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* Gold divider */
        .gold-line { height: 1px; background: linear-gradient(90deg, transparent, rgba(212,168,75,0.5), transparent); }

        /* â”€â”€ Theme system â”€â”€ */
        body.theme-midnight { --v-bg:#080810; --v-surface:#0e0e1a; --v-card:#161626; --v-border:rgba(120,120,200,0.15); --v-gold:#c9a84b; }
        body.theme-graphite { --v-bg:#0d0d0d; --v-surface:#131313; --v-card:#1c1c1c; --v-border:rgba(255,255,255,0.1); --v-gold:#d4a84b; }
        body.theme-arctic  { --v-bg:#090f18; --v-surface:#0e1620; --v-card:#141e2c; --v-border:rgba(96,165,250,0.15); --v-gold:#60a5fa; }
        body.theme-emerald { --v-bg:#080f0c; --v-surface:#0e1812; --v-card:#141f18; --v-border:rgba(52,211,153,0.15); --v-gold:#34d399; }

        /* â”€â”€ Skeleton loaders â”€â”€ */
        @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }

        /* â”€â”€ Number animation â”€â”€ */
        .num-anim { transition: color 0.4s, opacity 0.3s; }
        .num-flash-green { animation: flashGreen 0.6s ease; }
        .num-flash-red   { animation: flashRed   0.6s ease; }
        @keyframes flashGreen { 0%,100%{color:inherit} 50%{color:#4ade80} }
        @keyframes flashRed   { 0%,100%{color:inherit} 50%{color:#f87171} }

        /* â”€â”€ Modal entrance â”€â”€ */
        @keyframes modalIn { from{opacity:0;transform:scale(0.96) translateY(12px)} to{opacity:1;transform:scale(1) translateY(0)} }
        .modal-anim { animation: modalIn 0.28s cubic-bezier(0.16,1,0.3,1); }

        /* â”€â”€ Silent Focus Mode overlay â”€â”€ */
        #focusModeBar {
            display:none; position:fixed; top:0; left:0; right:0; z-index:10100;
            background:linear-gradient(90deg,#0a0a0f,#111118,#0a0a0f);
            border-bottom:1px solid rgba(212,168,75,0.2);
            padding:10px 24px; align-items:center; justify-content:space-between;
        }
        body.focus-mode #focusModeBar { display:flex; }
        body.focus-mode .pl-value { filter:blur(8px); pointer-events:none; transition:filter 0.3s; }
        body.focus-mode .pl-value:hover { filter:blur(0); }
        body.focus-mode #leaderSection { opacity:0.15; pointer-events:none; }

        /* â”€â”€ Regime badge â”€â”€ */
        .regime-badge {
            display:inline-flex; align-items:center; gap:5px;
            padding:3px 9px; border-radius:20px; font-size:10px; font-weight:700;
            background:rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.1);
        }

        /* â”€â”€ Strategy equity curve â”€â”€ */
        .equity-sparkline { height:40px; overflow:hidden; }

        /* â”€â”€ Decision timeline â”€â”€ */
        .decision-dot {
            width:10px; height:10px; border-radius:50%; border:2px solid;
            cursor:pointer; transition:transform 0.2s;
            flex-shrink:0;
        }
        .decision-dot:hover { transform:scale(1.6); }

        /* â”€â”€ Capital allocator bars â”€â”€ */
        .alloc-bar {
            height:8px; border-radius:4px; transition:width 0.4s cubic-bezier(0.4,0,0.2,1);
        }

        /* â”€â”€ Stress test pulse â”€â”€ */
        @keyframes stressPulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .stress-running { animation: stressPulse 0.8s infinite; }

        /* â”€â”€ Contextual Tooltips â”€â”€ */
        .v-tooltip {
            position: relative;
            display: inline-flex;
            align-items: center;
        }
        .v-tooltip-icon {
            width: 14px; height: 14px; border-radius: 50%;
            background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15);
            color: #8888a8; font-size: 9px; font-weight: 700;
            display: inline-flex; align-items: center; justify-content: center;
            cursor: help; margin-left: 4px; flex-shrink: 0;
            transition: all 0.15s;
        }
        .v-tooltip-icon:hover { background: rgba(212,168,75,0.15); border-color: var(--v-gold); color: var(--v-gold); }
        .v-tooltip-popup {
            position: absolute; bottom: calc(100% + 8px); left: 50%; transform: translateX(-50%);
            background: #1a1a2e; border: 1px solid rgba(212,168,75,0.25);
            border-radius: 10px; padding: 10px 13px; width: 220px; z-index: 9999;
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
            box-shadow: 0 12px 36px rgba(0,0,0,0.5);
        }
        .v-tooltip-popup::after {
            content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 8px; background: #1a1a2e;
            border-right: 1px solid rgba(212,168,75,0.25); border-bottom: 1px solid rgba(212,168,75,0.25);
            transform: translateX(-50%) rotate(45deg);
        }
        .v-tooltip:hover .v-tooltip-popup { opacity: 1; pointer-events: auto; }
        .v-tooltip-title { font-size: 11px; font-weight: 700; color: var(--v-gold); margin-bottom: 4px; }
        .v-tooltip-body { font-size: 10px; color: #a0a0c0; line-height: 1.55; }
        .v-tooltip-improve { font-size: 9px; color: #4ade80; margin-top: 5px; font-style: italic; }

        /* â”€â”€ Feature Hint Banner â”€â”€ */
        #featureHintBanner {
            position: fixed; bottom: 24px; right: 24px; z-index: 9990;
            background: #1a1a2e; border: 1px solid rgba(212,168,75,0.3);
            border-radius: 14px; padding: 14px 18px; max-width: 300px;
            box-shadow: 0 16px 40px rgba(0,0,0,0.5);
            animation: slideUp 0.35s cubic-bezier(0.16,1,0.3,1);
            display: none;
        }
        #featureHintBanner.visible { display: block; }

        /* â”€â”€ Data freshness indicator â”€â”€ */
        .data-fresh { color: #4ade80; }
        .data-stale { color: #f59e0b; }
        .data-old   { color: #f87171; }

        /* Footer */
        footer { position: relative; z-index: 1; border-top: 1px solid rgba(255,255,255,0.08); }
        .footer-col-head {
            font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase;
            color: #8888a8; margin: 0 0 16px;
        }
        .footer-link {
            display: block; font-size: 13px; color: #7070a0; text-decoration: none;
            padding: 3px 0; transition: color 0.15s; cursor: pointer; background: none; border: none;
            text-align: left; font-family: var(--v-sans); line-height: 1.4;
        }
        .footer-link:hover, .footer-link:focus { color: var(--v-gold); outline: none; }
        .footer-link:focus-visible { outline: 2px solid var(--v-gold); border-radius: 2px; }
        .footer-divider { height: 1px; background: rgba(255,255,255,0.07); margin: 32px 0; }
        .footer-legal-text { font-size: 11px; color: #4a4a6a; line-height: 1.7; }
        .status-dot { width: 7px; height: 7px; border-radius: 50%; background: #22c55e; display: inline-block; margin-right: 5px; animation: pulse-green 2.5s infinite; }
        /* Legal page overlays */
        .legal-overlay {
            display: none; position: fixed; inset: 0; z-index: 9996;
            background: rgba(0,0,0,0.9); backdrop-filter: blur(16px);
            align-items: flex-start; justify-content: center;
            overflow-y: auto; padding: 40px 20px;
        }
        .legal-sheet {
            background: #0e0e16; border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px; width: 100%; max-width: 720px;
            margin: 0 auto 40px; overflow: hidden;
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        .legal-header {
            padding: 28px 36px 22px; border-bottom: 1px solid rgba(255,255,255,0.07);
            display: flex; justify-content: space-between; align-items: flex-start;
            position: sticky; top: 0; background: #0e0e16; z-index: 2;
        }
        .legal-body {
            padding: 28px 36px 40px; font-size: 13.5px; color: #a0a0c0;
            line-height: 1.85;
        }
        .legal-body h2 { font-family: var(--v-serif); font-size: 1.1rem; color: #e0e0f5; margin: 24px 0 8px; }
        .legal-body h2:first-of-type { margin-top: 0; }
        .legal-body p { margin: 0 0 12px; }
        .legal-body ul { margin: 0 0 12px 20px; padding: 0; }
        .legal-body li { margin-bottom: 5px; }
        .legal-body a { color: var(--v-gold); text-decoration: none; }
        .legal-body a:hover { text-decoration: underline; }
        .legal-body .highlight-box {
            background: rgba(212,168,75,0.06); border: 1px solid rgba(212,168,75,0.18);
            border-radius: 8px; padding: 12px 16px; margin: 16px 0; font-size: 13px; color: #d0c090;
        }
        /* Sitemap */
        .sitemap-group { margin-bottom: 24px; }
        .sitemap-group-title { font-size: 10px; font-weight: 700; color: #8888a8; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 10px; }
        .sitemap-link { display: inline-flex; align-items: center; gap: 6px; color: #9090b8; font-size: 13px; text-decoration: none; padding: 4px 10px; border-radius: 5px; transition: all 0.15s; cursor: pointer; background: none; border: none; font-family: var(--v-sans); }
        .sitemap-link:hover { color: var(--v-gold); background: rgba(212,168,75,0.08); }
        /* Contact form */
        .contact-field { width: 100%; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; padding: 11px 14px; font-size: 13px; color: #e0e0f5; outline: none; font-family: var(--v-sans); transition: border-color 0.15s; }
        .contact-field:focus { border-color: var(--v-gold); }
        .contact-field::placeholder { color: #6060a0; }
        .social-link {
            display: inline-flex; align-items: center; gap: 10px;
            color: #9090aa; text-decoration: none; font-size: 0.875rem;
            transition: color 0.2s; padding: 8px 0;
        }
        .social-link:hover { color: var(--v-gold); }
        .social-icon { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); color: #b0b0c8; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .social-link:hover .social-icon { border-color: var(--v-gold); color: var(--v-gold); }

        /* â”€â”€ App UI â”€â”€ */
        .app-header {
            background: var(--v-surface); border-bottom: 1px solid var(--v-border);
            position: sticky; top: 0; z-index: 50;
        }
        .g-card {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 12px; transition: box-shadow 0.2s, border-color 0.2s, transform 0.1s;
        }
        .g-card:hover { border-color: rgba(201,168,76,0.3); box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
        .search-bar {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 24px; transition: 0.2s;
        }
        .search-bar:focus-within { border-color: var(--v-gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
        .search-bar input { color: var(--v-text); }
        .search-bar input::placeholder { color: var(--v-muted); }
        .btn-google { background: var(--v-gold); color: #0a0a0f; border-radius: 8px; font-weight: 600; padding: 8px 20px; transition: 0.2s; }
        .btn-google:hover { background: var(--v-gold-light); }
        .btn-outline { border: 1px solid var(--v-border); color: var(--v-muted); border-radius: 8px; font-weight: 500; padding: 8px 20px; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--v-gold); color: var(--v-gold); }
        .change-pill { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; font-family: var(--v-mono); display: inline-flex; align-items: center; }
        .pill-up   { background: rgba(34,197,94,0.12);  color: #4ade80; }
        .pill-down { background: rgba(239,68,68,0.12);  color: #f87171; }
        .badge-live  { background: rgba(34,197,94,0.15); color: #4ade80; }
        .badge-sim   { background: var(--v-card); color: var(--v-muted); }
        .badge-stale { background: rgba(201,168,76,0.12); color: var(--v-gold); }
        .dot-live    { background: #22c55e; animation: pulse-green 2s infinite; }
        .dot-closed  { background: #ef4444; }
        .dot-unknown { background: #6b7280; }
        @keyframes pulse-green { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* Tutorial overlay */
        #tutorialOverlay { position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; }
        #tutorialOverlay.hidden { display:none; }
        .tutorial-card { background: var(--v-card); border:1px solid rgba(201,168,76,0.3); border-radius:20px; width:520px; max-width:90vw; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,0.7); animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1); }
        .tutorial-progress-bar  { height:3px; background:var(--v-border); }
        .tutorial-progress-fill { height:3px; background:linear-gradient(90deg,var(--v-gold),var(--v-gold-light)); transition:width 0.5s cubic-bezier(0.16,1,0.3,1); }

        /* App sidebar */
        #appSidebar { background: var(--v-surface); border-left: 1px solid var(--v-border); }
        #appSidebar h3 { color: var(--v-text); }
        #portfolioList .port-val { color: var(--v-text); }

        /* Scrollbar */
        .sidebar-scroll { height: calc(100vh - 200px); overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--v-border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(201,168,76,0.3); }

        /* Animations */
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
        @keyframes flash-green { 0%{background:rgba(34,197,94,0.15)} 100%{background:transparent} }
        @keyframes flash-red   { 0%{background:rgba(239,68,68,0.15)} 100%{background:transparent} }
        @keyframes heroFade { from{opacity:0;transform:translateY(32px)} to{opacity:1;transform:translateY(0)} }
        @keyframes numberFlip { 0%{transform:translateY(-8px);opacity:0} 100%{transform:translateY(0);opacity:1} }
        @keyframes shimmer { 0%{background-position:-200% 0} 100%{background-position:200% 0} }
        @keyframes borderGlow { 0%,100%{border-color:rgba(212,168,75,0.2)} 50%{border-color:rgba(212,168,75,0.6)} }
        .skeleton {
            background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 6px;
        }
        .mode-standard-glow { box-shadow: 0 0 0 1px rgba(212,168,75,0.15), inset 0 1px 0 rgba(212,168,75,0.08); }
        .mode-realism-glow  { box-shadow: 0 0 0 1px rgba(96,165,250,0.15), inset 0 1px 0 rgba(96,165,250,0.08); }
        .heatmap-cell {
            height: 24px; border-radius: 4px; display: flex; align-items: center; justify-content: center;
            font-size: 8px; font-weight: 700; cursor: default; transition: transform 0.15s;
        }
        .heatmap-cell:hover { transform: scale(1.15); }
        .tier-badge {
            display: inline-flex; align-items: center; gap: 3px;
            padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700;
        }
        .coach-insight {
            background: rgba(167,139,250,0.06);
            border-left: 2px solid rgba(167,139,250,0.4);
            border-radius: 0 6px 6px 0;
            padding: 6px 10px;
            margin-bottom: 6px;
            font-size: 11px;
            line-height: 1.55;
            color: #c0c0d8;
            animation: slideUp 0.3s ease-out;
        }
        /* Theme variations */
        body.theme-blue {
            --v-bg: #050d1a; --v-surface: #0a1628; --v-card: #0f1e38;
            --v-border: rgba(96,165,250,0.15); --v-gold: #60a5fa;
            --v-gold-light: #93c5fd; --v-text: #e0f0ff; --v-muted: #7eaad4;
        }
        body.theme-green {
            --v-bg: #020f06; --v-surface: #061410; --v-card: #0c1e14;
            --v-border: rgba(34,197,94,0.15); --v-gold: #22c55e;
            --v-gold-light: #4ade80; --v-text: #e0ffe8; --v-muted: #72c98a;
        }
        body.theme-white {
            --v-bg: #f8f8fc; --v-surface: #ffffff; --v-card: #f0f0f8;
            --v-border: rgba(0,0,0,0.1); --v-gold: #1a73e8;
            --v-gold-light: #4285f4; --v-text: #0d0d1a; --v-muted: #606080;
        }
        .theme-opt {
            display:block; width:100%; text-align:left; background:none; border:none;
            color:#c0c0d8; font-size:12px; padding:7px 10px; border-radius:6px;
            cursor:pointer; font-family:var(--v-sans); transition:background 0.1s;
        }
        .theme-opt:hover { background:rgba(255,255,255,0.06); }
        body.theme-white .theme-opt:hover { background:rgba(0,0,0,0.04); }
        .notif-item {
            padding:10px 14px; border-bottom:1px solid rgba(255,255,255,0.05);
            display:flex;align-items:flex-start;gap:10px;transition:background 0.1s;
            cursor:default;
        }
        .notif-item:hover { background:rgba(255,255,255,0.03); }
        .notif-item:last-child { border-bottom:none; }
        .notif-dot { width:6px;height:6px;border-radius:50%;flex-shrink:0;margin-top:4px; }
        /* RG violation pulse */
        @keyframes rgViolation { 0%,100%{border-color:rgba(239,68,68,0.3)} 50%{border-color:rgba(239,68,68,0.8)} }
        .rg-violation { animation:rgViolation 1s infinite; }
        /* Positive streak glow on P&L */
        @keyframes plGlow { 0%,100%{text-shadow:none} 50%{text-shadow:0 0 12px rgba(74,222,128,0.5)} }
        .pl-streak-glow { animation:plGlow 2s infinite; }
        /* API health dot blink */
        @keyframes apiBlink { 0%,100%{opacity:1} 50%{opacity:0.4} }
        #apiHealthDot.live { animation:apiBlink 2s infinite; }
        /* Macro sector heat cells */
        .sector-heat-cell {
            border-radius:8px; padding:12px 8px; text-align:center; cursor:default; transition:transform 0.15s;
        }
        .sector-heat-cell:hover { transform:scale(1.04); }
        /* Strategy tag badges */
        .strat-tag { font-size:10px; font-weight:700; padding:2px 7px; border-radius:4px; background:rgba(167,139,250,0.12); color:#a78bfa; }
        /* Number flip animation */
        .num-flip { animation:numberFlip 0.35s ease-out; }
        /* Replay bar */
        #replayBar { animation: slideUp 0.25s ease-out; }
        /* Number flip animation on values that update */
        .val-updated { animation: numberFlip 0.3s ease-out; }
        /* Floating P&L glow on winning streak */
        #floatingPL.winning { box-shadow: 0 0 16px rgba(74,222,128,0.2); border-color: rgba(74,222,128,0.25); }
        /* Macro modal */
        .sector-heat-cell div:first-child { font-size:8px; color:#c0c0d8; margin-bottom:2px; }
        #progressRiskChart > div { cursor:default; transition:height 0.3s ease; }
        #progressRiskChart > div:hover { filter:brightness(1.2); }
        #replaySpeed option, #tradeStrategyTag option { background:#1a1a24; color:#e0e0f5; }
        .loading-skeleton { background:linear-gradient(90deg,rgba(255,255,255,0.04) 25%,rgba(255,255,255,0.08) 50%,rgba(255,255,255,0.04) 75%); background-size:200% 100%; animation:shimmer 1.5s infinite; border-radius:8px; }
        .rg-blocked { animation:rgViolation 1s ease infinite; }
        @media (max-width:640px) {
            #macroModal > div, #strategyLabModal > div, #progressModal > div { border-radius:16px 16px 0 0; margin:auto 0 0 0; }
        }
        .flash-up   { animation: flash-green 0.8s ease-out; }
        .flash-down { animation: flash-red   0.8s ease-out; }
        .stock-price, .change-pill { transition: color 0.3s; }
        .anim-1 { animation: heroFade 0.8s 0.1s both; }
        .anim-2 { animation: heroFade 0.8s 0.3s both; }
        .anim-3 { animation: heroFade 0.8s 0.5s both; }
        .anim-4 { animation: heroFade 0.8s 0.7s both; }

        /* â”€â”€ Light Mode â”€â”€ */
        body.light-mode {
            --v-bg: #f0f2f5;
            --v-surface: #ffffff;
            --v-card: #ffffff;
            --v-border: rgba(0,0,0,0.09);
            --v-text: #0d0d1a;
            --v-muted: #525270;
            --v-gold: #8a6000;
            --v-gold-light: #b07800;
            --v-green: #16a34a;
            --v-red: #dc2626;
        }
        /* App shell */
        body.light-mode { background: #f0f2f5; color: #0d0d1a; }
        body.light-mode .g-card { background: #ffffff; border-color: rgba(0,0,0,0.08); box-shadow: 0 1px 6px rgba(0,0,0,0.07); }
        body.light-mode .app-header { background: #fff !important; border-color: rgba(0,0,0,0.09) !important; }
        body.light-mode .search-bar { background: #eef0f5; border-color: rgba(0,0,0,0.1); }
        body.light-mode .search-bar input { color: #0d0d1a; }
        body.light-mode input:not([type="range"]), body.light-mode select, body.light-mode textarea { background: #eef0f5 !important; color: #0d0d1a !important; border-color: rgba(0,0,0,0.12) !important; }
        /* Stock grid cards */
        body.light-mode [data-symbol] { background: #fff !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode .stock-sym { color: #1a1a2e !important; }
        body.light-mode .stock-price { color: #0d0d1a !important; }
        /* Sidebar */
        body.light-mode aside, body.light-mode #desktopSidebar { background: transparent; }
        body.light-mode #portfolioList > div { border-color: rgba(0,0,0,0.06) !important; }
        /* Headings / labels */
        body.light-mode [style*="color:#e0e0f5"], body.light-mode [style*="color:#f0f0fa"], body.light-mode [style*="color:#e8e8f5"] { color: #1a1a2e !important; }
        body.light-mode [style*="color:#c0c0d8"], body.light-mode [style*="color:#b0b0c8"], body.light-mode [style*="color:#a0a0b8"] { color: #525270 !important; }
        body.light-mode [style*="color:#8888a8"] { color: #7070a0 !important; }
        body.light-mode [style*="color:#606080"] { color: #8080a0 !important; }
        body.light-mode [style*="background:#0f0f18"], body.light-mode [style*="background:#1a1a24"], body.light-mode [style*="background:#1e1e28"] { background: #eef0f5 !important; }
        body.light-mode [style*="background:#0e0e16"] { background: #e8eaf0 !important; }
        body.light-mode [style*="background:rgba(255,255,255,0.03)"], body.light-mode [style*="background:rgba(255,255,255,0.04)"], body.light-mode [style*="background:rgba(255,255,255,0.06)"], body.light-mode [style*="background:rgba(255,255,255,0.08)"] { background: rgba(0,0,0,0.03) !important; }
        body.light-mode [style*="border:1px solid rgba(255,255,255,0.06)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.07)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.08)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.1)"] { border-color: rgba(0,0,0,0.08) !important; }
        /* Leaderboard + overlays */
        body.light-mode #leaderboardOverlay > div { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #apiConfigModal > div { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #journalModal > div { background: #fff !important; }
        body.light-mode .tutorial-card { background: #fff !important; }
        /* Stock detail page */
        body.light-mode #stockDetailPage { background: #f0f2f5 !important; }
        body.light-mode #stockDetailPage .bg-\[\#1c1c1e\] { background: #f0f2f5 !important; }
        body.light-mode #stockDetailPage .bg-\[\#2c2c2e\] { background: #ffffff !important; }
        body.light-mode #stockDetailPage .bg-\[\#1e1e28\] { background: #ffffff !important; }
        body.light-mode #stockDetailPage .border-gray-700 { border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #stockDetailPage .text-gray-400, body.light-mode #stockDetailPage .text-gray-500 { color: #6060a0 !important; }
        body.light-mode #stockDetailPage .text-white, body.light-mode #stockDetailPage .text-gray-800, body.light-mode #stockDetailPage .text-gray-900 { color: #0d0d1a !important; }
        body.light-mode #stockDetailPage select, body.light-mode #stockDetailPage input { background: #eef0f5 !important; color: #0d0d1a !important; border-color: rgba(0,0,0,0.15) !important; }
        /* Toast */
        body.light-mode #themeToggle { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
        /* News feed cards */
        body.light-mode #newsFeed > div { background: #fff !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode #newsFeed > div > div[style*="color:#e0e0f5"] { color: #1a1a2e !important; }
        /* Analyst cards */
        body.light-mode #analystRatings, body.light-mode #earningsData > div, body.light-mode #similarStocks button { background: #eef0f5 !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode .analyst-bar { background: rgba(0,0,0,0.07) !important; }
        /* Scrollbar */
        body.light-mode ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); }

        /* â”€â”€ Search Dropdown â”€â”€ */
        #searchWrap { position: relative; flex: 1; max-width: 42rem; }
        #searchDropdown {
            position: absolute; top: calc(100% + 8px); left: 0; right: 0; z-index: 999;
            background: #1a1a24; border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 420px; overflow-y: auto;
        }
        body.light-mode #searchDropdown { background: #fff; border-color: rgba(0,0,0,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
        .search-result-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; cursor: pointer; transition: background 0.1s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(255,255,255,0.06); }
        body.light-mode .search-result-item:hover { background: #f4f4f8; }
        body.light-mode .search-result-item { border-color: rgba(0,0,0,0.05); }

        /* â”€â”€ Market Countdown â”€â”€ */
        #marketCountdown {
            font-size: 11px; font-weight: 700; font-family: var(--v-mono);
            color: var(--v-muted); letter-spacing: 0.03em;
        }

        /* â”€â”€ Portfolio Performance Chart â”€â”€ */
        #perfChartWrap { position: relative; height: 160px; margin-top: 8px; }

        /* â”€â”€ Mobile Layout â”€â”€ */
        #mobileNav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
            background: #111118; border-top: 1px solid rgba(255,255,255,0.08);
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
        }
        body.light-mode #mobileNav { background: #fff; border-color: rgba(0,0,0,0.1); }
        .mob-nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 3px;
            background: none; border: none; color: #8888a8; cursor: pointer;
            font-size: 10px; font-weight: 600; font-family: var(--v-sans); flex: 1;
            padding: 4px 0; transition: color 0.15s;
        }
        .mob-nav-btn.active { color: var(--v-gold); }
        .mob-nav-btn svg { width: 20px; height: 20px; }

        /* â”€â”€ Journal Modal â”€â”€ */
        #journalModal {
            position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px); display: none;
            align-items: center; justify-content: center;
        }
        #journalModal.open { display: flex; }

        /* â”€â”€ Analyst / Similar â”€â”€ */
        .analyst-bar { height: 6px; border-radius: 3px; background: rgba(255,255,255,0.08); overflow: hidden; margin-top: 4px; }
        .analyst-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 900px) {
            /* Landing page */
            #heroGrid { grid-template-columns: 1fr !important; gap: 40px !important; padding: 80px 24px 40px !important; text-align: center; }
            #heroRight { display: none; }
            #heroLeft .anim-4 { justify-content: center; }
            #heroMiniStats { justify-content: center; }
            #featuresGrid { grid-template-columns: 1fr !important; }
            #featuresGrid .feat-card:first-child { grid-column: span 1 !important; }
            #howGrid { grid-template-columns: 1fr 1fr !important; }
            .home-nav { padding: 0 20px; }
            .home-nav .logo { font-size: 1.4rem; }
            footer > div > div:first-child { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 900px) {
            #mobileNav { display: flex; }
            #appMain { padding-bottom: 80px !important; grid-template-columns: 1fr !important; }
            #appMain > div:first-child { border-right: none !important; }
            #desktopSidebar { display: none !important; }
        }
        @media (max-width: 768px) {
            .app-header { padding: 0 12px !important; }
            #searchWrap { max-width: 200px !important; }
            #marketCountdown { display: none; }
        }
        @media (min-width: 769px) {
            #mobilePortfolioView { display: none; }
        }
        /* light mode overrides for more menu */
        body.light-mode #moreMenu { background: #fff; border-color: rgba(0,0,0,0.1); }
        body.light-mode #moreMenu button { color: #1a1a2e; }

        /* â”€â”€ Indicator toggle buttons â”€â”€ */
        .ind-btn {
            font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;
            border:1px solid rgba(255,255,255,0.1);background:transparent;
            color:#8888a8;cursor:pointer;transition:all 0.15s;font-family:var(--v-sans);
        }
        .ind-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
        /* â”€â”€ SIP Modal styles â”€â”€ */
        #sipModal input:focus, #sipModal select:focus { border-color:var(--v-gold) !important; outline:none; }
        .sip-type-tab { transition:all 0.15s; }
        .sip-type-tab.active { background:rgba(212,168,75,0.12);color:var(--v-gold);border-bottom:2px solid var(--v-gold); }
        /* â”€â”€ Chart toolbar light mode â”€â”€ */
        body.light-mode #chartOuter { background:#ffffff; }
        body.light-mode .ctab { color:#555570; }
        /* â”€â”€ Chart indicator + interval buttons â”€â”€ */
        .ind-btn {
            font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;cursor:pointer;
            border:1px solid rgba(255,255,255,0.1);background:transparent;color:#8888a8;
            transition:all 0.15s;white-space:nowrap;
        }
        .ind-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
        .itv-btn {
            font-size:9px;font-weight:600;padding:3px 8px;cursor:pointer;
            border:none;background:transparent;color:#6868a0;
            border-radius:4px;transition:all 0.15s;white-space:nowrap;
        }
        .itv-btn:hover { color:#e0e0f5;background:rgba(255,255,255,0.06); }
        .itv-active { background:rgba(138,180,248,0.12) !important;color:#8ab4f8 !important;font-weight:700 !important; }
        body.light-mode .itv-active { background:rgba(26,115,232,0.1) !important;color:#1a73e8 !important; }
        body.light-mode .ind-btn { color:#6060a0; }
        /* â”€â”€ New Feature Modals â”€â”€ */
        #screenerModal, #calendarModal, #communityModal, #educationModal, #botModal {
            font-family: var(--v-sans);
        }
        #screenerModal > div, #calendarModal > div, #communityModal > div,
        #educationModal > div, #botModal {
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        body.light-mode #screenerModal > div,
        body.light-mode #calendarModal > div,
        body.light-mode #communityModal > div,
        body.light-mode #educationModal > div,
        body.light-mode #botModal { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #screenerResults > div > div,
        body.light-mode #communityFeed > div,
        body.light-mode #educationContent > div > div { background: #f4f4f8 !important; border-color: rgba(0,0,0,0.07) !important; }
        /* Toolbar action buttons */
        .toolbar-btn { font-size:10px;font-weight:700;padding:4px 10px;border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#a0a0b8;transition:all 0.15s; }
        .toolbar-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
    </style>
</head>
<body class="overflow-x-hidden">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VESTRA HOMEPAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="homePage">

  <!-- â•â•â• NAV â•â•â• -->
  <nav class="home-nav">
    <div style="display:flex;align-items:center;gap:14px;">
      <div class="logo">Vestra</div>
      <div style="height:18px;width:1px;background:rgba(255,255,255,0.15);"></div>
      <div style="font-size:10px;color:#6868a0;font-weight:600;letter-spacing:0.12em;text-transform:uppercase;">Intelligence Platform</div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="nav-btn nav-btn-ghost" onclick="showAuthFromHome('login')">Log In</button>
      <button class="nav-btn nav-btn-gold" onclick="showAuthFromHome('register')">Start Free â†’</button>
    </div>
  </nav>

  <!-- â•â•â• HERO â•â•â• -->
  <section style="min-height:100vh;display:flex;align-items:center;padding:100px 48px 60px;overflow:hidden;position:relative;">
    <div style="position:absolute;inset:0;background-image:linear-gradient(rgba(255,255,255,0.022) 1px,transparent 1px),linear-gradient(90deg,rgba(255,255,255,0.022) 1px,transparent 1px);background-size:60px 60px;pointer-events:none;"></div>
    <div class="orb" style="width:900px;height:900px;background:radial-gradient(circle,rgba(201,168,76,0.07),transparent 60%);top:-350px;right:-250px;pointer-events:none;"></div>
    <div class="orb" style="width:500px;height:500px;background:radial-gradient(circle,rgba(96,165,250,0.04),transparent 65%);bottom:-100px;left:-80px;pointer-events:none;"></div>

    <div style="max-width:1200px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 420px;gap:72px;align-items:center;">
      <div class="anim-1">
        <div style="display:inline-flex;align-items:center;gap:8px;margin-bottom:24px;">
          <div style="width:6px;height:6px;background:#22c55e;border-radius:50%;animation:pulse-green 2s infinite;"></div>
          <span style="font-size:10px;color:#6868a0;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;">Trading Intelligence Platform Â· v6.0</span>
        </div>

        <h1 style="font-family:var(--v-serif);font-size:clamp(3rem,5vw,5.2rem);line-height:1.0;margin:0 0 10px;color:#f0f0fa;">Build Your<br>Trading Edge.</h1>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.3rem,2.2vw,2rem);color:var(--v-gold);font-weight:400;font-style:italic;margin:0 0 28px;line-height:1.2;">Without Risking a Dollar.</h2>

        <p style="font-size:1rem;color:#8888a8;line-height:1.8;margin:0 0 32px;max-width:480px;">Vestra is a structured trading intelligence environment. Simulate real markets, detect cognitive biases, enforce risk discipline, and measure long-term skill development â€” all with $100,000 in virtual capital.</p>

        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:36px;max-width:460px;">
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>Real-time market data</div>
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>AI cognitive bias detection</div>
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>Risk enforcement system</div>
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>Decision intelligence timeline</div>
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>Strategy stress testing</div>
          <div style="display:flex;align-items:center;gap:9px;font-size:12px;color:#a0a0b8;"><div style="width:18px;height:18px;border-radius:4px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:9px;color:var(--v-gold);">âœ“</div>Multi-asset simulation</div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:36px;">
          <button class="nav-btn nav-btn-gold" style="padding:14px 36px;font-size:0.95rem;border-radius:10px;" onclick="showAuthFromHome('register')">Start Trading Free â†’</button>
          <button class="nav-btn nav-btn-ghost" style="padding:14px 24px;font-size:0.95rem;border-radius:10px;" onclick="document.getElementById('homeFeaturesSection').scrollIntoView({behavior:'smooth'})">Explore Features</button>
        </div>

        <div style="display:flex;gap:28px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.06);flex-wrap:wrap;">
          <div style="font-size:11px;color:#5050a0;"><span style="color:#f0f0fa;font-weight:700;font-family:var(--v-mono);">500+</span> real stocks</div>
          <div style="font-size:11px;color:#5050a0;"><span style="color:#f0f0fa;font-weight:700;font-family:var(--v-mono);">$100K</span> starting capital</div>
          <div style="font-size:11px;color:#5050a0;"><span style="color:#f0f0fa;font-weight:700;font-family:var(--v-mono);">$0</span> financial risk</div>
          <div style="font-size:11px;color:#5050a0;"><span style="color:#4ade80;font-weight:700;">â— Live</span> market data</div>
        </div>
      </div>

      <!-- Right: App preview card -->
      <div class="anim-3" style="position:relative;">
        <div style="position:absolute;top:-18px;right:-16px;z-index:2;background:rgba(10,10,15,0.95);border:1px solid rgba(52,211,153,0.3);backdrop-filter:blur(10px);padding:10px 14px;border-radius:10px;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,0.4);">
          <div style="font-size:9px;font-weight:700;color:#34d399;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:3px;">Discipline Score</div>
          <div style="font-family:var(--v-mono);font-size:1.3rem;font-weight:700;color:#f0f0fa;">A <span style="font-size:0.8rem;color:#34d399;">84/100</span></div>
        </div>
        <div style="position:absolute;bottom:-12px;left:-14px;z-index:2;background:rgba(10,10,15,0.95);border:1px solid rgba(239,68,68,0.25);backdrop-filter:blur(10px);padding:9px 13px;border-radius:10px;white-space:nowrap;box-shadow:0 8px 24px rgba(0,0,0,0.4);">
          <div style="font-size:9px;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:2px;">ğŸ” Pattern Detected</div>
          <div style="font-size:11px;color:#e0e0f0;">Revenge trading risk â†‘</div>
        </div>
        <div style="background:linear-gradient(160deg,#141420,#0e0e18);border:1px solid rgba(255,255,255,0.1);border-radius:20px;padding:22px;box-shadow:0 40px 100px rgba(0,0,0,0.6);">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div><div style="font-family:var(--v-serif);font-size:1.1rem;color:#f0f0fa;">AAPL</div><div style="font-size:10px;color:#6868a0;margin-top:1px;">Apple Inc. Â· NASDAQ</div></div>
            <div style="text-align:right;"><div style="font-family:var(--v-mono);font-size:1.3rem;color:#f0f0fa;" id="heroPrice">$254.86</div><div style="font-size:11px;color:#4ade80;font-family:var(--v-mono);" id="heroChange">+1.24%</div></div>
          </div>
          <canvas id="heroChart" style="width:100%;height:100px;display:block;margin-bottom:14px;"></canvas>
          <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:14px;">
            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:4px;">Portfolio</div>
              <div style="font-family:var(--v-mono);font-size:0.9rem;color:#f0f0fa;">$103.2K</div>
              <div style="font-size:10px;color:#4ade80;">+3.2%</div>
            </div>
            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:4px;">Win Rate</div>
              <div style="font-family:var(--v-mono);font-size:0.9rem;color:#f0f0fa;">64%</div>
              <div style="font-size:10px;color:#4ade80;">â†‘ improving</div>
            </div>
            <div style="background:rgba(255,255,255,0.04);border-radius:8px;padding:10px;text-align:center;">
              <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:4px;">Regime</div>
              <div style="font-size:1rem;">ğŸ“ˆ</div>
              <div style="font-size:10px;color:#4ade80;">Trending</div>
            </div>
          </div>
          <div style="border-top:1px solid rgba(255,255,255,0.06);padding-top:12px;">
            <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Holdings</div>
            <div style="display:flex;flex-direction:column;gap:5px;">
              <div style="display:flex;justify-content:space-between;font-size:11px;align-items:center;"><div style="display:flex;align-items:center;gap:7px;"><div style="width:4px;height:4px;background:#4ade80;border-radius:50%;"></div><span style="color:#c0c0d8;font-weight:600;">AAPL</span></div><span style="color:#4ade80;font-family:var(--v-mono);">+2.1%</span></div>
              <div style="display:flex;justify-content:space-between;font-size:11px;align-items:center;"><div style="display:flex;align-items:center;gap:7px;"><div style="width:4px;height:4px;background:#4ade80;border-radius:50%;"></div><span style="color:#c0c0d8;font-weight:600;">NVDA</span></div><span style="color:#4ade80;font-family:var(--v-mono);">+5.8%</span></div>
              <div style="display:flex;justify-content:space-between;font-size:11px;align-items:center;"><div style="display:flex;align-items:center;gap:7px;"><div style="width:4px;height:4px;background:#f87171;border-radius:50%;"></div><span style="color:#c0c0d8;font-weight:600;">MSFT</span></div><span style="color:#f87171;font-family:var(--v-mono);">âˆ’0.4%</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- TICKER -->
  <div class="ticker-wrap" style="padding:10px 0;">
    <div class="ticker" id="homeTicker"><span id="tickerInner"></span><span id="tickerInner2"></span></div>
  </div>

  <!-- â•â•â• INTELLIGENCE STRIP â•â•â• -->
  <section style="padding:0 48px;background:#0b0b14;border-top:1px solid rgba(255,255,255,0.04);border-bottom:1px solid rgba(255,255,255,0.04);">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:grid;grid-template-columns:repeat(5,1fr);border-left:1px solid rgba(255,255,255,0.06);">
        <div style="padding:22px 20px;border-right:1px solid rgba(255,255,255,0.06);">
          <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;">Market Status</div>
          <div style="display:flex;align-items:center;gap:7px;"><div style="width:7px;height:7px;background:#22c55e;border-radius:50%;animation:pulse-green 2s infinite;"></div><span style="font-size:13px;font-weight:700;color:#4ade80;">NYSE Simulated</span></div>
          <div style="font-size:10px;color:#5050a0;margin-top:3px;">9:30â€“16:00 ET rules</div>
        </div>
        <div style="padding:22px 20px;border-right:1px solid rgba(255,255,255,0.06);">
          <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;">Data Source</div>
          <div style="font-size:13px;font-weight:700;color:#f0f0fa;">Finnhub API</div>
          <div style="font-size:10px;color:#5050a0;margin-top:3px;">Real prices, 15-sec refresh</div>
        </div>
        <div style="padding:22px 20px;border-right:1px solid rgba(255,255,255,0.06);">
          <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;">Asset Classes</div>
          <div style="font-size:13px;font-weight:700;color:#f0f0fa;">5 Markets</div>
          <div style="font-size:10px;color:#5050a0;margin-top:3px;">Equity Â· ETF Â· FX Â· Crypto Â· Comm.</div>
        </div>
        <div style="padding:22px 20px;border-right:1px solid rgba(255,255,255,0.06);">
          <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;">Starting Capital</div>
          <div style="font-family:var(--v-mono);font-size:13px;font-weight:700;color:var(--v-gold);">$100,000</div>
          <div style="font-size:10px;color:#5050a0;margin-top:3px;">Virtual â€” zero financial risk</div>
        </div>
        <div style="padding:22px 20px;border-right:1px solid rgba(255,255,255,0.06);">
          <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:7px;">Platform</div>
          <div style="font-size:13px;font-weight:700;color:#f0f0fa;">v7.0 Intelligence</div>
          <div style="font-size:10px;color:#5050a0;margin-top:3px;">AI Coach Â· Behavioral Engine</div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• FEATURES â•â•â• -->
  <section id="homeFeaturesSection" style="padding:96px 48px;">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:60px;">
        <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin:0 0 12px;">Built for Serious Skill Development</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(2rem,4vw,3.2rem);margin:0 0 16px;color:#f0f0fa;line-height:1.1;">A Trading Psychology Lab.<br>A Decision Intelligence Engine.</h2>
        <p style="font-size:1rem;color:#6868a0;max-width:560px;margin:0 auto;line-height:1.75;">Not a game. A structured professional training environment where every feature exists to improve a specific dimension of trading skill.</p>
      </div>

      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:16px;">
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#a78bfa,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ§ª</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Strategy Lab</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Create named strategies with defined rules. Track equity curves, drawdown, win rate, and R-multiple per strategy. Stress-test against adverse scenarios.</p>
          <div style="font-size:9px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.08em;">Strategy Â· Equity Curve Â· Stress Test</div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#34d399,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ§ </div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">AI Trade Coach</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Detects overtrading, revenge trading, recency bias, and loss aversion. Provides discipline scores, hold-time analysis, and position sizing trends.</p>
          <div style="font-size:9px;font-weight:700;color:#34d399;text-transform:uppercase;letter-spacing:0.08em;">Bias Detection Â· Discipline Â· Analytics</div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#f59e0b,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ›¡</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Risk Guard</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Define max risk per trade, daily loss limit, max positions. Hard enforcement disables trading on violation. Train discipline before real stakes.</p>
          <div style="font-size:9px;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:0.08em;">Enforcement Â· Daily Limits Â· Discipline</div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#fbbf24,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ—“</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Decision Timeline</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Plot every trade decision against your equity curve. See entry clustering heatmaps, decision log, and what regime each trade was made in.</p>
          <div style="font-size:9px;font-weight:700;color:#fbbf24;text-transform:uppercase;letter-spacing:0.08em;">Equity Curve Â· Regime Â· Heatmap</div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#60a5fa,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">â®</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Trade Replay</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Replay any trading day candle-by-candle. Use Mistake Replay to re-examine losing trades without the outcome â€” relearn from your worst decisions.</p>
          <div style="font-size:9px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:0.08em;">Replay Â· Mistake Analysis Â· Learning Loop</div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#818cf8,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ”•</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Silent Focus Mode</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Hide all P&amp;L during open positions. No leaderboard. No rank updates. Results revealed only on close. Train decision quality without outcome bias.</p>
          <div style="font-size:9px;font-weight:700;color:#818cf8;text-transform:uppercase;letter-spacing:0.08em;">Mindset Â· Process Â· Anti-anxiety</div>
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#22d3ee,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸŒ</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Multi-Asset Trading</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Trade across 5 asset classes: US equities, index/sector ETFs, commodities, major forex pairs, and crypto â€” each with realistic session rules.</p>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(96,165,250,0.1);color:#60a5fa;border:1px solid rgba(96,165,250,0.2);">ğŸ“¦ ETFs</span>
            <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(251,191,36,0.1);color:#fbbf24;border:1px solid rgba(251,191,36,0.2);">ğŸ— Commodities</span>
            <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(34,211,238,0.1);color:#22d3ee;border:1px solid rgba(34,211,238,0.2);">ğŸ’± Forex</span>
            <span style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;background:rgba(244,114,182,0.1);color:#f472b6;border:1px solid rgba(244,114,182,0.2);">â‚¿ Crypto</span>
          </div>
        </div>
        <div class="feat-card" style="position:relative;overflow:hidden;">
          <div style="position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,#f472b6,transparent);"></div>
          <div style="font-size:1.6rem;margin-bottom:14px;">ğŸ“Š</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Portfolio Analytics</h3>
          <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0 0 14px;">Sharpe ratio, Calmar ratio, max drawdown, profit factor, monthly P&amp;L heatmap, sector exposure, best/worst trades, SPY benchmark. Capital allocation simulator.</p>
          <div style="font-size:9px;font-weight:700;color:#f472b6;text-transform:uppercase;letter-spacing:0.08em;">Sharpe Â· Drawdown Â· Heatmap Â· Benchmark</div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• SKILL DEVELOPMENT â•â•â• -->
  <section style="padding:80px 48px;background:#0b0b14;border-top:1px solid rgba(255,255,255,0.04);">
    <div style="max-width:1200px;margin:0 auto;display:grid;grid-template-columns:1fr 1fr;gap:80px;align-items:center;">
      <div>
        <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin:0 0 14px;">Structured Skill Development</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0 0 20px;color:#f0f0fa;line-height:1.1;">From Reactive Trader<br>to Disciplined Practitioner.</h2>
        <p style="font-size:0.95rem;color:#6868a0;line-height:1.8;margin:0 0 28px;">Every tool targets a specific skill dimension. Progress is measured, visualised, and explained â€” so you know exactly what to improve and why.</p>
        <div style="display:flex;flex-direction:column;gap:14px;">
          <div style="display:flex;gap:14px;align-items:flex-start;">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;">ğŸ¯</div>
            <div><div style="font-size:13px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">Risk Control</div><div style="font-size:12px;color:#6868a0;line-height:1.6;">Learn to size positions correctly, enforce daily loss limits, and stop trading when rules are violated.</div></div>
          </div>
          <div style="display:flex;gap:14px;align-items:flex-start;">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;">ğŸ§˜</div>
            <div><div style="font-size:13px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">Emotional Discipline</div><div style="font-size:12px;color:#6868a0;line-height:1.6;">Identify revenge trading, recency bias, and emotional patterns before they cost real money.</div></div>
          </div>
          <div style="display:flex;gap:14px;align-items:flex-start;">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;">ğŸ“</div>
            <div><div style="font-size:13px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">Strategy Consistency</div><div style="font-size:12px;color:#6868a0;line-height:1.6;">Tag every trade to a named strategy. See what actually works across market regimes over time.</div></div>
          </div>
          <div style="display:flex;gap:14px;align-items:flex-start;">
            <div style="width:36px;height:36px;border-radius:8px;background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.2);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:16px;">ğŸ§­</div>
            <div><div style="font-size:13px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">Market Adaptability</div><div style="font-size:12px;color:#6868a0;line-height:1.6;">Understand your performance in trending vs range-bound vs high-volatility regimes.</div></div>
          </div>
        </div>
      </div>

      <!-- Discipline Score Card -->
      <div style="background:linear-gradient(160deg,#141420,#0e0e18);border:1px solid rgba(255,255,255,0.08);border-radius:20px;padding:28px;">
        <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:18px;">Long-Term Discipline Rating</div>
        <div style="display:flex;align-items:center;gap:20px;margin-bottom:22px;">
          <div style="text-align:center;"><div style="font-family:var(--v-serif);font-size:4rem;color:#4ade80;line-height:1;">A</div><div style="font-size:10px;color:#6868a0;">84/100</div></div>
          <div style="flex:1;"><div style="font-size:12px;color:#8888a8;margin-bottom:10px;line-height:1.6;">Calculated from risk control, drawdown management, emotional stability, and strategy adherence.</div><div style="font-size:11px;color:#4ade80;">â†‘ +7 points this month</div></div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;">
          <div><div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;"><span style="color:#8888a8;">Risk Control</span><span style="color:#4ade80;font-weight:700;">91%</span></div><div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="height:100%;width:91%;background:#4ade80;border-radius:3px;"></div></div></div>
          <div><div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;"><span style="color:#8888a8;">Drawdown Control</span><span style="color:#4ade80;font-weight:700;">78%</span></div><div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="height:100%;width:78%;background:#4ade80;border-radius:3px;"></div></div></div>
          <div><div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;"><span style="color:#8888a8;">Consistency</span><span style="color:#f59e0b;font-weight:700;">73%</span></div><div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="height:100%;width:73%;background:#f59e0b;border-radius:3px;"></div></div></div>
          <div><div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;"><span style="color:#8888a8;">Strategy Adherence</span><span style="color:#f59e0b;font-weight:700;">68%</span></div><div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="height:100%;width:68%;background:#f59e0b;border-radius:3px;"></div></div></div>
        </div>
        <div style="margin-top:16px;padding:12px;background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.15);border-radius:10px;">
          <div style="font-size:10px;color:#34d399;font-weight:700;margin-bottom:4px;">COACH INSIGHT</div>
          <div style="font-size:11px;color:#8888a8;line-height:1.6;">Strategy adherence is your weakest area. Try tagging every trade to a defined strategy â€” it forces intentional thinking before entry.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• CHALLENGE TIERS â•â•â• -->
  <section style="padding:80px 48px;">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:52px;">
        <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin:0 0 12px;">Structured Challenge Mode</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0 0 14px;color:#f0f0fa;">Progress Through Tiers. Earn Every Level.</h2>
        <p style="font-size:0.95rem;color:#6868a0;max-width:520px;margin:0 auto;line-height:1.75;">Fixed capital. Strict risk rules. Long-term rankings. Each tier demands higher discipline â€” not just better returns.</p>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:14px;">
        <div style="background:rgba(180,100,50,0.06);border:1px solid rgba(180,100,50,0.2);border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:10px;">ğŸ¥‰</div>
          <div style="font-weight:700;color:#cd7f32;font-size:1rem;margin-bottom:8px;">Cadet</div>
          <div style="font-size:11px;color:#8888a8;line-height:1.7;margin-bottom:10px;">$10K capital Â· 3% max risk Â· Learn the fundamentals of discipline</div>
          <div style="font-size:10px;color:#6868a0;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">Entry level â€” anyone can start</div>
        </div>
        <div style="background:rgba(150,150,170,0.06);border:1px solid rgba(150,150,170,0.2);border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:10px;">ğŸ¥ˆ</div>
          <div style="font-weight:700;color:#c0c0c0;font-size:1rem;margin-bottom:8px;">Analyst</div>
          <div style="font-size:11px;color:#8888a8;line-height:1.7;margin-bottom:10px;">$25K capital Â· 2% max risk Â· Prove consistent edge of +5%</div>
          <div style="font-size:10px;color:#6868a0;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">Requires disciplined execution</div>
        </div>
        <div style="background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.2);border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:10px;">ğŸ¥‡</div>
          <div style="font-weight:700;color:var(--v-gold);font-size:1rem;margin-bottom:8px;">Associate</div>
          <div style="font-size:11px;color:#8888a8;line-height:1.7;margin-bottom:10px;">$50K capital Â· 1.5% max risk Â· +10% with &lt;10% drawdown</div>
          <div style="font-size:10px;color:#6868a0;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">Professional-grade discipline required</div>
        </div>
        <div style="background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.2);border-radius:16px;padding:24px;text-align:center;">
          <div style="font-size:2rem;margin-bottom:10px;">ğŸ’</div>
          <div style="font-weight:700;color:#818cf8;font-size:1rem;margin-bottom:8px;">Portfolio Manager</div>
          <div style="font-size:11px;color:#8888a8;line-height:1.7;margin-bottom:10px;">$100K capital Â· 1% max risk Â· Elite risk-adjusted performance</div>
          <div style="font-size:10px;color:#6868a0;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">Near-zero tolerance for error</div>
        </div>
      </div>
      <div style="text-align:center;margin-top:32px;">
        <button class="nav-btn nav-btn-gold" style="padding:12px 32px;font-size:0.875rem;border-radius:10px;" onclick="showAuthFromHome('register')">Start at Cadet Tier â†’</button>
      </div>
    </div>
  </section>

  <!-- â•â•â• PLATFORM ARCHITECTURE â•â•â• -->
  <section style="padding:80px 48px;background:#09090f;border-top:1px solid rgba(255,255,255,0.04);">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:52px;">
        <p style="color:#60a5fa;font-size:0.7rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin:0 0 12px;">System Architecture</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0 0 14px;color:#f0f0fa;line-height:1.1;">How the Intelligence Platform Works</h2>
        <p style="font-size:0.95rem;color:#6868a0;max-width:560px;margin:0 auto;line-height:1.75;">Eight interconnected systems â€” each one designed to develop a specific dimension of professional trading skill.</p>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:1px;background:rgba(255,255,255,0.05);border-radius:16px;overflow:hidden;border:1px solid rgba(255,255,255,0.07);">
        <div style="background:#0d0d1a;padding:24px 20px;">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ§ª</div>
          <div style="font-size:12px;font-weight:700;color:#a78bfa;margin-bottom:6px;">Strategy Lab</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Name your strategies. Track their equity curves independently. Stress-test against adverse markets.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ§ </div>
          <div style="font-size:12px;font-weight:700;color:#34d399;margin-bottom:6px;">AI Behavioral Engine</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Detects revenge trading, overconfidence, loss aversion, and recency bias in your trade data.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ›¡</div>
          <div style="font-size:12px;font-weight:700;color:#f59e0b;margin-bottom:6px;">Risk Enforcement</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Hard limits on position size, daily loss, open positions. Violations logged. Trading disabled on breach.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ—“</div>
          <div style="font-size:12px;font-weight:700;color:#fbbf24;margin-bottom:6px;">Decision Timeline</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Every trade plotted on your equity curve with market regime labels and clustering heatmaps.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-top:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">â®</div>
          <div style="font-size:12px;font-weight:700;color:#60a5fa;margin-bottom:6px;">Replay Mode</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Replay any session candle-by-candle. Re-examine losing trades without knowing the outcome.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);border-top:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ”•</div>
          <div style="font-size:12px;font-weight:700;color:#818cf8;margin-bottom:6px;">Silent Focus Mode</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Hide P&amp;L while positions are open. Train process discipline without dollar-amount anxiety.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);border-top:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸŒ</div>
          <div style="font-size:12px;font-weight:700;color:#22d3ee;margin-bottom:6px;">Multi-Asset Engine</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Trade equities, ETFs, forex, commodities, and crypto with asset-specific behavior models.</div>
        </div>
        <div style="background:#0d0d1a;padding:24px 20px;border-left:1px solid rgba(255,255,255,0.05);border-top:1px solid rgba(255,255,255,0.05);">
          <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ“Š</div>
          <div style="font-size:12px;font-weight:700;color:#f472b6;margin-bottom:6px;">Analytics Engine</div>
          <div style="font-size:11px;color:#6060a0;line-height:1.65;">Sharpe, Calmar, Profit Factor, Expectancy, Risk of Ruin, rolling metrics, monthly heatmap.</div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• DATA TRANSPARENCY & CREDIBILITY â•â•â• -->
  <section style="padding:60px 48px;border-top:1px solid rgba(255,255,255,0.04);">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:48px;align-items:center;">
        <div>
          <p style="color:#4ade80;font-size:0.7rem;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin:0 0 12px;">Data Integrity &amp; Transparency</p>
          <h2 style="font-family:var(--v-serif);font-size:clamp(1.6rem,3vw,2.4rem);margin:0 0 18px;color:#f0f0fa;line-height:1.15;">Real Data.<br>Real Conditions.<br>Honest Simulation.</h2>
          <p style="font-size:0.95rem;color:#6868a0;line-height:1.8;margin:0 0 24px;">Vestra uses the Finnhub API for live market prices, refreshed every 15 seconds. Simulation mechanics are clearly disclosed â€” no fake fills, no manipulated outcomes.</p>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;align-items:center;gap:10px;font-size:12px;"><div style="width:7px;height:7px;background:#4ade80;border-radius:50%;flex-shrink:0;"></div><span style="color:#a0a0c0;">All prices from Finnhub.io real-time API</span></div>
            <div style="display:flex;align-items:center;gap:10px;font-size:12px;"><div style="width:7px;height:7px;background:#4ade80;border-radius:50%;flex-shrink:0;"></div><span style="color:#a0a0c0;">Order fills use realistic bid-ask spread simulation in Realism Mode</span></div>
            <div style="display:flex;align-items:center;gap:10px;font-size:12px;"><div style="width:7px;height:7px;background:#4ade80;border-radius:50%;flex-shrink:0;"></div><span style="color:#a0a0c0;">No real money, no real broker â€” purely virtual capital</span></div>
            <div style="display:flex;align-items:center;gap:10px;font-size:12px;"><div style="width:7px;height:7px;background:#4ade80;border-radius:50%;flex-shrink:0;"></div><span style="color:#a0a0c0;">NYSE market hours enforced in Realism Mode</span></div>
            <div style="display:flex;align-items:center;gap:10px;font-size:12px;"><div style="width:7px;height:7px;background:#4ade80;border-radius:50%;flex-shrink:0;"></div><span style="color:#a0a0c0;">All calculations (P&amp;L, Sharpe, drawdown) use standard formulas â€” disclosed in Help Center</span></div>
          </div>
        </div>
        <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.07);border-radius:20px;padding:28px;display:grid;gap:12px;">
          <div style="display:flex;justify-content:space-between;align-items:center;padding-bottom:12px;border-bottom:1px solid rgba(255,255,255,0.05);">
            <div style="font-size:12px;font-weight:700;color:#f0f0fa;">System Status</div>
            <div style="display:flex;align-items:center;gap:6px;"><div style="width:8px;height:8px;background:#22c55e;border-radius:50%;animation:pulse-green 2s infinite;"></div><span style="font-size:11px;color:#4ade80;font-weight:600;">All Systems Operational</span></div>
          </div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:5px;">Data Source</div>
              <div style="font-size:13px;font-weight:700;color:#f0f0fa;">Finnhub.io</div>
              <div style="font-size:10px;color:#4ade80;margin-top:2px;">Real-time API</div>
            </div>
            <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:5px;">Refresh Rate</div>
              <div style="font-size:13px;font-weight:700;color:#f0f0fa;">15 seconds</div>
              <div style="font-size:10px;color:#8888a8;margin-top:2px;">During market hours</div>
            </div>
            <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:5px;">Market Hours</div>
              <div style="font-size:13px;font-weight:700;color:#f0f0fa;">NYSE Rules</div>
              <div style="font-size:10px;color:#8888a8;margin-top:2px;">9:30â€“16:00 ET</div>
            </div>
            <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:14px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:5px;">Assets Covered</div>
              <div style="font-size:13px;font-weight:700;color:#f0f0fa;">500+ symbols</div>
              <div style="font-size:10px;color:#8888a8;margin-top:2px;">5 asset classes</div>
            </div>
          </div>
          <div style="background:rgba(212,168,75,0.05);border:1px solid rgba(212,168,75,0.15);border-radius:10px;padding:12px;">
            <div style="font-size:10px;color:#d4a84b;font-weight:700;margin-bottom:3px;">âš ï¸ Simulation Disclosure</div>
            <div style="font-size:10px;color:#8888a8;line-height:1.6;">This is a training simulation. No real money is involved. Market fills are approximated â€” not guaranteed at exact price.</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• HOW IT WORKS â•â•â• -->
  <section id="how" style="padding:80px 48px;background:#0b0b14;border-top:1px solid rgba(255,255,255,0.04);">
    <div style="max-width:1100px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:56px;">
        <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.13em;text-transform:uppercase;margin:0 0 10px;">Up and Running in Minutes</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0;color:#f0f0fa;">How Vestra Works</h2>
      </div>
      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;position:relative;">
        <div style="position:absolute;top:22px;left:12.5%;right:12.5%;height:1px;background:linear-gradient(90deg,rgba(201,168,76,0.5),rgba(201,168,76,0.1));pointer-events:none;"></div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">1</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Create Account</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Sign up in seconds. Instantly get $100K virtual cash and guided onboarding.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">2</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Connect Live Data</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Free <a href="https://finnhub.io" target="_blank" style="color:var(--v-gold);">Finnhub</a> API key â€” real prices update every 15 seconds.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">3</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Build Strategies</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Define entry/exit rules, risk %, and target R. Tag every trade. Let AI detect your patterns.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">4</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Measure Progress</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Track discipline scores, advance through tiers, compete on risk-adjusted leaderboards.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- â•â•â• CTA â•â•â• -->
  <section style="padding:100px 48px;text-align:center;position:relative;overflow:hidden;border-top:1px solid rgba(255,255,255,0.04);">
    <div class="orb" style="width:700px;height:700px;background:radial-gradient(circle,rgba(201,168,76,0.07),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);"></div>
    <div style="max-width:640px;margin:0 auto;position:relative;z-index:1;">
      <div style="display:inline-block;background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);border-radius:100px;padding:5px 16px;margin-bottom:22px;">
        <span style="font-size:10px;font-weight:700;color:var(--v-gold);letter-spacing:0.1em;text-transform:uppercase;">No credit card Â· No risk Â· No real money</span>
      </div>
      <h2 style="font-family:var(--v-serif);font-size:clamp(2.2rem,5vw,3.8rem);margin:0 0 18px;color:#f0f0fa;line-height:1.05;">Start Building Your<br>Trading Intelligence Today.</h2>
      <p style="color:#6868a0;font-size:1rem;line-height:1.8;margin:0 0 36px;">The only thing you lose is your excuses.</p>
      <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
        <button class="nav-btn nav-btn-gold" style="padding:16px 48px;font-size:1rem;border-radius:12px;" onclick="showAuthFromHome('register')">Create Free Account â†’</button>
        <button class="nav-btn nav-btn-ghost" style="padding:16px 24px;font-size:1rem;border-radius:12px;" onclick="showAuthFromHome('login')">Sign In</button>
      </div>
    </div>
  </section>

  <!-- â•â•â• FOOTER â•â•â• -->
  <footer style="padding:60px 48px 0;background:var(--v-surface);">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:grid;grid-template-columns:2fr 1fr 1fr 1fr;gap:48px;padding-bottom:48px;" id="footerGrid">
        <div>
          <div class="logo" style="font-size:1.8rem;margin-bottom:10px;">Vestra</div>
          <p style="font-size:12px;color:#8888a8;margin:0 0 6px;">Structured Trading Intelligence Platform.</p>
          <p style="font-size:11px;color:#5050a0;margin:0 0 20px;line-height:1.7;">A disciplined professional training environment. No real money. No broker. No financial risk. Pure skill development.</p>
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:14px;">
            <span class="status-dot"></span>
            <span style="font-size:11px;color:#4ade80;font-weight:600;" id="systemStatus">All Systems Operational</span>
          </div>
          <div style="display:flex;flex-direction:column;gap:7px;">
            <div style="display:inline-flex;align-items:center;gap:7px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:7px;padding:7px 12px;"><span style="font-size:14px;">ğŸ“</span><span style="font-size:10px;color:#8888a8;">Education &amp; Skill Development Platform</span></div>
            <div style="display:inline-flex;align-items:center;gap:7px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:7px;padding:7px 12px;"><span style="font-size:14px;">ğŸ”’</span><span style="font-size:10px;color:#8888a8;">Zero real money Â· Zero financial risk</span></div>
          </div>
        </div>
        <div>
          <p class="footer-col-head">Platform</p>
          <nav>
            <button class="footer-link" onclick="document.getElementById('authOverlay').style.display='flex'">Dashboard</button>
            <button class="footer-link" onclick="openLeaderboard()">Leaderboard</button>
            <button class="footer-link" onclick="openStrategyLab()">Strategy Lab</button>
            <button class="footer-link" onclick="openAICoach()">AI Coach</button>
            <button class="footer-link" onclick="openMacro()">Market Overview</button>
            <button class="footer-link" onclick="openCalendar()">Economic Calendar</button>
            <button class="footer-link" onclick="openAdvancedAnalytics()">Analytics</button>
            <button class="footer-link" onclick="openChallengeMode()">Challenges</button>
          </nav>
        </div>
        <div>
          <p class="footer-col-head">Legal</p>
          <nav>
            <button class="footer-link" onclick="openLegalPage('privacy')">Privacy Policy</button>
            <button class="footer-link" onclick="openLegalPage('terms')">Terms of Service</button>
            <button class="footer-link" onclick="openLegalPage('disclaimer')">Risk Disclaimer</button>
            <button class="footer-link" onclick="openLegalPage('competition')">Competition Rules</button>
            <button class="footer-link" onclick="openLegalPage('cookies')">Cookie Policy</button>
            <button class="footer-link" onclick="openLegalPage('sitemap')">Sitemap</button>
          </nav>
        </div>
        <div>
          <p class="footer-col-head">Company</p>
          <nav>
            <button class="footer-link" onclick="openLegalPage('about')">About Vestra</button>
            <button class="footer-link" onclick="openLegalPage('contact')">Contact Us</button>
            <button class="footer-link" onclick="openLegalPage('faq')">FAQ</button>
            <button class="footer-link" onclick="openRoadmap()">Roadmap & Updates</button>
            <a href="mailto:support@vestra.app" class="footer-link">support@vestra.app</a>
          </nav>
          <div style="margin-top:16px;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:6px;display:inline-block;">
            <span style="font-size:10px;color:#6060a0;font-family:var(--v-mono);">Vestra v6.0</span>
          </div>
          <p class="footer-col-head" style="margin-top:20px;">Connect</p>
          <div style="display:flex;flex-direction:column;gap:2px;">
            <a href="https://www.instagram.com/badeatorneto/?hl=en" target="_blank" rel="noopener noreferrer" class="footer-link" style="display:flex;align-items:center;gap:7px;">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>@badeatorneto</a>
            <a href="mailto:arush2011jain@gmail.com" class="footer-link" style="display:flex;align-items:center;gap:7px;">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>arush2011jain@gmail.com</a>
          </div>
        </div>
      </div>
      <div class="footer-divider"></div>
      <div style="padding-bottom:32px;">
        <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px 18px;margin-bottom:20px;max-width:820px;">
          <p class="footer-legal-text" style="margin:0;"><strong style="color:#8888a8;font-weight:600;">Important Notice:</strong> Vestra is a simulation platform only. No real money is involved. All portfolio values, trades, profits, and losses are entirely virtual. Vestra is not a broker-dealer, financial advisor, or investment platform. Nothing constitutes real financial advice or real financial transactions.</p>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
          <p class="footer-legal-text" style="margin:0;">Â© <span id="footerYear">2026</span> Vestra. All rights reserved. Simulation platform only.</p>
          <div style="display:flex;gap:16px;align-items:center;flex-wrap:wrap;">
            <span style="font-size:10px;color:#3a3a5a;">Data: Finnhub.io (when connected)</span>
            <button class="footer-link" style="font-size:11px;padding:0;" onclick="openLegalPage('privacy')">Privacy</button>
            <button class="footer-link" style="font-size:11px;padding:0;" onclick="openLegalPage('terms')">Terms</button>
            <button class="footer-link" style="font-size:11px;padding:0;" onclick="openLegalPage('disclaimer')">Disclaimer</button>
          </div>
        </div>
      </div>
    </div>
  </footer>

</div><!-- end #homePage -->


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â• LOGIN / REGISTER OVERLAY â•â•â• -->
<div id="authOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center" style="background:rgba(0,0,0,0.92);backdrop-filter:blur(16px);display:none;">
    <div style="background:var(--v-card);border:1px solid rgba(201,168,76,0.2);border-radius:20px;width:100%;max-width:440px;padding:40px;box-shadow:0 30px 100px rgba(0,0,0,0.6);position:relative;">
        <button onclick="document.getElementById('authOverlay').style.display='none'" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--v-muted);font-size:18px;cursor:pointer;line-height:1;" title="Close">âœ•</button>
        <div class="text-center" style="margin-bottom:28px;">
            <div style="font-family:var(--v-serif);font-size:2.5rem;color:var(--v-text);margin-bottom:6px;">Vestra</div>
            <div style="font-size:10px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:600;margin-bottom:20px;">Trading With No Risk</div>
            <h2 id="authTitle" style="font-size:1.3rem;font-weight:700;color:var(--v-text);margin:0 0 4px;">Sign In</h2>
            <p id="authSubtitle" style="color:var(--v-muted);font-size:0.875rem;margin:0;">to your trading account</p>
        </div>
        <div id="authError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div id="registerNameGroup" class="hidden" style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Display Name</label>
            <input id="authName" type="text" placeholder="e.g. TradingWolf99" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Username</label>
            <input id="authUser" type="text" placeholder="username" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Password</label>
            <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'" oninput="showPasswordStrength(this.value)">
            <div id="passwordStrengthBar"></div>
        </div>
        <button id="authSubmitBtn" onclick="handleAuthSubmit()" style="width:100%;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);transition:background 0.2s;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Sign In</button>
        <p style="text-align:center;font-size:13px;color:var(--v-muted);margin-top:16px;">
            <span id="authToggleText">Don't have an account?</span>
            <button onclick="toggleAuthMode()" id="authToggleBtn" style="color:var(--v-gold);font-weight:600;margin-left:4px;background:none;border:none;cursor:pointer;font-size:13px;font-family:var(--v-sans);">Create account</button>
        </p>
    </div>
</div>

<!-- â•â• SILENT FOCUS MODE BAR â•â• -->
<div id="focusModeBar">
    <div style="display:flex;align-items:center;gap:10px;">
        <span style="font-size:14px;">ğŸ¯</span>
        <span style="font-size:12px;font-weight:700;color:var(--v-gold);">Silent Focus Mode</span>
        <span style="font-size:11px;color:#8888a8;">P&L hidden Â· No distractions Â· Results revealed on close</span>
    </div>
    <div style="display:flex;align-items:center;gap:12px;">
        <span id="focusModeTimer" style="font-family:var(--v-mono);font-size:12px;color:#6868a0;"></span>
        <button onclick="toggleFocusMode()" style="background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.25);color:#f87171;border-radius:7px;padding:5px 12px;font-size:11px;font-weight:700;cursor:pointer;">Exit Focus</button>
    </div>
</div>

<div id="appPage" style="width:100%;">



<!-- â•â•â• LEADERBOARD OVERLAY â•â•â• -->
<!-- â•â•â• LEADERBOARD OVERLAY â€” MODE-SPLIT DESIGN â•â•â• -->
<div id="leaderboardOverlay" class="fixed inset-0 z-[9998] hidden" style="background:rgba(0,0,0,0.78);backdrop-filter:blur(10px);" onclick="closeLeaderboard()">
    <div onclick="event.stopPropagation()" style="position:absolute;right:0;top:0;height:100%;width:100%;max-width:520px;background:#0e0e16;border-left:1px solid rgba(255,255,255,0.07);overflow-y:auto;display:flex;flex-direction:column;">

        <!-- Sticky Header -->
        <div style="position:sticky;top:0;z-index:10;background:#0e0e16;border-bottom:1px solid rgba(255,255,255,0.07);">
            <div style="padding:20px 24px 14px;display:flex;align-items:flex-start;justify-content:space-between;">
                <div>
                    <h2 id="lbTitle" style="font-size:1.1rem;font-weight:700;color:#f0f0fa;margin:0 0 3px;">ğŸ† Standard Mode Leaderboard</h2>
                    <p id="lbSubtitle" style="font-size:11px;color:#8888a8;margin:0 0 2px;">Monthly competition Â· Gold accent</p>
                    <div id="lbCompetitionCountdown" style="font-size:10px;color:#6868a0;margin-top:2px;"></div>
                </div>
                <button onclick="closeLeaderboard()" style="background:none;border:none;color:#8888a8;font-size:24px;cursor:pointer;line-height:1;flex-shrink:0;margin-top:2px;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
            </div>

            <!-- Mode Toggle Tabs -->
            <div style="display:flex;gap:0;padding:0 24px;border-top:1px solid rgba(255,255,255,0.05);">
                <button onclick="setLeaderMode('standard')" id="lbTab-standard"
                    style="flex:1;padding:10px 8px;font-size:12px;font-weight:700;border:none;cursor:pointer;background:rgba(212,168,75,0.12);color:var(--v-gold);border-bottom:2px solid var(--v-gold);transition:all 0.15s;">
                    ğŸŸ¡ Standard
                </button>
                <button onclick="setLeaderMode('realism')" id="lbTab-realism"
                    style="flex:1;padding:10px 8px;font-size:12px;font-weight:700;border:none;cursor:pointer;background:transparent;color:#6868a0;border-bottom:2px solid transparent;transition:all 0.15s;">
                    ğŸ”µ Realism
                </button>
            </div>

            <!-- Sort sub-tabs -->
            <div style="display:flex;gap:4px;padding:10px 24px;border-top:1px solid rgba(255,255,255,0.04);flex-wrap:wrap;">
                <button onclick="setLeaderSort('total')"        id="sort-total"       class="lbsort-btn" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:6px;border:none;cursor:pointer;background:rgba(255,255,255,0.08);color:#e0e0f5;">ğŸ’° Value</button>
                <button onclick="setLeaderSort('return')"       id="sort-return"      class="lbsort-btn" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:6px;border:none;cursor:pointer;background:transparent;color:#8888a8;">ğŸ“ˆ Return</button>
                <button onclick="setLeaderSort('drawdown')"     id="sort-drawdown"    class="lbsort-btn" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:6px;border:none;cursor:pointer;background:transparent;color:#8888a8;">ğŸ›¡ Drawdown</button>
                <button onclick="setLeaderSort('discipline')"   id="sort-discipline"  class="lbsort-btn" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:6px;border:none;cursor:pointer;background:transparent;color:#8888a8;">ğŸ¯ Discipline</button>
                <button onclick="toggleLBRiskAdj()"             id="lbRiskAdjBtn"     style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);cursor:pointer;background:rgba(255,255,255,0.06);color:#8888a8;margin-left:auto;" title="Toggle risk-adjusted ranking (Sharpe-based)">âš–ï¸ Risk-Adj</button>
            </div>

            <!-- Min trades filter bar -->
            <div style="display:flex;align-items:center;gap:8px;padding:6px 24px 10px;border-top:1px solid rgba(255,255,255,0.04);">
                <span style="font-size:10px;color:#6060a0;white-space:nowrap;">Min trades:</span>
                <button onclick="setLBMinTrades(0)"  id="lbmt-0"  class="lbmt-btn" style="font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid rgba(255,255,255,0.1);cursor:pointer;background:rgba(212,168,75,0.12);color:#d4a84b;">All</button>
                <button onclick="setLBMinTrades(5)"  id="lbmt-5"  class="lbmt-btn" style="font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;background:transparent;color:#8888a8;">5+</button>
                <button onclick="setLBMinTrades(10)" id="lbmt-10" class="lbmt-btn" style="font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;background:transparent;color:#8888a8;">10+</button>
                <button onclick="setLBMinTrades(25)" id="lbmt-25" class="lbmt-btn" style="font-size:10px;padding:3px 8px;border-radius:5px;border:1px solid rgba(255,255,255,0.08);cursor:pointer;background:transparent;color:#8888a8;">25+</button>
                <div style="margin-left:auto;font-size:10px;color:#606080;" id="lbIntegrityInfo">Integrity filter: ON</div>
            </div>

            <!-- Mode comparison strip -->
            <div id="lbCompareStrip" style="margin:0 24px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px 12px;display:grid;grid-template-columns:1fr 1px 1fr;gap:0;font-size:10px;">
                <div style="text-align:center;padding-right:8px;">
                    <div style="color:#d4a84b;font-weight:700;margin-bottom:1px;">Standard Avg Return</div>
                    <div id="lbStdAvg" style="font-family:var(--v-mono);color:#e0e0f5;font-size:12px;">â€”</div>
                </div>
                <div style="background:rgba(255,255,255,0.08);"></div>
                <div style="text-align:center;padding-left:8px;">
                    <div style="color:#60a5fa;font-weight:700;margin-bottom:1px;">Realism Avg Return</div>
                    <div id="lbRlsAvg" style="font-family:var(--v-mono);color:#e0e0f5;font-size:12px;">â€”</div>
                </div>
            </div>
        </div>

        <!-- List -->
        <div id="leaderboardList" style="flex:1;padding:16px 24px 24px;">
            <div style="text-align:center;color:#8888a8;padding:40px 0;">Loading tradersâ€¦</div>
        </div>

        <!-- Footer -->
        <div style="border-top:1px solid rgba(255,255,255,0.07);padding:12px 24px;background:#0a0a12;font-size:10px;color:#606080;display:flex;justify-content:space-between;align-items:center;">
            <button onclick="openChampions()" style="font-size:10px;font-weight:700;color:#d4a84b;background:none;border:none;cursor:pointer;padding:0;">ğŸ› Hall of Champions</button>
            <span id="lbMonthTag" style="color:#8888a8;font-weight:600;"></span>
        </div>
    </div>
</div>

<!-- â•â•â• MODE SELECTION MODAL (shown on first login if mode not set) â•â•â• -->
<div id="modeSelectModal" style="display:none;position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.92);backdrop-filter:blur(20px);align-items:center;justify-content:center;">
    <div style="background:#111118;border:1px solid rgba(255,255,255,0.1);border-radius:24px;width:100%;max-width:580px;padding:0;overflow:hidden;animation:slideUp 0.4s cubic-bezier(0.16,1,0.3,1);">
        <div style="background:linear-gradient(135deg,rgba(212,168,75,0.08),rgba(96,165,250,0.08));padding:32px 36px 24px;text-align:center;">
            <div style="font-size:2.5rem;margin-bottom:10px;">âš™ï¸</div>
            <h2 style="font-family:var(--v-serif);font-size:1.6rem;color:#f0f0fa;margin:0 0 8px;">Choose Your Trading Mode</h2>
            <p style="font-size:13px;color:#8888a8;margin:0;line-height:1.6;">Your mode determines which leaderboard you compete on. This decision is locked during active monthly competitions.</p>
        </div>
        <div style="padding:24px 36px;display:grid;grid-template-columns:1fr 1fr;gap:16px;">
            <!-- Standard Mode Card -->
            <div onclick="confirmModeSelect('standard')" style="cursor:pointer;background:rgba(212,168,75,0.06);border:2px solid rgba(212,168,75,0.25);border-radius:16px;padding:20px;transition:all 0.2s;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.background='rgba(212,168,75,0.1)'" onmouseout="this.style.borderColor='rgba(212,168,75,0.25)';this.style.background='rgba(212,168,75,0.06)'">
                <div style="font-size:2rem;margin-bottom:10px;">ğŸŸ¡</div>
                <div style="font-weight:700;color:#d4a84b;font-size:1rem;margin-bottom:6px;">Standard Mode</div>
                <ul style="font-size:11px;color:#a0a0b8;line-height:1.7;margin:0;padding:0;list-style:none;">
                    <li>âœ“ Simplified fills</li>
                    <li>âœ“ No market hour enforcement</li>
                    <li>âœ“ Basic slippage</li>
                    <li>âœ“ Ideal for learning</li>
                    <li style="color:#d4a84b;font-weight:600;margin-top:6px;">Gold Leaderboard</li>
                </ul>
            </div>
            <!-- Realism Mode Card -->
            <div onclick="confirmModeSelect('realism')" style="cursor:pointer;background:rgba(96,165,250,0.06);border:2px solid rgba(96,165,250,0.25);border-radius:16px;padding:20px;transition:all 0.2s;" onmouseover="this.style.borderColor='#60a5fa';this.style.background='rgba(96,165,250,0.1)'" onmouseout="this.style.borderColor='rgba(96,165,250,0.25)';this.style.background='rgba(96,165,250,0.06)'">
                <div style="font-size:2rem;margin-bottom:10px;">ğŸ”µ</div>
                <div style="font-weight:700;color:#60a5fa;font-size:1rem;margin-bottom:6px;">Realism Mode</div>
                <ul style="font-size:11px;color:#a0a0b8;line-height:1.7;margin:0;padding:0;list-style:none;">
                    <li>âœ“ Market hours enforced</li>
                    <li>âœ“ Real spread simulation</li>
                    <li>âœ“ Earnings volatility spikes</li>
                    <li>âœ“ Stricter order logic</li>
                    <li style="color:#60a5fa;font-weight:600;margin-top:6px;">Blue Leaderboard Â· Harder</li>
                </ul>
            </div>
        </div>
        <div style="padding:0 36px 28px;text-align:center;">
            <p style="font-size:11px;color:#606080;margin:0;">You can change your mode between monthly competition periods from your profile settings.</p>
        </div>
    </div>
</div>

<!-- â•â•â• TRADE CONFIRMATION MODAL â•â•â• -->
<div id="tradeConfirmModal" style="display:none;position:fixed;inset:0;z-index:9500;background:rgba(0,0,0,0.8);backdrop-filter:blur(12px);align-items:center;justify-content:center;">
    <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:420px;padding:0;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">
        <div id="tcHeader" style="padding:20px 24px 14px;border-bottom:1px solid rgba(255,255,255,0.07);">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;" id="tcOrderType">Market Order</div>
            <div style="font-size:1.2rem;font-weight:700;color:#f0f0fa;" id="tcTitle">Buy AAPL</div>
        </div>
        <div style="padding:16px 24px;">
            <!-- Trade summary grid -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px;">
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Shares</div>
                    <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;" id="tcQty">0</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Effective Price</div>
                    <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;" id="tcPrice">$0.00</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Total Cost</div>
                    <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;" id="tcTotal">$0.00</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Remaining Cash</div>
                    <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;" id="tcCash">$0.00</div>
                </div>
            </div>
            <!-- Risk bar -->
            <div style="margin-bottom:14px;">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px;">
                    <span style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Portfolio Risk</span>
                    <span id="tcRiskPct" style="font-size:11px;font-weight:700;color:#f0f0fa;">0%</span>
                </div>
                <div style="height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                    <div id="tcRiskBar" style="height:100%;border-radius:3px;background:#4ade80;transition:width 0.3s;width:0%;"></div>
                </div>
                <div id="tcRiskWarn" style="font-size:10px;color:#f87171;margin-top:4px;display:none;">âš  High concentration â€” consider reducing position size</div>
            </div>
            <!-- Slippage note (realism mode only) -->
            <div id="tcSlippageNote" style="display:none;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2);border-radius:6px;padding:8px 10px;margin-bottom:10px;font-size:10px;color:#93c5fd;">ğŸ”µ Realism Mode: small spread/slippage applied to this order</div>
        </div>
        <div style="padding:0 24px 24px;display:flex;gap:10px;">
            <button onclick="cancelTradeConfirm()" style="flex:1;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;padding:12px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;">Cancel</button>
            <button id="tcConfirmBtn" onclick="executeConfirmedTrade()" style="flex:2;background:#34c759;color:#fff;font-weight:700;padding:12px;border-radius:10px;border:none;font-size:14px;cursor:pointer;">Confirm Buy</button>
        </div>
    </div>
</div>

<header class="app-header">
    <div style="width:100%;padding:0 28px;height:64px;display:flex;align-items:center;gap:16px;justify-content:space-between;">

        <!-- Brand -->
        <div style="flex-shrink:0;">
            <div class="vestra-brand" style="font-size:1.5rem;font-weight:700;color:var(--v-text);line-height:1;">Vestra</div>
            <div style="font-size:8px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:700;">No Risk Trading</div>
        </div>

        <!-- Search â€” takes all remaining space -->
        <div id="searchWrap" style="flex:1;max-width:520px;">
            <div class="search-bar flex items-center px-4 h-10">
                <svg class="w-4 h-4 mr-2" style="color:var(--v-muted);flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="search" oninput="handleSearch(this.value)" onfocus="showSearchDropdown()" placeholder="Search 500+ stocksâ€¦" class="bg-transparent border-none outline-none w-full text-sm" autocomplete="off" style="color:var(--v-text);">
                <button id="searchClear" onclick="clearSearch()" style="display:none;background:none;border:none;color:var(--v-muted);cursor:pointer;font-size:15px;padding:0 2px;flex-shrink:0;">âœ•</button>
            </div>
            <div id="searchDropdown" style="display:none;"></div>
        </div>

        <!-- Market status + countdown -->
        <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
            <div id="marketStatusDot" class="w-2 h-2 rounded-full" style="background:#6b7280;flex-shrink:0;"></div>
            <span id="marketStatusText" style="font-size:11px;font-weight:600;color:var(--v-muted);white-space:nowrap;">Closed</span>
            <span style="color:var(--v-border);font-size:14px;">Â·</span>
            <div id="marketCountdown" title="Time until market opens/closes" style="white-space:nowrap;"></div>
        </div>

        <!-- Action buttons -->
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
            <button onclick="openApiConfig()" id="liveDataBtn" style="font-size:11px;background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.3);color:var(--v-gold);padding:5px 10px;border-radius:6px;font-weight:700;cursor:pointer;white-space:nowrap;">âš¡ Live</button>
            <button onclick="openLeaderboard()" style="font-size:11px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);color:var(--v-gold);padding:5px 10px;border-radius:6px;font-weight:700;cursor:pointer;">ğŸ†</button>
            <!-- Notification Bell -->
            <div style="position:relative;" id="notifWrap">
                <button onclick="toggleNotifPanel()" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 8px;cursor:pointer;font-size:13px;line-height:1;position:relative;">
                    ğŸ””
                    <span id="notifBadge" style="display:none;position:absolute;top:-4px;right:-4px;background:#ef4444;color:#fff;border-radius:50%;width:14px;height:14px;font-size:8px;font-weight:700;display:flex;align-items:center;justify-content:center;line-height:1;">0</span>
                </button>
                <div id="notifPanel" style="display:none;position:absolute;right:0;top:calc(100%+8px);width:300px;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:14px;z-index:999;box-shadow:0 20px 60px rgba(0,0,0,0.5);overflow:hidden;">
                    <div style="padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;">
                        <span style="font-size:12px;font-weight:700;color:#f0f0fa;">Notifications</span>
                        <button onclick="clearAllNotifs()" style="font-size:10px;color:#8888a8;background:none;border:none;cursor:pointer;">Clear all</button>
                    </div>
                    <div id="notifList" style="max-height:280px;overflow-y:auto;padding:6px 0;">
                        <div style="text-align:center;color:#6868a0;font-size:11px;padding:20px;">No notifications yet</div>
                    </div>
                </div>
            </div>
            <!-- Sound Toggle -->
            <button id="soundToggleBtn" onclick="toggleSound()" title="Toggle micro sounds" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 8px;cursor:pointer;font-size:13px;line-height:1;">ğŸ”‡</button>
            <!-- Theme Switcher -->
            <div style="position:relative;" id="themeWrap">
                <button onclick="toggleThemeMenu()" id="themeToggle" title="Change theme" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 8px;cursor:pointer;font-size:13px;line-height:1;">ğŸ¨</button>
                <div id="themeMenu" style="display:none;position:absolute;right:0;top:calc(100%+8px);background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:6px;min-width:200px;z-index:999;box-shadow:0 16px 40px rgba(0,0,0,0.5);">
                    <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;padding:4px 8px 6px;">Professional Themes</div>
                    <button onclick="applyTheme('dark')"     class="theme-opt" data-theme="dark">ğŸŒ‘ Institutional Dark</button>
                    <button onclick="applyTheme('midnight')" class="theme-opt" data-theme="midnight">ğŸŒŒ Midnight</button>
                    <button onclick="applyTheme('graphite')" class="theme-opt" data-theme="graphite">â¬› Graphite</button>
                    <button onclick="applyTheme('arctic')"   class="theme-opt" data-theme="arctic">ğŸ§Š Arctic Blue</button>
                    <button onclick="applyTheme('emerald')"  class="theme-opt" data-theme="emerald">ğŸ’¹ Emerald Pro</button>
                    <button onclick="applyTheme('white')"    class="theme-opt" data-theme="white">â˜€ï¸ Minimal White</button>
                </div>
            </div>

            <!-- Overflow menu â€” export/import/tutorial/sync -->
            <div style="position:relative;" id="moreMenuWrap">
                <button onclick="toggleMoreMenu()" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 9px;cursor:pointer;font-size:13px;color:var(--v-muted);">â‹¯</button>
                <div id="moreMenu" style="display:none;position:absolute;right:0;top:calc(100%+6px);background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:6px;min-width:180px;z-index:999;box-shadow:0 16px 40px rgba(0,0,0,0.5);">
                    <div id="syncBadge" style="font-size:11px;padding:6px 10px;color:var(--v-muted);border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:4px;">Sync: Local</div>
                    <button onclick="exportPortfolioData();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“¤ Export Portfolio</button>
                    <button onclick="document.getElementById('importFile').click();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“¥ Import Portfolio</button>
                    <button onclick="startTutorial(true);toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“ Tutorial</button>
                    <button onclick="openRiskGuard();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ›¡ Risk Guard Settings</button>
                    <button onclick="openTraderProgress();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“ˆ Trader Progress</button>
                    <div style="height:1px;background:rgba(255,255,255,0.06);margin:4px 0;"></div>
                    <button onclick="openDecisionTimeline();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ—“ Decision Timeline</button>
                    <button onclick="openPerformanceReport();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“Š Weekly Report</button>
                    <button onclick="openSimulationSettings();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">âš™ï¸ Sim Mode</button>
                    <button onclick="openRoadmap();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ—ºï¸ Roadmap</button>
                    <button onclick="openCapitalAllocator();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ’¼ Capital Allocator</button>
                    <button onclick="toggleSilentFocus();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ”• Silent Focus Mode</button>
                </div>
            </div>
            <input id="importFile" type="file" accept="application/json" class="hidden" onchange="importPortfolioData(event)">

            <!-- Avatar + name -->
            <div style="display:flex;align-items:center;gap:8px;padding-left:10px;border-left:1px solid var(--v-border);">
                <div id="userAvatar" style="width:30px;height:30px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:12px;font-weight:700;flex-shrink:0;">?</div>
                <div style="display:flex;flex-direction:column;">
                    <div id="userDisplayName" style="font-size:12px;font-weight:600;color:var(--v-text);line-height:1.2;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">â€”</div>
                    <button onclick="logOut()" style="font-size:10px;color:var(--v-muted);background:none;border:none;cursor:pointer;padding:0;text-align:left;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--v-muted)'">Sign out</button>
                </div>
            </div>
        </div>

    </div>
</header>

<!-- News banner -->
<div id="newsBanner" class="fixed top-16 left-0 right-0 z-40 hidden px-6 py-2.5 text-center font-medium text-white shadow-lg" style="font-size:13px;">
    <span id="newsHeadline"></span>
</div>

<!-- â•â•â• MAIN TRADING LAYOUT â€” full viewport width â•â•â• -->
<main id="appMain" style="width:100%;padding:0;display:grid;grid-template-columns:1fr 280px;gap:0;min-height:calc(100vh - 64px);align-items:start;">

    <!-- â”€â”€ LEFT: stock grid + news â”€â”€ -->
    <div style="padding:20px 20px 40px 28px;min-width:0;border-right:1px solid var(--v-border);">

        <!-- Toolbar -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div style="display:flex;align-items:baseline;gap:12px;">
                <div style="font-size:1.1rem;font-weight:300;color:#f0f0fa;letter-spacing:-0.01em;">Most Active</div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;">Market Trends</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                <button onclick="openScreener()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ” Screener</button>
                <button onclick="openCalendar()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“… Calendar</button>
                <button onclick="openCommunity()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ’¬ Community</button>
                <button onclick="openEducation()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“ Learn</button>
                <button onclick="openStrategyLab()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#a78bfa';this.style.color='#a78bfa'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ§ª Strategy Lab</button>
                <button onclick="openMacro()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#60a5fa';this.style.color='#60a5fa'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸŒ Macro</button>
                <button onclick="openTraderProgress()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#4ade80';this.style.color='#4ade80'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“ˆ Progress</button>
                <button onclick="openRiskGuard()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#f59e0b';this.style.color='#f59e0b'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ›¡ Risk Guard</button>
                <button onclick="openAdvancedAnalytics()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#f472b6';this.style.color='#f472b6'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“Š Analytics</button>
                <button onclick="openAICoach()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#34d399';this.style.color='#34d399'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ§  AI Coach</button>
                <button onclick="openChallengeMode()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#fb923c';this.style.color='#fb923c'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ† Challenge</button>
                <button onclick="toggleSilentFocus()" id="silentFocusBtn" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#818cf8';this.style.color='#818cf8'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'" title="Hide P&amp;L during open trades">ğŸ”• Focus</button>
            <!-- Help button -->
            <button onclick="openHelpCenter()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" title="Help Center &amp; Feature Guide" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">â“ Help</button>
                <button onclick="openMultiAsset()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='#22d3ee';this.style.color='#22d3ee'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸŒ Multi-Asset</button>
                <!-- API Health -->
                <div style="display:flex;align-items:center;gap:4px;padding:2px 7px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:5px;" title="Data source status">
                    <div id="apiHealthDot" style="width:5px;height:5px;border-radius:50%;background:#6b7280;flex-shrink:0;"></div>
                    <span id="dataSourceBadge" style="font-size:10px;font-weight:700;color:#8888a8;">SIM</span>
                </div>
            </div>
        </div>

        <!-- Stock grid: wide cards, fills all available width -->
        <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px;margin-bottom:32px;"></div>

        <!-- News grid below -->
        <div style="border-top:1px solid var(--v-border);padding-top:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <div style="font-size:0.95rem;font-weight:600;color:#e0e0f5;">Market News</div>
                <a href="https://finance.yahoo.com/news/" target="_blank" rel="noopener noreferrer" style="font-size:11px;color:var(--v-gold);font-weight:600;text-decoration:none;">More â†—</a>
            </div>
            <div id="newsFeed" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;"></div>
        </div>
    </div>

    <!-- â”€â”€ RIGHT SIDEBAR â€” sticky, scrolls independently â”€â”€ -->
    <aside id="desktopSidebar" style="position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;padding:16px 16px 24px 16px;display:flex;flex-direction:column;gap:12px;background:var(--v-surface);">

        <!-- Equity summary â€” top of sidebar, always visible -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="display:flex;align-items:center;gap:5px;">
                    <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Portfolio</div>
                    <span class="v-tooltip">
                        <div class="v-tooltip-icon">?</div>
                        <div class="v-tooltip-popup">
                            <div class="v-tooltip-title">Total Portfolio Value</div>
                            <div class="v-tooltip-body">Your cash + current market value of all open positions. Starts at $100,000.</div>
                            <div class="v-tooltip-improve">â†‘ Grow this through disciplined strategy execution</div>
                        </div>
                    </span>
                </div>
                <div style="display:flex;align-items:center;gap:6px;">
                    <span id="modeBadgeSidebar" style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;background:rgba(212,168,75,0.12);color:#d4a84b;border:1px solid rgba(212,168,75,0.25);" title="Current trading mode">ğŸŸ¡ Standard</span>
                    <span id="dataSourceBadge2" style="display:none;"></span>
                </div>
            </div>
            <div style="font-size:1.6rem;font-weight:300;color:#f5f5fa;font-family:var(--v-mono);line-height:1;margin-bottom:4px;">$<span id="netWorth">100,000.00</span></div>
            <div id="plDisplay" class="pl-value" style="font-size:0.78rem;font-weight:600;color:#4ade80;">+$0.00 (0.00%)</div>
            <div id="portfolioList" style="border-top:1px solid rgba(255,255,255,0.05);margin-top:10px;max-height:160px;overflow-y:auto;">
                <div style="font-size:11px;color:#6868a0;padding:10px 0;text-align:center;font-style:italic;">No holdings yet.</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);font-size:10px;color:#6868a0;">
                <span class="v-tooltip">Realized: <span id="realizedPL" class="pl-value" style="color:#a0a0b8;font-weight:600;">$0.00</span>
                    <div class="v-tooltip-popup">
                        <div class="v-tooltip-title">Realized P&L</div>
                        <div class="v-tooltip-body">Profit/loss from trades you've already closed. This is your locked-in performance.</div>
                    </div>
                </span>
                <span class="v-tooltip">Unrealized: <span id="unrealizedPL" class="pl-value" style="color:#a0a0b8;font-weight:600;">$0.00</span>
                    <div class="v-tooltip-popup" style="left:auto;right:0;transform:none;">
                        <div class="v-tooltip-title">Unrealized P&L</div>
                        <div class="v-tooltip-body">Gain/loss on positions still open. Not yours until you close the trade.</div>
                    </div>
                </span>
            </div>
            <div style="margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);font-size:10px;color:#6868a0;">
                <span class="v-tooltip">Buying Power: <span id="buyingPower" class="pl-value" style="color:#f0f0fa;font-weight:700;font-family:var(--v-mono);">$100,000.00</span>
                    <div class="v-tooltip-popup">
                        <div class="v-tooltip-title">Buying Power</div>
                        <div class="v-tooltip-body">Available cash (Ã—leverage if enabled) for new positions. Never risk more than 2% on a single trade.</div>
                    </div>
                </span>
            </div>
            <!-- Portfolio analytics stats row -->
            <div id="portfolioStats" style="display:none;"></div>
        </div>

        <!-- Performance chart -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Performance</div>
                <div style="display:flex;gap:3px;">
                    <button onclick="setPerfPeriod('1D',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid var(--v-gold);background:rgba(212,168,75,0.15);color:var(--v-gold);cursor:pointer;">1D</button>
                    <button onclick="setPerfPeriod('5D',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">5D</button>
                    <button onclick="setPerfPeriod('1M',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">1M</button>
                    <button onclick="setPerfPeriod('6M',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">6M</button>
                    <button onclick="setPerfPeriod('1Y',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">1Y</button>
                </div>
            </div>
            <div id="perfChartWrap" style="height:110px;"><canvas id="perfChart"></canvas></div>
        </div>

        <!-- Allocation chart -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Allocation</div>
            <div style="height:120px;"><canvas id="allocationChart"></canvas></div>
            <div id="sectorExposure" style="margin-top:8px;font-size:10px;color:#8888a8;"></div>
        </div>

        <!-- Watchlist -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Watchlist</div>
                <button onclick="addCurrentToWatchlist()" style="font-size:10px;font-weight:700;color:var(--v-gold);background:none;border:none;cursor:pointer;padding:0;">+ Add</button>
            </div>
            <div id="watchlistItems" style="font-size:11px;color:#c0c0d8;margin-bottom:10px;"></div>

            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Price Alerts</div>
            <div style="display:grid;grid-template-columns:2fr 2fr 2fr;gap:4px;margin-bottom:5px;">
                <input id="alertSymbol" placeholder="SYM" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
                <select id="alertType" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
                    <option value="above">Above</option>
                    <option value="below">Below</option>
                    <option value="move">% Move</option>
                </select>
                <input id="alertValue" placeholder="$" type="number" step="0.01" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
            </div>
            <button onclick="createPriceAlert()" style="width:100%;background:rgba(212,168,75,0.08);color:var(--v-gold);border:1px solid rgba(212,168,75,0.18);border-radius:6px;padding:6px;font-size:10px;font-weight:700;cursor:pointer;" onmouseover="this.style.background='rgba(212,168,75,0.14)'" onmouseout="this.style.background='rgba(212,168,75,0.08)'">Set Alert</button>
            <div id="alertsList" style="margin-top:6px;font-size:10px;color:#a0a0b8;"></div>
            <div id="alertFeed" style="margin-top:4px;font-size:10px;"></div>
        </div>

        <!-- Quests -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Daily Quests</div>
            <div id="questList" style="font-size:11px;color:#c0c0d8;margin-bottom:6px;"></div>
            <div style="font-size:10px;color:#8888a8;margin-bottom:6px;">Streak: <span id="tradeStreak" style="font-weight:700;color:#d4a84b;">0 days</span></div>
            <div id="achievementList" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>

        <!-- SIP Plans Sidebar Widget -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">ğŸ“… SIP Plans</div>
                <button onclick="openSIP(null)" style="font-size:9px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.18);padding:2px 7px;border-radius:4px;cursor:pointer;">+ New</button>
            </div>
            <div id="sipSidebarWidget" style="font-size:11px;color:#8888a8;">
                <div style="text-align:center;padding:4px 0;font-style:italic;color:#6868a0;">No active SIP plans.</div>
            </div>
        </div>

        <!-- History -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">History</div>
            <div id="historyList" style="font-size:10px;color:#c0c0d8;max-height:160px;overflow-y:auto;"></div>
        </div>

        <!-- â”€â”€ AI Coach Panel â”€â”€ -->
        <div style="background:var(--v-card);border:1px solid rgba(167,139,250,0.2);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="display:flex;align-items:center;gap:6px;">
                    <div style="font-size:11px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.07em;">ğŸ§  AI Coach</div>
                    <span class="v-tooltip">
                        <div class="v-tooltip-icon">?</div>
                        <div class="v-tooltip-popup">
                            <div class="v-tooltip-title">AI Trade Coach</div>
                            <div class="v-tooltip-body">Analyzes your trading patterns to detect biases: overtrading, revenge trading, recency bias, loss aversion. Needs 3+ closed trades.</div>
                            <div class="v-tooltip-improve">Click "Open Full Coach" for detailed analysis</div>
                        </div>
                    </span>
                </div>
                <div style="display:flex;gap:5px;">
                    <button onclick="refreshAICoach()" style="font-size:9px;color:#a78bfa;background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);padding:2px 7px;border-radius:4px;cursor:pointer;">Refresh</button>
                    <button onclick="openAICoach()" style="font-size:9px;color:#a78bfa;background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);padding:2px 7px;border-radius:4px;cursor:pointer;">Full â†’</button>
                </div>
            </div>
            <div id="aiCoachInsights" style="font-size:11px;color:#c0c0d8;line-height:1.65;">
                <div style="text-align:center;color:#6868a0;font-style:italic;padding:8px 0;">Complete trades to unlock coaching insights.</div>
            </div>
            <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;text-align:center;">
                <div>
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Discipline</div>
                    <div id="coachDiscipline" style="font-size:1rem;font-weight:700;color:#a78bfa;">â€”</div>
                </div>
                <div>
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Risk Mgmt</div>
                    <div id="coachRisk" style="font-size:1rem;font-weight:700;color:#60a5fa;">â€”</div>
                </div>
                <div>
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Consistency</div>
                    <div id="coachConsistency" style="font-size:1rem;font-weight:700;color:#4ade80;">â€”</div>
                </div>
            </div>
        </div>

        <!-- â”€â”€ Millionaire Path Challenge â”€â”€ -->
        <div style="background:linear-gradient(135deg,rgba(212,168,75,0.06),rgba(212,168,75,0.02));border:1px solid rgba(212,168,75,0.2);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.07em;">ğŸ’° Millionaire Path</div>
                <span id="millionaireTier" style="font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;background:rgba(212,168,75,0.1);color:var(--v-gold);">Bronze</span>
            </div>
            <div style="font-size:10px;color:#8888a8;margin-bottom:8px;">Goal: $100K â†’ $1,000,000</div>
            <div style="margin-bottom:8px;">
                <div style="display:flex;justify-content:space-between;font-size:10px;color:#8888a8;margin-bottom:4px;">
                    <span id="millionaireLabel">$100K start</span>
                    <span id="millionaireProgress">0%</span>
                </div>
                <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
                    <div id="millionaireBar" style="height:100%;background:linear-gradient(90deg,#d4a84b,#f0c96a);border-radius:4px;transition:width 0.5s;width:0%;"></div>
                </div>
                <div style="display:flex;justify-content:space-between;font-size:9px;color:#6868a0;margin-top:3px;">
                    <span>$100K</span><span>$250K</span><span>$500K</span><span>$1M</span>
                </div>
            </div>
            <div id="millionaireTierBadges" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
            <div id="millionaireRuleWarning" style="display:none;margin-top:8px;padding:6px 8px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;font-size:10px;color:#f87171;"></div>
        </div>

        <!-- â”€â”€ Portfolio Intelligence â”€â”€ -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">ğŸ“Š Portfolio Intelligence</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:10px;">
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Sharpe Ratio</div>
                    <div id="sharpeRatio" style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:#f0f0fa;">â€”</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Max Drawdown</div>
                    <div id="maxDrawdownDisplay" style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:#f87171;">0%</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">Volatility</div>
                    <div id="portfolioVolatility" style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:#f0f0fa;">â€”</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;text-align:center;">
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">vs S&amp;P 500</div>
                    <div id="vsSnP" style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:#60a5fa;">â€”</div>
                </div>
            </div>
            <!-- Monthly return heatmap -->
            <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">Monthly Returns</div>
            <div id="monthlyHeatmap" style="display:grid;grid-template-columns:repeat(6,1fr);gap:3px;"></div>
            <!-- Best / Worst trade -->
            <div style="margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);">
                <div id="bestWorstTrade" style="font-size:10px;color:#8888a8;"></div>
            </div>
        </div>

    </aside>
</main>

<!-- â•â•â• MOBILE BOTTOM NAV â•â•â• -->
<nav id="mobileNav">
    <button class="mob-nav-btn active" id="mnMarket" onclick="mobileTab('market')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Market
    </button>
    <button class="mob-nav-btn" id="mnPortfolio" onclick="mobileTab('portfolio')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        Portfolio
    </button>
    <button class="mob-nav-btn" id="mnSearch" onclick="mobileTab('search')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        Search
    </button>
    <button class="mob-nav-btn" id="mnLeader" onclick="openLeaderboard()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
        Ranks
    </button>
    <button class="mob-nav-btn" id="mnProfile" onclick="mobileTab('profile')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        Profile
    </button>
</nav>

<!-- â•â•â• MOBILE PORTFOLIO VIEW â•â•â• -->
<div id="mobilePortfolioView" style="display:none;padding:16px;padding-bottom:80px;"></div>

<!-- â•â•â• JOURNAL MODAL â•â•â• -->
<div id="journalModal">
    <div style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:520px;padding:28px;margin:16px;max-height:90vh;overflow-y:auto;">
        <h3 style="font-family:var(--v-serif);font-size:1.2rem;color:#f0f0fa;margin:0 0 4px;">ğŸ““ Trade Journal</h3>
        <p id="journalTradeInfo" style="font-size:12px;color:#8888a8;margin:0 0 14px;font-family:var(--v-mono);"></p>

        <!-- Emotion Tags -->
        <div style="margin-bottom:14px;">
            <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:7px;">How are you feeling right now?</div>
            <div id="journalEmotionTags" style="display:flex;flex-wrap:wrap;gap:5px;"></div>
        </div>

        <!-- Strategy Tag -->
        <select id="journalStrategySelect" style="display:none;width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:8px;padding:8px 10px;font-size:12px;color:#e0e0f5;margin-bottom:12px;outline:none;"></select>

        <!-- Note textarea -->
        <textarea id="journalNote" placeholder="Why did you make this trade? What's your thesis? Any concerns?" style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:13px;color:#e8e8f5;font-family:var(--v-sans);outline:none;resize:vertical;min-height:100px;line-height:1.6;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'"></textarea>

        <!-- Post-trade checklist (SELLs only) -->
        <div id="journalChecklist" style="display:none;margin-top:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;"></div>

        <div style="display:flex;gap:10px;margin-top:14px;">
            <button onclick="saveJournalNote()" style="flex:1;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:12px;border-radius:10px;border:none;font-size:14px;cursor:pointer;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Save Note</button>
            <button onclick="closeJournal()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;padding:12px 18px;border-radius:10px;font-size:14px;cursor:pointer;font-weight:600;">Skip</button>
        </div>
    </div>
</div>

<div id="stockDetailPage" class="fixed inset-0 bg-[#1c1c1e] hidden z-50 overflow-y-auto">
    <div class="bg-[#1c1c1e] border-b border-gray-700 px-6 py-4 flex items-center gap-4 sticky top-0 z-10">
        <button onclick="closeStockDetail()" class="text-gray-400 hover:text-white flex items-center gap-2 text-sm font-medium transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Market
        </button>
        <span class="text-gray-600">|</span>
        <span id="detailHeaderSymbol" class="text-white font-medium"></span>
    </div>
    <div class="max-w-4xl mx-auto px-6 py-8">
        <div class="mb-6">
            <div class="text-gray-400 text-sm mb-1" id="detailName"></div>
            <div class="flex items-baseline gap-3 mb-2 flex-wrap">
                <span id="detailPrice" class="text-white font-light" style="font-size:3.5rem;line-height:1;"></span>
                <span class="text-gray-400 text-xl">USD</span>
                <button id="followBtn" onclick="toggleFollowCurrent()" class="ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium">+ Follow</button>
            </div>
            <div class="flex items-center gap-2 mb-1">
                <span id="detailChangeAmt" class="text-xl font-medium"></span>
                <span id="detailChangePct" class="text-xl font-medium"></span>
                <span id="detailArrow" class="text-xl"></span>
                <span class="text-gray-400 text-sm">today</span>
            </div>
            <div class="text-gray-500 text-xs">Closed: Feb 17, 4:05 am GMT-5</div>
            <div id="detailPremarket" class="text-[#8ab4f8] text-sm mt-1"></div>
        </div>
        <!-- â”€â”€ CHART TOOLBAR â”€â”€ -->
        <div style="background:#1c1c1e;border-radius:12px 12px 0 0;border:1px solid rgba(255,255,255,0.07);border-bottom:none;">
          <!-- Row 1: period tabs + indicator toggles -->
          <div style="display:flex;justify-content:space-between;align-items:center;padding:0 8px;border-bottom:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex;">
              <button onclick="setChartPeriod('1D',this)"  class="ctab ctab-active" style="font-size:11px;font-weight:700;padding:9px 12px;background:none;border:none;cursor:pointer;color:#8ab4f8;border-bottom:2px solid #8ab4f8;">1D</button>
              <button onclick="setChartPeriod('5D',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">5D</button>
              <button onclick="setChartPeriod('1M',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">1M</button>
              <button onclick="setChartPeriod('6M',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">6M</button>
              <button onclick="setChartPeriod('YTD',this)" class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">YTD</button>
              <button onclick="setChartPeriod('1Y',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">1Y</button>
              <button onclick="setChartPeriod('5Y',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">5Y</button>
              <button onclick="setChartPeriod('Max',this)" class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">Max</button>
            </div>
            <!-- Indicator toggles -->
            <div style="display:flex;gap:3px;padding:0 4px;flex-wrap:wrap;">
              <button onclick="toggleIndicator('EMA20')" id="ind-EMA20" class="ind-btn">EMA20</button>
              <button onclick="toggleIndicator('EMA50')" id="ind-EMA50" class="ind-btn">EMA50</button>
              <button onclick="toggleIndicator('BB')"    id="ind-BB"    class="ind-btn">BB</button>
              <button onclick="toggleIndicator('VWAP')"  id="ind-VWAP"  class="ind-btn">VWAP</button>
              <button onclick="toggleIndicator('RSI')"   id="ind-RSI"   class="ind-btn">RSI</button>
              <button onclick="toggleIndicator('MACD')"  id="ind-MACD"  class="ind-btn">MACD</button>
            </div>
          </div>
          <!-- Row 2: candle resolution â€” always visible, context-aware per period -->
          <div id="intradayRow" style="display:flex;align-items:center;gap:0;padding:0 8px;border-top:1px solid rgba(255,255,255,0.04);">
            <span style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;padding:6px 10px 6px 2px;">Resolution:</span>
            <!-- Intraday resolutions â€” shown for 1D and 5D -->
            <button onclick="setResolution('1')"  id="itv-1"  class="itv-btn" title="1-minute candles" style="display:none;">1m</button>
            <button onclick="setResolution('5')"  id="itv-5"  class="itv-btn" title="5-minute candles" style="display:none;">5m</button>
            <button onclick="setResolution('15')" id="itv-15" class="itv-btn" title="15-minute candles" style="display:none;">15m</button>
            <button onclick="setResolution('60')" id="itv-60" class="itv-btn" title="Hourly candles" style="display:none;">1H</button>
            <!-- Daily resolution â€” shown for 1M / 6M / YTD -->
            <button onclick="setResolution('D')"  id="itv-D"  class="itv-btn" title="Daily candles" style="display:none;">1D</button>
            <!-- Weekly resolution â€” shown for 1Y / 5Y -->
            <button onclick="setResolution('W')"  id="itv-W"  class="itv-btn" title="Weekly candles" style="display:none;">1W</button>
            <!-- Monthly resolution â€” shown for Max -->
            <button onclick="setResolution('M')"  id="itv-M"  class="itv-btn" title="Monthly candles" style="display:none;">1M</button>
            <!-- Right-side meta -->
            <div id="chartLiveIndicator" style="margin-left:auto;display:none;align-items:center;gap:4px;padding-right:4px;">
              <div style="width:5px;height:5px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;"></div>
              <span style="font-size:9px;color:#4ade80;font-weight:700;">LIVE</span>
            </div>
            <div id="chartTzLabel" style="margin-left:8px;font-size:9px;color:#6868a0;padding-right:4px;"></div>
            <!-- Strategy tag for this trade -->
            <select id="tradeStrategyTag" style="font-size:9px;background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);border-radius:4px;color:#a78bfa;padding:2px 4px;cursor:pointer;margin-left:4px;" title="Tag active strategy">
                <option value="">No strategy</option>
            </select>
            <!-- Replay button -->
            <button onclick="openReplayMode()" style="font-size:9px;font-weight:700;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.2);color:#60a5fa;border-radius:4px;padding:3px 8px;cursor:pointer;margin-left:4px;white-space:nowrap;" title="Practice on historical candles">ğŸ¬ Replay</button>
          </div>
          <!-- Replay Control Bar (hidden by default) -->
          <div id="replayBar" style="display:none;align-items:center;gap:8px;padding:7px 12px;background:rgba(96,165,250,0.06);border-top:1px solid rgba(96,165,250,0.15);">
            <span style="font-size:10px;font-weight:700;color:#60a5fa;">ğŸ¬ REPLAY MODE</span>
            <button onclick="replayStep(-1)" style="font-size:11px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e0f5;border-radius:5px;padding:3px 8px;cursor:pointer;" title="Step back">â—€</button>
            <button id="replayPlayBtn" onclick="toggleReplayPlay()" style="font-size:11px;background:rgba(96,165,250,0.15);border:1px solid rgba(96,165,250,0.3);color:#60a5fa;border-radius:5px;padding:3px 10px;cursor:pointer;font-weight:700;">â–¶ Play</button>
            <button onclick="replayStep(1)"  style="font-size:11px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#e0e0f5;border-radius:5px;padding:3px 8px;cursor:pointer;" title="Step forward">â–¶</button>
            <select id="replaySpeed" style="font-size:10px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.08);border-radius:4px;color:#e0e0f5;padding:3px 6px;">
                <option value="1000">1x</option>
                <option value="500" selected>2x</option>
                <option value="200">5x</option>
                <option value="100">10x</option>
            </select>
            <span id="replayDateLabel" style="font-size:10px;color:#8888a8;font-family:var(--v-mono);"></span>
            <span id="replayCandleIdx" style="font-size:10px;color:#6868a0;margin-left:auto;"></span>
            <button onclick="closeReplayMode()" style="font-size:10px;font-weight:700;color:#f87171;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:5px;padding:3px 8px;cursor:pointer;">âœ• Exit Replay</button>
          </div>
        </div>

        <!-- â”€â”€ Market Status Banner â”€â”€ -->
        <div id="marketStatusBanner" style="display:flex;align-items:center;padding:3px 12px;font-size:10px;font-weight:700;border-radius:0;border:1px solid rgba(74,222,128,0.15);border-top:none;background:rgba(74,222,128,0.06);color:#4ade80;letter-spacing:0.03em;transition:all 0.3s;"></div>
        <!-- â”€â”€ OHLC Summary bar â”€â”€ -->
        <!-- ATR Display -->
        <div id="atrDisplay" style="display:none;align-items:center;padding:6px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:7px;margin-bottom:8px;"></div>
        <div id="ohlcSummaryBar" style="display:none;align-items:center;gap:8px;padding:4px 12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-top:none;font-size:11px;flex-wrap:wrap;"></div>

        <!-- â”€â”€ CHART AREA â”€â”€ -->
        <div id="chartOuter" style="position:relative;background:#1c1c1e;border:1px solid rgba(255,255,255,0.07);border-top:none;border-radius:0 0 12px 12px;overflow:hidden;">
          <!-- Loading / error overlay -->
          <div id="chartOverlay" style="display:none;position:absolute;inset:0;z-index:20;background:rgba(20,20,28,0.88);align-items:center;justify-content:center;flex-direction:column;gap:8px;">
            <div id="chartOverlayIcon" style="font-size:1.5rem;">â³</div>
            <div id="chartOverlayText" style="font-size:12px;color:#9aa0a6;font-weight:600;">Loading chartâ€¦</div>
            <button id="chartRetryBtn" onclick="if(detailStock)drawChart(detailStock,currentChartPeriod)" style="display:none;margin-top:6px;background:rgba(212,168,75,0.12);border:1px solid rgba(212,168,75,0.3);color:var(--v-gold);border-radius:6px;padding:5px 14px;font-size:11px;font-weight:600;cursor:pointer;">â†º Retry</button>
          </div>
          <!-- Debug overlay â€” toggle with Shift+D on stock detail page -->
          <div id="chartDebugOverlay" style="display:none;position:absolute;top:8px;left:8px;z-index:30;background:rgba(10,10,18,0.93);border:1px solid rgba(245,158,11,0.35);border-radius:8px;padding:10px 13px;min-width:185px;pointer-events:none;"></div>
          <!-- Prev close badge -->
          <div style="position:absolute;right:10px;top:8px;z-index:5;text-align:right;line-height:1.4;">
            <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.04em;">Prev close</div>
            <div id="prevCloseVal" style="font-size:11px;color:#e0e0f5;font-weight:600;font-family:var(--v-mono);"></div>
          </div>
          <!-- Candlestick canvas -->
          <div style="height:310px;position:relative;">
            <canvas id="stockChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- RSI sub-panel -->
          <div id="rsiChartWrap" style="display:none;height:80px;border-top:1px solid rgba(255,255,255,0.05);position:relative;">
            <div style="position:absolute;left:6px;top:4px;font-size:8px;color:#f59e0b;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">RSI(14)</div>
            <canvas id="rsiChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- MACD sub-panel -->
          <div id="macdChartWrap" style="display:none;height:80px;border-top:1px solid rgba(255,255,255,0.05);position:relative;">
            <div style="position:absolute;left:6px;top:4px;font-size:8px;color:#a78bfa;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">MACD</div>
            <canvas id="macdChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- Volume panel -->
          <div style="height:64px;border-top:1px solid rgba(255,255,255,0.04);position:relative;">
            <div style="position:absolute;left:6px;top:3px;font-size:8px;color:#6868a0;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">Vol</div>
            <canvas id="volumeChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
        </div>
        <div style="margin-bottom:24px;"></div>
        <div class="grid grid-cols-3 border-t border-gray-700 text-sm mb-8">
            <div class="py-4 pr-4"><div class="text-gray-400 mb-1">Open</div><div class="text-white font-medium" id="sOpen">â€”</div></div>
            <div class="py-4 px-4"><div class="text-gray-400 mb-1">Mkt cap</div><div class="text-white font-medium" id="sMktCap">â€”</div></div>
            <div class="py-4 pl-4"><div class="text-gray-400 mb-1">Dividend</div><div class="text-white font-medium" id="sDividend">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">High</div><div class="text-white font-medium" id="sHigh">â€”</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">P/E ratio</div><div class="text-white font-medium" id="sPE">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">Qtrly Div Amt</div><div class="text-white font-medium" id="sDivAmt">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">Low</div><div class="text-white font-medium" id="sLow">â€”</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">52-wk high</div><div class="text-white font-medium" id="s52H">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">52-wk low</div><div class="text-white font-medium" id="s52L">â€”</div></div>
        </div>

        <!-- Analyst Ratings -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ“Š Analyst Ratings</h3>
            <div id="analystRatings"></div>
        </div>

        <!-- Earnings (simulated) -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ“ˆ Earnings History</h3>
            <div id="earningsData" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
        </div>

        <!-- Similar Stocks -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ”— Similar Stocks</h3>
            <div id="similarStocks" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="bg-[#2c2c2e] rounded-2xl p-6 border border-gray-700">
            <h3 class="text-white text-lg font-medium mb-4">Trade <span id="tradeSymLabel" class="text-gray-400"></span></h3>
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Buying Power</div><div class="text-white font-semibold text-lg" id="dBuyPow">$100,000</div></div>
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Shares Owned</div><div class="text-white font-semibold text-lg" id="dShares">0</div></div>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <select id="orderType" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" onchange="updateOrderTypeHint(this)">
                    <option value="market">Market</option>
                    <option value="limit">Limit</option>
                    <option value="stop-loss">Stop-loss</option>
                    <option value="take-profit">Take-profit</option>
                    <option value="bracket">Bracket (Entry+SL+TP)</option>
                    <option value="partial">Partial Close</option>
                    <option value="gtt">GTT (Good-Till-Triggered)</option>
                </select>
                <input id="orderQty" type="number" min="1" value="1" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Qty">
                <input id="orderTrigger" type="number" step="0.01" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Trigger">
            </div>
            <!-- Mode indicator in trade panel -->
            <div id="tradePanelModeBadge" style="margin-bottom:8px;padding:6px 10px;border-radius:7px;font-size:10px;font-weight:700;background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.18);color:#d4a84b;display:flex;align-items:center;justify-content:space-between;">
                <span id="tradePanelModeLabel">ğŸŸ¡ Standard Mode â€” Simplified fills</span>
                <button onclick="openModeSettings()" style="font-size:9px;color:#8888a8;background:none;border:none;cursor:pointer;text-decoration:underline;">Change</button>
            </div>
            <!-- Bracket order extra fields -->
            <div id="bracketExtraFields" style="display:none;margin-bottom:8px;display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div>
                    <label style="font-size:9px;color:#6868a0;display:block;margin-bottom:2px;">Stop-Loss $</label>
                    <input id="bracketSL" type="number" step="0.01" placeholder="Stop" style="width:100%;background:#1c1c1e;border:1px solid #4b5563;border-radius:4px;padding:6px 8px;font-size:12px;color:#fff;outline:none;">
                </div>
                <div>
                    <label style="font-size:9px;color:#6868a0;display:block;margin-bottom:2px;">Take-Profit $</label>
                    <input id="bracketTP" type="number" step="0.01" placeholder="Target" style="width:100%;background:#1c1c1e;border:1px solid #4b5563;border-radius:4px;padding:6px 8px;font-size:12px;color:#fff;outline:none;">
                </div>
            </div>
            <!-- R:R Calculator -->
            <div id="rrCalcPanel" style="display:none;margin-bottom:8px;background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.15);border-radius:7px;padding:8px 10px;">
                <div style="font-size:9px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:5px;">âš– Risk-to-Reward</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;font-size:10px;text-align:center;">
                    <div><div style="color:#f87171;font-weight:700;" id="rrRisk">Risk: â€”</div></div>
                    <div><div style="color:#4ade80;font-weight:700;" id="rrReward">Rwd: â€”</div></div>
                    <div><div style="color:#f0f0fa;font-weight:700;" id="rrRatio">R:R â€”</div></div>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="execDetailTrade('BUY')" class="flex-1 bg-[#34c759] hover:bg-[#2db34e] text-white font-semibold py-3 rounded-xl text-base transition">Buy / Place</button>
                <button onclick="execDetailTrade('SELL')" class="flex-1 bg-[#ff453a] hover:bg-[#e03d33] text-white font-semibold py-3 rounded-xl text-base transition">Sell / Place</button>
            </div>
            <!-- Floating P&L indicator -->
            <div id="floatingPL" style="display:none;margin-top:10px;padding:8px 12px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                <span style="font-size:10px;color:#8888a8;">Position P&L</span>
                <span id="floatingPLValue" style="font-family:var(--v-mono);font-size:12px;font-weight:700;color:#4ade80;">+$0.00</span>
            </div>
            <div id="pendingOrdersList" class="mt-3 text-xs text-gray-300 space-y-1"></div>
            <!-- Journal note for this stock -->
            <div id="stockJournalNote" style="margin-top:12px;display:none;background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.2);border-radius:10px;padding:12px;">
                <div style="font-size:10px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ““ Your Journal</div>
                <div id="stockJournalText" style="font-size:13px;color:#c0c0d8;line-height:1.6;"></div>
            </div>
            <div id="detailNews" class="mt-4 space-y-2"></div>
        </div>
        <!-- Fee structure panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0;">ğŸ’¸ Fee Structure</h3>
                <span style="font-size:10px;background:rgba(34,197,94,0.12);color:#4ade80;padding:2px 8px;border-radius:4px;font-weight:700;">$0 Commission</span>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Stock Trades</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">$0.00</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">No commissions</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Order Execution</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">Free</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Instant fills</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Account Fee</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">$0.00</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Forever free</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Spreads</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">Real</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Live bid/ask</div>
                </div>
            </div>
            <p style="font-size:10px;color:#4a4a6a;margin:10px 0 0;text-align:center;">Vestra is a paper trading simulator. No real money involved.</p>
        </div>

        <!-- Auto-Bot Rules panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0;">ğŸ¤– Auto-Bot Rules</h3>
                <button onclick="openBotBuilder()" style="font-size:10px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);padding:3px 10px;border-radius:5px;cursor:pointer;">+ New Rule</button>
            </div>
            <div id="botRulesList" style="font-size:11px;color:#8888a8;min-height:32px;">
                <div style="text-align:center;padding:8px 0;font-style:italic;">No auto-rules yet. Set conditions to trade automatically.</div>
            </div>
        </div>

        <!-- SIP / Recurring Investment Panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;" id="sipDetailPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0 0 2px;">ğŸ“… SIP / Recurring Invest</h3>
                    <div style="font-size:10px;color:#8888a8;">Dollar-cost average automatically</div>
                </div>
                <button onclick="openSIP(detailStock)" style="font-size:10px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);padding:3px 10px;border-radius:5px;cursor:pointer;">+ New Plan</button>
            </div>
            <div id="sipDetailList" style="font-size:11px;color:#8888a8;min-height:28px;">
                <div style="text-align:center;padding:6px 0;font-style:italic;">No active SIP plans for this stock.</div>
            </div>
            <!-- DCA stats row â€” shown when plans exist -->
            <div id="sipDcaStats" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Avg Cost</div>
                    <div id="sipAvgCost" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">â€”</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Total Invested</div>
                    <div id="sipTotalInvested" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">â€”</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Executions</div>
                    <div id="sipExecCount" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">0</div>
                </div>
            </div>
        </div>

        <!-- Share portfolio button -->
        <div style="text-align:center;padding:16px 0 8px;">
            <button onclick="sharePortfolio()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;padding:10px 24px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='#a0a0b8'">ğŸ”— Share My Portfolio</button>
        </div>
    </div>
</div>

<!-- â•â•â• IMMERSIVE TUTORIAL OVERLAY â•â•â• -->
<div id="tutorialOverlay" class="hidden">
    <div class="tutorial-card">
        <!-- Progress bar -->
        <div class="tutorial-progress-bar">
            <div class="tutorial-progress-fill" id="tutorialProgressFill" style="width:0%"></div>
        </div>
        <!-- Step indicator -->
        <div class="flex items-center justify-between px-8 pt-6 pb-0">
            <div class="flex gap-2" id="tutorialDots"></div>
            <button onclick="skipTutorial()" class="text-xs text-gray-500 hover:text-gray-300 transition font-medium">Skip tutorial</button>
        </div>
        <!-- Content -->
        <div class="px-8 py-6">
            <div id="tutorialIcon" class="text-5xl mb-4 text-center"></div>
            <h2 id="tutorialTitle" class="text-white text-2xl font-bold mb-3 text-center"></h2>
            <p id="tutorialDesc" class="text-gray-400 text-sm leading-relaxed text-center mb-6"></p>
            <!-- Highlight hint box -->
            <div id="tutorialHint" class="hidden rounded-xl px-4 py-3 mb-6 text-sm text-center font-medium" style="background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);color:#c4b5fd;"></div>
        </div>
        <!-- Actions -->
        <div class="px-8 pb-8 flex gap-3">
            <button id="tutorialPrevBtn" onclick="tutorialPrev()" class="hidden flex-1 border border-gray-600 text-gray-300 hover:border-gray-400 font-semibold py-3 rounded-xl text-sm transition">â† Back</button>
            <button id="tutorialNextBtn" onclick="tutorialNext()" class="flex-1 font-bold py-3 rounded-xl text-sm transition text-white" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">Continue â†’</button>
        </div>
    </div>
</div>

<!-- â•â•â• API CONFIG MODAL â•â•â• -->
<div id="apiConfigModal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);">
    <div style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,0.7);width:100%;max-width:520px;padding:36px;">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;">
            <div>
                <h2 style="font-size:1.25rem;font-weight:700;color:#f0f0fa;margin:0 0 4px;">âš¡ Real-Time Market Data</h2>
                <p style="font-size:0.85rem;color:#8888a8;margin:0;">Connect your Finnhub API key for live prices</p>
            </div>
            <button onclick="closeApiConfig()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;line-height:1;padding:0;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
        </div>
        <div style="background:rgba(99,179,237,0.08);border:1px solid rgba(99,179,237,0.2);border-radius:12px;padding:14px;margin-bottom:12px;font-size:0.875rem;color:#90cdf4;">
            <strong style="color:#bee3f8;">Free Finnhub API</strong> â€” Get your key at
            <a href="https://finnhub.io/register" target="_blank" style="color:#63b3ed;font-weight:600;text-decoration:underline;">finnhub.io/register</a>
            &nbsp;(60 calls/min, no credit card needed)
        </div>

        <div id="apiConfigError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Finnhub API Key</label>
            <input id="finnhubKeyInput" type="text" placeholder="e.g. d0abc123..." style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;font-family:var(--v-mono);outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'">
            <p style="font-size:11px;color:#606080;margin-top:6px;">Stored locally in your browser â€” never sent to any server.</p>
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Update Interval</label>
            <select id="updateIntervalInput" style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;outline:none;">
                <option value="10000">Every 10 seconds (recommended)</option>
                <option value="15000">Every 15 seconds</option>
                <option value="30000">Every 30 seconds</option>
                <option value="60000">Every 60 seconds</option>
            </select>
        </div>
        <div style="display:flex;gap:12px;">
            <button onclick="saveApiConfig()" style="flex:1;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Save & Activate</button>
            <button onclick="clearApiConfig()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.background='rgba(239,68,68,0.18)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">Clear</button>
        </div>
        <div id="apiTestResult" style="margin-top:12px;font-size:13px;text-align:center;color:#8888a8;display:none;"></div>
    </div>
</div>


<!-- â•â•â• SIP / RECURRING INVESTMENT MODAL â•â•â• -->
<div id="sipModal" style="display:none;position:fixed;inset:0;z-index:9100;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);">
  <div style="background:#14141e;border:1px solid rgba(212,168,75,0.2);border-radius:20px;width:100%;max-width:560px;margin:60px auto;padding:0;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">

    <!-- Header -->
    <div style="padding:22px 26px 0;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:18px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <h2 style="font-family:var(--v-serif);font-size:1.35rem;color:#f0f0fa;margin:0 0 4px;">ğŸ“… Create SIP Plan</h2>
          <p style="font-size:12px;color:#8888a8;margin:0;">Invest automatically at regular intervals â€” practice dollar-cost averaging</p>
        </div>
        <button onclick="closeSIP()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;line-height:1;">&times;</button>
      </div>
    </div>

    <!-- Type tabs -->
    <div style="display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,0.06);">
      <button onclick="setSIPType('stock')" id="sipTab-stock" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:rgba(212,168,75,0.1);color:var(--v-gold);border:none;border-bottom:2px solid var(--v-gold);cursor:pointer;">ğŸ“ˆ Stock SIP</button>
      <button onclick="setSIPType('fractional')" id="sipTab-fractional" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ”¬ Fractional</button>
      <button onclick="setSIPType('etf')" id="sipTab-etf" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ¦ ETF</button>
      <button onclick="setSIPType('drip')" id="sipTab-drip" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ’° DRIP</button>
    </div>

    <!-- Body -->
    <div style="padding:20px 26px 26px;">

      <!-- Type description banner -->
      <div id="sipTypeBanner" style="background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.15);border-radius:8px;padding:10px 12px;margin-bottom:16px;font-size:11px;color:#a08840;line-height:1.55;"></div>

      <!-- Fields -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div id="sipSymbolGroup">
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Symbol</label>
          <input id="sipSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;font-family:var(--v-mono);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
        <div>
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;" id="sipAmountLabel">Amount ($)</label>
          <input id="sipAmount" type="number" min="1" step="1" placeholder="e.g. 100" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
        <div>
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Frequency</label>
          <select id="sipFreq" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
        <div id="sipMaxAmountGroup">
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Max Total ($)</label>
          <input id="sipMaxTotal" type="number" min="0" step="100" placeholder="Unlimited" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
      </div>

      <!-- DRIP-specific toggle -->
      <div id="sipDripToggleGroup" style="display:none;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
          <input type="checkbox" id="sipDripEnabled" checked style="width:14px;height:14px;accent-color:var(--v-gold);">
          <span style="font-size:12px;color:#c0c0d8;">Reinvest dividends as fractional shares</span>
        </label>
      </div>

      <!-- DCA projection (live update) -->
      <div id="sipProjection" style="background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.12);border-radius:8px;padding:10px 12px;margin-bottom:14px;">
        <div style="font-size:9px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ“Š DCA Projection</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">3-month invest</div>
            <div id="sipProj3m" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">1-year invest</div>
            <div id="sipProj1y" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">Est. shares (1yr)</div>
            <div id="sipProjShares" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
        </div>
      </div>

      <div id="sipError" style="display:none;margin-bottom:10px;font-size:11px;color:#f87171;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:8px 10px;"></div>
      <button onclick="saveSIPPlan()" style="width:100%;background:linear-gradient(135deg,var(--v-gold),var(--v-gold-light));color:#0a0a0f;font-weight:700;padding:13px;border-radius:9px;border:none;font-size:13px;cursor:pointer;letter-spacing:0.02em;">Activate SIP Plan â†’</button>
    </div>

  </div>
</div>

<!-- â•â•â• STOCK SCREENER MODAL â•â•â• -->
<div id="screenerModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:900px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ” Stock Screener</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Filter 500+ stocks by technical, fundamental, and market criteria</p>
      </div>
      <button onclick="closeScreener()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <!-- Filters row -->
    <div style="padding:16px 24px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Sector</label>
        <select id="scSector" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">All Sectors</option>
          <option>Technology</option><option>Finance</option><option>Healthcare</option>
          <option>Consumer</option><option>Energy</option><option>Industrial</option>
          <option>Real Estate</option><option>Utilities</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Change %</label>
        <select id="scChange" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any</option>
          <option value="up5">Gainers &gt;5%</option>
          <option value="up2">Gainers &gt;2%</option>
          <option value="down2">Losers &lt;-2%</option>
          <option value="down5">Losers &lt;-5%</option>
          <option value="flat">Flat (Â±1%)</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Price Range</label>
        <select id="scPrice" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any Price</option>
          <option value="0-50">Under $50</option>
          <option value="50-200">$50â€“$200</option>
          <option value="200-500">$200â€“$500</option>
          <option value="500+">Over $500</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">P/E Ratio</label>
        <select id="scPE" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any P/E</option>
          <option value="low">Value (&lt;15)</option>
          <option value="mid">Moderate (15â€“35)</option>
          <option value="high">Growth (&gt;35)</option>
          <option value="neg">Unprofitable</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button onclick="runScreener()" style="background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:6px 18px;border-radius:7px;border:none;font-size:11px;cursor:pointer;white-space:nowrap;">Run Screen</button>
      </div>
    </div>
    <!-- Results -->
    <div id="screenerResults" style="padding:16px 24px 24px;max-height:480px;overflow-y:auto;">
      <div style="text-align:center;color:#8888a8;padding:32px 0;font-size:13px;">Set filters above and click Run Screen</div>
    </div>
  </div>
</div>

<!-- â•â•â• ECONOMIC CALENDAR MODAL â•â•â• -->
<div id="calendarModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:700px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ“… Economic Calendar</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Upcoming market events, Fed meetings & earnings</p>
      </div>
      <button onclick="closeCalendar()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <!-- Calendar filters -->
    <div style="padding:12px 24px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;gap:4px;flex-wrap:wrap;align-items:center;">
        <span style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;margin-right:4px;">Show:</span>
        <button onclick="setCalFilter('all')"      id="cal-all"      class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(212,168,75,0.3);background:rgba(212,168,75,0.1);color:var(--v-gold);cursor:pointer;">All</button>
        <button onclick="setCalFilter('earnings')" id="cal-earnings" class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">ğŸ“Š Earnings</button>
        <button onclick="setCalFilter('fed')"      id="cal-fed"      class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">ğŸ¦ Fed</button>
        <button onclick="setCalFilter('data')"     id="cal-data"     class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">ğŸ“ˆ Economic</button>
        <button onclick="setCalFilter('ipo')"      id="cal-ipo"      class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">ğŸš€ IPO</button>
        <button onclick="setCalFilter('dividend')" id="cal-dividend" class="cal-filter-btn" style="font-size:9px;font-weight:700;padding:3px 10px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">ğŸ’° Dividends</button>
    </div>
    <div id="calendarContent" style="padding:20px 24px 28px;"></div>
  </div>
</div>

<!-- â•â•â• COMMUNITY FEED MODAL â•â•â• -->
<div id="communityModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:680px;height:80vh;margin:5vh auto;display:flex;flex-direction:column;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 2px;">ğŸ’¬ Community</h2>
        <p style="font-size:11px;color:#8888a8;margin:0;">Share trade ideas and market insights</p>
      </div>
      <button onclick="closeCommunity()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <!-- Performance Badges Strip -->
    <div id="communityBadges" style="padding:8px 20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;gap:6px;flex-wrap:wrap;align-items:center;flex-shrink:0;background:rgba(255,255,255,0.01);">
        <span style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Your Badges:</span>
        <div id="myBadgeList" style="display:flex;gap:4px;flex-wrap:wrap;"></div>
    </div>
    <!-- Filter bar -->
    <div style="padding:8px 20px;border-bottom:1px solid rgba(255,255,255,0.05);display:flex;gap:4px;flex-shrink:0;align-items:center;">
        <span style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-right:4px;">Filter:</span>
        <button onclick="setCommunityFilter('all')"      id="cf-all"       class="cf-btn" style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;border:1px solid rgba(212,168,75,0.3);background:rgba(212,168,75,0.1);color:var(--v-gold);cursor:pointer;">All</button>
        <button onclick="setCommunityFilter('Breakout')"  id="cf-Breakout"  class="cf-btn" style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">#Breakout</button>
        <button onclick="setCommunityFilter('Swing')"     id="cf-Swing"     class="cf-btn" style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">#Swing</button>
        <button onclick="setCommunityFilter('Earnings')"  id="cf-Earnings"  class="cf-btn" style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">#Earnings</button>
        <button onclick="setCommunityFilter('Momentum')"  id="cf-Momentum"  class="cf-btn" style="font-size:9px;font-weight:700;padding:2px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">#Momentum</button>
    </div>
    <!-- Post composer -->
    <div style="padding:12px 20px;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div id="communityAvatar" style="width:32px;height:32px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:13px;font-weight:700;flex-shrink:0;">?</div>
        <div style="flex:1;">
          <textarea id="communityPost" placeholder="Share your trade ideaâ€¦ use #Breakout #Swing #Earnings tags" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 10px;font-size:12px;color:#e0e0f5;font-family:var(--v-sans);outline:none;resize:none;height:52px;line-height:1.5;" onfocus="this.style.borderColor='rgba(212,168,75,0.4)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'"></textarea>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px;">
            <div style="display:flex;gap:3px;">
                <button onclick="insertTag('#Breakout')" style="font-size:9px;color:#60a5fa;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2);border-radius:4px;padding:2px 6px;cursor:pointer;">#Breakout</button>
                <button onclick="insertTag('#Swing')"    style="font-size:9px;color:#4ade80;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.2);border-radius:4px;padding:2px 6px;cursor:pointer;">#Swing</button>
                <button onclick="insertTag('#Earnings')" style="font-size:9px;color:#f59e0b;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:4px;padding:2px 6px;cursor:pointer;">#Earnings</button>
            </div>
            <button onclick="postCommunityIdea()" style="background:var(--v-gold);color:#0a0a0f;font-weight:700;font-size:11px;padding:5px 14px;border-radius:6px;border:none;cursor:pointer;">Post Idea</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Feed -->
    <div id="communityFeed" style="flex:1;overflow-y:auto;padding:12px 20px 16px;display:flex;flex-direction:column;gap:10px;"></div>
  </div>
</div>

<!-- â•â•â• EDUCATION HUB MODAL â•â•â• -->
<div id="educationModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:780px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ“ Education Hub</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Learn trading fundamentals, strategies, and technical analysis</p>
      </div>
      <button onclick="closeEducation()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <div id="educationContent" style="padding:20px 24px 28px;"></div>
  </div>
</div>

<!-- â•â•â• AUTO-BOT BUILDER MODAL â•â•â• -->
<div id="botModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:520px;margin:60px auto;padding:28px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0;">ğŸ¤– Create Auto-Rule</h2>
      <button onclick="closeBotBuilder()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <p style="font-size:12px;color:#8888a8;margin:0 0 18px;line-height:1.6;">Set a condition â€” when it triggers, a paper trade executes automatically.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Symbol</label>
        <input id="botSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Action</label>
        <select id="botAction" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
          <option value="BUY">Buy</option>
          <option value="SELL">Sell</option>
        </select>
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Qty</label>
        <input id="botQty" type="number" min="1" value="1" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Condition</label>
        <select id="botCondition" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
          <option value="above">Price rises above</option>
          <option value="below">Price falls below</option>
          <option value="up_pct">% gain since open</option>
          <option value="down_pct">% drop since open</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Trigger Value</label>
      <input id="botTrigger" type="number" step="0.01" placeholder="e.g. 150.00" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
    </div>
    <button onclick="saveBotRule()" style="width:100%;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:12px;border-radius:8px;border:none;font-size:13px;cursor:pointer;">Create Rule</button>
    <div id="botError" style="display:none;margin-top:8px;font-size:11px;color:#f87171;text-align:center;"></div>
  </div>
</div>
</div><!-- end #appPage -->

<script>
    // â”€â”€ Clear any previously hardcoded API key if it matches the old default â”€â”€
    (function() {
        const OLD_KEY = 'd6c804pr01qsiik14ah0d6c804pr01qsiik14ahg';
        const stored = localStorage.getItem('finnhub_api_key');
        if (stored === OLD_KEY) {
            localStorage.removeItem('finnhub_api_key');
            localStorage.removeItem('finnhub_interval');
        }
    })();

    // --- Data Setup ---
    // Full 500 Ticker List (Simulated)
    // Real stock data as of Feb 17, 2026
    // â”€â”€ Real prices as of Feb 17 2026 (Robinhood / Google Finance) â”€â”€
    const realStockData = {
        'AAPL':  { name: 'Apple Inc.',               price: 254.86,  change: -2.27,  pe: 32.36,  mktCap: '3.76T', div: '0.41%', divAmt: '0.26', wkHigh: 288.62,  wkLow: 169.21 },
        'MSFT':  { name: 'Microsoft Corp.',           price: 400.00,  change: -0.29,  pe: 25.11,  mktCap: '2.98T', div: '0.84%', divAmt: '0.91', wkHigh: 555.45,  wkLow: 344.79 },
        'NVDA':  { name: 'NVIDIA Corp.',              price: 181.51,  change: -2.22,  pe: 49.60,  mktCap: '4.42T', div: '0.04%', divAmt: '0.01', wkHigh: 212.19,  wkLow: 86.62  },
        'GOOGL': { name: 'Alphabet Inc. Class A',     price: 305.72,  change: -1.06,  pe: 22.45,  mktCap: '3.69T', div: '0.00%', divAmt: '0.00', wkHigh: 349.00,  wkLow: 140.53 },
        'AMZN':  { name: 'Amazon.com Inc.',           price: 198.95,  change: -0.42,  pe: 41.50,  mktCap: '2.12T', div: '0.00%', divAmt: '0.00', wkHigh: 258.60,  wkLow: 161.38 },
        'META':  { name: 'Meta Platforms Inc.',       price: 638.64,  change: -1.55,  pe: 29.80,  mktCap: '1.61T', div: '0.00%', divAmt: '0.00', wkHigh: 796.25,  wkLow: 479.80 },
        'TSLA':  { name: 'Tesla Inc.',                price: 417.44,  change: -0.09,  pe: 388.17, mktCap: '1.57T', div: '0.00%', divAmt: '0.00', wkHigh: 498.83,  wkLow: 214.25 },
        'BRK.B': { name: 'Berkshire Hathaway B',      price: 488.15,  change: 0.42,   pe: 22.10,  mktCap: '1.07T', div: '0.00%', divAmt: '0.00', wkHigh: 497.20,  wkLow: 370.55 },
        'JPM':   { name: 'JPMorgan Chase & Co.',      price: 302.68,  change: 0.54,   pe: 14.20,  mktCap: '851B',  div: '2.38%', divAmt: '1.40', wkHigh: 337.25,  wkLow: 202.16 },
        'AVGO':  { name: 'Broadcom Inc.',             price: 324.96,  change: -1.82,  pe: 68.24,  mktCap: '1.54T', div: '1.24%', divAmt: '0.65', wkHigh: 414.61,  wkLow: 138.10 },
        'XOM':   { name: 'Exxon Mobil Corp.',         price: 148.70,  change: -1.90,  pe: 14.50,  mktCap: '632B',  div: '3.40%', divAmt: '0.99', wkHigh: 156.93,  wkLow: 97.80  },
        'WMT':   { name: 'Walmart Inc.',              price: 134.05,  change: 0.60,   pe: 38.90,  mktCap: '1.08T', div: '0.88%', divAmt: '0.24', wkHigh: 134.65,  wkLow: 79.81  },
        'COST':  { name: 'Costco Wholesale Corp.',    price: 1016.20, change: 1.40,   pe: 54.80,  mktCap: '441B',  div: '0.55%', divAmt: '1.16', wkHigh: 1077.49, wkLow: 844.06 },
        'V':     { name: 'Visa Inc.',                 price: 314.17,  change: -3.14,  pe: 29.76,  mktCap: '598B',  div: '0.91%', divAmt: '0.59', wkHigh: 375.51,  wkLow: 299.00 },
        'MA':    { name: 'Mastercard Inc.',           price: 571.44,  change: -0.18,  pe: 38.50,  mktCap: '527B',  div: '0.59%', divAmt: '0.76', wkHigh: 581.30,  wkLow: 440.34 },
        'LLY':   { name: 'Eli Lilly and Co.',         price: 858.60,  change: -1.20,  pe: 62.30,  mktCap: '817B',  div: '0.67%', divAmt: '1.50', wkHigh: 972.53,  wkLow: 704.17 },
        'UNH':   { name: 'UnitedHealth Group Inc.',   price: 538.22,  change: -0.44,  pe: 19.80,  mktCap: '496B',  div: '1.57%', divAmt: '2.21', wkHigh: 629.73,  wkLow: 462.86 },
        'PG':    { name: 'Procter & Gamble Co.',      price: 165.45,  change: 0.33,   pe: 25.70,  mktCap: '388B',  div: '2.43%', divAmt: '1.06', wkHigh: 177.98,  wkLow: 151.42 },
        'HD':    { name: 'Home Depot Inc.',           price: 396.56,  change: -0.55,  pe: 26.40,  mktCap: '393B',  div: '2.40%', divAmt: '2.25', wkHigh: 439.37,  wkLow: 316.90 },
        'JNJ':   { name: 'Johnson & Johnson',         price: 158.32,  change: 0.18,   pe: 22.50,  mktCap: '384B',  div: '3.07%', divAmt: '1.24', wkHigh: 168.93,  wkLow: 140.67 },
        'ORCL':  { name: 'Oracle Corp.',              price: 157.20,  change: -1.80,  pe: 29.40,  mktCap: '435B',  div: '1.02%', divAmt: '0.40', wkHigh: 345.72,  wkLow: 118.86 },
        'MRK':   { name: 'Merck & Co. Inc.',          price: 89.44,   change: -0.65,  pe: 12.10,  mktCap: '225B',  div: '3.71%', divAmt: '0.81', wkHigh: 134.63,  wkLow: 84.46  },
        'ABT':   { name: 'Abbott Laboratories',       price: 129.83,  change: 0.22,   pe: 23.10,  mktCap: '226B',  div: '1.87%', divAmt: '0.59', wkHigh: 136.15,  wkLow: 97.11  },
        'ABBV':  { name: 'AbbVie Inc.',               price: 196.24,  change: 0.41,   pe: 55.20,  mktCap: '345B',  div: '3.16%', divAmt: '1.64', wkHigh: 214.82,  wkLow: 147.35 },
        'CVX':   { name: 'Chevron Corp.',             price: 161.88,  change: -0.72,  pe: 14.90,  mktCap: '302B',  div: '4.25%', divAmt: '1.71', wkHigh: 171.69,  wkLow: 135.37 },
        'NFLX':  { name: 'Netflix Inc.',              price: 76.97,   change: 1.33,   pe: 50.40,  mktCap: '33B',   div: '0.00%', divAmt: '0.00', wkHigh: 134.12,  wkLow: 75.23  },
        'AMD':   { name: 'Advanced Micro Devices',    price: 206.82,  change: -0.69,  pe: 94.20,  mktCap: '334B',  div: '0.00%', divAmt: '0.00', wkHigh: 267.08,  wkLow: 76.48  },
        'ADBE':  { name: 'Adobe Inc.',                price: 263.93,  change: -0.50,  pe: 23.40,  mktCap: '114B',  div: '0.00%', divAmt: '0.00', wkHigh: 464.99,  wkLow: 251.10 },
        'CRM':   { name: 'Salesforce Inc.',           price: 188.40,  change: -0.50,  pe: 30.10,  mktCap: '181B',  div: '0.00%', divAmt: '0.00', wkHigh: 329.74,  wkLow: 180.24 },
        'INTC':  { name: 'Intel Corp.',               price: 46.62,   change: 0.65,   pe: 0,      mktCap: '199B',  div: '0.86%', divAmt: '0.13', wkHigh: 54.60,   wkLow: 17.67  },
        'CSCO':  { name: 'Cisco Systems Inc.',        price: 62.47,   change: 0.28,   pe: 17.20,  mktCap: '251B',  div: '2.91%', divAmt: '0.41', wkHigh: 64.72,   wkLow: 44.51  },
        'PFE':   { name: 'Pfizer Inc.',               price: 26.18,   change: -0.38,  pe: 9.60,   mktCap: '148B',  div: '6.57%', divAmt: '0.43', wkHigh: 32.44,   wkLow: 22.91  },
        'TMO':   { name: 'Thermo Fisher Scientific',  price: 547.12,  change: -0.90,  pe: 25.70,  mktCap: '213B',  div: '0.29%', divAmt: '0.39', wkHigh: 621.65,  wkLow: 478.35 },
        'DIS':   { name: 'Walt Disney Co.',           price: 111.60,  change: 1.10,   pe: 38.40,  mktCap: '202B',  div: '0.86%', divAmt: '0.50', wkHigh: 123.74,  wkLow: 83.91  },
        'KO':    { name: 'Coca-Cola Co.',             price: 71.08,   change: 0.52,   pe: 25.10,  mktCap: '306B',  div: '2.89%', divAmt: '0.51', wkHigh: 73.53,   wkLow: 56.57  },
        'PEP':   { name: 'PepsiCo Inc.',              price: 150.47,  change: -0.18,  pe: 21.40,  mktCap: '207B',  div: '3.65%', divAmt: '1.42', wkHigh: 183.41,  wkLow: 142.76 },
        'BAC':   { name: 'Bank of America Corp.',     price: 46.72,   change: 0.85,   pe: 14.10,  mktCap: '358B',  div: '2.49%', divAmt: '0.26', wkHigh: 48.08,   wkLow: 32.36  },
        'WFC':   { name: 'Wells Fargo & Co.',         price: 76.34,   change: 0.92,   pe: 13.20,  mktCap: '256B',  div: '2.36%', divAmt: '0.40', wkHigh: 81.49,   wkLow: 49.60  },
        'GS':    { name: 'Goldman Sachs Group',       price: 904.50,  change: 1.50,   pe: 17.64,  mktCap: '271B',  div: '1.50%', divAmt: '3.50', wkHigh: 984.70,  wkLow: 439.38 },
        'MS':    { name: 'Morgan Stanley',            price: 130.47,  change: 0.60,   pe: 20.80,  mktCap: '214B',  div: '3.07%', divAmt: '0.925',wkHigh: 137.00,  wkLow: 90.98  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'QCOM':  { name: 'Qualcomm Inc.',             price: 162.40,  change: -1.30,  pe: 14.30,  mktCap: '172B',  div: '2.11%', divAmt: '0.89', wkHigh: 230.63,  wkLow: 143.27 },
        'TXN':   { name: 'Texas Instruments Inc.',    price: 179.55,  change: -0.70,  pe: 28.40,  mktCap: '162B',  div: '2.95%', divAmt: '1.36', wkHigh: 220.39,  wkLow: 152.64 },
        'AMGN':  { name: 'Amgen Inc.',                price: 262.10,  change: 0.30,   pe: 17.80,  mktCap: '140B',  div: '3.51%', divAmt: '2.38', wkHigh: 329.65,  wkLow: 236.87 },
        'HON':   { name: 'Honeywell Intl. Inc.',      price: 219.66,  change: -0.42,  pe: 22.50,  mktCap: '137B',  div: '2.19%', divAmt: '1.13', wkHigh: 235.36,  wkLow: 185.33 },
        'NKE':   { name: 'Nike Inc.',                 price: 74.29,   change: -0.68,  pe: 22.10,  mktCap: '111B',  div: '2.15%', divAmt: '0.40', wkHigh: 97.67,   wkLow: 70.41  },
        'CAT':   { name: 'Caterpillar Inc.',          price: 386.30,  change: 0.55,   pe: 19.30,  mktCap: '186B',  div: '1.58%', divAmt: '1.41', wkHigh: 418.49,  wkLow: 302.40 },
        'MCD':   { name: "McDonald's Corp.",          price: 301.67,  change: 0.33,   pe: 24.50,  mktCap: '217B',  div: '2.49%', divAmt: '1.77', wkHigh: 317.90,  wkLow: 243.97 },
        'SBUX':  { name: 'Starbucks Corp.',           price: 101.29,  change: 1.50,   pe: 32.60,  mktCap: '113B',  div: '2.95%', divAmt: '0.61', wkHigh: 115.07,  wkLow: 72.91  },
        'BA':    { name: 'Boeing Co.',                price: 183.24,  change: -1.80,  pe: 0,      mktCap: '139B',  div: '0.00%', divAmt: '0.00', wkHigh: 211.03,  wkLow: 136.32 },
        'PLTR':  { name: 'Palantir Technologies',     price: 131.72,  change: -5.20,  pe: 208.59, mktCap: '313B',  div: '0.00%', divAmt: '0.00', wkHigh: 207.52,  wkLow: 66.12  },
        'PANW':  { name: 'Palo Alto Networks',        price: 192.48,  change: 0.70,   pe: 52.40,  mktCap: '120B',  div: '0.00%', divAmt: '0.00', wkHigh: 210.20,  wkLow: 152.29 },
        'NOW':   { name: 'ServiceNow Inc.',           price: 1024.35, change: -2.40,  pe: 121.30, mktCap: '207B',  div: '0.00%', divAmt: '0.00', wkHigh: 1198.09, wkLow: 738.00 },
        'ISRG':  { name: 'Intuitive Surgical Inc.',   price: 579.88,  change: -1.10,  pe: 84.60,  mktCap: '205B',  div: '0.00%', divAmt: '0.00', wkHigh: 599.09,  wkLow: 363.75 },
        'AXP':   { name: 'American Express Co.',      price: 301.44,  change: 0.40,   pe: 21.50,  mktCap: '208B',  div: '1.01%', divAmt: '0.82', wkHigh: 325.87,  wkLow: 213.08 },
        'SPGI':  { name: 'S&P Global Inc.',           price: 497.32,  change: 0.22,   pe: 34.20,  mktCap: '157B',  div: '0.81%', divAmt: '0.94', wkHigh: 574.18,  wkLow: 421.72 },
        'BLK':   { name: 'BlackRock Inc.',            price: 1068.00, change: 0.55,   pe: 24.60,  mktCap: '158B',  div: '2.17%', divAmt: '5.21', wkHigh: 1088.11, wkLow: 755.12 },
        'RTX':   { name: 'RTX Corp.',                 price: 130.80,  change: 0.33,   pe: 37.50,  mktCap: '175B',  div: '2.04%', divAmt: '0.63', wkHigh: 138.52,  wkLow: 100.18 },
        'LMT':   { name: 'Lockheed Martin Corp.',     price: 487.26,  change: 0.48,   pe: 17.80,  mktCap: '119B',  div: '2.94%', divAmt: '3.30', wkHigh: 606.99,  wkLow: 414.10 },
        'VZ':    { name: 'Verizon Communications',    price: 40.23,   change: -0.25,  pe: 9.40,   mktCap: '169B',  div: '6.56%', divAmt: '0.67', wkHigh: 44.73,   wkLow: 38.16  },
        'T':     { name: 'AT&T Inc.',                 price: 26.94,   change: 0.15,   pe: 11.80,  mktCap: '193B',  div: '4.82%', divAmt: '0.28', wkHigh: 27.91,   wkLow: 16.11  },
        'NEE':   { name: 'NextEra Energy Inc.',       price: 73.14,   change: 0.55,   pe: 22.30,  mktCap: '149B',  div: '2.87%', divAmt: '0.54', wkHigh: 84.40,   wkLow: 57.88  },
        'DHR':   { name: 'Danaher Corp.',             price: 225.60,  change: -0.82,  pe: 36.40,  mktCap: '163B',  div: '0.49%', divAmt: '0.27', wkHigh: 265.57,  wkLow: 209.72 },
        'UNP':   { name: 'Union Pacific Corp.',       price: 251.90,  change: 0.18,   pe: 21.60,  mktCap: '151B',  div: '2.30%', divAmt: '1.34', wkHigh: 269.80,  wkLow: 214.37 },
        'PM':    { name: 'Philip Morris Intl.',       price: 135.88,  change: 0.62,   pe: 22.10,  mktCap: '212B',  div: '3.72%', divAmt: '1.35', wkHigh: 137.60,  wkLow: 91.20  },
        'COP':   { name: 'ConocoPhillips',            price: 107.18,  change: -0.55,  pe: 12.40,  mktCap: '138B',  div: '2.41%', divAmt: '0.78', wkHigh: 134.80,  wkLow: 95.61  },
        'MU':    { name: 'Micron Technology Inc.',    price: 94.76,   change: -2.30,  pe: 17.20,  mktCap: '105B',  div: '0.42%', divAmt: '0.115',wkHigh: 163.94,  wkLow: 78.20  },
        'AMAT':  { name: 'Applied Materials Inc.',    price: 171.22,  change: -2.80,  pe: 22.60,  mktCap: '142B',  div: '0.93%', divAmt: '0.40', wkHigh: 261.93,  wkLow: 148.10 },
        'LRCX':  { name: 'Lam Research Corp.',        price: 720.45,  change: -3.10,  pe: 22.80,  mktCap: '94B',   div: '1.09%', divAmt: '2.30', wkHigh: 1134.34, wkLow: 648.82 },
        'ADI':   { name: 'Analog Devices Inc.',       price: 209.80,  change: -1.55,  pe: 36.40,  mktCap: '109B',  div: '1.62%', divAmt: '0.92', wkHigh: 246.59,  wkLow: 186.76 },
        'INTU':  { name: 'Intuit Inc.',               price: 571.30,  change: -1.80,  pe: 47.20,  mktCap: '160B',  div: '0.70%', divAmt: '1.04', wkHigh: 721.98,  wkLow: 522.91 },
        'SCHW':  { name: 'Charles Schwab Corp.',      price: 80.94,   change: 0.75,   pe: 28.10,  mktCap: '148B',  div: '1.34%', divAmt: '0.25', wkHigh: 85.74,   wkLow: 56.38  },
        'GILD':  { name: 'Gilead Sciences Inc.',      price: 90.72,   change: 0.35,   pe: 16.40,  mktCap: '113B',  div: '3.17%', divAmt: '0.79', wkHigh: 101.75,  wkLow: 68.70  },
        'REGN':  { name: 'Regeneron Pharmaceuticals', price: 626.82,  change: -0.82,  pe: 21.40,  mktCap: '66B',   div: '0.00%', divAmt: '0.00', wkHigh: 1191.00, wkLow: 578.41 },
        'VRTX':  { name: 'Vertex Pharmaceuticals',    price: 498.22,  change: 0.55,   pe: 32.80,  mktCap: '128B',  div: '0.00%', divAmt: '0.00', wkHigh: 535.24,  wkLow: 364.29 },
        'DE':    { name: 'Deere & Co.',               price: 476.20,  change: -0.45,  pe: 19.50,  mktCap: '129B',  div: '1.47%', divAmt: '1.75', wkHigh: 496.73,  wkLow: 339.40 },
        'ACN':   { name: 'Accenture Plc.',            price: 338.70,  change: -0.55,  pe: 27.30,  mktCap: '212B',  div: '1.77%', divAmt: '1.48', wkHigh: 383.18,  wkLow: 288.16 },
        'WM':    { name: 'Waste Management Inc.',     price: 217.40,  change: 0.28,   pe: 31.20,  mktCap: '88B',   div: '1.48%', divAmt: '0.75', wkHigh: 222.05,  wkLow: 182.72 },
        'ITW':   { name: 'Illinois Tool Works',       price: 258.35,  change: -0.35,  pe: 24.80,  mktCap: '79B',   div: '2.49%', divAmt: '1.40', wkHigh: 271.04,  wkLow: 220.29 },
        'ETN':   { name: 'Eaton Corp. Plc.',          price: 347.80,  change: 0.42,   pe: 31.60,  mktCap: '138B',  div: '0.90%', divAmt: '0.86', wkHigh: 401.83,  wkLow: 240.79 },
        'LOW':   { name: "Lowe's Companies Inc.",     price: 265.12,  change: 0.33,   pe: 23.40,  mktCap: '152B',  div: '1.80%', divAmt: '1.15', wkHigh: 289.10,  wkLow: 210.99 },
        'SYK':   { name: 'Stryker Corp.',             price: 390.55,  change: 0.45,   pe: 33.50,  mktCap: '147B',  div: '0.90%', divAmt: '0.86', wkHigh: 421.33,  wkLow: 302.09 },
        'BDX':   { name: 'Becton Dickinson & Co.',    price: 223.80,  change: -0.30,  pe: 16.80,  mktCap: '64B',   div: '1.75%', divAmt: '0.95', wkHigh: 250.68,  wkLow: 211.50 },
        'MDT':   { name: 'Medtronic Plc.',            price: 87.44,   change: 0.25,   pe: 18.20,  mktCap: '116B',  div: '3.40%', divAmt: '0.70', wkHigh: 92.51,   wkLow: 71.93  },
        'C':     { name: 'Citigroup Inc.',            price: 84.32,   change: 0.92,   pe: 11.80,  mktCap: '161B',  div: '2.85%', divAmt: '0.56', wkHigh: 87.10,   wkLow: 54.80  },
        'MMC':   { name: 'Marsh & McLennan Cos.',     price: 221.60,  change: 0.18,   pe: 28.40,  mktCap: '108B',  div: '1.44%', divAmt: '0.815',wkHigh: 232.25,  wkLow: 185.56 },
        'CB':    { name: 'Chubb Ltd.',                price: 271.50,  change: 0.33,   pe: 13.80,  mktCap: '109B',  div: '1.35%', divAmt: '0.91', wkHigh: 300.12,  wkLow: 225.36 },
        'PLD':   { name: 'Prologis Inc.',             price: 106.78,  change: -0.45,  pe: 35.60,  mktCap: '97B',   div: '3.36%', divAmt: '0.96', wkHigh: 136.80,  wkLow: 96.68  },
        'CI':    { name: 'Cigna Group',               price: 298.45,  change: -0.38,  pe: 14.60,  mktCap: '71B',   div: '1.78%', divAmt: '1.40', wkHigh: 361.78,  wkLow: 268.60 },
        'ELV':   { name: 'Elevance Health Inc.',      price: 442.20,  change: -0.55,  pe: 14.20,  mktCap: '109B',  div: '1.44%', divAmt: '1.63', wkHigh: 581.35,  wkLow: 374.50 },
        'ZTS':   { name: 'Zoetis Inc.',               price: 155.60,  change: -0.72,  pe: 28.80,  mktCap: '71B',   div: '1.10%', divAmt: '0.432',wkHigh: 192.50,  wkLow: 146.43 },
        'BSX':   { name: 'Boston Scientific Corp.',   price: 102.84,  change: 0.32,   pe: 62.30,  mktCap: '147B',  div: '0.00%', divAmt: '0.00', wkHigh: 106.08,  wkLow: 66.22  },
        'FI':    { name: 'Fiserv Inc.',               price: 224.72,  change: 0.40,   pe: 24.50,  mktCap: '137B',  div: '0.00%', divAmt: '0.00', wkHigh: 249.80,  wkLow: 167.36 },
        'LIN':   { name: 'Linde Plc.',                price: 455.30,  change: 0.18,   pe: 30.20,  mktCap: '210B',  div: '1.26%', divAmt: '1.39', wkHigh: 494.99,  wkLow: 396.79 },
        'CMCSA': { name: 'Comcast Corp.',             price: 33.18,   change: -0.30,  pe: 9.20,   mktCap: '127B',  div: '3.31%', divAmt: '0.31', wkHigh: 41.26,   wkLow: 32.24  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'TJX':   { name: 'TJX Companies Inc.',        price: 127.30,  change: 0.55,   pe: 30.40,  mktCap: '152B',  div: '1.23%', divAmt: '0.3625',wkHigh: 132.73, wkLow: 97.62  },
        'PGR':   { name: 'Progressive Corp.',         price: 262.40,  change: 0.42,   pe: 18.20,  mktCap: '153B',  div: '0.00%', divAmt: '0.00', wkHigh: 277.91,  wkLow: 175.50 },
        'MDLZ':  { name: 'Mondelez Intl. Inc.',       price: 61.34,   change: -0.18,  pe: 21.60,  mktCap: '80B',   div: '2.87%', divAmt: '0.435',wkHigh: 75.28,   wkLow: 58.54  },
        'ADP':   { name: 'ADP Inc.',                  price: 298.80,  change: 0.35,   pe: 29.30,  mktCap: '121B',  div: '2.07%', divAmt: '1.40', wkHigh: 318.53,  wkLow: 232.95 },
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   NEWS-DRIVEN VOLATILITY ENGINE (added 2026)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const newsHeadlines = [
    { text: "FED RAISES RATES 50 bps â€“ growth stocks under pressure", sector: "Technology", impact: -9 },
    { text: "TECH MEGACAP RALLY: AI spending beats expectations", sector: "Technology", impact: +13 },
    { text: "OIL SURGES 8% after OPEC+ cuts production", sector: "Energy", impact: +11 },
    { text: "FDA grants full approval to breakthrough cancer therapy", sector: "Healthcare", impact: +16 },
    { text: "Consumer confidence hits 2-year high", sector: "Consumer", impact: +8 },
    { text: "Semiconductor shortage worsens â€“ supply chain warning", sector: "Technology", impact: -10 },
    { text: "Crypto rebounds sharply after regulatory clarity", sector: "Financials", impact: +14 },
    { text: "Major bank reports stronger-than-expected Q4 earnings", sector: "Financials", impact: +7 },
    { text: "Global chip export restrictions tightened", sector: "Technology", impact: -12 },
    { text: "Renewable energy subsidies expanded in new bill", sector: "Energy", impact: +10 },
    { text: "Inflation cools more than expected", sector: "Consumer", impact: +6 },
    { text: "Big Tech faces new antitrust scrutiny in EU", sector: "Technology", impact: -8 }
];

let newsTimer = null;

function showNewsEvent() {
    const event = newsHeadlines[Math.floor(Math.random() * newsHeadlines.length)];
    
    const banner = document.getElementById('newsBanner');
    const headlineEl = document.getElementById('newsHeadline');
    
    headlineEl.textContent = event.text;
    banner.style.background = event.impact >= 0 ? '#065f46' : '#991b1b';
    banner.classList.remove('hidden');
    
    // Apply sector-wide movement
    stocks.forEach(stock => {
        if (stock.sector === event.sector) {
            // 70â€“130% of base impact + individual noise
            const move = event.impact * (0.7 + Math.random() * 0.6);
            stock.price = Math.max(0.5, stock.price * (1 + move / 100));
            stock.change = Number((move + (Math.random() - 0.5) * 4).toFixed(2));
        }
    });

    // Hide banner after 5.5 seconds
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 5500);

    // Refresh UI
    renderGrid();
    if (detailStock) {
        const updated = stocks.find(s => s.symbol === detailStock.symbol);
        if (updated) openStockDetail(updated);
    }
    updateUI();
}

function startNewsEngine() {
    if (newsTimer) clearInterval(newsTimer);
    // First event after 8â€“15 seconds, then every 24â€“36 seconds
    const firstDelay = 8000 + Math.random() * 7000;
    setTimeout(showNewsEvent, firstDelay);
    
    newsTimer = setInterval(showNewsEvent, 24000 + Math.random() * 12000);
}


    // â”€â”€ Multi-Asset Expansion: ETFs, Forex, Commodities, Crypto â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const multiAssetData = {
        // â”€â”€ Index ETFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'SPY':  { name:'SPDR S&P 500 ETF',           price:587.32, change: 0.44, pe:22.1, mktCap:'557B',  div:'1.24%', divAmt:'1.82', wkHigh:613.23, wkLow:480.11, assetClass:'ETF',     sector:'Index', session:'NYSE' },
        'QQQ':  { name:'Invesco QQQ (Nasdaq 100)',    price:516.48, change: 0.61, pe:32.4, mktCap:'294B',  div:'0.56%', divAmt:'0.89', wkHigh:540.81, wkLow:406.40, assetClass:'ETF',     sector:'Index', session:'NYSE' },
        'DIA':  { name:'SPDR Dow Jones ETF',          price:447.18, change: 0.22, pe:20.8, mktCap:'33B',   div:'1.67%', divAmt:'5.63', wkHigh:450.29, wkLow:357.22, assetClass:'ETF',     sector:'Index', session:'NYSE' },
        'IWM':  { name:'iShares Russell 2000 ETF',   price:225.62, change:-0.35, pe:18.2, mktCap:'64B',   div:'1.44%', divAmt:'0.97', wkHigh:245.19, wkLow:187.93, assetClass:'ETF',     sector:'Index', session:'NYSE' },
        // â”€â”€ Sector ETFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'XLK':  { name:'Technology Select Sector',   price:238.14, change: 0.81, pe:34.7, mktCap:'65B',   div:'0.74%', divAmt:'0.56', wkHigh:258.64, wkLow:175.28, assetClass:'ETF',     sector:'Technology', session:'NYSE' },
        'XLF':  { name:'Financial Select Sector',    price:49.82,  change: 0.53, pe:15.4, mktCap:'41B',   div:'1.82%', divAmt:'0.27', wkHigh:51.67,  wkLow:34.81,  assetClass:'ETF',     sector:'Financials', session:'NYSE' },
        'XLE':  { name:'Energy Select Sector',       price:91.44,  change:-1.12, pe:12.8, mktCap:'37B',   div:'3.21%', divAmt:'0.89', wkHigh:99.28,  wkLow:77.36,  assetClass:'ETF',     sector:'Energy', session:'NYSE' },
        'XLV':  { name:'Health Care Select Sector',  price:149.33, change: 0.18, pe:21.3, mktCap:'37B',   div:'1.61%', divAmt:'0.72', wkHigh:163.82, wkLow:131.19, assetClass:'ETF',     sector:'Healthcare', session:'NYSE' },
        'XLI':  { name:'Industrial Select Sector',   price:138.92, change: 0.29, pe:23.1, mktCap:'19B',   div:'1.43%', divAmt:'0.60', wkHigh:142.88, wkLow:106.24, assetClass:'ETF',     sector:'Industrials', session:'NYSE' },
        // â”€â”€ Commodity ETFs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'GLD':  { name:'SPDR Gold Shares',            price:264.18, change: 0.71, pe:0,   mktCap:'77B',   div:'0.00%', divAmt:'0.00', wkHigh:274.21, wkLow:182.44, assetClass:'Commodity', sector:'Gold', session:'NYSE' },
        'SLV':  { name:'iShares Silver Trust',        price:30.44,  change: 0.92, pe:0,   mktCap:'14B',   div:'0.00%', divAmt:'0.00', wkHigh:33.81,  wkLow:21.04,  assetClass:'Commodity', sector:'Silver', session:'NYSE' },
        'USO':  { name:'United States Oil Fund',      price:73.81,  change:-1.33, pe:0,   mktCap:'1.2B',  div:'0.00%', divAmt:'0.00', wkHigh:87.42,  wkLow:59.18,  assetClass:'Commodity', sector:'Crude Oil', session:'NYSE' },
        'UNG':  { name:'United States Natural Gas',  price:14.62,  change:-2.14, pe:0,   mktCap:'0.4B',  div:'0.00%', divAmt:'0.00', wkHigh:21.88,  wkLow:11.34,  assetClass:'Commodity', sector:'Nat Gas', session:'NYSE' },
        'COPX': { name:'Global X Copper Miners ETF', price:36.77,  change:-0.44, pe:0,   mktCap:'1.8B',  div:'1.20%', divAmt:'0.14', wkHigh:43.12,  wkLow:28.14,  assetClass:'Commodity', sector:'Copper', session:'NYSE' },
        // â”€â”€ Forex (Major Pairs â€” prices as base currency in USD equivalent) â”€
        'EURUSD': { name:'Euro / US Dollar',         price:1.0842, change: 0.12, pe:0, mktCap:'â€”', div:'â€”', divAmt:'0', wkHigh:1.1215, wkLow:1.0448, assetClass:'Forex', sector:'Major', session:'Forex24', lotSize:100000 },
        'USDJPY': { name:'US Dollar / Japanese Yen', price:149.72, change:-0.08, pe:0, mktCap:'â€”', div:'â€”', divAmt:'0', wkHigh:161.94, wkLow:141.64, assetClass:'Forex', sector:'Major', session:'Forex24', lotSize:100000 },
        'GBPUSD': { name:'British Pound / US Dollar',price:1.2638, change: 0.15, pe:0, mktCap:'â€”', div:'â€”', divAmt:'0', wkHigh:1.3127, wkLow:1.2299, assetClass:'Forex', sector:'Major', session:'Forex24', lotSize:100000 },
        'AUDUSD': { name:'Australian Dollar / USD',  price:0.6318, change:-0.21, pe:0, mktCap:'â€”', div:'â€”', divAmt:'0', wkHigh:0.6942, wkLow:0.5994, assetClass:'Forex', sector:'Major', session:'Forex24', lotSize:100000 },
        'USDCAD': { name:'US Dollar / Canadian Dollar',price:1.3948,change: 0.09,pe:0, mktCap:'â€”', div:'â€”', divAmt:'0', wkHigh:1.4792, wkLow:1.3418, assetClass:'Forex', sector:'Major', session:'Forex24', lotSize:100000 },
        // â”€â”€ Digital Assets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        'BTC-USD':  { name:'Bitcoin',         price:98244.0,  change: 1.84,  pe:0, mktCap:'1.94T', div:'0.00%', divAmt:'0.00', wkHigh:109114.0, wkLow:52548.0,  assetClass:'Crypto', sector:'Digital Asset', session:'24/7' },
        'ETH-USD':  { name:'Ethereum',        price:2728.40,  change: 2.11,  pe:0, mktCap:'328B',  div:'0.00%', divAmt:'0.00', wkHigh:4118.0,   wkLow:1784.0,   assetClass:'Crypto', sector:'Digital Asset', session:'24/7' },
        'SOL-USD':  { name:'Solana',          price:198.44,   change: 3.42,  pe:0, mktCap:'96B',   div:'0.00%', divAmt:'0.00', wkHigh:295.83,   wkLow:107.24,   assetClass:'Crypto', sector:'Digital Asset', session:'24/7' },
    };
    // Merge multi-asset into realStockData
    Object.assign(realStockData, multiAssetData);

    const tickers = Object.keys(realStockData);
    // Fill remaining spots to ~200 with realistic sector peers
    const extraTickers = ['PYPL','SQ','UBER','LYFT','SNAP','PINS','TWTR','RBLX','COIN','HOOD','DKNG','PENN','MGM','CZR','WYNN','LVS','NCLH','CCL','RCL','DAL','UAL','AAL','LUV','JBLU','ALK','F','GM','RIVN','LCID','NIO','LI','XPEV','BIDU','JD','PDD','BABA','TCOM','NTES','BILI','IQ','TME','FUTU','TIGR','ZM','DOCU','WORK','BOX','DBX','ESTC','MDB','DDOG','NET','FSLY','CRWD','S','OKTA','MIME','PING','SAIL','SAIL','ATEN','ALTR','CALD','FROG','SUMO','NLOK','VNET','CLDR','SPLK','ONEM','HIMS','TDOC','AMWL','ACCD','PHR','GDRX','CLOV','OSGN','SMAR','APPN','MNDY','TTWO','EA','ATVI','ZNGA','SCPL','MZOR','OMCL','NUAN','HLTH','AMPH','CHNG'];
    extraTickers.forEach(t => {
        if (!realStockData[t]) {
            realStockData[t] = { name: t + ' Corp.', price: +(50 + Math.random()*300).toFixed(2), change: +((Math.random()*6)-2.5).toFixed(2), pe: +(10+Math.random()*50).toFixed(1), mktCap: (Math.random()*200+10).toFixed(0)+'B', div: '0.00%', divAmt:'0.00', wkHigh: 0, wkLow: 0 };
            tickers.push(t);
        }
    });

    let stocks = [];
    let cash = 100000;
    let portfolio = {};
    let leverage = 1;
    let selectedStock = null;
    let watchlist = [];
    let priceAlerts = [];
    let pendingOrders = [];
    let transactions = [];
    let costBasis = {};
    let achievements = [];
    let alertEvents = [];
    let tradeStreak = { count: 0, lastDay: '' };
    let dailyQuest = { date: '', profitableTrades: 0, totalTrades: 0 };
    let tutorialState = { active: false, step: 0 };
    let allocationChart = null;
    let marketLoopStarted = false;

    // Initialize Market
    function initMarket() {
        stocks = tickers.map(symbol => {
            const d = realStockData[symbol];
            const wkHigh = d.wkHigh || +(d.price * (1.2 + Math.random()*0.3)).toFixed(2);
            const wkLow  = d.wkLow  || +(d.price * (0.65 + Math.random()*0.2)).toFixed(2);
            return {
                symbol,
                name: d.name,
                price: d.price,
                change: d.change,
                pe: d.pe,
                mktCap: d.mktCap,
                div: d.div,
                divAmt: d.divAmt,
                wkHigh,
                wkLow,
                sector: inferSector(symbol, d.name)
            };
        });
        renderGrid();
        updateUI();
        renderNews();
        if (!marketLoopStarted) {
            marketLoopStarted = true;
            setInterval(simulateMarketTick, 30000);
            setInterval(recordPerfSnapshot, 300000); // snapshot every 5 min
        }
        // Start live data if API key is already stored
        updateMarketStatus();
        updateDataSourceUI();
        if (RT.key) startLiveData();
        // Initial performance snapshot + chart draw
        recordPerfSnapshot();
        setTimeout(drawPerfChart, 200);
    }

    // --- Rendering ---
    function renderGrid() {
        const query = document.getElementById('search').value.toUpperCase();
        const grid  = document.getElementById('grid');

        let displayList = query
            ? stocks.filter(s => s.symbol.includes(query) || s.name.toUpperCase().includes(query)).slice(0, 50)
            : stocks.slice(0, 50);

        // Build a map of existing cards by symbol so we can update in-place
        const existingCards = {};
        grid.querySelectorAll('[data-symbol]').forEach(el => {
            existingCards[el.dataset.symbol] = el;
        });

        const symbolsInDisplay = new Set(displayList.map(s => s.symbol));

        // Remove cards no longer in the list
        Object.keys(existingCards).forEach(sym => {
            if (!symbolsInDisplay.has(sym)) existingCards[sym].remove();
        });

        displayList.forEach((stock, idx) => {
            const isPos = stock.change >= 0;
            const pillClass = isPos ? 'pill-up' : 'pill-down';
            const changeStr = (isPos ? '+' : '') + stock.change.toFixed(2) + '%';
            const priceStr  = '$' + stock.price.toFixed(2);
            const freshLabel = getCardFreshnessLabel(stock.symbol);

            if (existingCards[stock.symbol]) {
                // Card exists â€” update only changed text nodes (no full rebuild)
                const card = existingCards[stock.symbol];
                const pill  = card.querySelector('.change-pill');
                const price = card.querySelector('.stock-price');
                const sym   = card.querySelector('.stock-sym');
                const oldPrice = price ? parseFloat(price.textContent.replace('$','')) : null;
                if (pill)  { pill.className  = 'change-pill ' + pillClass; pill.textContent = changeStr; }
                if (price && price.textContent !== priceStr) {
                    price.textContent = priceStr;
                    // Flash card background green/red on price change
                    if (oldPrice !== null) {
                        card.classList.remove('flash-up','flash-down');
                        void card.offsetWidth; // force reflow to restart animation
                        card.classList.add(stock.price >= oldPrice ? 'flash-up' : 'flash-down');
                    }
                }
                if (sym)   sym.innerHTML = stock.symbol + freshLabel;
                // Ensure position in grid matches sorted order
                if (grid.children[idx] !== card) grid.insertBefore(card, grid.children[idx] || null);
            } else {
                // New card â€” create it
                const card = document.createElement('div');
                card.className    = 'g-card cursor-pointer';
                card.style.cssText = 'padding:16px;display:flex;flex-direction:column;justify-content:space-between;min-height:120px;';
                card.dataset.symbol = stock.symbol;
                card.onclick = () => openModal(stock);
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;">
                        <div style="min-width:0;">
                            <div class="stock-sym" style="font-weight:700;color:#e8e8f5;font-size:0.9rem;letter-spacing:0.02em;white-space:nowrap;">${stock.symbol}${freshLabel}</div>
                            <div style="font-size:0.7rem;color:#6868a0;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${stock.name}</div>
                        </div>
                        <div class="change-pill ${pillClass}" style="flex-shrink:0;">${changeStr}</div>
                    </div>
                    <div style="margin-top:12px;">
                        <div class="stock-price" style="font-size:1.45rem;font-weight:300;color:#f0f0fa;font-family:var(--v-mono);line-height:1;">${priceStr}</div>
                        <div style="font-size:9px;color:#5858a0;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em;">${stock.sector || ''}</div>
                    </div>`;
                grid.insertBefore(card, grid.children[idx] || null);
            }
        });
    }

    // sChart, volChart, detailStock, currentChartPeriod, activeIndicators declared in chart engine above
    let detailStock = null;

    function openModal(stock) { openStockDetail(stock); }

    function openStockDetail(stock) {
        detailStock = stock;
        // Fetch fresh quote on open, then just update the price fields in place (no recursive re-open)
        if (RT.key) {
            fetchQuote(stock.symbol).then(data => {
                if (data && detailStock && detailStock.symbol === stock.symbol) {
                    applyRealQuote(stock.symbol, data);
                    const s = getStockBySymbol(stock.symbol);
                    if (!s) return;
                    const isPos2 = s.change >= 0;
                    const changeAmt2 = s.price * Math.abs(s.change) / 100;
                    const color2 = isPos2 ? '#81c995' : '#f28b82';
                    document.getElementById('detailPrice').innerText = s.price.toFixed(2);
                    document.getElementById('detailChangeAmt').style.color = color2;
                    document.getElementById('detailChangeAmt').innerText = (isPos2?'+':'-') + changeAmt2.toFixed(2);
                    document.getElementById('detailChangePct').style.color = color2;
                    document.getElementById('detailChangePct').innerText = '(' + Math.abs(s.change).toFixed(2) + '%)';
                    document.getElementById('detailArrow').style.color = color2;
                    document.getElementById('detailArrow').innerText = isPos2 ? 'â†‘' : 'â†“';
                    if (s.dayHigh) document.getElementById('sHigh').innerText = '$' + s.dayHigh.toFixed(2);
                    if (s.dayLow)  document.getElementById('sLow').innerText  = '$' + s.dayLow.toFixed(2);
                    if (s.dayOpen) document.getElementById('sOpen').innerText = '$' + s.dayOpen.toFixed(2);
                }
            });
        }
        document.getElementById('stockDetailPage').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const isPos = stock.change >= 0;
        const changeAmt = (stock.price * Math.abs(stock.change) / 100);
        const color = isPos ? '#81c995' : '#f28b82';
        document.getElementById('detailHeaderSymbol').innerText = stock.symbol;
        document.getElementById('detailName').innerText = stock.name;
        document.getElementById('detailPrice').innerText = stock.price.toFixed(2);
        document.getElementById('detailChangeAmt').style.color = color;
        document.getElementById('detailChangeAmt').innerText = (isPos?'+':'-') + changeAmt.toFixed(2);
        document.getElementById('detailChangePct').style.color = color;
        document.getElementById('detailChangePct').innerText = '(' + Math.abs(stock.change).toFixed(2) + '%)';
        document.getElementById('detailArrow').style.color = color;
        document.getElementById('detailArrow').innerText = isPos ? 'â†‘' : 'â†“';
        document.getElementById('detailPremarket').innerText = 'Pre-market ' + (stock.price*0.997).toFixed(2) + ' -' + (stock.price*0.003).toFixed(2) + ' (0.35%)';
        // prevClose: prefer live API value (from Finnhub quote pc field), else calculate
        const prevClosePrice = stock.prevClose || (stock.price - changeAmt*(isPos?1:-1));
        document.getElementById('prevCloseVal').innerText = prevClosePrice.toFixed(2);
        document.getElementById('sOpen').innerText = '$' + (stock.dayOpen || (stock.price * (1 + (Math.random()*0.005 - 0.002)))).toFixed(2);
        document.getElementById('sHigh').innerText = '$' + (stock.dayHigh || (stock.price * 1.008)).toFixed(2);
        document.getElementById('sLow').innerText  = '$' + (stock.dayLow  || (stock.price * 0.992)).toFixed(2);
        document.getElementById('sMktCap').innerText = stock.mktCap || 'â€”';
        document.getElementById('sPE').innerText = stock.pe > 0 ? stock.pe.toFixed(2) : 'N/A';
        document.getElementById('s52H').innerText = '$' + (stock.wkHigh || (stock.price * 1.3)).toFixed(2);
        document.getElementById('s52L').innerText = '$' + (stock.wkLow || (stock.price * 0.7)).toFixed(2);
        document.getElementById('sDividend').innerText = stock.div || '0.00%';
        document.getElementById('sDivAmt').innerText = stock.divAmt > 0 ? '$' + stock.divAmt : 'â€”';
        document.getElementById('tradeSymLabel').innerText = stock.symbol;
        document.getElementById('dBuyPow').innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
        document.getElementById('dShares').innerText = portfolio[stock.symbol] || 0;
        document.getElementById('alertSymbol').value = stock.symbol;
        updateFollowButton();
        renderDetailNews(stock.symbol);
        renderPendingOrders();
        onTutorialEvent('open_stock');

        // Dim trade buttons if no API key
        const buyBtn  = document.querySelector('[onclick="execDetailTrade(\'BUY\')"]');
        const sellBtn = document.querySelector('[onclick="execDetailTrade(\'SELL\')"]');
        if (buyBtn && sellBtn) {
            if (!RT.key) {
                buyBtn.style.opacity  = '0.45';
                sellBtn.style.opacity = '0.45';
                buyBtn.title  = 'Connect Live Data API to trade';
                sellBtn.title = 'Connect Live Data API to trade';
            } else {
                buyBtn.style.opacity  = '1';
                sellBtn.style.opacity = '1';
                buyBtn.title  = '';
                sellBtn.title = '';
            }
        }
        document.querySelectorAll('.ctab').forEach(b => { b.className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200'; });
        document.querySelector('.ctab').className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-[#8ab4f8] text-[#8ab4f8]';
        // Draw chart after a microtask to allow the async fetchQuote (fired above)
        // to warm RT.cache before resolveCandles runs. The one-shot quote fetch
        // inside resolveCandles acts as a second safety net if the above is still pending.
        Promise.resolve().then(() => {
            // Initialize the resolution row for default period (1D) before drawing
            _currentIntradayRes = '5';
            _syncResolutionRow('1D');
            drawChart(stock, '1D');
        });
        // New feature panels
        renderAnalystRatings(stock);
        renderEarnings(stock);
        renderSimilarStocks(stock);
        renderStockJournalNote(stock.symbol);
    }

    function closeStockDetail() {
        // Clean chart state so next stock starts fresh
        clearInterval(_liveRefreshTimer); _liveRefreshTimer = null;
        _chartDebugMode = false;
        const dbg = document.getElementById('chartDebugOverlay');
        if (dbg) dbg.style.display = 'none';
        document.getElementById('stockDetailPage').classList.add('hidden');
        document.body.style.overflow = '';
        detailStock = null;
        destroyCharts();
        activeIndicators.clear();
        document.querySelectorAll('.ind-btn').forEach(b=>{b.style.background='transparent';b.style.color='#8888a8';b.style.borderColor='rgba(255,255,255,0.1)';});
        ['rsiChartWrap','macdChartWrap'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
    }

    function closeModal() { closeStockDetail(); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   CHART ENGINE v3  â€”  Production candlestick + volume + indicators
    //   â€¢ Chart.js Financial plugin (candlestick) with pure-canvas fallback
    //   â€¢ Finnhub resolution â†’ correct time unit, correct from/to windows
    //   â€¢ chart.data.datasets[0].data = newData; chart.update('none')
    //     (no destroy/recreate on interval change â€” prevents flicker)
    //   â€¢ Live 1m refresh every 30s (market open only)
    //   â€¢ Earnings markers, crosshair, themed tooltips
    //   â€¢ Intraday interval row (1m/5m/15m/1H) auto-shown for short periods
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let sChart    = null;   // Chart.js candlestick instance
    let volChart  = null;   // Chart.js volume bar instance
    let activeIndicators = new Set();
    let currentChartPeriod  = '1D';
    let _currentIntradayRes = '5';   // Finnhub resolution for current period
    let _chartFetchId       = 0;     // stale-fetch guard
    let _periodDebounce     = null;
    let _liveRefreshTimer   = null;
    let _lastLiveCandle     = 0;     // timestamp of last live candle (ms)
    const candleCache = {};          // symbol||period||res â†’ {data, ts}  (fully isolated)
    let _chartDebugMode = false;     // toggle with Shift+D on chart page
    let _chartDebugInfo = {};        // populated by fetchCandles + drawChart

    // â”€â”€ Debug overlay Â§8 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateChartDebugOverlay() {
        const el = document.getElementById('chartDebugOverlay');
        if (!el) return;
        el.style.display = _chartDebugMode ? 'block' : 'none';
        if (!_chartDebugMode) return;
        const d = _chartDebugInfo;
        const fmt = ts => ts ? new Date(ts).toLocaleString([], {month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}) : 'N/A';
        const mismatchRow = d.priceMismatch ? `<div style="color:#f59e0b">âš  Price Î”: ${d.priceMismatch}</div>` : '';
        const cacheCount = Object.keys(candleCache).length;
        el.innerHTML = `
            <div style="font-size:9px;line-height:1.65;color:#e0e0f5;">
                <div style="font-weight:700;color:#f59e0b;margin-bottom:4px;font-size:10px;">ğŸ” Chart Debug v5 â€” UDP</div>
                <div><span style="color:#8888a8;">Symbol:</span> ${d.symbol||'â€”'} | <span style="color:#8888a8;">Period:</span> ${d.period||'â€”'}</div>
                <div><span style="color:#8888a8;">Res:</span> ${d.res||'â€”'} | <span style="color:#8888a8;">Candles:</span> ${d.count||0} | <span style="color:#8888a8;">Base:</span> ${d.baseDays||0}d</div>
                <div style="border-top:1px solid rgba(255,255,255,0.08);margin:3px 0;padding-top:3px;"></div>
                <div><span style="color:#8888a8;">First:</span> ${fmt(d.first?.x)} @ $${d.first?.c?.toFixed(2)||'â€”'}</div>
                <div><span style="color:#8888a8;">Last: </span> ${fmt(d.last?.x)}  @ $${d.last?.c?.toFixed(2)||'â€”'}</div>
                <div><span style="color:#8888a8;">Range:</span> $${d.minPrice?.toFixed(2)||'â€”'} â€“ $${d.maxPrice?.toFixed(2)||'â€”'}</div>
                <div style="border-top:1px solid rgba(255,255,255,0.08);margin:3px 0;padding-top:3px;"></div>
                <div><span style="color:#8888a8;">Live quote:</span> <span style="color:#4ade80;">$${typeof d.liveQuote==='number'?d.liveQuote.toFixed(4):d.liveQuote}</span></div>
                <div><span style="color:#8888a8;">Last close: </span> <span style="color:#e0e0f5;">$${typeof d.lastClose==='number'?d.lastClose.toFixed(4):d.lastClose||'â€”'}</span></div>
                <div><span style="color:#8888a8;">Quote Î”:</span> <span style="font-weight:700;color:${d.quoteDiff==='âœ“ synced'?'#4ade80':d.quoteDiff==='â€”'?'#8888a8':'#f87171'}">${d.quoteDiff||'â€”'}</span> <span style="color:#6060a0;font-size:8px;">(must be âœ“ synced)</span></div>
                <div><span style="color:#8888a8;">Chart $:</span> $${typeof d.lastClose==='number'?d.lastClose.toFixed(4):'â€”'} | <span style="color:#8888a8;">Header $:</span> $${typeof d.liveQuote==='number'?d.liveQuote.toFixed(4):'â€”'}</div>
                <div><span style="color:#8888a8;">Split Ã—:</span> ${d.splitFactor||'â€”'}</div>
                <div style="border-top:1px solid rgba(255,255,255,0.08);margin:3px 0;padding-top:3px;"></div>
                <div><span style="color:#8888a8;">Data:</span> <span style="color:${d.isSimulated?'#f87171':'#4ade80'}">${d.isSimulated?'âš  Simulated':'âœ“ Adj live'}</span> | <span style="color:#8888a8;">Cache:</span> ${cacheCount}</div>
                ${d.ytdPct!=null?`<div><span style="color:#8888a8;">YTD:</span> <span style="color:${parseFloat(d.ytdPct)>=0?'#4ade80':'#f87171'}">${d.ytdPct>=0?'+':''}${d.ytdPct}%</span></div>`:''}
                ${mismatchRow}
                <div style="color:#5050a0;margin-top:4px;font-size:8px;">Shift+D toggle Â· Shift+C clear cache</div>
            </div>`;
    }

    // â”€â”€ Debug hotkeys: Shift+D (toggle overlay), Shift+C (clear cache) â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document.addEventListener('keydown', e => {
        if (!document.getElementById('stockDetailPage') ||
            document.getElementById('stockDetailPage').classList.contains('hidden')) return;
        if (e.shiftKey && e.key === 'D') {
            _chartDebugMode = !_chartDebugMode;
            updateChartDebugOverlay();
        }
        if (e.shiftKey && e.key === 'C') {
            // Clear ALL caches: candleCache (shim), _baseStore (daily base), _intradayStore (1D)
            Object.keys(candleCache).forEach(k => delete candleCache[k]);
            Object.keys(_baseStore).forEach(k => delete _baseStore[k]);
            Object.keys(_intradayStore).forEach(k => delete _intradayStore[k]);
            Object.keys(_baseLoading).forEach(k => delete _baseLoading[k]);
            if (detailStock) drawChart(detailStock, currentChartPeriod);
            console.log('[UDP] All caches cleared via Shift+C');
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UNIFIED PERIOD Ã— RESOLUTION MATRIX  (single source of truth)
    //
    //  PERIOD_CFG[period] defines:
    //    windowSec   â€” how far back to fetch from Finnhub (with calendar buffer)
    //    defaultRes  â€” the Finnhub resolution used unless user overrides
    //    allowedRes  â€” which resolution buttons are valid for this period
    //    unit        â€” Chart.js time unit for axis labels
    //    isIntraday  â€” true = use fetchIntraday path; false = use fetchBase path
    //    maxPts      â€” max candles to keep (trim oldest if exceeded)
    //
    //  RESOLUTION OVERRIDE RULE:
    //    The bottom row only changes resolution within the SAME period.
    //    It never changes windowSec â€” that is controlled exclusively by the top row.
    //    fetchIntraday receives (windowSec from period, res from user/default).
    //    aggregateBase receives period for its date window, ignores res (daily base).
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const PERIOD_CFG = {
        '1D':  { windowSec:3*86400,       defaultRes:'5',  allowedRes:['1','5','15','60'],  unit:'minute', isIntraday:true,  maxPts:500 },
        '5D':  { windowSec:9*86400,       defaultRes:'15', allowedRes:['5','15','60'],      unit:'minute', isIntraday:true,  maxPts:500 },
        '1M':  { windowSec:40*86400,      defaultRes:'D',  allowedRes:['D'],                unit:'day',    isIntraday:false, maxPts:35  },
        '6M':  { windowSec:200*86400,     defaultRes:'D',  allowedRes:['D'],                unit:'day',    isIntraday:false, maxPts:140 },
        'YTD': { windowSec:null,          defaultRes:'D',  allowedRes:['D'],                unit:'day',    isIntraday:false, maxPts:260 },
        '1Y':  { windowSec:380*86400,     defaultRes:'W',  allowedRes:['D','W'],            unit:'week',   isIntraday:false, maxPts:56  },
        '5Y':  { windowSec:5*385*86400,   defaultRes:'W',  allowedRes:['W'],                unit:'week',   isIntraday:false, maxPts:270 },
        'Max': { windowSec:22*365*86400,  defaultRes:'M',  allowedRes:['M'],                unit:'month',  isIntraday:false, maxPts:264 },
    };

    // Resolution â†’ Chart.js time unit
    const RES_TO_UNIT = {
        '1':'minute','5':'minute','15':'minute','60':'hour',
        'D':'day','W':'week','M':'month',
    };

    // Keep INTERVAL_CFG as a compatibility alias (some legacy paths reference it)
    const INTERVAL_CFG = {
        '1D':  { res:'5',  fromSec:3*86400,      unit:'minute', maxPts:500, showItv:true,  itvDef:'5'  },
        '5D':  { res:'15', fromSec:9*86400,      unit:'minute', maxPts:500, showItv:true,  itvDef:'15' },
        '1M':  { res:'D',  fromSec:40*86400,     unit:'day',    maxPts:35,  showItv:false, itvDef:'D'  },
        '6M':  { res:'D',  fromSec:200*86400,    unit:'day',    maxPts:140, showItv:false, itvDef:'D'  },
        'YTD': { res:'D',  fromSec:null,         unit:'day',    maxPts:260, showItv:false, itvDef:'D'  },
        '1Y':  { res:'W',  fromSec:380*86400,    unit:'week',   maxPts:56,  showItv:false, itvDef:'W'  },
        '5Y':  { res:'W',  fromSec:5*385*86400,  unit:'week',   maxPts:270, showItv:false, itvDef:'W'  },
        'Max': { res:'M',  fromSec:22*365*86400, unit:'month',  maxPts:264, showItv:false, itvDef:'M'  },
    };

    function isDark() { return !document.body.classList.contains('light-mode'); }
    function themeColors() {
        return isDark()
            ? { bg:'#1c1c1e', grid:'rgba(255,255,255,0.055)', text:'#9aa0a6', tooltip:'rgba(20,20,28,0.97)', border:'rgba(255,255,255,0.1)' }
            : { bg:'#ffffff',  grid:'rgba(0,0,0,0.06)',        text:'#606078', tooltip:'rgba(248,248,255,0.97)', border:'rgba(0,0,0,0.08)' };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UNIFIED DATA PIPELINE  v4  â€”  Single source of truth
    //
    //  Architecture:
    //    Step 1 â€” fetchBase()       : MAX-range daily adjusted candles for symbol
    //    Step 2 â€” aggregateBase()   : derive any period view from that base
    //    Step 3 â€” syncQuoteToCandles(): patch last candle with /quote live price
    //    Step 4 â€” isBaseStale()     : force re-fetch if >5 calendar days old
    //    Step 5 â€” validateDataset() : log integrity issues, never silent-fail
    //    Step 6 â€” buildDebugInfo()  : populate Shift+D panel with split factor,
    //                                 quote diff, base day count
    //
    //  resolveCandles(symbol, period, intradayRes) is the single public API.
    //  fetchCandles() is kept as a thin shim for backward compat.
    //  candleCache is kept for the live-refresh timer (1D intraday).
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Base store â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _baseStore   = {};   // symbol â†’ { candles[], fetchedAt, splitFactor, quote }
    const _intradayStore = {}; // `${symbol}||${res}` â†’ { candles[], fetchedAt }
    const _baseLoading = {};   // symbol â†’ Promise (deduplicate concurrent calls)
    const BASE_TTL     = 5 * 60 * 1000;   // 5 min
    const INTRADAY_TTL = 30  * 1000;       // 30 s

    // â”€â”€ Simulation fallback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Used ONLY when API unavailable. Anchors last candle to stock.price.
    //   Seeded by price so same stock always generates the same-looking history.
    function generateSimCandles(stock, period) {
        const nMap  = { '1D':78,'5D':5,'1M':22,'6M':130,'YTD':180,'1Y':252,'5Y':260,'Max':120 };
        const vMap  = { '1D':0.003,'5D':0.004,'1M':0.008,'6M':0.010,
                        'YTD':0.010,'1Y':0.012,'5Y':0.018,'Max':0.022 };
        const iMap  = { '1D':300000,'5D':86400000,'1M':86400000,'6M':86400000,
                        'YTD':86400000,'1Y':86400000,'5Y':604800000,'Max':2592000000 };
        const n     = nMap[period]  || 80;
        const volPct = vMap[period]  || 0.010;
        const itvMs = iMap[period]  || 86400000;
        let rng = Math.abs(Math.round(stock.price * 7919)) % 4294967296 || 1;
        const rand = () => { rng=(rng*1664525+1013904223)%4294967296; return rng/4294967296; };
        const closes = [stock.price];
        for (let i=1;i<n;i++) {
            const p=closes[i-1];
            closes.push(Math.max(p*0.5, p*(1+(rand()-0.5)*2*volPct-0.0002)));
        }
        closes.reverse();
        const now=Date.now();
        return closes.map((cl,i)=>{
            const t=now-(n-1-i)*itvMs, sw=cl*volPct*0.6;
            const o=cl+(rand()-0.5)*sw, h=Math.max(o,cl)+rand()*sw*0.3, l=Math.min(o,cl)-rand()*sw*0.3;
            return{x:t,o:+o.toFixed(4),h:+h.toFixed(4),l:+l.toFixed(4),
                   c:+cl.toFixed(4),v:Math.round(cl*8e4*(0.6+rand()*0.8)),adjusted:false};
        });
    }

    // â”€â”€ Candle integrity validator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function validateRawCandles(raw, label) {
        const errs=[];
        let out = raw.filter((c,i)=>{
            if(c.o==null||c.h==null||c.l==null||c.c==null){errs.push(`[${i}] null OHLC`);return false;}
            if(c.c<=0||c.o<=0){errs.push(`[${i}] zero price`);return false;}
            c.h=Math.max(c.h,c.o,c.c); c.l=Math.min(c.l,c.o,c.c);
            return true;
        });
        out.sort((a,b)=>a.x-b.x);
        out=out.filter((c,i)=>i===0||c.x!==out[i-1].x);
        if(out.length>4){
            const sorted=out.map(c=>c.c).sort((a,b)=>a-b);
            const med=sorted[Math.floor(sorted.length/2)];
            out=out.filter(c=>c.c>med*0.005&&c.c<med*200);
        }
        if(errs.length) console.warn(`[UDP] ${label}:`,errs);
        return out;
    }

    // â”€â”€ Step 1 â€” fetchBase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Fetches 22 years of daily adjusted candles once per symbol.
    //   Also calls /stock/split for informational split factor.
    async function fetchBase(symbol) {
        if(!RT||!RT.key) return null;
        // Deduplication: concurrent calls for same symbol share one in-flight Promise
        if(_baseLoading[symbol]) return _baseLoading[symbol];
        // Cache hit
        const ex=_baseStore[symbol];
        if(ex&&(Date.now()-ex.fetchedAt)<BASE_TTL) return ex;

        // IMPORTANT: capture Promise in local var. The `finally` block deletes
        // _baseLoading[symbol] before callers would read it via the property.
        const promise=(async()=>{
            try{
                const toSec=Math.floor(Date.now()/1000);
                const frSec=toSec-22*365*86400;  // 22 years of daily history
                const url=`https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=D&from=${frSec}&to=${toSec}&adjusted=true&token=${RT.key}`;
                const r=await fetch(url);
                if(r.status===429){showChartOverlay('ratelimit');setRateLimit();return null;}
                if(!r.ok) return null;
                const d=await r.json();
                if(!d||d.s!=='ok'||!d.t?.length) return null;

                let raw=d.t.map((ts,i)=>({
                    x:ts*1000,o:d.o[i],h:d.h[i],l:d.l[i],c:d.c[i],
                    v:d.v?(d.v[i]||0):0
                }));
                raw=validateRawCandles(raw,`${symbol}/base`);
                if(raw.length<5) return null;

                // Fetch split history for debug panel (informational only â€”
                // candles already come split-adjusted via adjusted=true)
                let splitFactor=1;
                try{
                    const yr=new Date().getFullYear();
                    const su=`https://finnhub.io/api/v1/stock/split?symbol=${encodeURIComponent(symbol)}&from=${yr-22}-01-01&to=${yr}-12-31&token=${RT.key}`;
                    const sr=await fetch(su);
                    if(sr.ok){
                        const sd=await sr.json();
                        if(Array.isArray(sd)&&sd.length){
                            splitFactor=sd.reduce((acc,s)=>acc*((s.toFactor||1)/(s.fromFactor||1)),1);
                        }
                    }
                }catch(_){}  // split fetch never blocks chart

                const candles=raw.map(c=>({
                    x:c.x,
                    o:+c.o.toFixed(4),h:+c.h.toFixed(4),
                    l:+c.l.toFixed(4),c:+c.c.toFixed(4),
                    v:Math.round(c.v||0),adjusted:true
                }));
                const entry={candles,fetchedAt:Date.now(),splitFactor,quote:null,symbol};
                _baseStore[symbol]=entry;
                console.log(`[UDP] ${symbol}: ${candles.length} adj daily | splitÃ—${splitFactor.toFixed(4)} | $${candles[0].c.toFixed(2)}â†’$${candles[candles.length-1].c.toFixed(2)}`);
                return entry;
            }catch(e){console.warn('[UDP] fetchBase error:',e);return null;}
            finally{delete _baseLoading[symbol];}  // release lock whether success or fail
        })();
        _baseLoading[symbol]=promise;  // register for deduplication
        return promise;                // return captured ref (not _baseLoading which was just deleted)
    }

    // â”€â”€ Step 2 â€” aggregateBase â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Derives view candles from daily base.
    //   Aggregation: O=first, H=max, L=min, C=last, V=sum. Never average.
    function aggregateBase(daily, period) {
        if(!daily||daily.length===0) return [];
        const now=Date.now();
        let fromMs;
        if(period==='YTD'){
            const y=new Date().getFullYear();
            fromMs=Date.UTC(y,0,1,5,0,0); // Jan 1 00:00 EST (UTC-5, always in Jan)
        } else {
            const days={'5D':9,'1M':40,'6M':200,'1Y':380,'5Y':5*385,'Max':0};
            const d=days[period];
            fromMs = (d===0||d==null) ? 0 : now-d*86400000;
        }

        const win=daily.filter(c=>c.x>=fromMs);
        if(win.length===0) return daily.slice(-5);

        // 5Y â†’ weekly buckets; Max â†’ monthly buckets; others â†’ daily as-is
        if(period!=='5Y'&&period!=='Max') return win;

        const bucketFn = c => {
            const d=new Date(c.x);
            if(period==='5Y'){
                // ISO week: anchor to Monday
                const dow=d.getUTCDay()||7;
                const mon=new Date(d); mon.setUTCDate(d.getUTCDate()-(dow-1));
                return `${mon.getUTCFullYear()}-${String(mon.getUTCMonth()).padStart(2,'0')}-${String(mon.getUTCDate()).padStart(2,'0')}`;
            }
            return `${d.getUTCFullYear()}-${String(d.getUTCMonth()).padStart(2,'0')}`;
        };

        const buckets=new Map();
        for(const c of win){
            const k=bucketFn(c);
            if(!buckets.has(k)){
                buckets.set(k,{x:c.x,o:c.o,h:c.h,l:c.l,c:c.c,v:c.v||0,adjusted:true});
            } else {
                const b=buckets.get(k);
                b.h=Math.max(b.h,c.h); b.l=Math.min(b.l,c.l);
                b.c=c.c; b.v+=(c.v||0); // close = last, vol = sum
            }
        }
        return [...buckets.values()].sort((a,b)=>a.x-b.x);
    }

    // â”€â”€ Step 1b â€” fetchIntraday (1D and 5D) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   windowSec: how far back to fetch (3Ã—86400 for 1D, 9Ã—86400 for 5D)
    //   period:    '1D' filters to today only; '5D' keeps all sessions in window
    async function fetchIntraday(symbol, res, windowSec, period) {
        if(!RT||!RT.key) return null;
        const effWindow = windowSec || 3*86400;
        const key = `${symbol}||${res}||${period||'1D'}`;
        const cached = _intradayStore[key];
        if(cached && (Date.now()-cached.fetchedAt) < INTRADAY_TTL) return cached.candles;

        const toSec = Math.floor(Date.now()/1000);
        const frSec = toSec - effWindow;
        try{
            const url = `https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=${res}&from=${frSec}&to=${toSec}&adjusted=true&token=${RT.key}`;
            const r = await fetch(url);
            if(r.status===429){ showChartOverlay('ratelimit'); setRateLimit(); return null; }
            if(!r.ok) return null;
            const d = await r.json();
            if(!d||d.s!=='ok'||!d.t?.length) return null;

            let raw = d.t.map((ts,i)=>({x:ts*1000,o:d.o[i],h:d.h[i],l:d.l[i],c:d.c[i],v:d.v?(d.v[i]||0):0}));
            raw = validateRawCandles(raw, `${symbol}/intra`);

            let candles;
            if(period === '5D') {
                // 5D: keep all regular-session candles in the 9-day window
                // This gives 5 trading days of intraday data
                candles = raw.filter(c => {
                    const et = new Date(new Date(c.x).toLocaleString('en-US',{timeZone:'America/New_York'}));
                    const mins = et.getHours()*60 + et.getMinutes();
                    return mins >= 9*60+30 && mins <= 16*60;
                });
                if(candles.length < 3) candles = raw; // fallback: use all data
            } else {
                // 1D: prefer today's session only
                const nowET = new Date(new Date().toLocaleString('en-US',{timeZone:'America/New_York'}));
                const todayCandles = raw.filter(c => {
                    const et = new Date(new Date(c.x).toLocaleString('en-US',{timeZone:'America/New_York'}));
                    const mins = et.getHours()*60 + et.getMinutes();
                    return et.getDate()===nowET.getDate() && et.getMonth()===nowET.getMonth()
                        && et.getFullYear()===nowET.getFullYear() && mins>=9*60+30 && mins<=16*60;
                });
                candles = todayCandles.length >= 3 ? todayCandles : raw.slice(-200);
            }

            candles = candles.map(c=>({
                x:c.x, o:+c.o.toFixed(4), h:+c.h.toFixed(4),
                l:+c.l.toFixed(4), c:+c.c.toFixed(4),
                v:Math.round(c.v||0), adjusted:true
            }));
            _intradayStore[key] = {candles, fetchedAt:Date.now()};
            return candles;
        } catch(e) { return null; }
    }

    // â”€â”€ Step 3 â€” syncQuoteToCandles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Patches last candle so chart close = header price = portfolio price.
    //   Tolerance: $0.005 (half-cent). If within tolerance, no mutation.
    function syncQuoteToCandles(candles, livePrice) {
        if(!candles||candles.length===0||!(livePrice>0)) return candles;
        const last=candles[candles.length-1];
        const diff=Math.abs(last.c-livePrice);
        if(diff<0.005) return candles;   // within half-cent tolerance â€” no mutation

        const cloned=candles.map(c=>({...c}));
        const lc=cloned[cloned.length-1];
        const market=isMarketOpen();

        if(market){
            // Market hours: update current candle in place
            lc.c=+livePrice.toFixed(4);
            lc.h=Math.max(lc.h,livePrice);
            lc.l=Math.min(lc.l,livePrice);
        } else if(diff>0.005){
            // After-hours and meaningful move: append extended-session stub
            const nowMs=Date.now();
            if(nowMs-lc.x>60000){
                cloned.push({x:nowMs,o:lc.c,h:Math.max(lc.c,livePrice),
                    l:Math.min(lc.c,livePrice),c:+livePrice.toFixed(4),
                    v:0,adjusted:true,extended:true});
            } else {
                lc.c=+livePrice.toFixed(4);
                lc.h=Math.max(lc.h,livePrice);
                lc.l=Math.min(lc.l,livePrice);
            }
        }
        return cloned;
    }

    // â”€â”€ Step 4 â€” stale detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function isBaseStale(entry){
        if(!entry||!entry.candles.length) return true;
        // Stale if last candle is more than 3 calendar days old.
        // 3 days catches: last candle is Fri close, it's now Mon morning (2 days gap).
        // Prevents showing Friday data on Monday without re-fetching.
        return Date.now()-entry.candles[entry.candles.length-1].x > 3*86400000;
    }

    // â”€â”€ Step 5 â€” dataset validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function validateDataset(candles,symbol,period,livePrice){
        if(!candles||candles.length===0){console.warn(`[UDP] ${symbol}/${period}: empty`);return;}
        const issues=[];
        if(candles.some(c=>c.c<=0)) issues.push('zero/neg prices');
        for(let i=1;i<candles.length;i++){
            if(candles[i].x<=candles[i-1].x){issues.push(`ts not increasing at [${i}]`);break;}
        }
        if(livePrice>0){
            const diff=Math.abs(candles[candles.length-1].c-livePrice);
            if(diff>0.01) issues.push(`last candle $${candles[candles.length-1].c.toFixed(4)} vs quote $${livePrice.toFixed(4)} (Î”${diff.toFixed(4)})`);
        }
        if(issues.length) console.warn(`[UDP] ${symbol}/${period} validation:`,issues);
    }

    // â”€â”€ Master resolver â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Single entry point. Enforces the contract:
    //     period  â†’ controls date window (windowSec / YTD / Max)
    //     res     â†’ controls candle granularity within that window
    //   They are independent axes. Changing res never changes windowSec.
    //
    //   Routing:
    //     1D / 5D  â†’ fetchIntraday(symbol, res, windowSec, period)
    //     1Mâ€“Max   â†’ fetchBase (22yr daily) â†’ aggregateBase(period) â†’ done
    //                 (res is informational only for daily+; aggregation handles it)
    //
    //   Quote sync guarantee:
    //     Live price is patched into the last candle after every resolve,
    //     within $0.005 tolerance. After-hours appended as extended stub.
    async function resolveCandles(symbol, period, res) {
        const pcfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        // Effective resolution: user override if allowed for this period, else default
        const allowedRes = pcfg.allowedRes || [pcfg.defaultRes];
        const effectiveRes = (res && allowedRes.includes(res)) ? res : pcfg.defaultRes;

        // â”€â”€ Live price warm-up â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let livePrice = RT.cache[symbol]?.price || 0;
        if (livePrice <= 0 && RT && RT.key) {
            const qt = await fetchQuote(symbol);
            if (qt && qt.c > 0) {
                livePrice = qt.c;
                RT.cache[symbol] = { price: qt.c, change: (qt.dp||0), ts: Date.now() };
                const stk = getStockBySymbol(symbol);
                if (stk) {
                    stk.price = qt.c;
                    if (qt.dp != null) stk.change = qt.dp;
                    if (qt.h)  stk.dayHigh   = qt.h;
                    if (qt.l)  stk.dayLow    = qt.l;
                    if (qt.o)  stk.dayOpen   = qt.o;
                    if (qt.pc) stk.prevClose = qt.pc;
                }
            }
        }

        // â”€â”€ INTRADAY PATH: 1D and 5D â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //   windowSec comes from PERIOD_CFG[period].windowSec (never from res)
        //   effectiveRes controls candle granularity only
        if (pcfg.isIntraday) {
            const candles = await fetchIntraday(symbol, effectiveRes, pcfg.windowSec, period);
            if (!candles || candles.length < 3) return null;
            const synced = syncQuoteToCandles(candles, livePrice);
            validateDataset(synced, symbol, period, livePrice);
            return synced;
        }

        // â”€â”€ DAILY+ PATH: 1M, 6M, YTD, 1Y, 5Y, Max â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        //   Always uses 22-year daily base â†’ aggregateBase slices by period window
        //   Resolution is handled by aggregation (weekly/monthly bucketing in aggregateBase)
        //   Never re-fetches at different granularity â€” base is always daily adjusted
        let entry = await fetchBase(symbol);
        if (!entry) return null;
        if (isBaseStale(entry)) {
            delete _baseStore[symbol];
            entry = await fetchBase(symbol);
            if (!entry) return null;
        }
        if (entry.quote === null && livePrice > 0) entry.quote = { c: livePrice };

        // Patch base store last candle with live quote â€” ALL derived windows share this
        if (livePrice > 0 && entry.candles.length > 0) {
            const lb = entry.candles[entry.candles.length - 1];
            if (Math.abs(lb.c - livePrice) >= 0.005) {
                lb.c = +livePrice.toFixed(4);
                lb.h = Math.max(lb.h, livePrice);
                lb.l = Math.min(lb.l, livePrice);
            }
        }

        // For 1Y: if user selected 'D' resolution, return raw daily slice (no weekly agg)
        // aggregateBase handles weekly/monthly bucketing for 5Y and Max
        let view;
        if (period === '1Y' && effectiveRes === 'D') {
            // Override: show daily candles for 1Y instead of weekly
            const now = Date.now();
            const fromMs = now - 380 * 86400000;
            view = entry.candles.filter(c => c.x >= fromMs);
            if (!view || view.length < 3) view = aggregateBase(entry.candles, period);
        } else {
            view = aggregateBase(entry.candles, period);
        }

        if (!view || view.length < 3) return null;
        const synced = syncQuoteToCandles(view, livePrice);
        validateDataset(synced, symbol, period, livePrice);
        return synced;
    }


    // â”€â”€ Debug info builder â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildDebugInfo(symbol, period, activeRes, candles, isSimulated) {
        const entry = _baseStore[symbol];
        const pcfg  = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const livePrice = RT.cache[symbol]?.price || 0;
        const last = candles[candles.length - 1];
        const diff = livePrice > 0 ? Math.abs(last.c - livePrice) : null;
        _chartDebugInfo = {
            period, symbol,
            res: pcfg.isIntraday ? activeRes : 'Dâ†’agg',
            count: candles.length,
            first: candles[0], last,
            minPrice: Math.min(...candles.map(c => c.l)),
            maxPrice: Math.max(...candles.map(c => c.h)),
            isSimulated,
            splitFactor: entry?.splitFactor != null ? entry.splitFactor.toFixed(4) : 'â€”',
            liveQuote: livePrice || 'â€”',
            lastClose: last.c,
            quoteDiff: diff != null ? (diff < 0.005 ? 'âœ“ synced' : '$' + diff.toFixed(4)) : 'â€”',
            baseDays: entry?.candles.length || 0,
            integrityIssues: 0,
            ytdPct: null,
            priceMismatch: diff != null && diff > 0.01 ? (diff / livePrice * 100).toFixed(2) + '%' : null,
        };
        if (period === 'YTD' && candles.length > 1) {
            const s = candles[0].c;
            _chartDebugInfo.ytdPct = ((last.c - s) / s * 100).toFixed(2);
        }
        updateChartDebugOverlay();
    }

    // â”€â”€ Backward-compat shim: fetchCandles â†’ resolveCandles â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    //   Keeps live-refresh timer and any legacy callers working.
    //   Also maintains candleCache for the live-refresh path.
    async function fetchCandles(symbol, period, res) {
        const candles = await resolveCandles(symbol, period, res||_currentIntradayRes);
        if(candles) {
            const key=`${symbol}||${period}||${res||_currentIntradayRes}`;
            candleCache[key]={data:candles,ts:Date.now(),period,res,symbol};
        }
        return candles;
    }

    // â”€â”€ Overlay / indicator math â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sma(arr, n) {
        return arr.map((_,i)=>i<n-1?null:arr.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n);
    }
    function ema(arr, n) {
        const k=2/(n+1), out=[arr[0]];
        for(let i=1;i<arr.length;i++) out.push(arr[i]*k+out[i-1]*(1-k));
        return out.map((v,i)=>i<n-1?null:v);
    }
    function bollingerBands(closes, n=20, mult=2) {
        const mid=sma(closes,n);
        return closes.map((_,i)=>{
            if(i<n-1)return null;
            const sl=closes.slice(i-n+1,i+1), mean=sl.reduce((a,b)=>a+b,0)/n;
            const sd=Math.sqrt(sl.reduce((s,v)=>s+(v-mean)**2,0)/n);
            return{mid:mid[i],upper:mid[i]+mult*sd,lower:mid[i]-mult*sd};
        });
    }
    function calcRSI(closes, n=14) {
        const gains=[], losses=[];
        for(let i=1;i<closes.length;i++){
            const d=closes[i]-closes[i-1];
            gains.push(Math.max(0,d)); losses.push(Math.max(0,-d));
        }
        return gains.map((_,i)=>{
            if(i<n-1)return null;
            const ag=gains.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n;
            const al=losses.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n;
            return al===0?100:100-100/(1+ag/al);
        });
    }
    function calcMACD(closes) {
        const e12=ema(closes,12), e26=ema(closes,26);
        const ml=closes.map((_,i)=>e12[i]!=null&&e26[i]!=null?e12[i]-e26[i]:null);
        const valid=ml.filter(v=>v!=null);
        const sig9=sma(valid,9); let si=0;
        const sl=ml.map(v=>v==null?null:(sig9[si++]||null));
        return{macdLine:ml,signalLine:sl,histogram:ml.map((v,i)=>v!=null&&sl[i]!=null?v-sl[i]:null)};
    }
    function calcVWAP(candles) {
        let cpv=0, cv=0;
        return candles.map(c=>{cpv+=((c.h+c.l+c.c)/3)*(c.v||1);cv+=(c.v||1);return cpv/cv;});
    }

    // â”€â”€ Earnings date markers (simulated quarterly) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getEarningsMarkers() {
        const now=Date.now(), q=90*86400000;
        return [
            {ts:now-q,     label:'Q3E',color:'#f59e0b'},
            {ts:now-2*q,   label:'Q2E',color:'#f59e0b'},
            {ts:now-3*q,   label:'Q1E',color:'#f59e0b'},
            {ts:now-4*q,   label:'Q4E',color:'#a78bfa'},
        ];
    }

    // â”€â”€ Overlay line builder for Chart.js financial mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function buildOverlayDatasets(candles) {
        const closes=candles.map(c=>c.c);
        const ts=candles.map(c=>c.x);
        const ds=[];
        const line=(label,vals,color,dash=[],w=1.5)=>({
            type:'line',label,
            data:ts.map((x,i)=>vals[i]!=null?{x,y:vals[i]}:null).filter(Boolean),
            borderColor:color,borderWidth:w,pointRadius:0,tension:0.3,
            borderDash:dash,fill:false,order:1,yAxisID:'y'
        });
        if(activeIndicators.has('EMA20')) ds.push(line('EMA20',ema(closes,20),'#60a5fa'));
        if(activeIndicators.has('EMA50')) ds.push(line('EMA50',ema(closes,50),'#f97316'));
        if(activeIndicators.has('VWAP'))  ds.push(line('VWAP',calcVWAP(candles),'#f59e0b'));
        if(activeIndicators.has('BB')) {
            const bb=bollingerBands(closes);
            const upper=bb.map((b,i)=>b?{x:ts[i],y:b.upper}:null).filter(Boolean);
            const lower=bb.map((b,i)=>b?{x:ts[i],y:b.lower}:null).filter(Boolean);
            const mid  =bb.map((b,i)=>b?{x:ts[i],y:b.mid}:null).filter(Boolean);
            ds.push({type:'line',label:'BB Upper',data:upper,borderColor:'rgba(96,165,250,0.55)',borderWidth:1,pointRadius:0,borderDash:[3,2],fill:false,order:1,yAxisID:'y'});
            ds.push({type:'line',label:'BB Lower',data:lower,borderColor:'rgba(96,165,250,0.55)',borderWidth:1,pointRadius:0,borderDash:[3,2],fill:'-1',backgroundColor:'rgba(96,165,250,0.05)',order:1,yAxisID:'y'});
            ds.push({type:'line',label:'BB Mid',  data:mid,  borderColor:'rgba(96,165,250,0.3)', borderWidth:1,pointRadius:0,fill:false,order:1,yAxisID:'y'});
        }
        return ds;
    }

    // â”€â”€ Overlay line painter for pure-canvas mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function paintOverlaysCanvas(ctx, candles, meta) {
        const {PAD,cW,cH,toX,toY}=meta;
        const closes=candles.map(c=>c.c);
        const line=(vals,color,dash=[],w=1.5)=>{
            ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=w; ctx.setLineDash(dash);
            ctx.beginPath(); let s=false;
            vals.forEach((v,i)=>{if(v==null)return;const x=toX(i),y=toY(v);s?ctx.lineTo(x,y):(ctx.moveTo(x,y),s=true);});
            ctx.stroke(); ctx.setLineDash([]); ctx.restore();
        };
        if(activeIndicators.has('EMA20')) line(ema(closes,20),'#60a5fa');
        if(activeIndicators.has('EMA50')) line(ema(closes,50),'#f97316');
        if(activeIndicators.has('VWAP'))  line(calcVWAP(candles),'#f59e0b');
        if(activeIndicators.has('BB')) {
            const bb=bollingerBands(closes);
            const upper=bb.map(b=>b?b.upper:null);
            const lower=bb.map(b=>b?b.lower:null);
            // fill band
            ctx.save(); ctx.globalAlpha=0.06; ctx.fillStyle='#60a5fa';
            ctx.beginPath(); let sf=false;
            upper.forEach((v,i)=>{if(v==null)return;const x=toX(i),y=toY(v);sf?ctx.lineTo(x,y):(ctx.moveTo(x,y),sf=true);});
            [...lower].reverse().forEach((v,i)=>{if(v==null)return;const ri=lower.length-1-i;ctx.lineTo(toX(ri),toY(v));});
            ctx.closePath(); ctx.fill(); ctx.restore();
            line(upper,'rgba(96,165,250,0.6)',[3,2]);
            line(lower,'rgba(96,165,250,0.6)',[3,2]);
            line(bb.map(b=>b?b.mid:null),'rgba(96,165,250,0.35)');
        }
        // Earnings markers
        if(detailStock){
            const markers=getEarningsMarkers();
            const earliest=candles[0]?.x, latest=candles[candles.length-1]?.x;
            markers.forEach(m=>{
                if(m.ts<earliest||m.ts>latest) return;
                const idx=candles.reduce((ci,c,i)=>Math.abs(c.x-m.ts)<Math.abs(candles[ci].x-m.ts)?i:ci,0);
                const x=toX(idx);
                const {H,PAD:P}=meta;
                ctx.save(); ctx.strokeStyle=m.color; ctx.lineWidth=1; ctx.setLineDash([2,3]);
                ctx.beginPath(); ctx.moveTo(x,P.top); ctx.lineTo(x,H-P.bottom); ctx.stroke();
                ctx.setLineDash([]); ctx.fillStyle=m.color; ctx.font='bold 8px sans-serif'; ctx.textAlign='center';
                ctx.fillText(m.label,x,P.top-2); ctx.restore();
            });
        }
    }

    // â”€â”€ Overlay / loading UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const OVERLAY_STATES = {
        loading:   { icon:'â³', msg:'Loading chartâ€¦',                   keep:true  },
        nodata:    { icon:'ğŸ“­', msg:'No data available',                 keep:false },
        closed:    { icon:'ğŸ”’', msg:'Market Closed',                     keep:false },
        ratelimit: { icon:'âš ï¸', msg:'API limit reached â€” retry in 60s', keep:false },
        simulated: { icon:'ğŸ“Š', msg:'Simulated data â€” connect API for live prices', keep:false },
        unavail:   { icon:'âš ï¸', msg:'Live data unavailable',            keep:false },
        integrity: { icon:'ğŸ›¡', msg:'Data Integrity Error â€” showing simulation', keep:false },
    };

    function showChartOverlay(stateOrMsg, icon, keep=false) {
        const ov  = document.getElementById('chartOverlay');
        const ti  = document.getElementById('chartOverlayIcon');
        const tt  = document.getElementById('chartOverlayText');
        const btn = document.getElementById('chartRetryBtn');
        if(!ov) return;
        ov.style.display = 'flex';
        const preset = OVERLAY_STATES[stateOrMsg];
        if(ti)  ti.textContent = preset ? preset.icon : (icon || 'â³');
        if(tt)  tt.textContent = preset ? preset.msg  : stateOrMsg;
        if(btn) btn.style.display = ['integrity','ratelimit','unavail','nodata'].includes(stateOrMsg) ? 'block' : 'none';
        const shouldKeep = preset ? preset.keep : keep;
        if(!shouldKeep) setTimeout(hideChartOverlay, 2800);
    }
    function hideChartOverlay() {
        const ov=document.getElementById('chartOverlay');
        if(ov) ov.style.display='none';
    }

    // â”€â”€ Timezone label â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateTzLabel() {
        const el=document.getElementById('chartTzLabel');
        if(!el) return;
        try {
            const tz = Intl.DateTimeFormat().resolvedOptions().timeZone;
            const abbr = new Date().toLocaleTimeString('en',{timeZoneName:'short'}).split(' ').pop();
            el.textContent = abbr || tz;
        } catch(e) { el.textContent=''; }
    }

    // â”€â”€ Market session shade (canvas mode) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function paintSessionShading(ctx, candles, meta) {
        const {PAD, toX, W, H} = meta;
        const isIntraday = candles.length > 0 && (candles[candles.length-1].x - candles[0].x) < 14*86400000;
        if (!isIntraday) return; // no shading for long periods
        // Pre-market: before 9:30 ET; After-hours: after 16:00 ET
        candles.forEach((c, i) => {
            const d = new Date(c.x);
            const et = new Date(d.toLocaleString('en-US', {timeZone:'America/New_York'}));
            const mins = et.getHours()*60 + et.getMinutes();
            const isRegular = mins >= 9*60+30 && mins < 16*60;
            const isPreMkt  = mins < 9*60+30;
            if (!isRegular) {
                const x1 = toX(i) - (meta.cw||4)/2;
                const w  = (meta.cw||4) + 1;
                ctx.save();
                ctx.fillStyle = isPreMkt ? 'rgba(99,179,237,0.06)' : 'rgba(248,113,113,0.06)';
                ctx.fillRect(x1, PAD.top, w, H-PAD.top-PAD.bottom);
                ctx.restore();
            }
        });
    }

    // â”€â”€ Destroy charts cleanly â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function destroyCharts() {
        if(sChart)   { try{sChart.destroy();}   catch(e){} sChart=null; }
        if(volChart) { try{volChart.destroy();} catch(e){} volChart=null; }
        clearInterval(_liveRefreshTimer); _liveRefreshTimer=null;
        // Clear per-symbol intraday store on close so next open re-fetches fresh data
        if(detailStock) {
            const sym = detailStock.symbol;
            Object.keys(_intradayStore).forEach(k=>{ if(k.startsWith(sym+'||')) delete _intradayStore[k]; });
        }
    }

    // â”€â”€ Pure-canvas candlestick renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function paintCandleCanvas(canvas, candles, tc, period) {
        const dpr=window.devicePixelRatio||1;
        const W=canvas.clientWidth||700, H=canvas.clientHeight||310;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        const PAD={top:18,right:68,bottom:34,left:8};
        const cW=W-PAD.left-PAD.right, cH=H-PAD.top-PAD.bottom;
        const allH=candles.map(c=>c.h), allL=candles.map(c=>c.l);
        const dataMin=Math.min(...allL), dataMax=Math.max(...allH);
        const dataPad=(dataMax-dataMin)*0.003;
        const minP=dataMin-dataPad, maxP=dataMax+dataPad, pr=maxP-minP||1;
        const toY=p=>PAD.top+cH*(1-(p-minP)/pr);
        const toX=i=>PAD.left+(i+0.5)*(cW/candles.length);
        const cw=Math.max(1, cW/candles.length*0.65);

        // Background
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);

        // Grid + Y-labels
        const gridLines=5;
        for(let i=0;i<=gridLines;i++){
            const p=minP+pr*(i/gridLines), y=toY(p);
            ctx.strokeStyle=tc.grid; ctx.lineWidth=1;
            ctx.beginPath(); ctx.moveTo(PAD.left,y); ctx.lineTo(W-PAD.right,y); ctx.stroke();
            ctx.fillStyle=tc.text; ctx.font='10px sans-serif'; ctx.textAlign='left';
            ctx.fillText('$'+(p>=1000?p.toFixed(0):p>=100?p.toFixed(1):p.toFixed(2)), W-PAD.right+4, y+4);
        }

        // X-axis labels
        const isIntraday = ['1D','5D'].includes(period);
        const isMonthly  = ['5Y','Max'].includes(period);
        ctx.fillStyle=tc.text; ctx.font='10px sans-serif'; ctx.textAlign='center';
        const labelEvery=Math.max(1,Math.floor(candles.length/8));
        candles.forEach((c,i)=>{
            if(i%labelEvery!==0)return;
            const d=new Date(c.x);
            let lbl;
            if (isIntraday)     lbl = d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
            else if (isMonthly) lbl = d.toLocaleDateString([],{month:'short',year:'2-digit'});
            else                lbl = d.toLocaleDateString([],{month:'short',day:'numeric'});
            ctx.fillText(lbl,toX(i),H-PAD.bottom+14);
        });

        // Session shading + overlays (behind candles)
        const meta={PAD,cW,cH,toX,toY,W,H,dpr,cw};
        paintSessionShading(ctx, candles, meta);
        paintOverlaysCanvas(ctx, candles, meta);

        // Candles
        candles.forEach((c,i)=>{
            const up=c.c>=c.o, col=up?'#26a69a':'#ef5350', x=toX(i);
            const wickW=Math.max(0.8, cw*0.12);
            ctx.strokeStyle=col; ctx.lineWidth=wickW;
            ctx.beginPath(); ctx.moveTo(x,toY(c.h)); ctx.lineTo(x,toY(c.l)); ctx.stroke();
            ctx.fillStyle=up?'#26a69a':'#ef5350';
            const bT=Math.min(toY(c.o),toY(c.c)), bH=Math.max(1,Math.abs(toY(c.c)-toY(c.o)));
            ctx.fillRect(x-cw/2,bT,cw,bH);
        });

        // Crosshair & tooltip on hover
        canvas._candles=candles; canvas._meta={...meta,tc,period};
        canvas.onmousemove=function(e){
            const rect=canvas.getBoundingClientRect();
            const mx=e.clientX-rect.left, my=e.clientY-rect.top;
            const idx=Math.min(candles.length-1,Math.max(0,Math.round((mx-PAD.left)/(cW/candles.length)-0.5)));
            paintCandleCanvas(canvas,candles,tc,period);
            const c=candles[idx], x=toX(idx);
            // Crosshair
            ctx.save();
            ctx.strokeStyle='rgba(255,255,255,0.2)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(x,PAD.top); ctx.lineTo(x,H-PAD.bottom); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(PAD.left,my); ctx.lineTo(W-PAD.right,my); ctx.stroke();
            ctx.setLineDash([]); ctx.restore();
            // Price pin on Y-axis
            const pinY=Math.max(PAD.top,Math.min(H-PAD.bottom,my));
            const pinPrice=maxP-((pinY-PAD.top)/cH)*pr;
            ctx.fillStyle='rgba(96,165,250,0.9)'; ctx.beginPath();
            ctx.roundRect(W-PAD.right+1,pinY-9,66,18,3); ctx.fill();
            ctx.fillStyle='#fff'; ctx.font='bold 9px sans-serif'; ctx.textAlign='left';
            ctx.fillText('$'+pinPrice.toFixed(2),W-PAD.right+5,pinY+4);
            // Tooltip card
            const d=new Date(c.x);
            const dateStr=isIntraday
                ?d.toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'})
                :d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric',year:'numeric'});
            const pct=((c.c-c.o)/c.o*100).toFixed(2);
            const lines=[dateStr,`O: $${c.o.toFixed(2)}   H: $${c.h.toFixed(2)}`,`L: $${c.l.toFixed(2)}   C: $${c.c.toFixed(2)}`,`Change: ${pct>=0?'+':''}${pct}%`];
            const bW=210,bH=72, bX=Math.min(x+12,W-bW-PAD.right-2), bY=PAD.top+6;
            ctx.fillStyle=tc.tooltip; ctx.strokeStyle=c.c>=c.o?'#26a69a':'#ef5350'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.roundRect(bX,bY,bW,bH,7); ctx.fill(); ctx.stroke();
            ctx.fillStyle=isDark()?'#ebebf5':'#1a1a2e'; ctx.font='10px sans-serif'; ctx.textAlign='left';
            lines.forEach((l,i)=>ctx.fillText(l,bX+10,bY+16+i*14));
        };
        canvas.onmouseleave=function(){paintCandleCanvas(canvas,candles,themeColors(),period);};
    }

    // â”€â”€ Volume canvas renderer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function paintVolumeCanvas(canvas, candles, tc) {
        const dpr=window.devicePixelRatio||1;
        const W=canvas.clientWidth||700, H=canvas.clientHeight||64;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        const PAD={top:4,right:68,bottom:14,left:8};
        const cW=W-PAD.left-PAD.right, cH=H-PAD.top-PAD.bottom;
        const maxV=Math.max(...candles.map(c=>c.v||0))||1;
        const bw=Math.max(1,(cW/candles.length)*0.65);
        candles.forEach((c,i)=>{
            const x=PAD.left+(i+0.5)*(cW/candles.length);
            const bH=(c.v||0)/maxV*cH;
            ctx.fillStyle=c.c>=c.o?'rgba(38,166,154,0.5)':'rgba(239,83,80,0.5)';
            ctx.fillRect(x-bw/2,PAD.top+cH-bH,bw,bH);
        });
        // Vol label
        ctx.fillStyle=tc.text; ctx.font='8px sans-serif'; ctx.textAlign='left';
        const maxVStr=maxV>=1e6?(maxV/1e6).toFixed(1)+'M':maxV>=1e3?(maxV/1e3).toFixed(0)+'K':''+maxV;
        ctx.fillText(maxVStr,W-PAD.right+4,PAD.top+10);
    }

    // â”€â”€ RSI sub-chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawRSIChart(candles, tc) {
        const canvas=document.getElementById('rsiChart');
        if(!canvas)return;
        const closes=candles.map(c=>c.c);
        const rsi=calcRSI(closes);
        const W=canvas.clientWidth||700, H=canvas.clientHeight||80;
        const dpr=window.devicePixelRatio||1;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        const PAD={l:8,r:68,t:6,b:14};
        const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
        const valid=rsi.map((v,i)=>v!=null?i:null).filter(x=>x!=null);
        if(!valid.length)return;
        const toX=i=>PAD.l+(i/candles.length)*cW;
        const toY=v=>PAD.t+(1-v/100)*cH;
        // Zones
        ctx.fillStyle='rgba(239,68,68,0.07)'; ctx.fillRect(PAD.l,PAD.t,cW,toY(70)-PAD.t);
        ctx.fillStyle='rgba(34,197,94,0.07)'; ctx.fillRect(PAD.l,toY(30),cW,H-PAD.b-toY(30));
        // Reference lines
        [30,50,70].forEach(v=>{
            ctx.strokeStyle=tc.grid; ctx.lineWidth=0.5; ctx.setLineDash([2,3]);
            ctx.beginPath(); ctx.moveTo(PAD.l,toY(v)); ctx.lineTo(W-PAD.r,toY(v)); ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle=tc.text; ctx.font='8px sans-serif'; ctx.textAlign='left';
            ctx.fillText(v,W-PAD.r+4,toY(v)+3);
        });
        // RSI line
        ctx.strokeStyle='#f59e0b'; ctx.lineWidth=1.5; ctx.beginPath();
        valid.forEach((i,n)=>{const y=toY(rsi[i]);n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y);});
        ctx.stroke();
        const last=rsi[valid[valid.length-1]];
        ctx.fillStyle=last>70?'#f87171':last<30?'#4ade80':'#f59e0b';
        ctx.font='bold 8px sans-serif'; ctx.textAlign='left';
        ctx.fillText('RSI '+last.toFixed(1),W-PAD.r+4,toY(last)+3);
    }

    // â”€â”€ MACD sub-chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawMACDChart(candles, tc) {
        const canvas=document.getElementById('macdChart');
        if(!canvas)return;
        const {macdLine,signalLine,histogram}=calcMACD(candles.map(c=>c.c));
        const valid=macdLine.map((v,i)=>v!=null?i:null).filter(x=>x!=null);
        if(!valid.length)return;
        const allVals=[...macdLine,...signalLine,...histogram].filter(v=>v!=null);
        const minV=Math.min(...allVals), maxV=Math.max(...allVals), rng=maxV-minV||1;
        const W=canvas.clientWidth||700, H=canvas.clientHeight||80;
        const dpr=window.devicePixelRatio||1;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        const PAD={l:8,r:68,t:6,b:4};
        const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
        const toX=i=>PAD.l+(i/candles.length)*cW;
        const toY=v=>PAD.t+(1-(v-minV)/rng)*cH;
        const zero=toY(0);
        ctx.strokeStyle=tc.grid; ctx.lineWidth=0.5;
        ctx.beginPath(); ctx.moveTo(PAD.l,zero); ctx.lineTo(W-PAD.r,zero); ctx.stroke();
        const bw=Math.max(1,cW/candles.length*0.65);
        valid.forEach(i=>{
            if(histogram[i]==null)return;
            const x=toX(i), y=toY(histogram[i]);
            ctx.fillStyle=histogram[i]>=0?'rgba(38,166,154,0.6)':'rgba(239,83,80,0.6)';
            ctx.fillRect(x-bw/2,Math.min(y,zero),bw,Math.abs(y-zero));
        });
        ctx.strokeStyle='#60a5fa'; ctx.lineWidth=1.5; ctx.beginPath();
        valid.forEach((i,n)=>{const y=toY(macdLine[i]);n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y);}); ctx.stroke();
        ctx.strokeStyle='#f97316'; ctx.lineWidth=1; ctx.beginPath();
        valid.forEach((i,n)=>{if(signalLine[i]==null)return;const y=toY(signalLine[i]);n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y);}); ctx.stroke();
        ctx.fillStyle=tc.text; ctx.font='8px sans-serif'; ctx.textAlign='left';
        ctx.fillText('MACD',PAD.l+2,PAD.t+10);
    }

    // â”€â”€ MAIN: full chart draw (or no-flicker update) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // â”€â”€ MAIN CHART DRAW â€” unified, validated, cross-interval consistent â”€â”€â”€â”€â”€â”€
    async function drawChart(stock, period) {
        currentChartPeriod = period;
        const fetchId = ++_chartFetchId;
        showChartOverlay('loading');
        updateTzLabel();

        const pcfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const cfg   = INTERVAL_CFG[period] || INTERVAL_CFG['1D']; // compat alias for Chart.js unit

        // Effective resolution: user's current selection if allowed for this period, else default
        const allowedRes = pcfg.allowedRes || [pcfg.defaultRes];
        const res = (allowedRes.includes(_currentIntradayRes)) ? _currentIntradayRes : pcfg.defaultRes;

        // Chart.js time unit derives from effective resolution (not period default)
        const chartUnit = RES_TO_UNIT[res] || pcfg.unit;

        // â”€â”€ Cache isolation: clear stale cross-interval data â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Different periods must never share candle data. Each key is unique.
        // (cache key format: symbol||period||res â€” fully isolated)

        let candles = await fetchCandles(stock.symbol, period, res);
        if (fetchId !== _chartFetchId) return; // stale fetch â€” newer request in flight

        let isSimulated = false;
        if (!candles || candles.length < 3) {
            // â”€â”€ Data integrity error path â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if (RT && RT.key) {
                // API is configured but returned nothing usable â€” show error overlay
                // Render simulation underneath so the chart area isn't blank
                candles = generateSimCandles(stock, period);
                isSimulated = true;
                showChartOverlay('integrity');
                // integrity overlay auto-dismisses after 2.8s (OVERLAY_STATES.integrity.keep=false)
            } else {
                candles = generateSimCandles(stock, period);
                isSimulated = true;
                showChartOverlay('simulated');
            }
        } else {
            // â”€â”€ Post-resolve data synchronisation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // resolveCandles() already called syncQuoteToCandles() so last candle close
            // matches the live price within $0.005 tolerance.
            // Here we only push secondary UI fields that depend on the resolved candles.
            const lastCandle = candles[candles.length - 1];
            const livePrice  = RT.cache[stock.symbol]?.price || stock.price || 0;

            // prevClose sync: use Finnhub quote pc field (set by applyRealQuote),
            // or fall back to second-to-last daily candle.
            if (!stock.prevClose) {
                if (candles.length >= 2) {
                    stock.prevClose = candles[candles.length - 2].c;
                }
            }
            const pcEl = document.getElementById('prevCloseVal');
            if (pcEl && stock.prevClose > 0) pcEl.innerText = stock.prevClose.toFixed(2);

            // 52W high/low: derive from the 1Y daily base view (most accurate)
            if (period === '1Y' || period === '5Y') {
                const allH = candles.map(c => c.h), allL = candles.map(c => c.l);
                const dsHigh = Math.max(...allH), dsLow = Math.min(...allL);
                const h52El = document.getElementById('s52H');
                const l52El = document.getElementById('s52L');
                if (h52El && dsHigh > 0) h52El.innerText = '$' + dsHigh.toFixed(2);
                if (l52El && dsLow  > 0) l52El.innerText = '$' + dsLow.toFixed(2);
            }

            hideChartOverlay();
        }

        buildDebugInfo(stock.symbol, period, res, candles, isSimulated);

        // Live indicator badge
        const liveBadge = document.getElementById('chartLiveIndicator');
        if(liveBadge) liveBadge.style.display = (period==='1D' && isMarketOpen() && RT.key) ? 'flex' : 'none';

        const tc = themeColors();

        // â”€â”€ Candlestick chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const candleCanvas = document.getElementById('stockChart');
        if (!candleCanvas) return;
        candleCanvas.style.width='100%'; candleCanvas.style.height='100%';

        const hasFinancial = typeof Chart!=='undefined' && Chart.registry &&
                             !!Chart.registry.controllers.get?.('candlestick');

        if (hasFinancial) {
            // Register plugin if needed
            if (!Chart.registry.controllers.get('candlestick')) {
                try{ Chart.register(window['chartjs-chart-financial']||{}); }catch(e){}
            }

            const candleData = candles.map(c=>({x:c.x,o:c.o,h:c.h,l:c.l,c:c.c}));
            const volData    = candles.map(c=>({x:c.x,y:c.v||0}));
            const overlays   = buildOverlayDatasets(candles);

            // â”€â”€ Per-period recreation guard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            //   Chart.js cannot reliably switch time unit (minuteâ†”dayâ†”weekâ†”month)
            //   in-place without y-axis scale contamination from prior period.
            //   We recreate when: period changed, or unit changed, or chart gone.
            const prevUnit = sChart?._vestraUnit;
            const needRecreate = !sChart || sChart._destroyed ||
                                 sChart.canvas !== candleCanvas ||
                                 prevUnit !== chartUnit;

            if (!needRecreate) {
                // â”€â”€ NO-FLICKER SAME-UNIT UPDATE: swap data in place â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                sChart.data.datasets[0].data = candleData;
                if(sChart.data.datasets[1] && sChart.data.datasets[1].label==='Volume') {
                    sChart.data.datasets[1].data = volData;
                    sChart.data.datasets[1].backgroundColor = candles.map(c=>c.c>=c.o?'rgba(38,166,154,0.3)':'rgba(239,83,80,0.3)');
                    sChart.data.datasets.splice(2);
                } else {
                    sChart.data.datasets.splice(1);
                }
                overlays.forEach(ds=>sChart.data.datasets.push(ds));
                // Update time unit and Y-axis bounds from actual dataset
                sChart.options.scales.x.time.unit = chartUnit;
                const lo = Math.min(...candles.map(c=>c.l));
                const hi = Math.max(...candles.map(c=>c.h));
                const pad = (hi-lo)*0.02 || hi*0.01;
                sChart.options.scales.y.min = lo - pad;
                sChart.options.scales.y.max = hi + pad;
                sChart.options.scales.vol.max = Math.max(...candles.map(c=>c.v||0)) * 5 || 1;
                sChart.update('none');
            } else {
                // â”€â”€ INITIAL CREATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
                if (sChart) { try{sChart.destroy();}catch(e){} sChart=null; }
                sChart = new Chart(candleCanvas, {
                    type:'candlestick',
                    data:{ datasets:[
                        { label:stock.symbol, data:candleData, yAxisID:'y',
                          color:{up:'#26a69a',down:'#ef5350',unchanged:'#9aa0a6'},
                          borderColor:{up:'#26a69a',down:'#ef5350',unchanged:'#9aa0a6'} },
                        { type:'bar', label:'Volume', data:volData, yAxisID:'vol',
                          backgroundColor:candles.map(c=>c.c>=c.o?'rgba(38,166,154,0.3)':'rgba(239,83,80,0.3)'),
                          borderRadius:1, borderSkipped:'bottom', order:10 },
                        ...overlays
                    ]},
                    options:{
                        responsive:true, maintainAspectRatio:false,
                        animation:{duration:0},
                        interaction:{mode:'index',intersect:false},
                        plugins:{
                            legend:{display:false},
                            tooltip:{
                                backgroundColor:tc.tooltip,
                                titleColor:isDark()?'#e0e0f5':'#1a1a2e',
                                bodyColor:isDark()?'#9aa0a6':'#555570',
                                borderColor:tc.border, borderWidth:1, padding:12,
                                callbacks:{
                                    title:ctx=>{
                                        const raw=ctx[0];
                                        const d=new Date(raw.parsed?.x||raw.raw?.x||0);
                                        const intra = pcfg.isIntraday || ['1','5','15','60'].includes(res);
                                        return d.toLocaleString([],intra
                                            ?{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}
                                            :{weekday:'short',month:'short',day:'numeric',year:'numeric'});
                                    },
                                    label:ctx=>{
                                        if(ctx.dataset.label==='Volume'){
                                            const v=ctx.parsed.y;
                                            return `Vol: ${v>=1e6?(v/1e6).toFixed(2)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v}`;
                                        }
                                        if(ctx.dataset.type==='line')return `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(2)||''}`;
                                        const{o,h,l,c}=ctx.raw||{};
                                        if(o==null)return '';
                                        const pct=((c-o)/o*100).toFixed(2);
                                        return[`O: $${o.toFixed(2)}   H: $${h.toFixed(2)}`,`L: $${l.toFixed(2)}   C: $${c.toFixed(2)}`,`${pct>=0?'â–² +':'â–¼ '}${pct}%`];
                                    },
                                    filter:ctx=>!(ctx.dataset.label==='Volume'&&ctx.parsed.y===0)
                                }
                            }
                        },
                        scales:{
                            x:{
                                type:'time',
                                time:{
                                    unit: chartUnit,
                                    tooltipFormat: (['day','week'].includes(chartUnit)) ? 'MMM d, yyyy' :
                                                   chartUnit === 'month' ? 'MMM yyyy' : 'MMM d, yyyy HH:mm'
                                },
                                adapters:{ date:{} },
                                ticks:{ color:tc.text, maxTicksLimit:9, maxRotation:0, source:'auto', autoSkip:true },
                                grid:{ color:tc.grid, drawBorder:false }
                            },
                            y:{
                                position:'right',
                                // Explicit auto-scale from actual dataset, with 2% padding.
                                // NEVER undefined â€” that causes Chart.js to inherit stale domain
                                // from the previous period when switching (e.g. 1Dâ†’Max).
                                min: (()=>{ const lo=Math.min(...candles.map(c=>c.l)); const hi=Math.max(...candles.map(c=>c.h)); return lo - (hi-lo)*0.02; })(),
                                max: (()=>{ const lo=Math.min(...candles.map(c=>c.l)); const hi=Math.max(...candles.map(c=>c.h)); return hi + (hi-lo)*0.02; })(),
                                grid:{ color:tc.grid, drawBorder:false },
                                ticks:{
                                    color:tc.text,
                                    maxTicksLimit:8,
                                    callback: v => '$' + (v>=1000 ? v.toFixed(0) : v>=100 ? v.toFixed(1) : v.toFixed(2))
                                }
                            },
                            vol:{
                                position:'left',
                                display:true,
                                grid:{ display:false },
                                // Volume axis: max = 5Ã— peak volume so bars stay in lower 20%
                                // Calculated from actual dataset, never hard-coded
                                max: Math.max(...candles.map(c=>c.v||0)) * 5 || 1,
                                min: 0,
                                ticks:{ display:false },
                                border:{ display:false }
                            }
                        }
                    }
                });
                sChart._vestraUnit = chartUnit;  // stamp for recreation guard
            }

            // Volume is now embedded in sChart as dataset index 1 (yAxisID:'vol')
            // Hide the separate volume canvas since it's no longer needed in Chart.js mode
            const volCanvas=document.getElementById('volumeChart');
            if(volCanvas){ volCanvas.style.display='none'; }
            if(volChart){try{volChart.destroy();}catch(e){} volChart=null;}
        } else {
            // â”€â”€ Pure-canvas fallback (no Financial plugin) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            paintCandleCanvas(candleCanvas, candles, tc, period);
            const volCanvas=document.getElementById('volumeChart');
            if(volCanvas){
                volCanvas.style.display='block';
                paintVolumeCanvas(volCanvas, candles, tc);
            }
        }

        // Sub-panels
        if(activeIndicators.has('RSI'))  drawRSIChart(candles, tc);
        if(activeIndicators.has('MACD')) drawMACDChart(candles, tc);

        // â”€â”€ Live 1m auto-refresh (market hours, 1D period only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        clearInterval(_liveRefreshTimer); _liveRefreshTimer=null;
        if(period==='1D' && isMarketOpen() && RT.key) {
            _lastLiveCandle = candles[candles.length-1]?.x || 0;
            _liveRefreshTimer = setInterval(async()=>{
                if(!detailStock || currentChartPeriod!=='1D') { clearInterval(_liveRefreshTimer); return; }
                // Bust candleCache shim AND _intradayStore so resolveCandles re-fetches fresh data
                delete candleCache[`${detailStock.symbol}||1D||${_currentIntradayRes}`];
                delete _intradayStore[`${detailStock.symbol}||${_currentIntradayRes}||1D`];
                const fresh = await fetchCandles(detailStock.symbol,'1D',_currentIntradayRes);
                if(!fresh||fresh.length===0) {
                    showChartOverlay(isMarketOpen() ? 'ratelimit' : 'closed');
                    return;
                }
                const newest = fresh[fresh.length-1];
                if(newest.x <= _lastLiveCandle) return; // no new candle
                _lastLiveCandle = newest.x;
                const tc2=themeColors();
                if(sChart && !sChart._destroyed) {
                    // Live append â€” no flicker, update candle + embedded volume
                    sChart.data.datasets[0].data = fresh.map(c=>({x:c.x,o:c.o,h:c.h,l:c.l,c:c.c}));
                    if(sChart.data.datasets[1]?.label==='Volume') {
                        sChart.data.datasets[1].data = fresh.map(c=>({x:c.x,y:c.v||0}));
                        sChart.data.datasets[1].backgroundColor = fresh.map(c=>c.c>=c.o?'rgba(38,166,154,0.3)':'rgba(239,83,80,0.3)');
                    }
                    sChart.update('none');
                } else {
                    paintCandleCanvas(candleCanvas, fresh, tc2, '1D');
                    const vc=document.getElementById('volumeChart');
                    if(vc) paintVolumeCanvas(vc, fresh, tc2);
                }
            }, 30000);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  UNIFIED PERIOD + RESOLUTION HANDLERS
    //
    //  Contract:
    //    setChartPeriod(period, btn)  â€” top row: changes date window only
    //      â€¢ Updates _currentIntradayRes to the default for that period
    //      â€¢ Shows only resolution buttons valid for that period
    //      â€¢ Clears intraday cache (never base cache) and redraws
    //
    //    setResolution(res)           â€” bottom row: changes candle granularity only
    //      â€¢ windowSec never changes â€” it stays bound to the current period
    //      â€¢ Clears only the intraday cache for the current period+res
    //      â€¢ Redraws with the same period, new resolution
    //
    //  NO independent data sources. NO cross-contamination between rows.
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function _syncResolutionRow(period) {
        const pcfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const allowed = pcfg.allowedRes || [pcfg.defaultRes];

        // Show/hide each button based on whether it's valid for this period
        const ALL_RES = ['1','5','15','60','D','W','M'];
        ALL_RES.forEach(r => {
            const btn = document.getElementById('itv-' + r);
            if (!btn) return;
            btn.style.display = allowed.includes(r) ? '' : 'none';
            btn.classList.remove('itv-active');
        });

        // Activate the current resolution button (or default if current isn't allowed)
        const active = allowed.includes(_currentIntradayRes) ? _currentIntradayRes : pcfg.defaultRes;
        _currentIntradayRes = active;
        const activeBtn = document.getElementById('itv-' + active);
        if (activeBtn) activeBtn.classList.add('itv-active');

        // Always show the resolution row (it always has at least one button)
        const row = document.getElementById('intradayRow');
        if (row) row.style.display = 'flex';
    }

    function setChartPeriod(period, btn) {
        // Style period tabs
        document.querySelectorAll('.ctab').forEach(b => {
            b.style.color = '#6868a0';
            b.style.borderBottomColor = 'transparent';
            b.style.fontWeight = '600';
        });
        if (btn) {
            btn.style.color = '#8ab4f8';
            btn.style.borderBottomColor = '#8ab4f8';
            btn.style.fontWeight = '700';
        }
        currentChartPeriod = period;

        // Reset resolution to period default, then sync the button row
        const pcfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        _currentIntradayRes = pcfg.defaultRes;
        _syncResolutionRow(period);

        // Cache invalidation:
        //   Intraday (1D/5D): clear _intradayStore so fresh fetch happens
        //   Daily+ periods: never clear _baseStore (it's shared)
        if (detailStock) {
            const sym = detailStock.symbol;
            if (pcfg.isIntraday) {
                Object.keys(_intradayStore).forEach(k => {
                    if (k.startsWith(sym + '||')) delete _intradayStore[k];
                });
            }
            // Always clear candleCache shim for this period
            Object.keys(candleCache).forEach(k => {
                if (k.startsWith(sym + '||' + period)) delete candleCache[k];
            });
        }

        showChartOverlay('loading');
        clearTimeout(_periodDebounce);
        _periodDebounce = setTimeout(() => {
            if (detailStock) drawChart(detailStock, period);
        }, 80);
    }

    // setResolution: bottom row â€” changes candle granularity ONLY, not date window
    let _itvDebounce = null;
    function setResolution(res) {
        const pcfg = PERIOD_CFG[currentChartPeriod] || PERIOD_CFG['1D'];
        const allowed = pcfg.allowedRes || [pcfg.defaultRes];

        // Ignore clicks on resolutions not valid for this period (shouldn't happen
        // since the buttons are hidden, but guard defensively)
        if (!allowed.includes(res)) return;

        _currentIntradayRes = res;

        // Update button states
        document.querySelectorAll('.itv-btn').forEach(b => b.classList.remove('itv-active'));
        const btn = document.getElementById('itv-' + res);
        if (btn) btn.classList.add('itv-active');

        if (!detailStock) return;
        const sym = detailStock.symbol;

        // Clear only the specific intraday cache entry for this period+res
        // Never clear _baseStore â€” daily+ periods re-aggregate from the same base
        if (pcfg.isIntraday) {
            const key = `${sym}||${res}||${currentChartPeriod}`;
            delete _intradayStore[key];
        }
        // Clear candleCache shim for this combination
        Object.keys(candleCache).forEach(k => {
            if (k.startsWith(sym + '||' + currentChartPeriod)) delete candleCache[k];
        });

        showChartOverlay('loading');
        clearTimeout(_itvDebounce);
        _itvDebounce = setTimeout(() => {
            if (detailStock) drawChart(detailStock, currentChartPeriod);
        }, 120);
    }

    // Legacy alias â€” keeps any existing onclick="setIntradayInterval(...)" refs working
    function setIntradayInterval(res) { setResolution(res); }

    // â”€â”€ Indicator toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function toggleIndicator(name) {
        const btn=document.getElementById('ind-'+name);
        if(activeIndicators.has(name)){
            activeIndicators.delete(name);
            if(btn){btn.style.background='transparent';btn.style.color='#8888a8';btn.style.borderColor='rgba(255,255,255,0.1)';}
            if(name==='RSI'){const w=document.getElementById('rsiChartWrap');if(w)w.style.display='none';}
            if(name==='MACD'){const w=document.getElementById('macdChartWrap');if(w)w.style.display='none';}
        } else {
            activeIndicators.add(name);
            if(btn){btn.style.background='rgba(212,168,75,0.15)';btn.style.color='var(--v-gold)';btn.style.borderColor='var(--v-gold)';}
            if(name==='RSI'){const w=document.getElementById('rsiChartWrap');if(w)w.style.display='block';}
            if(name==='MACD'){const w=document.getElementById('macdChartWrap');if(w)w.style.display='block';}
        }
        if(detailStock) drawChart(detailStock, currentChartPeriod);
    }

    // Stubs for any old patch references that might linger
    function drawChartWithIndicators(){}
    function drawRSI(){}

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHART SYSTEM UPGRADES â€” Full production spec
    //  1. Rate-limit detection + proper overlay messages
    //  2. Market open/close detection with session shading controller
    //  3. Zoom + pan via chartjs-plugin-zoom (loaded dynamically)
    //  4. Crosshair plugin for Chart.js mode
    //  5. Debounced, non-flickering interval switching with loading spinner
    //  6. Auto timezone detection with tooltip localisation
    //  7. Live candle append (no full re-fetch, only newest appended)
    //  8. Volume aligned exactly with candles (shared x-axis)
    //  9. VWAP, SMA overlays via indicator toggles
    //  10. Proper error states: NoData / MarketClosed / RateLimit
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â”€â”€ Crosshair plugin for Chart.js financial mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const CrosshairPlugin = {
        id: 'vestra-crosshair',
        afterDraw(chart) {
            if (!chart._crosshairX) return;
            const { ctx, chartArea:{left,right,top,bottom}, scales } = chart;
            const x = chart._crosshairX, y = chart._crosshairY;
            ctx.save();
            ctx.strokeStyle = 'rgba(255,255,255,0.18)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4,4]);
            // vertical
            ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
            // horizontal
            if (y >= top && y <= bottom) {
                ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
            }
            ctx.setLineDash([]);
            // Price tag on Y axis
            if (scales.y && y >= top && y <= bottom) {
                const price = scales.y.getValueForPixel(y);
                if (price != null) {
                    ctx.fillStyle = 'rgba(96,165,250,0.9)';
                    ctx.beginPath(); ctx.roundRect(right+2, y-9, 66, 18, 3); ctx.fill();
                    ctx.fillStyle = '#fff'; ctx.font = 'bold 9px sans-serif'; ctx.textAlign = 'left';
                    ctx.fillText('$'+price.toFixed(2), right+6, y+4);
                }
            }
            ctx.restore();
        }
    };

    // Register crosshair plugin if Chart.js available
    if (typeof Chart !== 'undefined') {
        try { Chart.register(CrosshairPlugin); } catch(e){}
    }

    // Attach crosshair events to candlestick canvas (Chart.js mode)
    function attachCrosshairEvents(chartInstance, canvas) {
        if (!chartInstance || !canvas) return;
        canvas.addEventListener('mousemove', function(e) {
            const rect = canvas.getBoundingClientRect();
            chartInstance._crosshairX = e.clientX - rect.left;
            chartInstance._crosshairY = e.clientY - rect.top;
            chartInstance.draw();
        }, { passive: true });
        canvas.addEventListener('mouseleave', function() {
            delete chartInstance._crosshairX;
            delete chartInstance._crosshairY;
            chartInstance.draw();
        });
    }

    // â”€â”€ Rate limit detection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _rateLimitUntil = 0;
    function isRateLimited() { return Date.now() < _rateLimitUntil; }
    function setRateLimit()  { _rateLimitUntil = Date.now() + 62000; }

    // Wrap fetchCandles to detect rate limits
    const _baseFetchCandles = fetchCandles;
    fetchCandles = async function(symbol, period, res) {
        if (isRateLimited()) {
            const secs = Math.ceil((_rateLimitUntil - Date.now())/1000);
            showChartOverlay(`âš ï¸ API limit â€” retry in ${secs}s`, 'âš ï¸', true);
            return null;
        }
        try {
            const result = await _baseFetchCandles(symbol, period, res);
            return result;
        } catch(e) {
            if (e?.message?.includes('429') || e?.message?.includes('limit')) setRateLimit();
            return null;
        }
    };

    // â”€â”€ Market session banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateMarketStatusBanner() {
        const banner = document.getElementById('marketStatusBanner');
        if (!banner) return;
        const open = isMarketOpen();
        // Check pre/after hours
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', {timeZone:'America/New_York'}));
        const mins = et.getHours()*60 + et.getMinutes();
        const dayOfWeek = et.getDay();
        const isWeekend = dayOfWeek===0 || dayOfWeek===6;
        let state, color, bg;
        if (isWeekend) {
            state='Weekend â€” Markets Closed'; color='#9aa0a6'; bg='rgba(154,160,166,0.08)';
        } else if (mins >= 4*60 && mins < 9*60+30) {
            state='Pre-Market'; color='#60a5fa'; bg='rgba(96,165,250,0.08)';
        } else if (open) {
            state='Market Open'; color='#4ade80'; bg='rgba(74,222,128,0.08)';
        } else if (mins >= 16*60 && mins < 20*60) {
            state='After-Hours'; color='#f97316'; bg='rgba(249,115,22,0.08)';
        } else {
            state='Market Closed'; color='#9aa0a6'; bg='rgba(154,160,166,0.08)';
        }
        banner.style.background = bg;
        banner.style.color = color;
        banner.style.borderColor = color.replace(')',',0.2)').replace('rgb','rgba');
        banner.innerHTML = `<span style="display:inline-block;width:6px;height:6px;border-radius:50%;background:${color};margin-right:5px;${open?'animation:pulse 2s infinite':''}"></span>${state}`;
    }

    // (setChartPeriod and setResolution are fully defined above â€” no patches needed)

    // â”€â”€ Attach crosshair to sChart after drawChart completes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _baseDrawChart = drawChart;
    drawChart = async function(stock, period) {
        await _baseDrawChart(stock, period);
        // After draw, attach crosshair to Chart.js instance if available
        if (sChart && !sChart._crosshairAttached) {
            sChart._crosshairAttached = true;
            const canvas = document.getElementById('stockChart');
            if (canvas) attachCrosshairEvents(sChart, canvas);
        }
        // Update market status banner
        updateMarketStatusBanner();
    };

    // â”€â”€ Dynamic tooltip timezone display â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getUserTimezone() {
        try { return Intl.DateTimeFormat().resolvedOptions().timeZone; }
        catch(e) { return 'UTC'; }
    }

    // â”€â”€ Volume alignment fix: ensure volume canvas is always hidden
    //    in Chart.js mode since volume is now embedded as dataset[1]
    const _origDestroyCharts = destroyCharts;
    destroyCharts = function() {
        _origDestroyCharts();
        // Ensure volume canvas resets display state
        const vc = document.getElementById('volumeChart');
        if (vc) vc.style.display = 'none';
    };

    // â”€â”€ Performance: requestAnimationFrame wrapper for canvas redraws â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _rafPending = null;
    function scheduleCanvasRedraw(fn) {
        if (_rafPending) cancelAnimationFrame(_rafPending);
        _rafPending = requestAnimationFrame(() => { _rafPending = null; fn(); });
    }

    // â”€â”€ Max candle guard: slice if over limit before rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function enforceMaxCandles(candles, period) {
        const pcfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const limit = pcfg.maxPts || 500;
        if (candles.length > limit) return candles.slice(candles.length - limit);
        return candles;
    }

    // â”€â”€ Proper live candle append (append only new candle, no full re-render) â”€
    function appendLiveCandle(newCandle) {
        if (!sChart || sChart._destroyed) return false;
        const ds0 = sChart.data.datasets[0];
        if (!ds0 || !ds0.data) return false;
        const last = ds0.data[ds0.data.length - 1];
        if (last && newCandle.x <= (last.x || 0)) {
            // Same candle â€” update in place (current candle tick)
            ds0.data[ds0.data.length - 1] = {x:newCandle.x,o:newCandle.o,h:newCandle.h,l:newCandle.l,c:newCandle.c};
            // Update volume
            const ds1 = sChart.data.datasets[1];
            if (ds1 && ds1.label === 'Volume') {
                ds1.data[ds1.data.length - 1] = {x:newCandle.x, y:newCandle.v||0};
                ds1.backgroundColor[ds1.data.length-1] = newCandle.c>=newCandle.o?'rgba(38,166,154,0.3)':'rgba(239,83,80,0.3)';
            }
        } else {
            // New candle â€” append
            ds0.data.push({x:newCandle.x,o:newCandle.o,h:newCandle.h,l:newCandle.l,c:newCandle.c});
            const ds1 = sChart.data.datasets[1];
            if (ds1 && ds1.label === 'Volume') {
                ds1.data.push({x:newCandle.x, y:newCandle.v||0});
                if (Array.isArray(ds1.backgroundColor)) {
                    ds1.backgroundColor.push(newCandle.c>=newCandle.o?'rgba(38,166,154,0.3)':'rgba(239,83,80,0.3)');
                }
            }
            // Enforce max candles
            const limit = 500;
            if (ds0.data.length > limit) {
                ds0.data.splice(0, ds0.data.length - limit);
                if (ds1) { ds1.data.splice(0, ds1.data.length - limit); if(Array.isArray(ds1.backgroundColor)) ds1.backgroundColor.splice(0, ds1.backgroundColor.length - limit); }
            }
        }
        sChart.update('none');
        return true;
    }

    // â”€â”€ OHLC summary bar below chart (live updating) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateOHLCSummary(candles) {
        if (!candles || candles.length === 0) return;
        const latest = candles[candles.length-1];
        const open   = candles[0].o;
        const high   = Math.max(...candles.map(c=>c.h));
        const low    = Math.min(...candles.map(c=>c.l));
        const close  = latest.c;
        const pct    = ((close - open)/open*100).toFixed(2);
        const bar    = document.getElementById('ohlcSummaryBar');
        if (!bar) return;
        const col = close >= open ? '#26a69a' : '#ef5350';
        bar.innerHTML = `
            <span style="color:#6868a0;font-size:9px;text-transform:uppercase;letter-spacing:0.05em;">O</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:#e0e0f5;">$${open.toFixed(2)}</span>
            <span style="color:#6868a0;font-size:9px;text-transform:uppercase;letter-spacing:0.05em;">H</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:#4ade80;">$${high.toFixed(2)}</span>
            <span style="color:#6868a0;font-size:9px;text-transform:uppercase;letter-spacing:0.05em;">L</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:#ef5350;">$${low.toFixed(2)}</span>
            <span style="color:#6868a0;font-size:9px;text-transform:uppercase;letter-spacing:0.05em;">C</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:#e0e0f5;">$${close.toFixed(2)}</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:${col};margin-left:4px;">${pct>=0?'+':''}${pct}%</span>`;
        bar.style.display = 'flex';
    }

    // Patch drawChart to also call updateOHLCSummary after rendering
    const _drawChartWithSummary = drawChart;
    drawChart = async function(stock, period) {
        await _drawChartWithSummary(stock, period);
        // Primary: read from canvas._candles (set by paintCandleCanvas)
        const vc = document.getElementById('stockChart');
        if (vc && vc._candles && vc._candles.length > 0) {
            updateOHLCSummary(vc._candles);
            return;
        }
        // Secondary: read from Chart.js dataset if in financial mode
        if (sChart && !sChart._destroyed && sChart.data.datasets[0]?.data?.length > 0) {
            const ds = sChart.data.datasets[0].data;
            // Chart.js candlestick data is {x,o,h,l,c} â€” reconstruct candle format
            const synth = ds.map(d => ({ x:d.x, o:d.o||d.y, h:d.h||d.y, l:d.l||d.y, c:d.c||d.y, v:0 }));
            updateOHLCSummary(synth);
            return;
        }
        // Tertiary: cache lookup using correct key format
        const pcfg2 = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const res2  = pcfg2.allowedRes.includes(_currentIntradayRes) ? _currentIntradayRes : pcfg2.defaultRes;
        const cacheKey = `${stock.symbol}||${period}||${res2}`;
        if (candleCache[cacheKey]) updateOHLCSummary(candleCache[cacheKey].data);
    };




    function execDetailTrade(type) {
        if (!detailStock) return;

        // Gate: require API key before trading
        if (!RT.key) {
            showNoApiToast();
            return;
        }

        const sym      = detailStock.symbol;
        const price    = detailStock.price;
        const orderType = document.getElementById('orderType').value;
        const qty      = Math.max(1, parseInt(document.getElementById('orderQty').value || '1', 10));
        const trigger  = parseFloat(document.getElementById('orderTrigger').value || '0');

        if (orderType === 'market') {
            const ok = executeOrderNow({ side: type, symbol: sym, qty, type: 'market' }, price, false);
            if (ok) {
                document.getElementById('dShares').innerText = portfolio[sym] || 0;
                document.getElementById('dBuyPow').innerText = '$' + (cash * leverage).toLocaleString(undefined, { maximumFractionDigits: 0 });
                showTradeToast(type, qty, sym, price);
                recordPerfSnapshot();
                // Open journal after a short delay so toast is visible first
                setTimeout(() => openJournal({ side: type, symbol: sym, qty, price, ts: Date.now() }), 800);
            }
            return;
        }
        if (!Number.isFinite(trigger) || trigger <= 0) {
            alert('Enter a valid trigger price for non-market orders.');
            return;
        }
        if ((orderType === 'stop-loss' || orderType === 'take-profit') && type !== 'SELL') {
            alert(orderType + ' orders are available for SELL only.');
            return;
        }
        pendingOrders.unshift({
            id: 'ord_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
            symbol: sym, side: type, qty, type: orderType, trigger,
            createdAt: Date.now(), status: 'OPEN'
        });
        renderPendingOrders();
        updateUI();
        saveUserData(false);
        showTradeToast(type, qty, sym, trigger, true);
    }

    function showTradeToast(type, qty, sym, price, isPending) {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        const isBuy = type === 'BUY';
        const isInfo = type === 'INFO';
        const bg = isInfo ? '#2a2a3a' : isPending ? '#1a73e8' : (isBuy ? '#34c759' : '#ff453a');
        const label = isInfo ? '' : isPending ? 'â³ Order Placed' : (isBuy ? 'âœ… Bought' : 'âœ… Sold');
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:${bg};color:white;padding:12px 24px;border-radius:12px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.3);
            animation:toastIn 0.25s ease-out;border:1px solid rgba(255,255,255,0.1);`;
        toast.innerHTML = isInfo ? sym : `${label}: ${qty} Ã— ${sym} @ $${price.toFixed(2)}`;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.4s'; setTimeout(() => toast.remove(), 400); }, 2500);
    }

    function executeTrade(type) { execDetailTrade(type); }

    function showNoApiToast() {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:#1c1c2e;color:white;padding:14px 28px;border-radius:14px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 30px rgba(0,0,0,0.4);
            border:1px solid rgba(139,92,246,0.4);animation:toastIn 0.25s ease-out;
            display:flex;align-items:center;gap:12px;`;
        toast.innerHTML = `<span style="font-size:20px">ğŸ”‘</span>
            <div>
                <div>API key required to trade</div>
                <div style="font-size:11px;opacity:0.7;font-weight:400;margin-top:2px">Click <strong>âš¡ Live Data</strong> in the header to connect</div>
            </div>`;
        document.body.appendChild(toast);
        // Shake animation
        toast.animate([{transform:'translateX(-50%) translateX(-6px)'},{transform:'translateX(-50%) translateX(6px)'},{transform:'translateX(-50%) translateX(-4px)'},{transform:'translateX(-50%) translateX(0)'}], {duration:300});
        setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity 0.4s'; setTimeout(()=>toast.remove(),400); }, 3000);
    }

    function triggerCrash() {
        stocks.forEach(s => { s.price = s.price * 0.8; s.change = s.change - 20; });
        renderGrid();
        updateUI();
        saveUserData(false);
        if(detailStock) { const u=stocks.find(s=>s.symbol===detailStock.symbol); if(u) openStockDetail(u); }
        alert("MARKET CRASH INITIATED: All assets down 20%");
    }

    function updateUI() {
        const list = document.getElementById('portfolioList');
        const symsInPortfolio = Object.keys(portfolio);
        let portfolioValue = 0;

        // Clear the empty-state message if we now have holdings
        if (symsInPortfolio.length > 0 && list.querySelector('.italic')) {
            list.innerHTML = '';
        }

        // Remove rows for sold positions
        list.querySelectorAll('[data-port-sym]').forEach(el => {
            if (!portfolio[el.dataset.portSym]) el.remove();
        });

        // Add/update rows
        symsInPortfolio.forEach(symbol => {
            const qty   = portfolio[symbol];
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            const val   = qty * stock.price;
            portfolioValue += val;
            const isPos = stock.change >= 0;
            const cost  = (costBasis[symbol] ? costBasis[symbol].totalCost / costBasis[symbol].shares : stock.price);
            const gainPct = ((stock.price - cost) / cost * 100).toFixed(2);

            let row = list.querySelector(`[data-port-sym="${symbol}"]`);
            if (row) {
                row.querySelector('.port-val').textContent = '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.querySelector('.port-chg').textContent = (isPos ? '+' : '') + stock.change.toFixed(2) + '% today';
                row.querySelector('.port-chg').style.color = isPos ? '#4ade80' : '#f87171';
                row.querySelector('.port-qty').textContent = qty + ' shares Â· ' + (gainPct >= 0 ? '+' : '') + gainPct + '% avg';
            } else {
                row = document.createElement('div');
                row.className       = 'py-3 flex justify-between items-center cursor-pointer rounded'; row.style.cssText = 'border-bottom:1px solid rgba(255,255,255,0.06);';
                row.dataset.portSym = symbol;
                row.innerHTML = `
                    <div>
                        <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${symbol}</div>
                        <div class="port-qty" style="font-size:11px;color:#8888a8;margin-top:2px;">${qty} shares Â· ${gainPct >= 0 ? '+' : ''}${gainPct}% avg</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="port-val" style="font-weight:600;color:#f0f0fa;font-size:0.875rem;font-family:var(--v-mono);">$${val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <div class="port-chg" style="font-size:11px;color:${isPos ? '#4ade80' : '#f87171'};">${isPos ? '+' : ''}${stock.change.toFixed(2)}% today</div>
                    </div>`;
                row.onclick = () => openStockDetail(stock);
                list.appendChild(row);
            }
        });

        if (symsInPortfolio.length === 0) {
            list.innerHTML = '<div style="font-size:13px;color:#8888a8;padding:16px 0;text-align:center;font-style:italic;">Your portfolio is empty.</div>';
        }

        // Total equity + P&L
        const totalEquity = cash + portfolioValue;
        const nwEl = document.getElementById('netWorth');
        if (nwEl) {
            const prev = parseFloat(nwEl.innerText.replace(/,/g,'')) || totalEquity;
            nwEl.innerText = totalEquity.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            if (Math.abs(totalEquity - prev) > 0.01) {
                nwEl.parentElement?.classList.add(totalEquity > prev ? 'num-flash-green' : 'num-flash-red');
                setTimeout(() => nwEl.parentElement?.classList.remove('num-flash-green','num-flash-red'), 700);
            }
        }

        const pl    = totalEquity - 100000;
        const plPct = ((pl / 100000) * 100).toFixed(2);
        const plEl  = document.getElementById('plDisplay');
        if (plEl) {
            plEl.innerText = (pl >= 0 ? '+$' : '-$') + Math.abs(pl).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' (' + (pl >= 0 ? '+' : '') + plPct + '%)';
            plEl.style.color = pl >= 0 ? '#4ade80' : '#f87171';
        }

        // Cash / buying power
        const bpEl = document.getElementById('buyingPower');
        if (bpEl) bpEl.innerText = '$' + (cash * leverage).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Realized / Unrealized P&L breakdown
        const realizedAmt = Number(currentUser?.realizedPL || 0);
        const unrealizedAmt = portfolioValue - Object.keys(portfolio).reduce((sum, sym) => {
            const cb = costBasis[sym];
            return sum + (cb ? cb.totalCost : 0);
        }, 0);
        const rEl = document.getElementById('realizedPL');
        const uEl = document.getElementById('unrealizedPL');
        if (rEl) { rEl.innerText = (realizedAmt >= 0 ? '+' : '') + '$' + Math.abs(realizedAmt).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); rEl.style.color = realizedAmt >= 0 ? '#4ade80' : '#f87171'; }
        if (uEl) { uEl.innerText = (unrealizedAmt >= 0 ? '+' : '') + '$' + Math.abs(unrealizedAmt).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2}); uEl.style.color = unrealizedAmt >= 0 ? '#4ade80' : '#f87171'; }

        renderWatchlist();
        renderAlerts();
        renderHistory();
        renderAnalytics();
        renderQuestsAndAchievements();
        drawPerfChart();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AUTH + PERSISTENT STORAGE SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentUser = null;  // { username, displayName }
    let authMode = 'login';  // 'login' | 'register'

    // Storage adapter: use platform storage if available, otherwise fallback to localStorage.
    window.__storageFallback = false;
    function buildStorageFallback() {
        // Prefix shared keys so they're distinguishable in localStorage
        const lsKey = (key, shared) => shared ? 'shared:' + key : 'priv:' + key;
        return {
            async get(key, shared = false) {
                try {
                    const val = localStorage.getItem(lsKey(key, shared));
                    return val == null ? null : { key, value: val, shared };
                } catch (_) { return null; }
            },
            async set(key, value, shared = false) {
                try {
                    localStorage.setItem(lsKey(key, shared), value);
                    return { key, value, shared };
                } catch (e) {
                    throw new Error('Storage unavailable: ' + (e.message || e));
                }
            },
            async delete(key, shared = false) {
                try {
                    localStorage.removeItem(lsKey(key, shared));
                    return { key, deleted: true, shared };
                } catch (_) { return null; }
            },
            async list(prefix = '', shared = false) {
                const keys = [];
                const lsPrefix = lsKey(prefix, shared);
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(lsPrefix)) {
                            // Strip the ls prefix to return the original key
                            keys.push(k.slice(shared ? 'shared:'.length : 'priv:'.length));
                        }
                    }
                } catch (_) {}
                return { keys, prefix, shared };
            }
        };
    }

    function ensureStorageAdapter() {
        const valid = window.storage
            && typeof window.storage.get === 'function'
            && typeof window.storage.set === 'function'
            && typeof window.storage.list === 'function';
        if (!valid) {
            window.__storageFallback = true;
            window.storage = buildStorageFallback();
        }
        return window.storage;
    }

    ensureStorageAdapter();

    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        const isReg = authMode === 'register';
        document.getElementById('authTitle').innerText = isReg ? 'Create account' : 'Sign in';
        document.getElementById('authSubtitle').innerText = isReg ? 'Start with $100,000 USD' : 'to your trading account';
        document.getElementById('authSubmitBtn').innerText = isReg ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').innerText = isReg ? 'Already have an account?' : "Don't have an account?";
        document.getElementById('authToggleBtn').innerText = isReg ? 'Sign in' : 'Create account';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isReg);
        document.getElementById('authError').classList.add('hidden');
    }

    function showAuthError(msg) {
        const el = document.getElementById('authError');
        el.innerText = msg;
        el.classList.remove('hidden');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AUTH SYSTEM v2 â€” Unique IDs, integrity, password strength
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function generateUID() {
        return 'u_' + Date.now().toString(36) + '_' + Math.random().toString(36).slice(2, 9);
    }

    function scorePassword(pw) {
        let s = 0;
        if (pw.length >= 6) s++;
        if (pw.length >= 10) s++;
        if (/[A-Z]/.test(pw)) s++;
        if (/[0-9]/.test(pw)) s++;
        if (/[^A-Za-z0-9]/.test(pw)) s++;
        return s; // 0-5
    }

    function showPasswordStrength(pw) {
        const el = document.getElementById('passwordStrengthBar');
        if (!el) return;
        const score = scorePassword(pw);
        const colors = ['#f87171','#f87171','#f59e0b','#f59e0b','#4ade80','#4ade80'];
        const labels = ['Too short','Weak','Fair','Good','Strong','Very strong'];
        const pct = (score / 5) * 100;
        el.innerHTML = `<div style="height:3px;background:rgba(255,255,255,0.08);border-radius:2px;overflow:hidden;margin-top:5px;">
            <div style="height:100%;width:${pct}%;background:${colors[score]};transition:all 0.3s;border-radius:2px;"></div>
        </div><div style="font-size:9px;color:${colors[score]};margin-top:3px;">${labels[score]}</div>`;
    }

    async function handleAuthSubmit() {
        const username = document.getElementById('authUser').value.trim().toLowerCase();
        const password = document.getElementById('authPass').value;
        const displayName = document.getElementById('authName').value.trim();
        const storage = ensureStorageAdapter();

        if (!username || !password) return showAuthError('Please fill in all fields.');
        if (!/^[a-z0-9_]+$/.test(username)) return showAuthError('Username: letters, numbers, underscores only.');

        const submitBtn = document.getElementById('authSubmitBtn');
        if (submitBtn) { submitBtn.disabled = true; submitBtn.textContent = 'Please waitâ€¦'; }

        try {
            if (authMode === 'register') {
                if (!displayName) return showAuthError('Please enter a display name.');
                if (username.length < 3) return showAuthError('Username must be at least 3 characters.');
                if (password.length < 6) return showAuthError('Password must be at least 6 characters.');
                if (scorePassword(password) < 2) return showAuthError('Password too weak â€” add numbers or special characters.');
                // Check if username taken
                let existing = null;
                try { existing = await storage.get('user:' + username, true); } catch(e) {}
                if (existing && existing.value) return showAuthError('Username already taken. Try another.');

                const uid = generateUID();
                const userData = {
                    uid,                             // Unique permanent ID
                    username,
                    displayName,
                    passwordHash: simpleHash(password),
                    cash: 100000,
                    portfolio: {},
                    joinedAt: Date.now(),
                    totalTrades: 0,
                    integrityScore: 100,             // Starts at 100, decremented by violations
                    riskViolations: 0,
                    tradingMode: 'standard',
                    competitionEligible: true,
                    realizedPL: 0,
                    verifiedAccount: true,
                };
                await storage.set('user:' + username, JSON.stringify(userData), true);
                await storage.set('uid:' + uid, username, true);  // UID â†’ username index
                await loginAs(userData);
            } else {
                let stored = null;
                try { stored = await storage.get('user:' + username, true); } catch(e) {}
                if (!stored || !stored.value) return showAuthError('Account not found. Please register first.');
                const userData = JSON.parse(stored.value);
                if (userData.passwordHash !== simpleHash(password)) return showAuthError('Incorrect password. Try again.');
                // Backfill UID for legacy accounts
                if (!userData.uid) {
                    userData.uid = generateUID();
                    userData.integrityScore = userData.integrityScore ?? 100;
                    userData.riskViolations = userData.riskViolations ?? 0;
                    userData.verifiedAccount = true;
                    await storage.set('user:' + username, JSON.stringify(userData), true);
                    await storage.set('uid:' + userData.uid, username, true);
                }
                await loginAs(userData);
            }
        } catch(e) {
            showAuthError('Error: ' + (e.message || 'Unknown error. Try again.'));
        } finally {
            if (submitBtn) { submitBtn.disabled = false; submitBtn.textContent = authMode === 'register' ? 'Create Account' : 'Sign In'; }
        }
    }

    async function loginAs(userData) {
        currentUser = userData || {};
        const safeName = (currentUser.displayName && String(currentUser.displayName).trim())
            ? String(currentUser.displayName).trim()
            : ((currentUser.username && String(currentUser.username).trim()) || 'Trader');
        currentUser.displayName = safeName;
        cash = Number.isFinite(currentUser.cash) ? currentUser.cash : 100000;
        portfolio = (currentUser.portfolio && typeof currentUser.portfolio === 'object') ? currentUser.portfolio : {};
        watchlist = Array.isArray(currentUser.watchlist) ? currentUser.watchlist : [];
        priceAlerts = Array.isArray(currentUser.priceAlerts) ? currentUser.priceAlerts : [];
        pendingOrders = Array.isArray(currentUser.pendingOrders) ? currentUser.pendingOrders : [];
        transactions = Array.isArray(currentUser.transactions) ? currentUser.transactions : [];
        costBasis = (currentUser.costBasis && typeof currentUser.costBasis === 'object') ? currentUser.costBasis : {};
        achievements = Array.isArray(currentUser.achievements) ? currentUser.achievements : [];
        tradeStreak = (currentUser.tradeStreak && typeof currentUser.tradeStreak === 'object') ? currentUser.tradeStreak : { count: 0, lastDay: '' };
        dailyQuest = (currentUser.dailyQuest && typeof currentUser.dailyQuest === 'object') ? currentUser.dailyQuest : { date: '', profitableTrades: 0, totalTrades: 0 };
        perfHistory = Array.isArray(currentUser.perfHistory) ? currentUser.perfHistory : [];
        tradeJournal = (currentUser.tradeJournal && typeof currentUser.tradeJournal === 'object') ? currentUser.tradeJournal : {};
        ensureDailyQuest();
        requestNotificationPermission();
        updateSyncBadge();
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('userAvatar').innerText = safeName[0].toUpperCase();
        document.getElementById('userDisplayName').innerText = safeName;
        // Save immediately so user appears on leaderboard right away
        await saveUserData(false);
        // Show the app and hide the homepage
        showApp();
        initMarket();
        if (!currentUser.tutorialDone) startTutorial(false);
    }

    function logOut() {
        if (!confirm('Sign out? Your progress is saved.')) return;
        currentUser = null;
        cash = 100000;
        portfolio = {};
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('authUser').value = '';
        document.getElementById('authPass').value = '';
        document.getElementById('authName').value = '';
        document.getElementById('authError').classList.add('hidden');
        authMode = 'login';
        document.getElementById('authTitle').innerText = 'Sign in';
        document.getElementById('authSubtitle').innerText = 'to your trading account';
        // Return to homepage
        showHomepage();
    }

    function simpleHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) { h = (Math.imul(31, h) + str.charCodeAt(i)) | 0; }
        return h.toString(36);
    }

    async function saveUserData(countTrade = false) {
        if (!currentUser || !currentUser.username) return false;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = stocks.find(x => x.symbol === sym);
            return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const totalShares = Object.values(portfolio).reduce((a, b) => a + b, 0);
        const season = getSeasonKey();
        currentUser.cash = cash;
        currentUser.portfolio = portfolio;
        currentUser.watchlist = watchlist;
        currentUser.priceAlerts = priceAlerts;
        currentUser.pendingOrders = pendingOrders;
        currentUser.transactions = transactions.slice(0, 200);
        currentUser.costBasis = costBasis;
        currentUser.achievements = achievements;
        currentUser.tradeStreak = tradeStreak;
        currentUser.dailyQuest = dailyQuest;
        currentUser.totalValue = cash + portfolioValue;
        currentUser.profit = (cash + portfolioValue) - 100000;
        currentUser.totalShares = totalShares;
        currentUser.realizedPL = Number(currentUser.realizedPL || 0);
        if (countTrade) currentUser.totalTrades = (currentUser.totalTrades || 0) + 1;
        currentUser.lastActive = Date.now();
        currentUser.seasonStats = currentUser.seasonStats || {};
        currentUser.seasonStats[season] = {
            totalValue: currentUser.totalValue,
            profit: currentUser.profit,
            totalShares: currentUser.totalShares,
            totalTrades: currentUser.totalTrades || 0
        };
        currentUser.perfHistory = perfHistory;
        currentUser.tradeJournal = tradeJournal;
        // New feature state
        if (typeof strategies !== 'undefined') currentUser.strategies = strategies;
        if (typeof riskGuardCfg !== 'undefined') currentUser.riskGuardCfg = { ...riskGuardCfg };
        if (typeof activeTheme !== 'undefined') currentUser.theme = activeTheme;
        try {
            const storage = ensureStorageAdapter();
            await storage.set('user:' + currentUser.username, JSON.stringify(currentUser), true);
            return true;
        } catch (e) {
            console.error('Failed to save user data:', e);
            return false;
        }
    }

    // getSeasonKey kept for backward compat with seasonStats references
    function getSeasonKey(ts = Date.now()) {
        const d = new Date(ts);
        const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum = utc.getUTCDay() || 7;
        utc.setUTCDate(utc.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
        const weekNum = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
        return utc.getUTCFullYear() + '-W' + String(weekNum).padStart(2, '0');
    }

    function dayKey(ts = Date.now()) {
        const d = new Date(ts);
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return d.getFullYear() + '-' + m + '-' + day;
    }

    function ensureDailyQuest() {
        const today = dayKey();
        if (dailyQuest.date !== today) {
            dailyQuest = { date: today, profitableTrades: 0, totalTrades: 0 };
        }
    }

    function inferSector(symbol, name) {
        const n = (name || '').toLowerCase();
        if (n.includes('bank') || n.includes('financial') || n.includes('capital')) return 'Financials';
        if (n.includes('pharma') || n.includes('health') || n.includes('med')) return 'Healthcare';
        if (n.includes('energy') || n.includes('oil') || n.includes('gas')) return 'Energy';
        if (n.includes('retail') || n.includes('consumer') || n.includes('walmart') || n.includes('costco')) return 'Consumer';
        if (n.includes('software') || n.includes('tech') || n.includes('semiconductor') || n.includes('cloud') || ['AAPL','MSFT','NVDA','GOOGL','META','AMD','INTC'].includes(symbol)) return 'Technology';
        if (n.includes('industrial') || n.includes('air') || n.includes('aerospace') || n.includes('transport')) return 'Industrials';
        return 'Other';
    }

    function fmtMoney(v) {
        return '$' + Number(v || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getStockBySymbol(sym) { return stocks.find(s => s.symbol === sym); }

    function avgCost(sym) {
        const cb = costBasis[sym];
        if (!cb || !cb.shares) return 0;
        return cb.totalCost / cb.shares;
    }

    function updateSyncBadge() {
        const el = document.getElementById('syncBadge');
        if (!el) return;
        el.innerText = window.__storageFallback ? 'Sync: Local' : 'Sync: Cloud';
        el.className = window.__storageFallback
            ? 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 font-semibold'
            : 'text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-semibold';
    }

    function addCurrentToWatchlist() {
        if (!detailStock) return;
        if (!watchlist.includes(detailStock.symbol)) watchlist.unshift(detailStock.symbol);
        watchlist = watchlist.slice(0, 40);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function toggleFollowCurrent() {
        if (!detailStock) return;
        const sym = detailStock.symbol;
        if (watchlist.includes(sym)) watchlist = watchlist.filter(s => s !== sym);
        else watchlist.unshift(sym);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function updateFollowButton() {
        const btn = document.getElementById('followBtn');
        if (!btn || !detailStock) return;
        const followed = watchlist.includes(detailStock.symbol);
        btn.innerText = followed ? 'Following' : '+ Follow';
        btn.className = followed
            ? 'ml-auto flex items-center gap-2 border border-[#8ab4f8] text-[#8ab4f8] px-4 py-1.5 rounded-full text-sm font-medium'
            : 'ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium';
    }

    function renderWatchlist() {
        const el = document.getElementById('watchlistItems');
        if (!el) return;
        if (!watchlist.length) { el.innerHTML = '<div class="text-xs text-gray-500">No watchlist symbols yet.</div>'; return; }
        el.innerHTML = watchlist.slice(0, 10).map(sym => {
            const st = getStockBySymbol(sym);
            const p = st ? st.price.toFixed(2) : 'â€”';
            return `<div class="flex items-center justify-between border border-gray-100 rounded px-2 py-1">
                <button class="font-semibold text-gray-700" onclick="openSymbolFromWatchlist('${sym}')">${sym}</button>
                <div class="text-gray-500">$${p}</div>
                <button class="text-red-500" onclick="removeWatchSymbol('${sym}')">Ã—</button>
            </div>`;
        }).join('');
    }

    function openSymbolFromWatchlist(sym) {
        const st = getStockBySymbol(sym);
        if (st) openStockDetail(st);
    }

    function removeWatchSymbol(sym) {
        watchlist = watchlist.filter(s => s !== sym);
        renderWatchlist();
        saveUserData(false);
    }

    function createPriceAlert() {
        const symbol = (document.getElementById('alertSymbol').value || '').trim().toUpperCase();
        const type = document.getElementById('alertType').value;
        const value = parseFloat(document.getElementById('alertValue').value || '0');
        if (!symbol || !getStockBySymbol(symbol)) return alert('Enter a valid symbol for alert.');
        if (!Number.isFinite(value) || value <= 0) return alert('Enter a valid alert value.');
        priceAlerts.unshift({ id: 'al_' + Date.now(), symbol, type, value, triggered: false, createdAt: Date.now() });
        priceAlerts = priceAlerts.slice(0, 60);
        renderAlerts();
        saveUserData(false);
    }

    function renderAlerts() {
        const el = document.getElementById('alertsList');
        if (!el) return;
        el.innerHTML = priceAlerts.slice(0, 8).map(a => {
            const status = a.triggered ? '<span class="text-green-600">triggered</span>' : '<span class="text-gray-500">active</span>';
            return `<div class="flex justify-between gap-2">
                <span>${a.symbol} ${a.type} ${a.value}</span>
                <span>${status} <button class="text-red-500" onclick="removeAlert('${a.id}')">Ã—</button></span>
            </div>`;
        }).join('') || '<div class="text-gray-500">No alerts yet.</div>';

        const feed = document.getElementById('alertFeed');
        if (feed) feed.innerHTML = alertEvents.slice(0, 4).map(x => '<div style="color:#4ade80;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:6px;padding:4px 8px;">' + x + '</div>').join('');
    }

    function removeAlert(id) {
        priceAlerts = priceAlerts.filter(a => a.id !== id);
        renderAlerts();
        saveUserData(false);
    }

    function renderPendingOrders() {
        const el = document.getElementById('pendingOrdersList');
        if (!el) return;
        const open = pendingOrders.filter(o => o.status === 'OPEN').slice(0, 6);
        el.innerHTML = open.map(o => '<div class="flex justify-between"><span>' + o.side + ' ' + o.qty + ' ' + o.symbol + ' (' + o.type + ')</span><span>@ ' + o.trigger.toFixed(2) + '</span></div>').join('') || '<div class="text-gray-400">No pending orders</div>';
    }

    function shouldFillOrder(order, stock) {
        if (!stock) return false;
        if (order.type === 'limit') {
            if (order.side === 'BUY') return stock.price <= order.trigger;
            return stock.price >= order.trigger;
        }
        if (order.type === 'stop-loss') return order.side === 'SELL' && stock.price <= order.trigger;
        if (order.type === 'take-profit') return order.side === 'SELL' && stock.price >= order.trigger;
        return false;
    }

    function executeOrderNow(order, fillPrice, fromPending) {
        const sym = order.symbol;
        const qty = order.qty;
        const price = fillPrice;
        const held = portfolio[sym] || 0;
        let realized = 0;

        if (order.side === 'BUY') {
            const cost = price * qty;
            if (cash * leverage < cost) { if (!fromPending) alert('Insufficient Buying Power!'); return false; }
            cash -= cost;
            portfolio[sym] = held + qty;
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.shares += qty;
            cb.totalCost += cost;
            costBasis[sym] = cb;
        } else {
            if (held < qty) { if (!fromPending) alert('Not enough shares to sell.'); return false; }
            const avg = avgCost(sym);
            realized = (price - avg) * qty;
            cash += price * qty;
            portfolio[sym] = held - qty;
            if (portfolio[sym] <= 0) delete portfolio[sym];
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.totalCost = Math.max(0, cb.totalCost - avg * qty);
            cb.shares = Math.max(0, cb.shares - qty);
            if (cb.shares === 0) delete costBasis[sym]; else costBasis[sym] = cb;
            currentUser.realizedPL = Number(currentUser.realizedPL || 0) + realized;
        }

        transactions.unshift({
            id: 'tx_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
            symbol: sym,
            side: order.side,
            qty,
            price,
            orderType: order.type,
            realizedPL: realized,
            timestamp: Date.now()
        });
        transactions = transactions.slice(0, 300);
        ensureDailyQuest();
        dailyQuest.totalTrades += 1;
        if (realized > 0) dailyQuest.profitableTrades += 1;
        updateStreak();
        checkAchievements();
        if (fromPending) {
            order.status = 'FILLED';
            order.filledAt = Date.now();
            order.fillPrice = price;
        }
        updateUI();
        renderPendingOrders();
        saveUserData(true);
        onTutorialEvent(order.side === 'BUY' ? 'buy_trade' : 'sell_trade');
        return true;
    }

    function updateStreak() {
        const today = dayKey();
        if (!tradeStreak.lastDay) { tradeStreak = { count: 1, lastDay: today }; return; }
        if (tradeStreak.lastDay === today) return;
        const prev = new Date(tradeStreak.lastDay + 'T00:00:00');
        const now = new Date(today + 'T00:00:00');
        const diff = Math.round((now - prev) / 86400000);
        tradeStreak.count = diff === 1 ? (tradeStreak.count + 1) : 1;
        tradeStreak.lastDay = today;
    }

    function checkAchievements() {
        const names = new Set(achievements.map(a => a.name));
        const totalTrades = currentUser.totalTrades || 0;
        const realized = Number(currentUser.realizedPL || 0);
        const maybeAdd = (name) => { if (!names.has(name)) achievements.unshift({ name, at: Date.now() }); };
        if (totalTrades >= 10) maybeAdd('First 10 Trades');
        if (totalTrades >= 50) maybeAdd('Active Trader');
        if (realized >= 1000) maybeAdd('Profit Hunter');
        if (tradeStreak.count >= 3) maybeAdd('3-Day Streak');
        if (dailyQuest.profitableTrades >= 3) maybeAdd('Quest: 3 Profitable Trades');
        achievements = achievements.slice(0, 20);
    }

    function renderHistory() {
        const el = document.getElementById('historyList');
        if (!el) return;
        if (transactions.length === 0) {
            el.innerHTML = '<div style="color:#8888a8;text-align:center;padding:12px 0;font-style:italic;">No trades yet.</div>';
            return;
        }
        el.innerHTML = transactions.slice(0, 20).map(t => {
            const isBuy  = t.side === 'BUY';
            const badgeStyle = isBuy
                ? 'background:rgba(34,197,94,0.15);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const plHtml = t.side === 'SELL'
                ? `<span style="font-weight:600;margin-left:6px;font-size:10px;color:${t.realizedPL >= 0 ? '#4ade80' : '#f87171'}">${t.realizedPL >= 0 ? '+' : ''}${fmtMoney(t.realizedPL)}</span>`
                : '';
            const time = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `<div data-tx-id="${t.id}" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;margin-bottom:4px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;${badgeStyle}">${t.side}</span>
                    <span style="font-size:12px;color:#c0c0d8;">${t.qty} Ã— <strong style="color:#e8e8f5;">${t.symbol}</strong></span>
                    ${plHtml}
                    ${(tradeJournal[t.symbol]||[]).length ? '<span title="Has journal note" style="font-size:10px;">ğŸ““</span>' : ''}
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px;font-weight:600;color:#e0e0f5;font-family:var(--v-mono);">$${t.price.toFixed(2)}</div>
                    <div style="font-size:10px;color:#606080;">${time}</div>
                </div>
            </div>`;
        }).join('');
    }

    function renderAnalytics() {
        const realized = Number(currentUser && currentUser.realizedPL || 0);
        let unrealized = 0;
        const alloc    = [];
        const sectors  = {};

        Object.keys(portfolio).forEach(sym => {
            const st = getStockBySymbol(sym);
            if (!st) return;
            const qty = portfolio[sym];
            const val = st.price * qty;
            alloc.push({ sym, val });
            const avg = avgCost(sym);
            unrealized += (st.price - avg) * qty;
            sectors[st.sector] = (sectors[st.sector] || 0) + val;
        });

        // Realized / Unrealized P&L
        const rEl = document.getElementById('realizedPL');
        const uEl = document.getElementById('unrealizedPL');
        if (rEl) {
            rEl.innerText  = (realized   >= 0 ? '+' : '') + fmtMoney(realized);
            rEl.style.color = realized   >= 0 ? '#4ade80' : '#f87171';
        }
        if (uEl) {
            uEl.innerText  = (unrealized >= 0 ? '+' : '') + fmtMoney(unrealized);
            uEl.style.color = unrealized >= 0 ? '#4ade80' : '#f87171';
        }

        // Sector exposure
        const secEl = document.getElementById('sectorExposure');
        if (secEl) {
            const total = Object.values(sectors).reduce((a,b)=>a+b,0) || 1;
            const sorted = Object.entries(sectors).sort((a,b)=>b[1]-a[1]).slice(0,5);
            if (sorted.length === 0) {
                secEl.innerHTML = '<div class="text-gray-400">No positions yet.</div>';
            } else {
                secEl.innerHTML = sorted.map(([k,v]) => {
                    const pct = ((v/total)*100).toFixed(1);
                    return `<div class="flex justify-between items-center">
                        <span class="text-gray-600">${k}</span>
                        <div class="flex items-center gap-2">
                            <div class="h-1.5 rounded-full bg-blue-400" style="width:${Math.round(pct)}px"></div>
                            <span class="font-semibold">${pct}%</span>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // Pie chart â€” update data instead of destroying/recreating
        const canvas = document.getElementById('allocationChart');
        if (!canvas) return;
        const labels = alloc.slice(0,8).map(x => x.sym);
        const values = alloc.slice(0,8).map(x => x.val);
        const COLORS  = ['#1a73e8','#34a853','#fbbc05','#ea4335','#7baaf7','#81c995','#fdd663','#f28b82'];

        if (allocationChart && allocationChart.data) {
            // Update existing chart data without destroying it
            allocationChart.data.labels   = labels;
            allocationChart.data.datasets[0].data = values.length ? values : [1];
            allocationChart.data.datasets[0].backgroundColor = values.length ? COLORS : ['#e0e0e0'];
            allocationChart.update('none'); // 'none' = no animation, instant
        } else {
            if (allocationChart) allocationChart.destroy();
            allocationChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: labels.length ? labels : ['Empty'],
                    datasets: [{ data: values.length ? values : [1], backgroundColor: values.length ? COLORS : ['#e0e0e0'] }]
                },
                options: {
                    plugins: { legend: { display: false }, tooltip: {
                        callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString(undefined,{maximumFractionDigits:0})}` }
                    }},
                    maintainAspectRatio: false,
                    animation: { duration: 300 }
                }
            });
        }
    }

    function renderQuestsAndAchievements() {
        ensureDailyQuest();

        // Daily quests with progress bars
        const quest = document.getElementById('questList');
        if (quest) {
            const pTrades   = Math.min(dailyQuest.profitableTrades, 3);
            const tTrades   = Math.min(dailyQuest.totalTrades, 5);
            const pPct      = (pTrades / 3 * 100).toFixed(0);
            const tPct      = (tTrades / 5 * 100).toFixed(0);
            const pDone     = pTrades >= 3;
            const tDone     = tTrades >= 5;
            quest.innerHTML = `
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span>${pDone ? 'âœ…' : 'ğŸ¯'} Profitable trades</span>
                        <span class="font-bold ${pDone ? 'text-green-600' : ''}">${pTrades}/3</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${pPct}%;background:${pDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span>${tDone ? 'âœ…' : 'ğŸ“Š'} Total trades today</span>
                        <span class="font-bold ${tDone ? 'text-green-600' : ''}">${tTrades}/5</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${tPct}%;background:${tDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>`;
        }

        // Streak
        const streak = document.getElementById('tradeStreak');
        if (streak) streak.innerText = (tradeStreak.count || 0) + ' day' + (tradeStreak.count !== 1 ? 's' : '');

        // Achievements
        const ach = document.getElementById('achievementList');
        if (ach) {
            ach.innerHTML = achievements.slice(0,8).map(a =>
                `<span class="text-xs bg-yellow-50 border border-yellow-200 text-yellow-800 px-2 py-1 rounded">ğŸ… ${a.name}</span>`
            ).join('') || '<span class="text-xs text-gray-400">Complete trades to earn badges.</span>';
        }
    }

    function renderNews() {
        const feed = document.getElementById('newsFeed');
        if (!feed) return;
        const movers = stocks.slice().sort((a,b)=>Math.abs(b.change)-Math.abs(a.change)).slice(0,4);
        feed.innerHTML = movers.map((s, i) => {
            const pos = s.change >= 0;
            const sentiment = pos ? 'Bullish' : 'Bearish';
            const tagStyle = pos
                ? 'background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const source = ['Reuters','Bloomberg','CNBC','WSJ'][i % 4];
            const headline = pos ? (s.symbol + ' climbs as momentum buyers step in') : (s.symbol + ' slips as sellers pressure the tape');
            return '<div style="padding:14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;background:#1a1a24;">'
                + '<div style="font-size:11px;color:#8888a8;margin-bottom:6px;"><span style="font-weight:700;color:#b0b0c8;">' + source + '</span> Â· ' + (15 + i * 10) + ' min ago</div>'
                + '<div style="font-size:0.875rem;font-weight:500;color:#e0e0f5;line-height:1.4;margin-bottom:8px;">' + headline + '</div>'
                + '<div style="display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;' + tagStyle + '">' + sentiment + '</div>'
                + '</div>';
        }).join('');
    }

    function renderDetailNews(symbol) {
        const el = document.getElementById('detailNews');
        if (!el || !symbol) return;
        const st = getStockBySymbol(symbol);
        const pos = st && st.change >= 0;
        const t1 = pos ? 'Analysts raise short-term outlook for ' + symbol : 'Analysts cut near-term targets for ' + symbol;
        const t2 = pos ? symbol + ' options flow shows bullish positioning' : symbol + ' sees defensive hedging activity';
        el.innerHTML = '<div class="text-xs text-gray-300">Ticker News</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t1 + '</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t2 + '</div>';
    }

    function processPendingOrders() {
        let changed = false;
        pendingOrders.forEach(o => {
            if (o.status !== 'OPEN') return;
            const st = getStockBySymbol(o.symbol);
            if (shouldFillOrder(o, st)) {
                const ok = executeOrderNow(o, st.price, true);
                if (ok) changed = true;
            }
        });
        if (changed) saveUserData(false);
    }

    // processAlerts is defined later with notification support

    function simulateMarketTick() {
        stocks.forEach(s => {
            // Skip simulation for stocks that have fresh live data (< 30 sec old)
            const cached = RT.cache[s.symbol];
            if (cached && RT.key && (Date.now() - cached.ts) < 30000) return;

            const drift = (Math.random() - 0.5) * 0.018;
            s.price = Math.max(1, s.price * (1 + drift));
            s.change = Math.max(-30, Math.min(30, s.change + drift * 100));
        });
        renderGrid();
        updateUI();
        processPendingOrders();
        processAlerts();
        renderNews();
        // If detail page is open, update just the price fields â€” never re-open it
        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
    }

    // Update price/change fields on the detail page without touching anything else
    function updateDetailPriceFields(s) {
        const isPos = s.change >= 0;
        const changeAmt = s.price * Math.abs(s.change) / 100;
        const color = isPos ? '#81c995' : '#f28b82';
        const priceEl = document.getElementById('detailPrice');
        if (priceEl) priceEl.innerText = s.price.toFixed(2);
        const caEl = document.getElementById('detailChangeAmt');
        if (caEl) { caEl.style.color = color; caEl.innerText = (isPos?'+':'-') + changeAmt.toFixed(2); }
        const cpEl = document.getElementById('detailChangePct');
        if (cpEl) { cpEl.style.color = color; cpEl.innerText = '(' + Math.abs(s.change).toFixed(2) + '%)'; }
        const arEl = document.getElementById('detailArrow');
        if (arEl) { arEl.style.color = color; arEl.innerText = isPos ? 'â†‘' : 'â†“'; }
        const bpEl = document.getElementById('dBuyPow');
        if (bpEl) bpEl.innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function exportPortfolioData() {
        if (!currentUser) return;
        const payload = {
            username: currentUser.username,
            displayName: currentUser.displayName,
            cash,
            portfolio,
            watchlist,
            priceAlerts,
            pendingOrders,
            transactions,
            costBasis,
            achievements,
            tradeStreak,
            dailyQuest,
            realizedPL: Number(currentUser.realizedPL || 0)
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'portfolio-' + currentUser.username + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importPortfolioData(event) {
        const file = event.target.files && event.target.files[0];
        if (!file || !currentUser) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                cash = Number(data.cash || 100000);
                portfolio = data.portfolio || {};
                watchlist = Array.isArray(data.watchlist) ? data.watchlist : [];
                priceAlerts = Array.isArray(data.priceAlerts) ? data.priceAlerts : [];
                pendingOrders = Array.isArray(data.pendingOrders) ? data.pendingOrders : [];
                transactions = Array.isArray(data.transactions) ? data.transactions : [];
                costBasis = data.costBasis || {};
                achievements = Array.isArray(data.achievements) ? data.achievements : [];
                tradeStreak = data.tradeStreak || { count: 0, lastDay: '' };
                dailyQuest = data.dailyQuest || { date: '', profitableTrades: 0, totalTrades: 0 };
                currentUser.realizedPL = Number(data.realizedPL || 0);
                updateUI();
                saveUserData(false);
                alert('Import complete.');
            } catch (e) {
                alert('Invalid import file.');
            }
        };
        reader.readAsText(file);
    }

    const tutorialSteps = [
        {
            icon: 'ğŸ§ ',
            title: 'Welcome to Vestra Intelligence Platform',
            desc: 'Vestra is a structured trading psychology lab â€” not a game. You get $100,000 in virtual capital, real-time market data, and a full suite of decision intelligence tools. The goal: build real skills before real money is at stake.',
            hint: 'No financial risk. Pure professional training.',
            event: null
        },
        {
            icon: 'âš¡',
            title: 'Step 1: Connect Live Market Data',
            desc: 'Click "âš¡ Live Data" in the header to add your free Finnhub API key. This enables real-time prices, candlestick charts, and trading. Get your free key at finnhub.io â€” takes 60 seconds.',
            hint: 'ğŸ”‘ Trading is disabled without an API key',
            event: null
        },
        {
            icon: 'ğŸ›¡',
            title: 'Step 2: Set Your Risk Rules',
            desc: 'Before your first trade, open Risk Guard (âš™ in toolbar). Set a max risk per trade (e.g. 2%), a daily loss limit, and max open positions. These rules will be enforced â€” protecting you from common beginner mistakes.',
            hint: 'Risk Guard is what separates disciplined traders from gamblers.',
            event: null
        },
        {
            icon: 'ğŸ§ª',
            title: 'Step 3: Create a Strategy',
            desc: 'Open Strategy Lab and define your first trading strategy â€” give it a name, entry/exit rules, and a risk-per-trade target. Tag every trade to a strategy. This is how you measure what actually works.',
            hint: 'ğŸ“‹ Unnamed trades cannot be reviewed systematically.',
            event: null
        },
        {
            icon: 'ğŸ’¸',
            title: 'Step 4: Place Your First Trade',
            desc: 'Open any stock card, set quantity, choose order type (start with Market), and hit Buy. A journal prompt will appear â€” write your thesis. Why this stock? What\'s the setup? What could go wrong?',
            hint: 'ğŸŸ¢ Market orders execute immediately at the current price',
            event: 'buy_trade'
        },
        {
            icon: 'ğŸ“Š',
            title: 'Step 5: Review with the AI Coach',
            desc: 'After a few trades, open the AI Trade Coach (ğŸ§  in toolbar). It will analyze your position sizing patterns, hold-time bias, and detect emotional trading patterns like revenge trading or recency bias.',
            hint: 'Bias detection requires at least 3 closed trades.',
            event: null
        },
        {
            icon: 'ğŸ—“',
            title: 'Step 6: Study Your Decision Timeline',
            desc: 'The Decision Timeline plots every trade on your equity curve with market regime labels. Use it to find: When did you make your best decisions? What regime were you trading in? Were you clustering entries after losses?',
            hint: null,
            event: null
        },
        {
            icon: 'ğŸ”•',
            title: 'Pro Tip: Use Silent Focus Mode',
            desc: 'Toggle "Focus" in the toolbar to hide all P&L while positions are open. Train yourself to focus on process, not outcome. Results are revealed only when you close a position â€” building discipline under uncertainty.',
            hint: 'ğŸ¯ Elite traders focus on decisions, not dollar signs.',
            event: null
        },
        {
            icon: 'ğŸš€',
            title: 'You\'re Ready. Build Your Edge.',
            desc: 'Start trading. Review your discipline scores weekly. Advance through challenge tiers. Compete on the risk-adjusted leaderboard. Every feature exists to measure and improve a specific trading skill.',
            hint: 'The goal is not to win. The goal is to become better.',
            event: null
        }
    ];

    function renderTutorialStep() {
        const step = tutorialState.step;
        const s = tutorialSteps[step];
        const total = tutorialSteps.length;

        document.getElementById('tutorialIcon').textContent  = s.icon;
        document.getElementById('tutorialTitle').textContent = s.title;
        document.getElementById('tutorialDesc').textContent  = s.desc;

        const hintEl = document.getElementById('tutorialHint');
        if (s.hint) { hintEl.textContent = s.hint; hintEl.classList.remove('hidden'); }
        else { hintEl.classList.add('hidden'); }

        // Progress fill
        document.getElementById('tutorialProgressFill').style.width = ((step / (total - 1)) * 100) + '%';

        // Dots
        const dotsEl = document.getElementById('tutorialDots');
        dotsEl.innerHTML = tutorialSteps.map((_, i) =>
            `<div class="rounded-full transition-all duration-300" style="width:${i===step?'20px':'8px'};height:8px;background:${i===step?'#a78bfa':i<step?'rgba(167,139,250,0.5)':'rgba(255,255,255,0.15)'}"></div>`
        ).join('');

        // Back button
        const prevBtn = document.getElementById('tutorialPrevBtn');
        if (step > 0) prevBtn.classList.remove('hidden'); else prevBtn.classList.add('hidden');

        // Next button label
        const nextBtn = document.getElementById('tutorialNextBtn');
        nextBtn.textContent = step === total - 1 ? 'ğŸš€ Start Trading' : 'Continue â†’';
    }

    function startTutorial(forceOpen) {
        if (!forceOpen && currentUser && currentUser.tutorialDone) return;
        tutorialState.active = true;
        tutorialState.step   = 0;
        document.getElementById('tutorialOverlay').classList.remove('hidden');
        renderTutorialStep();
    }

    function tutorialNext() {
        const total = tutorialSteps.length;
        if (tutorialState.step >= total - 1) { skipTutorial(); return; }
        tutorialState.step++;
        renderTutorialStep();
    }

    function tutorialPrev() {
        if (tutorialState.step <= 0) return;
        tutorialState.step--;
        renderTutorialStep();
    }

    function skipTutorial() {
        tutorialState.active = false;
        document.getElementById('tutorialOverlay').classList.add('hidden');
        if (currentUser) { currentUser.tutorialDone = true; saveUserData(false); }
    }

    function nextTutorialStep() { tutorialNext(); } // legacy alias

    function onTutorialEvent(eventName) {
        if (!tutorialState.active) return;
        const step = tutorialSteps[tutorialState.step];
        if (step && step.event === eventName) {
            setTimeout(() => tutorialNext(), 600); // slight delay so user sees the action
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   REAL-TIME DATA ENGINE â€” Finnhub Integration
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // --- Config ---
    const RT = {
        key: localStorage.getItem('finnhub_api_key') || '',
        interval: 10000,
        timer: null,
        cache: {},
        queue: [],
        queueIdx: 0,
        liveCount: 0,
        batchSize: 10,
    };

    // Priority symbols: watchlist + portfolio + top 20, then rest
    function buildQueue() {
        const priority = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const rest = stocks.filter(s => !priority.has(s.symbol)).map(s => s.symbol);
        RT.queue = [...priority, ...rest];
        // Do NOT reset queueIdx here â€” we want to cycle through all stocks over time
    }

    // Fetch a single quote from Finnhub
    async function fetchQuote(symbol) {
        if (!RT.key) return null;
        try {
            const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${RT.key}`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            if (!data.c || data.c === 0) return null;
            return data;
        } catch (e) { return null; }
    }

    // Apply a real quote to our stock object
    function applyRealQuote(symbol, data) {
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const newPrice = data.c;
        if (!newPrice || newPrice <= 0) return;
        stock.price  = newPrice;
        stock.change = (data.dp != null) ? data.dp : stock.change;
        if (data.h)  stock.dayHigh   = data.h;
        if (data.l)  stock.dayLow    = data.l;
        if (data.o)  stock.dayOpen   = data.o;
        if (data.pc) stock.prevClose = data.pc;
        RT.cache[symbol] = { price: newPrice, change: stock.change, ts: Date.now() };
        RT.liveCount++;

        // â”€â”€ Patch base store last candle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Keep the cached daily base in sync with the live price so ALL derived
        // views (1M, 6M, YTD, 1Y, 5Y, Max) show the correct final close without
        // requiring a new API fetch for each period switch.
        const baseEntry = _baseStore[symbol];
        if (baseEntry && baseEntry.candles && baseEntry.candles.length > 0) {
            const lb = baseEntry.candles[baseEntry.candles.length-1];
            if (Math.abs(lb.c - newPrice) >= 0.005) {
                lb.c = +newPrice.toFixed(4);
                lb.h = Math.max(lb.h, newPrice);
                lb.l = Math.min(lb.l, newPrice);
            }
        }

        // â”€â”€ Live chart candle sync â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // When the live batch-fetch updates a quote, immediately sync the last
        // chart candle so chart close = header price = portfolio price.
        // Applies to both Chart.js mode and canvas fallback mode.
        if (detailStock && detailStock.symbol === symbol) {
            try {
                if (sChart && !sChart._destroyed) {
                    const ds0 = sChart.data.datasets[0];
                    if (ds0 && ds0.data && ds0.data.length > 0) {
                        const last = ds0.data[ds0.data.length - 1];
                        if (last && Math.abs((last.c||0) - newPrice) >= 0.005) {
                            last.c = +newPrice.toFixed(4);
                            last.h = Math.max(last.h||newPrice, newPrice);
                            last.l = Math.min(last.l||newPrice, newPrice);
                            sChart.update('none');
                        }
                    }
                } else {
                    // Canvas fallback: re-paint if canvas has stored candles
                    const canvas = document.getElementById('stockChart');
                    if (canvas && canvas._candles && canvas._candles.length > 0) {
                        const lc = canvas._candles[canvas._candles.length-1];
                        if (Math.abs(lc.c - newPrice) >= 0.005) {
                            lc.c = +newPrice.toFixed(4);
                            lc.h = Math.max(lc.h, newPrice);
                            lc.l = Math.min(lc.l, newPrice);
                            paintCandleCanvas(canvas, canvas._candles, themeColors(), currentChartPeriod);
                        }
                    }
                }
            } catch(_) {}

            // Keep header price display in sync (in case updateDetailPriceFields hasn't fired yet)
            try {
                const priceEl = document.getElementById('detailPrice');
                if (priceEl && Math.abs(parseFloat(priceEl.innerText||'0') - newPrice) >= 0.005) {
                    priceEl.innerText = newPrice.toFixed(2);
                }
            } catch(_) {}
        }
    }

    // Batch-fetch: priority stocks every cycle, rest rotate
    async function fetchNextBatch() {
        if (!RT.key) return;

        const prioritySet = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...(detailStock ? [detailStock.symbol] : []),
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const prioritySyms = [...prioritySet];
        const restSyms = stocks.filter(s => !prioritySet.has(s.symbol)).map(s => s.symbol);

        if (RT.queueIdx >= restSyms.length) RT.queueIdx = 0;
        const rotatingBatch = restSyms.slice(RT.queueIdx, RT.queueIdx + 10);
        RT.queueIdx += 10;

        const batch = [...new Set([...prioritySyms, ...rotatingBatch])];

        RT.liveCount = 0;
        await Promise.all(batch.map(async sym => {
            const data = await fetchQuote(sym);
            if (data) applyRealQuote(sym, data);
        }));

        renderGrid();
        updateUI();

        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
        updateDataSourceUI();
    }

    // Start/stop the live data loop
    function startLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        fetchNextBatch(); // immediate first fetch
        RT.timer = setInterval(fetchNextBatch, RT.interval);
        updateMarketStatus();
    }

    function stopLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        RT.timer = null;
        RT.liveCount = 0;
        updateDataSourceUI();
    }

    // --- Market Hours (NYSE) ---
    function isMarketOpen() {
        const now = new Date();
        // Convert to Eastern Time
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay(); // 0=Sun, 6=Sat
        if (day === 0 || day === 6) return false;
        const h = et.getHours(), m = et.getMinutes();
        const mins = h * 60 + m;
        return mins >= 9 * 60 + 30 && mins < 16 * 60;
    }

    function updateMarketStatus() {
        const dot  = document.getElementById('marketStatusDot');
        const text = document.getElementById('marketStatusText');
        if (!dot || !text) return;
        if (isMarketOpen()) {
            dot.className  = 'w-2 h-2 rounded-full dot-live';
            text.textContent = 'Market Open';
            text.className   = 'text-xs text-green-600 font-semibold';
        } else {
            dot.className  = 'w-2 h-2 rounded-full dot-closed';
            text.textContent = 'Market Closed';
            text.className   = 'text-xs text-gray-500 font-medium';
        }
    }

    function updateDataSourceUI() {
        const badge = document.getElementById('dataSourceBadge');
        const btn   = document.getElementById('liveDataBtn');
        if (!badge) return;
        if (RT.key && RT.liveCount > 0) {
            badge.textContent = 'âš¡ LIVE';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-live';
            if (btn) { btn.textContent = 'âš¡ Live: ON'; btn.style.cssText = 'font-size:11px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.35);color:#4ade80;padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        } else if (RT.key) {
            badge.textContent = 'â†» Fetchingâ€¦';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-stale';
        } else {
            badge.textContent = 'SIM';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-sim';
            if (btn) { btn.textContent = 'âš¡ Live Data'; btn.style.cssText = 'font-size:11px;background:rgba(212,168,75,0.12);border:1px solid rgba(212,168,75,0.3);color:var(--v-gold);padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        }
    }

    // Data freshness per card
    function getCardFreshnessLabel(symbol) {
        const cached = RT.cache[symbol];
        if (!cached || !RT.key) return '';
        const ageSec = Math.round((Date.now() - cached.ts) / 1000);
        return `<span class="text-[9px] font-semibold badge-live rounded px-1 ml-1">liveÂ·${ageSec}s</span>`;
    }

    // --- API Config Modal ---
    function openApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        // Only pre-fill if the user themselves previously saved a key
        const savedKey = localStorage.getItem('finnhub_api_key') || '';
        document.getElementById('finnhubKeyInput').value = savedKey;
        document.getElementById('updateIntervalInput').value = RT.interval || 10000;
        document.getElementById('apiConfigError').style.display = 'none';
        document.getElementById('apiTestResult').style.display = 'none';
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }

    function closeApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        modal.classList.add('hidden');
        modal.style.display = '';
    }

    async function saveApiConfig() {
        const key      = document.getElementById('finnhubKeyInput').value.trim();
        const interval = Number(document.getElementById('updateIntervalInput').value);
        const errEl    = document.getElementById('apiConfigError');
        const resultEl = document.getElementById('apiTestResult');

        errEl.classList.add('hidden');
        resultEl.classList.remove('hidden');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';

        if (!key) {
            errEl.textContent = 'âš ï¸ Please enter an API key.';
            errEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            return;
        }

        // Save immediately without network test (network is blocked in preview environments)
        RT.key      = key;
        RT.interval = interval;
        localStorage.setItem('finnhub_api_key', key);
        localStorage.setItem('finnhub_interval', interval);

        resultEl.style.cssText = 'margin-top:12px;font-size:13px;text-align:center;color:#4ade80;font-weight:600;display:block;';
        resultEl.textContent = 'âœ… Key saved! Live data will activate when opened locally.';

        // Try a live test â€” works when opened as a local file, silently skips if blocked
        try {
            const testUrl = `https://finnhub.io/api/v1/quote?symbol=AAPL&token=${key}`;
            const res = await fetch(testUrl);
            const data = await res.json();
            if (data.c && data.c > 0) {
                resultEl.textContent = `âœ… Connected! AAPL = $${data.c.toFixed(2)}`;
                startLiveData();
                setTimeout(closeApiConfig, 1800);
                return;
            }
        } catch(e) {
            // Network blocked (e.g. running in Claude preview) â€” key is still saved
        }

        startLiveData(); // will gracefully no-op if network blocked
        updateDataSourceUI();
        setTimeout(closeApiConfig, 2200);
    }

    function clearApiConfig() {
        RT.key = '';
        localStorage.removeItem('finnhub_api_key');
        localStorage.removeItem('finnhub_interval');
        stopLiveData();
        document.getElementById('finnhubKeyInput').value = '';
        document.getElementById('apiTestResult').classList.add('hidden');
        const resultEl = document.getElementById('apiTestResult');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';
        resultEl.textContent = 'Live data cleared. Using simulated mode.';
        resultEl.classList.remove('hidden');
        updateDataSourceUI();
        setTimeout(closeApiConfig, 1500);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: LIVE SEARCH DROPDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let searchTimeout = null;
    function handleSearch(val) {
        document.getElementById('searchClear').style.display = val ? 'block' : 'none';
        renderGrid(); // keep grid filtering
        clearTimeout(searchTimeout);
        if (!val.trim()) { hideSearchDropdown(); return; }
        searchTimeout = setTimeout(() => showSearchDropdown(val), 80);
    }
    function showSearchDropdown(val) {
        const q = (val || document.getElementById('search').value || '').toUpperCase().trim();
        const drop = document.getElementById('searchDropdown');
        if (!q) { drop.style.display = 'none'; return; }
        const matches = stocks.filter(s =>
            s.symbol.startsWith(q) || s.symbol.includes(q) || s.name.toUpperCase().includes(q)
        ).slice(0, 12);
        if (!matches.length) { drop.style.display = 'none'; return; }
        drop.innerHTML = matches.map(s => {
            const pos = s.change >= 0;
            const col = pos ? '#4ade80' : '#f87171';
            const sign = pos ? '+' : '';
            return `<div class="search-result-item" onclick="selectSearchResult('${s.symbol}')">
                <div>
                    <div style="font-weight:700;color:#e8e8f5;font-size:0.9rem;">${s.symbol}</div>
                    <div style="font-size:11px;color:#8888a8;margin-top:1px;">${s.name}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-family:var(--v-mono);font-size:0.9rem;color:#f0f0fa;">$${s.price.toFixed(2)}</div>
                    <div style="font-size:11px;color:${col};font-family:var(--v-mono);">${sign}${s.change.toFixed(2)}%</div>
                </div>
            </div>`;
        }).join('');
        drop.style.display = 'block';
    }
    function hideSearchDropdown() {
        document.getElementById('searchDropdown').style.display = 'none';
    }
    function selectSearchResult(symbol) {
        const stock = getStockBySymbol(symbol);
        if (stock) { hideSearchDropdown(); openStockDetail(stock); }
    }
    function clearSearch() {
        document.getElementById('search').value = '';
        document.getElementById('searchClear').style.display = 'none';
        hideSearchDropdown();
        renderGrid();
    }
    document.addEventListener('click', e => {
        if (!document.getElementById('searchWrap')?.contains(e.target)) hideSearchDropdown();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: DESKTOP PRICE ALERT NOTIFICATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
    function fireAlertNotification(symbol, type, value, price) {
        const title = `ğŸ”” Vestra Alert: ${symbol}`;
        const body = `${symbol} is ${type} $${value} â€” now at $${price.toFixed(2)}`;
        if ('Notification' in window && Notification.permission === 'granted') {
            const n = new Notification(title, { body, icon: '' });
            setTimeout(() => n.close(), 6000);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: MARKET OPEN/CLOSE COUNTDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateCountdown() {
        const el = document.getElementById('marketCountdown');
        if (!el) return;
        const now = new Date();
        const ny = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = ny.getDay();
        const h = ny.getHours(), m = ny.getMinutes(), s = ny.getSeconds();
        const totalSec = h * 3600 + m * 60 + s;
        const openSec = 9 * 3600 + 30 * 60;
        const closeSec = 16 * 3600;
        const isWeekday = day >= 1 && day <= 5;
        const marketOpen = isWeekday && totalSec >= openSec && totalSec < closeSec;

        let diff, label;
        if (!isWeekday || (!marketOpen && totalSec >= closeSec)) {
            // Weekend or after close â€” count to next Monday or tomorrow open
            let daysToOpen = day === 6 ? 2 : (day === 0 ? 1 : (day === 5 ? 3 : 1));
            diff = daysToOpen * 86400 - totalSec + openSec;
            label = 'Opens in';
        } else if (marketOpen) {
            diff = closeSec - totalSec;
            label = 'Closes in';
        } else {
            diff = openSec - totalSec;
            label = 'Opens in';
        }
        const hh = Math.floor(diff / 3600);
        const mm = Math.floor((diff % 3600) / 60);
        const ss = diff % 60;
        const pad = n => String(n).padStart(2, '0');
        el.textContent = `${label} ${hh > 0 ? hh + 'h ' : ''}${pad(mm)}m ${pad(ss)}s`;
        el.style.color = marketOpen ? '#4ade80' : 'var(--v-muted)';
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: DARK / LIGHT MODE TOGGLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleMoreMenu() {
        const m = document.getElementById('moreMenu');
        if (m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }
    document.addEventListener('click', e => {
        const wrap = document.getElementById('moreMenuWrap');
        if (wrap && !wrap.contains(e.target)) {
            const m = document.getElementById('moreMenu');
            if (m) m.style.display = 'none';
        }
    }, true);

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        document.getElementById('themeToggle').textContent = isLight ? 'ğŸŒ™' : 'â˜€ï¸';
        localStorage.setItem('vestra_theme', isLight ? 'light' : 'dark');
    }
    // Restore saved theme
    if (localStorage.getItem('vestra_theme') === 'light') {
        document.body.classList.add('light-mode');
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('themeToggle');
            if (btn) btn.textContent = 'â˜€ï¸';
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: PORTFOLIO PERFORMANCE CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let perfHistory = []; // [{ts, value}]
    let perfChart = null;
    let perfPeriod = '1D';

    function recordPerfSnapshot() {
        if (!currentUser) return;
        const val = cash + Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym);
            return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const now = Date.now();
        // Only add a snapshot every 5 minutes at most
        if (perfHistory.length && now - perfHistory[perfHistory.length - 1].ts < 300000) {
            perfHistory[perfHistory.length - 1].value = val; // update last
        } else {
            perfHistory.push({ ts: now, value: val });
        }
        // Keep max 365 days of data
        const cutoff = now - 365 * 86400000;
        perfHistory = perfHistory.filter(p => p.ts > cutoff);
        if (currentUser) currentUser.perfHistory = perfHistory;
        drawPerfChart();
    }

    function setPerfPeriod(p, btn) {
        perfPeriod = p;
        document.querySelectorAll('.perf-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
            b.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        // If btn not passed, find it by text
        if (!btn) {
            document.querySelectorAll('.perf-btn').forEach(b => {
                if (b.textContent.trim() === p) btn = b;
            });
        }
        if (btn) {
            btn.style.background = 'rgba(212,168,75,0.15)';
            btn.style.color = 'var(--v-gold)';
            btn.style.borderColor = 'var(--v-gold)';
        }
        drawPerfChart();
    }

    function drawPerfChart() {
        const canvas = document.getElementById('perfChart');
        if (!canvas) return;
        const wrap = document.getElementById('perfChartWrap');
        if (!wrap) return;

        // Filter by period
        const now = Date.now();
        const cutoffs = { '1D': 86400000, '5D': 5*86400000, '1M': 30*86400000, '6M': 182*86400000, '1Y': 365*86400000 };
        const cutoff = now - (cutoffs[perfPeriod] || cutoffs['1D']);
        let data = perfHistory.filter(p => p.ts >= cutoff);

        // Seed simulated history if not enough real points
        if (data.length < 3) {
            const cutMs = cutoffs[perfPeriod] || 86400000;
            const pts = perfPeriod === '1D' ? 24 : perfPeriod === '5D' ? 30 : perfPeriod === '1M' ? 30 : perfPeriod === '6M' ? 26 : 52;
            const interval = cutMs / pts;
            const startVal = 100000;
            const endVal = cash + Object.keys(portfolio).reduce((s,sym) => { const st=getStockBySymbol(sym); return s+(st?st.price*portfolio[sym]:0); }, 0);
            // Merge with real data
            const seed2 = (currentUser?.username||'x').charCodeAt(0);
            let v = startVal;
            const generated = [];
            for (let i = 0; i <= pts; i++) {
                const t = now - cutMs + i * interval;
                // only add if no real point nearby
                const hasReal = perfHistory.some(p => Math.abs(p.ts - t) < interval * 0.8);
                if (!hasReal) {
                    const drift = (Math.sin(i * 0.7 + seed2) * 0.008) + ((endVal - startVal) / startVal / pts);
                    v = Math.max(50000, v * (1 + drift));
                    generated.push({ ts: t, value: v });
                }
            }
            // Force the last real point to match current equity
            generated.push({ ts: now, value: endVal });
            // Merge and sort
            data = [...perfHistory.filter(p => p.ts >= now - cutMs), ...generated]
                .sort((a, b) => a.ts - b.ts);
        }

        const W = wrap.clientWidth || 260;
        const H = 150;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = W * dpr; canvas.height = H * dpr;
        canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const vals = data.map(d => d.value);
        const minV = Math.min(...vals) * 0.998;
        const maxV = Math.max(...vals) * 1.002;
        const toX = i => (i / (data.length - 1)) * W;
        const toY = v => H - ((v - minV) / (maxV - minV || 1)) * (H - 20) - 10;

        const isPos = data[data.length - 1].value >= data[0].value;
        const lineColor = isPos ? '#4ade80' : '#f87171';
        const fillColor = isPos ? 'rgba(74,222,128,0.12)' : 'rgba(248,113,113,0.12)';

        // Baseline at 100k
        const baseY = toY(100000);
        ctx.beginPath();
        ctx.setLineDash([4, 4]);
        ctx.moveTo(0, baseY); ctx.lineTo(W, baseY);
        ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 1; ctx.stroke();
        ctx.setLineDash([]);

        // Fill
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(data[0].value));
        data.forEach((d, i) => ctx.lineTo(toX(i), toY(d.value)));
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
        ctx.fillStyle = fillColor; ctx.fill();

        // Line
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(data[0].value));
        data.forEach((d, i) => ctx.lineTo(toX(i), toY(d.value)));
        ctx.strokeStyle = lineColor; ctx.lineWidth = 2; ctx.stroke();

        // Current value label
        const cur = data[data.length - 1].value;
        const pct = ((cur - 100000) / 100000 * 100).toFixed(2);
        ctx.font = `bold ${11 * dpr / dpr}px DM Sans, sans-serif`;
        ctx.fillStyle = lineColor;
        ctx.fillText(`${isPos ? '+' : ''}${pct}%`, 4, 14);

        if (perfChart) { try { perfChart.destroy(); } catch(e){} perfChart = null; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: PAPER TRADING JOURNAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let journalPendingTx = null;
    let tradeJournal = {}; // { symbol: [{ ts, side, qty, price, note }] }

    function openJournal(tx) {
        journalPendingTx = tx;
        const modal = document.getElementById('journalModal');
        const info = document.getElementById('journalTradeInfo');
        const note = document.getElementById('journalNote');
        info.textContent = `${tx.side} ${tx.qty}Ã— ${tx.symbol} @ $${tx.price.toFixed(2)}`;
        // Pre-fill with previous note if any
        const prev = (tradeJournal[tx.symbol] || []).slice(-1)[0];
        note.value = prev ? prev.note : '';
        note.placeholder = tx.side === 'BUY'
            ? 'Why are you buying? What\'s your target price? Time horizon?'
            : 'Why selling? Taking profit or cutting loss?';
        modal.classList.add('open');
        setTimeout(() => note.focus(), 100);
    }

    function saveJournalNote() {
        if (!journalPendingTx) { closeJournal(); return; }
        const note = document.getElementById('journalNote').value.trim();
        const tx = journalPendingTx;
        if (!tradeJournal[tx.symbol]) tradeJournal[tx.symbol] = [];
        tradeJournal[tx.symbol].push({ ts: tx.ts || Date.now(), side: tx.side, qty: tx.qty, price: tx.price, note });
        if (currentUser) currentUser.tradeJournal = tradeJournal;
        closeJournal();
        renderHistory(); // refresh to show note indicator
        if (tx.symbol === detailStock?.symbol) renderStockJournalNote(tx.symbol);
    }

    function closeJournal() {
        document.getElementById('journalModal').classList.remove('open');
        journalPendingTx = null;
    }

    function renderStockJournalNote(symbol) {
        const wrap = document.getElementById('stockJournalNote');
        const txt = document.getElementById('stockJournalText');
        if (!wrap || !txt) return;
        const entries = (tradeJournal[symbol] || []).slice(-3);
        if (!entries.length) { wrap.style.display = 'none'; return; }
        wrap.style.display = 'block';
        txt.innerHTML = entries.map(e => {
            const d = new Date(e.ts).toLocaleDateString([], { month:'short', day:'numeric' });
            return `<div style="margin-bottom:6px;"><span style="font-size:10px;color:${e.side==='BUY'?'#4ade80':'#f87171'};font-weight:700;">${e.side} ${d}</span><br>${e.note || '<em style="color:#606080;">No note</em>'}</div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: STOCK DETAIL ENRICHMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderAnalystRatings(stock) {
        const el = document.getElementById('analystRatings');
        if (!el) return;
        // Generate deterministic simulated ratings from stock data
        const seed = stock.symbol.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        const rng = (min, max) => { const x = Math.sin(seed * 9301 + 49297) * 233280; return Math.floor((x - Math.floor(x)) * (max - min + 1)) + min; };
        const buy = rng(35, 70), hold = rng(15, 35), sell = 100 - buy - Math.min(hold, 100 - buy);
        const total = buy + hold + Math.max(0, sell);
        const consensus = buy > 55 ? 'Strong Buy' : buy > 40 ? 'Buy' : buy > 30 ? 'Hold' : 'Underperform';
        const consColor = buy > 55 ? '#4ade80' : buy > 40 ? '#a3e635' : buy > 30 ? '#facc15' : '#f87171';
        const targetSeed = (seed % 30) / 100;
        const target = (stock.price * (1 + targetSeed + 0.05)).toFixed(2);
        const upside = ((target - stock.price) / stock.price * 100).toFixed(1);

        el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <div style="font-size:1.1rem;font-weight:700;color:${consColor};">${consensus}</div>
                    <div style="font-size:11px;color:#8888a8;">Based on ${rng(12,40)} analysts</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:13px;color:#f0f0fa;font-weight:600;">Target: $${target}</div>
                    <div style="font-size:11px;color:${upside >= 0 ? '#4ade80' : '#f87171'};">${upside >= 0 ? '+' : ''}${upside}% upside</div>
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;">
                ${[['Buy', buy, '#4ade80'], ['Hold', hold, '#facc15'], ['Sell', Math.max(0,sell), '#f87171']].map(([label, pct, color]) => `
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="width:40px;font-size:11px;color:#8888a8;">${label}</div>
                    <div class="analyst-bar" style="flex:1;"><div class="analyst-fill" style="width:${pct}%;background:${color};"></div></div>
                    <div style="width:32px;font-size:11px;font-weight:700;color:#c0c0d8;text-align:right;">${pct}%</div>
                </div>`).join('')}
            </div>`;
    }

    function renderEarnings(stock) {
        const el = document.getElementById('earningsData');
        if (!el) return;
        const seed = stock.symbol.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        const quarters = ['Q1 2025','Q4 2024','Q3 2024','Q2 2024'];
        el.innerHTML = quarters.map((q, i) => {
            const base = stock.price * (0.04 + (seed % 7) * 0.01);
            const est = (base + i * 0.02).toFixed(2);
            const beat = (seed + i) % 3 !== 0;
            const actual = beat ? (parseFloat(est) + Math.random() * 0.15).toFixed(2) : (parseFloat(est) - Math.random() * 0.08).toFixed(2);
            const diff = ((actual - est) / est * 100).toFixed(1);
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px;">
                <div style="font-size:11px;color:#8888a8;margin-bottom:4px;">${q}</div>
                <div style="font-size:13px;font-weight:700;color:#f0f0fa;">$${actual} <span style="font-size:10px;color:${beat?'#4ade80':'#f87171'};font-weight:600;">${beat?'BEAT':'MISS'} ${diff}%</span></div>
                <div style="font-size:11px;color:#606080;">Est. $${est}</div>
            </div>`;
        }).join('');
    }

    function renderSimilarStocks(stock) {
        const el = document.getElementById('similarStocks');
        if (!el) return;
        const sector = stock.sector || inferSector(stock.symbol, stock.name);
        const similar = stocks.filter(s => s.symbol !== stock.symbol && inferSector(s.symbol, s.name) === sector).slice(0, 6);
        if (!similar.length) { el.innerHTML = '<div style="color:#8888a8;font-size:13px;">No similar stocks found.</div>'; return; }
        el.innerHTML = similar.map(s => {
            const pos = s.change >= 0;
            return `<button onclick="openStockDetail(getStockBySymbol('${s.symbol}'))" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:8px 12px;cursor:pointer;text-align:left;transition:border-color 0.2s;" onmouseover="this.style.borderColor='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)'">
                <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${s.symbol}</div>
                <div style="font-size:11px;color:${pos?'#4ade80':'#f87171'};font-family:var(--v-mono);">${pos?'+':''}${s.change.toFixed(2)}%</div>
            </button>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: SHAREABLE PORTFOLIO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sharePortfolio() {
        if (!currentUser) return;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym); return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const total = cash + portfolioValue;
        const pl = total - 100000;
        const plPct = (pl / 100000 * 100).toFixed(2);
        const holdings = Object.keys(portfolio).slice(0, 5).map(sym => {
            const s = getStockBySymbol(sym);
            return s ? `${sym} Ã—${portfolio[sym]}` : sym;
        }).join(', ');

        const shareText = `ğŸ“Š My Vestra Portfolio\nğŸ‘¤ ${currentUser.displayName}\nğŸ’° $${total.toLocaleString(undefined,{maximumFractionDigits:0})} total equity\n${pl >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${pl >= 0 ? '+' : ''}$${Math.abs(pl).toLocaleString(undefined,{maximumFractionDigits:0})} (${pl >= 0 ? '+' : ''}${plPct}%)\nğŸ¦ Holdings: ${holdings || 'None yet'}\n\nTry Vestra â€” risk-free trading!`;

        if (navigator.share) {
            navigator.share({ title: 'My Vestra Portfolio', text: shareText }).catch(() => {});
        } else {
            navigator.clipboard.writeText(shareText).then(() => {
                showTradeToast('INFO', 0, 'Portfolio stats copied to clipboard!', 0, false);
            }).catch(() => {
                // fallback: show in a prompt
                prompt('Copy your portfolio summary:', shareText);
            });
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: MOBILE TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function mobileTab(tab) {
        document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mn' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');

        const grid = document.querySelector('#grid')?.parentElement;
        const sidebar = document.getElementById('desktopSidebar');
        const mobPortfolio = document.getElementById('mobilePortfolioView');
        const searchWrap = document.getElementById('searchWrap');

        if (tab === 'market') {
            if (grid) grid.style.display = '';
            if (mobPortfolio) mobPortfolio.style.display = 'none';
        } else if (tab === 'portfolio') {
            if (grid) grid.style.display = 'none';
            if (mobPortfolio) {
                mobPortfolio.style.display = 'block';
                renderMobilePortfolio();
            }
        } else if (tab === 'search') {
            if (grid) grid.style.display = '';
            const inp = document.getElementById('search');
            if (inp) { inp.focus(); }
        } else if (tab === 'profile') {
            if (grid) grid.style.display = 'none';
            if (mobPortfolio) {
                mobPortfolio.style.display = 'block';
                mobPortfolio.innerHTML = `<div style="padding:20px 0;">
                    <div style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin-bottom:4px;">${currentUser?.displayName || 'â€”'}</div>
                    <div style="font-size:13px;color:#8888a8;margin-bottom:20px;">@${currentUser?.username || 'â€”'}</div>
                    <button onclick="sharePortfolio()" style="width:100%;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);color:var(--v-gold);padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">ğŸ”— Share Portfolio</button>
                    <button onclick="openApiConfig()" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#c0c0d8;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">âš¡ Live Data Settings</button>
                    <button onclick="toggleTheme()" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#c0c0d8;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">ğŸŒ™ Toggle Theme</button>
                    <button onclick="logOut()" style="width:100%;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;">Sign Out</button>
                </div>`;
            }
        }
    }

    function renderMobilePortfolio() {
        const el = document.getElementById('mobilePortfolioView');
        if (!el) return;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym); return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const total = cash + portfolioValue;
        const pl = total - 100000;
        const plPct = (pl / 100000 * 100).toFixed(2);
        const plColor = pl >= 0 ? '#4ade80' : '#f87171';
        let holdingsHtml = '<div style="color:#8888a8;font-size:13px;padding:16px 0;">No holdings yet.</div>';
        if (Object.keys(portfolio).length) {
            holdingsHtml = Object.keys(portfolio).map(sym => {
                const s = getStockBySymbol(sym);
                if (!s) return '';
                const val = s.price * portfolio[sym];
                const pos = s.change >= 0;
                return `<div onclick="openStockDetail(getStockBySymbol('${sym}'))" style="display:flex;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;">
                    <div><div style="font-weight:700;color:#e8e8f5;">${sym}</div><div style="font-size:11px;color:#8888a8;">${portfolio[sym]} shares</div></div>
                    <div style="text-align:right;"><div style="font-family:var(--v-mono);color:#f0f0fa;">$${val.toFixed(2)}</div><div style="font-size:11px;color:${pos?'#4ade80':'#f87171'};">${pos?'+':''}${s.change.toFixed(2)}% today</div></div>
                </div>`;
            }).join('');
        }
        el.innerHTML = `<div style="margin-bottom:20px;">
            <div style="font-size:11px;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Total Equity</div>
            <div style="font-size:2.2rem;font-weight:300;color:#f5f5fa;font-family:var(--v-mono);">$${total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
            <div style="font-size:1rem;font-weight:600;color:${plColor};">${pl>=0?'+':''}$${Math.abs(pl).toFixed(2)} (${pl>=0?'+':''}${plPct}%)</div>
        </div>
        <div style="font-size:0.9rem;font-weight:600;color:#e0e0f5;margin-bottom:8px;">Holdings</div>
        ${holdingsHtml}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HOOK: Patch processAlerts to fire notifications
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function processAlerts() {
        let fired = false;
        priceAlerts.forEach(a => {
            if (a.triggered) return;
            const st = getStockBySymbol(a.symbol);
            if (!st) return;
            const cond = (a.type === 'above' && st.price >= a.value)
                || (a.type === 'below' && st.price <= a.value)
                || (a.type === 'move' && Math.abs(st.change) >= a.value);
            if (cond) {
                a.triggered = true;
                alertEvents.unshift(`Alert: ${a.symbol} ${a.type} $${a.value} â†’ $${st.price.toFixed(2)}`);
                alertEvents = alertEvents.slice(0, 8);
                fireAlertNotification(a.symbol, a.type, a.value, st.price);
                fired = true;
            }
        });
        if (fired) { renderAlerts(); saveUserData(false); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HOOK: Patch execDetailTrade to open journal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Update market status every minute
    setInterval(updateMarketStatus, 60000);

    // â•â•â• END REAL-TIME DATA ENGINE â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   HOMEPAGE LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showHomepage() {
        document.getElementById('homePage').style.display = 'block';
        document.getElementById('appPage').style.display  = 'none';
        document.getElementById('authOverlay').style.display = 'none';
        drawHeroChart();
        initTicker();
    }

    function showApp() {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('appPage').style.display  = 'block';
        document.getElementById('authOverlay').style.display = 'none';
    }

    function showAuthFromHome(mode) {
        authMode = mode;
        const isRegister = mode === 'register';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isRegister);
        document.getElementById('authTitle').textContent    = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authSubtitle').textContent = isRegister ? 'Join Vestra â€” it\'s free' : 'to your trading account';
        document.getElementById('authSubmitBtn').textContent = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').textContent = isRegister ? 'Already have an account?' : 'Don\'t have an account?';
        document.getElementById('authToggleBtn').textContent  = isRegister ? 'Sign in' : 'Create account';
        document.getElementById('authOverlay').style.display = 'flex';
    }

    function scrollToSection(id) {
        document.getElementById(id)?.scrollIntoView({ behavior: 'smooth' });
    }

    function drawHeroChart() {
        const canvas = document.getElementById('heroChart');
        if (!canvas) return;
        const W = canvas.parentElement.clientWidth - 48;
        const H = 140;
        const dpr = window.devicePixelRatio || 1;
        canvas.width  = W * dpr;
        canvas.height = H * dpr;
        canvas.style.width  = W + 'px';
        canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const pts = 80;
        const values = [];
        let v = 180;
        for (let i = 0; i < pts; i++) { v += (Math.random() - 0.42) * 4; values.push(Math.max(140, v)); }
        const min = Math.min(...values), max = Math.max(...values);
        const toX = i => (i / (pts - 1)) * W;
        const toY = v => H - ((v - min) / (max - min + 1)) * (H - 16) - 8;

        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, 'rgba(201,168,76,0.25)');
        grad.addColorStop(1, 'rgba(201,168,76,0)');
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
        ctx.fillStyle = grad; ctx.fill();

        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.strokeStyle = '#c9a84c'; ctx.lineWidth = 2; ctx.stroke();

        let base = 214.37;
        setInterval(() => {
            base += (Math.random() - 0.48) * 0.5;
            const el = document.getElementById('heroPrice');
            const ch = document.getElementById('heroChange');
            if (el) el.textContent = '$' + base.toFixed(2);
            if (ch) {
                const pct = ((base - 211.74) / 211.74 * 100).toFixed(2);
                ch.textContent = (pct >= 0 ? '+' : '') + pct + '%';
                ch.style.color = pct >= 0 ? '#4ade80' : '#f87171';
            }
        }, 2000);
    }

    function initTicker() {
        const items = ['AAPL $214.37 +1.2%','TSLA $248.12 +0.8%','MSFT $415.23 +0.5%','NVDA $138.42 +3.1%','AMZN $224.18 -0.3%','META $612.45 +1.7%','GOOGL $198.23 +0.4%','JPM $281.43 +0.9%','V $341.27 +0.6%','WMT $98.45 +1.1%','XOM $112.34 +0.7%','HD $387.12 +0.8%'];
        const html = items.map(t => {
            const pos = t.includes('+');
            return `<span style="display:inline-block;padding:0 32px;font-family:var(--v-mono);font-size:0.8rem;color:${pos?'#4ade80':'#f87171'};">${t}</span>`;
        }).join('');
        ['tickerInner','tickerInner2'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
    }




    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   ORDER TYPE HINT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateOrderTypeHint(sel) {
        const hints = {
            market: 'Executes immediately at current market price.',
            limit: 'Fills only at your specified price or better.',
            'stop-loss': 'Sells automatically if price drops to trigger.',
            'take-profit': 'Sells automatically when price hits your target.',
            gtt: 'Good-Till-Triggered: persists until price condition is met.'
        };
        // Show toast-style hint
        showTradeToast('INFO', 0, hints[sel.value] || '', 0, false);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   STOCK SCREENER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openScreener() { document.getElementById('screenerModal').style.display='block'; }
    function closeScreener() { document.getElementById('screenerModal').style.display='none'; }

    function runScreener() {
        const sector = document.getElementById('scSector').value;
        const change = document.getElementById('scChange').value;
        const price  = document.getElementById('scPrice').value;
        const pe     = document.getElementById('scPE').value;
        const res    = document.getElementById('screenerResults');

        let filtered = stocks.slice();
        if (sector)  filtered = filtered.filter(s => s.sector === sector);
        if (change === 'up5')   filtered = filtered.filter(s => s.change > 5);
        else if (change === 'up2')   filtered = filtered.filter(s => s.change > 2);
        else if (change === 'down2') filtered = filtered.filter(s => s.change < -2);
        else if (change === 'down5') filtered = filtered.filter(s => s.change < -5);
        else if (change === 'flat')  filtered = filtered.filter(s => Math.abs(s.change) <= 1);
        if (price === '0-50')   filtered = filtered.filter(s => s.price < 50);
        else if (price === '50-200')  filtered = filtered.filter(s => s.price >= 50 && s.price < 200);
        else if (price === '200-500') filtered = filtered.filter(s => s.price >= 200 && s.price < 500);
        else if (price === '500+')    filtered = filtered.filter(s => s.price >= 500);
        if (pe === 'low')  filtered = filtered.filter(s => s.pe > 0 && s.pe < 15);
        else if (pe === 'mid')  filtered = filtered.filter(s => s.pe >= 15 && s.pe <= 35);
        else if (pe === 'high') filtered = filtered.filter(s => s.pe > 35);
        else if (pe === 'neg')  filtered = filtered.filter(s => s.pe < 0);

        filtered = filtered.slice(0, 100);
        if (filtered.length === 0) {
            res.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;font-size:13px;">No stocks match these criteria.</div>';
            return;
        }

        res.innerHTML = `
            <div style="font-size:11px;color:#6868a0;margin-bottom:10px;">${filtered.length} results</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;">
                ${filtered.map(s => {
                    const isPos = s.change >= 0;
                    return `<div onclick="closeScreener();openStockDetail(getStockBySymbol('${s.symbol}'))" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;cursor:pointer;transition:border-color 0.2s;" onmouseover="this.style.borderColor='rgba(212,168,75,0.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.07)'">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
                            <div>
                                <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${s.symbol}</div>
                                <div style="font-size:10px;color:#6868a0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:110px;">${s.name}</div>
                            </div>
                            <span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;${isPos?'background:rgba(34,197,94,0.12);color:#4ade80':'background:rgba(239,68,68,0.12);color:#f87171'}">${isPos?'+':''}${s.change.toFixed(2)}%</span>
                        </div>
                        <div style="font-family:var(--v-mono);font-size:1.1rem;color:#f0f0fa;">$${s.price.toFixed(2)}</div>
                        <div style="font-size:9px;color:#6868a0;margin-top:3px;">P/E: ${s.pe>0?s.pe.toFixed(1):'â€”'} Â· ${s.sector||'â€”'}</div>
                    </div>`;
                }).join('')}
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   ECONOMIC CALENDAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openCalendar() {
        document.getElementById('calendarModal').style.display = 'block';
        renderCalendar();
    }
    function closeCalendar() { document.getElementById('calendarModal').style.display='none'; }

    function renderCalendar() {
        const el = document.getElementById('calendarContent');
        const now = Date.now();
        const day = 86400000;
        const events = [
            { ts: now + 1*day,  type:'fed',      impact:'high',   title:'FOMC Meeting Minutes',            detail:'Federal Reserve publishes meeting minutes. Watch for rate guidance language.' },
            { ts: now + 2*day,  type:'earnings', impact:'high',   title:'NVDA Earnings Report Q4 2025',    detail:'NVIDIA Q4 earnings. Analysts expect EPS of $0.84 on revenue of $38.0B.' },
            { ts: now + 3*day,  type:'data',     impact:'medium', title:'US CPI Inflation Data',           detail:'Consumer Price Index for January. Core CPI expected at 3.1% YoY.' },
            { ts: now + 4*day,  type:'earnings', impact:'high',   title:'AAPL Earnings Report Q1 2026',    detail:'Apple Q1 FY2026 results. iPhone 17 cycle in focus. EPS est. $2.26.' },
            { ts: now + 5*day,  type:'data',     impact:'high',   title:'US Non-Farm Payrolls',            detail:'January jobs report. Consensus forecast: +195K jobs, unemployment 4.1%.' },
            { ts: now + 6*day,  type:'earnings', impact:'medium', title:'MSFT Earnings Report Q2 FY26',    detail:'Microsoft Q2 FY2026. Azure cloud growth in focus. EPS est. $3.12.' },
            { ts: now + 8*day,  type:'fed',      impact:'high',   title:'Fed Chair Powell Speech',         detail:'Jerome Powell speaks at the Economic Club of New York on monetary policy outlook.' },
            { ts: now + 9*day,  type:'data',     impact:'medium', title:'US Retail Sales MoM',             detail:'January retail sales data. Previous: +0.4%. Consensus: +0.3%.' },
            { ts: now + 11*day, type:'earnings', impact:'high',   title:'GOOGL Earnings Report Q4 2025',   detail:'Alphabet Q4 results. AI-driven search monetization and cloud revenue in focus.' },
            { ts: now + 12*day, type:'data',     impact:'high',   title:'Fed Rate Decision',               detail:'FOMC rate decision. Markets pricing 88% probability of hold at 4.25â€“4.50%.' },
            { ts: now + 14*day, type:'earnings', impact:'medium', title:'META Earnings Report Q4 2025',    detail:'Meta Q4 2025 results. AI advertising tools and Reality Labs losses in focus.' },
            { ts: now + 18*day, type:'data',     impact:'medium', title:'US GDP Q4 2025 Preliminary',      detail:'Q4 GDP growth estimate. Previous: +2.8% annualized. Est: +2.5%.' },
        ];
        const typeColor = { fed:'rgba(139,92,246,0.12)', earnings:'rgba(212,168,75,0.10)', data:'rgba(34,197,94,0.08)' };
        const typeText  = { fed:'#a78bfa', earnings:'var(--v-gold)', data:'#4ade80' };
        const typeLabel = { fed:'ğŸ¦ Fed', earnings:'ğŸ“Š Earnings', data:'ğŸ“ˆ Economic' };
        const impactDot = { high:'#ef4444', medium:'var(--v-gold)', low:'#4ade80' };

        el.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;">
            ${events.map(ev => {
                const d = new Date(ev.ts);
                const dateStr = d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
                return `<div style="background:${typeColor[ev.type]};border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
                    <div style="width:52px;flex-shrink:0;text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;font-weight:700;">${d.toLocaleDateString([],{month:'short'})}</div>
                        <div style="font-family:var(--v-mono);font-size:1.3rem;color:#f0f0fa;line-height:1;">${d.getDate()}</div>
                        <div style="font-size:9px;color:#6868a0;">${d.toLocaleDateString([],{weekday:'short'})}</div>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                            <span style="font-size:9px;font-weight:700;color:${typeText[ev.type]};text-transform:uppercase;letter-spacing:0.05em;">${typeLabel[ev.type]}</span>
                            <span style="width:5px;height:5px;border-radius:50%;background:${impactDot[ev.impact]};flex-shrink:0;"></span>
                            <span style="font-size:9px;color:#6868a0;text-transform:capitalize;">${ev.impact} impact</span>
                        </div>
                        <div style="font-weight:600;color:#e0e0f5;font-size:0.875rem;margin-bottom:3px;">${ev.title}</div>
                        <div style="font-size:11px;color:#8888a8;line-height:1.5;">${ev.detail}</div>
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   COMMUNITY / SOCIAL TRADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const communityPosts = [
        { user:'TradingWolf', avatar:'TW', ts: Date.now()-3600000,  text:'Watching $NVDA closely â€” the AI datacenter narrative is still strong. Buying dips under $175. ğŸ¯', likes:12, sym:'NVDA' },
        { user:'BullRunner99', avatar:'BR', ts: Date.now()-7200000,  text:'$AAPL looking bearish short-term after the iPhone 17 leak disappointment. Set a stop at $248. ğŸ“‰', likes:8, sym:'AAPL' },
        { user:'QuantEdge',    avatar:'QE', ts: Date.now()-14400000, text:'RSI on $META just hit oversold territory (28). Historically this has been a great entry. Long here. ğŸ”¥', likes:19, sym:'META' },
        { user:'ValueHunter',  avatar:'VH', ts: Date.now()-21600000, text:'$JPM P/E at 14x with 2.4% dividend yield â€” classic value. Adding to position today. ğŸ¦', likes:6, sym:'JPM' },
        { user:'SwingKing',    avatar:'SK', ts: Date.now()-43200000, text:'Fed minutes tomorrow could be a catalyst. $SPY calls cheap right now. Risk/reward looks good. âš¡', likes:23, sym:'SPY' },
    ];

    function openCommunity() {
        document.getElementById('communityModal').style.display = 'block';
        const av = document.getElementById('communityAvatar');
        if (av && currentUser) { av.textContent = (currentUser.displayName||currentUser.username||'?')[0].toUpperCase(); }
        renderCommunityFeed();
    }
    function closeCommunity() { document.getElementById('communityModal').style.display='none'; }

    function renderCommunityFeed() {
        const feed = document.getElementById('communityFeed');
        if (!feed) return;
        feed.innerHTML = communityPosts.slice().sort((a,b)=>b.ts-a.ts).map((p, idx) => {
            const rel = relativeTime(p.ts);
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <div style="width:28px;height:28px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:11px;font-weight:700;flex-shrink:0;">${p.avatar}</div>
                    <div>
                        <div style="font-weight:700;color:#e0e0f5;font-size:12px;">${p.user}</div>
                        <div style="font-size:10px;color:#6868a0;">${rel}</div>
                    </div>
                    ${p.sym ? `<span onclick="closeCommunity();openStockDetail(getStockBySymbol('${p.sym}'))" style="margin-left:auto;font-size:9px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.2);padding:2px 7px;border-radius:4px;cursor:pointer;">$${p.sym}</span>` : ''}
                </div>
                <p style="font-size:12px;color:#c0c0d8;line-height:1.6;margin:0 0 8px;">${p.text}</p>
                <button onclick="communityLike(${idx})" style="font-size:10px;color:#6868a0;background:none;border:none;cursor:pointer;padding:0;" onmouseover="this.style.color='var(--v-gold)'" onmouseout="this.style.color='#6868a0'">â¤ï¸ ${p.likes}</button>
            </div>`;
        }).join('');
    }

    function communityLike(idx) {
        communityPosts[idx].likes++;
        renderCommunityFeed();
    }

    function postCommunityIdea() {
        const ta = document.getElementById('communityPost');
        const text = ta.value.trim();
        if (!text) return;
        const name = currentUser?.displayName || currentUser?.username || 'You';
        const initials = name.slice(0,2).toUpperCase();
        // Extract $TICKER mentions
        const syms = text.match(/\$[A-Z]{1,5}/g);
        const sym = syms ? syms[0].replace('$','') : '';
        communityPosts.unshift({ user:name, avatar:initials, ts:Date.now(), text, likes:0, sym });
        ta.value = '';
        renderCommunityFeed();
    }

    function relativeTime(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff/60000)+'m ago';
        if (diff < 86400000) return Math.floor(diff/3600000)+'h ago';
        return Math.floor(diff/86400000)+'d ago';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   EDUCATION HUB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const eduLessons = [
        { emoji:'ğŸ“Š', cat:'Basics', title:'What is a Stock?', read:'3 min', content:`A stock represents ownership in a company. When you buy a share of Apple (AAPL), you own a small piece of Apple Inc. Companies issue stock to raise money for growth, and shareholders can profit through price appreciation and dividends.<br><br><strong>Key concepts:</strong><br>â€¢ <em>Market cap</em> = share price Ã— total shares<br>â€¢ <em>P/E ratio</em> = price Ã· annual earnings per share<br>â€¢ <em>Dividend yield</em> = annual dividend Ã· share price<br><br>Vestra tip: Start by researching companies you already know and use every day.` },
        { emoji:'ğŸ“ˆ', cat:'Charting', title:'Reading Candlestick Charts', read:'5 min', content:`Candlestick charts show four data points for each time period: Open, High, Low, Close (OHLC).<br><br><strong>Green candle (bullish)</strong>: price closed higher than it opened<br><strong>Red candle (bearish)</strong>: price closed lower than it opened<br><br>The thin lines (wicks) show the highest and lowest prices hit. A long upper wick means sellers pushed price down from the high. A long lower wick means buyers stepped in at the low.<br><br>Common patterns: Doji (indecision), Hammer (reversal signal), Engulfing (trend change).` },
        { emoji:'ğŸ“‰', cat:'Charting', title:'Moving Averages Explained', read:'4 min', content:`A Moving Average (MA) smooths price data to identify trends by calculating the average closing price over N periods.<br><br><strong>SMA (Simple Moving Average)</strong>: equal weight to all periods. Common: 20-day, 50-day, 200-day.<br><strong>EMA (Exponential MA)</strong>: more weight to recent prices, reacts faster.<br><br><em>Golden Cross</em>: 50-day MA crosses above 200-day â†’ bullish signal<br><em>Death Cross</em>: 50-day MA crosses below 200-day â†’ bearish signal<br><br>Try toggling MA on in Vestra's chart to see it in action.` },
        { emoji:'âš¡', cat:'Technical', title:'RSI â€” Relative Strength Index', read:'4 min', content:`RSI measures the speed and magnitude of recent price changes to evaluate if a stock is overbought or oversold. It ranges from 0 to 100.<br><br><strong>Rules of thumb:</strong><br>â€¢ RSI above 70 â†’ potentially overbought (may pull back)<br>â€¢ RSI below 30 â†’ potentially oversold (may bounce)<br>â€¢ RSI at 50 â†’ neutral / trend confirmation<br><br>Important: RSI is a momentum indicator, not a buy/sell signal on its own. A stock can stay overbought for extended periods in a strong uptrend. Always confirm with price action.` },
        { emoji:'ğŸ¯', cat:'Strategy', title:'Position Sizing & Risk Management', read:'5 min', content:`How much you trade matters more than what you trade. Professional traders typically risk no more than 1â€“2% of their total portfolio on any single trade.<br><br><strong>Example:</strong> $100,000 portfolio Ã— 1% risk = $1,000 max loss per trade.<br>If your stop-loss is 5% below entry, your position size = $1,000 Ã· 5% = $20,000 max position.<br><br><em>Kelly Criterion</em>: advanced formula to optimize position sizing based on win rate and payoff ratio.<br><br>Vestra tip: Use stop-loss orders on every trade. Practice sizing in simulation before real money.` },
        { emoji:'ğŸ¦', cat:'Fundamentals', title:'How to Read an Earnings Report', read:'6 min', content:`Quarterly earnings reports are the most important events for individual stocks. Key metrics to watch:<br><br><strong>EPS (Earnings Per Share)</strong>: net income divided by shares outstanding. Compare to analyst consensus estimate.<br><strong>Revenue</strong>: total sales. Growth rate matters as much as the number itself.<br><strong>Guidance</strong>: management's forecast for next quarter. Often more important than actual results.<br><br>A stock can beat EPS estimates and still fall if guidance disappoints â€” this is called "sell the news." Markets are forward-looking.` },
        { emoji:'ğŸ”„', cat:'Strategy', title:'Understanding Order Types', read:'4 min', content:`<strong>Market Order</strong>: executes immediately at the best available price. Use when you need certainty of execution, not price.<br><br><strong>Limit Order</strong>: only fills at your specified price or better. Protects you from bad fills but may not execute.<br><br><strong>Stop-Loss</strong>: automatically sells if price drops to your trigger. Essential risk management tool.<br><br><strong>Take-Profit</strong>: automatically sells when your price target is hit. Locks in gains without watching the screen.<br><br><strong>GTT (Good-Till-Triggered)</strong>: like a limit order that stays active indefinitely until the condition is met.` },
    ];

    let eduFilter = 'All';

    function openEducation() {
        document.getElementById('educationModal').style.display = 'block';
        renderEducation();
    }
    function closeEducation() { document.getElementById('educationModal').style.display='none'; }

    function renderEducation(openIdx = null) {
        const el = document.getElementById('educationContent');
        if (!el) return;
        if (openIdx !== null) {
            const l = eduLessons[openIdx];
            el.innerHTML = `
                <button onclick="renderEducation()" style="font-size:12px;color:var(--v-gold);background:none;border:none;cursor:pointer;padding:0;margin-bottom:16px;">â† Back to lessons</button>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:2rem;">${l.emoji}</div>
                    <div>
                        <div style="font-size:9px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:3px;">${l.cat} Â· ${l.read} read</div>
                        <h3 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0;">${l.title}</h3>
                    </div>
                </div>
                <div style="font-size:13px;color:#c0c0d8;line-height:1.8;">${l.content}</div>`;
            return;
        }

        const cats = ['All', ...new Set(eduLessons.map(l => l.cat))];
        el.innerHTML = `
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;">
                ${cats.map(cat => `<button onclick="setEduFilter('${cat}')" id="edu-${cat}" style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:5px;cursor:pointer;border:1px solid ${cat===eduFilter?'var(--v-gold)':'rgba(255,255,255,0.1)'};background:${cat===eduFilter?'rgba(212,168,75,0.15)':'transparent'};color:${cat===eduFilter?'var(--v-gold)':'#8888a8'};">${cat}</button>`).join('')}
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;">
                ${eduLessons.map((l, i) => (eduFilter==='All'||l.cat===eduFilter) ? `
                    <div onclick="renderEducation(${i})" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;cursor:pointer;transition:border-color 0.2s;" onmouseover="this.style.borderColor='rgba(212,168,75,0.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.07)'">
                        <div style="font-size:1.8rem;margin-bottom:8px;">${l.emoji}</div>
                        <div style="font-size:9px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">${l.cat} Â· ${l.read}</div>
                        <div style="font-weight:600;color:#e0e0f5;font-size:0.875rem;">${l.title}</div>
                    </div>` : '').join('')}
            </div>`;
    }

    function setEduFilter(cat) {
        eduFilter = cat;
        renderEducation();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   AUTO-BOT RULES ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let botRules = [];

    function openBotBuilder() {
        document.getElementById('botModal').style.display = 'block';
        document.getElementById('botError').style.display = 'none';
        // Pre-fill symbol from current detail stock
        if (detailStock) document.getElementById('botSymbol').value = detailStock.symbol;
    }
    function closeBotBuilder() { document.getElementById('botModal').style.display='none'; }

    function saveBotRule() {
        const sym  = document.getElementById('botSymbol').value.trim().toUpperCase();
        const action = document.getElementById('botAction').value;
        const qty  = parseInt(document.getElementById('botQty').value);
        const cond = document.getElementById('botCondition').value;
        const trig = parseFloat(document.getElementById('botTrigger').value);
        const errEl = document.getElementById('botError');

        if (!sym || isNaN(qty) || qty < 1 || isNaN(trig)) {
            errEl.style.display='block'; errEl.textContent='Please fill in all fields with valid values.'; return;
        }
        const stock = getStockBySymbol(sym);
        if (!stock) {
            errEl.style.display='block'; errEl.textContent=`Symbol "${sym}" not found in the market.`; return;
        }
        botRules.push({ id: Date.now(), sym, action, qty, cond, trig, active: true, created: Date.now() });
        renderBotRules();
        closeBotBuilder();
        showTradeToast('INFO', qty, sym, trig, true);
    }

    function renderBotRules() {
        const el = document.getElementById('botRulesList');
        if (!el) return;
        if (botRules.length === 0) {
            el.innerHTML = '<div style="text-align:center;padding:8px 0;font-style:italic;">No auto-rules yet. Set conditions to trade automatically.</div>';
            return;
        }
        const condLabel = { above:'rises above', below:'falls below', up_pct:'gains â‰¥', down_pct:'drops â‰¥' };
        el.innerHTML = botRules.map((r, i) => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:11px;color:#c0c0d8;">
                    <span style="font-weight:700;color:${r.action==='BUY'?'#4ade80':'#f87171'}">${r.action}</span>
                    <span style="color:#e0e0f5;"> ${r.qty}Ã— ${r.sym}</span>
                    <span style="color:#8888a8;"> if price ${condLabel[r.cond]} $${r.trig}</span>
                </div>
                <button onclick="removeBotRule(${i})" style="font-size:10px;color:#8888a8;background:none;border:none;cursor:pointer;padding:0 0 0 8px;" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#8888a8'">âœ•</button>
            </div>`).join('');
    }

    function removeBotRule(idx) {
        botRules.splice(idx, 1);
        renderBotRules();
    }

    // Process bot rules on every market tick
    const _origSimulateTick = simulateMarketTick;
    simulateMarketTick = function() {
        _origSimulateTick();
        processBotRules();
    };

    function processBotRules() {
        botRules.forEach((rule, idx) => {
            if (!rule.active) return;
            const stock = getStockBySymbol(rule.sym);
            if (!stock) return;
            let triggered = false;
            if (rule.cond === 'above'    && stock.price >= rule.trig) triggered = true;
            if (rule.cond === 'below'    && stock.price <= rule.trig) triggered = true;
            if (rule.cond === 'up_pct'   && stock.change >= rule.trig) triggered = true;
            if (rule.cond === 'down_pct' && stock.change <= -Math.abs(rule.trig)) triggered = true;
            if (triggered) {
                rule.active = false; // fire once
                // Execute the trade
                const qty = rule.qty;
                const type = rule.action;
                if (type === 'BUY') {
                    const cost = stock.price * qty;
                    if (cash >= cost) {
                        cash -= cost;
                        portfolio[rule.sym] = (portfolio[rule.sym] || 0) + qty;
                        if (!costBasis[rule.sym]) costBasis[rule.sym] = [];
                        costBasis[rule.sym].push({ qty, price: stock.price });
                        transactions.unshift({ type:'BUY', symbol:rule.sym, qty, price:stock.price, ts:Date.now(), note:'ğŸ¤– Auto-rule' });
                        showTradeToast('BUY', qty, rule.sym, stock.price, false);
                        updateUI();
                        saveUserData(true);
                    }
                } else {
                    const owned = portfolio[rule.sym] || 0;
                    const sellQty = Math.min(qty, owned);
                    if (sellQty > 0) {
                        cash += stock.price * sellQty;
                        portfolio[rule.sym] -= sellQty;
                        if (portfolio[rule.sym] <= 0) delete portfolio[rule.sym];
                        const avg = avgCost(rule.sym);
                        if (currentUser) currentUser.realizedPL = (currentUser.realizedPL||0) + (stock.price-avg)*sellQty;
                        transactions.unshift({ type:'SELL', symbol:rule.sym, qty:sellQty, price:stock.price, ts:Date.now(), note:'ğŸ¤– Auto-rule' });
                        showTradeToast('SELL', sellQty, rule.sym, stock.price, false);
                        updateUI();
                        saveUserData(true);
                    }
                }
                renderBotRules();
            }
        });
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   SIP / RECURRING INVESTMENT ENGINE
    //   Supports: Stock SIP, Fractional, ETF, DRIP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   INTRADAY INTERVAL SYSTEM (Finnhub resolution mapping)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   SLIPPAGE & SPREAD SIMULATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let slippageEnabled = true;
    let spreadEnabled   = true;

    function applySlippage(price, type) {
        if (!slippageEnabled) return price;
        // 0â€“0.05% random slippage + 0.01% base spread
        const slip = price * (0.0001 + Math.random() * 0.0005);
        return type === 'BUY' ? price + slip : price - slip;
    }

    // Patch execDetailTrade to apply slippage on market orders
    const _origExecDetailTrade = execDetailTrade;
    execDetailTrade = function(type) {
        // For market orders, briefly show effective price
        const ot = document.getElementById('orderType');
        if (ot && ot.value === 'market' && detailStock && slippageEnabled) {
            const eff = applySlippage(detailStock.price, type);
            showTradeToast('INFO', 0, `Effective price: $${eff.toFixed(2)} (slippage applied)`, eff, true);
        }
        _origExecDetailTrade(type);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   RISK SCORE METER  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function calcRiskScore(stock) {
        if (!stock) return { score:50, label:'Medium', color:'var(--v-gold)' };
        const pct = Math.abs(stock.change);
        const pe  = stock.pe || 25;
        // Heuristic: volatility + P/E extremes = higher risk
        let score = 50;
        score += pct * 4;                          // daily move contribution
        if (pe > 50) score += 15;
        if (pe < 0)  score += 20;                  // unprofitable
        if (pe < 15 && pe > 0) score -= 10;        // value = lower risk
        score = Math.min(100, Math.max(0, score));
        const label = score < 30 ? 'Low' : score < 60 ? 'Medium' : score < 80 ? 'High' : 'Very High';
        const color = score < 30 ? '#4ade80' : score < 60 ? 'var(--v-gold)' : score < 80 ? '#f97316' : '#ef4444';
        return { score: Math.round(score), label, color };
    }

    function calcVolatilityMeter(stock) {
        if (!stock) return { pct:0, label:'â€”' };
        const pct = Math.abs(stock.change);
        const label = pct < 1 ? 'Low' : pct < 3 ? 'Moderate' : pct < 6 ? 'High' : 'Extreme';
        return { pct: Math.min(100, pct * 10), label };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   KEYBOARD SHORTCUTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('keydown', function(e) {
        const inInput = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName);
        if (inInput) return;
        const detail = document.getElementById('stockDetailPage');
        const isDetailOpen = detail && !detail.classList.contains('hidden');

        if (isDetailOpen) {
            if (e.key === 'b' || e.key === 'B') { e.preventDefault(); execDetailTrade('BUY'); }
            if (e.key === 's' || e.key === 'S') { e.preventDefault(); execDetailTrade('SELL'); }
            if (e.key === '1') { e.preventDefault(); const btn=document.querySelector('.ctab'); if(btn)setChartPeriod('1D',btn); }
            if (e.key === 'd' || e.key === 'D') { e.preventDefault(); const btns=document.querySelectorAll('.ctab'); btns.forEach(b=>{if(b.textContent==='1D')setChartPeriod('1D',b);}); }
            if (e.key === 'Escape') closeStockDetail();
        }

        // Keyboard shortcut hint toast
        if (e.key === '?' && !inInput) {
            showTradeToast('INFO',0,'Shortcuts: B=Buy S=Sell 1=1D D=Daily Esc=Close',0,true);
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   EARNINGS + NEWS MARKERS ON CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   RENDER RISK METER in stock detail page
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origOpenStockDetailRisk = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetailRisk(stock);
        setTimeout(() => renderRiskMeter(stock), 200);
    };

    function renderRiskMeter(stock) {
        const container = document.getElementById('analystRatings');
        if (!container) return;
        const risk = calcRiskScore(stock);
        const vol  = calcVolatilityMeter(stock);
        // Append below existing analyst content
        const existing = container.querySelector('.risk-meter-row');
        if (existing) existing.remove();
        const div = document.createElement('div');
        div.className = 'risk-meter-row';
        div.style.cssText = 'margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.07);display:grid;grid-template-columns:1fr 1fr;gap:10px;';
        div.innerHTML = `
            <div>
                <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">âš¡ Risk Score</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                        <div style="height:100%;width:${risk.score}%;background:${risk.color};border-radius:3px;transition:width 0.5s;"></div>
                    </div>
                    <span style="font-size:11px;font-weight:700;color:${risk.color};min-width:30px;">${risk.score}</span>
                </div>
                <div style="font-size:10px;color:${risk.color};margin-top:3px;">${risk.label}</div>
            </div>
            <div>
                <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ“Š Volatility</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                        <div style="height:100%;width:${vol.pct}%;background:#a78bfa;border-radius:3px;transition:width 0.5s;"></div>
                    </div>
                    <span style="font-size:11px;font-weight:700;color:#a78bfa;min-width:30px;">${Math.abs(stock.change).toFixed(1)}%</span>
                </div>
                <div style="font-size:10px;color:#a78bfa;margin-top:3px;">${vol.label} today</div>
            </div>`;
        container.appendChild(div);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   "WHY DID THIS STOCK MOVE?" BUTTON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origRenderDetailNews = renderDetailNews;
    renderDetailNews = function(symbol) {
        _origRenderDetailNews(symbol);
        // Append "Why did this move?" button if we have a change
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const dn = document.getElementById('detailNews');
        if (!dn) return;
        // Remove existing why-btn
        dn.querySelector('.why-btn-row')?.remove();
        const div = document.createElement('div');
        div.className = 'why-btn-row';
        div.style.cssText = 'margin-top:8px;';
        div.innerHTML = `<button onclick="showWhyMoved('${symbol}')" style="width:100%;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2);color:#93c5fd;font-size:11px;font-weight:700;padding:8px;border-radius:7px;cursor:pointer;" onmouseover="this.style.background='rgba(96,165,250,0.14)'" onmouseout="this.style.background='rgba(96,165,250,0.08)'">ğŸ’¡ Why did ${symbol} move today?</button>`;
        dn.appendChild(div);
    };

    function showWhyMoved(symbol) {
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const isPos = stock.change >= 0;
        const reasons = isPos ? [
            `${symbol} gained ${stock.change.toFixed(2)}% â€” possibly driven by sector rotation into ${stock.sector||'this sector'}.`,
            `Analyst upgrades or positive earnings guidance may be driving bullish momentum.`,
            `Broad market strength (S&P 500 up today) is lifting most large-caps.`,
            `Technical breakout above key resistance level â€” momentum traders following.`
        ] : [
            `${symbol} dropped ${Math.abs(stock.change).toFixed(2)}% â€” profit-taking after recent gains.`,
            `Macro headwinds: rising yields or USD strength pressuring growth stocks today.`,
            `Weak sector sentiment in ${stock.sector||'this space'} following peer earnings misses.`,
            `Risk-off environment ahead of economic data â€” investors rotating to safety.`
        ];
        const msg = reasons[Math.floor(Math.random()*reasons.length)];
        // Display as a temporary overlay card
        const dn = document.getElementById('detailNews');
        if (!dn) return;
        const existing = dn.querySelector('.why-result');
        if (existing) existing.remove();
        const d = document.createElement('div');
        d.className='why-result';
        d.style.cssText=`background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.18);border-radius:8px;padding:10px 12px;margin-top:6px;font-size:11px;color:#bfdbfe;line-height:1.6;animation:slideUp 0.3s ease-out;`;
        d.innerHTML = `<strong style="color:#93c5fd;">ğŸ’¡ Analysis:</strong> ${msg} <em style="display:block;margin-top:4px;color:#6868a0;font-size:10px;">Note: This is a simulated analysis for educational purposes.</em>`;
        dn.appendChild(d);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   PORTFOLIO ANALYTICS UPGRADES
    //   Win rate, avg hold time, Sharpe ratio, vs S&P
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function calcPortfolioStats() {
        if (!transactions || transactions.length < 2) return null;
        const sells = transactions.filter(t => t.type==='SELL');
        if (sells.length === 0) return null;
        const wins = sells.filter(t => {
            const buy = transactions.filter(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts);
            if (!buy.length) return false;
            const avgBuy = buy.reduce((s,b)=>s+b.price*b.qty,0)/buy.reduce((s,b)=>s+b.qty,0);
            return t.price > avgBuy;
        });
        const winRate = (wins.length / sells.length * 100).toFixed(1);
        // Avg hold time (ms)
        let holdTimes = [];
        sells.forEach(s => {
            const buy = transactions.filter(b=>b.type==='BUY'&&b.symbol===s.symbol&&b.ts<s.ts);
            if (buy.length) holdTimes.push(s.ts - buy[buy.length-1].ts);
        });
        const avgHold = holdTimes.length ? holdTimes.reduce((a,b)=>a+b,0)/holdTimes.length : 0;
        const avgHoldStr = avgHold > 86400000 ? (avgHold/86400000).toFixed(1)+'d' : (avgHold/3600000).toFixed(1)+'h';
        return { winRate, avgHoldStr, tradeCount:sells.length };
    }

    // Patch renderAnalytics to include stats
    const _origRenderAnalytics = renderAnalytics;
    renderAnalytics = function() {
        _origRenderAnalytics();
        const stats = calcPortfolioStats();
        const statsEl = document.getElementById('portfolioStats');
        if (!statsEl || !stats) return;
        statsEl.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);">
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Win Rate</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#4ade80;">${stats.winRate}%</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Avg Hold</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">${stats.avgHoldStr}</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Trades</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">${stats.tradeCount}</div>
                </div>
            </div>`;
        statsEl.style.display = 'block';
    };

    let sipPlans = [];       // all active plans
    let sipHistory = [];     // execution log
    let _sipIntervalId = null;

    // ETF catalogue
    const ETF_CATALOGUE = [
        { symbol:'SPY',  name:'S&P 500 ETF (SPDR)',         price:590,  expense:0.0945 },
        { symbol:'QQQ',  name:'Nasdaq-100 ETF (Invesco)',    price:500,  expense:0.20  },
        { symbol:'VTI',  name:'Total Stock Mkt ETF (Vanguard)', price:285, expense:0.03 },
        { symbol:'VOO',  name:'Vanguard S&P 500 ETF',        price:540,  expense:0.03  },
        { symbol:'IWM',  name:'Russell 2000 ETF (iShares)',  price:228,  expense:0.19  },
        { symbol:'DIA',  name:'Dow Jones ETF (SPDR)',        price:440,  expense:0.16  },
        { symbol:'GLD',  name:'Gold ETF (SPDR)',             price:250,  expense:0.40  },
        { symbol:'TLT',  name:'20yr Treasury ETF (iShares)', price:94,   expense:0.15  },
        { symbol:'ARKK', name:'ARK Innovation ETF',          price:72,   expense:0.75  },
        { symbol:'XLK',  name:'Technology Select SPDR ETF',  price:226,  expense:0.09  },
    ];

    // Interval â†’ ms multiplier (simulated â€” 1 real second = 1 simulated day)
    const SIP_INTERVAL_MS = { daily:1000*30, weekly:1000*210, biweekly:1000*420, monthly:1000*900 };

    // â”€â”€ Type descriptions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SIP_TYPE_INFO = {
        stock:      'ğŸ“ˆ <b>Stock SIP</b> â€” Buy a fixed dollar amount of a specific stock at regular intervals. You always own individual shares directly. Dollar-cost averaging helps smooth out price volatility over time.',
        fractional: 'ğŸ”¬ <b>Fractional Investing</b> â€” Invest a set dollar amount regardless of share price. Receive fractional shares (e.g. 0.38 of AAPL). Perfect for high-priced stocks like BRK.B or COST.',
        etf:        'ğŸ¦ <b>ETF Auto-Invest</b> â€” Recurring investment into a diversified ETF (S&P 500, Nasdaq, etc.). Provides instant diversification like a mutual fund SIP but with stock-like liquidity.',
        drip:       'ğŸ’° <b>DRIP (Dividend Reinvestment)</b> â€” Automatically reinvest dividends received from dividend-paying stocks back into more shares. Passive compounding with zero extra cash outlay.',
    };

    // â”€â”€ Open/close modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSIP(stock) {
        const modal = document.getElementById('sipModal');
        if (!modal) return;
        modal.style.display = 'block';
        // Pre-fill from current stock
        const sym = stock ? stock.symbol : '';
        document.getElementById('sipSymbol').value = sym;
        document.getElementById('sipAmount').value = 100;
        document.getElementById('sipFreq').value = 'weekly';
        document.getElementById('sipMaxTotal').value = '';
        document.getElementById('sipError').style.display = 'none';
        setSIPType('stock');
        updateSIPProjection();
    }
    function closeSIP() {
        const modal = document.getElementById('sipModal');
        if (modal) modal.style.display = 'none';
    }

    // â”€â”€ SIP type tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _sipCurrentType = 'stock';

    function setSIPType(type) {
        _sipCurrentType = type;
        ['stock','fractional','etf','drip'].forEach(t => {
            const btn = document.getElementById('sipTab-'+t);
            if (!btn) return;
            if (t === type) {
                btn.style.background = 'rgba(212,168,75,0.1)';
                btn.style.color      = 'var(--v-gold)';
                btn.style.borderBottom = '2px solid var(--v-gold)';
                btn.style.fontWeight = '700';
            } else {
                btn.style.background = 'transparent';
                btn.style.color      = '#8888a8';
                btn.style.borderBottom = '2px solid transparent';
                btn.style.fontWeight = '600';
            }
        });
        // Show/hide DRIP toggle
        const dripGroup = document.getElementById('sipDripToggleGroup');
        if (dripGroup) dripGroup.style.display = type === 'drip' ? 'block' : 'none';
        // Swap ETF selector
        const symGroup = document.getElementById('sipSymbolGroup');
        if (type === 'etf') {
            symGroup.innerHTML = `
                <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">ETF</label>
                <select id="sipSymbol" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;">
                    ${ETF_CATALOGUE.map(e=>`<option value="${e.symbol}">${e.symbol} â€” ${e.name}</option>`).join('')}
                </select>`;
        } else {
            symGroup.innerHTML = `
                <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Symbol</label>
                <input id="sipSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;font-family:var(--v-mono);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">`;
            if (detailStock) document.getElementById('sipSymbol').value = detailStock.symbol;
        }
        // Update label
        const amtLabel = document.getElementById('sipAmountLabel');
        if (amtLabel) amtLabel.textContent = type === 'drip' ? 'Dividend Yield est. (%)' : 'Amount ($)';
        // Show banner
        const banner = document.getElementById('sipTypeBanner');
        if (banner) banner.innerHTML = SIP_TYPE_INFO[type] || '';
        updateSIPProjection();
    }

    // â”€â”€ DCA projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSIPProjection() {
        const amount = parseFloat(document.getElementById('sipAmount')?.value || 0);
        const freq   = document.getElementById('sipFreq')?.value || 'weekly';
        const sym    = document.getElementById('sipSymbol')?.value?.trim().toUpperCase();
        const freqPerYear = { daily:252, weekly:52, biweekly:26, monthly:12 }[freq] || 52;
        const freq3m = Math.ceil(freqPerYear/4);

        const proj3m  = document.getElementById('sipProj3m');
        const proj1y  = document.getElementById('sipProj1y');
        const projSh  = document.getElementById('sipProjShares');

        if (!amount || amount <= 0) {
            if(proj3m) proj3m.textContent='â€”';
            if(proj1y) proj1y.textContent='â€”';
            if(projSh) projSh.textContent='â€”';
            return;
        }

        const total3m = amount * freq3m;
        const total1y = amount * freqPerYear;

        let price = 100;
        if (_sipCurrentType === 'etf') {
            const etf = ETF_CATALOGUE.find(e=>e.symbol===sym);
            if (etf) price = etf.price;
        } else {
            const stock = sym ? getStockBySymbol(sym) : null;
            if (stock) price = stock.price;
        }

        const shares1y = total1y / price;

        if(proj3m) proj3m.textContent = '$'+total3m.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
        if(proj1y) proj1y.textContent = '$'+total1y.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
        if(projSh) projSh.textContent = shares1y < 1 ? shares1y.toFixed(4) : shares1y.toFixed(2);
    }

    // Attach live update to amount/freq inputs
    setTimeout(()=>{
        ['sipAmount','sipFreq'].forEach(id=>{
            const el=document.getElementById(id);
            if(el) el.addEventListener('input', updateSIPProjection);
            if(el) el.addEventListener('change',updateSIPProjection);
        });
    }, 1000);

    // â”€â”€ Save a new SIP plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveSIPPlan() {
        const errEl  = document.getElementById('sipError');
        errEl.style.display = 'none';
        const sym    = (document.getElementById('sipSymbol')?.value || '').trim().toUpperCase();
        const amount = parseFloat(document.getElementById('sipAmount')?.value);
        const freq   = document.getElementById('sipFreq')?.value;
        const maxTot = parseFloat(document.getElementById('sipMaxTotal')?.value) || Infinity;
        const dripOn = document.getElementById('sipDripEnabled')?.checked ?? true;

        if (!sym) { errEl.textContent='Enter a symbol.'; errEl.style.display='block'; return; }
        if (_sipCurrentType !== 'drip' && (!amount || amount < 1)) {
            errEl.textContent='Enter a valid dollar amount (min $1).'; errEl.style.display='block'; return;
        }

        // Validate symbol
        let stockRef = null;
        if (_sipCurrentType === 'etf') {
            const etf = ETF_CATALOGUE.find(e=>e.symbol===sym);
            if (!etf) { errEl.textContent='ETF not found in our catalogue.'; errEl.style.display='block'; return; }
            // Add ETF as a simulated stock if needed
            if (!getStockBySymbol(sym)) {
                stocks.push({ symbol:sym, name:etf.name, price:etf.price, change:0.1, pe:20, mktCap:'â€”', div:'0.00%', divAmt:0, wkHigh:etf.price*1.2, wkLow:etf.price*0.8, sector:'ETF' });
            }
            stockRef = getStockBySymbol(sym);
        } else if (_sipCurrentType === 'drip') {
            stockRef = getStockBySymbol(sym);
            if (!stockRef) { errEl.textContent=`Symbol "${sym}" not found.`; errEl.style.display='block'; return; }
            if (!stockRef.divAmt || stockRef.divAmt <= 0) {
                errEl.textContent=`${sym} doesn't pay a dividend. DRIP requires a dividend-paying stock.`;
                errEl.style.display='block'; return;
            }
        } else {
            stockRef = getStockBySymbol(sym);
            if (!stockRef) { errEl.textContent=`Symbol "${sym}" not found. Use the screener to find valid tickers.`; errEl.style.display='block'; return; }
        }

        const plan = {
            id: 'sip_'+Date.now(),
            type: _sipCurrentType,
            sym, amount, freq, maxTotal: maxTot,
            dripOn, active: true,
            totalInvested: 0, execCount: 0,
            created: Date.now(),
            nextExec: Date.now() + (SIP_INTERVAL_MS[freq] || 30000),
        };

        sipPlans.push(plan);
        renderSIPDetailPanel(sym);
        renderSIPSidebarWidget();
        closeSIP();
        showTradeToast('INFO', 0, `ğŸ“… SIP Plan: ${sym} ${freq} $${amount}`, 0, false);
        startSIPEngine();
    }

    // â”€â”€ Render SIP panel on stock detail page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSIPDetailPanel(sym) {
        const listEl = document.getElementById('sipDetailList');
        if (!listEl) return;
        const plans = sipPlans.filter(p=>p.sym===sym&&p.active);
        if (plans.length === 0) {
            listEl.innerHTML = '<div style="text-align:center;padding:6px 0;font-style:italic;color:#6868a0;">No active SIP plans for this stock.</div>';
            return;
        }
        const freqLabel = { daily:'Daily', weekly:'Weekly', biweekly:'Bi-weekly', monthly:'Monthly' };
        const typeEmoji = { stock:'ğŸ“ˆ', fractional:'ğŸ”¬', etf:'ğŸ¦', drip:'ğŸ’°' };
        listEl.innerHTML = plans.map(p => {
            const totalSpent = p.totalInvested;
            const stock = getStockBySymbol(p.sym);
            const currentVal = stock ? (totalSpent / (stock.price || 1)) * stock.price : totalSpent;
            const roi = totalSpent > 0 ? ((currentVal-totalSpent)/totalSpent*100).toFixed(1) : '0.0';
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-size:11px;font-weight:700;color:#e0e0f5;">${typeEmoji[p.type]||''} ${freqLabel[p.freq]||p.freq} Â· $${p.amount}</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Invested: $${p.totalInvested.toFixed(2)} Â· ${p.execCount} executions</div>
                </div>
                <button onclick="cancelSIPPlan('${p.id}')" style="font-size:10px;color:#8888a8;background:none;border:1px solid rgba(255,255,255,0.08);padding:3px 8px;border-radius:5px;cursor:pointer;" onmouseover="this.style.color='#f87171';this.style.borderColor='rgba(239,68,68,0.3)'" onmouseout="this.style.color='#8888a8';this.style.borderColor='rgba(255,255,255,0.08)'">Cancel</button>
            </div>`;
        }).join('');
        // Update DCA stats
        const statsEl = document.getElementById('sipDcaStats');
        if (statsEl) statsEl.style.display = plans.length > 0 ? 'grid' : 'none';
        const stock = getStockBySymbol(sym);
        const totalInv = plans.reduce((a,p)=>a+p.totalInvested,0);
        const totalExec = plans.reduce((a,p)=>a+p.execCount,0);
        const avg = stock && totalExec > 0 ? (totalInv / (plans.reduce((a,p)=>a+(p.execCount),0)||1)).toFixed(2) : 'â€”';
        const avgEl=document.getElementById('sipAvgCost'); if(avgEl) avgEl.textContent = avg!=='â€”'?'$'+avg:'â€”';
        const invEl=document.getElementById('sipTotalInvested'); if(invEl) invEl.textContent = '$'+totalInv.toFixed(0);
        const excEl=document.getElementById('sipExecCount'); if(excEl) excEl.textContent = totalExec;
    }

    // â”€â”€ Render SIP sidebar widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSIPSidebarWidget() {
        const el = document.getElementById('sipSidebarWidget');
        if (!el) return;
        const active = sipPlans.filter(p=>p.active);
        if (active.length === 0) {
            el.innerHTML = '<div style="font-size:11px;color:#6868a0;text-align:center;padding:4px 0;font-style:italic;">No active SIP plans.</div>';
            return;
        }
        const typeEmoji = { stock:'ğŸ“ˆ', fractional:'ğŸ”¬', etf:'ğŸ¦', drip:'ğŸ’°' };
        el.innerHTML = active.slice(0,4).map(p => {
            const pct = p.maxTotal < Infinity ? Math.min(100,(p.totalInvested/p.maxTotal*100)).toFixed(0) : null;
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div style="font-size:11px;">
                    <span style="font-weight:700;color:#e0e0f5;">${typeEmoji[p.type]||''} ${p.sym}</span>
                    <span style="color:#8888a8;font-size:10px;"> $${p.amount} ${p.freq}</span>
                </div>
                <div style="text-align:right;font-size:10px;">
                    ${pct!=null?`<div style="color:#6868a0;">${pct}% used</div>`:''}
                    <div style="color:#4ade80;">$${p.totalInvested.toFixed(0)} invested</div>
                </div>
            </div>`;
        }).join('');
    }

    // â”€â”€ SIP execution engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startSIPEngine() {
        if (_sipIntervalId) return; // already running
        _sipIntervalId = setInterval(executeDueSIPs, 5000); // check every 5s
    }

    function executeDueSIPs() {
        const now = Date.now();
        let didExecute = false;

        sipPlans.forEach(plan => {
            if (!plan.active) return;
            if (now < plan.nextExec) return;

            const stock = getStockBySymbol(plan.sym);
            if (!stock) return;

            // Check max total
            if (plan.totalInvested >= plan.maxTotal) {
                plan.active = false;
                showTradeToast('INFO', 0, `ğŸ“… SIP for ${plan.sym} reached max total â€” completed`, 0, false);
                return;
            }

            const price = stock.price;
            let dollarAmount = plan.amount;

            if (plan.type === 'drip') {
                // Simulate quarterly dividend payout
                const owned = portfolio[plan.sym] || 0;
                if (owned === 0) { reschedule(plan); return; }
                const divAmt = (stock.divAmt || 0) * owned;
                if (divAmt <= 0) { reschedule(plan); return; }
                dollarAmount = divAmt;
            }

            // Fractional shares â€” dollar amount always goes through
            const fractionalShares = dollarAmount / price; // e.g. 0.38 shares
            const wholeShares = plan.type === 'stock' ? Math.floor(fractionalShares) : fractionalShares;
            if (wholeShares <= 0 && plan.type === 'stock') {
                // Not enough for even 1 share â€” accumulate and skip
                showTradeToast('INFO', 0, `SIP: ${plan.sym} insufficient for 1 share at $${price.toFixed(2)} â€” accumulating`, 0, false);
                reschedule(plan);
                return;
            }

            const actualShares = plan.type === 'stock' ? wholeShares : fractionalShares;
            const actualCost   = actualShares * price;

            if (cash < actualCost) {
                showTradeToast('INFO', 0, `ğŸ“… SIP ${plan.sym}: insufficient cash â€” paused`, 0, false);
                plan.active = false;
                return;
            }

            // Execute
            cash -= actualCost;
            portfolio[plan.sym] = (portfolio[plan.sym] || 0) + actualShares;
            if (!costBasis[plan.sym]) costBasis[plan.sym] = [];
            costBasis[plan.sym].push({ qty:actualShares, price });
            plan.totalInvested += actualCost;
            plan.execCount++;
            plan.lastExecPrice = price;

            const note = `ğŸ“… SIP (${plan.type}) Â· ${plan.freq}`;
            transactions.unshift({ type:'BUY', symbol:plan.sym, qty:+actualShares.toFixed(6), price, ts:Date.now(), note });
            sipHistory.push({ planId:plan.id, sym:plan.sym, shares:actualShares, price, cost:actualCost, ts:Date.now() });

            showTradeToast('BUY', +actualShares.toFixed(4), plan.sym, price, false);
            updateUI();
            saveUserData(true);
            didExecute = true;

            reschedule(plan);
        });

        if (didExecute) {
            if (detailStock) renderSIPDetailPanel(detailStock.symbol);
            renderSIPSidebarWidget();
        }
    }

    function reschedule(plan) {
        plan.nextExec = Date.now() + (SIP_INTERVAL_MS[plan.freq] || 900000);
    }

    // â”€â”€ Cancel a plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cancelSIPPlan(id) {
        const plan = sipPlans.find(p=>p.id===id);
        if (!plan) return;
        plan.active = false;
        if (detailStock) renderSIPDetailPanel(detailStock.symbol);
        renderSIPSidebarWidget();
        showTradeToast('INFO', 0, `ğŸ“… SIP for ${plan.sym} cancelled`, 0, false);
    }

    // â”€â”€ Hook openStockDetail to render SIP panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origOpenStockDetail = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetail(stock);
        renderSIPDetailPanel(stock.symbol);
    };


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TRADING MODE SYSTEM
    //  Standard vs Realism â€” separate leaderboards, separate rules
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let _tradingMode = 'standard';   // 'standard' | 'realism'
    let _modeLockedUntilMonthEnd = false;
    let _pendingConfirmTrade = null; // holds { side, stock, qty, orderType, trigger, bracketSL, bracketTP }

    // â”€â”€ Mode persistence â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getTradingMode() {
        if (currentUser && currentUser.tradingMode) return currentUser.tradingMode;
        return _tradingMode;
    }

    function isRealism() { return getTradingMode() === 'realism'; }

    function setTradingMode(mode, skipSave) {
        _tradingMode = mode;
        if (currentUser) currentUser.tradingMode = mode;
        applyModeUI(mode);
        if (!skipSave) saveUserData(false);
    }

    function applyModeUI(mode) {
        const isR = mode === 'realism';
        const accent      = isR ? '#60a5fa' : '#d4a84b';
        const accentBg    = isR ? 'rgba(96,165,250,0.12)' : 'rgba(212,168,75,0.12)';
        const accentBord  = isR ? 'rgba(96,165,250,0.25)' : 'rgba(212,168,75,0.25)';
        const modeLabel   = isR ? 'ğŸ”µ Realism Mode â€” Market hours Â· Real spreads' : 'ğŸŸ¡ Standard Mode â€” Simplified fills';
        const badgeLabel  = isR ? 'ğŸ”µ Realism' : 'ğŸŸ¡ Standard';

        // Sidebar badge
        const sb = document.getElementById('modeBadgeSidebar');
        if (sb) {
            sb.textContent = badgeLabel;
            sb.style.color = accent;
            sb.style.background = accentBg;
            sb.style.borderColor = accentBord;
        }
        // Trade panel
        const tpb = document.getElementById('tradePanelModeBadge');
        if (tpb) {
            tpb.style.background = accentBg;
            tpb.style.borderColor = accentBord;
            tpb.style.color = accent;
        }
        const tpl = document.getElementById('tradePanelModeLabel');
        if (tpl) tpl.textContent = modeLabel;

        // slippageEnabled mirrors realism mode
        slippageEnabled = true;  // always on in both modes; realism adds more
    }

    // â”€â”€ Mode Selection Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showModeSelectModal() {
        const el = document.getElementById('modeSelectModal');
        if (el) el.style.display = 'flex';
    }

    function confirmModeSelect(mode) {
        const el = document.getElementById('modeSelectModal');
        if (el) el.style.display = 'none';
        setTradingMode(mode, false);
        showTradeToast('INFO', 0, `Mode set: ${mode === 'realism' ? 'ğŸ”µ Realism Mode' : 'ğŸŸ¡ Standard Mode'}`, 0, true);
    }

    function openModeSettings() {
        const month = new Date().getMonth();
        if (_modeLockedUntilMonthEnd) {
            showTradeToast('INFO', 0, 'Mode switching is disabled during active competition.', 0, true);
            return;
        }
        showModeSelectModal();
    }

    // Check if mode needs to be selected on login
    function checkModeOnLogin() {
        if (!currentUser) return;
        if (!currentUser.tradingMode) {
            setTimeout(showModeSelectModal, 800);
        } else {
            setTradingMode(currentUser.tradingMode, true);
        }
    }

    // â”€â”€ Realism Mode: market hours enforcement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function isMarketHoursNow() {
        const now = new Date();
        const et = new Date(now.toLocaleString('en-US', {timeZone:'America/New_York'}));
        const day = et.getDay(), h = et.getHours(), m = et.getMinutes();
        if (day === 0 || day === 6) return false;
        const mins = h*60+m;
        return mins >= 9*60+30 && mins < 16*60;
    }

    function checkRealismGate(side) {
        if (!isRealism()) return true;
        if (!isMarketHoursNow()) {
            showTradeToast('INFO', 0, 'ğŸ”µ Realism Mode: Market is closed. Orders only execute during regular hours (9:30â€“16:00 ET).', 0, true);
            return false;
        }
        return true;
    }

    // â”€â”€ Realism Mode: spread simulation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function realismSpread(price, side) {
        if (!isRealism()) return price;
        // Simulate ~0.01% spread + 0.02% slippage for realism
        const spreadPct = 0.0003;
        return side === 'BUY' ? price * (1 + spreadPct) : price * (1 - spreadPct);
    }

    // â”€â”€ Trade Confirmation Modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openTradeConfirm(side, stock, qty, orderType, trigger, bracketSL, bracketTP) {
        _pendingConfirmTrade = { side, stock, qty, orderType, trigger, bracketSL, bracketTP };
        const price = trigger && trigger > 0 ? trigger : stock.price;
        const effPrice = realismSpread(price, side);
        const total = effPrice * qty;
        const remaining = cash - (side === 'BUY' ? total : 0);
        const riskPct = Math.min(100, (total / (cash + total)) * 100);
        const isHigh = riskPct > 25;

        document.getElementById('tcOrderType').textContent = orderType.toUpperCase() + ' ORDER';
        document.getElementById('tcTitle').textContent = `${side === 'BUY' ? 'ğŸŸ¢ Buy' : 'ğŸ”´ Sell'} ${qty} Ã— ${stock.symbol}`;
        document.getElementById('tcQty').textContent = qty;
        document.getElementById('tcPrice').textContent = '$' + effPrice.toFixed(2);
        document.getElementById('tcTotal').textContent = '$' + total.toFixed(2);
        document.getElementById('tcCash').textContent = '$' + remaining.toFixed(2);
        document.getElementById('tcRiskPct').textContent = riskPct.toFixed(1) + '%';
        document.getElementById('tcRiskBar').style.width = riskPct + '%';
        document.getElementById('tcRiskBar').style.background = isHigh ? '#ef4444' : riskPct > 15 ? '#f97316' : '#4ade80';
        const warn = document.getElementById('tcRiskWarn');
        if (warn) warn.style.display = isHigh ? 'block' : 'none';
        const slip = document.getElementById('tcSlippageNote');
        if (slip) slip.style.display = isRealism() ? 'block' : 'none';
        const btn = document.getElementById('tcConfirmBtn');
        if (btn) {
            btn.textContent = `Confirm ${side === 'BUY' ? 'Buy' : 'Sell'}`;
            btn.style.background = side === 'BUY' ? '#34c759' : '#ff453a';
        }
        const modal = document.getElementById('tradeConfirmModal');
        if (modal) modal.style.display = 'flex';
    }

    function cancelTradeConfirm() {
        _pendingConfirmTrade = null;
        const modal = document.getElementById('tradeConfirmModal');
        if (modal) modal.style.display = 'none';
    }

    function executeConfirmedTrade() {
        const pt = _pendingConfirmTrade;
        if (!pt) return;
        cancelTradeConfirm();
        const { side, stock, qty, orderType, trigger, bracketSL, bracketTP } = pt;
        // Apply realism spread to execution price
        const rawPrice = trigger && trigger > 0 ? trigger : stock.price;
        const effPrice = realismSpread(rawPrice, side);

        if (orderType === 'market') {
            const ok = executeOrderNow({ side, symbol: stock.symbol, qty, type: 'market' }, effPrice, false);
            if (ok) {
                document.getElementById('dShares').innerText = portfolio[stock.symbol] || 0;
                document.getElementById('dBuyPow').innerText = '$' + (cash * leverage).toLocaleString(undefined, { maximumFractionDigits: 0 });
                showTradeToast(side, qty, stock.symbol, effPrice);
                recordPerfSnapshot();
                updateFloatingPL(stock);
                setTimeout(() => openJournal({ side, symbol: stock.symbol, qty, price: effPrice, ts: Date.now() }), 800);
            }
        } else if (orderType === 'bracket') {
            // Place market entry
            const ok = executeOrderNow({ side, symbol: stock.symbol, qty, type: 'market' }, effPrice, false);
            if (ok) {
                // Place accompanying SL + TP as pending orders
                if (bracketSL && bracketSL > 0) {
                    pendingOrders.unshift({ id:'ord_sl_'+Date.now(), symbol:stock.symbol, side:'SELL', qty, type:'stop-loss',   trigger:bracketSL, createdAt:Date.now(), status:'OPEN', note:'Bracket SL' });
                }
                if (bracketTP && bracketTP > 0) {
                    pendingOrders.unshift({ id:'ord_tp_'+Date.now(), symbol:stock.symbol, side:'SELL', qty, type:'take-profit', trigger:bracketTP, createdAt:Date.now(), status:'OPEN', note:'Bracket TP' });
                }
                renderPendingOrders();
                showTradeToast(side, qty, stock.symbol, effPrice);
                recordPerfSnapshot();
                updateFloatingPL(stock);
            }
        } else if (orderType === 'partial') {
            // Partial close: qty from existing position
            const owned = portfolio[stock.symbol] || 0;
            const closeQty = Math.min(qty, owned);
            if (closeQty <= 0) { showTradeToast('INFO',0,'No position to close.',0,true); return; }
            const ok = executeOrderNow({ side:'SELL', symbol:stock.symbol, qty:closeQty, type:'market' }, effPrice, false);
            if (ok) {
                document.getElementById('dShares').innerText = portfolio[stock.symbol] || 0;
                showTradeToast('SELL', closeQty, stock.symbol, effPrice);
                recordPerfSnapshot();
            }
        } else {
            // Limit / stop-loss / take-profit / gtt
            pendingOrders.unshift({
                id: 'ord_' + Date.now() + '_' + Math.random().toString(36).slice(2,7),
                symbol: stock.symbol, side, qty, type: orderType, trigger,
                createdAt: Date.now(), status: 'OPEN'
            });
            renderPendingOrders();
            updateUI();
            saveUserData(false);
            showTradeToast(side, qty, stock.symbol, trigger, true);
        }
    }

    // â”€â”€ Patch execDetailTrade to use confirmation modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origExecDetailTrade2 = execDetailTrade;
    execDetailTrade = function(side) {
        if (!detailStock) return;
        if (!RT.key) { showNoApiToast(); return; }
        if (!checkRealismGate(side)) return;

        const qty = Math.max(1, parseInt(document.getElementById('orderQty')?.value || '1', 10));
        const orderType = document.getElementById('orderType')?.value || 'market';
        const trigger = parseFloat(document.getElementById('orderTrigger')?.value || '0');
        const bracketSL = parseFloat(document.getElementById('bracketSL')?.value || '0');
        const bracketTP = parseFloat(document.getElementById('bracketTP')?.value || '0');

        // Bracket and partial close show confirmation always
        // Market orders show confirmation modal
        openTradeConfirm(side, detailStock, qty, orderType, trigger || 0, bracketSL, bracketTP);
    };

    // â”€â”€ Show/hide bracket fields when order type changes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origUpdateOrderTypeHint = updateOrderTypeHint;
    updateOrderTypeHint = function(sel) {
        _origUpdateOrderTypeHint(sel);
        const val = sel?.value || 'market';
        const bf = document.getElementById('bracketExtraFields');
        const rrp = document.getElementById('rrCalcPanel');
        if (bf) bf.style.display = (val === 'bracket') ? 'grid' : 'none';
        if (rrp) rrp.style.display = (val === 'bracket') ? 'block' : 'none';
        if (val === 'bracket') updateRRCalc();
    };

    function updateRRCalc() {
        if (!detailStock) return;
        const price = detailStock.price;
        const sl = parseFloat(document.getElementById('bracketSL')?.value || '0');
        const tp = parseFloat(document.getElementById('bracketTP')?.value || '0');
        const qty = parseInt(document.getElementById('orderQty')?.value || '1', 10);
        const riskEl   = document.getElementById('rrRisk');
        const rewardEl = document.getElementById('rrReward');
        const ratioEl  = document.getElementById('rrRatio');
        if (!riskEl) return;
        if (sl > 0 && tp > 0 && price > 0) {
            const risk   = Math.abs(price - sl) * qty;
            const reward = Math.abs(tp - price) * qty;
            const ratio  = risk > 0 ? (reward/risk).toFixed(2) : 'â€”';
            riskEl.textContent   = 'Risk: $' + risk.toFixed(0);
            rewardEl.textContent = 'Rwd: $' + reward.toFixed(0);
            ratioEl.textContent  = 'R:R ' + ratio;
            ratioEl.style.color  = parseFloat(ratio) >= 2 ? '#4ade80' : parseFloat(ratio) >= 1 ? '#f59e0b' : '#f87171';
        } else {
            riskEl.textContent='Risk: â€”'; rewardEl.textContent='Rwd: â€”'; ratioEl.textContent='R:R â€”';
        }
    }

    // Attach RR update to bracket fields
    setTimeout(() => {
        ['bracketSL','bracketTP','orderQty'].forEach(id => {
            const el = document.getElementById(id);
            if (el) el.addEventListener('input', updateRRCalc);
        });
    }, 1200);

    // â”€â”€ Floating position P&L â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateFloatingPL(stock) {
        if (!stock) return;
        const qty = portfolio[stock.symbol] || 0;
        const fpEl = document.getElementById('floatingPL');
        const fpV  = document.getElementById('floatingPLValue');
        if (!fpEl || !fpV) return;
        if (qty <= 0) { fpEl.style.display = 'none'; return; }
        const avg = avgCost(stock.symbol);
        const pl  = (stock.price - avg) * qty;
        const pct = avg > 0 ? ((stock.price - avg)/avg*100).toFixed(2) : '0.00';
        fpEl.style.display = 'flex';
        fpV.textContent = (pl >= 0 ? '+' : '') + '$' + Math.abs(pl).toFixed(2) + ' (' + (pl>=0?'+':'') + pct + '%)';
        fpV.style.color = pl >= 0 ? '#4ade80' : '#f87171';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEADERBOARD â€” MODE-SPLIT SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let leaderSort = 'total';
    let leaderMode = 'standard';   // current leaderboard tab
    let leaderMinTrades = 0;  // minimum trades filter

    function setLBMinTrades(n) {
        leaderMinTrades = n;
        document.querySelectorAll('.lbmt-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
            b.style.borderColor = 'rgba(255,255,255,0.08)';
        });
        const active = document.getElementById('lbmt-' + n);
        const accent = leaderMode === 'realism' ? '#60a5fa' : '#d4a84b';
        if (active) {
            active.style.background = leaderMode === 'realism' ? 'rgba(96,165,250,0.12)' : 'rgba(212,168,75,0.12)';
            active.style.color = accent;
            active.style.borderColor = accent + '50';
        }
        loadLeaderboard();
    }

    function setLeaderMode(mode) {
        leaderMode = mode;
        const isR = mode === 'realism';
        ['standard','realism'].forEach(m => {
            const btn = document.getElementById('lbTab-' + m);
            if (!btn) return;
            const active = m === mode;
            const accent = m === 'realism' ? '#60a5fa' : '#d4a84b';
            const accentBg = m === 'realism' ? 'rgba(96,165,250,0.12)' : 'rgba(212,168,75,0.12)';
            btn.style.background = active ? accentBg : 'transparent';
            btn.style.color = active ? accent : '#6868a0';
            btn.style.borderBottom = active ? ('2px solid ' + accent) : '2px solid transparent';
        });
        const titleEl = document.getElementById('lbTitle');
        const subEl   = document.getElementById('lbSubtitle');
        if (titleEl) titleEl.textContent = isR ? 'ğŸ† Realism Mode Leaderboard' : 'ğŸ† Standard Mode Leaderboard';
        if (subEl)   subEl.textContent   = isR ? 'Monthly competition Â· Blue accent Â· Harder rules Â· Verified mode' : 'Monthly competition Â· Gold accent';
        const now = new Date();
        const mt = document.getElementById('lbMonthTag');
        if (mt) mt.textContent = now.toLocaleString('default', {month:'long', year:'numeric'});
        updateLBCountdown();
        loadLeaderboard();
    }

    function setLeaderSort(type) {
        leaderSort = type;
        const accent = leaderMode === 'realism' ? '#60a5fa' : '#d4a84b';
        document.querySelectorAll('.lbsort-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
        });
        const active = document.getElementById('sort-' + type);
        if (active) {
            active.style.background = leaderMode === 'realism' ? 'rgba(96,165,250,0.12)' : 'rgba(212,168,75,0.12)';
            active.style.color = accent;
        }
        loadLeaderboard();
    }

    function updateLBCountdown() {
        const el = document.getElementById('lbCompetitionCountdown');
        if (!el) return;
        const now = new Date();
        const endOfMonth = new Date(now.getFullYear(), now.getMonth()+1, 1, 0, 0, 0);
        const msLeft = endOfMonth - now;
        const dLeft = Math.floor(msLeft / 86400000);
        const hLeft = Math.floor((msLeft % 86400000) / 3600000);
        el.textContent = `â³ Competition ends in ${dLeft}d ${hLeft}h`;
    }

    async function openLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.remove('hidden');
        setLeaderMode(leaderMode); // re-apply tab styling
        await loadLeaderboard();
    }

    function closeLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.add('hidden');
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboardList');
        if (!list) return;
        const isR = leaderMode === 'realism';
        const accent = isR ? '#60a5fa' : '#d4a84b';
        list.innerHTML = `<div style="text-align:center;color:#8888a8;padding:32px 0;">Loading tradersâ€¦</div>`;

        try {
            const storage = ensureStorageAdapter();
            const keys = await storage.list('user:', true);
            if (!keys || !keys.keys || keys.keys.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;">No traders yet â€” be the first!</div>';
                return;
            }

            const users = [];
            for (const key of keys.keys) {
                try {
                    const r = await storage.get(key, true);
                    if (r) {
                        const u = JSON.parse(r.value);
                        if (u.displayName) users.push(u);
                    }
                } catch(e) {}
            }

            // â”€â”€ ANTI-GAMING: Enhanced filtering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const modeUsers = users
                .filter(u => (u.tradingMode || 'standard') === leaderMode)
                .filter(u => {
                    // Extreme risk violations
                    if ((u.riskViolations || 0) > 15) return false;
                    // Ghost/spam accounts: active but no real trades
                    if ((u.totalTrades || 0) === 0 && (u.totalValue || 100000) > 105000) return false;
                    // Zero-activity accounts
                    if (!u.lastActive && (u.totalValue || 100000) === 100000) return false;
                    return true;
                })
                .filter(u => {
                    // Minimum trade threshold filter
                    if (leaderMinTrades > 0 && (u.totalTrades || 0) < leaderMinTrades) return false;
                    return true;
                });

            // â”€â”€ Compute advanced stats for each user â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const monthKey = getMonthKey();
            modeUsers.forEach(u => {
                const ms = (u.monthlyStats && u.monthlyStats[monthKey]) || {};
                u._total       = ms.totalValue    || u.totalValue    || 100000;
                u._return      = ms.monthlyReturn || u.profit        || 0;
                u._returnPct   = ((u._total - 100000) / 100000 * 100);
                u._drawdown    = ms.maxDrawdown   || u.maxDrawdown   || 0;
                u._trades      = u.totalTrades    || 0;
                u._discipline  = u.disciplineScore || 0;
                u._integrity   = u.integrityScore ?? 100;
                u._winRate     = u.disciplineScore || 0; // disciplineScore IS win rate currently
                // Composite Trader Rating (0-100)
                const retScore = Math.min(50, Math.max(-20, u._returnPct));
                const ddPenalty = Math.abs(u._drawdown) * 0.5;
                const intBonus = (u._integrity - 70) * 0.3;
                const discBonus = u._discipline * 0.2;
                u._traderRating = Math.max(0, Math.min(100, 50 + retScore - ddPenalty + intBonus + discBonus));
                // Risk-adjusted: return Ã— (integrity/100) / (1 + |drawdown/10|)
                u._riskAdj = (u._returnPct * (u._integrity / 100)) / (1 + Math.abs(u._drawdown / 10));
                // Eligibility check
                const integCheck = checkLeaderboardIntegrity(u);
                u._eligible = integCheck.eligible;
                u._ineligReason = integCheck.reason;
            });

            // â”€â”€ Sort â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            if      (leaderSort === 'total')       modeUsers.sort((a,b) => b._total - a._total);
            else if (leaderSort === 'return')      modeUsers.sort((a,b) => b._returnPct - a._returnPct);
            else if (leaderSort === 'drawdown')    modeUsers.sort((a,b) => a._drawdown - b._drawdown);
            else if (leaderSort === 'riskadjusted') modeUsers.sort((a,b) => b._riskAdj - a._riskAdj);
            else if (leaderSort === 'integrity')   modeUsers.sort((a,b) => b._integrity - a._integrity);
            else if (leaderSort === 'discipline')  modeUsers.sort((a,b) => b._traderRating - a._traderRating);

            // â”€â”€ Avg return for compare strip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const allStd = users.filter(u=>(u.tradingMode||'standard')==='standard');
            const allRls = users.filter(u=>(u.tradingMode||'standard')==='realism');
            const avgReturn = arr => arr.length
                ? (arr.reduce((s,u)=>s+((u.totalValue||100000)-100000)/100000*100,0)/arr.length).toFixed(1)+'%'
                : 'â€”';
            const stdAvgEl = document.getElementById('lbStdAvg');
            const rlsAvgEl = document.getElementById('lbRlsAvg');
            if (stdAvgEl) stdAvgEl.textContent = avgReturn(allStd);
            if (rlsAvgEl) rlsAvgEl.textContent = avgReturn(allRls);

            // â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            const isMe = u => currentUser && u.username === currentUser.username;

            if (modeUsers.length === 0) {
                const minTradesMsg = leaderMinTrades > 0 ? ` with ${leaderMinTrades}+ trades` : '';
                list.innerHTML = `<div style="text-align:center;padding:40px 20px;">
                    <div style="font-size:2rem;margin-bottom:12px;">ğŸ‹ï¸</div>
                    <div style="font-size:13px;color:#8888a8;margin-bottom:8px;">No ${leaderMode} mode traders${minTradesMsg} yet.</div>
                    <div style="font-size:11px;color:#606080;">Switch to ${leaderMode} mode or adjust the minimum trades filter.</div>
                </div>`;
                return;
            }

            const sortLabel = { total:'Portfolio Value', return:'Return %', drawdown:'Lowest Drawdown', riskadjusted:'Risk-Adjusted Score', integrity:'Integrity Score', discipline:'Trader Rating' }[leaderSort] || 'Value';

            list.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;font-size:10px;color:#606080;margin-bottom:14px;text-transform:uppercase;letter-spacing:0.07em;">
                <span>${isR ? 'ğŸ”µ Realism' : 'ğŸŸ¡ Standard'} Â· ${modeUsers.length} trader${modeUsers.length!==1?'s':''}</span>
                <span style="color:${accent};">â†‘ ${sortLabel}</span>
            </div>`
            + modeUsers.map((u, i) => {
                const me = isMe(u);
                const pct = u._returnPct;
                const pctColor = pct >= 0 ? '#4ade80' : '#f87171';
                const pctStr = (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%';
                const ineligBadge = !u._eligible
                    ? `<span title="${u._ineligReason}" style="font-size:8px;color:#f87171;background:rgba(239,68,68,0.1);padding:1px 5px;border-radius:3px;margin-left:4px;cursor:help;">Ineligible</span>`
                    : '';
                const realismBadge = isR
                    ? '<span style="font-size:8px;color:#60a5fa;background:rgba(96,165,250,0.1);border:1px solid rgba(96,165,250,0.2);padding:1px 5px;border-radius:3px;margin-left:4px;">âœ“ Verified</span>'
                    : '';
                // Integrity badge
                const integ = u._integrity;
                const integColor = integ >= 80 ? '#4ade80' : integ >= 60 ? '#f59e0b' : '#f87171';
                const integBadge = `<span style="font-size:8px;color:${integColor};background:${integColor}15;padding:1px 5px;border-radius:3px;margin-left:4px;" title="Integrity score â€” measures rule compliance">âš¡${integ}</span>`;
                const border = me
                    ? `background:${isR?'rgba(96,165,250,0.08)':'rgba(212,168,75,0.08)'};border:1px solid ${isR?'rgba(96,165,250,0.3)':'rgba(212,168,75,0.3)'};`
                    : 'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);';
                const medal = medals[i] || `<span style="font-size:12px;color:#606080;font-weight:700;">#${i+1}</span>`;
                // Secondary metric based on sort mode
                const secMetric = leaderSort === 'drawdown'
                    ? `<div style="font-size:9px;color:#9aa0a6;font-family:var(--v-mono);">DD: ${(u._drawdown||0).toFixed(1)}%</div>`
                    : leaderSort === 'discipline' || leaderSort === 'riskadjusted'
                    ? `<div style="font-size:9px;color:${accent};font-family:var(--v-mono);">${leaderSort==='discipline'?'Rating: '+u._traderRating.toFixed(0):'R-Adj: '+u._riskAdj.toFixed(1)}</div>`
                    : '';
                // Trades badge
                const tradesBadge = u._trades >= 25
                    ? `<span style="font-size:8px;color:#a78bfa;background:rgba(167,139,250,0.1);padding:1px 5px;border-radius:3px;margin-left:4px;">${u._trades} trades</span>`
                    : u._trades >= 5
                    ? `<span style="font-size:8px;color:#6868a0;background:rgba(255,255,255,0.05);padding:1px 5px;border-radius:3px;margin-left:4px;">${u._trades} trades</span>`
                    : '';
                return `<div style="border-radius:12px;padding:13px 16px;margin-bottom:8px;display:flex;align-items:center;gap:10px;${border}transition:all 0.2s;${!u._eligible?'opacity:0.55':''}">
                    <div style="font-size:1.2rem;width:26px;text-align:center;flex-shrink:0;">${medal}</div>
                    <div style="width:36px;height:36px;border-radius:50%;background:${me?accent:'#1e1e2e'};display:flex;align-items:center;justify-content:center;color:${me?'#0a0a0f':'#c0c0d8'};font-weight:700;font-size:14px;flex-shrink:0;">${u.displayName[0].toUpperCase()}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.88rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;display:flex;align-items:center;flex-wrap:wrap;gap:2px;">
                            ${u.displayName}${me ? ` <span style="font-size:9px;color:${accent};font-weight:600;">(you)</span>` : ''}${ineligBadge}${realismBadge}${integBadge}${tradesBadge}
                        </div>
                        <div style="font-size:10px;color:#8888a8;margin-top:1px;">@${u.username}</div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.88rem;font-family:var(--v-mono);">$${(u._total||0).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        <div style="font-size:11px;color:${pctColor};font-family:var(--v-mono);">${pctStr}</div>
                        ${secMetric}
                    </div>
                </div>`;
            }).join('');

        } catch(e) {
            list.innerHTML = `<div style="text-align:center;color:#f87171;padding:32px 0;font-size:12px;">Load error: ${e.message}</div>`;
        }
    }

    // â”€â”€ Month key for competition tracking â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function getMonthKey(ts = Date.now()) {
        const d = new Date(ts);
        return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
    }

    // â”€â”€ Save monthly stats into user record â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origSaveUserData = saveUserData;
    saveUserData = async function(countTrade) {
        if (currentUser) {
            // Persist mode
            currentUser.tradingMode = getTradingMode();
            currentUser.competitionEligible = currentUser.competitionEligible !== false;
            // Monthly stats
            const monthKey = getMonthKey();
            const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
                const s = stocks.find(x => x.symbol === sym);
                return sum + (s ? s.price * portfolio[sym] : 0);
            }, 0);
            const totalValue = cash + portfolioValue;
            const maxDD = computeMaxDrawdown();
            currentUser.monthlyStats = currentUser.monthlyStats || {};
            currentUser.monthlyStats[monthKey] = {
                totalValue,
                monthlyReturn: totalValue - 100000,
                maxDrawdown: maxDD,
                tradingMode: getTradingMode(),
                updatedAt: Date.now(),
                tradeCount: (transactions||[]).filter(t=>t.type==='SELL').length,
            };
            currentUser.maxDrawdown = maxDD;

            // â”€â”€ Comprehensive Trader Rating â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const sells = (transactions||[]).filter(t=>t.type==='SELL');
            if (sells.length > 0) {
                const wins = sells.filter(t => t.price > (t.avgBuy || t.price));
                currentUser.disciplineScore = Math.round((wins.length / sells.length) * 100);

                // Compute patience score: avg days between trades
                if (sells.length >= 3) {
                    const timestamps = sells.map(t => t.ts || Date.now()).sort((a,b)=>a-b);
                    const gaps = timestamps.slice(1).map((t,i) => (t - timestamps[i]) / 86400000);
                    const avgGap = gaps.reduce((a,b)=>a+b,0) / gaps.length;
                    currentUser.patienceScore = Math.min(100, Math.round(avgGap * 10));
                }

                // Compute risk stability score (position size consistency)
                try {
                    const rss = computeRiskStabilityScore();
                    if (rss) currentUser.riskStabilityScore = rss.score;
                } catch(e) {}

                // Behavioral flags
                const riskAdj = computeRiskAdjustedReturn ? computeRiskAdjustedReturn() : null;
                if (riskAdj) {
                    currentUser.sharpe = riskAdj.sharpe;
                    currentUser.calmar = riskAdj.calmar;
                }
            }

            // Compute integrity score every save
            currentUser.integrityScore = computeIntegrityScore();

            // Composite Trader Rating (0-100) â€” used for discipline leaderboard
            const retPct = (totalValue - 100000) / 100000 * 100;
            const retScore = Math.min(50, Math.max(-20, retPct * 0.8));
            const ddPenalty = Math.abs(maxDD) * 0.5;
            const intBonus = ((currentUser.integrityScore || 100) - 70) * 0.3;
            const discBonus = (currentUser.disciplineScore || 0) * 0.2;
            const consistBonus = (currentUser.riskStabilityScore || 50) * 0.1;
            currentUser.traderRating = Math.max(0, Math.min(100, Math.round(50 + retScore - ddPenalty + intBonus + discBonus + consistBonus)));
        }
        return _origSaveUserData(countTrade);
    };

    function computeMaxDrawdown() {
        if (!perfHistory || perfHistory.length < 2) return 0;
        let peak = perfHistory[0]?.value || 100000;
        let maxDD = 0;
        perfHistory.forEach(p => {
            if (p.value > peak) peak = p.value;
            const dd = (peak - p.value) / peak * 100;
            if (dd > maxDD) maxDD = dd;
        });
        return parseFloat(maxDD.toFixed(2));
    }

    // â”€â”€ Patch loginAs to check mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origLoginAs = loginAs;
    loginAs = async function(userData) {
        await _origLoginAs(userData);
        checkModeOnLogin();
        // Also update floating PL if detail open
        if (detailStock) updateFloatingPL(detailStock);
    };

    // â”€â”€ Patch openStockDetail to show floating PL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origOpenStockDetailMode = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetailMode(stock);
        setTimeout(() => updateFloatingPL(stock), 300);
    };

    // â”€â”€ Analytics panel: show current mode + discipline score â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origRenderAnalytics2 = renderAnalytics;
    renderAnalytics = function() {
        _origRenderAnalytics2();
        // Mode display in analytics
        const modeEl = document.getElementById('analyticsModeBadge');
        if (modeEl) {
            const isR = isRealism();
            modeEl.textContent = isR ? 'ğŸ”µ Realism Mode' : 'ğŸŸ¡ Standard Mode';
            modeEl.style.color = isR ? '#60a5fa' : '#d4a84b';
        }
        // Max drawdown + win rate in sidebar stats
        const stats = calcPortfolioStats();
        const statsEl = document.getElementById('portfolioStats');
        if (statsEl && stats) {
            const maxDD = computeMaxDrawdown();
            const mode = getTradingMode();
            statsEl.style.display = 'block';
            statsEl.innerHTML = `
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);">
                    <div style="text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Win Rate</div>
                        <div style="font-family:var(--v-mono);font-size:0.875rem;color:#4ade80;">${stats.winRate}%</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Max DD</div>
                        <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f87171;">${maxDD.toFixed(1)}%</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Avg Hold</div>
                        <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">${stats.avgHoldStr}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Mode</div>
                        <div style="font-size:0.75rem;font-weight:700;color:${mode==='realism'?'#60a5fa':'#d4a84b'};">${mode==='realism'?'ğŸ”µ Real':'ğŸŸ¡ Std'}</div>
                    </div>
                </div>`;
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AI TRADING COACH SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeCoachMetrics() {
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        if (sells.length === 0) return null;

        // Win rate
        const wins = sells.filter(t => {
            const cb = costBasis[t.symbol];
            const avg = cb && cb.shares ? cb.totalCost / cb.shares : 0;
            return t.price > (t.avgBuy || avg || t.price * 0.99);
        });
        const winRate = wins.length / sells.length;

        // Average hold time (ms)
        const holds = sells.map(t => {
            const buys = (transactions || []).filter(b => b.type === 'BUY' && b.symbol === t.symbol && b.ts < t.ts);
            if (!buys.length) return null;
            return t.ts - buys[buys.length - 1].ts;
        }).filter(Boolean);
        const avgHold = holds.length ? holds.reduce((a,b)=>a+b,0)/holds.length : 0;
        const avgHoldDays = avgHold / 86400000;

        // Avg risk per trade (normalized by portfolio)
        const avgTradeSize = sells.reduce((s,t)=>s+(t.price*(t.qty||1)),0)/sells.length;
        const portfolioSize = (currentUser && currentUser.totalValue) || 100000;
        const avgRiskPct = (avgTradeSize / portfolioSize) * 100;

        // Overtrading: >3 trades per day average
        const days = {};
        sells.forEach(t => { const d = dayKey(t.ts); days[d] = (days[d]||0)+1; });
        const dayVals = Object.values(days);
        const avgPerDay = dayVals.length ? dayVals.reduce((a,b)=>a+b,0)/dayVals.length : 0;
        const overtrading = avgPerDay > 3;

        // Consistency: std dev of daily P&L
        const perfVals = perfHistory.map(p=>p.value||100000);
        let volatilityScore = 0;
        if (perfVals.length > 5) {
            const returns = perfVals.slice(1).map((v,i)=>(v-perfVals[i])/perfVals[i]*100);
            const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
            const variance = returns.reduce((s,v)=>s+(v-mean)**2,0)/returns.length;
            volatilityScore = Math.sqrt(variance);
        }

        // Scores (0-100)
        const disciplineScore = Math.round(Math.min(100,
            winRate * 40 +                              // win rate contributes up to 40
            Math.min(30, avgHoldDays * 5) +            // longer hold = better up to 30
            (overtrading ? 0 : 20) +                   // no overtrading = +20
            (avgRiskPct < 10 ? 10 : 0)                 // small position size = +10
        ));
        const riskScore = Math.round(Math.min(100,
            (avgRiskPct < 5 ? 100 : avgRiskPct < 10 ? 80 : avgRiskPct < 20 ? 60 : 40)
        ));
        const consistencyScore = Math.round(Math.max(0, 100 - volatilityScore * 8));

        return { winRate, avgHoldDays, avgRiskPct, overtrading, disciplineScore, riskScore, consistencyScore, sellCount: sells.length };
    }

    function generateCoachInsights(metrics) {
        if (!metrics) return ['Complete some trades to unlock personalised coaching insights.'];
        const insights = [];

        if (metrics.winRate < 0.4)
            insights.push('Your win rate is below 40%. Review your entry criteria â€” consider waiting for stronger confirmation signals before entering trades.');
        else if (metrics.winRate >= 0.6)
            insights.push('Strong win rate above 60%. Focus on increasing position sizes on high-conviction setups while maintaining risk discipline.');

        if (metrics.avgHoldDays < 0.5)
            insights.push('Average hold time is under 12 hours. Short-term trading increases costs and noise exposure. Consider extending your holding period.');
        else if (metrics.avgHoldDays > 10)
            insights.push('Your holding period exceeds 10 days on average. This is consistent with a swing or position trading style â€” ensure your thesis remains valid.');

        if (metrics.overtrading)
            insights.push('You\'re averaging more than 3 trades per day â€” a pattern associated with overtrading. Selective, high-quality trades typically outperform high-frequency ones.');

        if (metrics.avgRiskPct > 15)
            insights.push('Position sizes exceed 15% of portfolio on average. Consider reducing concentration to manage drawdown risk effectively.');

        if (metrics.disciplineScore >= 75)
            insights.push('Your discipline score is excellent. You\'re exhibiting consistent, rule-based trading behaviour.');

        if (metrics.consistencyScore < 50)
            insights.push('Your equity curve shows high volatility. A more consistent process tends to compound better over time than peak-and-trough performance.');

        return insights.slice(0, 3);
    }

    function refreshAICoach() {
        const container = document.getElementById('aiCoachInsights');
        const dEl = document.getElementById('coachDiscipline');
        const rEl = document.getElementById('coachRisk');
        const cEl = document.getElementById('coachConsistency');

        const metrics = computeCoachMetrics();
        if (!metrics) {
            if (container) container.innerHTML = '<div class="coach-insight" style="border-color:rgba(167,139,250,0.2)">Complete trades to unlock personalised AI coaching insights.</div>';
            return;
        }

        if (dEl) dEl.textContent = metrics.disciplineScore;
        if (rEl) rEl.textContent  = metrics.riskScore;
        if (cEl) cEl.textContent  = metrics.consistencyScore;

        const scoreColor = s => s >= 75 ? '#4ade80' : s >= 50 ? '#f59e0b' : '#f87171';
        if (dEl) dEl.style.color = scoreColor(metrics.disciplineScore);
        if (rEl) rEl.style.color = scoreColor(metrics.riskScore);
        if (cEl) cEl.style.color = scoreColor(metrics.consistencyScore);

        const insights = generateCoachInsights(metrics);
        if (container) {
            container.innerHTML = insights.map(i => `<div class="coach-insight">${i}</div>`).join('');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PORTFOLIO INTELLIGENCE DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeSharpeRatio() {
        if (!perfHistory || perfHistory.length < 10) return null;
        const vals = perfHistory.map(p => p.value || 100000);
        const returns = vals.slice(1).map((v,i) => (v - vals[i]) / vals[i] * 100);
        if (returns.length < 3) return null;
        const mean = returns.reduce((a,b) => a+b, 0) / returns.length;
        const variance = returns.reduce((s,v) => s + (v-mean)**2, 0) / returns.length;
        const stdDev = Math.sqrt(variance);
        const riskFree = 0.02 / 252 * 100; // ~2% annual risk-free rate, daily
        return stdDev > 0 ? ((mean - riskFree) / stdDev * Math.sqrt(252)).toFixed(2) : null;
    }

    function computePortfolioVolatility() {
        if (!perfHistory || perfHistory.length < 5) return null;
        const vals = perfHistory.map(p => p.value || 100000);
        const returns = vals.slice(1).map((v,i) => (v-vals[i])/vals[i]*100);
        const mean = returns.reduce((a,b)=>a+b,0)/returns.length;
        const variance = returns.reduce((s,v)=>s+(v-mean)**2,0)/returns.length;
        return (Math.sqrt(variance) * Math.sqrt(252)).toFixed(1) + '%';
    }

    function renderMonthlyHeatmap() {
        const el = document.getElementById('monthlyHeatmap');
        if (!el) return;
        // Generate last 12 months of return data from perfHistory
        const now = Date.now();
        const months = [];
        for (let i = 11; i >= 0; i--) {
            const d = new Date(now);
            d.setMonth(d.getMonth() - i);
            const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
            const label = d.toLocaleString('default', {month:'short'});
            months.push({ key, label });
        }

        // Get monthly P&L from perfHistory
        const monthReturns = {};
        (perfHistory || []).forEach(p => {
            if (!p.ts && !p.date) return;
            const d = new Date(p.ts || Date.parse(p.date));
            const key = d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0');
            monthReturns[key] = monthReturns[key] || [];
            monthReturns[key].push(p.value || 100000);
        });

        el.innerHTML = months.map(m => {
            const vals = monthReturns[m.key];
            let ret = null;
            if (vals && vals.length >= 2) {
                ret = ((vals[vals.length-1] - vals[0]) / vals[0] * 100);
            }
            const bg = ret === null ? 'rgba(255,255,255,0.04)' :
                       ret > 5  ? 'rgba(34,197,94,0.5)'   :
                       ret > 2  ? 'rgba(34,197,94,0.3)'   :
                       ret > 0  ? 'rgba(34,197,94,0.15)'  :
                       ret > -3 ? 'rgba(239,68,68,0.15)'  :
                       ret > -5 ? 'rgba(239,68,68,0.3)'   : 'rgba(239,68,68,0.5)';
            const text = ret === null ? m.label : `${ret >= 0?'+':''}${ret.toFixed(0)}%`;
            const title = ret !== null ? `${m.label}: ${ret >= 0?'+':''}${ret.toFixed(1)}%` : m.label;
            return `<div class="heatmap-cell" style="background:${bg};" title="${title}">${m.label[0]}</div>`;
        }).join('');
    }

    function renderBestWorstTrade() {
        const el = document.getElementById('bestWorstTrade');
        if (!el) return;
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        if (sells.length === 0) { el.innerHTML = '<div style="color:#6868a0;font-style:italic;">No closed trades yet.</div>'; return; }
        const withPL = sells.map(t => {
            const pl = (t.price - (t.avgBuy || t.price * 0.98)) * (t.qty || 1);
            return { ...t, pl };
        }).sort((a,b) => b.pl - a.pl);
        const best  = withPL[0];
        const worst = withPL[withPL.length-1];
        el.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                <div style="background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);border-radius:6px;padding:6px 8px;">
                    <div style="font-size:8px;color:#4ade80;font-weight:700;text-transform:uppercase;margin-bottom:2px;">Best Trade</div>
                    <div style="font-weight:700;color:#f0f0fa;font-size:11px;">${best.symbol}</div>
                    <div style="font-family:var(--v-mono);color:#4ade80;font-size:10px;">+$${best.pl.toFixed(0)}</div>
                </div>
                <div style="background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15);border-radius:6px;padding:6px 8px;">
                    <div style="font-size:8px;color:#f87171;font-weight:700;text-transform:uppercase;margin-bottom:2px;">Worst Trade</div>
                    <div style="font-weight:700;color:#f0f0fa;font-size:11px;">${worst.symbol}</div>
                    <div style="font-family:var(--v-mono);color:#f87171;font-size:10px;">${worst.pl>=0?'+':''}$${worst.pl.toFixed(0)}</div>
                </div>
            </div>`;
    }

    function renderPortfolioIntelligence() {
        // Sharpe
        const sharpe = computeSharpeRatio();
        const sharpeEl = document.getElementById('sharpeRatio');
        if (sharpeEl) {
            sharpeEl.textContent = sharpe !== null ? sharpe : 'â€”';
            if (sharpe !== null) sharpeEl.style.color = parseFloat(sharpe) >= 1 ? '#4ade80' : parseFloat(sharpe) >= 0 ? '#f59e0b' : '#f87171';
        }
        // Max Drawdown
        const maxDD = computeMaxDrawdown();
        const ddEl = document.getElementById('maxDrawdownDisplay');
        if (ddEl) { ddEl.textContent = maxDD.toFixed(1) + '%'; ddEl.style.color = maxDD > 20 ? '#f87171' : maxDD > 10 ? '#f59e0b' : '#4ade80'; }
        // Volatility
        const vol = computePortfolioVolatility();
        const volEl = document.getElementById('portfolioVolatility');
        if (volEl) volEl.textContent = vol || 'â€”';
        // vs S&P 500 (simulated: assume 10% annual = ~0.04% daily)
        const totalPL = ((currentUser && currentUser.totalValue) || 100000) - 100000;
        const ownReturn = (totalPL / 100000 * 100).toFixed(1);
        const snpReturn = (perfHistory.length * 0.035).toFixed(1); // ~9% annualised simulated
        const vsEl = document.getElementById('vsSnP');
        if (vsEl) {
            const diff = parseFloat(ownReturn) - parseFloat(snpReturn);
            vsEl.textContent = (diff >= 0 ? '+' : '') + diff.toFixed(1) + '%';
            vsEl.style.color = diff >= 0 ? '#4ade80' : '#f87171';
            vsEl.title = `Your return: ${ownReturn}% Â· S&P 500 benchmark: ~${snpReturn}%`;
        }
        renderMonthlyHeatmap();
        renderBestWorstTrade();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MILLIONAIRE PATH CHALLENGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const MILLIONAIRE_TIERS = [
        { label: 'Bronze Trader',       min: 100000,  color: '#cd7f32', emoji: 'ğŸ¥‰' },
        { label: 'Silver Trader',       min: 150000,  color: '#c0c0c0', emoji: 'ğŸ¥ˆ' },
        { label: 'Gold Trader',         min: 250000,  color: '#d4a84b', emoji: 'ğŸ¥‡' },
        { label: 'Platinum Trader',     min: 500000,  color: '#60a5fa', emoji: 'ğŸ’' },
        { label: 'Institutional Tier',  min: 1000000, color: '#a78bfa', emoji: 'ğŸ›' },
    ];

    function updateMillionairePath() {
        const total = (currentUser && currentUser.totalValue) || (cash + Object.keys(portfolio).reduce((s,sym)=>{ const st=getStockBySymbol(sym); return s+(st?st.price*portfolio[sym]:0); },0));
        const goal = 1000000;
        const start = 100000;
        const pct = Math.min(100, Math.max(0, (total - start) / (goal - start) * 100));

        const barEl = document.getElementById('millionaireBar');
        const pctEl = document.getElementById('millionaireProgress');
        const labelEl = document.getElementById('millionaireLabel');
        const tierEl = document.getElementById('millionaireTier');
        const badgesEl = document.getElementById('millionaireTierBadges');

        if (barEl) barEl.style.width = pct + '%';
        if (pctEl) pctEl.textContent = pct.toFixed(1) + '%';
        if (labelEl) labelEl.textContent = '$' + Math.round(total/1000) + 'K current';

        // Determine current tier
        let currentTier = MILLIONAIRE_TIERS[0];
        for (const t of MILLIONAIRE_TIERS) { if (total >= t.min) currentTier = t; }
        if (tierEl) {
            tierEl.textContent = currentTier.emoji + ' ' + currentTier.label;
            tierEl.style.color = currentTier.color;
            tierEl.style.background = currentTier.color.replace('#','rgba(').replace(')',',0.1)').replace('rgba(','rgba(0x') || 'rgba(212,168,75,0.1)';
        }

        // Unlock badges
        if (badgesEl) {
            badgesEl.innerHTML = MILLIONAIRE_TIERS.map(t => {
                const unlocked = total >= t.min;
                return `<span class="tier-badge" style="background:${unlocked?t.color.replace('#',''):'rgba(255,255,255,0.04)'};color:${unlocked?'#0a0a0f':'#6868a0'};border:1px solid ${unlocked?t.color:'rgba(255,255,255,0.08)'};" title="${t.label}: $${(t.min/1000).toFixed(0)}K">${unlocked?t.emoji:'ğŸ”’'}</span>`;
            }).join('');
        }

        // Millionaire rule warnings
        const warnEl = document.getElementById('millionaireRuleWarning');
        if (warnEl) {
            // Check: no single trade > 20% of portfolio
            const largest = Object.keys(portfolio).reduce((mx,sym)=>{
                const st=getStockBySymbol(sym); const v=st?st.price*portfolio[sym]:0; return v>mx?v:mx;
            }, 0);
            const largePct = total > 0 ? largest/total*100 : 0;
            if (largePct > 20) {
                warnEl.style.display = 'block';
                warnEl.textContent = `âš  Max concentration rule: one position is ${largePct.toFixed(0)}% of your portfolio. Millionaire Path requires â‰¤20% per position.`;
            } else {
                warnEl.style.display = 'none';
            }
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MONTHLY CHAMPIONS â€” Hall of Fame
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    async function openChampions() {
        const el = document.getElementById('championsOverlay');
        if (el) el.style.display = 'flex';
        await loadChampions();
    }

    function closeChampions() {
        const el = document.getElementById('championsOverlay');
        if (el) el.style.display = 'none';
    }

    async function saveCurrentChampions() {
        // Called at month end (simulated: called on first open of new month)
        try {
            const storage = ensureStorageAdapter();
            const monthKey = getMonthKey();
            const keys = await storage.list('user:', true);
            if (!keys || !keys.keys) return;
            const users = [];
            for (const k of keys.keys) {
                try { const r = await storage.get(k, true); if(r){ const u=JSON.parse(r.value); if(u.displayName) users.push(u); } } catch(e){}
            }
            // Find top standard and realism users
            const std = users.filter(u=>(u.tradingMode||'standard')==='standard').sort((a,b)=>(b.totalValue||0)-(a.totalValue||0));
            const rls = users.filter(u=>(u.tradingMode||'standard')==='realism').sort((a,b)=>(b.totalValue||0)-(a.totalValue||0));
            const record = {
                month: monthKey,
                standard: std[0] ? { name: std[0].displayName, username: std[0].username, value: std[0].totalValue } : null,
                realism:  rls[0] ? { name: rls[0].displayName, username: rls[0].username, value: rls[0].totalValue } : null,
                savedAt: Date.now()
            };
            await storage.set('champions:' + monthKey, JSON.stringify(record), true);
        } catch(e) {}
    }

    async function loadChampions() {
        const el = document.getElementById('championsList');
        if (!el) return;
        el.innerHTML = '<div style="text-align:center;color:#8888a8;padding:20px 0;">Loadingâ€¦</div>';
        try {
            const storage = ensureStorageAdapter();
            const keys = await storage.list('champions:', true);
            if (!keys || !keys.keys || !keys.keys.length) {
                el.innerHTML = '<div style="text-align:center;color:#8888a8;padding:24px 0;font-size:13px;">No champions recorded yet.<br><span style="font-size:11px;color:#606080;display:block;margin-top:8px;">Champions are recorded at the end of each monthly competition.</span></div>';
                return;
            }
            const records = [];
            for (const k of keys.keys) {
                try { const r = await storage.get(k, true); if(r) records.push(JSON.parse(r.value)); } catch(e){}
            }
            records.sort((a,b) => b.month.localeCompare(a.month));
            el.innerHTML = records.map(r => {
                const d = new Date(r.month + '-01');
                const monthName = d.toLocaleString('default', {month:'long', year:'numeric'});
                return `<div style="margin-bottom:20px;padding-bottom:20px;border-bottom:1px solid rgba(255,255,255,0.06);">
                    <div style="font-size:12px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:12px;">${monthName}</div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                        ${r.standard ? `<div style="background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.2);border-radius:10px;padding:12px;">
                            <div style="font-size:9px;font-weight:700;color:#d4a84b;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸŸ¡ Standard</div>
                            <div style="font-weight:700;color:#f0f0fa;font-size:13px;">${r.standard.name}</div>
                            <div style="font-size:10px;color:#8888a8;margin-top:2px;">@${r.standard.username}</div>
                            <div style="font-family:var(--v-mono);font-size:12px;color:#d4a84b;margin-top:4px;">$${(r.standard.value||0).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        </div>` : '<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;color:#6868a0;font-size:11px;">No Standard entries</div>'}
                        ${r.realism ? `<div style="background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.2);border-radius:10px;padding:12px;">
                            <div style="font-size:9px;font-weight:700;color:#60a5fa;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ”µ Realism</div>
                            <div style="font-weight:700;color:#f0f0fa;font-size:13px;">${r.realism.name}</div>
                            <div style="font-size:10px;color:#8888a8;margin-top:2px;">@${r.realism.username}</div>
                            <div style="font-family:var(--v-mono);font-size:12px;color:#60a5fa;margin-top:4px;">$${(r.realism.value||0).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        </div>` : '<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:12px;color:#6868a0;font-size:11px;">No Realism entries</div>'}
                    </div>
                </div>`;
            }).join('') || '<div style="text-align:center;color:#8888a8;padding:24px 0;">No records found.</div>';
        } catch(e) {
            el.innerHTML = `<div style="color:#f87171;padding:16px 0;">Error: ${e.message}</div>`;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PATCH updateUI to refresh all new panels
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origUpdateUI = updateUI;
    updateUI = function() {
        _origUpdateUI();
        // Throttle expensive recalcs to every 3rd call
        updateUI._callCount = (updateUI._callCount || 0) + 1;
        if (updateUI._callCount % 3 === 0 || updateUI._callCount === 1) {
            refreshAICoach();
            renderPortfolioIntelligence();
            updateMillionairePath();
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MODE LOCK: check if we're in active competition (middle of month)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function checkModeLock() {
        // Lock mode after 7th of month; unlock on 1st
        const day = new Date().getDate();
        _modeLockedUntilMonthEnd = day >= 7;
    }
    checkModeLock();

    // Auto-save champions at end of month (check on login)
    function checkMonthEndChampions() {
        const today = new Date();
        const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1, 0).getDate();
        if (today.getDate() === daysInMonth) {
            // Last day of month â€” save champions
            setTimeout(saveCurrentChampions, 2000);
        }
    }

    // Patch loginAs to also trigger month-end check and update new panels
    const _origLoginAsIntelligence = loginAs;
    loginAs = async function(userData) {
        await _origLoginAsIntelligence(userData);
        checkModeLock();
        checkMonthEndChampions();
        setTimeout(() => {
            refreshAICoach();
            renderPortfolioIntelligence();
            updateMillionairePath();
        }, 600);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  NOTIFICATIONS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let notifications = [];   // { id, type, msg, ts, read }

    function pushNotif(type, msg) {
        const id = Date.now() + '_' + Math.random().toString(36).slice(2,5);
        notifications.unshift({ id, type, msg, ts: Date.now(), read: false });
        notifications = notifications.slice(0, 40);
        renderNotifPanel();
        updateNotifBadge();
    }

    function updateNotifBadge() {
        const unread = notifications.filter(n => !n.read).length;
        const badge = document.getElementById('notifBadge');
        if (!badge) return;
        if (unread > 0) {
            badge.style.display = 'flex';
            badge.textContent = unread > 9 ? '9+' : unread;
        } else {
            badge.style.display = 'none';
        }
    }

    function renderNotifPanel() {
        const el = document.getElementById('notifList');
        if (!el) return;
        if (!notifications.length) {
            el.innerHTML = '<div style="text-align:center;color:#6868a0;font-size:11px;padding:20px;">No notifications yet</div>';
            return;
        }
        const icons = { trade:'ğŸ’¹', alert:'ğŸ””', risk:'ğŸ›¡', rank:'ğŸ†', strategy:'ğŸ§ª', earn:'ğŸ“…', info:'â„¹ï¸' };
        const colors = { trade:'#4ade80', alert:'#f59e0b', risk:'#f87171', rank:'#d4a84b', strategy:'#a78bfa', earn:'#60a5fa', info:'#8888a8' };
        el.innerHTML = notifications.slice(0,20).map(n => {
            const icon  = icons[n.type] || 'ğŸ””';
            const color = colors[n.type] || '#8888a8';
            const ago   = timeAgo(n.ts);
            return `<div class="notif-item" onclick="markNotifRead('${n.id}')" style="${n.read ? 'opacity:0.55' : ''}">
                <div class="notif-dot" style="background:${color};"></div>
                <div style="flex:1;min-width:0;">
                    <div style="font-size:11px;color:#e0e0f5;line-height:1.4;">${icon} ${n.msg}</div>
                    <div style="font-size:9px;color:#6868a0;margin-top:2px;">${ago}</div>
                </div>
            </div>`;
        }).join('');
    }

    function markNotifRead(id) {
        const n = notifications.find(x => x.id === id);
        if (n) n.read = true;
        updateNotifBadge();
        renderNotifPanel();
    }

    function clearAllNotifs() {
        notifications = [];
        renderNotifPanel();
        updateNotifBadge();
    }

    function toggleNotifPanel() {
        const panel = document.getElementById('notifPanel');
        if (!panel) return;
        const open = panel.style.display !== 'none';
        panel.style.display = open ? 'none' : 'block';
        if (!open) {
            notifications.forEach(n => n.read = true);
            setTimeout(() => { updateNotifBadge(); renderNotifPanel(); }, 200);
        }
        // Close theme menu if open
        const tm = document.getElementById('themeMenu');
        if (tm) tm.style.display = 'none';
        document.addEventListener('click', closeNotifOnOutside, { once: true });
    }

    function closeNotifOnOutside(e) {
        if (!e.target.closest('#notifWrap')) {
            const p = document.getElementById('notifPanel');
            if (p) p.style.display = 'none';
        }
    }

    function timeAgo(ts) {
        const s = Math.floor((Date.now() - ts) / 1000);
        if (s < 60) return 'just now';
        if (s < 3600) return Math.floor(s/60) + 'm ago';
        if (s < 86400) return Math.floor(s/3600) + 'h ago';
        return Math.floor(s/86400) + 'd ago';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  THEME SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let activeTheme = 'dark';

    function applyTheme(theme) {
        const body = document.body;
        body.classList.remove('theme-blue', 'theme-green', 'theme-white', 'light-mode');
        if (theme === 'blue')  body.classList.add('theme-blue');
        if (theme === 'green') body.classList.add('theme-green');
        if (theme === 'white') { body.classList.add('light-mode'); }
        activeTheme = theme;
        if (currentUser) { currentUser.theme = theme; saveUserData(false); }
        localStorage.setItem('vestra_theme', theme);
        const tm = document.getElementById('themeMenu');
        if (tm) tm.style.display = 'none';
        // Update theme toggle icon
        const icons = { dark:'ğŸŒ‘', blue:'ğŸŒŠ', green:'ğŸ’¹', white:'â˜€ï¸' };
        const btn = document.getElementById('themeToggle');
        if (btn) btn.textContent = icons[theme] || 'ğŸ¨';
        document.querySelectorAll('.theme-opt').forEach(b => {
            b.style.fontWeight = b.dataset.theme === theme ? '800' : '400';
            b.style.color = b.dataset.theme === theme ? '#f0f0fa' : '';
        });
    }

    function toggleThemeMenu() {
        const tm = document.getElementById('themeMenu');
        if (!tm) return;
        const open = tm.style.display !== 'none';
        tm.style.display = open ? 'none' : 'block';
        const np = document.getElementById('notifPanel');
        if (np) np.style.display = 'none';
        if (!open) document.addEventListener('click', e => {
            if (!e.target.closest('#themeWrap')) tm.style.display = 'none';
        }, { once: true });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  RISK GUARD SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let riskGuardCfg = {
        maxRiskEnabled: false, maxRisk: 2,
        dailyLossEnabled: false, dailyLoss: 3,
        maxPosEnabled: false, maxPos: 5,
        consecEnabled: false, consecLoss: 3
    };
    let _consecLosses = 0;  // running count
    let _dailyStartValue = 100000;  // portfolio value at day start
    let _dailyStartDate = '';

    function loadRiskGuardCfg() {
        const saved = currentUser && currentUser.riskGuardCfg;
        if (saved) riskGuardCfg = { ...riskGuardCfg, ...saved };
        applyRiskGuardToUI();
    }

    function applyRiskGuardToUI() {
        const f = id => document.getElementById(id);
        if (f('rgMaxRiskEnabled'))  f('rgMaxRiskEnabled').checked  = riskGuardCfg.maxRiskEnabled;
        if (f('rgDailyLossEnabled'))f('rgDailyLossEnabled').checked = riskGuardCfg.dailyLossEnabled;
        if (f('rgMaxPosEnabled'))   f('rgMaxPosEnabled').checked    = riskGuardCfg.maxPosEnabled;
        if (f('rgConsecEnabled'))   f('rgConsecEnabled').checked     = riskGuardCfg.consecEnabled;
        if (f('rgMaxRisk'))  f('rgMaxRisk').value  = riskGuardCfg.maxRisk;
        if (f('rgDailyLoss'))f('rgDailyLoss').value = riskGuardCfg.dailyLoss;
        if (f('rgMaxPos'))   f('rgMaxPos').value    = riskGuardCfg.maxPos;
        if (f('rgConsecLoss'))f('rgConsecLoss').value= riskGuardCfg.consecLoss;
    }

    function saveRiskGuard() {
        const f = id => document.getElementById(id);
        riskGuardCfg.maxRiskEnabled  = f('rgMaxRiskEnabled')  ? f('rgMaxRiskEnabled').checked  : false;
        riskGuardCfg.dailyLossEnabled= f('rgDailyLossEnabled')? f('rgDailyLossEnabled').checked : false;
        riskGuardCfg.maxPosEnabled   = f('rgMaxPosEnabled')   ? f('rgMaxPosEnabled').checked    : false;
        riskGuardCfg.consecEnabled   = f('rgConsecEnabled')   ? f('rgConsecEnabled').checked    : false;
        riskGuardCfg.maxRisk  = parseFloat(f('rgMaxRisk')?.value || 2);
        riskGuardCfg.dailyLoss= parseFloat(f('rgDailyLoss')?.value || 3);
        riskGuardCfg.maxPos   = parseInt(f('rgMaxPos')?.value || 5, 10);
        riskGuardCfg.consecLoss= parseInt(f('rgConsecLoss')?.value || 3, 10);
        if (currentUser) { currentUser.riskGuardCfg = { ...riskGuardCfg }; saveUserData(false); }
        updateRGStatus();
    }

    function updateRGStatus() {
        const el = document.getElementById('riskGuardStatus');
        if (!el) return;
        const active = riskGuardCfg.maxRiskEnabled || riskGuardCfg.dailyLossEnabled || riskGuardCfg.maxPosEnabled || riskGuardCfg.consecEnabled;
        el.style.background = active ? 'rgba(74,222,128,0.08)' : 'rgba(255,255,255,0.04)';
        el.style.borderColor = active ? 'rgba(74,222,128,0.2)' : 'rgba(255,255,255,0.08)';
        el.style.color = active ? '#4ade80' : '#8888a8';
        el.innerHTML = active ? 'âœ“ Risk Guard active â€” monitoring your trades' : 'â„¹ Risk Guard disabled â€” no rules enforced';
    }

    // Returns null (ok) or an error string (blocked)
    function checkRGBeforeTrade(side, stock, qty) {
        const portfolioVal = (currentUser && currentUser.totalValue) || (cash + 100000);

        // Reset daily tracking
        const today = new Date().toDateString();
        if (_dailyStartDate !== today) {
            _dailyStartDate = today;
            _dailyStartValue = portfolioVal;
        }

        // 1. Max risk per trade
        if (riskGuardCfg.maxRiskEnabled && side === 'BUY') {
            const tradeCost = (stock.price || 0) * qty;
            const riskPct = (tradeCost / portfolioVal) * 100;
            if (riskPct > riskGuardCfg.maxRisk) {
                return `ğŸ›¡ Risk Guard: This trade is ${riskPct.toFixed(1)}% of your portfolio. Your max is ${riskGuardCfg.maxRisk}%. Reduce position size.`;
            }
        }

        // 2. Daily loss limit
        if (riskGuardCfg.dailyLossEnabled) {
            const dailyLossPct = ((_dailyStartValue - portfolioVal) / _dailyStartValue) * 100;
            if (dailyLossPct >= riskGuardCfg.dailyLoss) {
                return `ğŸ›¡ Risk Guard: Daily loss limit of ${riskGuardCfg.dailyLoss}% reached (current: ${dailyLossPct.toFixed(1)}%). Trading paused for today.`;
            }
        }

        // 3. Max open positions
        if (riskGuardCfg.maxPosEnabled && side === 'BUY') {
            const openPositions = Object.keys(portfolio).filter(s => (portfolio[s] || 0) > 0).length;
            if (openPositions >= riskGuardCfg.maxPos) {
                return `ğŸ›¡ Risk Guard: You have ${openPositions} open positions. Your max is ${riskGuardCfg.maxPos}. Close a position first.`;
            }
        }

        // 4. Consecutive loss limit
        if (riskGuardCfg.consecEnabled && side === 'BUY') {
            if (_consecLosses >= riskGuardCfg.consecLoss) {
                return `ğŸ›¡ Risk Guard: ${_consecLosses} consecutive losses detected. Take a break before your next trade.`;
            }
        }

        return null;
    }

    function trackTradeOutcome(profit) {
        if (profit < 0) {
            _consecLosses++;
        } else {
            _consecLosses = 0;
        }
    }

    function openRiskGuard() {
        const el = document.getElementById('riskGuardModal');
        if (el) { el.style.display = 'flex'; loadRiskGuardCfg(); updateRGStatus(); }
    }
    function closeRiskGuard() {
        const el = document.getElementById('riskGuardModal');
        if (el) el.style.display = 'none';
    }

    // Patch executeConfirmedTrade to check Risk Guard
    const _origExecConfirmed = executeConfirmedTrade;
    executeConfirmedTrade = function() {
        const pt = _pendingConfirmTrade;
        if (pt) {
            const err = checkRGBeforeTrade(pt.side, pt.stock, pt.qty);
            if (err) {
                cancelTradeConfirm();
                pushNotif('risk', err.replace('ğŸ›¡ Risk Guard: ', ''));
                // Show modal
                const warn = document.createElement('div');
                warn.style.cssText = 'position:fixed;inset:0;z-index:20000;background:rgba(0,0,0,0.7);display:flex;align-items:center;justify-content:center;';
                warn.innerHTML = `<div style="background:#14141e;border:2px solid rgba(239,68,68,0.4);border-radius:16px;padding:28px 32px;max-width:420px;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">
                    <div style="font-size:1.5rem;margin-bottom:10px;">ğŸ›¡</div>
                    <div style="font-weight:700;color:#f0f0fa;font-size:1rem;margin-bottom:8px;">Risk Guard Blocked</div>
                    <div style="font-size:13px;color:#c0c0d8;line-height:1.6;margin-bottom:18px;">${err}</div>
                    <button onclick="this.closest('div[style*=fixed]').remove()" style="background:#ef4444;color:#fff;border:none;border-radius:8px;padding:10px 20px;font-weight:700;cursor:pointer;font-size:13px;">Understood</button>
                </div>`;
                document.body.appendChild(warn);
                return;
            }
        }
        _origExecConfirmed();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STRATEGY LAB SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let strategies = [];   // [{ id, name, tag, entry, exit, risk, trades:[], createdAt }]

    function openStrategyLab() {
        const el = document.getElementById('strategyLabModal');
        if (el) { el.style.display = 'flex'; renderStrategyList(); }
    }
    function closeStrategyLab() {
        const el = document.getElementById('strategyLabModal');
        if (el) el.style.display = 'none';
    }

    function createStrategy() {
        const name  = (document.getElementById('slName')?.value || '').trim();
        const tag   = document.getElementById('slTag')?.value || '#Breakout';
        const entry = (document.getElementById('slEntry')?.value || '').trim();
        const exit  = (document.getElementById('slExit')?.value  || '').trim();
        const risk  = parseFloat(document.getElementById('slRisk')?.value || '1');
        if (!name) return;
        const s = { id:'strat_'+Date.now(), name, tag, entry, exit, risk, trades:[], createdAt:Date.now(), active:true };
        strategies.push(s);
        saveStrategies();
        renderStrategyList();
        // Clear form
        ['slName','slEntry','slExit'].forEach(id => { const el=document.getElementById(id); if(el)el.value=''; });
        pushNotif('strategy', `Strategy "${name}" created. Tag your trades with "${tag}".`);
    }

    function deleteStrategy(id) {
        strategies = strategies.filter(s => s.id !== id);
        saveStrategies();
        renderStrategyList();
    }

    function saveStrategies() {
        if (currentUser) { currentUser.strategies = strategies; saveUserData(false); }
    }

    function loadStrategies() {
        strategies = (currentUser && Array.isArray(currentUser.strategies)) ? currentUser.strategies : [];
    }

    function getStrategyStats(s) {
        const sells = (transactions||[]).filter(t => t.type==='SELL' && t.strategyId===s.id);
        const wins   = sells.filter(t => (t.price - (t.avgBuy||t.price)) > 0);
        const winRate = sells.length > 0 ? (wins.length/sells.length*100).toFixed(0) : 'â€”';
        const avgR   = sells.length > 0
            ? (sells.reduce((sum,t)=>{ const r=(t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100; return sum+r; },0)/sells.length).toFixed(1)
            : 'â€”';
        return { winRate, avgR, count:sells.length };
    }

    function renderStrategyList() {
        const el = document.getElementById('strategyList');
        if (!el) return;
        if (!strategies.length) {
            el.innerHTML = '<div style="text-align:center;color:#6868a0;padding:20px;font-style:italic;font-size:12px;">No strategies yet. Create one above.</div>';
            return;
        }
        const tagColors = { '#Breakout':'#60a5fa','#Swing':'#4ade80','#Earnings':'#f59e0b','#Momentum':'#a78bfa','#Reversal':'#f87171','#Scalp':'#f0c96a','#ValueBuy':'#34d399','#DipBuy':'#fb923c' };
        el.innerHTML = strategies.map(s => {
            const stats = getStrategyStats(s);
            const tagC  = tagColors[s.tag] || '#8888a8';
            const wc    = stats.winRate !== 'â€”' ? (parseInt(stats.winRate)>=50?'#4ade80':'#f87171') : '#8888a8';
            const rc    = stats.avgR !== 'â€”' ? (parseFloat(stats.avgR)>=0?'#4ade80':'#f87171') : '#8888a8';
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:14px 16px;display:grid;grid-template-columns:1fr auto;gap:10px;align-items:start;">
                <div>
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                        <span style="font-weight:700;color:#f0f0fa;font-size:13px;">${s.name}</span>
                        <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:${tagC}18;color:${tagC};border:1px solid ${tagC}28;">${s.tag}</span>
                        <span style="font-size:10px;color:#6868a0;">Risk: ${s.risk}%</span>
                    </div>
                    ${s.entry ? `<div style="font-size:10px;color:#8888a8;margin-bottom:2px;">â–¶ Entry: ${s.entry}</div>` : ''}
                    ${s.exit  ? `<div style="font-size:10px;color:#8888a8;margin-bottom:6px;">â—€ Exit: ${s.exit}</div>` : ''}
                    <div style="display:flex;gap:16px;font-size:11px;">
                        <span style="color:#8888a8;">Trades: <strong style="color:#f0f0fa;">${stats.count}</strong></span>
                        <span style="color:#8888a8;">Win: <strong style="color:${wc};">${stats.winRate}${stats.winRate!=='â€”'?'%':''}</strong></span>
                        <span style="color:#8888a8;">Avg R: <strong style="color:${rc};">${stats.avgR}${stats.avgR!=='â€”'?'%':''}</strong></span>
                    </div>
                </div>
                <button onclick="deleteStrategy('${s.id}')" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#f87171;border-radius:6px;padding:4px 9px;font-size:11px;cursor:pointer;">Delete</button>
            </div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MACRO MARKET OVERVIEW
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openMacro() {
        const el = document.getElementById('macroModal');
        if (el) { el.style.display = 'flex'; renderMacro(); }
    }
    function closeMacro() {
        const el = document.getElementById('macroModal');
        if (el) el.style.display = 'none';
    }

    function renderMacro() {
        if (!stocks || !stocks.length) return;
        // Major indices (simulated from stock prices)
        const sorted  = [...stocks].sort((a,b) => b.change - a.change);
        const gainers = sorted.slice(0,5);
        const losers  = sorted.slice(-5).reverse();
        const byVol   = [...stocks].sort((a,b) => (b.volume||0)-(a.volume||0)).slice(0,5);

        // Indices grid (4 representative benchmarks simulated)
        const indices = [
            { name:'S&P 500',  val: 5280 + stocks.reduce((s,x)=>s+x.change,0)/stocks.length*8,  chg: (stocks.reduce((s,x)=>s+x.change,0)/stocks.length*0.6).toFixed(2) },
            { name:'NASDAQ',   val: 16800 + stocks.filter(x=>['AAPL','MSFT','NVDA','GOOGL','META'].includes(x.symbol)).reduce((s,x)=>s+x.change,0)*15, chg: (stocks.filter(x=>['AAPL','MSFT','NVDA'].includes(x.symbol)).reduce((s,x)=>s+x.change,0)/3*0.8).toFixed(2) },
            { name:'DOW',      val: 39200 + stocks.reduce((s,x)=>s+x.change,0)/stocks.length*20, chg: (stocks.reduce((s,x)=>s+x.change,0)/stocks.length*0.5).toFixed(2) },
            { name:'VIX',      val: (18 - stocks.reduce((s,x)=>s+x.change,0)/stocks.length).toFixed(1), chg: (-stocks.reduce((s,x)=>s+x.change,0)/stocks.length*0.3).toFixed(2) }
        ];

        const indEl = document.getElementById('macroIndices');
        if (indEl) indEl.innerHTML = indices.map(x => {
            const c = parseFloat(x.chg) >= 0;
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;text-align:center;">
                <div style="font-size:9px;color:#8888a8;font-weight:700;text-transform:uppercase;margin-bottom:4px;">${x.name}</div>
                <div style="font-family:var(--v-mono);font-size:14px;font-weight:600;color:#f0f0fa;">${typeof x.val==='number'?x.val.toFixed(0):x.val}</div>
                <div style="font-size:11px;color:${c?'#4ade80':'#f87171'};font-weight:600;">${c?'+':''}${x.chg}%</div>
            </div>`;
        }).join('');

        // Sentiment score based on % of stocks up
        const upCount = stocks.filter(s => s.change >= 0).length;
        const sentimentScore = Math.round((upCount / stocks.length) * 100);
        const sentLabel = sentimentScore >= 75 ? 'Extreme Greed' : sentimentScore >= 60 ? 'Greed' : sentimentScore >= 45 ? 'Neutral' : sentimentScore >= 30 ? 'Fear' : 'Extreme Fear';
        const sentLabelEl = document.getElementById('sentimentLabel');
        const sentScoreEl = document.getElementById('sentimentScore');
        const sentNeedle  = document.getElementById('sentimentNeedle');
        if (sentLabelEl) sentLabelEl.textContent = sentLabel;
        if (sentScoreEl) { sentScoreEl.textContent = sentimentScore; sentScoreEl.style.color = sentimentScore >= 60 ? '#4ade80' : sentimentScore >= 40 ? '#f59e0b' : '#f87171'; }
        if (sentNeedle)  sentNeedle.style.left = sentimentScore + '%';

        // Breadth
        const downCount = stocks.length - upCount;
        const bEl = document.getElementById('macroBreath');
        if (bEl) bEl.innerHTML = [
            { label:'Advancing', val: upCount,   color:'#4ade80' },
            { label:'Declining', val: downCount,  color:'#f87171' },
            { label:'Unchanged', val: stocks.filter(s=>s.change===0).length, color:'#8888a8' },
            { label:'New High',  val: stocks.filter(s=>s.change>=3).length,  color:'#60a5fa' }
        ].map(b => `<div style="display:flex;justify-content:space-between;align-items:center;">
            <span style="font-size:11px;color:#8888a8;">${b.label}</span>
            <span style="font-family:var(--v-mono);font-size:12px;font-weight:700;color:${b.color};">${b.val}</span>
        </div>`).join('');

        // Sector heatmap
        const sectors = {};
        stocks.forEach(s => {
            const sec = s.sector || inferSector(s.symbol, s.name);
            if (!sectors[sec]) sectors[sec] = { total:0, count:0 };
            sectors[sec].total += s.change;
            sectors[sec].count++;
        });
        const secEl = document.getElementById('macroSectorHeat');
        if (secEl) secEl.innerHTML = Object.entries(sectors).map(([sec,v]) => {
            const avg = v.count>0 ? v.total/v.count : 0;
            const bg = avg>2?'rgba(34,197,94,0.5)':avg>0.5?'rgba(34,197,94,0.25)':avg>0?'rgba(34,197,94,0.1)':avg>-0.5?'rgba(239,68,68,0.1)':avg>-2?'rgba(239,68,68,0.25)':'rgba(239,68,68,0.5)';
            return `<div class="sector-heat-cell" style="background:${bg};" title="${sec}: ${avg>=0?'+':''}${avg.toFixed(1)}%">
                <div style="font-size:9px;font-weight:700;color:#e0e0f5;">${sec.slice(0,6)}</div>
                <div style="font-size:10px;font-weight:700;color:${avg>=0?'#4ade80':'#f87171'};">${avg>=0?'+':''}${avg.toFixed(1)}%</div>
            </div>`;
        }).join('');

        // Gainers / Losers / Volume
        const moverRow = s => `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
            <span style="font-weight:700;color:#f0f0fa;font-size:11px;">${s.symbol}</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:${s.change>=0?'#4ade80':'#f87171'};">${s.change>=0?'+':''}${s.change.toFixed(2)}%</span>
        </div>`;
        const gEl=document.getElementById('macroGainers'); if(gEl) gEl.innerHTML=gainers.map(moverRow).join('');
        const lEl=document.getElementById('macroLosers');  if(lEl) lEl.innerHTML=losers.map(moverRow).join('');
        const vEl=document.getElementById('macroVolume');
        if (vEl) vEl.innerHTML = byVol.map(s => `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
            <span style="font-weight:700;color:#f0f0fa;font-size:11px;">${s.symbol}</span>
            <span style="font-family:var(--v-mono);font-size:11px;color:#f59e0b;">${s.volume ? (s.volume/1e6).toFixed(1)+'M' : 'High'}</span>
        </div>`).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TRADER PROGRESS DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openTraderProgress() {
        const el = document.getElementById('progressModal');
        if (el) { el.style.display = 'flex'; renderProgress(); loadReflections(); }
    }
    function closeProgress() {
        const el = document.getElementById('progressModal');
        if (el) el.style.display = 'none';
    }

    function renderProgress() {
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        const buys  = (transactions||[]).filter(t=>t.type==='BUY');
        const wins  = sells.filter(t=>(t.price-(t.avgBuy||t.price))>0);
        const portfolioVal = (currentUser&&currentUser.totalValue)||cash;
        const totalDays = perfHistory.length > 0
            ? Math.max(1, Math.round((Date.now() - perfHistory[0].ts) / 86400000)) : 1;
        const avgHold = sells.length > 0
            ? sells.reduce((s,t)=>{ const buysForSym=(transactions||[]).filter(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts); return s+(buysForSym.length?t.ts-buysForSym[buysForSym.length-1].ts:0); },0)/sells.length/3600000
            : 0;

        const stats = [
            { label:'Trading Days', val: totalDays, unit:'', color:'#60a5fa' },
            { label:'Total Trades', val: sells.length + buys.length, unit:'', color:'#a78bfa' },
            { label:'Win Rate', val: sells.length>0?(wins.length/sells.length*100).toFixed(0):'â€”', unit:'%', color:'#4ade80' },
            { label:'Avg Hold', val: avgHold>24?((avgHold/24).toFixed(1)):avgHold.toFixed(1), unit: avgHold>24?'d':'h', color:'#f59e0b' }
        ];

        const statsEl = document.getElementById('progressStats');
        if (statsEl) statsEl.innerHTML = stats.map(s => `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;text-align:center;">
            <div style="font-size:8px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">${s.label}</div>
            <div style="font-family:var(--v-mono);font-size:1.2rem;font-weight:700;color:${s.color};">${s.val}<span style="font-size:0.8rem;">${s.unit}</span></div>
        </div>`).join('');

        // Long vs Short Bias
        const longTrades  = buys.length;
        const shortTrades = 0; // simulator is long-only
        const biasEl = document.getElementById('progressBias');
        if (biasEl) {
            const totalBias = longTrades + shortTrades || 1;
            const longPct = (longTrades/totalBias*100).toFixed(0);
            biasEl.innerHTML = `
            <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:5px;"><span style="color:#4ade80;">Long Bias</span><span style="color:#4ade80;font-weight:700;">${longPct}%</span></div>
            <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
                <div style="height:100%;width:${longPct}%;background:linear-gradient(90deg,#4ade80,#22c55e);border-radius:4px;transition:width 0.5s;"></div>
            </div>
            <div style="font-size:10px;color:#8888a8;margin-top:6px;">This simulator supports long positions only. Bias towards long holds is a healthy pattern.</div>`;
        }

        // Risk consistency chart (bar chart of trade sizes)
        const riskEl = document.getElementById('progressRiskChart');
        if (riskEl && buys.length > 0) {
            const recent = buys.slice(-20);
            const maxCost = Math.max(...recent.map(t=>(t.price||0)*(t.qty||1))) || 1;
            riskEl.innerHTML = recent.map(t => {
                const cost = (t.price||0)*(t.qty||1);
                const h = Math.max(6, (cost/maxCost)*72);
                const c = cost/portfolioVal > 0.2 ? '#f87171' : cost/portfolioVal > 0.1 ? '#f59e0b' : '#4ade80';
                return `<div title="${t.symbol}: $${cost.toFixed(0)}" style="flex:1;background:${c};border-radius:3px 3px 0 0;min-width:6px;height:${h}px;transition:height 0.3s;"></div>`;
            }).join('');
        } else if (riskEl) {
            riskEl.innerHTML = '<div style="color:#6868a0;font-size:11px;font-style:italic;">No trades yet.</div>';
        }
    }

    function loadReflections() {
        const saved = currentUser && currentUser.weeklyReflection;
        if (!saved) return;
        const lEl = document.getElementById('reflectLearn');
        const mEl = document.getElementById('reflectMistake');
        if (lEl) lEl.value = saved.learn || '';
        if (mEl) mEl.value = saved.mistake || '';
    }

    function saveReflection() {
        const learn   = document.getElementById('reflectLearn')?.value || '';
        const mistake = document.getElementById('reflectMistake')?.value || '';
        if (currentUser) {
            currentUser.weeklyReflection = { learn, mistake, savedAt: Date.now() };
            saveUserData(false);
        }
        pushNotif('info', 'ğŸ““ Weekly reflection saved. Keep reflecting to improve.');
        showTradeToast('INFO', 0, 'Reflection saved âœ“', 0, true);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  API HEALTH + DATA FRESHNESS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _lastDataFresh = Date.now();

    function updateAPIHealthDot(live) {
        const dot = document.getElementById('apiHealthDot');
        if (!dot) return;
        if (live) {
            dot.style.background = '#4ade80';
            dot.classList.add('live');
        } else {
            dot.style.background = '#6b7280';
            dot.classList.remove('live');
        }
    }

    function updateDataFreshness() {
        const ageS = Math.floor((Date.now() - _lastDataFresh) / 1000);
        const badge = document.getElementById('dataSourceBadge');
        if (!badge) return;
        if (ageS < 30)      badge.title = 'Data fresh (< 30s)';
        else if (ageS < 120) badge.title = 'Data ' + ageS + 's old';
        else                 badge.title = 'Data stale â€” price may be delayed';
    }

    // Patch updateUI to update freshness + API health
    const _origUpdateUIHealth = updateUI;
    updateUI = function() {
        _origUpdateUIHealth();
        updateDataFreshness();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SMART NOTIFICATIONS â€” wire into trading events
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Patch showTradeToast to also push notifications
    const _origShowTradeToast = showTradeToast;
    showTradeToast = function(type, qty, sym, price, isPending) {
        _origShowTradeToast(type, qty, sym, price, isPending);
        if (type === 'BUY' && !isPending)
            pushNotif('trade', `Bought ${qty} Ã— ${sym} @ $${Number(price||0).toFixed(2)}`);
        else if (type === 'SELL' && !isPending)
            pushNotif('trade', `Sold ${qty} Ã— ${sym} @ $${Number(price||0).toFixed(2)}`);
        else if (isPending)
            pushNotif('alert', `${type} order placed for ${qty} Ã— ${sym} @ $${Number(price||0).toFixed(2)}`);
    };

    // Patch executeOrderNow to track consecutive losses & notify on RG limit
    const _origExecuteOrderNow = executeOrderNow;
    executeOrderNow = function(order, fillPrice, fromPending) {
        const result = _origExecuteOrderNow(order, fillPrice, fromPending);
        if (result && order.side === 'SELL') {
            const cb = costBasis[order.symbol];
            const avg = cb && cb.shares ? cb.totalCost/cb.shares : fillPrice;
            const pl = (fillPrice - avg) * (order.qty || 1);
            trackTradeOutcome(pl);
            if (pl < 0 && _consecLosses >= (riskGuardCfg.consecLoss || 3) && riskGuardCfg.consecEnabled) {
                pushNotif('risk', `${_consecLosses} consecutive losses. Risk Guard recommends a break.`);
            }
        }
        return result;
    };

    // Patch loginAs chain to load all new state
    const _origLoginAsSystems = loginAs;
    loginAs = async function(userData) {
        await _origLoginAsSystems(userData);
        loadStrategies();
        loadRiskGuardCfg();
        // Restore theme
        const savedTheme = (currentUser && currentUser.theme) || localStorage.getItem('vestra_theme') || 'dark';
        applyTheme(savedTheme);
        // Welcome notification
        setTimeout(() => {
            pushNotif('info', `Welcome back, ${currentUser?.displayName || 'Trader'}! Markets are ${isMarketHoursNow() ? 'open ğŸŸ¢' : 'closed ğŸ”´'}.`);
        }, 1000);
        // Update API health dot
        updateAPIHealthDot(!!window.RT && !!window.RT.key);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  TRADE REPLAY ENGINE ğŸ¬
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let replayActive   = false;
    let replayCandles  = [];   // full historical candle array
    let replayCursor   = 0;    // current visible index
    let replayTimer    = null;
    let replayPlaying  = false;

    function openReplayMode() {
        if (!detailStock) return;
        // We need candlestick data â€” use whatever is cached in the chart
        if (!sChart || !sChart.data || !sChart.data.datasets[0] || !sChart.data.datasets[0].data.length) {
            showTradeToast('INFO', 0, 'Load a chart period first, then start Replay.', 0, true);
            return;
        }
        replayCandles = [...sChart.data.datasets[0].data];
        if (replayCandles.length < 5) {
            showTradeToast('INFO', 0, 'Not enough candle data for replay.', 0, true);
            return;
        }
        replayCursor  = Math.max(5, Math.floor(replayCandles.length * 0.3));
        replayActive  = true;
        replayPlaying = false;
        const bar = document.getElementById('replayBar');
        if (bar) bar.style.display = 'flex';
        updateReplayChart();
        pushNotif('info', 'ğŸ¬ Replay mode started. Practice trading on historical data.');
    }

    function closeReplayMode() {
        replayActive  = false;
        replayPlaying = false;
        clearInterval(replayTimer);
        replayTimer   = null;
        const bar = document.getElementById('replayBar');
        if (bar) bar.style.display = 'none';
        const btn = document.getElementById('replayPlayBtn');
        if (btn) btn.textContent = 'â–¶ Play';
        // Restore full chart
        if (detailStock) drawChart(detailStock, currentChartPeriod);
    }

    function updateReplayChart() {
        if (!replayActive || !sChart) return;
        const visible = replayCandles.slice(0, replayCursor + 1);
        sChart.data.datasets[0].data = visible;
        if (sChart.data.datasets[1]) {
            const volAll = sChart.data.datasets[1].data;
            sChart.data.datasets[1].data = Array.isArray(volAll) ? volAll.slice(0, replayCursor + 1) : [];
        }
        sChart.update('none');

        // Update labels
        const cur = replayCandles[replayCursor];
        const dateEl = document.getElementById('replayDateLabel');
        const idxEl  = document.getElementById('replayCandleIdx');
        if (dateEl && cur) {
            const d = new Date(cur.x || cur.t || 0);
            dateEl.textContent = d.toLocaleDateString('en-US', {month:'short', day:'numeric', hour:'2-digit', minute:'2-digit'});
        }
        if (idxEl) idxEl.textContent = `Candle ${replayCursor+1} / ${replayCandles.length}`;
    }

    function replayStep(dir) {
        replayCursor = Math.max(4, Math.min(replayCandles.length-1, replayCursor + dir));
        updateReplayChart();
    }

    function toggleReplayPlay() {
        replayPlaying = !replayPlaying;
        const btn = document.getElementById('replayPlayBtn');
        if (btn) btn.textContent = replayPlaying ? 'â¸ Pause' : 'â–¶ Play';
        if (replayPlaying) {
            const speed = parseInt(document.getElementById('replaySpeed')?.value || '500', 10);
            clearInterval(replayTimer);
            replayTimer = setInterval(() => {
                if (replayCursor >= replayCandles.length - 1) {
                    replayPlaying = false;
                    clearInterval(replayTimer);
                    if (btn) btn.textContent = 'â–¶ Play';
                    return;
                }
                replayCursor++;
                updateReplayChart();
            }, speed);
        } else {
            clearInterval(replayTimer);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STRATEGY SELECTOR in trade panel
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function populateStrategySelector() {
        const sel = document.getElementById('tradeStrategyTag');
        if (!sel) return;
        sel.innerHTML = '<option value="">No strategy</option>' +
            strategies.map(s => `<option value="${s.id}">${s.name} ${s.tag}</option>`).join('');
    }

    // Patch openStockDetail to populate strategy selector
    const _origOpenStockDetailReplay = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetailReplay(stock);
        setTimeout(populateStrategySelector, 200);
    };

    // Patch executeConfirmedTrade chain to tag trades with strategy
    const _origExecConfirmedStrategy = executeConfirmedTrade;
    executeConfirmedTrade = function() {
        const stratId = document.getElementById('tradeStrategyTag')?.value || '';
        // We'll tag the trade by hooking into the next transaction push
        _pendingStrategyId = stratId;
        _origExecConfirmedStrategy();
    };

    let _pendingStrategyId = '';

    // Patch executeOrderNow to stamp strategy
    const _origExecOrderNowStrat = executeOrderNow;
    executeOrderNow = function(order, fillPrice, fromPending) {
        if (_pendingStrategyId) {
            order = { ...order, strategyId: _pendingStrategyId };
        }
        const res = _origExecOrderNowStrat(order, fillPrice, fromPending);
        _pendingStrategyId = '';
        return res;
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PERFORMANCE BADGE SYSTEM ğŸ…
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const PERF_BADGES = [
        { id:'green10',   emoji:'ğŸŒ±', label:'10 Green Days',       desc:'10 profitable trading days',       check: u => (u._greenDays||0)>=10 },
        { id:'fiveR',     emoji:'âš¡', label:'5R Trade',             desc:'Single trade with 5Ã— R-multiple',  check: u => (u._best5R||0)>=5 },
        { id:'month20',   emoji:'ğŸš€', label:'20% Month',            desc:'20%+ return in a calendar month',  check: u => (u._bestMonthReturn||0)>=20 },
        { id:'noViolate', emoji:'ğŸ›¡', label:'Zero Violations',      desc:'Month with no Risk Guard alerts',  check: u => (u._monthNoViolation||false) },
        { id:'discipline80',emoji:'ğŸ¯',label:'Discipline 80',      desc:'Discipline score â‰¥ 80',            check: u => (u.disciplineScore||0)>=80 },
        { id:'win60',     emoji:'ğŸ’°', label:'60% Win Rate',         desc:'60%+ win rate over 20+ trades',   check: u => (u.totalTrades||0)>=20 && (u._winRate||0)>=60 },
        { id:'hold7',     emoji:'ğŸ¦', label:'Patient Trader',       desc:'Avg hold time > 7 days',          check: u => (u._avgHoldDays||0)>7 },
        { id:'million',   emoji:'ğŸ’', label:'Millionaire',          desc:'Portfolio reached $1,000,000',    check: u => (u.totalValue||0)>=1000000 },
    ];

    function computeAndSaveBadges() {
        if (!currentUser) return;
        const sells = (transactions||[]).filter(t=>t.type==='SELL');

        // Green days (days with profit)
        const dayPL = {};
        sells.forEach(t => { const d=dayKey(t.ts); dayPL[d]=(dayPL[d]||0)+(t.price-(t.avgBuy||t.price))*(t.qty||1); });
        currentUser._greenDays = Object.values(dayPL).filter(v=>v>0).length;

        // Best R-multiple
        const bestR = sells.reduce((mx,t)=>{
            const risk = (t.slPrice||0) ? Math.abs(t.price-t.slPrice) : (t.avgBuy||t.price)*0.02;
            const reward = Math.abs(t.price-(t.avgBuy||t.price));
            const r = risk>0?reward/risk:0;
            return r>mx?r:mx;
        },0);
        currentUser._best5R = bestR;

        // Win rate
        const wins = sells.filter(t=>(t.price-(t.avgBuy||t.price))>0);
        currentUser._winRate = sells.length>0?(wins.length/sells.length*100):0;

        // Avg hold time
        const holds = sells.map(t=>{ const b=(transactions||[]).filter(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts); return b.length?t.ts-b[b.length-1].ts:0; }).filter(Boolean);
        currentUser._avgHoldDays = holds.length>0?holds.reduce((a,b)=>a+b,0)/holds.length/86400000:0;

        // Best month return
        const monthlyVals = {};
        (perfHistory||[]).forEach(p=>{ const d=new Date(p.ts||Date.now()); const mk=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); monthlyVals[mk]=monthlyVals[mk]||[]; monthlyVals[mk].push(p.value||100000); });
        const monthReturns = Object.values(monthlyVals).map(vals=>vals.length>1?(vals[vals.length-1]-vals[0])/vals[0]*100:0);
        currentUser._bestMonthReturn = monthReturns.length?Math.max(...monthReturns):0;

        // Unlock badges
        const earned = PERF_BADGES.filter(b=>b.check(currentUser)).map(b=>b.id);
        const prev = currentUser.badges || [];
        const newOnes = earned.filter(id=>!prev.includes(id));
        currentUser.badges = earned;
        // Notify on new badge
        newOnes.forEach(id=>{
            const b = PERF_BADGES.find(x=>x.id===id);
            if(b) pushNotif('rank', `ğŸ… New Badge Unlocked: "${b.label}" â€” ${b.desc}`);
        });
    }

    function renderBadgesInCommunity() {
        const el = document.getElementById('myBadgeList');
        if (!el || !currentUser) return;
        const earned = currentUser.badges || [];
        if (!earned.length) { el.innerHTML = '<span style="font-size:10px;color:#6868a0;font-style:italic;">Trade to earn badges</span>'; return; }
        el.innerHTML = PERF_BADGES.filter(b=>earned.includes(b.id)).map(b=>`<span title="${b.label}: ${b.desc}" style="font-size:14px;cursor:default;" class="perf-badge">${b.emoji}</span>`).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  COMMUNITY 2.0 â€” strategy tags, filters, copy idea, follow
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let communityFilter = 'all';
    const TAG_COLORS = { '#Breakout':'#60a5fa','#Swing':'#4ade80','#Earnings':'#f59e0b','#Momentum':'#a78bfa','#Reversal':'#f87171','#Scalp':'#f0c96a','#ValueBuy':'#34d399','#DipBuy':'#fb923c' };

    function setCommunityFilter(tag) {
        communityFilter = tag;
        document.querySelectorAll('.cf-btn').forEach(b => {
            const active = b.id === 'cf-' + tag;
            b.style.background = active ? 'rgba(212,168,75,0.1)' : 'transparent';
            b.style.color = active ? 'var(--v-gold)' : '#8888a8';
            b.style.borderColor = active ? 'rgba(212,168,75,0.3)' : 'rgba(255,255,255,0.08)';
        });
        renderCommunityFeed();
    }

    function insertTag(tag) {
        const ta = document.getElementById('communityPost');
        if (!ta) return;
        ta.value = ta.value.trimEnd() + (ta.value ? ' ' : '') + tag + ' ';
        ta.focus();
    }

    function extractTags(text) {
        const matches = text.match(/#[A-Za-z]+/g) || [];
        return matches.filter(t => Object.keys(TAG_COLORS).includes(t));
    }

    // Override renderCommunityFeed to add strategy tags, follow, copy idea
    renderCommunityFeed = function() {
        const feed = document.getElementById('communityFeed');
        if (!feed) return;
        let posts = communityPosts.slice().sort((a,b)=>b.ts-a.ts);
        if (communityFilter !== 'all') {
            posts = posts.filter(p => p.text.includes('#'+communityFilter));
        }
        if (!posts.length) {
            feed.innerHTML = '<div style="text-align:center;color:#6868a0;padding:24px;font-style:italic;font-size:12px;">No posts with this filter yet.</div>';
            return;
        }
        feed.innerHTML = posts.map((p, idx) => {
            const rel  = relativeTime(p.ts);
            const tags = extractTags(p.text);
            const tagHtml = tags.map(t=>`<span style="font-size:9px;font-weight:700;color:${TAG_COLORS[t]||'#8888a8'};background:${TAG_COLORS[t]||'#8888a8'}18;border-radius:3px;padding:1px 5px;">${t}</span>`).join(' ');
            const followed = (currentUser && currentUser.following || []).includes(p.user);
            const isMe = currentUser && (p.user === currentUser.displayName || p.user === currentUser.username);
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <div style="width:28px;height:28px;border-radius:50%;background:${isMe?'var(--v-gold)':'#2a2a3a'};display:flex;align-items:center;justify-content:center;color:${isMe?'#0a0a0f':'#c0c0d8'};font-size:11px;font-weight:700;flex-shrink:0;">${p.avatar}</div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;color:#e0e0f5;font-size:12px;display:flex;align-items:center;gap:6px;">
                            ${p.user}
                            ${p.badge?`<span style="font-size:11px;" title="${p.badge}">${p.badge}</span>`:''}
                        </div>
                        <div style="font-size:10px;color:#6868a0;">${rel}</div>
                    </div>
                    ${p.sym ? `<span onclick="closeCommunity();openStockDetail(getStockBySymbol('${p.sym}'))" style="font-size:9px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.2);padding:2px 7px;border-radius:4px;cursor:pointer;">$${p.sym}</span>` : ''}
                    ${!isMe?`<button onclick="toggleFollowTrader('${p.user}')" style="font-size:9px;font-weight:700;color:${followed?'#4ade80':'#8888a8'};background:${followed?'rgba(74,222,128,0.08)':'rgba(255,255,255,0.04)'};border:1px solid ${followed?'rgba(74,222,128,0.2)':'rgba(255,255,255,0.08)'};border-radius:4px;padding:2px 7px;cursor:pointer;">${followed?'âœ“ Following':'+ Follow'}</button>`:''}
                </div>
                ${tagHtml?`<div style="margin-bottom:6px;display:flex;gap:4px;">${tagHtml}</div>`:''}
                <p style="font-size:12px;color:#c0c0d8;line-height:1.6;margin:0 0 8px;">${p.text}</p>
                <div style="display:flex;gap:10px;align-items:center;">
                    <button onclick="communityLike(${idx})" style="font-size:10px;color:#6868a0;background:none;border:none;cursor:pointer;padding:0;" onmouseover="this.style.color='var(--v-gold)'" onmouseout="this.style.color='#6868a0'">â¤ï¸ ${p.likes}</button>
                    ${p.sym?`<button onclick="copyIdeaToWatchlist('${p.sym}')" style="font-size:10px;color:#6868a0;background:none;border:none;cursor:pointer;padding:0;" onmouseover="this.style.color='#60a5fa'" onmouseout="this.style.color='#6868a0'">ğŸ“‹ Copy Idea</button>`:''}
                </div>
            </div>`;
        }).join('');
    };

    function toggleFollowTrader(traderName) {
        if (!currentUser) return;
        currentUser.following = currentUser.following || [];
        const idx = currentUser.following.indexOf(traderName);
        if (idx >= 0) currentUser.following.splice(idx, 1);
        else { currentUser.following.push(traderName); pushNotif('info', `Now following ${traderName}'s trade ideas.`); }
        saveUserData(false);
        renderCommunityFeed();
    }

    function copyIdeaToWatchlist(sym) {
        if (!sym) return;
        if (!watchlist.includes(sym)) watchlist.push(sym);
        saveUserData(false);
        pushNotif('info', `$${sym} added to watchlist from community idea.`);
        showTradeToast('INFO', 0, `$${sym} â†’ Watchlist âœ“`, 0, true);
        renderCommunityFeed();
    }

    // Override postCommunityIdea to include strategy tags and user badges
    const _origPostIdea = postCommunityIdea;
    postCommunityIdea = function() {
        const ta = document.getElementById('communityPost');
        const text = ta ? ta.value.trim() : '';
        if (!text) return;
        const name = currentUser?.displayName || currentUser?.username || 'You';
        const initials = name.slice(0,2).toUpperCase();
        const syms = text.match(/\$[A-Z]{1,5}/g);
        const sym  = syms ? syms[0].replace('$','') : '';
        const badges = currentUser?.badges || [];
        const topBadge = badges.length ? PERF_BADGES.find(b=>badges.includes(b.id))?.emoji || '' : '';
        communityPosts.unshift({ user:name, avatar:initials, ts:Date.now(), text, likes:0, sym, badge:topBadge });
        if (ta) ta.value = '';
        renderCommunityFeed();
        renderBadgesInCommunity();
        playTick();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CALENDAR UPGRADE â€” filters + countdowns + IPOs + dividends
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let calFilter = 'all';

    const calendarEvents = (() => {
        const now = Date.now(), day = 86400000;
        return [
            { ts: now + 1*day,  type:'fed',      impact:'high',   title:'FOMC Meeting Minutes',             detail:'Federal Reserve publishes meeting minutes. Watch for rate guidance language.' },
            { ts: now + 2*day,  type:'earnings', impact:'high',   title:'NVDA Earnings Q4 2025',            detail:'NVIDIA Q4 earnings. EPS est. $0.84 on revenue $38.0B.' },
            { ts: now + 3*day,  type:'data',     impact:'medium', title:'US CPI Inflation Data',            detail:'Core CPI expected at 3.1% YoY.' },
            { ts: now + 4*day,  type:'earnings', impact:'high',   title:'AAPL Earnings Q1 2026',            detail:'iPhone 17 cycle in focus. EPS est. $2.26.' },
            { ts: now + 4*day,  type:'ipo',      impact:'medium', title:'Reddit Inc (RDDT) Secondary',      detail:'Reddit secondary offering of 8M shares.' },
            { ts: now + 5*day,  type:'data',     impact:'high',   title:'US Non-Farm Payrolls',             detail:'Consensus: +195K jobs, unemployment 4.1%.' },
            { ts: now + 5*day,  type:'dividend', impact:'low',    title:'AAPL Dividend Ex-Date',            detail:'Apple quarterly dividend $0.25/share. Ex-dividend date.' },
            { ts: now + 6*day,  type:'earnings', impact:'medium', title:'MSFT Earnings Q2 FY26',            detail:'Azure cloud growth in focus. EPS est. $3.12.' },
            { ts: now + 7*day,  type:'ipo',      impact:'high',   title:'CoreWeave IPO Pricing',            detail:'AI infrastructure company CoreWeave pricing expected at $40-47/share.' },
            { ts: now + 8*day,  type:'fed',      impact:'high',   title:'Fed Chair Powell Speech',          detail:'Powell speaks at Economic Club of NY on monetary policy.' },
            { ts: now + 9*day,  type:'data',     impact:'medium', title:'US Retail Sales MoM',              detail:'Previous: +0.4%. Consensus: +0.3%.' },
            { ts: now + 9*day,  type:'dividend', impact:'low',    title:'MSFT Dividend Ex-Date',            detail:'Microsoft quarterly dividend $0.83/share.' },
            { ts: now + 11*day, type:'earnings', impact:'high',   title:'GOOGL Earnings Q4 2025',           detail:'AI-driven search + cloud revenue in focus.' },
            { ts: now + 12*day, type:'data',     impact:'high',   title:'Fed Rate Decision',                detail:'Markets pricing 88% hold probability at 4.25â€“4.50%.' },
            { ts: now + 14*day, type:'earnings', impact:'medium', title:'META Earnings Q4 2025',            detail:'AI advertising tools and Reality Labs losses in focus.' },
            { ts: now + 15*day, type:'ipo',      impact:'medium', title:'Shein IPO Expected Date',          detail:'Fast fashion giant Shein expected NYSE listing.' },
            { ts: now + 18*day, type:'data',     impact:'medium', title:'US GDP Q4 2025 Preliminary',       detail:'Previous: +2.8% annualized. Est: +2.5%.' },
            { ts: now + 20*day, type:'dividend', impact:'low',    title:'JPM Dividend Ex-Date',             detail:'JPMorgan quarterly dividend $1.25/share.' },
        ];
    })();

    function setCalFilter(type) {
        calFilter = type;
        document.querySelectorAll('.cal-filter-btn').forEach(b=>{
            const active = b.id === 'cal-' + type;
            b.style.background = active ? 'rgba(212,168,75,0.1)' : 'transparent';
            b.style.color      = active ? 'var(--v-gold)' : '#8888a8';
            b.style.borderColor= active ? 'rgba(212,168,75,0.3)' : 'rgba(255,255,255,0.08)';
        });
        renderCalendar();
    }

    // Override existing renderCalendar
    renderCalendar = function() {
        const el = document.getElementById('calendarContent');
        if (!el) return;
        const now = Date.now();
        const events = calFilter === 'all' ? calendarEvents : calendarEvents.filter(e=>e.type===calFilter);
        const typeColor = { fed:'rgba(139,92,246,0.1)', earnings:'rgba(212,168,75,0.08)', data:'rgba(34,197,94,0.08)', ipo:'rgba(96,165,250,0.08)', dividend:'rgba(245,158,11,0.08)' };
        const typeText  = { fed:'#a78bfa', earnings:'var(--v-gold)', data:'#4ade80', ipo:'#60a5fa', dividend:'#f59e0b' };
        const typeLabel = { fed:'ğŸ¦ Fed', earnings:'ğŸ“Š Earnings', data:'ğŸ“ˆ Economic', ipo:'ğŸš€ IPO', dividend:'ğŸ’° Dividend' };
        const impactDot = { high:'#ef4444', medium:'var(--v-gold)', low:'#4ade80' };

        function countdown(ts) {
            const diff = ts - now;
            if (diff <= 0) return '<span style="font-size:9px;color:#4ade80;font-weight:700;">Today</span>';
            const d = Math.floor(diff/86400000);
            const h = Math.floor((diff%86400000)/3600000);
            if (d > 0) return `<span style="font-size:9px;color:#f59e0b;font-weight:700;">in ${d}d ${h}h</span>`;
            return `<span style="font-size:9px;color:#f87171;font-weight:700;">in ${h}h</span>`;
        }

        el.innerHTML = events.length ? `<div style="display:flex;flex-direction:column;gap:8px;">
            ${events.map(ev => {
                const d = new Date(ev.ts);
                const dateStr = d.toLocaleDateString([],{weekday:'short',month:'short',day:'numeric'});
                return `<div style="background:${typeColor[ev.type]||'rgba(255,255,255,0.03)'};border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
                    <div style="width:52px;flex-shrink:0;text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;font-weight:700;">${d.toLocaleDateString([],{month:'short'})}</div>
                        <div style="font-family:var(--v-mono);font-size:1.3rem;color:#f0f0fa;line-height:1;">${d.getDate()}</div>
                        <div style="font-size:9px;color:#6868a0;">${d.toLocaleDateString([],{weekday:'short'})}</div>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;flex-wrap:wrap;">
                            <span style="font-size:9px;font-weight:700;color:${typeText[ev.type]||'#8888a8'};text-transform:uppercase;letter-spacing:0.05em;">${typeLabel[ev.type]||ev.type}</span>
                            <span style="width:5px;height:5px;border-radius:50%;background:${impactDot[ev.impact]||'#8888a8'};flex-shrink:0;"></span>
                            <span style="font-size:9px;color:#6868a0;text-transform:capitalize;">${ev.impact} impact</span>
                            ${countdown(ev.ts)}
                        </div>
                        <div style="font-weight:600;color:#e0e0f5;font-size:0.875rem;margin-bottom:3px;">${ev.title}</div>
                        <div style="font-size:11px;color:#8888a8;line-height:1.5;">${ev.detail}</div>
                    </div>
                </div>`;
            }).join('')}
        </div>` : '<div style="text-align:center;color:#6868a0;padding:32px;font-style:italic;">No events for this filter.</div>';
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MICRO SOUND SYSTEM ğŸ””
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let soundEnabled = false;
    let _audioCtx = null;

    function getAudioCtx() {
        if (!_audioCtx) _audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        return _audioCtx;
    }

    function playTone(freq, duration, vol, type) {
        if (!soundEnabled) return;
        try {
            const ctx = getAudioCtx();
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = type || 'sine';
            osc.frequency.value = freq;
            gain.gain.setValueAtTime(vol || 0.06, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + duration);
            osc.start(ctx.currentTime);
            osc.stop(ctx.currentTime + duration);
        } catch(e) {}
    }

    function playTick()     { playTone(880, 0.06, 0.04, 'sine'); }
    function playBuy()      { playTone(440, 0.12, 0.06, 'sine'); setTimeout(()=>playTone(554,0.1,0.05,'sine'),80); }
    function playSell()     { playTone(330, 0.12, 0.06, 'sine'); }
    function playAlert()    { playTone(660, 0.15, 0.07, 'triangle'); }
    function playSuccess()  { [440,554,659].forEach((f,i)=>setTimeout(()=>playTone(f,0.15,0.05,'sine'),i*80)); }

    function toggleSound() {
        soundEnabled = !soundEnabled;
        const btn = document.getElementById('soundToggleBtn');
        if (btn) btn.textContent = soundEnabled ? 'ğŸ””' : 'ğŸ”‡';
        if (soundEnabled) { setTimeout(playSuccess, 50); pushNotif('info','ğŸ”” Micro sounds enabled'); }
        if (currentUser) { currentUser.soundEnabled = soundEnabled; saveUserData(false); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHART DEPTH GRADIENT BACKGROUND
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function applyChartDepthGradient() {
        const canvas = document.getElementById('stockChart');
        if (!canvas || !sChart) return;
        const ctx = canvas.getContext('2d');
        const chartArea = sChart.chartArea;
        if (!chartArea) return;
        const gradient = ctx.createLinearGradient(0, chartArea.top, 0, chartArea.bottom);
        gradient.addColorStop(0,   'rgba(96,165,250,0.18)');
        gradient.addColorStop(0.5, 'rgba(96,165,250,0.06)');
        gradient.addColorStop(1,   'rgba(96,165,250,0.0)');
        if (sChart.data && sChart.data.datasets && sChart.data.datasets[0]) {
            sChart.data.datasets[0].backgroundColor = gradient;
            sChart.update('none');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  COMPOUNDING PROJECTION + 10-YEAR SIMULATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openCompoundProjector() {
        const currentVal = (currentUser && currentUser.totalValue) || cash;
        const modal = document.createElement('div');
        modal.id = 'compoundModal';
        modal.style.cssText = 'position:fixed;inset:0;z-index:10000;background:rgba(0,0,0,0.85);backdrop-filter:blur(14px);display:flex;align-items:center;justify-content:center;';
        modal.innerHTML = `
        <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(212,168,75,0.2);border-radius:24px;width:100%;max-width:600px;max-height:85vh;overflow-y:auto;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">
            <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 3px;">ğŸ“ˆ 10-Year Compound Projector</h2>
                    <p style="font-size:11px;color:#8888a8;margin:0;">Simulate long-term portfolio growth</p>
                </div>
                <button onclick="document.getElementById('compoundModal').remove()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
            </div>
            <div style="padding:20px 28px;">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:16px;">
                    <div>
                        <label style="font-size:9px;color:#8888a8;text-transform:uppercase;font-weight:700;display:block;margin-bottom:4px;">Starting Value</label>
                        <input id="cpStart" type="number" value="${Math.round(currentVal)}" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);">
                    </div>
                    <div>
                        <label style="font-size:9px;color:#8888a8;text-transform:uppercase;font-weight:700;display:block;margin-bottom:4px;">Annual Return %</label>
                        <input id="cpReturn" type="number" value="12" min="1" max="50" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);">
                    </div>
                    <div>
                        <label style="font-size:9px;color:#8888a8;text-transform:uppercase;font-weight:700;display:block;margin-bottom:4px;">Monthly Add ($)</label>
                        <input id="cpMonthly" type="number" value="500" min="0" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);">
                    </div>
                </div>
                <button onclick="runCompound()" style="background:rgba(212,168,75,0.12);color:var(--v-gold);border:1px solid rgba(212,168,75,0.25);border-radius:8px;padding:9px 20px;font-size:12px;font-weight:700;cursor:pointer;margin-bottom:16px;">Calculate Growth â†’</button>
                <div id="cpResults" style="display:none;">
                    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;" id="cpStats"></div>
                    <div style="height:180px;position:relative;background:rgba(255,255,255,0.02);border-radius:10px;padding:12px;overflow:hidden;">
                        <canvas id="cpChart"></canvas>
                    </div>
                    <div id="cpTable" style="margin-top:14px;max-height:200px;overflow-y:auto;font-size:11px;"></div>
                </div>
            </div>
        </div>`;
        modal.onclick = () => modal.remove();
        document.body.appendChild(modal);
    }

    function runCompound() {
        const start   = parseFloat(document.getElementById('cpStart')?.value || 100000);
        const annRate = parseFloat(document.getElementById('cpReturn')?.value || 12) / 100;
        const monthly = parseFloat(document.getElementById('cpMonthly')?.value || 500);
        const years   = 10;
        const mRate   = annRate / 12;
        const results = [{ year:0, value:start }];
        let v = start;
        for (let y = 1; y <= years; y++) {
            for (let m = 0; m < 12; m++) { v = v * (1 + mRate) + monthly; }
            results.push({ year:y, value:Math.round(v) });
        }
        const totalContributions = start + monthly * 12 * years;
        const finalVal = results[years].value;
        const gain = finalVal - totalContributions;
        document.getElementById('cpResults').style.display = 'block';
        document.getElementById('cpStats').innerHTML = [
            { label:'Final Value',    val:'$'+finalVal.toLocaleString(),                    color:'#4ade80' },
            { label:'Total Invested', val:'$'+Math.round(totalContributions).toLocaleString(), color:'#f0f0fa' },
            { label:'Compound Gain',  val:'$'+Math.round(gain).toLocaleString(),            color:gain>=0?'#4ade80':'#f87171' }
        ].map(s=>`<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:12px;text-align:center;">
            <div style="font-size:8px;color:#6868a0;text-transform:uppercase;margin-bottom:4px;">${s.label}</div>
            <div style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:${s.color};">${s.val}</div>
        </div>`).join('');
        // Draw bar chart on canvas
        const canvas = document.getElementById('cpChart');
        if (canvas && typeof Chart !== 'undefined') {
            if (canvas._chartInstance) canvas._chartInstance.destroy();
            canvas._chartInstance = new Chart(canvas.getContext('2d'), {
                type:'bar',
                data:{ labels:results.map(r=>`Y${r.year}`), datasets:[{ data:results.map(r=>r.value), backgroundColor:'rgba(212,168,75,0.4)', borderColor:'var(--v-gold)', borderWidth:1, borderRadius:3 }] },
                options:{ responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, scales:{ x:{ticks:{color:'#8888a8',font:{size:9}}}, y:{ticks:{color:'#8888a8',font:{size:9}, callback:v=>'$'+(v/1000).toFixed(0)+'K'}} } }
            });
        }
        document.getElementById('cpTable').innerHTML = `<table style="width:100%;border-collapse:collapse;"><tr style="background:rgba(255,255,255,0.05);"><th style="text-align:left;padding:5px 10px;color:#6868a0;font-size:9px;text-transform:uppercase;">Year</th><th style="text-align:right;padding:5px 10px;color:#6868a0;font-size:9px;text-transform:uppercase;">Value</th><th style="text-align:right;padding:5px 10px;color:#6868a0;font-size:9px;text-transform:uppercase;">Growth</th></tr>${results.map(r=>`<tr style="border-bottom:1px solid rgba(255,255,255,0.04);"><td style="padding:5px 10px;color:#8888a8;">${r.year===0?'Now':r.year+' yr'}</td><td style="padding:5px 10px;text-align:right;font-family:var(--v-mono);color:#f0f0fa;font-weight:600;">$${r.value.toLocaleString()}</td><td style="padding:5px 10px;text-align:right;font-family:var(--v-mono);color:${r.value>=start?'#4ade80':'#f87171'};">${r.year>0?'+'+((r.value-start)/start*100).toFixed(0)+'%':'â€”'}</td></tr>`).join('')}</table>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HOOK AI COACH â€” REVENGE TRADING + PATTERN DETECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function detectRevengeTradingPattern() {
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        // Revenge trading: buys within 10 minutes of a losing sell
        let revengeCount = 0;
        sells.forEach(sell => {
            const pl = (sell.price-(sell.avgBuy||sell.price))*(sell.qty||1);
            if (pl < 0) {
                const quickBuy = (transactions||[]).find(b=>b.type==='BUY'&&b.ts>sell.ts&&b.ts<sell.ts+600000);
                if (quickBuy) revengeCount++;
            }
        });
        return revengeCount;
    }

    function detectLateExitPattern() {
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        let lateExits = 0;
        sells.forEach(sell => {
            // Late exit: exited at a loss after holding 3+ days, when position was profitable earlier
            const holds = (transactions||[]).filter(b=>b.type==='BUY'&&b.symbol===sell.symbol&&b.ts<sell.ts);
            if (!holds.length) return;
            const holdDays = (sell.ts-holds[holds.length-1].ts)/86400000;
            const finalPL = (sell.price-(sell.avgBuy||sell.price));
            if (holdDays >= 3 && finalPL < 0) lateExits++;
        });
        return lateExits;
    }

    function detectEarlyProfitCutPattern() {
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        let earlyExits = 0;
        sells.forEach(sell => {
            const holds = (transactions||[]).filter(b=>b.type==='BUY'&&b.symbol===sell.symbol&&b.ts<sell.ts);
            if (!holds.length) return;
            const holdDays = (sell.ts-holds[holds.length-1].ts)/86400000;
            const plPct    = (sell.price-(sell.avgBuy||sell.price))/(sell.avgBuy||sell.price)*100;
            // Cut early: < 1 day hold, < 2% profit
            if (holdDays < 1 && plPct > 0 && plPct < 2) earlyExits++;
        });
        return earlyExits;
    }

    // Enhanced generateCoachInsights with new pattern detection
    const _origGenerateCoachInsights = generateCoachInsights;
    generateCoachInsights = function(metrics) {
        const base = _origGenerateCoachInsights(metrics);
        const extra = [];
        const revenge = detectRevengeTradingPattern();
        if (revenge >= 2) extra.push(`You've entered trades within 10 minutes of a losing exit ${revenge} times â€” a classic revenge trading pattern. Pause 30 minutes after a loss before re-entering.`);
        const lateExit = detectLateExitPattern();
        if (lateExit >= 2) extra.push(`${lateExit} trades turned from winners to losers during holding â€” consider tighter trailing stops to protect profit on multi-day holds.`);
        const earlyExit = detectEarlyProfitCutPattern();
        if (earlyExit >= 3) extra.push(`You frequently exit profitable trades early (< 2% gain, < 1 day). Let your winners run by pre-defining a target before entering.`);
        // Position sizing after losses
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        const portfolioVal = (currentUser&&currentUser.totalValue)||100000;
        const afterLossBuys = sells.filter(sell=>{
            const pl=(sell.price-(sell.avgBuy||sell.price))*(sell.qty||1);
            if(pl>=0) return false;
            const nextBuy=(transactions||[]).find(b=>b.type==='BUY'&&b.ts>sell.ts&&b.ts<sell.ts+86400000);
            return nextBuy&&(nextBuy.price*nextBuy.qty)/portfolioVal>0.15;
        });
        if (afterLossBuys.length >= 2) extra.push(`You tend to increase position size after losses. This amplifies drawdowns. Consider keeping position sizes consistent regardless of recent results.`);
        // Hold time pattern
        if (metrics && metrics.avgHoldDays > 1.5) {
            const shortWinRate = sells.filter(t=>(t.ts-(transactions.find(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts)?.ts||t.ts))<86400000&&(t.price-(t.avgBuy||t.price))>0).length / Math.max(1,sells.filter(t=>(t.ts-(transactions.find(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts)?.ts||t.ts))<86400000).length);
            if (shortWinRate < 0.4 && metrics.winRate > 0.5) extra.push(`Your overall win rate (${(metrics.winRate*100).toFixed(0)}%) is higher than your intraday win rate. You perform significantly better when holding > 2 days.`);
        }
        return [...base, ...extra].slice(0, 4);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  WIRE UP openCommunity to show badges
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origOpenComm = openCommunity;
    openCommunity = function() {
        _origOpenComm();
        computeAndSaveBadges();
        renderBadgesInCommunity();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SIDEBAR: Add Compound Projector button to Portfolio Intelligence
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Patch renderPortfolioIntelligence to add compound button
    const _origRenderPI = renderPortfolioIntelligence;
    renderPortfolioIntelligence = function() {
        _origRenderPI();
        const bwEl = document.getElementById('bestWorstTrade');
        if (bwEl && !document.getElementById('cpLaunchBtn')) {
            const btn = document.createElement('button');
            btn.id = 'cpLaunchBtn';
            btn.textContent = 'ğŸ“ˆ 10-Year Compound Projector â†’';
            btn.style.cssText = 'display:block;width:100%;margin-top:10px;background:rgba(212,168,75,0.07);color:var(--v-gold);border:1px solid rgba(212,168,75,0.18);border-radius:8px;padding:8px 12px;font-size:11px;font-weight:700;cursor:pointer;text-align:left;';
            btn.onclick = openCompoundProjector;
            bwEl.appendChild(btn);
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SOUND â€” wire into trades
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origShowToastSound = showTradeToast;
    showTradeToast = function(type, qty, sym, price, isPending) {
        _origShowToastSound(type, qty, sym, price, isPending);
        if (!isPending) {
            if (type === 'BUY')  playBuy();
            if (type === 'SELL') playSell();
        }
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PATCH updateUI â€” compute badges on every 5th update
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origUpdateUIBadge = updateUI;
    updateUI = function() {
        _origUpdateUIBadge();
        updateUI._badgeCount = (updateUI._badgeCount||0)+1;
        if (updateUI._badgeCount % 5 === 0) computeAndSaveBadges();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PATCH loginAs â€” restore sound setting + badges
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origLoginAsFinal = loginAs;
    loginAs = async function(userData) {
        await _origLoginAsFinal(userData);
        // Restore sound
        if (currentUser && currentUser.soundEnabled) {
            soundEnabled = true;
            const btn = document.getElementById('soundToggleBtn');
            if (btn) btn.textContent = 'ğŸ””';
        }
        computeAndSaveBadges();
        renderBadgesInCommunity();
        // Apply chart gradient after chart loads
        setTimeout(applyChartDepthGradient, 1500);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEGAL PAGES SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _activeLegalPages = new Set();

    function openLegalPage(key) {
        const el = document.getElementById('legal-' + key);
        if (!el) return;
        el.style.display = 'flex';
        _activeLegalPages.add(key);
        document.body.style.overflow = 'hidden';
        // Special init
        if (key === 'faq') renderFAQ();
        // Close on backdrop click
        el.addEventListener('click', function bk(e) {
            if (e.target === el) { closeLegalPage(key); el.removeEventListener('click', bk); }
        });
        // Close on Escape
        const esc = (e) => { if (e.key === 'Escape') { closeLegalPage(key); document.removeEventListener('keydown', esc); } };
        document.addEventListener('keydown', esc);
    }

    function closeLegalPage(key) {
        const el = document.getElementById('legal-' + key);
        if (el) el.style.display = 'none';
        _activeLegalPages.delete(key);
        if (_activeLegalPages.size === 0) document.body.style.overflow = '';
    }

    // â”€â”€ Contact Form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function submitContactForm() {
        const name  = (document.getElementById('contactName')?.value || '').trim();
        const email = (document.getElementById('contactEmail')?.value || '').trim();
        const msg   = (document.getElementById('contactMessage')?.value || '').trim();

        if (!name)  { document.getElementById('contactName')?.focus();  return; }
        if (!email || !email.includes('@')) { document.getElementById('contactEmail')?.focus(); return; }
        if (!msg)   { document.getElementById('contactMessage')?.focus(); return; }

        // Simulate submission (real implementation would POST to backend)
        const emailConfirm = document.getElementById('contactEmailConfirm');
        if (emailConfirm) emailConfirm.textContent = email;
        const form = document.getElementById('contactForm');
        const success = document.getElementById('contactSuccess');
        if (form) form.style.display = 'none';
        if (success) success.style.display = 'block';

        // Reset form for next use
        setTimeout(() => {
            if (form) { form.style.display = 'grid'; ['contactName','contactEmail','contactMessage'].forEach(id => { const el=document.getElementById(id); if(el)el.value=''; }); }
            if (success) success.style.display = 'none';
        }, 8000);
    }

    // â”€â”€ FAQ Content â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const FAQ_ITEMS = [
        { q: 'Is Vestra free to use?', a: 'Yes. Vestra is completely free. No credit card, no subscription, no hidden fees. Create an account and start trading with $100,000 virtual cash instantly.' },
        { q: 'Does Vestra use real money?', a: 'No. All portfolio values, trades, and returns on Vestra are entirely virtual. No real currency is ever deposited, withdrawn, or at risk. This is a simulation platform only.' },
        { q: 'How do I get live stock prices?', a: 'Vestra integrates with the Finnhub API for real-time market data. Get a free API key from finnhub.io and enter it via the âš¡ Live button in the header. Without an API key, prices update with simulated realistic movements.' },
        { q: 'What is Realism Mode?', a: 'Realism Mode enforces real-world trading constraints: orders only execute during NYSE market hours (9:30 AM â€“ 4:00 PM ET), bid-ask spread simulation applies, and you compete on a separate leaderboard from Standard Mode users.' },
        { q: 'What is the Strategy Lab?', a: 'The Strategy Lab lets you create named trading strategies with defined entry/exit conditions, risk parameters, and trade tagging. Each strategy builds its own performance dashboard showing win rate, average return, and drawdown.' },
        { q: 'How does the Risk Guard work?', a: 'Risk Guard lets you set personal trading rules: max risk per trade (% of portfolio), max daily loss, max open positions, and consecutive loss limits. If you attempt to violate a rule, the trade is blocked with an explanation.' },
        { q: 'What is the Trade Replay Engine?', a: 'The Replay Engine lets you practice on historical candle data. Open any stock chart, select a period, and click ğŸ¬ Replay. Candles reveal one at a time while you can place trades â€” exactly like a real trading practice session.' },
        { q: 'Can I export my trade history?', a: 'Yes. Use the â‹¯ menu in the top right of the dashboard, then click ğŸ“¤ Export Portfolio. Your full trade history, portfolio state, and journal entries are exported as a JSON file.' },
        { q: 'How are leaderboard rankings calculated?', a: 'Rankings are calculated monthly by total portfolio value. Secondary sort is by percentage return. Tertiary sort is by lowest maximum drawdown. Standard and Realism modes have completely separate leaderboards.' },
        { q: 'How do I delete my account?', a: 'Email support@vestra.app with your username and a deletion request. We will remove all your data within 5 business days. Alternatively, clearing your browser\'s local storage will erase local data immediately.' },
    ];

    function renderFAQ() {
        const el = document.getElementById('faqBody');
        if (!el || el.dataset.rendered) return;
        el.dataset.rendered = '1';
        el.innerHTML = FAQ_ITEMS.map((item, i) => `
            <div style="border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:18px;margin-bottom:18px;">
                <button onclick="toggleFAQ(${i})" style="width:100%;text-align:left;background:none;border:none;cursor:pointer;display:flex;justify-content:space-between;align-items:start;gap:12px;padding:0;" aria-expanded="false" id="faqBtn${i}">
                    <span style="font-size:14px;font-weight:600;color:#e0e0f5;line-height:1.5;">${item.q}</span>
                    <span id="faqArrow${i}" style="font-size:16px;color:#8888a8;flex-shrink:0;transition:transform 0.2s;line-height:1.5;">+</span>
                </button>
                <div id="faqAns${i}" style="display:none;font-size:13px;color:#9090b8;line-height:1.75;padding-top:10px;">${item.a}</div>
            </div>`).join('');
    }

    function toggleFAQ(i) {
        const ans   = document.getElementById('faqAns'  + i);
        const arrow = document.getElementById('faqArrow' + i);
        const btn   = document.getElementById('faqBtn'  + i);
        if (!ans) return;
        const open = ans.style.display !== 'none';
        ans.style.display   = open ? 'none' : 'block';
        if (arrow) arrow.textContent  = open ? '+' : 'âˆ’';
        if (arrow) arrow.style.color  = open ? '#8888a8' : 'var(--v-gold)';
        if (btn)   btn.setAttribute('aria-expanded', !open);
    }

    // â”€â”€ Footer: dynamic year â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const footerYearEl = document.getElementById('footerYear');
    if (footerYearEl) footerYearEl.textContent = new Date().getFullYear();

    // â”€â”€ Footer: responsive layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateFooterLayout() {
        const fg = document.getElementById('footerGrid');
        if (!fg) return;
        fg.style.gridTemplateColumns = window.innerWidth < 768 ? '1fr 1fr' : window.innerWidth < 560 ? '1fr' : '2fr 1fr 1fr 1fr';
    }
    window.addEventListener('resize', updateFooterLayout);
    updateFooterLayout();

    // â”€â”€ System status indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSystemStatus() {
        const el = document.getElementById('systemStatus');
        if (!el) return;
        // Could do a real ping here; for now always show operational
        el.textContent = 'All Systems Operational';
        el.style.color = '#4ade80';
    }
    setTimeout(updateSystemStatus, 500);

    // â”€â”€ Init â”€â”€
    initMarket();  // pre-load stock data
    showHomepage(); // start on homepage

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ADVANCED ANALYTICS SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _silentFocusMode = false;

    function toggleSilentFocus() {
        _silentFocusMode = !_silentFocusMode;
        const btn = document.getElementById('silentFocusBtn');
        if (btn) {
            btn.style.background = _silentFocusMode ? 'rgba(129,140,248,0.15)' : 'rgba(255,255,255,0.04)';
            btn.style.color = _silentFocusMode ? '#818cf8' : '#a0a0b8';
            btn.style.borderColor = _silentFocusMode ? 'rgba(129,140,248,0.4)' : 'rgba(255,255,255,0.08)';
            btn.title = _silentFocusMode ? 'Silent Focus: P&L hidden during open trades' : 'Enable Silent Focus Mode';
        }
        updateUI();
        if (_silentFocusMode) pushNotif('info', 'ğŸ”• Silent Focus Mode ON â€” P&L hidden while positions are open.');
    }

    function isSilentFocusActive() {
        return _silentFocusMode && Object.keys(portfolio).length > 0;
    }

    function openAdvancedAnalytics() {
        const el = document.getElementById('advancedAnalyticsModal');
        if (el) { el.style.display = 'flex'; renderAdvancedAnalytics(); }
    }
    function closeAdvancedAnalytics() {
        const el = document.getElementById('advancedAnalyticsModal');
        if (el) el.style.display = 'none';
    }

    function computeEquityCurve() {
        // Build equity curve from perfHistory + transactions
        const pts = (perfHistory || []).map(p => ({ ts: p.ts, val: p.value }));
        if (pts.length === 0) return [{ ts: Date.now(), val: cash }];
        return pts;
    }

    function computeDrawdownCurve(equityCurve) {
        let peak = equityCurve[0]?.val || 100000;
        return equityCurve.map(pt => {
            if (pt.val > peak) peak = pt.val;
            const dd = peak > 0 ? ((pt.val - peak) / peak * 100) : 0;
            return { ts: pt.ts, dd };
        });
    }

    function computeMonthlyReturns(equityCurve) {
        const monthly = {};
        for (let i = 1; i < equityCurve.length; i++) {
            const d = new Date(equityCurve[i].ts);
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            monthly[key] = monthly[key] || { start: equityCurve[i-1].val, end: equityCurve[i].val };
            monthly[key].end = equityCurve[i].val;
        }
        const result = {};
        for (const [k, v] of Object.entries(monthly)) {
            result[k] = ((v.end - v.start) / v.start * 100);
        }
        return result;
    }

    function computeSectorExposure() {
        const exposure = {};
        let total = 0;
        for (const [sym, qty] of Object.entries(portfolio)) {
            if (qty <= 0) continue;
            const stock = getStockBySymbol(sym);
            if (!stock) continue;
            const val = stock.price * qty;
            total += val;
            const sec = stock.sector || 'Other';
            exposure[sec] = (exposure[sec] || 0) + val;
        }
        return { exposure, total };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ANALYTICS ENGINE v2 â€” Complete Professional Metrics Suite
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeRiskAdjustedReturn() {
        const curve = computeEquityCurve();
        if (curve.length < 2) return { sharpe: 0, maxDD: 0, calmar: 0, totalReturn: 0 };
        const returns = [];
        for (let i = 1; i < curve.length; i++) {
            returns.push((curve[i].val - curve[i-1].val) / curve[i-1].val);
        }
        const avgRet = returns.reduce((a, b) => a + b, 0) / returns.length;
        const std = Math.sqrt(returns.reduce((a, b) => a + Math.pow(b - avgRet, 2), 0) / returns.length) || 0.001;
        const annualFactor = Math.sqrt(252);
        const sharpe = (avgRet / std) * annualFactor;
        const ddCurve = computeDrawdownCurve(curve);
        const maxDD = Math.min(...ddCurve.map(d => d.dd));
        const totalReturn = curve.length > 1 ? ((curve[curve.length-1].val - curve[0].val) / curve[0].val * 100) : 0;
        const calmar = maxDD !== 0 ? totalReturn / Math.abs(maxDD) : 0;
        return { sharpe: +sharpe.toFixed(2), maxDD: +maxDD.toFixed(2), calmar: +calmar.toFixed(2), totalReturn: +totalReturn.toFixed(2) };
    }

    function computeAllMetrics() {
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        const buys  = (transactions || []).filter(t => t.type === 'BUY');
        const curve = computeEquityCurve();
        const riskAdj = computeRiskAdjustedReturn();

        if (sells.length === 0) return {
            winRate: 0, avgWin: 0, avgLoss: 0, profitFactor: 0, expectancy: 0,
            riskOfRuin: 1, capitalEfficiency: 0, rollingWinRate: 0, rollingDD: 0,
            avgHoldTime: 0, patienceScore: 0, equityVolatility: 0,
            overconfidenceRisk: false, lossStreakWarning: false, emotionalDriftScore: 50,
            ...riskAdj
        };

        const wins  = sells.filter(t => (t.price - (t.avgBuy || t.price)) > 0);
        const losses = sells.filter(t => (t.price - (t.avgBuy || t.price)) <= 0);
        const n = sells.length;

        const winRate = wins.length / n;
        const avgWinPct = wins.length > 0 ? wins.reduce((s,t) => s + ((t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100), 0) / wins.length : 0;
        const avgLossPct = losses.length > 0 ? Math.abs(losses.reduce((s,t) => s + ((t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100), 0) / losses.length) : 0;

        // Profit Factor = gross wins / gross losses
        const grossWins  = wins.reduce((s,t)  => s + Math.max(0, (t.price-(t.avgBuy||t.price))*t.qty), 0);
        const grossLosses = losses.reduce((s,t) => s + Math.abs(Math.min(0, (t.price-(t.avgBuy||t.price))*t.qty)), 0);
        const profitFactor = grossLosses > 0 ? +(grossWins / grossLosses).toFixed(2) : grossWins > 0 ? 99 : 0;

        // Expectancy = (WR Ã— avgWin) - ((1-WR) Ã— avgLoss) in %
        const expectancy = +((winRate * avgWinPct) - ((1 - winRate) * avgLossPct)).toFixed(2);

        // Risk of Ruin (Kelly-based estimate)
        // RoR = ((1 - edge) / (1 + edge))^targetUnits where edge = winRate - (1-winRate)/rr
        const rr = avgLossPct > 0 ? avgWinPct / avgLossPct : 1;
        const edge = winRate - (1 - winRate) / (rr || 1);
        const rorBase = edge > 0 && rr > 0 ? Math.pow(Math.max(0, (1 - edge) / (1 + edge)), 20) : 0.99;
        const riskOfRuin = Math.min(1, Math.max(0, +rorBase.toFixed(3)));

        // Capital efficiency = realized PL / max capital deployed
        const maxDeployed = buys.reduce((mx, t) => Math.max(mx, t.price * t.qty), 0);
        const totalRealized = Number(currentUser?.realizedPL || 0);
        const capitalEfficiency = maxDeployed > 0 ? +((totalRealized / maxDeployed) * 100).toFixed(1) : 0;

        // Rolling win rate (last 10 trades)
        const last10 = sells.slice(0, 10);
        const rollingWins = last10.filter(t => (t.price-(t.avgBuy||t.price)) > 0).length;
        const rollingWinRate = last10.length > 0 ? +(rollingWins / last10.length * 100).toFixed(1) : 0;

        // Rolling drawdown (last 20 pts)
        const recent = curve.slice(-20);
        const recentDD = recent.length > 1 ? computeDrawdownCurve(recent) : [];
        const rollingDD = recentDD.length > 0 ? +Math.min(...recentDD.map(d=>d.dd)).toFixed(2) : 0;

        // Average hold time (hours)
        const holdTimes = sells.map(t => {
            const matchBuy = buys.filter(b => b.symbol === t.symbol && b.ts < t.ts);
            return matchBuy.length ? (t.ts - matchBuy[matchBuy.length-1].ts) / 3600000 : 0;
        }).filter(h => h > 0);
        const avgHoldTime = holdTimes.length > 0 ? +(holdTimes.reduce((a,b)=>a+b,0)/holdTimes.length).toFixed(1) : 0;

        // Patience score â€” higher hold time relative to session = more patient
        const patienceScore = Math.min(100, Math.round(Math.min(avgHoldTime / 4, 1) * 100));

        // Equity volatility score
        const returns2 = [];
        for (let i = 1; i < curve.length; i++) {
            returns2.push(Math.abs((curve[i].val - curve[i-1].val) / (curve[i-1].val || 1)));
        }
        const avgVol = returns2.length > 0 ? returns2.reduce((a,b)=>a+b,0)/returns2.length : 0;
        const equityVolatility = +(avgVol * 100).toFixed(2);

        // Overconfidence detection: win streak > 5 AND position sizes increasing
        let winStreak = 0, maxStreak = 0;
        const recentSells = [...sells].reverse(); // chronological order
        recentSells.forEach(t => {
            if ((t.price-(t.avgBuy||t.price)) > 0) { winStreak++; maxStreak = Math.max(maxStreak, winStreak); }
            else { winStreak = 0; }
        });
        const overconfidenceRisk = maxStreak >= 5;

        // Risk escalation detection: are trade sizes increasing after losses?
        const riskEscalation = (() => {
            if (sells.length < 4) return false;
            const recent = sells.slice(0, 6);
            let lossFollowedByBigger = 0;
            for (let i = 0; i < recent.length - 1; i++) {
                const wasLoss = (recent[i].price - (recent[i].avgBuy||recent[i].price)) < 0;
                const nextSize = recent[i+1].price * recent[i+1].qty;
                const thisSize = recent[i].price * recent[i].qty;
                if (wasLoss && nextSize > thisSize * 1.2) lossFollowedByBigger++;
            }
            return lossFollowedByBigger >= 2;
        })();

        // Emotional drift: variance in position sizes trending up over time
        const sizes = buys.map(t => t.price * t.qty);
        const firstHalf = sizes.slice(0, Math.ceil(sizes.length/2));
        const secondHalf = sizes.slice(Math.ceil(sizes.length/2));
        const fhAvg = firstHalf.length > 0 ? firstHalf.reduce((a,b)=>a+b,0)/firstHalf.length : 0;
        const shAvg = secondHalf.length > 0 ? secondHalf.reduce((a,b)=>a+b,0)/secondHalf.length : 0;
        const emotionalDriftScore = fhAvg > 0 ? Math.min(100, Math.max(0, Math.round(100 - ((shAvg/fhAvg - 1) * 100)))) : 50;

        // Loss streak warning (most recent)
        let curLossStreak = 0;
        for (const t of sells) {
            if ((t.price-(t.avgBuy||t.price)) < 0) curLossStreak++;
            else break;
        }
        const lossStreakWarning = curLossStreak >= 3;

        // Avg time between trades (patience)
        const tradeTimestamps = sells.map(t => t.ts || Date.now()).sort((a,b)=>a-b);
        let avgTimeBetweenTrades = 0;
        if (tradeTimestamps.length >= 2) {
            const gaps = tradeTimestamps.slice(1).map((t,i) => (t - tradeTimestamps[i]) / 3600000);
            avgTimeBetweenTrades = +(gaps.reduce((a,b)=>a+b,0)/gaps.length).toFixed(1);
        }

        return {
            winRate: +(winRate*100).toFixed(1), avgWin: +avgWinPct.toFixed(2), avgLoss: +avgLossPct.toFixed(2),
            profitFactor, expectancy, riskOfRuin, capitalEfficiency,
            rollingWinRate, rollingDD, avgHoldTime, patienceScore, equityVolatility,
            overconfidenceRisk, lossStreakWarning, emotionalDriftScore,
            riskEscalation, avgTimeBetweenTrades,
            grossWins, grossLosses, winStreak: maxStreak, curLossStreak,
            ...riskAdj
        };
    }

    // Integrity score calculation â€” used for leaderboard anti-gaming
    function computeIntegrityScore() {
        if (!currentUser) return 100;
        let score = currentUser.integrityScore ?? 100;
        // Already tracked in currentUser.riskViolations
        const violations = currentUser.riskViolations || 0;
        score = Math.max(0, 100 - violations * 8);
        return score;
    }

    function recordRiskViolation(reason) {
        if (!currentUser) return;
        currentUser.riskViolations = (currentUser.riskViolations || 0) + 1;
        currentUser.integrityScore = computeIntegrityScore();
        addNotification(`âš ï¸ Risk Violation: ${reason} â€” Integrity score reduced`, 'warning');
        saveUserData(false);
    }

    function drawMiniCurve(canvasId, dataPoints, color, fill) {
        const canvas = document.getElementById(canvasId);
        if (!canvas || dataPoints.length < 2) return;
        const dpr = window.devicePixelRatio || 1;
        const W = canvas.clientWidth || 280, H = canvas.clientHeight || 70;
        canvas.width = W * dpr; canvas.height = H * dpr;
        const ctx = canvas.getContext('2d'); ctx.scale(dpr, dpr);
        ctx.clearRect(0, 0, W, H);
        const vals = dataPoints.map(d => d.v || d.val || d.dd || 0);
        const mn = Math.min(...vals), mx = Math.max(...vals);
        const rng = mx - mn || 1;
        const toX = i => (i / (dataPoints.length - 1)) * (W - 4) + 2;
        const toY = v => H - 4 - ((v - mn) / rng) * (H - 8);
        if (fill) {
            const grad = ctx.createLinearGradient(0, 0, 0, H);
            grad.addColorStop(0, color + '44'); grad.addColorStop(1, color + '05');
            ctx.fillStyle = grad;
            ctx.beginPath(); ctx.moveTo(toX(0), H);
            dataPoints.forEach((d, i) => ctx.lineTo(toX(i), toY(vals[i])));
            ctx.lineTo(toX(dataPoints.length - 1), H); ctx.closePath(); ctx.fill();
        }
        ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.lineJoin = 'round';
        ctx.beginPath();
        dataPoints.forEach((d, i) => i === 0 ? ctx.moveTo(toX(i), toY(vals[i])) : ctx.lineTo(toX(i), toY(vals[i])));
        ctx.stroke();
    }

    function renderAdvancedAnalytics() {
        const curve = computeEquityCurve();
        const ddCurve = computeDrawdownCurve(curve);
        const monthly = computeMonthlyReturns(curve);
        const riskAdj = computeRiskAdjustedReturn();
        const { exposure, total: expTotal } = computeSectorExposure();
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        const portfolioVal = curve[curve.length - 1]?.val || cash;

        // Key metrics strip
        const metricsEl = document.getElementById('aaMetrics');
        if (metricsEl) {
            const metrics = [
                { label:'Total Return', val: riskAdj.totalReturn >= 0 ? '+' + riskAdj.totalReturn + '%' : riskAdj.totalReturn + '%', color: riskAdj.totalReturn >= 0 ? '#4ade80' : '#f87171' },
                { label:'Sharpe Ratio', val: riskAdj.sharpe, color: riskAdj.sharpe > 1 ? '#4ade80' : riskAdj.sharpe > 0 ? '#f59e0b' : '#f87171' },
                { label:'Max Drawdown', val: riskAdj.maxDD + '%', color: riskAdj.maxDD > -10 ? '#4ade80' : riskAdj.maxDD > -20 ? '#f59e0b' : '#f87171' },
                { label:'Calmar Ratio', val: riskAdj.calmar, color: riskAdj.calmar > 1 ? '#4ade80' : '#f59e0b' },
                { label:'Portfolio Value', val: '$' + portfolioVal.toLocaleString(undefined, {maximumFractionDigits:0}), color: '#60a5fa' },
                { label:'Closed Trades', val: sells.length, color: '#a78bfa' },
            ];
            metricsEl.innerHTML = metrics.map(m => `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;text-align:center;">
                <div style="font-size:8px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">${m.label}</div>
                <div style="font-family:var(--v-mono);font-size:1.1rem;font-weight:700;color:${m.color};">${m.val}</div>
            </div>`).join('');
        }

        // Draw equity curve
        setTimeout(() => {
            const equityPts = curve.map(p => ({ v: p.val }));
            drawMiniCurve('aaEquityCanvas', equityPts, '#4ade80', true);
            const ddPts = ddCurve.map(p => ({ v: p.dd }));
            drawMiniCurve('aaDDCanvas', ddPts, '#f87171', true);
        }, 60);

        // Monthly heatmap
        const hmEl = document.getElementById('aaMonthlyHeatmap');
        if (hmEl) {
            const months = Object.entries(monthly).slice(-12);
            if (months.length === 0) {
                hmEl.innerHTML = '<div style="color:#6868a0;font-size:11px;text-align:center;padding:20px;">No monthly data yet â€” keep trading!</div>';
            } else {
                const maxAbs = Math.max(...months.map(([,v]) => Math.abs(v)), 1);
                hmEl.innerHTML = months.map(([k, v]) => {
                    const [y, m] = k.split('-');
                    const mName = new Date(+y, +m-1, 1).toLocaleString('default', { month: 'short' });
                    const intensity = Math.min(1, Math.abs(v) / maxAbs);
                    const bg = v >= 0
                        ? `rgba(74,222,128,${0.08 + intensity * 0.35})`
                        : `rgba(248,113,113,${0.08 + intensity * 0.35})`;
                    const col = v >= 0 ? '#4ade80' : '#f87171';
                    return `<div style="background:${bg};border:1px solid ${col}28;border-radius:8px;padding:10px 6px;text-align:center;">
                        <div style="font-size:9px;color:#8888a8;">${mName} '${y.slice(2)}</div>
                        <div style="font-size:12px;font-weight:700;color:${col};font-family:var(--v-mono);">${v >= 0 ? '+' : ''}${v.toFixed(1)}%</div>
                    </div>`;
                }).join('');
            }
        }

        // Sector exposure
        const secEl = document.getElementById('aaSectorExposure');
        if (secEl) {
            if (expTotal === 0) {
                secEl.innerHTML = '<div style="color:#6868a0;font-size:11px;text-align:center;padding:16px;">No open positions.</div>';
            } else {
                const sorted = Object.entries(exposure).sort((a,b) => b[1]-a[1]);
                const sectorColors = { Technology:'#60a5fa', Financials:'#4ade80', Healthcare:'#34d399', Energy:'#f59e0b', Consumer:'#fb923c', Industrials:'#a78bfa', Other:'#8888a8', 'Digital Asset':'#f472b6', Commodity:'#fbbf24', Forex:'#22d3ee', Index:'#818cf8' };
                secEl.innerHTML = sorted.map(([sec, val]) => {
                    const pct = (val / expTotal * 100).toFixed(1);
                    const col = sectorColors[sec] || '#8888a8';
                    return `<div>
                        <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;">
                            <span style="color:${col};">${sec}</span>
                            <span style="font-family:var(--v-mono);color:#f0f0fa;">${pct}%</span>
                        </div>
                        <div style="height:6px;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;">
                            <div style="height:100%;width:${pct}%;background:${col};border-radius:3px;transition:width 0.5s;"></div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // Best/Worst trades
        const bwEl = document.getElementById('aaBestWorst');
        if (bwEl && sells.length > 0) {
            const withPnl = sells.map(t => ({
                ...t,
                pnl: ((t.price - (t.avgBuy || t.price)) / (t.avgBuy || t.price) * 100)
            })).sort((a, b) => b.pnl - a.pnl);
            const best3 = withPnl.slice(0, 3);
            const worst3 = withPnl.slice(-3).reverse();
            const row = (t, isGain) => `<div style="display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                <span style="font-weight:600;color:#f0f0fa;font-size:12px;">${t.symbol}</span>
                <span style="font-family:var(--v-mono);font-size:12px;color:${isGain ? '#4ade80' : '#f87171'};font-weight:700;">${t.pnl >= 0 ? '+' : ''}${t.pnl.toFixed(2)}%</span>
            </div>`;
            bwEl.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">
                <div>
                    <div style="font-size:10px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">ğŸ† Best Trades</div>
                    ${best3.map(t => row(t, true)).join('')}
                </div>
                <div>
                    <div style="font-size:10px;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">ğŸ“‰ Worst Trades</div>
                    ${worst3.map(t => row(t, false)).join('')}
                </div>
            </div>`;
        } else if (bwEl) {
            bwEl.innerHTML = '<div style="color:#6868a0;font-size:11px;text-align:center;padding:16px;">Close trades to see breakdown.</div>';
        }

        // Capital Allocation Simulator
        renderCapitalAllocator();
    }

    function renderCapitalAllocator() {
        const el = document.getElementById('aaAllocSim');
        if (!el) return;
        const totalCap = cash + getPortfolioValue();
        const strats = (strategies || []);
        if (strats.length === 0) {
            el.innerHTML = '<div style="color:#6868a0;font-size:11px;font-style:italic;">Create strategies in Strategy Lab to simulate capital allocation.</div>';
            return;
        }
        const equal = (100 / strats.length).toFixed(1);
        el.innerHTML = `<div style="font-size:10px;color:#8888a8;margin-bottom:10px;">Simulate how allocating capital across strategies affects your portfolio stability.</div>
        <div style="display:grid;gap:8px;">
        ${strats.map(s => {
            const stats = getStrategyStats(s);
            const allocated = (totalCap * parseFloat(equal) / 100);
            return `<div style="display:flex;align-items:center;gap:10px;background:rgba(255,255,255,0.03);border-radius:8px;padding:8px 12px;">
                <div style="flex:1;font-size:12px;color:#f0f0fa;font-weight:600;">${s.name}</div>
                <div style="font-size:10px;color:#a78bfa;font-family:var(--v-mono);">${equal}%</div>
                <div style="font-size:10px;color:#f0f0fa;font-family:var(--v-mono);">$${allocated.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                <div style="font-size:10px;color:${stats.winRate !== 'â€”' && parseInt(stats.winRate) >= 50 ? '#4ade80' : '#f59e0b'};">WR: ${stats.winRate}${stats.winRate !== 'â€”' ? '%' : ''}</div>
            </div>`;
        }).join('')}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AI COACH & BIAS MONITOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openAICoach() {
        const el = document.getElementById('aiCoachModal');
        if (el) { el.style.display = 'flex'; renderAICoach(); }
    }
    function closeAICoach() {
        const el = document.getElementById('aiCoachModal');
        if (el) el.style.display = 'none';
    }

    function computeDisciplineScores() {
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        const buys = (transactions || []).filter(t => t.type === 'BUY');
        const n = sells.length;
        if (n === 0) return { discipline: 50, consistency: 50, risk: 50, emotional: 50 };

        // Discipline: ratio of wins + adherence to RiskGuard
        const wins = sells.filter(t => (t.price - (t.avgBuy || t.price)) > 0);
        const winRate = wins.length / n;
        const discipline = Math.min(100, Math.round(winRate * 70 + 30));

        // Consistency: std dev of hold times
        const holdTimes = sells.map(t => {
            const matchBuy = buys.filter(b => b.symbol === t.symbol && b.ts < t.ts);
            return matchBuy.length ? t.ts - matchBuy[matchBuy.length-1].ts : 0;
        }).filter(h => h > 0);
        const avgHold = holdTimes.length ? holdTimes.reduce((a,b)=>a+b,0)/holdTimes.length : 1;
        const stdHold = holdTimes.length > 1
            ? Math.sqrt(holdTimes.reduce((a,b)=>a+Math.pow(b-avgHold,2),0)/holdTimes.length)
            : avgHold * 0.5;
        const cvHold = stdHold / (avgHold || 1);
        const consistency = Math.min(100, Math.round(100 - cvHold * 40));

        // Risk: detect oversizing
        const tradeSizes = buys.map(t => (t.price * (t.qty || 1)) / (cash + getPortfolioValue()));
        const avgSize = tradeSizes.reduce((a,b)=>a+b,0) / (tradeSizes.length || 1);
        const risk = avgSize < 0.05 ? 90 : avgSize < 0.1 ? 75 : avgSize < 0.2 ? 55 : 30;

        // Emotional: detect revenge trading / overtrading after losses
        let revengeCount = 0;
        for (let i = 1; i < sells.length; i++) {
            const prev = sells[i-1];
            const curr = sells[i];
            const prevLoss = (prev.price - (prev.avgBuy || prev.price)) < 0;
            const rapidRebuy = (curr.ts - prev.ts) < 3600000;
            if (prevLoss && rapidRebuy) revengeCount++;
        }
        const revengeRatio = revengeCount / (n || 1);
        const emotional = Math.min(100, Math.round(100 - revengeRatio * 200));

        return { discipline, consistency, risk, emotional };
    }

    function detectBiasPatterns() {
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        const buys = (transactions || []).filter(t => t.type === 'BUY');
        const patterns = [];

        if (sells.length < 3) return patterns;

        // Overtrading detection
        const dailyCounts = {};
        buys.forEach(t => {
            const dk = new Date(t.ts).toDateString();
            dailyCounts[dk] = (dailyCounts[dk] || 0) + 1;
        });
        const maxDaily = Math.max(...Object.values(dailyCounts), 0);
        if (maxDaily > 5) patterns.push({ icon:'âš¡', name:'Overtrading Detected', desc:`${maxDaily} trades in a single session. High frequency correlates with lower discipline scores.`, severity:'high' });

        // Revenge trading
        let revengeCount = 0;
        for (let i = 1; i < sells.length; i++) {
            if ((sells[i-1].price - (sells[i-1].avgBuy || sells[i-1].price)) < 0 && (sells[i].ts - sells[i-1].ts) < 3600000) revengeCount++;
        }
        if (revengeCount > 0) patterns.push({ icon:'ğŸ”', name:'Revenge Trading Pattern', desc:`${revengeCount} instances of rapid re-entry after a loss. This often amplifies losses.`, severity:'high' });

        // Early profit cutting
        const earlyExits = sells.filter(t => {
            const gain = (t.price - (t.avgBuy || t.price)) / (t.avgBuy || t.price) * 100;
            return gain > 0 && gain < 1.5;
        });
        if (earlyExits.length > sells.length * 0.4) patterns.push({ icon:'âœ‚ï¸', name:'Early Profit Cutting', desc:`${((earlyExits.length/sells.length)*100).toFixed(0)}% of winning trades closed with <1.5% gain. You may be cutting winners short.`, severity:'medium' });

        // Holding losers too long
        const bigLosses = sells.filter(t => {
            const loss = (t.price - (t.avgBuy || t.price)) / (t.avgBuy || t.price) * 100;
            return loss < -5;
        });
        if (bigLosses.length > sells.length * 0.25) patterns.push({ icon:'ğŸ§Š', name:'Loss Aversion / Holding Losers', desc:`${((bigLosses.length/sells.length)*100).toFixed(0)}% of closed trades had >5% loss â€” you may be holding losers too long.`, severity:'medium' });

        // Recency bias â€” win rate after loss streaks
        let lossStreak = 0, totalAfterStreak = 0, winsAfterStreak = 0;
        for (let i = 0; i < sells.length; i++) {
            if ((sells[i].price - (sells[i].avgBuy || sells[i].price)) < 0) {
                lossStreak++;
            } else {
                if (lossStreak >= 2 && i + 1 < sells.length) {
                    totalAfterStreak++;
                    if ((sells[i+1]?.price - (sells[i+1]?.avgBuy || sells[i+1]?.price)) > 0) winsAfterStreak++;
                }
                lossStreak = 0;
            }
        }
        if (totalAfterStreak > 0 && winsAfterStreak / totalAfterStreak < 0.4) {
            patterns.push({ icon:'ğŸ”®', name:'Recency Bias After Loss Streaks', desc:`Your win rate after 2+ consecutive losses is ${((winsAfterStreak/totalAfterStreak)*100).toFixed(0)}% â€” significantly below average.`, severity:'medium' });
        }

        if (patterns.length === 0) patterns.push({ icon:'âœ…', name:'No Significant Bias Detected', desc:'Your trading pattern appears disciplined based on available data. Keep monitoring.', severity:'low' });

        // Risk escalation after losses
        const metricsCheck = computeAllMetrics();
        if (metricsCheck.riskEscalation) {
            patterns.push({ icon:'ğŸ“ˆ', name:'Risk Escalation After Losses', desc:'Your position sizes appear to increase after losing trades. This is a common recovery trap â€” it amplifies drawdowns, not recoveries.', severity:'high' });
        }

        // Overconfidence after win streak
        if (metricsCheck.overconfidenceRisk) {
            patterns.push({ icon:'âš¡', name:'Overconfidence Risk â€” Long Win Streak', desc:`Win streak of ${metricsCheck.winStreak} detected. Research shows traders after long streaks take on excess risk. Review your last 3 position sizes.`, severity:'medium' });
        }

        // Impatience (very low avg time between trades)
        if (metricsCheck.avgTimeBetweenTrades > 0 && metricsCheck.avgTimeBetweenTrades < 0.25) {
            patterns.push({ icon:'â±', name:'Rapid-Fire Trading Pattern', desc:`Average ${(metricsCheck.avgTimeBetweenTrades*60).toFixed(0)} minutes between trades. Speed often signals reactive trading rather than planned execution.`, severity:'medium' });
        }

        return patterns;
    }

    function renderAICoach() {
        const scores = computeDisciplineScores();
        const patterns = detectBiasPatterns();

        // Scores ring
        const scoresEl = document.getElementById('coachScores');
        if (scoresEl) {
            const scoreItems = [
                { label:'Discipline', val: scores.discipline, color:'#a78bfa' },
                { label:'Consistency', val: scores.consistency, color:'#60a5fa' },
                { label:'Risk Control', val: scores.risk, color:'#4ade80' },
                { label:'Emotional', val: scores.emotional, color:'#f59e0b' },
            ];
            scoresEl.innerHTML = scoreItems.map(s => {
                const grade = s.val >= 80 ? 'A' : s.val >= 65 ? 'B' : s.val >= 50 ? 'C' : 'D';
                const gradeCol = s.val >= 80 ? '#4ade80' : s.val >= 65 ? '#f59e0b' : '#f87171';
                const dash = 2 * Math.PI * 28;
                const filled = dash * (s.val / 100);
                return `<div style="text-align:center;">
                    <svg width="72" height="72" viewBox="0 0 72 72">
                        <circle cx="36" cy="36" r="28" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="6"/>
                        <circle cx="36" cy="36" r="28" fill="none" stroke="${s.color}" stroke-width="6"
                            stroke-dasharray="${filled.toFixed(1)} ${(dash-filled).toFixed(1)}"
                            stroke-dashoffset="${(dash/4).toFixed(1)}" stroke-linecap="round"/>
                        <text x="36" y="33" text-anchor="middle" font-size="13" font-weight="700" fill="${gradeCol}">${grade}</text>
                        <text x="36" y="45" text-anchor="middle" font-size="9" fill="#8888a8">${s.val}</text>
                    </svg>
                    <div style="font-size:10px;font-weight:600;color:#c0c0d8;margin-top:3px;">${s.label}</div>
                </div>`;
            }).join('');
        }

        // Bias patterns
        const biasEl = document.getElementById('coachBiasPatterns');
        if (biasEl) {
            const severityColors = { high: '#f87171', medium: '#f59e0b', low: '#4ade80' };
            biasEl.innerHTML = patterns.map(p => `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-left:3px solid ${severityColors[p.severity]};border-radius:0 10px 10px 0;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
                <span style="font-size:1.3rem;flex-shrink:0;">${p.icon}</span>
                <div>
                    <div style="font-size:12px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">${p.name}</div>
                    <div style="font-size:11px;color:#8888a8;line-height:1.55;">${p.desc}</div>
                </div>
            </div>`).join('');
        }

        // Analytical insights
        const insightsEl = document.getElementById('coachInsights');
        if (insightsEl) {
            const sells = (transactions || []).filter(t => t.type === 'SELL');
            const wins = sells.filter(t => (t.price - (t.avgBuy || t.price)) > 0);
            const winRate = sells.length > 0 ? (wins.length / sells.length * 100).toFixed(1) : 'â€”';
            const avgWin = wins.length > 0 ? (wins.reduce((s, t) => s + ((t.price - (t.avgBuy || t.price)) / (t.avgBuy || t.price) * 100), 0) / wins.length).toFixed(2) : 'â€”';
            const losses = sells.filter(t => (t.price - (t.avgBuy || t.price)) <= 0);
            const avgLoss = losses.length > 0 ? (losses.reduce((s, t) => s + ((t.price - (t.avgBuy || t.price)) / (t.avgBuy || t.price) * 100), 0) / losses.length).toFixed(2) : 'â€”';
            const profitFactor = avgLoss !== 'â€”' && avgWin !== 'â€”' && parseFloat(avgLoss) !== 0 ? Math.abs(parseFloat(avgWin) / parseFloat(avgLoss)).toFixed(2) : 'â€”';
            insightsEl.innerHTML = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                ${[
                    { l:'Win Rate', v: winRate !== 'â€”' ? winRate + '%' : 'â€”', c: parseFloat(winRate) >= 50 ? '#4ade80' : '#f87171' },
                    { l:'Avg Win', v: avgWin !== 'â€”' ? '+' + avgWin + '%' : 'â€”', c:'#4ade80' },
                    { l:'Avg Loss', v: avgLoss !== 'â€”' ? avgLoss + '%' : 'â€”', c:'#f87171' },
                    { l:'Profit Factor', v: profitFactor, c: parseFloat(profitFactor) >= 1.5 ? '#4ade80' : '#f59e0b' },
                ].map(m => `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;padding:10px 12px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">${m.l}</div>
                    <div style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:${m.c};">${m.v}</div>
                </div>`).join('')}
            </div>`;
        }

        // Market Regime
        renderMarketRegime();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MARKET REGIME CLASSIFIER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function classifyMarketRegime() {
        const spy = stocks.find(s => s.symbol === 'SPY') || stocks.find(s => s.symbol === 'AAPL');
        if (!spy) return { regime:'Unknown', color:'#8888a8', icon:'â“' };

        const change = Math.abs(spy.change || 0);
        const allChanges = stocks.slice(0, 20).map(s => Math.abs(s.change || 0));
        const avgVol = allChanges.reduce((a,b)=>a+b,0) / allChanges.length;
        const breadthUp = stocks.slice(0, 30).filter(s => (s.change || 0) > 0).length;
        const breadthPct = breadthUp / 30;

        if (avgVol > 2.5) return { regime:'High Volatility', color:'#f87171', icon:'âš¡', desc:'Large intraday swings. Wider stops, tighter positions.' };
        if (breadthPct > 0.65) return { regime:'Trending Up', color:'#4ade80', icon:'ğŸ“ˆ', desc:'Broad-based rally. Trend-following strategies perform well.' };
        if (breadthPct < 0.35) return { regime:'Trending Down', color:'#f59e0b', icon:'ğŸ“‰', desc:'Market-wide selling. Consider defense and cash preservation.' };
        if (avgVol < 0.8) return { regime:'Low Volatility', color:'#60a5fa', icon:'ğŸ’¤', desc:'Compressed ranges. Options strategies and mean reversion.' };
        return { regime:'Range-Bound', color:'#a78bfa', icon:'â†”ï¸', desc:'No clear trend. Range trading and sector rotation.' };
    }

    function renderMarketRegime() {
        const el = document.getElementById('coachRegime');
        if (!el) return;
        const reg = classifyMarketRegime();

        // Performance per regime (simulated from transactions)
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        el.innerHTML = `<div style="display:flex;align-items:center;gap:16px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
            <div style="font-size:2.5rem;">${reg.icon}</div>
            <div>
                <div style="font-size:1rem;font-weight:700;color:${reg.color};margin-bottom:3px;">${reg.regime}</div>
                <div style="font-size:11px;color:#8888a8;line-height:1.55;">${reg.desc}</div>
            </div>
            <div style="margin-left:auto;text-align:right;font-size:11px;color:#8888a8;">
                <div>Total trades: <strong style="color:#f0f0fa;">${sells.length}</strong></div>
                <div>Active signals: <strong style="color:${reg.color};">${reg.regime}</strong></div>
            </div>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CHALLENGE MODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let challengeState = null;

    function loadChallengeState() {
        try {
            const saved = localStorage.getItem('vestra_challenge_v1');
            if (saved) challengeState = JSON.parse(saved);
        } catch(_) {}
    }

    function saveChallengeState() {
        try {
            if (challengeState) localStorage.setItem('vestra_challenge_v1', JSON.stringify(challengeState));
        } catch(_) {}
    }

    function openChallengeMode() {
        loadChallengeState();
        const el = document.getElementById('challengeModal');
        if (el) { el.style.display = 'flex'; renderChallengeModal(); }
    }
    function closeChallengeMode() {
        const el = document.getElementById('challengeModal');
        if (el) el.style.display = 'none';
    }

    const CHALLENGE_TIERS = [
        { id:'cadet',     name:'Cadet',     icon:'ğŸ¥‰', minReturn:-Infinity, maxDD:-15, maxRisk:3,  startCash:10000,  desc:'Learn discipline fundamentals. Max 3% risk per trade.' },
        { id:'analyst',   name:'Analyst',   icon:'ğŸ¥ˆ', minReturn:5,         maxDD:-12, maxRisk:2,  startCash:25000,  desc:'Prove consistent edge. Earn +5% with strict risk control.' },
        { id:'associate', name:'Associate', icon:'ğŸ¥‡', minReturn:10,        maxDD:-10, maxRisk:1.5,startCash:50000,  desc:'Professional-grade discipline. +10% with <10% drawdown.' },
        { id:'pm',        name:'Portfolio Manager', icon:'ğŸ’', minReturn:20, maxDD:-8, maxRisk:1, startCash:100000, desc:'Elite performance. +20% return with near-zero tolerance for error.' },
    ];

    function startChallenge(tierId) {
        const tier = CHALLENGE_TIERS.find(t => t.id === tierId);
        if (!tier) return;
        challengeState = {
            tierId, startedAt: Date.now(),
            startCash: tier.startCash,
            currentVal: tier.startCash,
            trades: [],
            violations: [],
            completed: false,
            failed: false,
        };
        saveChallengeState();
        renderChallengeModal();
        pushNotif('info', `ğŸ† Challenge started: ${tier.icon} ${tier.name} â€” $${tier.startCash.toLocaleString()} capital, strict rules active.`);
    }

    function resetChallenge() {
        challengeState = null;
        localStorage.removeItem('vestra_challenge_v1');
        renderChallengeModal();
    }

    function renderChallengeModal() {
        const el = document.getElementById('challengeContent');
        if (!el) return;

        if (!challengeState) {
            // Show tier selection
            el.innerHTML = `<div>
                <div style="font-size:11px;color:#8888a8;margin-bottom:16px;line-height:1.6;">Select a challenge tier. Each tier enforces strict risk rules and measures your progression as a disciplined trader. All P&L is simulated.</div>
                <div style="display:grid;gap:12px;">
                ${CHALLENGE_TIERS.map(t => `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:16px;display:flex;align-items:center;gap:16px;">
                    <div style="font-size:2rem;flex-shrink:0;">${t.icon}</div>
                    <div style="flex:1;">
                        <div style="font-size:13px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">${t.name}</div>
                        <div style="font-size:10px;color:#8888a8;">${t.desc}</div>
                        <div style="display:flex;gap:12px;margin-top:6px;font-size:10px;color:#6868a0;">
                            <span>Capital: <strong style="color:#f0f0fa;">$${t.startCash.toLocaleString()}</strong></span>
                            <span>Max Risk: <strong style="color:#f59e0b;">${t.maxRisk}%</strong></span>
                            <span>Max DD: <strong style="color:#f87171;">${t.maxDD}%</strong></span>
                            ${t.minReturn > 0 ? `<span>Target: <strong style="color:#4ade80;">+${t.minReturn}%</strong></span>` : ''}
                        </div>
                    </div>
                    <button onclick="startChallenge('${t.id}')" style="background:rgba(212,168,75,0.12);color:var(--v-gold);border:1px solid rgba(212,168,75,0.25);border-radius:8px;padding:8px 16px;font-size:11px;font-weight:700;cursor:pointer;flex-shrink:0;">Start</button>
                </div>`).join('')}
                </div>
            </div>`;
            return;
        }

        const tier = CHALLENGE_TIERS.find(t => t.id === challengeState.tierId);
        if (!tier) return;

        const totalVal = challengeState.currentVal;
        const returnPct = ((totalVal - challengeState.startCash) / challengeState.startCash * 100);
        const daysActive = Math.max(1, Math.round((Date.now() - challengeState.startedAt) / 86400000));
        const statusColor = challengeState.failed ? '#f87171' : challengeState.completed ? '#4ade80' : '#f59e0b';
        const status = challengeState.failed ? 'âŒ Failed' : challengeState.completed ? 'âœ… Completed' : 'ğŸŸ¡ Active';

        el.innerHTML = `<div>
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:20px;margin-bottom:16px;">
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:14px;">
                    <div>
                        <div style="font-size:1.1rem;font-weight:700;color:#f0f0fa;">${tier.icon} ${tier.name} Challenge</div>
                        <div style="font-size:10px;color:${statusColor};margin-top:2px;">${status} Â· Day ${daysActive}</div>
                    </div>
                    <button onclick="resetChallenge()" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#f87171;border-radius:6px;padding:4px 10px;font-size:10px;cursor:pointer;">Reset</button>
                </div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:14px;">
                    ${[
                        { l:'Capital', v:'$'+totalVal.toLocaleString(undefined,{maximumFractionDigits:0}), c:'#60a5fa' },
                        { l:'Return', v:(returnPct>=0?'+':'')+returnPct.toFixed(2)+'%', c:returnPct>=0?'#4ade80':'#f87171' },
                        { l:'Target', v:tier.minReturn>0?'+'+tier.minReturn+'%':'Discipline', c:'#f59e0b' },
                    ].map(m=>`<div style="text-align:center;background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;">${m.l}</div>
                        <div style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:${m.c};">${m.v}</div>
                    </div>`).join('')}
                </div>
                <div style="margin-bottom:8px;">
                    <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:4px;"><span style="color:#8888a8;">Progress to target</span><span style="color:#f0f0fa;">${Math.min(100,Math.max(0,(returnPct/(tier.minReturn||20)*100))).toFixed(0)}%</span></div>
                    <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
                        <div style="height:100%;width:${Math.min(100,Math.max(0,(returnPct/(tier.minReturn||20)*100))).toFixed(0)}%;background:linear-gradient(90deg,#f59e0b,#4ade80);border-radius:4px;transition:width 0.5s;"></div>
                    </div>
                </div>
                ${challengeState.violations.length > 0 ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:10px;color:#f87171;">âš ï¸ ${challengeState.violations.length} rule violation(s) recorded</div>` : ''}
            </div>
            <div style="font-size:11px;color:#8888a8;line-height:1.6;padding:12px;background:rgba(212,168,75,0.05);border:1px solid rgba(212,168,75,0.12);border-radius:10px;">
                <strong style="color:var(--v-gold);">Active Rules:</strong> Max ${tier.maxRisk}% risk per trade Â· Max ${tier.maxDD}% drawdown Â· No leverage Â· Realism Mode required for scoring
            </div>
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MULTI-ASSET PANEL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openMultiAsset() {
        const el = document.getElementById('multiAssetModal');
        if (el) { el.style.display = 'flex'; renderMultiAsset(); }
    }
    function closeMultiAsset() {
        const el = document.getElementById('multiAssetModal');
        if (el) el.style.display = 'none';
    }

    function renderMultiAsset() {
        const el = document.getElementById('maContent');
        if (!el) return;
        const assetClasses = [
            { id:'ETF',      label:'Index & Sector ETFs', icon:'ğŸ“¦', color:'#818cf8' },
            { id:'Commodity', label:'Commodities',         icon:'ğŸ—', color:'#fbbf24' },
            { id:'Forex',    label:'Forex â€” Major Pairs',  icon:'ğŸ’±', color:'#22d3ee' },
            { id:'Crypto',   label:'Digital Assets',       icon:'â‚¿',  color:'#f472b6' },
        ];
        el.innerHTML = assetClasses.map(ac => {
            const assetStocks = stocks.filter(s => {
                const md = realStockData[s.symbol];
                return md && md.assetClass === ac.id;
            });
            if (assetStocks.length === 0) return '';
            return `<div style="margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;color:${ac.color};text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;display:flex;align-items:center;gap:6px;">${ac.icon} ${ac.label}</div>
                <div style="display:grid;gap:6px;">
                ${assetStocks.map(s => {
                    const isPos = (s.change || 0) >= 0;
                    const session = (realStockData[s.symbol] || {}).session || 'NYSE';
                    const sessionOpen = session === '24/7' || session === 'Forex24' || isMarketOpen();
                    const sesColor = sessionOpen ? '#4ade80' : '#6868a0';
                    return `<div onclick="openStockDetail(stocks.find(st=>st.symbol==='${s.symbol}'))" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px 14px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:background 0.15s;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='rgba(255,255,255,0.03)'">
                        <div style="flex:1;">
                            <div style="display:flex;align-items:center;gap:6px;">
                                <span style="font-weight:700;color:#f0f0fa;font-size:12px;">${s.symbol}</span>
                                <span style="font-size:9px;padding:1px 5px;border-radius:3px;background:${ac.color}18;color:${ac.color};font-weight:700;">${ac.id}</span>
                                <span style="font-size:8px;padding:1px 5px;border-radius:3px;background:${sesColor}18;color:${sesColor};">â— ${session}</span>
                            </div>
                            <div style="font-size:10px;color:#8888a8;margin-top:1px;">${s.name}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-family:var(--v-mono);font-size:13px;color:#f0f0fa;font-weight:600;">${s.price >= 100 ? '$'+s.price.toFixed(2) : s.price >= 1 ? '$'+s.price.toFixed(4) : '$'+s.price.toFixed(5)}</div>
                            <div style="font-size:11px;color:${isPos?'#4ade80':'#f87171'};font-family:var(--v-mono);">${isPos?'+':''}${(s.change||0).toFixed(2)}%</div>
                        </div>
                    </div>`;
                }).join('')}
                </div>
            </div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ENHANCED LEADERBOARD â€” Risk-Adjusted Mode
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _lbRiskAdjMode = false;
    function toggleLBRiskAdj() {
        _lbRiskAdjMode = !_lbRiskAdjMode;
        const btn = document.getElementById('lbRiskAdjBtn');
        if (btn) {
            btn.style.background = _lbRiskAdjMode ? 'rgba(74,222,128,0.15)' : 'rgba(255,255,255,0.06)';
            btn.style.color = _lbRiskAdjMode ? '#4ade80' : '#8888a8';
        }
        renderLeaderboard();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STRATEGY LAB v6 â€” Enhanced with Target R, Equity Curve, Tabs, Stress Test
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openStrategyLabTab(tab) {
        document.getElementById('slPanelList').style.display   = (tab === 'list')   ? 'block' : 'none';
        document.getElementById('slPanelStress').style.display = (tab === 'stress') ? 'block' : 'none';
        document.getElementById('slTabList').style.background   = tab === 'list'   ? 'rgba(167,139,250,0.15)' : 'transparent';
        document.getElementById('slTabList').style.color        = tab === 'list'   ? '#a78bfa' : '#6868a0';
        document.getElementById('slTabList').style.border       = tab === 'list'   ? '1px solid rgba(167,139,250,0.3)' : '1px solid rgba(255,255,255,0.08)';
        document.getElementById('slTabStress').style.background = tab === 'stress' ? 'rgba(167,139,250,0.15)' : 'transparent';
        document.getElementById('slTabStress').style.color      = tab === 'stress' ? '#a78bfa' : '#6868a0';
        document.getElementById('slTabStress').style.border     = tab === 'stress' ? '1px solid rgba(167,139,250,0.3)' : '1px solid rgba(255,255,255,0.08)';
        if (tab === 'stress') populateStressStrategySelect();
    }

    function populateStressStrategySelect() {
        const sel = document.getElementById('stressStratSelect');
        if (!sel) return;
        sel.innerHTML = '<option value="">â€” Select a strategy â€”</option>' +
            strategies.map(s => `<option value="${s.id}">${s.name} (${s.tag})</option>`).join('');
    }

    // Override createStrategy to use enhanced version
    window.createStrategy = function() {
        const name    = document.getElementById('slName')?.value?.trim();
        const tag     = document.getElementById('slTag')?.value;
        const entry   = document.getElementById('slEntry')?.value?.trim();
        const exit    = document.getElementById('slExit')?.value?.trim();
        const risk    = parseFloat(document.getElementById('slRisk')?.value) || 1;
        const targetR = parseFloat(document.getElementById('slTargetR')?.value) || 2;
        if (!name) return;
        const id = 'str_' + Date.now();
        strategies.push({ id, name, tag, entry, exit, risk, targetR, createdAt: Date.now() });
        saveStrategies();
        renderStrategyList();
        pushNotif('info', `ğŸ§ª Strategy "${name}" created â€” ${risk}% risk, ${targetR}R target.`);
        ['slName','slEntry','slExit'].forEach(fid => { const el=document.getElementById(fid); if(el)el.value=''; });
    };

    // Enhanced renderStrategyList with equity curve sparkline and drawdown
    function renderStrategyList() {
        const el = document.getElementById('strategyList');
        if (!el) return;
        if (!strategies.length) {
            el.innerHTML = '<div style="text-align:center;color:#6868a0;padding:24px;font-style:italic;font-size:12px;">No strategies yet. Create one above to start tracking performance.</div>';
            return;
        }
        const tagColors = { '#Breakout':'#60a5fa','#Swing':'#4ade80','#Earnings':'#f59e0b','#Momentum':'#a78bfa','#Reversal':'#f87171','#Scalp':'#f0c96a','#ValueBuy':'#34d399','#DipBuy':'#fb923c','#MeanRevert':'#22d3ee','#CatalystPlay':'#f472b6' };
        el.innerHTML = strategies.map(s => {
            const sells = (transactions||[]).filter(t => t.type==='SELL' && t.strategyId===s.id);
            const wins  = sells.filter(t => (t.price-(t.avgBuy||t.price))>0);
            const winRate = sells.length > 0 ? (wins.length/sells.length*100).toFixed(0) : 'â€”';
            const returns = sells.map(t => (t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100);
            const avgR = returns.length > 0 ? (returns.reduce((a,b)=>a+b,0)/returns.length).toFixed(1) : 'â€”';
            const tagC  = tagColors[s.tag] || '#8888a8';
            const wc    = winRate !== 'â€”' ? (parseInt(winRate)>=50?'#4ade80':'#f87171') : '#8888a8';
            const rc    = avgR !== 'â€”' ? (parseFloat(avgR)>=0?'#4ade80':'#f87171') : '#8888a8';

            // Build equity curve sparkline
            let sparkSVG = '';
            if (returns.length >= 3) {
                let eq = 100;
                const pts = [100];
                returns.forEach(r => { eq *= (1 + r/100); pts.push(eq); });
                const minV = Math.min(...pts), maxV = Math.max(...pts);
                const range = maxV - minV || 1;
                const W = 100, H = 30;
                const coords = pts.map((v,i) => `${(i/(pts.length-1)*W).toFixed(1)},${(H - ((v-minV)/range*H)).toFixed(1)}`).join(' ');
                const finalColor = pts[pts.length-1] >= 100 ? '#4ade80' : '#f87171';
                sparkSVG = `<svg width="${W}" height="${H}" viewBox="0 0 ${W} ${H}" style="display:block;">
                    <polyline points="${coords}" fill="none" stroke="${finalColor}" stroke-width="1.5" stroke-linejoin="round"/>
                </svg>`;
            }

            // Max drawdown
            let maxDD = 0;
            if (returns.length > 0) {
                let peak = 100, eq2 = 100;
                returns.forEach(r => {
                    eq2 *= (1+r/100);
                    if (eq2 > peak) peak = eq2;
                    const dd = (eq2-peak)/peak*100;
                    if (dd < maxDD) maxDD = dd;
                });
            }

            // R-multiple achieved
            const actualR = sells.length > 0 && s.risk > 0
                ? (returns.reduce((a,b)=>a+b,0) / sells.length / s.risk).toFixed(1) : 'â€”';

            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:14px;padding:14px 16px;">
                <div style="display:grid;grid-template-columns:1fr auto;gap:12px;align-items:start;">
                    <div style="min-width:0;">
                        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;flex-wrap:wrap;">
                            <span style="font-weight:700;color:#f0f0fa;font-size:13px;">${s.name}</span>
                            <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;background:${tagC}18;color:${tagC};border:1px solid ${tagC}28;">${s.tag}</span>
                            <span style="font-size:10px;color:#6868a0;">Risk: ${s.risk}% Â· Target: ${s.targetR||2}R</span>
                        </div>
                        ${s.entry ? `<div style="font-size:10px;color:#8888a8;margin-bottom:1px;">â–¶ ${s.entry}</div>` : ''}
                        ${s.exit  ? `<div style="font-size:10px;color:#8888a8;margin-bottom:8px;">â—€ ${s.exit}</div>` : ''}
                        <div style="display:flex;gap:16px;font-size:11px;flex-wrap:wrap;">
                            <span style="color:#8888a8;">Trades: <strong style="color:#f0f0fa;">${sells.length}</strong></span>
                            <span style="color:#8888a8;">Win: <strong style="color:${wc};">${winRate}${winRate!=='â€”'?'%':''}</strong></span>
                            <span style="color:#8888a8;">Avg%: <strong style="color:${rc};">${avgR}${avgR!=='â€”'?'%':''}</strong></span>
                            <span style="color:#8888a8;">R achieved: <strong style="color:${actualR!=='â€”'&&parseFloat(actualR)>=(s.targetR||2)?'#4ade80':actualR!=='â€”'?'#f59e0b':'#8888a8'};">${actualR}</strong></span>
                            <span style="color:#8888a8;">Max DD: <strong style="color:${maxDD<-10?'#f87171':maxDD<-5?'#f59e0b':'#4ade80'};">${maxDD.toFixed(1)}%</strong></span>
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:8px;">
                        <button onclick="deleteStrategy('${s.id}')" style="background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);color:#f87171;border-radius:6px;padding:3px 8px;font-size:10px;cursor:pointer;white-space:nowrap;">Delete</button>
                        ${sparkSVG ? `<div title="Equity curve">${sparkSVG}</div>` : '<div style="font-size:9px;color:#6868a0;padding:4px;">No trades yet</div>'}
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    // â”€â”€ Stress Test Engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function runStressTest() {
        const stratId = document.getElementById('stressStratSelect')?.value;
        const strat = strategies.find(s => s.id === stratId);
        const btnEl = document.getElementById('stressRunBtn');
        const resEl = document.getElementById('stressResults');
        if (!resEl) return;

        // Build base returns from strategy trade history or overall history as fallback
        let sells = stratId
            ? (transactions||[]).filter(t => t.type==='SELL' && t.strategyId===stratId)
            : (transactions||[]).filter(t => t.type==='SELL');
        if (!sells.length) {
            // Simulate with random realistic returns
            sells = Array.from({length:20},(_,i)=>({
                price: 100 + (Math.random()*20-8),
                avgBuy: 100,
                strategyId: stratId
            }));
        }
        const baseReturns = sells.map(t => (t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100);

        if (btnEl) { btnEl.classList.add('stress-running'); btnEl.textContent = 'â³ Runningâ€¦'; }

        setTimeout(() => {
            if (btnEl) { btnEl.classList.remove('stress-running'); btnEl.textContent = 'â–¶ Run Stress Test'; }

            const scenarios = [];

            if (document.getElementById('sc_hv')?.checked) {
                // High vol: widen returns by Ã—2, add extra losses
                const hvReturns = baseReturns.map(r => r > 0 ? r * 0.65 : r * 2.1);
                scenarios.push({ name:'âš¡ High Volatility', color:'#f87171', returns:hvReturns,
                    desc:'VIX >30: Winners compressed, losers amplified.' });
            }
            if (document.getElementById('sc_news')?.checked) {
                // News shock: 15% of trades have +/-12% gap
                const newsReturns = baseReturns.map(r => Math.random()<0.15 ? r + (Math.random()<0.5?12:-12) : r);
                scenarios.push({ name:'ğŸ“° News Event', color:'#f59e0b', returns:newsReturns,
                    desc:'Earnings/FOMC gaps applied to 15% of trades.' });
            }
            if (document.getElementById('sc_ll')?.checked) {
                // Low liquidity: add slippage -0.3% to -0.8% per trade
                const llReturns = baseReturns.map(r => r - (0.3 + Math.random()*0.5));
                scenarios.push({ name:'ğŸ’¤ Low Liquidity', color:'#60a5fa', returns:llReturns,
                    desc:'Holiday/thin market. Spread cost applied.' });
            }
            if (document.getElementById('sc_gap')?.checked) {
                // Gap risk: 10% of trades stop blown
                const gapReturns = baseReturns.map(r => Math.random()<0.1 ? Math.min(r, -(strat?.risk||2)*2.5) : r);
                scenarios.push({ name:'â†•ï¸ Gap Risk', color:'#a78bfa', returns:gapReturns,
                    desc:'10% of stops gapped through. Position sizing critical.' });
            }

            if (!scenarios.length) {
                resEl.style.display = 'block';
                resEl.innerHTML = '<div style="color:#8888a8;font-size:11px;padding:8px;">Select at least one scenario to test.</div>';
                return;
            }

            // Add baseline
            scenarios.unshift({ name:'ğŸ“‹ Baseline', color:'#8888a8', returns:baseReturns, desc:'Your actual/expected performance without stress.' });

            resEl.style.display = 'block';
            resEl.innerHTML = `<div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:12px;">Stress Test Results${strat?' â€” '+strat.name:' â€” All Trades'}</div>
                <div style="display:flex;flex-direction:column;gap:10px;">
                ${scenarios.map(sc => {
                    const wins = sc.returns.filter(r=>r>0).length;
                    const wr = sc.returns.length > 0 ? (wins/sc.returns.length*100).toFixed(0) : 0;
                    const avg = sc.returns.length > 0 ? (sc.returns.reduce((a,b)=>a+b,0)/sc.returns.length).toFixed(2) : 0;
                    let eq = 100;
                    let maxDD = 0, peak = 100;
                    sc.returns.forEach(r => {
                        eq *= (1+r/100);
                        if(eq>peak)peak=eq;
                        const dd=(eq-peak)/peak*100;
                        if(dd<maxDD)maxDD=dd;
                    });
                    const totalReturn = (eq - 100).toFixed(1);
                    return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-left:3px solid ${sc.color};border-radius:0 10px 10px 0;padding:12px 14px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                            <div>
                                <div style="font-size:12px;font-weight:700;color:#f0f0fa;">${sc.name}</div>
                                <div style="font-size:10px;color:#8888a8;margin-top:2px;">${sc.desc}</div>
                            </div>
                            <div style="text-align:right;font-family:var(--v-mono);">
                                <div style="font-size:1.1rem;font-weight:700;color:${parseFloat(totalReturn)>=0?'#4ade80':'#f87171'};">${parseFloat(totalReturn)>=0?'+':''}${totalReturn}%</div>
                                <div style="font-size:9px;color:#6868a0;">total return</div>
                            </div>
                        </div>
                        <div style="display:flex;gap:14px;font-size:11px;">
                            <span style="color:#8888a8;">Win Rate: <strong style="color:${parseInt(wr)>=50?'#4ade80':'#f87171'};">${wr}%</strong></span>
                            <span style="color:#8888a8;">Avg Trade: <strong style="color:${parseFloat(avg)>=0?'#4ade80':'#f87171'};">${avg}%</strong></span>
                            <span style="color:#8888a8;">Max DD: <strong style="color:${maxDD<-15?'#f87171':maxDD<-8?'#f59e0b':'#4ade80'};">${maxDD.toFixed(1)}%</strong></span>
                        </div>
                    </div>`;
                }).join('')}
                </div>`;
        }, 900);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SILENT FOCUS MODE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _focusModeActive = false;
    let _focusModeStart  = 0;
    let _focusTimer      = null;

    function toggleSilentFocus() {
        _focusModeActive = !_focusModeActive;
        document.body.classList.toggle('focus-mode', _focusModeActive);
        const bar = document.getElementById('focusModeBar');
        const btn = document.getElementById('silentFocusBtn');
        if (_focusModeActive) {
            _focusModeStart = Date.now();
            if (bar) bar.style.display = 'flex';
            if (btn) { btn.style.background='rgba(129,140,248,0.15)'; btn.style.color='#818cf8'; btn.style.borderColor='rgba(129,140,248,0.3)'; }
            _focusTimer = setInterval(() => {
                const elapsed = Math.floor((Date.now()-_focusModeStart)/1000);
                const m = Math.floor(elapsed/60), s = elapsed%60;
                const el = document.getElementById('focusModeTimer');
                if (el) el.textContent = `${m}:${s.toString().padStart(2,'0')} elapsed`;
            }, 1000);
            pushNotif('info','ğŸ”• Silent Focus Mode active â€” P&L is hidden. Stay disciplined.');
        } else {
            if (bar) bar.style.display = 'none';
            if (btn) { btn.style.background='rgba(255,255,255,0.04)'; btn.style.color='#a0a0b8'; btn.style.borderColor='rgba(255,255,255,0.08)'; }
            clearInterval(_focusTimer);
        }
    }

    function toggleFocusMode() { toggleSilentFocus(); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  THEME SYSTEM â€” Extended with 6 themes
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const THEMES = {
        dark:     { bg:'#0a0a0f', surface:'#111118', card:'#1a1a24', border:'rgba(255,255,255,0.12)', gold:'#d4a84b' },
        midnight: { bg:'#080810', surface:'#0e0e1a', card:'#161626', border:'rgba(120,120,200,0.15)',  gold:'#c9a84b' },
        graphite: { bg:'#0d0d0d', surface:'#131313', card:'#1c1c1c', border:'rgba(255,255,255,0.1)',   gold:'#d4a84b' },
        arctic:   { bg:'#090f18', surface:'#0e1620', card:'#141e2c', border:'rgba(96,165,250,0.15)',   gold:'#60a5fa' },
        emerald:  { bg:'#080f0c', surface:'#0e1812', card:'#141f18', border:'rgba(52,211,153,0.15)',   gold:'#34d399' },
        white:    { bg:'#f8f8fc', surface:'#ffffff',  card:'#f0f0f8', border:'rgba(0,0,0,0.1)',         gold:'#b8860b',
                    text:'#1a1a2e', muted:'#5050a0' }
    };

    // Patch applyTheme to include new themes
    const _origApplyTheme = window.applyTheme;
    window.applyTheme = function(theme) {
        const t = THEMES[theme];
        if (!t) { if(_origApplyTheme) _origApplyTheme(theme); return; }
        const root = document.documentElement;
        root.style.setProperty('--v-bg',      t.bg);
        root.style.setProperty('--v-surface', t.surface);
        root.style.setProperty('--v-card',    t.card);
        root.style.setProperty('--v-border',  t.border);
        root.style.setProperty('--v-gold',    t.gold);
        if (t.text)  root.style.setProperty('--v-text',  t.text);
        if (t.muted) root.style.setProperty('--v-muted', t.muted);
        document.querySelectorAll('.theme-opt').forEach(b => {
            b.style.background = b.dataset.theme === theme ? 'rgba(212,168,75,0.12)' : 'transparent';
            b.style.color      = b.dataset.theme === theme ? 'var(--v-gold)' : '#a0a0b8';
        });
        localStorage.setItem('vestra_theme', theme);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AI COACH â€” Extended with sizing chart and hold time analysis
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderAICoachExtended() {
        renderAICoach(); // existing scores/bias/regime

        // Position sizing trend chart
        const sizingEl = document.getElementById('coachSizingChart');
        if (sizingEl) {
            const buys = (transactions||[]).filter(t=>t.type==='BUY').slice(-20);
            const portVal = (cash||100000) + getPortfolioValue();
            if (buys.length > 0) {
                const maxSz = Math.max(...buys.map(t=>(t.price*(t.qty||1))/portVal));
                sizingEl.innerHTML = buys.map(t => {
                    const sz = (t.price*(t.qty||1))/portVal;
                    const pct = Math.max(8, (sz/Math.max(maxSz,0.01))*100);
                    const col = sz > 0.2 ? '#f87171' : sz > 0.1 ? '#f59e0b' : '#4ade80';
                    return `<div style="flex:1;background:${col}33;border:1px solid ${col}44;border-radius:3px 3px 0 0;min-width:6px;height:${pct}%;align-self:flex-end;position:relative;" title="${t.symbol}: ${(sz*100).toFixed(1)}% of portfolio">
                        <div style="position:absolute;top:0;left:0;right:0;height:${pct}%;background:${col};opacity:0.7;border-radius:inherit;"></div>
                    </div>`;
                }).join('');
            } else {
                sizingEl.innerHTML = '<div style="font-size:11px;color:#6868a0;width:100%;text-align:center;align-self:center;">No trades yet</div>';
            }
        }

        // Hold time analysis: wins vs losses
        const holdEl = document.getElementById('coachHoldTime');
        if (holdEl) {
            const sells = (transactions||[]).filter(t=>t.type==='SELL');
            const buys  = (transactions||[]).filter(t=>t.type==='BUY');
            const wins  = sells.filter(t=>(t.price-(t.avgBuy||t.price))>0);
            const losses= sells.filter(t=>(t.price-(t.avgBuy||t.price))<=0);

            function avgHoldHrs(trades) {
                if (!trades.length) return 0;
                const holds = trades.map(t => {
                    const b = buys.filter(b=>b.symbol===t.symbol&&b.ts<t.ts);
                    return b.length ? (t.ts - b[b.length-1].ts)/3600000 : 0;
                });
                return holds.reduce((a,b)=>a+b,0)/holds.length;
            }

            const winHold  = avgHoldHrs(wins);
            const lossHold = avgHoldHrs(losses);
            const bias = winHold > 0 && lossHold > 0 ? (lossHold > winHold*1.5 ? 'âš ï¸ Holding losers significantly longer than winners â€” classic loss aversion.' : lossHold < winHold*0.6 ? 'âœ‚ï¸ Exiting losers faster than winners. Positive asymmetry.' : 'âœ“ Hold time distribution appears balanced.') : 'â€”';

            const fmt = h => h < 1 ? Math.round(h*60)+'m' : h < 24 ? h.toFixed(1)+'h' : (h/24).toFixed(1)+'d';

            holdEl.innerHTML = `
                <div style="background:rgba(74,222,128,0.06);border:1px solid rgba(74,222,128,0.15);border-radius:10px;padding:14px;text-align:center;">
                    <div style="font-size:10px;color:#4ade80;font-weight:700;margin-bottom:6px;">ğŸ† Avg Hold â€” Winners</div>
                    <div style="font-family:var(--v-mono);font-size:1.4rem;font-weight:700;color:#4ade80;">${wins.length?fmt(winHold):'â€”'}</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:3px;">${wins.length} winning trades</div>
                </div>
                <div style="background:rgba(248,113,113,0.06);border:1px solid rgba(248,113,113,0.15);border-radius:10px;padding:14px;text-align:center;">
                    <div style="font-size:10px;color:#f87171;font-weight:700;margin-bottom:6px;">ğŸ“‰ Avg Hold â€” Losers</div>
                    <div style="font-family:var(--v-mono);font-size:1.4rem;font-weight:700;color:#f87171;">${losses.length?fmt(lossHold):'â€”'}</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:3px;">${losses.length} losing trades</div>
                </div>
                ${bias !== 'â€”' ? `<div style="grid-column:span 2;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;font-size:11px;color:#c0c0d8;">${bias}</div>` : ''}
            `;
        }
    }

    // Override openAICoach to use extended version
    const _origOpenAICoach = window.openAICoach || function(){};
    window.openAICoach = function() {
        const el = document.getElementById('aiCoachModal');
        if (el) { el.style.display = 'flex'; renderAICoachExtended(); }
    };
    window.closeAICoach = function() {
        const el = document.getElementById('aiCoachModal');
        if (el) el.style.display = 'none';
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  DECISION INTELLIGENCE TIMELINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openDecisionTimeline() {
        const el = document.getElementById('decisionTimelineModal');
        if (el) { el.style.display = 'flex'; renderDecisionTimeline(); }
    }
    function closeDecisionTimeline() {
        const el = document.getElementById('decisionTimelineModal');
        if (el) el.style.display = 'none';
    }

    function renderDecisionTimeline() {
        const sells  = (transactions||[]).filter(t=>t.type==='SELL').slice(-50);
        const phist  = perfHistory || [];

        // Equity curve canvas
        const canvas = document.getElementById('dtCanvas');
        if (canvas && phist.length > 1) {
            const ctx = canvas.getContext('2d');
            const W = canvas.parentElement.clientWidth || 720;
            const H = 160;
            canvas.width = W; canvas.height = H;
            ctx.clearRect(0,0,W,H);

            const vals = phist.map(p=>p.val||p.value||100000);
            const minV = Math.min(...vals), maxV = Math.max(...vals);
            const range = maxV - minV || 1;
            const pad = 20;

            // Draw baseline
            const baseY = H - pad - ((100000-minV)/range)*(H-2*pad);
            ctx.strokeStyle = 'rgba(255,255,255,0.08)';
            ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(pad,baseY); ctx.lineTo(W-pad,baseY); ctx.stroke();
            ctx.setLineDash([]);

            // Equity line
            ctx.beginPath();
            vals.forEach((v,i) => {
                const x = pad + (i/(vals.length-1))*(W-2*pad);
                const y = H - pad - ((v-minV)/range)*(H-2*pad);
                i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.strokeStyle = '#818cf8';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Trade dots
            sells.forEach(t => {
                if (!t.ts) return;
                const pIdx = phist.findIndex(p => p.ts >= t.ts);
                if (pIdx < 0) return;
                const x = pad + (pIdx/(vals.length-1))*(W-2*pad);
                const v = vals[pIdx];
                const y = H - pad - ((v-minV)/range)*(H-2*pad);
                const gain = t.price - (t.avgBuy||t.price);
                ctx.beginPath();
                ctx.arc(x, y, 5, 0, Math.PI*2);
                ctx.fillStyle = gain > 0 ? '#4ade80' : gain < 0 ? '#f87171' : '#f59e0b';
                ctx.fill();
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = 1;
                ctx.stroke();
            });
        }

        // Regime bar
        const regBar = document.getElementById('dtRegimeBar');
        if (regBar && sells.length > 0) {
            regBar.innerHTML = sells.map(t => {
                const gain = t.price-(t.avgBuy||t.price);
                // Estimate regime from surrounding performance
                const col = gain > 0 ? '#4ade8033' : '#f8717133';
                return `<div style="flex:1;background:${col};min-width:4px;" title="${t.symbol} ${gain>0?'+':''}${((gain/(t.avgBuy||t.price))*100).toFixed(1)}%"></div>`;
            }).join('');
        } else if (regBar) {
            regBar.innerHTML = '<div style="font-size:11px;color:#6868a0;padding:6px;">No trades yet</div>';
        }

        // Trade log
        const logEl = document.getElementById('dtTradeLog');
        if (logEl) {
            if (!sells.length) {
                logEl.innerHTML = '<div style="text-align:center;color:#6868a0;font-size:11px;padding:20px;">No closed trades yet.</div>';
            } else {
                logEl.innerHTML = [...sells].reverse().map(t => {
                    const gain  = t.price-(t.avgBuy||t.price);
                    const pct   = t.avgBuy ? (gain/t.avgBuy*100).toFixed(2) : '0.00';
                    const isPos = gain >= 0;
                    const d     = t.ts ? new Date(t.ts).toLocaleDateString('en-US',{month:'short',day:'numeric'}) : 'â€”';
                    const note  = t.journalNote || t.note || '';
                    const strat = t.strategyTag || t.tag || '';
                    return `<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-left:3px solid ${isPos?'#4ade80':'#f87171'};border-radius:0 8px 8px 0;padding:8px 12px;">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <span style="font-weight:700;font-size:12px;color:#f0f0fa;">${t.symbol}</span>
                                ${strat?`<span style="font-size:9px;margin-left:6px;padding:1px 5px;border-radius:3px;background:rgba(167,139,250,0.15);color:#a78bfa;">${strat}</span>`:''}
                                ${note?`<div style="font-size:10px;color:#8888a8;margin-top:2px;">"${note}"</div>`:''}
                            </div>
                            <div style="text-align:right;">
                                <div style="font-family:var(--v-mono);font-size:12px;font-weight:700;color:${isPos?'#4ade80':'#f87171'};">${isPos?'+':''}${pct}%</div>
                                <div style="font-size:9px;color:#6868a0;">${d}</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // Entry clustering heatmap by hour
        const hmEl = document.getElementById('dtHeatmap');
        if (hmEl) {
            const buys = (transactions||[]).filter(t=>t.type==='BUY');
            const hours = new Array(14).fill(0); // 9:30â†’16:00 = slots
            buys.forEach(t => {
                if (!t.ts) return;
                const h = new Date(t.ts).getHours();
                const idx = Math.min(13, Math.max(0, h - 9));
                hours[idx]++;
            });
            const maxH = Math.max(...hours, 1);
            hmEl.innerHTML = hours.map((count,i) => {
                const pct = Math.max(10, (count/maxH)*100);
                const label = `${9+i}:${i===0?'30':'00'}`;
                return `<div style="flex:1;display:flex;flex-direction:column;align-items:center;gap:2px;" title="${label}: ${count} trades">
                    <div style="width:100%;background:rgba(96,165,250,${0.1+count/maxH*0.7});border-radius:3px;height:${pct}%;min-height:4px;"></div>
                </div>`;
            }).join('');
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  CAPITAL ALLOCATION SIMULATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _caAllocations = {};

    function openCapitalAllocator() {
        const el = document.getElementById('capitalAllocatorModal');
        if (el) { el.style.display = 'flex'; renderCapitalAllocator(); }
    }
    function closeCapitalAllocator() {
        const el = document.getElementById('capitalAllocatorModal');
        if (el) el.style.display = 'none';
    }

    function useCurrentPortfolio() {
        const el = document.getElementById('caCapital');
        if (el) {
            const pv = (cash||0) + getPortfolioValue();
            el.value = Math.round(pv);
            updateCapitalAllocator();
        }
    }

    function renderCapitalAllocator() {
        const slidersEl = document.getElementById('caStrategySliders');
        if (!slidersEl) return;

        // Initialize allocations evenly
        const totalStrats = strategies.length;
        if (totalStrats === 0) {
            slidersEl.innerHTML = '<div style="font-size:11px;color:#6868a0;font-style:italic;">No strategies created yet. Create strategies in the Strategy Lab first.</div>';
            return;
        }

        strategies.forEach(s => {
            if (!(_caAllocations[s.id] >= 0)) _caAllocations[s.id] = Math.floor(100/totalStrats);
        });

        slidersEl.innerHTML = strategies.map(s => {
            const pct = _caAllocations[s.id] || 0;
            return `<div style="display:grid;grid-template-columns:140px 1fr 60px;gap:10px;align-items:center;">
                <div style="font-size:11px;font-weight:600;color:#f0f0fa;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${s.name}">${s.name}</div>
                <input type="range" min="0" max="100" value="${pct}" data-strat="${s.id}"
                    oninput="_caAllocations['${s.id}']=parseInt(this.value);updateCapitalAllocator()"
                    style="width:100%;accent-color:#818cf8;cursor:pointer;">
                <div style="font-family:var(--v-mono);font-size:12px;font-weight:700;color:#818cf8;text-align:right;" id="caPct_${s.id}">${pct}%</div>
            </div>`;
        }).join('');

        updateCapitalAllocator();
    }

    function updateCapitalAllocator() {
        const capital = parseFloat(document.getElementById('caCapital')?.value) || 100000;
        const total = Object.values(_caAllocations).reduce((a,b)=>a+b,0);

        // Update % labels
        strategies.forEach(s => {
            const el = document.getElementById(`caPct_${s.id}`);
            if (el) el.textContent = (_caAllocations[s.id]||0) + '%';
        });

        // Cash remainder
        const cashPct = Math.max(0, 100 - total);
        const cashAmt = capital * cashPct / 100;
        const remEl = document.getElementById('caCashRemVal');
        if (remEl) remEl.textContent = '$' + cashAmt.toLocaleString(undefined,{maximumFractionDigits:0});

        // Bar chart
        const barEl = document.getElementById('caBarChart');
        if (barEl) {
            const colors = ['#818cf8','#34d399','#f472b6','#f59e0b','#60a5fa','#a78bfa','#fb923c','#4ade80'];
            const items = strategies.map((s,i) => ({
                name:s.name, pct:_caAllocations[s.id]||0, color:colors[i%colors.length],
                amt: capital * (_caAllocations[s.id]||0) / 100
            }));
            items.push({ name:'Cash', pct:cashPct, color:'#6868a0', amt:cashAmt });

            barEl.innerHTML = items.filter(it=>it.pct>0).map(it => `<div>
                <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:3px;">
                    <span style="color:${it.color};font-weight:600;">${it.name}</span>
                    <span style="color:#f0f0fa;font-family:var(--v-mono);">${it.pct}% â€” $${it.amt.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
                </div>
                <div style="height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
                    <div class="alloc-bar" style="width:${it.pct}%;background:${it.color};"></div>
                </div>
            </div>`).join('');
        }

        // Projection
        const projEl = document.getElementById('caProjection');
        if (projEl) {
            // Bear, Base, Bull scenarios
            const scenarios = [
                { name:'Bear', color:'#f87171', mult:0.6 },
                { name:'Base', color:'#f59e0b', mult:1.0 },
                { name:'Bull', color:'#4ade80', mult:1.4 },
            ];
            const allTradeReturns = (transactions||[]).filter(t=>t.type==='SELL').map(t=>(t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100);
            const avgR = allTradeReturns.length > 0 ? allTradeReturns.reduce((a,b)=>a+b,0)/allTradeReturns.length : 1.5;
            const tradesPerMonth = Math.max(4, allTradeReturns.length / 3);

            projEl.innerHTML = scenarios.map(sc => {
                const adjR = avgR * sc.mult;
                let eq = capital;
                for (let i = 0; i < tradesPerMonth * 3; i++) {
                    eq *= (1 + (adjR/100 + (Math.random()-0.5)*0.02));
                }
                const ret = ((eq-capital)/capital*100).toFixed(1);
                return `<div style="background:rgba(255,255,255,0.03);border:1px solid ${sc.color}22;border-radius:10px;padding:12px;text-align:center;">
                    <div style="font-size:10px;font-weight:700;color:${sc.color};margin-bottom:6px;">${sc.name} Case</div>
                    <div style="font-family:var(--v-mono);font-size:1.1rem;font-weight:700;color:${parseFloat(ret)>=0?sc.color:'#f87171'};">${parseFloat(ret)>=0?'+':''}${ret}%</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">$${Math.round(eq).toLocaleString()}</div>
                </div>`;
            }).join('');
        }
    }

    function runRebalancingSim() {
        const capital = parseFloat(document.getElementById('caCapital')?.value) || 100000;
        const freq = document.getElementById('caRebalFreq')?.value || 'none';
        const resEl = document.getElementById('caRebalResult');
        if (!resEl) return;

        const allReturns = (transactions||[]).filter(t=>t.type==='SELL').map(t=>(t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100);
        const avgR = allReturns.length > 0 ? allReturns.reduce((a,b)=>a+b,0)/allReturns.length : 1.5;
        const tradesPerMonth = Math.max(4, allReturns.length / 3);

        // Simulate 12 months
        let eqRebal = capital, eqNoRebal = capital;
        const MONTHS = 12;
        const rebalPeriod = freq === 'monthly' ? 1 : freq === 'quarterly' ? 3 : 999;

        for (let m = 0; m < MONTHS; m++) {
            for (let t = 0; t < tradesPerMonth; t++) {
                const r = (avgR + (Math.random()-0.5)*4)/100;
                eqRebal   *= (1 + r);
                eqNoRebal *= (1 + r);
            }
            if ((m+1) % rebalPeriod === 0 && freq !== 'none') {
                // Rebalancing adds ~0.2% friction but improves diversification
                eqRebal *= 0.998;
            }
        }

        const rebalRet   = ((eqRebal-capital)/capital*100).toFixed(1);
        const noRebalRet = ((eqNoRebal-capital)/capital*100).toFixed(1);

        resEl.innerHTML = freq === 'none'
            ? `<span style="color:#8888a8;">Select a rebalancing frequency to see impact simulation.</span>`
            : `<div style="display:flex;gap:14px;flex-wrap:wrap;margin-top:6px;">
                <span style="font-size:11px;color:#8888a8;">With ${freq} rebalancing: <strong style="color:#4ade80;">${rebalRet}%</strong> (12 months)</span>
                <span style="font-size:11px;color:#8888a8;">Without: <strong style="color:#f59e0b;">${noRebalRet}%</strong></span>
                <span style="font-size:10px;color:#6868a0;">Note: Rebalancing adds small friction but enforces position size discipline.</span>
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ADVANCED ANALYTICS MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let _aaMode = 'equity'; // 'equity' or 'drawdown'

    function openAdvancedAnalytics() {
        const el = document.getElementById('advancedAnalyticsModal');
        if (el) { el.style.display = 'flex'; renderAdvancedAnalytics(); }
    }
    function closeAdvancedAnalytics() {
        const el = document.getElementById('advancedAnalyticsModal');
        if (el) el.style.display = 'none';
    }

    function aaToggleCurve(mode) {
        _aaMode = mode;
        document.getElementById('aaBtnEquity').style.background   = mode==='equity'   ? 'rgba(244,114,182,0.15)' : 'transparent';
        document.getElementById('aaBtnEquity').style.color        = mode==='equity'   ? '#f472b6' : '#6868a0';
        document.getElementById('aaBtnDD').style.background       = mode==='drawdown' ? 'rgba(244,114,182,0.15)' : 'transparent';
        document.getElementById('aaBtnDD').style.color            = mode==='drawdown' ? '#f472b6' : '#6868a0';
        drawAACanvas();
    }

    function drawAACanvas() {
        const canvas = document.getElementById('aaEquityCanvas');
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const W = canvas.parentElement.clientWidth - 16 || 720;
        const H = 144;
        canvas.width = W; canvas.height = H;
        ctx.clearRect(0,0,W,H);

        const phist = perfHistory || [];
        if (phist.length < 2) {
            ctx.fillStyle = '#6868a0';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('No performance history yet â€” make some trades!', W/2, H/2);
            return;
        }

        const vals = phist.map(p=>p.val||p.value||100000);
        const base = vals[0] || 100000;

        if (_aaMode === 'equity') {
            const minV = Math.min(...vals), maxV = Math.max(...vals);
            const range = maxV - minV || 1;
            const pad = 16;

            // Fill area
            ctx.beginPath();
            vals.forEach((v,i) => {
                const x = pad + (i/(vals.length-1))*(W-2*pad);
                const y = H - pad - ((v-minV)/range)*(H-2*pad);
                i===0 ? ctx.moveTo(x,H-pad) : undefined;
                i===0 ? ctx.lineTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.lineTo(pad + (W-2*pad), H-pad);
            ctx.closePath();
            const grad = ctx.createLinearGradient(0,0,0,H);
            grad.addColorStop(0, 'rgba(244,114,182,0.2)');
            grad.addColorStop(1, 'rgba(244,114,182,0.02)');
            ctx.fillStyle = grad;
            ctx.fill();

            // Line
            ctx.beginPath();
            vals.forEach((v,i) => {
                const x = pad + (i/(vals.length-1))*(W-2*pad);
                const y = H - pad - ((v-minV)/range)*(H-2*pad);
                i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.strokeStyle = '#f472b6';
            ctx.lineWidth = 2;
            ctx.stroke();

        } else {
            // Drawdown chart
            let peak = base;
            const dds = vals.map(v => { if(v>peak)peak=v; return (v-peak)/peak*100; });
            const minDD = Math.min(...dds, -0.1);
            const pad = 16;

            ctx.beginPath();
            dds.forEach((d,i) => {
                const x = pad + (i/(dds.length-1))*(W-2*pad);
                const y = pad + (1 - d/minDD) * (H - 2*pad);
                i===0 ? ctx.moveTo(x,pad) : undefined;
                i===0 ? ctx.lineTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.lineTo(pad+(W-2*pad), pad);
            ctx.closePath();
            const gradDD = ctx.createLinearGradient(0,0,0,H);
            gradDD.addColorStop(0, 'rgba(248,113,113,0.05)');
            gradDD.addColorStop(1, 'rgba(248,113,113,0.3)');
            ctx.fillStyle = gradDD;
            ctx.fill();

            ctx.beginPath();
            dds.forEach((d,i) => {
                const x = pad + (i/(dds.length-1))*(W-2*pad);
                const y = pad + (1 - d/minDD) * (H - 2*pad);
                i===0 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
            });
            ctx.strokeStyle = '#f87171';
            ctx.lineWidth = 2;
            ctx.stroke();
        }
    }

    function renderAdvancedAnalytics() {
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        const phist = perfHistory || [];
        const portVal = (cash||0) + getPortfolioValue();
        const startVal = phist.length > 0 ? (phist[0].val||100000) : 100000;

        // Draw canvas
        requestAnimationFrame(drawAACanvas);

        // Risk-adjusted metrics
        const metricsEl = document.getElementById('aaRiskMetrics');
        if (metricsEl) {
            const returns = sells.map(t=>(t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100);
            const winRet  = returns.filter(r=>r>0);
            const lossRet = returns.filter(r=>r<0);

            const avgR    = returns.length > 0 ? returns.reduce((a,b)=>a+b,0)/returns.length : 0;
            const stdDev  = returns.length > 1 ? Math.sqrt(returns.reduce((a,b)=>a+Math.pow(b-avgR,2),0)/returns.length) : 0;
            const sharpe  = stdDev > 0 ? (avgR / stdDev * Math.sqrt(252)).toFixed(2) : 'â€”';

            const avgWin  = winRet.length > 0  ? winRet.reduce((a,b)=>a+b,0)/winRet.length   : 0;
            const avgLoss = lossRet.length > 0 ? lossRet.reduce((a,b)=>a+b,0)/lossRet.length : 0;
            const pf      = avgLoss !== 0 ? Math.abs(avgWin/avgLoss).toFixed(2) : 'â€”';

            let maxDD = 0, peak = startVal;
            phist.forEach(p => {
                const v = p.val||p.value||startVal;
                if(v>peak)peak=v;
                const dd=(v-peak)/peak*100;
                if(dd<maxDD)maxDD=dd;
            });

            const calmar = maxDD !== 0 ? (((portVal-startVal)/startVal*100) / Math.abs(maxDD)).toFixed(2) : 'â€”';

            const items = [
                { l:'Sharpe Ratio',   v:sharpe,  c:parseFloat(sharpe)>=1?'#4ade80':parseFloat(sharpe)>=0?'#f59e0b':'#f87171' },
                { l:'Profit Factor',  v:pf,      c:parseFloat(pf)>=1.5?'#4ade80':parseFloat(pf)>=1?'#f59e0b':'#f87171' },
                { l:'Max Drawdown',   v:maxDD.toFixed(1)+'%', c:maxDD>-10?'#4ade80':maxDD>-20?'#f59e0b':'#f87171' },
                { l:'Calmar Ratio',   v:calmar,  c:parseFloat(calmar)>=0.5?'#4ade80':parseFloat(calmar)>=0?'#f59e0b':'#f87171' },
            ];
            metricsEl.innerHTML = items.map(m=>`<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;text-align:center;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:5px;">${m.l}</div>
                <div style="font-family:var(--v-mono);font-size:1.1rem;font-weight:700;color:${m.c};">${m.v}</div>
            </div>`).join('');
        }

        // Monthly heatmap
        renderAAMonthlyHeatmap();

        // Sector exposure
        renderAASectorExposure();

        // Best/worst trades
        const allSells = sells.slice();
        allSells.sort((a,b) => {
            const ra = (a.price-(a.avgBuy||a.price))/(a.avgBuy||a.price);
            const rb = (b.price-(b.avgBuy||b.price))/(b.avgBuy||b.price);
            return rb - ra;
        });

        function tradeRow(t) {
            const gain = t.price-(t.avgBuy||t.price);
            const pct  = t.avgBuy ? (gain/t.avgBuy*100).toFixed(2) : '0.00';
            return `<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05);border-radius:7px;padding:7px 10px;display:flex;justify-content:space-between;font-size:11px;">
                <span style="font-weight:600;color:#f0f0fa;">${t.symbol}</span>
                <span style="font-family:var(--v-mono);color:${parseFloat(pct)>=0?'#4ade80':'#f87171'};">${parseFloat(pct)>=0?'+':''}${pct}%</span>
            </div>`;
        }

        const bestEl  = document.getElementById('aaBestTrades');
        const worstEl = document.getElementById('aaWorstTrades');
        if (bestEl)  bestEl.innerHTML  = allSells.slice(0,5).map(tradeRow).join('') || '<div style="color:#6868a0;font-size:11px;">No trades yet</div>';
        if (worstEl) worstEl.innerHTML = allSells.slice(-5).reverse().map(tradeRow).join('') || '<div style="color:#6868a0;font-size:11px;">No trades yet</div>';

        // Benchmark compare
        const benchEl = document.getElementById('aaBenchmarkCompare');
        if (benchEl) {
            const myReturn = ((portVal-startVal)/startVal*100).toFixed(1);
            // SPY baseline assumption: ~8% annual, ~2% per trading month
            const tradingDays = phist.length || 1;
            const spyReturn   = (tradingDays / 252 * 8).toFixed(1);
            const alpha       = (parseFloat(myReturn) - parseFloat(spyReturn)).toFixed(1);
            benchEl.innerHTML = `<div style="font-size:12px;color:#8888a8;">Your return: <strong style="color:${parseFloat(myReturn)>=0?'#4ade80':'#f87171'};">${parseFloat(myReturn)>=0?'+':''}${myReturn}%</strong></div>
                <div style="font-size:12px;color:#8888a8;margin-top:3px;">SPY (est.): <strong style="color:#60a5fa;">+${spyReturn}%</strong></div>
                <div style="font-size:11px;margin-top:5px;">Alpha: <strong style="color:${parseFloat(alpha)>=0?'#4ade80':'#f87171'};">${parseFloat(alpha)>=0?'+':''}${alpha}%</strong></div>`;
        }
    }

    function renderAAMonthlyHeatmap() {
        const el = document.getElementById('aaMonthlyHeatmap');
        if (!el) return;
        const sells = (transactions||[]).filter(t=>t.type==='SELL');
        const monthly = {};
        sells.forEach(t => {
            const d = new Date(t.ts||Date.now());
            const key = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
            const r = (t.price-(t.avgBuy||t.price))/(t.avgBuy||t.price)*100;
            monthly[key] = (monthly[key]||0) + r;
        });

        const keys = Object.keys(monthly).sort();
        if (!keys.length) {
            el.innerHTML = '<div style="color:#6868a0;font-size:11px;font-style:italic;">No closed trades to build heatmap.</div>';
            return;
        }

        const maxAbs = Math.max(...Object.values(monthly).map(Math.abs), 0.1);
        el.innerHTML = `<div style="display:flex;flex-wrap:wrap;gap:6px;">
            ${keys.map(k => {
                const v = monthly[k];
                const intensity = Math.abs(v) / maxAbs;
                const bg = v >= 0 ? `rgba(74,222,128,${0.1+intensity*0.6})` : `rgba(248,113,113,${0.1+intensity*0.6})`;
                const bc = v >= 0 ? `rgba(74,222,128,${0.2+intensity*0.4})` : `rgba(248,113,113,${0.2+intensity*0.4})`;
                return `<div style="background:${bg};border:1px solid ${bc};border-radius:8px;padding:10px 14px;min-width:80px;text-align:center;" title="${k}: ${v.toFixed(1)}%">
                    <div style="font-size:9px;color:#8888a8;margin-bottom:3px;">${k}</div>
                    <div style="font-family:var(--v-mono);font-size:12px;font-weight:700;color:${v>=0?'#4ade80':'#f87171'};">${v>=0?'+':''}${v.toFixed(1)}%</div>
                </div>`;
            }).join('')}
        </div>`;
    }

    function renderAASectorExposure() {
        const el = document.getElementById('aaSectorExposure');
        if (!el) return;
        const sectorMap = {};
        Object.keys(portfolio||{}).forEach(sym => {
            const qty = portfolio[sym]?.qty || 0;
            if (!qty) return;
            const d = realStockData[sym] || {};
            const sec = d.sector || 'Other';
            const val = (stocks.find(s=>s.symbol===sym)?.price||0) * qty;
            sectorMap[sec] = (sectorMap[sec]||0) + val;
        });

        const total = Object.values(sectorMap).reduce((a,b)=>a+b,0) || 1;
        const sorted = Object.entries(sectorMap).sort((a,b)=>b[1]-a[1]);

        if (!sorted.length) {
            el.innerHTML = '<div style="color:#6868a0;font-size:11px;font-style:italic;">No open positions.</div>';
            return;
        }

        const colors = ['#818cf8','#34d399','#f472b6','#f59e0b','#60a5fa','#a78bfa','#fb923c','#4ade80','#22d3ee','#f87171'];
        el.innerHTML = sorted.map(([sec, val], i) => {
            const pct = (val/total*100).toFixed(1);
            return `<div>
                <div style="display:flex;justify-content:space-between;font-size:11px;margin-bottom:3px;">
                    <span style="color:${colors[i%colors.length]};font-weight:600;">${sec}</span>
                    <span style="color:#f0f0fa;font-family:var(--v-mono);">${pct}% Â· $${val.toLocaleString(undefined,{maximumFractionDigits:0})}</span>
                </div>
                <div style="height:7px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;">
                    <div style="height:100%;width:${pct}%;background:${colors[i%colors.length]};border-radius:4px;transition:width 0.4s;"></div>
                </div>
            </div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ENHANCED PROGRESS DASHBOARD â€” Long-term Discipline Score
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origRenderProgress = window.renderProgress;
    window.renderProgress = function() {
        if (_origRenderProgress) _origRenderProgress();
        renderLongTermDisciplineScore();
    };

    function renderLongTermDisciplineScore() {
        // Check if the discipline score section exists, inject if not
        const progressModal = document.getElementById('progressModal');
        if (!progressModal) return;
        let ltEl = document.getElementById('ltDisciplineScore');
        if (!ltEl) {
            const inner = progressModal.querySelector('[style*="padding:20px 28px"]') || progressModal.querySelector('div[style*="gap:16px"]');
            if (inner) {
                const div = document.createElement('div');
                div.id = 'ltDisciplineScore';
                div.style.cssText = 'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;';
                inner.appendChild(div);
                ltEl = div;
            } else return;
        }

        const scores = computeDisciplineScores ? computeDisciplineScores() : { discipline:50,consistency:50,risk:50,emotional:50 };
        const overall = Math.round((scores.discipline + scores.consistency + scores.risk + scores.emotional) / 4);
        const grade = overall >= 85 ? 'A+' : overall >= 75 ? 'A' : overall >= 65 ? 'B' : overall >= 55 ? 'C' : 'D';
        const gradeColor = overall >= 75 ? '#4ade80' : overall >= 55 ? '#f59e0b' : '#f87171';

        ltEl.innerHTML = `<div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;">ğŸ… Long-Term Discipline Rating</div>
            <div style="display:flex;align-items:center;gap:20px;">
                <div style="text-align:center;flex-shrink:0;">
                    <div style="font-family:var(--v-serif);font-size:3rem;color:${gradeColor};line-height:1;">${grade}</div>
                    <div style="font-size:9px;color:#6868a0;margin-top:2px;">${overall}/100</div>
                </div>
                <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                    ${[
                        {l:'Risk Control', v:scores.risk, d:'Position sizing vs RiskGuard adherence'},
                        {l:'Drawdown Ctrl', v:Math.min(100,Math.round(Math.max(0,(20-Math.abs(computeMaxDD?.()??0))/20*100))), d:'Max drawdown vs 20% threshold'},
                        {l:'Consistency',  v:scores.consistency, d:'Hold time and sizing variance'},
                        {l:'Strategy Adherence', v:strategies.length?Math.min(100,Math.round((transactions||[]).filter(t=>t.strategyId).length/Math.max(1,(transactions||[]).filter(t=>t.type==='BUY').length)*100)):0, d:'% of trades tagged to a strategy'},
                    ].map(m=>`<div>
                        <div style="display:flex;justify-content:space-between;font-size:10px;margin-bottom:2px;"><span style="color:#8888a8;">${m.l}</span><span style="color:${m.v>=70?'#4ade80':m.v>=50?'#f59e0b':'#f87171'};font-weight:700;">${m.v}%</span></div>
                        <div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;"><div style="height:100%;width:${m.v}%;background:${m.v>=70?'#4ade80':m.v>=50?'#f59e0b':'#f87171'};border-radius:3px;transition:width 0.5s;"></div></div>
                    </div>`).join('')}
                </div>
            </div>`;
    }

    function computeMaxDD() {
        const phist = perfHistory || [];
        if (phist.length < 2) return 0;
        let maxDD = 0, peak = phist[0].val||100000;
        phist.forEach(p => {
            const v = p.val||p.value||100000;
            if(v>peak)peak=v;
            const dd=(v-peak)/peak*100;
            if(dd<maxDD)maxDD=dd;
        });
        return maxDD;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ENHANCED LEADERBOARD â€” regime badge + verified mode + risk-adjusted
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // Patch renderLeaderboard to add regime badge (non-breaking extension)
    const _origRenderLeaderboard = window.renderLeaderboard;
    if (_origRenderLeaderboard) {
        window.renderLeaderboard = function(...args) {
            _origRenderLeaderboard(...args);
            // Add regime badge to leaderboard header if it exists
            const lbHead = document.querySelector('#leaderboardModal h2');
            if (lbHead && !document.getElementById('lbRegimeBadge')) {
                const reg = classifyMarketRegime ? classifyMarketRegime() : { regime:'Unknown', color:'#8888a8', icon:'â“' };
                const badge = document.createElement('span');
                badge.id = 'lbRegimeBadge';
                badge.className = 'regime-badge';
                badge.style.marginLeft = '10px';
                badge.innerHTML = `${reg.icon} <span style="color:${reg.color};">${reg.regime}</span>`;
                lbHead.appendChild(badge);
            }
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MACRO MARKET OVERVIEW â€” Enhanced with Sentiment meter & Breadth
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origRenderMacro = window.renderMacro;
    window.renderMacro = function() {
        if (_origRenderMacro) _origRenderMacro();
        renderMacroExtras();
    };

    function renderMacroExtras() {
        // Inject market breadth + sentiment if macro modal is open
        const macroModal = document.getElementById('macroModal');
        if (!macroModal || macroModal.style.display === 'none') return;

        let extEl = document.getElementById('macroExtras');
        if (!extEl) {
            const inner = macroModal.querySelector('div[style*="padding:20px 28px"]');
            if (inner) {
                extEl = document.createElement('div');
                extEl.id = 'macroExtras';
                inner.appendChild(extEl);
            } else return;
        }

        const breadthUp  = stocks.slice(0,50).filter(s=>(s.change||0)>0).length;
        const breadthDn  = stocks.slice(0,50).filter(s=>(s.change||0)<0).length;
        const breadthPct = (breadthUp/50*100).toFixed(0);
        const sentScore  = Math.round(50 + (breadthUp-breadthDn)/50*50);
        const sentLabel  = sentScore >= 65 ? 'Bullish' : sentScore >= 50 ? 'Neutral' : sentScore >= 35 ? 'Cautious' : 'Bearish';
        const sentColor  = sentScore >= 65 ? '#4ade80' : sentScore >= 50 ? '#f0f0fa' : sentScore >= 35 ? '#f59e0b' : '#f87171';

        const reg = classifyMarketRegime ? classifyMarketRegime() : { regime:'Unknown', color:'#8888a8', icon:'â“', desc:'' };

        extEl.innerHTML = `
        <div style="margin-top:16px;display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
            <!-- Breadth -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px;text-align:center;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Market Breadth</div>
                <div style="font-family:var(--v-mono);font-size:1.4rem;font-weight:700;color:${parseInt(breadthPct)>=50?'#4ade80':'#f87171'};">${breadthPct}%</div>
                <div style="font-size:10px;color:#8888a8;">${breadthUp} up Â· ${breadthDn} down</div>
                <div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;margin-top:8px;overflow:hidden;">
                    <div style="height:100%;width:${breadthPct}%;background:${parseInt(breadthPct)>=50?'#4ade80':'#f87171'};border-radius:3px;"></div>
                </div>
            </div>
            <!-- Sentiment -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px;text-align:center;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Sentiment Meter</div>
                <div style="font-family:var(--v-mono);font-size:1.2rem;font-weight:700;color:${sentColor};">${sentLabel}</div>
                <div style="font-size:10px;color:#8888a8;">${sentScore}/100</div>
                <div style="height:5px;background:rgba(255,255,255,0.06);border-radius:3px;margin-top:8px;overflow:hidden;">
                    <div style="height:100%;width:${sentScore}%;background:${sentColor};border-radius:3px;"></div>
                </div>
            </div>
            <!-- Regime -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px;text-align:center;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Regime</div>
                <div style="font-size:1.5rem;">${reg.icon}</div>
                <div style="font-size:11px;font-weight:700;color:${reg.color};">${reg.regime}</div>
            </div>
        </div>`;
    }

    // Initialize challenge state on app load
    loadChallengeState();

    // Restore saved theme
    (function() {
        const saved = localStorage.getItem('vestra_theme');
        if (saved && saved !== 'dark') window.applyTheme(saved);
    })();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PHASE 2: HELP CENTER & FEATURE GUIDANCE SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openHelpCenter() {
        const el = document.getElementById('helpCenterModal');
        if (el) { el.style.display = 'flex'; }
    }
    function closeHelpCenter() {
        const el = document.getElementById('helpCenterModal');
        if (el) { el.style.display = 'none'; }
    }

    // Feature hint banner system
    const _featureHints = [
        { title: 'ğŸ§ª Strategy Lab', body: 'Tag every trade to a strategy. After 10+ trades, you\'ll see which strategies have genuine edge â€” and which don\'t.', action: 'Click "Strategy Lab" in the toolbar to create your first strategy.' },
        { title: 'ğŸ”• Silent Focus Mode', body: 'Hide your P&L while positions are open. Train yourself to make exit decisions based on rules â€” not dollar amounts.', action: 'Click "ğŸ”• Focus" in the toolbar to activate.' },
        { title: 'ğŸ—“ Decision Timeline', body: 'See all your trades plotted on your equity curve with market regime labels. Identify when your edge disappears.', action: 'Open "More â†’ Decision Timeline" in the toolbar.' },
        { title: 'ğŸ›¡ Risk Guard', body: 'Set your max risk per trade before you place another order. This single rule protects your capital more than anything else.', action: 'Open "Risk Guard" in the toolbar and set 2% max risk.' },
        { title: 'ğŸ§  AI Coach', body: 'After 5+ closed trades, your coach will detect behavioral patterns â€” overtrading, revenge trading, recency bias.', action: 'Click "ğŸ§  AI Coach" in the toolbar.' },
        { title: 'ğŸ“Š Portfolio Analytics', body: 'Returns alone are misleading. Check your Sharpe ratio â€” it shows risk-adjusted performance, not just profits.', action: 'Click "ğŸ“Š Analytics" in the toolbar.' },
    ];
    let _hintQueue = [..._featureHints];
    let _hintTimer = null;

    function showFeatureHint(idx) {
        const hint = _featureHints[idx % _featureHints.length];
        const banner = document.getElementById('featureHintBanner');
        if (!banner) return;
        document.getElementById('hintBannerTitle').textContent = hint.title;
        document.getElementById('hintBannerBody').textContent = hint.body;
        document.getElementById('hintBannerAction').textContent = hint.action;
        banner.classList.add('visible');
        if (_hintTimer) clearTimeout(_hintTimer);
        _hintTimer = setTimeout(closeFeatureHint, 8000);
    }

    function closeFeatureHint() {
        const banner = document.getElementById('featureHintBanner');
        if (banner) banner.classList.remove('visible');
    }

    // Show feature hints at intervals for new users
    function startFeatureHints() {
        if (!currentUser || currentUser.tutorialDone === false) return; // don't interrupt tutorial
        let idx = 0;
        const trades = (transactions || []).filter(t => t.type === 'SELL').length;
        // Only show hints when user has few trades (still learning)
        if (trades > 20) return;
        setTimeout(() => showFeatureHint(idx++), 15000);
        setInterval(() => { if (Math.random() > 0.4) showFeatureHint(idx++); }, 120000);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PHASE 1: DATA FRESHNESS INDICATOR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function updateDataFreshness() {
        const dot = document.getElementById('apiHealthDot');
        const badge = document.getElementById('dataSourceBadge');
        if (!RT.key) {
            if (dot) { dot.style.background = '#6b7280'; dot.title = 'No API key â€” simulated data'; }
            if (badge) { badge.textContent = 'SIM'; badge.style.color = '#6b7280'; }
            return;
        }
        const age = Date.now() - (RT._lastFetch || 0);
        const freshMs = 30000;
        const staleMs = 120000;
        if (age < freshMs) {
            if (dot) { dot.style.background = '#22c55e'; dot.title = 'Live data â€” fresh'; }
            if (badge) { badge.textContent = 'LIVE'; badge.style.color = '#4ade80'; }
        } else if (age < staleMs) {
            if (dot) { dot.style.background = '#f59e0b'; dot.title = 'Data updating...'; }
            if (badge) { badge.textContent = 'LIVE'; badge.style.color = '#f59e0b'; }
        } else {
            if (dot) { dot.style.background = '#ef4444'; dot.title = 'Data may be stale â€” check API key'; }
            if (badge) { badge.textContent = 'STALE'; badge.style.color = '#f87171'; }
        }
    }
    setInterval(updateDataFreshness, 10000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PHASE 5: RISK STABILITY SCORE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeRiskStabilityScore() {
        const sells = (transactions || []).filter(t => t.type === 'SELL');
        if (sells.length < 3) return null;
        // Look at position sizes relative to portfolio value
        const sizes = sells.map(t => {
            const portVal = t.portfolioSnap || 100000;
            return (t.price * t.qty) / portVal * 100; // position size as % of portfolio
        });
        const avg = sizes.reduce((a,b) => a+b, 0) / sizes.length;
        const variance = sizes.reduce((sum, s) => sum + Math.pow(s - avg, 2), 0) / sizes.length;
        const stdDev = Math.sqrt(variance);
        // Low std dev = high consistency = high score
        const score = Math.max(0, Math.min(100, 100 - stdDev * 5));
        return {
            score: Math.round(score),
            avg: avg.toFixed(1),
            stdDev: stdDev.toFixed(1),
            grade: score >= 80 ? 'A' : score >= 65 ? 'B' : score >= 50 ? 'C' : 'D'
        };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PHASE 4: MARKET REGIME LABEL FOR DASHBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function getRegimeLabelHTML() {
        try {
            const reg = classifyMarketRegime();
            if (!reg) return '';
            return `<span class="regime-badge" style="background:${reg.color}18;border-color:${reg.color}35;color:${reg.color};">${reg.icon} ${reg.regime}</span>`;
        } catch(e) { return ''; }
    }

    // (leaderboard override already patched above)

    document.addEventListener('DOMContentLoaded', () => {
        setTimeout(startFeatureHints, 3000);
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  SIMULATION MODES â€” Conservative / Standard / Institutional
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    let simulationMode = 'standard'; // 'conservative' | 'standard' | 'institutional'

    const SIMULATION_MODES = {
        conservative: {
            label: 'Conservative', icon: 'ğŸ›¡', color: '#4ade80',
            spreadBps: 5,         // 0.05% bid-ask spread
            slippage: 0.001,      // 0.1% slippage
            desc: 'Tighter spreads, realistic fills. Best for beginners learning risk management.',
            maxPositionPct: 0.15  // max 15% per position
        },
        standard: {
            label: 'Standard', icon: 'âš–ï¸', color: '#f59e0b',
            spreadBps: 15,        // 0.15% spread
            slippage: 0.002,      // 0.2% slippage
            desc: 'Balanced realism. Spread and slippage simulate typical retail trading.',
            maxPositionPct: 0.30
        },
        institutional: {
            label: 'Institutional', icon: 'ğŸ›', color: '#a78bfa',
            spreadBps: 30,        // 0.3% spread (wider â€” institutional-size simulation)
            slippage: 0.005,      // 0.5% slippage
            desc: 'Maximum realism. Large spreads and slippage model real institutional conditions.',
            maxPositionPct: 0.10  // tighter position limits
        }
    };

    function applySpread(price, side) {
        const cfg = SIMULATION_MODES[simulationMode] || SIMULATION_MODES.standard;
        const halfSpread = price * (cfg.spreadBps / 10000) / 2;
        const slip = price * cfg.slippage * (Math.random() * 0.5 + 0.75); // variable slippage
        return side === 'BUY' ? price + halfSpread + slip : price - halfSpread - slip;
    }

    function setSimulationMode(mode) {
        simulationMode = mode;
        if (currentUser) { currentUser.simulationMode = mode; saveUserData(false); }
        // Update UI badge
        const badge = document.getElementById('simModeBadge');
        const cfg = SIMULATION_MODES[mode];
        if (badge && cfg) {
            badge.textContent = `${cfg.icon} ${cfg.label} Mode`;
            badge.style.color = cfg.color;
        }
        showTradeToast('INFO', 0, `${cfg.icon} ${cfg.label} simulation mode active`, 0, false);
    }

    function openSimulationSettings() {
        const modal = document.getElementById('simModeModal');
        if (modal) modal.style.display = 'flex';
    }
    function closeSimulationSettings() {
        const modal = document.getElementById('simModeModal');
        if (modal) modal.style.display = 'none';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ATR (Average True Range) DISPLAY
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function computeATR(candles, period = 14) {
        if (!candles || candles.length < 2) return null;
        const trs = [];
        for (let i = 1; i < candles.length; i++) {
            const c = candles[i], prev = candles[i-1];
            const h = c.h || c.high || c.c || 0;
            const l = c.l || c.low  || c.c || 0;
            const pc = prev.c || prev.close || 0;
            trs.push(Math.max(h - l, Math.abs(h - pc), Math.abs(l - pc)));
        }
        const subset = trs.slice(-period);
        return subset.length > 0 ? +(subset.reduce((a,b)=>a+b,0)/subset.length).toFixed(2) : null;
    }

    function renderATRDisplay(candles, currentPrice) {
        const el = document.getElementById('atrDisplay');
        if (!el) return;
        const atr = computeATR(candles);
        if (!atr || !currentPrice) { el.style.display = 'none'; return; }
        const atrPct = (atr / currentPrice * 100).toFixed(2);
        const vol = atrPct > 3 ? 'High' : atrPct > 1.5 ? 'Medium' : 'Low';
        const col = atrPct > 3 ? '#f87171' : atrPct > 1.5 ? '#f59e0b' : '#4ade80';
        el.style.display = 'flex';
        el.innerHTML = `<span style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-right:6px;">ATR(14)</span>
            <span style="font-family:var(--v-mono);font-size:11px;font-weight:700;color:${col};">$${atr}</span>
            <span style="font-size:9px;color:${col};margin-left:4px;">${atrPct}% Â· ${vol} Vol</span>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  MARKET SESSION VISUALIZER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function renderMarketSessions() {
        const el = document.getElementById('marketSessionsViz');
        if (!el) return;
        const now = new Date();
        const utcH = now.getUTCHours() + now.getUTCMinutes() / 60;

        const sessions = [
            { name: 'Sydney',   open: 22, close: 7,  color: '#a78bfa', utcOpen: 22, utcClose: 31 },
            { name: 'Tokyo',    open: 0,  close: 9,  color: '#60a5fa', utcOpen: 0,  utcClose: 9  },
            { name: 'London',   open: 8,  close: 17, color: '#f59e0b', utcOpen: 8,  utcClose: 17 },
            { name: 'New York', open: 13, close: 22, color: '#4ade80', utcOpen: 13, utcClose: 22 },
        ];

        const isOpen = (s) => {
            if (s.utcOpen < s.utcClose) return utcH >= s.utcOpen && utcH < s.utcClose;
            return utcH >= s.utcOpen || utcH < s.utcClose - 24;
        };

        el.innerHTML = `<div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:8px;">Market Sessions (UTC)</div>
        <div style="display:flex;flex-direction:column;gap:5px;">
        ${sessions.map(s => {
            const open = isOpen(s);
            return `<div style="display:flex;align-items:center;gap:8px;">
                <div style="width:8px;height:8px;border-radius:50%;background:${open ? s.color : '#3a3a5a'};${open ? 'box-shadow:0 0 6px '+s.color : ''};flex-shrink:0;"></div>
                <span style="font-size:11px;font-weight:600;color:${open ? '#f0f0fa' : '#5050a0'};min-width:68px;">${s.name}</span>
                <span style="font-size:10px;color:${open ? s.color : '#4040a0'};">${open ? 'â— OPEN' : 'â—‹ Closed'}</span>
                <span style="font-size:9px;color:#3a3a5a;margin-left:auto;">${String(s.open).padStart(2,'0')}:00â€“${String(s.close).padStart(2,'0')}:00</span>
            </div>`;
        }).join('')}
        </div>`;
    }

    setInterval(renderMarketSessions, 60000);

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  JOURNAL UPGRADE â€” Emotion Tags + Structured Reflection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const EMOTION_TAGS = [
        { id: 'confident', label: 'ğŸ˜¤ Confident',  color: '#4ade80' },
        { id: 'anxious',   label: 'ğŸ˜° Anxious',    color: '#f59e0b' },
        { id: 'fomo',      label: 'ğŸ”¥ FOMO',       color: '#f87171' },
        { id: 'calm',      label: 'ğŸ§˜ Calm',       color: '#60a5fa' },
        { id: 'revenge',   label: 'ğŸ˜¤ Revenge',    color: '#ef4444' },
        { id: 'greedy',    label: 'ğŸ’° Greedy',     color: '#fbbf24' },
        { id: 'disciplined', label: 'ğŸ¯ Disciplined', color: '#34d399' },
        { id: 'unsure',    label: 'ğŸ¤” Unsure',     color: '#a78bfa' },
    ];

    let _selectedEmotionTag = null;
    let _selectedStrategy   = null;

    function openJournalV2(tx) {
        journalPendingTx = tx;
        _selectedEmotionTag = null;
        _selectedStrategy = null;

        const modal = document.getElementById('journalModal');
        const info  = document.getElementById('journalTradeInfo');
        const note  = document.getElementById('journalNote');

        info.textContent = `${tx.side} ${tx.qty}Ã— ${tx.symbol} @ $${tx.price.toFixed(2)}`;
        note.value = '';
        note.placeholder = tx.side === 'BUY'
            ? 'Thesis: Why this stock, why now? Price target? Stop level?'
            : 'Exit rationale: Taking profit or cutting loss? Did you follow your plan?';

        // Render emotion tags
        const emotEl = document.getElementById('journalEmotionTags');
        if (emotEl) {
            emotEl.innerHTML = EMOTION_TAGS.map(e =>
                `<button onclick="selectEmotionTag('${e.id}')" id="etag_${e.id}"
                    style="font-size:10px;padding:4px 9px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.04);color:#8888a8;cursor:pointer;transition:all 0.15s;"
                    onmouseover="this.style.borderColor='${e.color}';this.style.color='${e.color}'"
                    onmouseout="if(window._selectedEmotionTag!=='${e.id}'){this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='#8888a8';}"
                >${e.label}</button>`
            ).join('');
        }

        // Render strategy selector
        const stratEl = document.getElementById('journalStrategySelect');
        if (stratEl) {
            const stratList = (strategies || []);
            if (stratList.length > 0) {
                stratEl.innerHTML = `<option value="">â€” No strategy tag â€”</option>` +
                    stratList.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
                stratEl.style.display = 'block';
                stratEl.onchange = () => { _selectedStrategy = stratEl.value || null; };
            } else {
                stratEl.style.display = 'none';
            }
        }

        // Render post-trade checklist for SELLs
        const checklistEl = document.getElementById('journalChecklist');
        if (checklistEl) {
            if (tx.side === 'SELL') {
                const items = [
                    'I followed my exit plan (not emotion)',
                    'I knew my stop loss before entering',
                    'I accepted the outcome regardless of result',
                    'This trade was within my risk limit',
                ];
                checklistEl.style.display = 'block';
                checklistEl.innerHTML = `<div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Post-Trade Checklist</div>` +
                    items.map((item, i) => `<label style="display:flex;align-items:center;gap:8px;font-size:11px;color:#a0a0c0;margin-bottom:5px;cursor:pointer;">
                        <input type="checkbox" id="jcheck_${i}" style="accent-color:var(--v-gold);">
                        ${item}
                    </label>`).join('');
            } else {
                checklistEl.style.display = 'none';
            }
        }

        modal.classList.add('open');
        setTimeout(() => note.focus(), 100);
    }

    function selectEmotionTag(id) {
        _selectedEmotionTag = _selectedEmotionTag === id ? null : id;
        EMOTION_TAGS.forEach(e => {
            const btn = document.getElementById('etag_' + e.id);
            if (!btn) return;
            if (e.id === _selectedEmotionTag) {
                btn.style.borderColor = e.color;
                btn.style.color = e.color;
                btn.style.background = e.color + '18';
            } else {
                btn.style.borderColor = 'rgba(255,255,255,0.1)';
                btn.style.color = '#8888a8';
                btn.style.background = 'rgba(255,255,255,0.04)';
            }
        });
    }

    function saveJournalNoteV2() {
        if (!journalPendingTx) { closeJournal(); return; }
        const note = document.getElementById('journalNote').value.trim();
        const tx   = journalPendingTx;

        // Gather checklist scores
        const checks = [0,1,2,3].map(i => document.getElementById('jcheck_' + i)?.checked ? 1 : 0);
        const checkScore = checks.reduce((a,b)=>a+b,0);

        if (!tradeJournal[tx.symbol]) tradeJournal[tx.symbol] = [];
        tradeJournal[tx.symbol].push({
            ts: tx.ts || Date.now(),
            side: tx.side,
            qty: tx.qty,
            price: tx.price,
            note,
            emotionTag: _selectedEmotionTag,
            strategyId: _selectedStrategy,
            checkScore,
            planAdherence: tx.side === 'SELL' ? checkScore / 4 : null,
        });

        // Track emotion pattern in user data
        if (currentUser) {
            currentUser.tradeJournal = tradeJournal;
            if (_selectedEmotionTag === 'revenge' || _selectedEmotionTag === 'fomo') {
                recordRiskViolation(`Emotional trade tagged: ${_selectedEmotionTag}`);
            }
        }
        closeJournal();
        renderHistory();
        if (tx.symbol === detailStock?.symbol) renderStockJournalNote(tx.symbol);
    }

    // Override journal open/save with upgraded versions
    window.openJournal = openJournalV2;
    window.saveJournalNote = saveJournalNoteV2;

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  STRATEGY DECAY DETECTION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function checkStrategyDecay() {
        if (!strategies || strategies.length === 0) return [];
        const decayAlerts = [];
        const sells = (transactions || []).filter(t => t.type === 'SELL');

        strategies.forEach(s => {
            const stratSells = sells.filter(t => t.strategyId === s.id);
            if (stratSells.length < 6) return; // Need at least 6 trades to detect decay

            // Split into first half and second half
            const half = Math.floor(stratSells.length / 2);
            const first  = stratSells.slice(0, half);
            const second = stratSells.slice(half);

            const winRate = arr => arr.filter(t => (t.price-(t.avgBuy||t.price)) > 0).length / arr.length;
            const wr1 = winRate(first);
            const wr2 = winRate(second);

            if (wr1 - wr2 > 0.2) { // Win rate dropped by >20%
                decayAlerts.push({
                    strategy: s.name,
                    message: `Win rate dropped from ${(wr1*100).toFixed(0)}% â†’ ${(wr2*100).toFixed(0)}% in recent trades. Strategy may be losing edge.`,
                    severity: wr1 - wr2 > 0.35 ? 'critical' : 'warning'
                });
            }
        });
        return decayAlerts;
    }

    function renderStrategyDecayAlerts() {
        const alerts = checkStrategyDecay();
        const el = document.getElementById('strategyDecayAlerts');
        if (!el) return;
        if (alerts.length === 0) {
            el.innerHTML = '<div style="color:#4ade80;font-size:11px;font-style:italic;">âœ“ All strategies performing within expected range.</div>';
            return;
        }
        el.innerHTML = alerts.map(a => `
            <div style="background:rgba(${a.severity==='critical'?'239,68,68':'245,158,11'},0.08);border:1px solid rgba(${a.severity==='critical'?'239,68,68':'245,158,11'},0.25);border-radius:8px;padding:10px 12px;margin-bottom:6px;">
                <div style="font-size:11px;font-weight:700;color:${a.severity==='critical'?'#f87171':'#f59e0b'};margin-bottom:3px;">âš ï¸ ${a.strategy} â€” Strategy Decay Detected</div>
                <div style="font-size:10px;color:#a0a0c0;line-height:1.55;">${a.message}</div>
            </div>`).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  PERFORMANCE REPORT â€” Weekly Digest
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function generateWeeklyReport() {
        const metrics = computeAllMetrics();
        const sells   = (transactions || []).filter(t => t.type === 'SELL');
        const scores  = computeDisciplineScores();
        const regime  = classifyMarketRegime();
        const decayAlerts = checkStrategyDecay();

        const totalEquity = cash + Object.keys(portfolio).reduce((s,sym)=>{
            const st = getStockBySymbol(sym); return s+(st?st.price*portfolio[sym]:0);
        },0);
        const pl = totalEquity - 100000;
        const plPct = (pl/100000*100).toFixed(2);

        const reportHTML = `
        <div style="font-family:var(--v-mono);background:#0a0a0f;padding:32px;border-radius:16px;max-width:680px;margin:0 auto;">
            <!-- Header -->
            <div style="text-align:center;margin-bottom:32px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.08);">
                <div style="font-size:11px;color:#6868a0;font-weight:700;letter-spacing:0.14em;text-transform:uppercase;margin-bottom:8px;">Vestra Intelligence Platform</div>
                <div style="font-family:var(--v-serif);font-size:1.8rem;color:#f0f0fa;font-weight:400;">Weekly Performance Report</div>
                <div style="font-size:11px;color:#8888a8;margin-top:6px;">${new Date().toLocaleDateString([], {weekday:'long',year:'numeric',month:'long',day:'numeric'})}</div>
                <div style="font-size:11px;color:#8888a8;margin-top:2px;">Trader: ${currentUser?.displayName || 'â€”'}</div>
            </div>

            <!-- Equity Summary -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:20px;margin-bottom:20px;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">Portfolio Summary</div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
                    <div><div style="font-size:9px;color:#6868a0;margin-bottom:3px;">Total Equity</div><div style="font-size:1.3rem;font-weight:700;color:#f0f0fa;">$${totalEquity.toLocaleString(undefined,{maximumFractionDigits:0})}</div></div>
                    <div><div style="font-size:9px;color:#6868a0;margin-bottom:3px;">Total Return</div><div style="font-size:1.3rem;font-weight:700;color:${pl>=0?'#4ade80':'#f87171'};">${pl>=0?'+':''}${plPct}%</div></div>
                    <div><div style="font-size:9px;color:#6868a0;margin-bottom:3px;">Closed Trades</div><div style="font-size:1.3rem;font-weight:700;color:#a78bfa;">${sells.length}</div></div>
                </div>
            </div>

            <!-- Risk-Adjusted Metrics -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:20px;">
                ${[
                    {l:'Sharpe Ratio', v:metrics.sharpe, c: metrics.sharpe>1?'#4ade80':metrics.sharpe>0?'#f59e0b':'#f87171'},
                    {l:'Max Drawdown', v:metrics.maxDD+'%', c: metrics.maxDD>-10?'#4ade80':metrics.maxDD>-20?'#f59e0b':'#f87171'},
                    {l:'Profit Factor', v:metrics.profitFactor, c: metrics.profitFactor>=1.5?'#4ade80':metrics.profitFactor>=1?'#f59e0b':'#f87171'},
                    {l:'Win Rate', v:metrics.winRate+'%', c: metrics.winRate>=50?'#4ade80':'#f87171'},
                    {l:'Expectancy', v:metrics.expectancy+'%', c: metrics.expectancy>=0?'#4ade80':'#f87171'},
                    {l:'Capital Eff.', v:metrics.capitalEfficiency+'%', c: metrics.capitalEfficiency>=0?'#4ade80':'#f87171'},
                ].map(m=>`<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;text-align:center;">
                    <div style="font-size:8px;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">${m.l}</div>
                    <div style="font-size:1.1rem;font-weight:700;color:${m.c};">${m.v}</div>
                </div>`).join('')}
            </div>

            <!-- Discipline Scores -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:20px;margin-bottom:20px;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">Behavioral Scores</div>
                <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;">
                    ${[
                        {l:'Discipline', v:scores.discipline, c:'#a78bfa'},
                        {l:'Consistency', v:scores.consistency, c:'#60a5fa'},
                        {l:'Risk Control', v:scores.risk, c:'#4ade80'},
                        {l:'Emotional', v:scores.emotional, c:'#f59e0b'},
                    ].map(s=>{
                        const g = s.v>=80?'A':s.v>=65?'B':s.v>=50?'C':'D';
                        return `<div style="text-align:center;">
                            <div style="font-size:1.6rem;font-weight:700;color:${s.c};">${g}</div>
                            <div style="font-size:8px;color:#6868a0;margin-top:2px;">${s.l} Â· ${s.v}/100</div>
                        </div>`;
                    }).join('')}
                </div>
            </div>

            <!-- Regime + Behavioral Warnings -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:20px;margin-bottom:20px;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Market Context</div>
                <div style="display:flex;align-items:center;gap:12px;">
                    <div style="font-size:2rem;">${regime.icon}</div>
                    <div>
                        <div style="font-size:13px;font-weight:700;color:${regime.color};">${regime.regime}</div>
                        <div style="font-size:11px;color:#8888a8;">${regime.desc}</div>
                    </div>
                </div>
                ${metrics.lossStreakWarning ? `<div style="margin-top:10px;padding:8px 12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:11px;color:#f87171;">âš ï¸ Active loss streak (${metrics.curLossStreak} trades) â€” consider reducing size or taking a break.</div>` : ''}
                ${metrics.overconfidenceRisk ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(245,158,11,0.08);border:1px solid rgba(245,158,11,0.2);border-radius:8px;font-size:11px;color:#f59e0b;">âš¡ Overconfidence risk â€” win streak of ${metrics.winStreak}. Check position sizes on next trade.</div>` : ''}
                ${metrics.riskEscalation ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:11px;color:#f87171;">ğŸ“ˆ Risk escalation pattern: position sizes increased after losses. Review last 5 trades.</div>` : ''}
                ${decayAlerts.length > 0 ? `<div style="margin-top:8px;padding:8px 12px;background:rgba(167,139,250,0.08);border:1px solid rgba(167,139,250,0.2);border-radius:8px;font-size:11px;color:#a78bfa;">ğŸ§ª ${decayAlerts.length} strategy decay alert(s) detected this period.</div>` : ''}
            </div>

            <!-- Behavioral Intelligence -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:20px;margin-bottom:20px;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">Behavioral Intelligence</div>
                <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;">
                    ${[
                        {l:'Avg Hold Time', v: metrics.avgHoldTime>24?(metrics.avgHoldTime/24).toFixed(1)+'d':metrics.avgHoldTime.toFixed(1)+'h', c:'#60a5fa', tip:'Time in trades on average'},
                        {l:'Avg Between Trades', v: metrics.avgTimeBetweenTrades>24?(metrics.avgTimeBetweenTrades/24).toFixed(1)+'d':metrics.avgTimeBetweenTrades.toFixed(1)+'h', c:'#a78bfa', tip:'Patience between entries'},
                        {l:'Patience Score', v: metrics.patienceScore+'/100', c: metrics.patienceScore>=70?'#4ade80':metrics.patienceScore>=40?'#f59e0b':'#f87171', tip:'Hold time relative to session length'},
                        {l:'Emotional Drift', v: metrics.emotionalDriftScore+'/100', c: metrics.emotionalDriftScore>=70?'#4ade80':metrics.emotionalDriftScore>=40?'#f59e0b':'#f87171', tip:'Position size stability over time'},
                        {l:'Rolling Win Rate', v: metrics.rollingWinRate+'%', c: metrics.rollingWinRate>=50?'#4ade80':'#f87171', tip:'Win rate of last 10 trades'},
                        {l:'Risk of Ruin', v: metrics.riskOfRuin<0.01?'<1%':(metrics.riskOfRuin*100).toFixed(1)+'%', c: metrics.riskOfRuin<0.05?'#4ade80':metrics.riskOfRuin<0.2?'#f59e0b':'#f87171', tip:'Probability of losing all capital at current sizing'},
                    ].map(m=>`<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;text-align:center;" title="${m.tip}">
                        <div style="font-size:8px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:3px;">${m.l}</div>
                        <div style="font-size:1rem;font-weight:700;color:${m.c};">${m.v}</div>
                    </div>`).join('')}
                </div>
            </div>

            <!-- Footer -->
            <div style="text-align:center;font-size:10px;color:#3a3a5a;padding-top:16px;border-top:1px solid rgba(255,255,255,0.04);">
                Vestra Intelligence Platform Â· Simulation only Â· No real financial advice<br>
                Generated ${new Date().toISOString()}
            </div>
        </div>`;

        return reportHTML;
    }

    function openPerformanceReport() {
        const modal = document.getElementById('perfReportModal');
        const body  = document.getElementById('perfReportBody');
        if (!modal || !body) return;
        body.innerHTML = generateWeeklyReport();
        modal.style.display = 'flex';
    }
    function closePerformanceReport() {
        const modal = document.getElementById('perfReportModal');
        if (modal) modal.style.display = 'none';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ROADMAP & TRANSPARENCY PAGE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function openRoadmap() {
        const modal = document.getElementById('roadmapModal');
        if (modal) modal.style.display = 'flex';
    }
    function closeRoadmap() {
        const modal = document.getElementById('roadmapModal');
        if (modal) modal.style.display = 'none';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEADERBOARD INTEGRITY CHECK
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function checkLeaderboardIntegrity(user) {
        // Returns { eligible, reason }
        if (!user) return { eligible: false, reason: 'Invalid account' };
        if ((user.totalTrades || 0) < 3) return { eligible: false, reason: 'Minimum 3 trades required' };
        if ((user.riskViolations || 0) > 10) return { eligible: false, reason: 'Too many risk violations' };
        if ((user.integrityScore ?? 100) < 40) return { eligible: false, reason: 'Integrity score too low' };
        // Check for unrealistic returns (>500% return = suspicious)
        const retPct = user.totalValue ? ((user.totalValue - 100000) / 100000 * 100) : 0;
        if (retPct > 500) return { eligible: false, reason: 'Return flagged for review (>500%)' };
        // Ghost account: totalValue === exactly starting capital with no trades
        if ((user.totalTrades || 0) === 0 && (user.totalValue || 100000) === 100000) return { eligible: false, reason: 'No trading activity' };
        return { eligible: true, reason: 'Verified' };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  BEHAVIORAL INTELLIGENCE â€” Upgraded AI Coach Refresh
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function refreshAICoachSidebar() {
        // Update the sidebar score rings
        const scores = computeDisciplineScores();
        const d = document.getElementById('coachDiscipline');
        const r = document.getElementById('coachRisk');
        const con = document.getElementById('coachConsistency');
        if (d) d.textContent = scores.discipline >= 80 ? 'A' : scores.discipline >= 65 ? 'B' : scores.discipline >= 50 ? 'C' : 'D';
        if (r) r.textContent = scores.risk >= 80 ? 'A' : scores.risk >= 65 ? 'B' : scores.risk >= 50 ? 'C' : 'D';
        if (con) con.textContent = scores.consistency >= 80 ? 'A' : scores.consistency >= 65 ? 'B' : scores.consistency >= 50 ? 'C' : 'D';

        // Update insights panel
        const insEl = document.getElementById('aiCoachInsights');
        if (!insEl) return;
        const metrics = computeAllMetrics();
        const patterns = detectBiasPatterns();
        const urgentPattern = patterns.find(p => p.severity === 'high');

        let html = '';
        if (urgentPattern) {
            html += `<div style="padding:7px 10px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:7px;margin-bottom:6px;">
                <div style="font-size:10px;font-weight:700;color:#f87171;">${urgentPattern.icon} ${urgentPattern.name}</div>
                <div style="font-size:10px;color:#a0a0c0;margin-top:2px;line-height:1.4;">${urgentPattern.desc}</div>
            </div>`;
        }
        if (metrics.lossStreakWarning) {
            html += `<div style="font-size:10px;color:#f59e0b;padding:5px 0;">âš ï¸ ${metrics.curLossStreak} consecutive losses â€” consider pausing.</div>`;
        }
        if (metrics.winRate === 0 && (transactions||[]).filter(t=>t.type==='SELL').length === 0) {
            html = '<div style="color:#6868a0;font-size:11px;font-style:italic;text-align:center;padding:8px 0;">Close some trades to unlock coaching.</div>';
        }
        if (!html) {
            html = `<div style="font-size:10px;color:#8888a8;line-height:1.6;">Win Rate: <span style="color:${metrics.winRate>=50?'#4ade80':'#f87171'};font-weight:700;">${metrics.winRate}%</span>
                Â· Expectancy: <span style="color:${metrics.expectancy>=0?'#4ade80':'#f87171'};font-weight:700;">${metrics.expectancy}%</span>
                Â· Profit Factor: <span style="color:${metrics.profitFactor>=1.5?'#4ade80':'#f59e0b'};font-weight:700;">${metrics.profitFactor}</span></div>`;
        }
        insEl.innerHTML = html;
    }

    // Wire refreshAICoach to also update sidebar
    const _origRefreshAICoach = window.refreshAICoach;
    window.refreshAICoach = function() {
        if (typeof _origRefreshAICoach === 'function') _origRefreshAICoach();
        refreshAICoachSidebar();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  NOTIFICATIONS UPGRADE â€” Risk Alerts, Rank Changes, Challenge Milestones
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function triggerRankChangeAlert(oldRank, newRank) {
        if (!oldRank || !newRank || oldRank === newRank) return;
        const moved = oldRank - newRank; // positive = moved up
        if (moved > 0) {
            addNotification(`ğŸ“ˆ Rank improved: #${oldRank} â†’ #${newRank} (+${moved} spots)`, 'success');
        } else {
            addNotification(`ğŸ“‰ Rank dropped: #${oldRank} â†’ #${newRank} (${moved} spots)`, 'warning');
        }
    }

    function triggerChallengeMilestone(msg) {
        addNotification(`ğŸ† Challenge: ${msg}`, 'success');
    }

    // Check for loss streak on every trade
    function postTradeIntelligenceCheck() {
        const metrics = computeAllMetrics();
        if (metrics.lossStreakWarning && metrics.curLossStreak === 3) {
            addNotification('âš ï¸ 3 consecutive losses. Risk Guard recommends reducing size by 50% or stopping for today.', 'warning');
        }
        if (metrics.overconfidenceRisk) {
            addNotification('âš¡ Win streak detected. Overconfidence risk â€” double-check your position sizing.', 'warning');
        }
        refreshAICoachSidebar();
        renderStrategyDecayAlerts();
    }

    // (executeOrderNow hook already wired above)

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  ADVANCED METRICS: RENDER IN AI COACH MODAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Extend renderAICoach to include new metrics
    const _origRenderAICoach = window.renderAICoach;
    window.renderAICoach = function() {
        if (typeof _origRenderAICoach === 'function') _origRenderAICoach();

        // Add advanced metrics panel if not already rendered
        const container = document.getElementById('coachAdvancedMetrics');
        if (!container) return;
        const m = computeAllMetrics();
        const stability = computeRiskStabilityScore();
        const decayAlerts = checkStrategyDecay();

        container.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:12px;">
            ${[
                {l:'Expectancy', v:m.expectancy+'%/trade', tip:'Expected value per trade. Positive = edge exists.', c:m.expectancy>=0?'#4ade80':'#f87171'},
                {l:'Risk of Ruin', v:m.riskOfRuin<0.01?'<1%':(m.riskOfRuin*100).toFixed(1)+'%', tip:'Probability of losing all capital at current sizing.', c:m.riskOfRuin<0.05?'#4ade80':m.riskOfRuin<0.2?'#f59e0b':'#f87171'},
                {l:'Capital Efficiency', v:m.capitalEfficiency+'%', tip:'Realized P&L as % of max capital deployed.', c:m.capitalEfficiency>=0?'#4ade80':'#f87171'},
                {l:'Equity Volatility', v:m.equityVolatility+'%', tip:'Average daily equity swing as % of portfolio.', c:m.equityVolatility<1?'#4ade80':m.equityVolatility<3?'#f59e0b':'#f87171'},
                {l:'Rolling Win Rate', v:m.rollingWinRate+'%', tip:'Win rate of your last 10 trades.', c:m.rollingWinRate>=50?'#4ade80':'#f87171'},
                {l:'Patience Score', v:stability?stability.score+'/100':'â€”', tip:'Consistency of position sizing across trades.', c:stability&&stability.score>=70?'#4ade80':'#f59e0b'},
            ].map(item=>`<div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px;">
                <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;">${item.l}</div>
                <div style="font-family:var(--v-mono);font-size:1rem;font-weight:700;color:${item.c};">${item.v}</div>
                <div style="font-size:9px;color:#4040a0;margin-top:3px;line-height:1.4;">${item.tip}</div>
            </div>`).join('')}
        </div>
        ${m.emotionalDriftScore < 60 ? `<div style="padding:8px 12px;background:rgba(239,68,68,0.07);border:1px solid rgba(239,68,68,0.2);border-radius:8px;font-size:11px;color:#f87171;margin-bottom:8px;">
            âš¡ Emotional Drift Detected: Your position sizes are increasing over time (score: ${m.emotionalDriftScore}/100). This pattern often precedes large losses.
        </div>` : ''}
        ${decayAlerts.length > 0 ? `<div style="padding:8px 12px;background:rgba(167,139,250,0.07);border:1px solid rgba(167,139,250,0.2);border-radius:8px;font-size:11px;color:#a78bfa;">
            ğŸ§ª Strategy Decay: ${decayAlerts.map(a=>a.strategy).join(', ')} â€” Win rate declining in recent trades.
        </div>` : ''}
        <!-- Market Sessions -->
        <div id="marketSessionsViz" style="margin-top:12px;padding:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;"></div>`;

        renderMarketSessions();
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  INIT: Wire everything together
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Load simulation mode from user prefs
    if (currentUser?.simulationMode) setSimulationMode(currentUser.simulationMode);

    // (saveUserData already patched above)

</script>

<!-- â•â•â• MONTHLY CHAMPIONS OVERLAY â•â•â• -->
<div id="championsOverlay" style="display:none;position:fixed;inset:0;z-index:9997;background:rgba(0,0,0,0.85);backdrop-filter:blur(14px);align-items:center;justify-content:center;" onclick="closeChampions()">
    <div onclick="event.stopPropagation()" style="background:#0e0e16;border:1px solid rgba(212,168,75,0.2);border-radius:24px;width:100%;max-width:520px;max-height:80vh;overflow-y:auto;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:28px 32px 20px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 4px;">ğŸ› Hall of Champions</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Monthly winners by mode</p>
            </div>
            <button onclick="closeChampions()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div id="championsList" style="padding:24px 32px 28px;">
            <div style="text-align:center;color:#8888a8;padding:24px 0;">Loading championsâ€¦</div>
        </div>
    </div>
</div>


<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     STRATEGY LAB MODAL â€” v6 with equity curve, stress test, Target R
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="strategyLabModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(167,139,250,0.2);border-radius:24px;width:100%;max-width:780px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(167,139,250,0.07),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ§ª Strategy Lab</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Create, tag, analyse, and stress-test your trading strategies</p>
            </div>
            <div style="display:flex;gap:8px;align-items:center;">
                <button onclick="openStrategyLabTab('list')" id="slTabList" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:7px;cursor:pointer;background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);">Strategies</button>
                <button onclick="openStrategyLabTab('stress')" id="slTabStress" style="font-size:11px;font-weight:700;padding:5px 12px;border-radius:7px;cursor:pointer;background:transparent;color:#6868a0;border:1px solid rgba(255,255,255,0.08);">Stress Test</button>
                <button onclick="closeStrategyLab()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;margin-left:4px;">&times;</button>
            </div>
        </div>

        <!-- TAB: Strategy List -->
        <div id="slPanelList" style="padding:20px 28px;">
            <!-- Create Strategy -->
            <div style="background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.15);border-radius:14px;padding:16px;margin-bottom:20px;">
                <div style="font-size:11px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:12px;">+ New Strategy</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
                    <input id="slName" placeholder="Strategy name (e.g. RSI Bounce)" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 12px;font-size:12px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                    <select id="slTag" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 12px;font-size:12px;color:#e0e0f5;outline:none;">
                        <option value="#Breakout">#Breakout</option>
                        <option value="#Swing">#Swing</option>
                        <option value="#Earnings">#Earnings</option>
                        <option value="#Momentum">#Momentum</option>
                        <option value="#Reversal">#Reversal</option>
                        <option value="#Scalp">#Scalp</option>
                        <option value="#ValueBuy">#ValueBuy</option>
                        <option value="#DipBuy">#DipBuy</option>
                        <option value="#MeanRevert">#MeanRevert</option>
                        <option value="#CatalystPlay">#CatalystPlay</option>
                    </select>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:10px;margin-bottom:12px;">
                    <div>
                        <label style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;display:block;">Entry Condition</label>
                        <input id="slEntry" placeholder="RSI &lt; 30, breakout..." style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 10px;font-size:11px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                    </div>
                    <div>
                        <label style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;display:block;">Exit Condition</label>
                        <input id="slExit" placeholder="RSI &gt; 70, target..." style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 10px;font-size:11px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                    </div>
                    <div>
                        <label style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;display:block;">Risk per Trade %</label>
                        <input id="slRisk" type="number" step="0.1" value="1" min="0.1" max="10" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 10px;font-size:11px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
                    </div>
                    <div>
                        <label style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:3px;display:block;">Target R</label>
                        <input id="slTargetR" type="number" step="0.1" value="2" min="0.5" max="20" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 10px;font-size:11px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='#a78bfa'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'" title="Reward-to-risk ratio target (e.g. 2 = 2:1 R:R)">
                    </div>
                </div>
                <button onclick="createStrategy()" style="background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:8px;padding:8px 20px;font-size:12px;font-weight:700;cursor:pointer;">Create Strategy</button>
            </div>
            <!-- Strategy Performance List -->
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">Your Strategies</div>
            <!-- Strategy Decay Alerts -->
            <div id="strategyDecayAlerts" style="margin-bottom:12px;"></div>
            <div id="strategyList" style="display:flex;flex-direction:column;gap:12px;">
                <div style="text-align:center;color:#6868a0;padding:20px;font-style:italic;font-size:12px;">No strategies yet. Create one above to start tracking performance.</div>
            </div>
        </div>

        <!-- TAB: Stress Test Engine -->
        <div id="slPanelStress" style="display:none;padding:20px 28px;">
            <div style="font-size:11px;color:#8888a8;line-height:1.6;margin-bottom:16px;background:rgba(255,255,255,0.03);border-radius:10px;padding:12px 14px;border:1px solid rgba(255,255,255,0.06);">
                The <strong style="color:#f0f0fa;">Stress Test Engine</strong> simulates your strategy performance under historical adverse conditions â€” high volatility regimes, earnings-driven gaps, low-liquidity days, and trending/ranging markets. Results are based on your actual trade history distributions.
            </div>
            <!-- Strategy selector -->
            <div style="margin-bottom:16px;">
                <label style="font-size:10px;color:#8888a8;display:block;margin-bottom:5px;">Select Strategy to Test</label>
                <select id="stressStratSelect" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:8px 12px;font-size:12px;color:#e0e0f5;outline:none;width:100%;max-width:300px;">
                    <option value="">â€” Select a strategy â€”</option>
                </select>
            </div>
            <!-- Scenarios -->
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;">Test Scenarios</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:16px;" id="stressScenarios">
                <label style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px 14px;cursor:pointer;display:flex;gap:10px;align-items:flex-start;">
                    <input type="checkbox" id="sc_hv" checked style="margin-top:2px;cursor:pointer;">
                    <div>
                        <div style="font-size:12px;font-weight:600;color:#f87171;">âš¡ High Volatility</div>
                        <div style="font-size:10px;color:#8888a8;margin-top:2px;">VIX >30 regime. Slippage Ã—3, gaps simulated.</div>
                    </div>
                </label>
                <label style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px 14px;cursor:pointer;display:flex;gap:10px;align-items:flex-start;">
                    <input type="checkbox" id="sc_news" checked style="margin-top:2px;cursor:pointer;">
                    <div>
                        <div style="font-size:12px;font-weight:600;color:#f59e0b;">ğŸ“° News Event Shock</div>
                        <div style="font-size:10px;color:#8888a8;margin-top:2px;">Earnings/FOMC gap: Â±5-15% overnight move.</div>
                    </div>
                </label>
                <label style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px 14px;cursor:pointer;display:flex;gap:10px;align-items:flex-start;">
                    <input type="checkbox" id="sc_ll" style="margin-top:2px;cursor:pointer;">
                    <div>
                        <div style="font-size:12px;font-weight:600;color:#60a5fa;">ğŸ’¤ Low Liquidity</div>
                        <div style="font-size:10px;color:#8888a8;margin-top:2px;">Holiday/pre-market thin order book. Wider spreads.</div>
                    </div>
                </label>
                <label style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:12px 14px;cursor:pointer;display:flex;gap:10px;align-items:flex-start;">
                    <input type="checkbox" id="sc_gap" style="margin-top:2px;cursor:pointer;">
                    <div>
                        <div style="font-size:12px;font-weight:600;color:#a78bfa;">â†•ï¸ Gap Simulation</div>
                        <div style="font-size:10px;color:#8888a8;margin-top:2px;">10% of trades open with a gap past stop-loss.</div>
                    </div>
                </label>
            </div>
            <button onclick="runStressTest()" style="background:rgba(167,139,250,0.15);color:#a78bfa;border:1px solid rgba(167,139,250,0.3);border-radius:8px;padding:9px 24px;font-size:12px;font-weight:700;cursor:pointer;margin-bottom:16px;" id="stressRunBtn">â–¶ Run Stress Test</button>
            <!-- Results -->
            <div id="stressResults" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     RISK GUARD MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="riskGuardModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:center;justify-content:center;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(245,158,11,0.2);border-radius:24px;width:100%;max-width:480px;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 16px;border-bottom:1px solid rgba(255,255,255,0.07);background:linear-gradient(135deg,rgba(245,158,11,0.06),transparent);">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 3px;">ğŸ›¡ Risk Guard</h2>
                    <p style="font-size:11px;color:#8888a8;margin:0;">Enforce trading discipline with hard rules</p>
                </div>
                <button onclick="closeRiskGuard()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
            </div>
        </div>
        <div style="padding:20px 28px;">
            <div style="display:grid;gap:14px;">
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:12px;font-weight:600;color:#f0f0fa;">Max Risk per Trade</div>
                            <div style="font-size:10px;color:#8888a8;">Block trades exceeding this % of portfolio</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="rgMaxRiskEnabled" onchange="saveRiskGuard()" style="cursor:pointer;">
                            <span style="font-size:10px;color:#8888a8;">Active</span>
                        </label>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input id="rgMaxRisk" type="number" value="2" min="0.1" max="20" step="0.1" style="width:80px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);" oninput="saveRiskGuard()">
                        <span style="color:#8888a8;font-size:12px;">% of portfolio per trade</span>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:12px;font-weight:600;color:#f0f0fa;">Max Daily Loss</div>
                            <div style="font-size:10px;color:#8888a8;">Disable trading if daily P&amp;L falls below this</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="rgDailyLossEnabled" onchange="saveRiskGuard()" style="cursor:pointer;">
                            <span style="font-size:10px;color:#8888a8;">Active</span>
                        </label>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input id="rgDailyLoss" type="number" value="3" min="0.5" max="30" step="0.5" style="width:80px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);" oninput="saveRiskGuard()">
                        <span style="color:#8888a8;font-size:12px;">% max daily drawdown</span>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:12px;font-weight:600;color:#f0f0fa;">Max Open Positions</div>
                            <div style="font-size:10px;color:#8888a8;">Enforce concentration discipline</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="rgMaxPosEnabled" onchange="saveRiskGuard()" style="cursor:pointer;">
                            <span style="font-size:10px;color:#8888a8;">Active</span>
                        </label>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input id="rgMaxPos" type="number" value="5" min="1" max="30" step="1" style="width:80px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);" oninput="saveRiskGuard()">
                        <span style="color:#8888a8;font-size:12px;">max simultaneous positions</span>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:14px;">
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
                        <div>
                            <div style="font-size:12px;font-weight:600;color:#f0f0fa;">Consecutive Loss Limit</div>
                            <div style="font-size:10px;color:#8888a8;">Pause trading after N losses in a row</div>
                        </div>
                        <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                            <input type="checkbox" id="rgConsecEnabled" onchange="saveRiskGuard()" style="cursor:pointer;">
                            <span style="font-size:10px;color:#8888a8;">Active</span>
                        </label>
                    </div>
                    <div style="display:flex;align-items:center;gap:8px;">
                        <input id="rgConsecLoss" type="number" value="3" min="1" max="10" step="1" style="width:80px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);border-radius:6px;padding:6px 10px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);" oninput="saveRiskGuard()">
                        <span style="color:#8888a8;font-size:12px;">consecutive losses max</span>
                    </div>
                </div>
            </div>
            <!-- Status -->
            <div id="riskGuardStatus" style="margin-top:14px;padding:10px 14px;border-radius:8px;font-size:11px;font-weight:600;background:rgba(74,222,128,0.08);border:1px solid rgba(74,222,128,0.2);color:#4ade80;display:flex;align-items:center;gap:6px;">
                <span>âœ“</span> Risk Guard active â€” monitoring your trades
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     MACRO MARKET OVERVIEW MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="macroModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(96,165,250,0.2);border-radius:24px;width:100%;max-width:800px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(96,165,250,0.07),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸŒ Market Overview</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Major indices Â· Sector heatmap Â· Sentiment</p>
            </div>
            <button onclick="closeMacro()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:16px;">
            <!-- Major Indices -->
            <div>
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">Major Indices</div>
                <div id="macroIndices" style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;"></div>
            </div>
            <!-- Fear/Greed + Breadth -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
                    <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;">ğŸ˜¨ Sentiment Meter</div>
                    <div style="text-align:center;">
                        <div id="sentimentLabel" style="font-size:1.4rem;font-weight:700;color:#f0f0fa;margin-bottom:4px;">Neutral</div>
                        <div id="sentimentScore" style="font-family:var(--v-mono);font-size:2rem;font-weight:300;color:#f59e0b;">50</div>
                        <div style="height:8px;background:linear-gradient(90deg,#ef4444,#f59e0b,#4ade80);border-radius:4px;margin-top:10px;position:relative;">
                            <div id="sentimentNeedle" style="position:absolute;top:-3px;width:14px;height:14px;border-radius:50%;background:#fff;border:2px solid #1a1a24;transform:translateX(-50%);transition:left 0.5s;left:50%;box-shadow:0 2px 6px rgba(0,0,0,0.4);"></div>
                        </div>
                        <div style="display:flex;justify-content:space-between;font-size:8px;color:#6868a0;margin-top:4px;"><span>Extreme Fear</span><span>Extreme Greed</span></div>
                    </div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
                    <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;">ğŸ“Š Market Breadth</div>
                    <div id="macroBreath" style="display:grid;gap:8px;"></div>
                </div>
            </div>
            <!-- Sector Heatmap -->
            <div>
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:10px;">Sector Heatmap</div>
                <div id="macroSectorHeat" style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;"></div>
            </div>
            <!-- Top Movers -->
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:14px;">
                <div>
                    <div style="font-size:10px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">ğŸš€ Top Gainers</div>
                    <div id="macroGainers" style="font-size:11px;display:flex;flex-direction:column;gap:4px;"></div>
                </div>
                <div>
                    <div style="font-size:10px;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">ğŸ“‰ Top Losers</div>
                    <div id="macroLosers" style="font-size:11px;display:flex;flex-direction:column;gap:4px;"></div>
                </div>
                <div>
                    <div style="font-size:10px;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">âš¡ Unusual Volume</div>
                    <div id="macroVolume" style="font-size:11px;display:flex;flex-direction:column;gap:4px;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TRADER PROGRESS MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="progressModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(74,222,128,0.2);border-radius:24px;width:100%;max-width:680px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(74,222,128,0.06),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ“ˆ Trader Progress</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Your growth as a disciplined trader</p>
            </div>
            <button onclick="closeProgress()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:16px;">
            <!-- Key Stats Grid -->
            <div id="progressStats" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;"></div>
            <!-- Long vs Short Bias -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;">Trading Bias</div>
                <div id="progressBias" style="display:grid;gap:6px;"></div>
            </div>
            <!-- Risk Consistency -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:10px;">Risk Consistency</div>
                <div id="progressRiskChart" style="height:80px;display:flex;align-items:flex-end;gap:3px;"></div>
            </div>
            <!-- Reflection Prompts -->
            <div style="background:rgba(212,168,75,0.05);border:1px solid rgba(212,168,75,0.15);border-radius:12px;padding:16px;">
                <div style="font-size:11px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:12px;">ğŸ““ Weekly Reflection</div>
                <div style="display:grid;gap:8px;">
                    <div>
                        <label style="font-size:10px;color:#8888a8;display:block;margin-bottom:3px;">What did you learn this week?</label>
                        <textarea id="reflectLearn" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 10px;font-size:11px;color:#e0e0f5;outline:none;resize:none;height:50px;font-family:var(--v-sans);line-height:1.5;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'"></textarea>
                    </div>
                    <div>
                        <label style="font-size:10px;color:#8888a8;display:block;margin-bottom:3px;">What mistake repeated?</label>
                        <textarea id="reflectMistake" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 10px;font-size:11px;color:#e0e0f5;outline:none;resize:none;height:50px;font-family:var(--v-sans);line-height:1.5;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'"></textarea>
                    </div>
                    <button onclick="saveReflection()" style="background:rgba(212,168,75,0.12);color:var(--v-gold);border:1px solid rgba(212,168,75,0.25);border-radius:8px;padding:8px 16px;font-size:11px;font-weight:700;cursor:pointer;align-self:start;">Save Reflection</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LEGAL PAGES â€” SPA Overlays
     All opened via openLegalPage(key)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->

<!-- â”€â”€â”€ PRIVACY POLICY â”€â”€â”€ -->
<div id="legal-privacy" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Privacy Policy">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Legal</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Privacy Policy</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">Last updated: January 2026</p>
      </div>
      <button onclick="closeLegalPage('privacy')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <div class="highlight-box">Vestra does not process real financial transactions. This policy covers simulated trading data only.</div>
      <h2>1. Data We Collect</h2>
      <p>When you use Vestra, we collect the following information:</p>
      <ul>
        <li><strong>Account data:</strong> Display name, username (no real name or ID required)</li>
        <li><strong>Simulation data:</strong> Virtual portfolio holdings, trade history, strategy notes, journal entries</li>
        <li><strong>Usage data:</strong> Pages visited, features used, session duration â€” collected in aggregate only</li>
        <li><strong>Device data:</strong> Browser type, operating system, screen resolution</li>
      </ul>
      <p>We do not collect: real name, address, phone number, payment information, government ID, or any financial account details.</p>
      <h2>2. How We Use Your Data</h2>
      <ul>
        <li>To operate your simulation account and maintain your virtual portfolio</li>
        <li>To display your performance on the competitive leaderboard (if you consent)</li>
        <li>To improve platform features and fix issues</li>
        <li>To send service-critical notifications (no marketing without consent)</li>
      </ul>
      <h2>3. Data Sharing</h2>
      <p>We do not sell your personal data. We may share aggregated, non-identifiable statistics publicly (e.g., "average user return this month"). Your username and simulation performance may be visible to other users on the leaderboard unless you enable Private Profile mode.</p>
      <h2>4. Data Storage</h2>
      <p>Simulation data is stored in your browser's local storage and, if you enable cloud sync, in encrypted form on our servers. Data is retained for up to 24 months of inactivity before being purged.</p>
      <h2>5. Cookies</h2>
      <p>Vestra uses only strictly necessary cookies required for session management. We do not use advertising, tracking, or third-party analytics cookies without your explicit consent.</p>
      <h2>6. Your Rights</h2>
      <ul>
        <li>Right to access your data: request a full export at any time</li>
        <li>Right to deletion: request account and data deletion via <a href="mailto:support@vestra.app">support@vestra.app</a></li>
        <li>Right to portability: export your trade history as JSON</li>
        <li>Right to correct: edit your display name and profile details at any time</li>
      </ul>
      <h2>7. Contact</h2>
      <p>For data-related requests: <a href="mailto:support@vestra.app">support@vestra.app</a><br>We respond within 48 hours on business days.</p>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ TERMS OF SERVICE â”€â”€â”€ -->
<div id="legal-terms" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Terms of Service">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Legal</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Terms of Service</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">Last updated: January 2026</p>
      </div>
      <button onclick="closeLegalPage('terms')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <div class="highlight-box">By creating an account or using Vestra, you agree to these Terms of Service in full.</div>
      <h2>1. Acceptance of Terms</h2>
      <p>By accessing or using Vestra ("the Platform"), you agree to be bound by these Terms of Service. If you do not agree, do not use the Platform.</p>
      <h2>2. Simulation-Only Clause</h2>
      <p>Vestra is exclusively a simulation platform. All portfolio values, trades, profits, and losses are entirely virtual. No real currency, securities, or financial instruments are traded. Vestra is not a broker-dealer, investment advisor, or financial services provider. Nothing on this platform constitutes a real financial transaction.</p>
      <h2>3. No Financial Advice</h2>
      <p>All content on Vestra â€” including charts, analytics, AI coaching, strategy suggestions, and educational material â€” is provided for informational and educational purposes only. Nothing constitutes financial, investment, legal, or tax advice. Always consult a qualified professional before making real investment decisions.</p>
      <h2>4. Account Responsibilities</h2>
      <ul>
        <li>You are responsible for maintaining the security of your account credentials</li>
        <li>You must not impersonate other users or create misleading usernames</li>
        <li>You must not use automated bots or scripts to interact with the platform</li>
        <li>You must not attempt to manipulate leaderboard rankings through exploits</li>
      </ul>
      <h2>5. Leaderboard Integrity</h2>
      <p>Competitive leaderboards are provided in good faith. Any attempt to exploit system bugs, use automated trading bots, or otherwise manipulate rankings will result in immediate account suspension. Vestra reserves the right to remove any entry deemed to violate the spirit of fair competition.</p>
      <h2>6. Termination</h2>
      <p>Vestra reserves the right to suspend or terminate accounts that violate these Terms, at our sole discretion, with or without prior notice.</p>
      <h2>7. Limitation of Liability</h2>
      <p>To the maximum extent permitted by law, Vestra and its operators shall not be liable for any direct, indirect, incidental, or consequential damages arising from your use of the Platform. The Platform is provided "as is" without warranty of any kind.</p>
      <h2>8. Intellectual Property</h2>
      <p>All platform code, design, and brand assets are the property of Vestra. User-generated content (journal entries, strategy notes) remains your property, and you grant Vestra a limited licence to store and display it within the Platform.</p>
      <h2>9. Governing Law</h2>
      <p>These Terms shall be governed by the laws of the applicable jurisdiction. Any disputes shall be resolved through binding arbitration where permitted by law.</p>
      <h2>10. Changes to Terms</h2>
      <p>We may update these Terms periodically. Continued use of the Platform after changes constitutes acceptance of the revised Terms. We will notify users of material changes via the in-app notification system.</p>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ RISK DISCLAIMER â”€â”€â”€ -->
<div id="legal-disclaimer" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Risk Disclaimer">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#f87171;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Important Notice</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Risk Disclaimer</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">Please read carefully before trading with real money</p>
      </div>
      <button onclick="closeLegalPage('disclaimer')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <div class="highlight-box" style="border-color:rgba(239,68,68,0.3);background:rgba(239,68,68,0.05);color:#fca5a5;">âš  This disclaimer applies to real-world trading. Vestra itself involves no financial risk whatsoever.</div>
      <h2>Real-World Trading Risk</h2>
      <p>Trading securities, derivatives, and other financial instruments in real markets involves substantial risk of loss. The following risks are inherent to all market participation:</p>
      <ul>
        <li><strong>Capital loss risk:</strong> You can lose some or all of your invested capital</li>
        <li><strong>Market risk:</strong> Prices can move against your position rapidly and unpredictably</li>
        <li><strong>Liquidity risk:</strong> You may not be able to exit a position at a desired price</li>
        <li><strong>Volatility risk:</strong> Markets can experience extreme movements, especially around news events</li>
        <li><strong>Leverage risk:</strong> Leveraged products can result in losses exceeding your initial investment</li>
      </ul>
      <h2>Simulation vs Reality</h2>
      <p>Vestra is designed purely for educational purposes. The following important differences exist between simulation and real trading:</p>
      <ul>
        <li>Simulated orders execute at idealized prices without real-world slippage (outside Realism Mode)</li>
        <li>Emotional responses to real financial loss are not replicated in simulation</li>
        <li>Virtual portfolio growth does not guarantee equivalent real-world performance</li>
        <li>Tax implications of real trading are not modelled in simulation</li>
      </ul>
      <h2>No Financial Advice</h2>
      <p>Nothing on Vestra â€” including AI coaching insights, strategy analytics, educational content, or market data â€” constitutes financial advice. Vestra is not a licensed financial advisor. All analysis is for educational reference only.</p>
      <h2>Past Performance</h2>
      <p>Past simulated performance on Vestra does not guarantee, predict, or imply equivalent future performance in real markets. Historical results shown are based on virtual conditions that may differ substantially from real market environments.</p>
      <h2>Seek Professional Advice</h2>
      <p>Before making any real investment decisions, consult a qualified, licenced financial advisor who understands your personal financial situation, goals, and risk tolerance.</p>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ COMPETITION RULES â”€â”€â”€ -->
<div id="legal-competition" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Competition Rules">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Competitive Platform</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Competition Rules</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">Monthly leaderboard integrity policy</p>
      </div>
      <button onclick="closeLegalPage('competition')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <h2>Mode Separation</h2>
      <p>Standard Mode and Realism Mode leaderboards are strictly separated. Users compete only against others in the same mode. Cross-mode comparisons are not made on competitive rankings.</p>
      <h2>Monthly Competition Period</h2>
      <p>Each competition runs for a full calendar month. Rankings are calculated based on total portfolio value, percentage return, and maximum drawdown. Mode switching is locked from the 7th of the month until the 1st of the following month to ensure fair competition.</p>
      <h2>Eligibility</h2>
      <ul>
        <li>Account must have been active before the 7th of the competition month</li>
        <li>A minimum of 3 completed trades is required for leaderboard eligibility</li>
        <li>Users who switch mode mid-competition are marked ineligible for that month</li>
      </ul>
      <h2>Prohibited Conduct</h2>
      <ul>
        <li>Exploiting platform bugs to gain unfair advantage</li>
        <li>Using automated trading scripts or bots</li>
        <li>Creating multiple accounts to manipulate rankings</li>
        <li>Any form of collusion with other users</li>
      </ul>
      <h2>Realism Mode Rules</h2>
      <ul>
        <li>Trades only execute during NYSE market hours (9:30 AM â€“ 4:00 PM ET)</li>
        <li>Bid-ask spread simulation applies to all executions</li>
        <li>Maximum 5 trades per day in Millionaire Path Challenge mode</li>
        <li>Maximum 2% risk per trade in Millionaire Path Challenge mode</li>
      </ul>
      <h2>Prizes &amp; Recognition</h2>
      <p>Monthly champions receive a "Hall of Champions" entry visible to all users. Vestra competitions are recognition-only â€” no real monetary prizes are offered or implied.</p>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ COOKIE POLICY â”€â”€â”€ -->
<div id="legal-cookies" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Cookie Policy">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Legal</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Cookie Policy</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">Last updated: January 2026</p>
      </div>
      <button onclick="closeLegalPage('cookies')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <h2>What Are Cookies?</h2>
      <p>Cookies are small text files stored on your device by your browser. They help websites remember your preferences and maintain session state.</p>
      <h2>Cookies We Use</h2>
      <p><strong>Strictly Necessary (always active):</strong></p>
      <ul>
        <li><code style="background:rgba(255,255,255,0.06);padding:1px 5px;border-radius:3px;">vestra_session</code> â€” Maintains your login session</li>
        <li><code style="background:rgba(255,255,255,0.06);padding:1px 5px;border-radius:3px;">vestra_theme</code> â€” Remembers your chosen theme preference</li>
      </ul>
      <p><strong>We do NOT use:</strong></p>
      <ul>
        <li>Advertising or retargeting cookies</li>
        <li>Third-party analytics cookies (e.g., Google Analytics)</li>
        <li>Social media tracking pixels</li>
        <li>Cross-site tracking of any kind</li>
      </ul>
      <h2>Managing Cookies</h2>
      <p>You can clear cookies at any time through your browser settings. Note that clearing strictly necessary cookies will log you out of the platform. Most of Vestra's data is stored in <strong>localStorage</strong>, not cookies â€” this data persists until you explicitly clear it or request account deletion.</p>
      <h2>Changes</h2>
      <p>We will notify users via the in-app notification system of any changes to our cookie practices.</p>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ ABOUT â”€â”€â”€ -->
<div id="legal-about" class="legal-overlay" role="dialog" aria-modal="true" aria-label="About Vestra">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Company</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">About Vestra</h2>
      </div>
      <button onclick="closeLegalPage('about')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <div class="highlight-box">Vestra v6.0 â€” Structured Trading Intelligence &amp; Skill Development Platform</div>
      <h2>Mission</h2>
      <p>Vestra exists to make professional-grade trading education accessible to everyone. We believe that the best way to learn markets is by doing â€” with realistic tools, structured feedback, and competitive motivation â€” without any financial risk.</p>
      <h2>What Vestra Is</h2>
      <p>A structured trading simulation platform that replicates the experience of real market participation as closely as possible, with institutional-grade tools including:</p>
      <ul>
        <li>Real-time and historical market data (via Finnhub API)</li>
        <li>Advanced order types: market, limit, stop-loss, bracket, GTT</li>
        <li>Strategy Lab v6 with equity curves, drawdown tracking, Target R, and Stress Test Engine</li>
        <li>AI Trading Coach 3.0 with cognitive bias detection, hold-time analysis, and sizing trend charts</li>
        <li>Risk Guard enforcement system for discipline training</li>
        <li>Competitive monthly leaderboards with mode separation and risk-adjusted ranking</li>
        <li>Trade Replay Engine for practice on historical data</li>
        <li>Advanced Portfolio Analytics: equity curve, drawdown, Sharpe ratio, monthly heatmap, sector exposure</li>
        <li>Decision Intelligence Timeline: trade decisions plotted against equity curve with regime context</li>
        <li>Capital Allocation Simulator with rebalancing simulation</li>
        <li>Silent Focus Mode: P&L hidden during open positions for distraction-free trading</li>
        <li>Multi-Asset simulation: Equities, ETFs, Commodities, Forex, Crypto</li>
        <li>6 professional UI themes including Institutional Dark, Arctic Blue, and Emerald Pro</li>
        <li>Structured Challenge Mode with 4 tier progression system</li>
      </ul>
      <h2>What Vestra Is Not</h2>
      <p>Vestra is not a brokerage, not a financial advisor, not an investment platform, and not a gambling application. No real money ever changes hands.</p>
      <h2>Version History</h2>
      <ul>
        <li><strong>v6.0</strong> â€” Decision Intelligence, Capital Allocator, Advanced Analytics, Silent Focus Mode, Stress Test Engine, 6 Themes, Extended AI Coach, Long-term Discipline Score</li>
        <li><strong>v5.0</strong> â€” Strategy Lab, Replay Engine, Risk Guard, AI Coach 2.0, Legal Infrastructure</li>
        <li><strong>v4.0</strong> â€” Mode-split leaderboards, Realism Mode, Portfolio Intelligence</li>
        <li><strong>v3.0</strong> â€” Bracket orders, SIP plans, community layer, education academy</li>
        <li><strong>v2.0</strong> â€” Live API integration, advanced charting, screener</li>
        <li><strong>v1.0</strong> â€” Core simulation with basic portfolio tracking</li>
      </ul>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ CONTACT â”€â”€â”€ -->
<div id="legal-contact" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Contact">
  <div class="legal-sheet" style="max-width:560px;">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Company</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Contact Us</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">We respond within 48 hours on business days</p>
      </div>
      <button onclick="closeLegalPage('contact')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <!-- Email direct -->
      <div style="display:flex;align-items:center;gap:12px;background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.18);border-radius:10px;padding:14px 16px;margin-bottom:24px;">
        <div style="font-size:20px;">âœ‰ï¸</div>
        <div>
          <div style="font-size:11px;color:#8888a8;margin-bottom:2px;">Email us directly</div>
          <a href="mailto:support@vestra.app" style="color:var(--v-gold);font-weight:600;font-size:14px;text-decoration:none;">support@vestra.app</a>
        </div>
      </div>
      <!-- Contact Form -->
      <div style="display:grid;gap:12px;" id="contactForm">
        <div>
          <label style="font-size:11px;color:#8888a8;display:block;margin-bottom:5px;">Name</label>
          <input id="contactName" class="contact-field" placeholder="Your name" type="text" autocomplete="name">
        </div>
        <div>
          <label style="font-size:11px;color:#8888a8;display:block;margin-bottom:5px;">Email</label>
          <input id="contactEmail" class="contact-field" placeholder="your@email.com" type="email" autocomplete="email">
        </div>
        <div>
          <label style="font-size:11px;color:#8888a8;display:block;margin-bottom:5px;">Message</label>
          <textarea id="contactMessage" class="contact-field" placeholder="How can we help?" style="resize:vertical;min-height:100px;"></textarea>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
          <span style="font-size:11px;color:#6060a0;">â± Response within 48 hours</span>
          <button onclick="submitContactForm()" style="background:var(--v-gold);color:#0a0a0f;font-weight:700;border:none;border-radius:8px;padding:10px 22px;font-size:13px;cursor:pointer;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Send Message â†’</button>
        </div>
      </div>
      <div id="contactSuccess" style="display:none;text-align:center;padding:24px;">
        <div style="font-size:2.5rem;margin-bottom:12px;">âœ…</div>
        <div style="font-weight:700;color:#4ade80;font-size:1rem;margin-bottom:6px;">Message Sent!</div>
        <div style="font-size:12px;color:#8888a8;">We've received your message and will respond to <span id="contactEmailConfirm"></span> within 48 hours.</div>
      </div>
    </div>
  </div>
</div>

<!-- â”€â”€â”€ FAQ â”€â”€â”€ -->
<div id="legal-faq" class="legal-overlay" role="dialog" aria-modal="true" aria-label="FAQ">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Support</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Frequently Asked Questions</h2>
      </div>
      <button onclick="closeLegalPage('faq')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body" id="faqBody"></div>
  </div>
</div>

<!-- â”€â”€â”€ SITEMAP â”€â”€â”€ -->
<div id="legal-sitemap" class="legal-overlay" role="dialog" aria-modal="true" aria-label="Sitemap">
  <div class="legal-sheet">
    <div class="legal-header">
      <div>
        <p style="font-size:10px;color:#d4a84b;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;margin:0 0 4px;">Navigation</p>
        <h2 style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin:0;">Sitemap</h2>
        <p style="font-size:11px;color:#8888a8;margin:4px 0 0;">All sections and pages of Vestra</p>
      </div>
      <button onclick="closeLegalPage('sitemap')" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;border-radius:8px;padding:7px 12px;cursor:pointer;font-size:13px;font-weight:600;">âœ• Close</button>
    </div>
    <div class="legal-body">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px;">
        <div>
          <div class="sitemap-group">
            <div class="sitemap-group-title">Core Pages</div>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');showHomepage()">ğŸ  Home</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');document.getElementById('authOverlay').style.display='flex'">ğŸ“Š Dashboard</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openLeaderboard()">ğŸ† Leaderboard</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openMacro()">ğŸŒ Market Overview</button>
          </div>
          <div class="sitemap-group">
            <div class="sitemap-group-title">Trading Tools</div>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openStrategyLab()">ğŸ§ª Strategy Lab</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openCalendar()">ğŸ“… Economic Calendar</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openScreener()">ğŸ” Stock Screener</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openRiskGuard()">ğŸ›¡ Risk Guard</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openTraderProgress()">ğŸ“ˆ Trader Progress</button>
          </div>
        </div>
        <div>
          <div class="sitemap-group">
            <div class="sitemap-group-title">Community</div>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openCommunity()">ğŸ’¬ Discussion Feed</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openLeaderboard()">ğŸ¥‡ Monthly Challenges</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openChampions()">ğŸ› Hall of Champions</button>
            <button class="sitemap-link" onclick="closeLegalPage('sitemap');openEducation()">ğŸ“ Education Academy</button>
          </div>
          <div class="sitemap-group">
            <div class="sitemap-group-title">Legal & Company</div>
            <button class="sitemap-link" onclick="openLegalPage('privacy')">ğŸ”’ Privacy Policy</button>
            <button class="sitemap-link" onclick="openLegalPage('terms')">ğŸ“„ Terms of Service</button>
            <button class="sitemap-link" onclick="openLegalPage('disclaimer')">âš ï¸ Risk Disclaimer</button>
            <button class="sitemap-link" onclick="openLegalPage('competition')">ğŸ† Competition Rules</button>
            <button class="sitemap-link" onclick="openLegalPage('about')">ğŸ¢ About Vestra</button>
            <button class="sitemap-link" onclick="openLegalPage('contact')">âœ‰ï¸ Contact Us</button>
            <button class="sitemap-link" onclick="openLegalPage('faq')">â“ FAQ</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<!-- â•â•â• AI COACH MODAL â•â•â• -->
<div id="aiCoachModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(52,211,153,0.2);border-radius:24px;width:100%;max-width:720px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(52,211,153,0.07),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ§  AI Trade Coach</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Cognitive bias detection Â· Discipline scoring Â· Analytical insights</p>
            </div>
            <div style="display:flex;gap:8px;">
                <button onclick="renderAICoach()" style="font-size:11px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);color:#34d399;border-radius:7px;padding:5px 12px;font-weight:700;cursor:pointer;">â†» Refresh</button>
                <button onclick="closeAICoach()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
            </div>
        </div>
        <div style="padding:20px 28px;display:grid;gap:20px;">
            <!-- Score Rings -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">Discipline Scores</div>
                <div id="coachScores" style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;"></div>
            </div>
            <!-- Analytical Insights -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Performance Analytics</div>
                <div id="coachInsights"></div>
            </div>
            <!-- Bias Patterns -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Cognitive Bias Monitor</div>
                <div id="coachBiasPatterns" style="display:flex;flex-direction:column;gap:8px;"></div>
            </div>
            <!-- Market Regime -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Market Regime Classifier</div>
                <div id="coachRegime"></div>
            </div>
            <!-- Advanced Behavioral Intelligence -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Advanced Intelligence Metrics</div>
                <div id="coachAdvancedMetrics"></div>
            </div>
            <!-- Extended: Sizing escalation chart -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Position Sizing Trend (last 20 trades)</div>
                <div id="coachSizingChart" style="height:72px;display:flex;align-items:flex-end;gap:3px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:8px;overflow:hidden;"></div>
                <div style="font-size:9px;color:#6868a0;margin-top:5px;">Green = within limit Â· Yellow = borderline Â· Red = oversized</div>
            </div>
            <!-- Hold time distortion -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Win vs Loss Hold Time Analysis</div>
                <div id="coachHoldTime" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• CHALLENGE MODE MODAL â•â•â• -->
<div id="challengeModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(212,168,75,0.2);border-radius:24px;width:100%;max-width:600px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(212,168,75,0.07),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ† Structured Challenge Mode</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Fixed capital Â· Strict rules Â· Tier progression Â· No gambling</p>
            </div>
            <button onclick="closeChallengeMode()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div id="challengeContent" style="padding:20px 28px;"></div>
    </div>
</div>

<!-- â•â•â• MULTI-ASSET MODAL â•â•â• -->
<div id="multiAssetModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(34,211,238,0.2);border-radius:24px;width:100%;max-width:640px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(34,211,238,0.06),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸŒ Multi-Asset Trading</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">ETFs Â· Commodities Â· Forex Â· Digital Assets â€” all simulated</p>
            </div>
            <button onclick="closeMultiAsset()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <!-- Market hours legend -->
        <div style="padding:12px 28px;border-bottom:1px solid rgba(255,255,255,0.06);display:flex;gap:14px;flex-wrap:wrap;">
            <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;"></span>Market Open</span>
            <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#60a5fa;display:inline-block;"></span>24/7 (Crypto)</span>
            <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#22d3ee;display:inline-block;"></span>Forex Session</span>
            <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#6868a0;display:inline-block;"></span>Closed</span>
        </div>
        <div id="maContent" style="padding:20px 28px;max-height:65vh;overflow-y:auto;"></div>
    </div>
</div>

<!-- â•â•â• DECISION TIMELINE MODAL â•â•â• -->
<div id="decisionTimelineModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(251,191,36,0.2);border-radius:24px;width:100%;max-width:780px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(251,191,36,0.06),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ—“ Decision Intelligence Timeline</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Your trades plotted against equity curve Â· Market conditions Â· Journal tags</p>
            </div>
            <button onclick="closeDecisionTimeline()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:18px;">
            <!-- Equity curve with trade dots -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Equity Curve + Trade Decisions</div>
                <div id="dtEquityCurve" style="position:relative;height:160px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.07);border-radius:12px;overflow:hidden;">
                    <canvas id="dtCanvas" style="width:100%;height:100%;"></canvas>
                </div>
                <div style="display:flex;gap:14px;margin-top:8px;flex-wrap:wrap;">
                    <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#4ade80;display:inline-block;"></span>Winning trade</span>
                    <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#f87171;display:inline-block;"></span>Losing trade</span>
                    <span style="font-size:10px;color:#8888a8;display:flex;align-items:center;gap:4px;"><span style="width:8px;height:8px;border-radius:50%;background:#f59e0b;display:inline-block;"></span>Neutral/open</span>
                </div>
            </div>
            <!-- Market regime at each decision -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Regime at Time of Trade</div>
                <div id="dtRegimeBar" style="height:28px;display:flex;border-radius:8px;overflow:hidden;"></div>
            </div>
            <!-- Trade decision log -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Trade Decision Log</div>
                <div id="dtTradeLog" style="max-height:240px;overflow-y:auto;display:flex;flex-direction:column;gap:6px;"></div>
            </div>
            <!-- Entry/Exit Clustering -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Market Memory Heatmap â€” Entry Clustering by Hour</div>
                <div id="dtHeatmap" style="display:flex;gap:3px;align-items:flex-end;height:50px;"></div>
                <div style="display:flex;gap:0;margin-top:4px;">
                    <span style="font-size:9px;color:#6868a0;flex:1;text-align:center;">9:30</span>
                    <span style="font-size:9px;color:#6868a0;flex:1;text-align:center;">11</span>
                    <span style="font-size:9px;color:#6868a0;flex:1;text-align:center;">13</span>
                    <span style="font-size:9px;color:#6868a0;flex:1;text-align:center;">15</span>
                    <span style="font-size:9px;color:#6868a0;flex:1;text-align:center;">16</span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• CAPITAL ALLOCATOR MODAL â•â•â• -->
<div id="capitalAllocatorModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(99,102,241,0.2);border-radius:24px;width:100%;max-width:680px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(99,102,241,0.07),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ’¼ Capital Allocation Simulator</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Allocate across strategies Â· Simulate rebalancing Â· Analyse drawdown stability</p>
            </div>
            <button onclick="closeCapitalAllocator()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:18px;">
            <!-- Total capital input -->
            <div style="display:flex;align-items:center;gap:12px;">
                <label style="font-size:11px;color:#8888a8;flex-shrink:0;">Total Capital:</label>
                <input id="caCapital" type="number" value="100000" step="1000" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;padding:7px 12px;font-size:13px;color:#f0f0fa;outline:none;font-family:var(--v-mono);width:140px;" oninput="updateCapitalAllocator()">
                <span style="font-size:11px;color:#8888a8;">USD (virtual)</span>
                <button onclick="useCurrentPortfolio()" style="font-size:11px;background:rgba(99,102,241,0.12);border:1px solid rgba(99,102,241,0.25);color:#818cf8;border-radius:7px;padding:5px 10px;cursor:pointer;font-weight:700;">Use Portfolio Value</button>
            </div>
            <!-- Allocation sliders per strategy -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Strategy Allocations</div>
                <div id="caStrategySliders" style="display:flex;flex-direction:column;gap:10px;"></div>
                <!-- Cash remainder -->
                <div id="caCashRem" style="margin-top:10px;padding:10px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:8px;display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:#8888a8;">ğŸ¦ Unallocated Cash</span>
                    <span id="caCashRemVal" style="font-family:var(--v-mono);font-size:13px;font-weight:700;color:#60a5fa;">$100,000</span>
                </div>
            </div>
            <!-- Visualisation -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Allocation Breakdown</div>
                <div id="caBarChart" style="display:flex;flex-direction:column;gap:6px;"></div>
            </div>
            <!-- Simulated outcomes -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Simulated 3-Month Projection (based on strategy win rates)</div>
                <div id="caProjection" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;"></div>
            </div>
            <!-- Rebalancing -->
            <div style="background:rgba(99,102,241,0.05);border:1px solid rgba(99,102,241,0.15);border-radius:12px;padding:14px;">
                <div style="font-size:11px;font-weight:700;color:#818cf8;margin-bottom:8px;">âš–ï¸ Rebalancing Simulation</div>
                <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;">
                    <select id="caRebalFreq" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:6px 10px;font-size:11px;color:#e0e0f5;outline:none;">
                        <option value="monthly">Monthly Rebalance</option>
                        <option value="quarterly">Quarterly Rebalance</option>
                        <option value="none" selected>No Rebalancing</option>
                    </select>
                    <button onclick="runRebalancingSim()" style="background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);color:#818cf8;border-radius:7px;padding:6px 14px;font-size:11px;font-weight:700;cursor:pointer;">Simulate</button>
                </div>
                <div id="caRebalResult" style="margin-top:10px;font-size:11px;color:#8888a8;"></div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• ADVANCED ANALYTICS MODAL â•â•â• -->
<div id="advancedAnalyticsModal" style="display:none;position:fixed;inset:0;z-index:9995;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(244,114,182,0.2);border-radius:24px;width:100%;max-width:780px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(244,114,182,0.06),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ“Š Advanced Portfolio Analytics</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Equity curve Â· Drawdown Â· Risk-adjusted return Â· Sector exposure Â· Monthly heatmap</p>
            </div>
            <div style="display:flex;gap:8px;">
                <button onclick="renderAdvancedAnalytics()" style="font-size:11px;background:rgba(244,114,182,0.1);border:1px solid rgba(244,114,182,0.25);color:#f472b6;border-radius:7px;padding:5px 12px;font-weight:700;cursor:pointer;">â†» Refresh</button>
                <button onclick="closeAdvancedAnalytics()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
            </div>
        </div>
        <div style="padding:20px 28px;display:grid;gap:20px;">
            <!-- Mode badge -->
            <div id="analyticsModeBadge" style="display:none;"></div>

            <!-- Key Metrics Strip -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Key Performance Metrics</div>
                <div id="aaMetrics" style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;"></div>
            </div>

            <!-- Equity + Drawdown Curves -->
            <div>
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                    <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;">Equity &amp; Drawdown Curves</div>
                    <div style="display:flex;gap:6px;">
                        <button onclick="aaToggleCurve('equity')" id="aaBtnEquity" style="font-size:10px;background:rgba(244,114,182,0.15);border:1px solid rgba(244,114,182,0.3);color:#f472b6;border-radius:5px;padding:3px 8px;cursor:pointer;font-weight:700;">Equity</button>
                        <button onclick="aaToggleCurve('drawdown')" id="aaBtnDD" style="font-size:10px;background:transparent;border:1px solid rgba(255,255,255,0.1);color:#6868a0;border-radius:5px;padding:3px 8px;cursor:pointer;">Drawdown</button>
                    </div>
                </div>
                <div style="height:160px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:12px;overflow:hidden;padding:8px;">
                    <canvas id="aaEquityCanvas" style="width:100%;height:100%;"></canvas>
                </div>
            </div>

            <!-- Risk-adjusted metrics (legacy ID kept for compatibility) -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Risk-Adjusted Performance</div>
                <div id="aaRiskMetrics" style="display:grid;grid-template-columns:repeat(4,1fr);gap:10px;"></div>
            </div>

            <!-- Monthly P&L Heatmap -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Monthly P&amp;L Heatmap</div>
                <div id="aaMonthlyHeatmap" style="display:grid;grid-template-columns:repeat(6,1fr);gap:8px;overflow-x:auto;"></div>
            </div>

            <!-- Sector Exposure -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Sector Exposure</div>
                <div id="aaSectorExposure" style="display:flex;flex-direction:column;gap:6px;"></div>
            </div>

            <!-- Best / Worst Trades (combined container for JS) -->
            <div id="aaBestWorst">
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;">
                    <div>
                        <div style="font-size:10px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">ğŸ† Best 5 Trades</div>
                        <div id="aaBestTrades" style="display:flex;flex-direction:column;gap:5px;">
                            <div style="color:#6868a0;font-size:11px;text-align:center;padding:12px;">Close trades to see breakdown.</div>
                        </div>
                    </div>
                    <div>
                        <div style="font-size:10px;font-weight:700;color:#f87171;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">ğŸ“‰ Worst 5 Trades</div>
                        <div id="aaWorstTrades" style="display:flex;flex-direction:column;gap:5px;">
                            <div style="color:#6868a0;font-size:11px;text-align:center;padding:12px;">Close trades to see breakdown.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Compare vs SPY -->
            <div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:14px;">
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <div>
                        <div style="font-size:12px;font-weight:700;color:#f0f0fa;margin-bottom:3px;">Compare vs SPY (Benchmark)</div>
                        <div style="font-size:11px;color:#8888a8;">Your return vs S&amp;P 500 during your trading period</div>
                    </div>
                    <div id="aaBenchmarkCompare" style="text-align:right;"></div>
                </div>
            </div>

            <!-- Capital Allocation Simulator -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">Capital Allocation Simulator</div>
                <div id="aaAllocSim"></div>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• HELP CENTER MODAL â•â•â• -->
<div id="helpCenterModal" style="display:none;position:fixed;inset:0;z-index:9996;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(212,168,75,0.2);border-radius:24px;width:100%;max-width:800px;margin:0 auto 40px;overflow:hidden;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(212,168,75,0.06),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">â“ Feature Guide &amp; Help Center</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Learn what every feature does, why it exists, and how it improves your trading.</p>
            </div>
            <button onclick="closeHelpCenter()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:16px;">

            <!-- Feature guide grid -->
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                <!-- Strategy Lab -->
                <div style="background:rgba(167,139,250,0.06);border:1px solid rgba(167,139,250,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ§ª</span>
                        <span style="font-size:12px;font-weight:700;color:#a78bfa;">Strategy Lab</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Create named strategies with defined rules.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> You can't improve what you can't measure. Strategy tags let you see which rules actually generate edge.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Strategy consistency, systematic thinking</p>
                </div>
                <!-- AI Coach -->
                <div style="background:rgba(52,211,153,0.06);border:1px solid rgba(52,211,153,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ§ </span>
                        <span style="font-size:12px;font-weight:700;color:#34d399;">AI Trade Coach</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Detects behavioral biases in your trading pattern.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> Most losses come from psychology, not strategy. The coach shows patterns you can't see yourself.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Emotional discipline, bias awareness</p>
                </div>
                <!-- Risk Guard -->
                <div style="background:rgba(245,158,11,0.06);border:1px solid rgba(245,158,11,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ›¡</span>
                        <span style="font-size:12px;font-weight:700;color:#f59e0b;">Risk Guard</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Hard enforcement of your personal risk rules.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> Risk management is the #1 skill separating profitable from unprofitable traders. Rules must be non-negotiable.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Risk control, position sizing</p>
                </div>
                <!-- Decision Timeline -->
                <div style="background:rgba(251,191,36,0.06);border:1px solid rgba(251,191,36,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ—“</span>
                        <span style="font-size:12px;font-weight:700;color:#fbbf24;">Decision Timeline</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Visual map of every trade on your equity curve with regime context.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> See when you made great decisions vs. emotional ones. Identify market conditions where your edge works.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Pattern recognition, self-review</p>
                </div>
                <!-- Silent Focus Mode -->
                <div style="background:rgba(129,140,248,0.06);border:1px solid rgba(129,140,248,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ”•</span>
                        <span style="font-size:12px;font-weight:700;color:#818cf8;">Silent Focus Mode</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Hides all P&amp;L while you have open positions.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> Watching P&amp;L tick causes emotional decisions. Train yourself to exit based on rules, not dollar amounts.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Process discipline, anxiety management</p>
                </div>
                <!-- Advanced Analytics -->
                <div style="background:rgba(244,114,182,0.06);border:1px solid rgba(244,114,182,0.15);border-radius:12px;padding:16px;">
                    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                        <span style="font-size:1.2rem;">ğŸ“Š</span>
                        <span style="font-size:12px;font-weight:700;color:#f472b6;">Portfolio Analytics</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">What:</strong> Sharpe ratio, drawdown, monthly heatmap, sector exposure, benchmark comparison.</p>
                    <p style="font-size:11px;color:#8888a8;line-height:1.6;margin:0 0 8px;"><strong style="color:#c0c0d8;">Why:</strong> Returns alone are misleading. Risk-adjusted returns tell the real story of your skill.</p>
                    <p style="font-size:11px;color:#4ade80;margin:0;">â†‘ Improves: Performance analysis, capital efficiency</p>
                </div>
            </div>

            <!-- Key metrics glossary -->
            <div style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:12px;">ğŸ“š Metric Glossary</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">Sharpe Ratio:</strong> Return per unit of risk. &gt;1 is good, &gt;2 is excellent. Measures efficiency, not just profit.</div>
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">Max Drawdown:</strong> Largest peak-to-trough decline. Keep it under 20% to stay competitive in challenges.</div>
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">Calmar Ratio:</strong> Annual return Ã· max drawdown. Shows return relative to your worst loss period.</div>
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">R-Multiple:</strong> How much you win vs. risk. +2R means you gained 2Ã— your risk. Aim for &gt;1.5R average.</div>
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">Profit Factor:</strong> Gross profits Ã· gross losses. &gt;1.5 indicates a genuine edge exists in your strategy.</div>
                    <div style="font-size:11px;color:#a0a0c0;"><strong style="color:#f0f0fa;">Discipline Score:</strong> Composite of risk control, drawdown management, consistency, and strategy adherence.</div>
                </div>
            </div>

            <!-- Quick actions -->
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
                <button onclick="startTutorial(true);closeHelpCenter()" style="font-size:12px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);color:var(--v-gold);border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:700;">ğŸ“ Restart Walkthrough</button>
                <button onclick="openRiskGuard();closeHelpCenter()" style="font-size:12px;background:rgba(245,158,11,0.1);border:1px solid rgba(245,158,11,0.25);color:#f59e0b;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:700;">ğŸ›¡ Set Up Risk Rules</button>
                <button onclick="openStrategyLab();closeHelpCenter()" style="font-size:12px;background:rgba(167,139,250,0.1);border:1px solid rgba(167,139,250,0.25);color:#a78bfa;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:700;">ğŸ§ª Create First Strategy</button>
                <button onclick="openAICoach();closeHelpCenter()" style="font-size:12px;background:rgba(52,211,153,0.1);border:1px solid rgba(52,211,153,0.25);color:#34d399;border-radius:8px;padding:8px 16px;cursor:pointer;font-weight:700;">ğŸ§  Review AI Coach</button>
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• FEATURE HINT BANNER â•â•â• -->
<div id="featureHintBanner">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px;">
        <div style="font-size:11px;font-weight:700;color:var(--v-gold);" id="hintBannerTitle">ğŸ’¡ Feature Discovery</div>
        <button onclick="closeFeatureHint()" style="background:none;border:none;color:#6868a0;cursor:pointer;font-size:14px;line-height:1;padding:0;margin-left:10px;">âœ•</button>
    </div>
    <div style="font-size:11px;color:#a0a0c0;line-height:1.6;" id="hintBannerBody"></div>
    <div style="margin-top:8px;font-size:10px;color:#4ade80;" id="hintBannerAction"></div>
</div>

<!-- â•â•â• PERFORMANCE REPORT MODAL â•â•â• -->
<div id="perfReportModal" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.88);backdrop-filter:blur(16px);align-items:flex-start;justify-content:center;padding:32px 16px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="width:100%;max-width:720px;margin:0 auto 40px;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div style="font-size:11px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;">ğŸ“Š Weekly Performance Report</div>
            <div style="display:flex;gap:8px;">
                <button onclick="window.print()" style="font-size:11px;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);color:var(--v-gold);border-radius:7px;padding:5px 12px;cursor:pointer;font-weight:700;">ğŸ–¨ï¸ Print</button>
                <button onclick="closePerformanceReport()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.12);color:#8888a8;font-size:18px;border-radius:7px;padding:2px 10px;cursor:pointer;">&times;</button>
            </div>
        </div>
        <div id="perfReportBody"></div>
    </div>
</div>

<!-- â•â•â• SIMULATION MODE MODAL â•â•â• -->
<div id="simModeModal" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:center;justify-content:center;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(255,255,255,0.1);border-radius:24px;width:100%;max-width:560px;margin:16px;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 3px;">âš™ï¸ Simulation Mode</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">Controls spread, slippage, and position size limits</p>
            </div>
            <button onclick="closeSimulationSettings()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:12px;">
            ${Object.entries({conservative:{label:'Conservative',icon:'ğŸ›¡',color:'#4ade80',spreadBps:5,slippage:0.001,desc:'Tighter spreads, realistic fills. Best for beginners learning risk management.',maxPositionPct:0.15},standard:{label:'Standard',icon:'âš–ï¸',color:'#f59e0b',spreadBps:15,slippage:0.002,desc:'Balanced realism. Spread and slippage simulate typical retail trading.',maxPositionPct:0.30},institutional:{label:'Institutional',icon:'ğŸ›',color:'#a78bfa',spreadBps:30,slippage:0.005,desc:'Maximum realism. Large spreads and slippage model real institutional conditions.',maxPositionPct:0.10}}).map(([key, cfg]) =>
                `<div onclick="setSimulationMode('${key}');closeSimulationSettings()" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:16px;cursor:pointer;transition:all 0.15s;" onmouseover="this.style.borderColor='${cfg.color}';this.style.background='${cfg.color}0a'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.background='rgba(255,255,255,0.03)'">
                    <div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">
                        <span style="font-size:1.4rem;">${cfg.icon}</span>
                        <span style="font-size:13px;font-weight:700;color:${cfg.color};">${cfg.label}</span>
                        <span style="margin-left:auto;font-size:10px;color:#6868a0;font-family:var(--v-mono);">Spread: ${cfg.spreadBps}bps Â· Slip: ${(cfg.slippage*100).toFixed(1)}%</span>
                    </div>
                    <p style="font-size:11px;color:#8888a8;margin:0;line-height:1.55;">${cfg.desc}</p>
                </div>`
            ).join('')}
            <div style="padding:10px 14px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:8px;font-size:10px;color:#5050a0;line-height:1.6;">
                Active mode: <span id="simModeBadge" style="color:#f59e0b;font-weight:700;">âš–ï¸ Standard Mode</span>
                Â· Spread and slippage are applied on every order execution, deducted from fill price.
            </div>
        </div>
    </div>
</div>

<!-- â•â•â• ROADMAP & TRANSPARENCY MODAL â•â•â• -->
<div id="roadmapModal" style="display:none;position:fixed;inset:0;z-index:9998;background:rgba(0,0,0,0.82);backdrop-filter:blur(14px);align-items:flex-start;justify-content:center;padding-top:40px;overflow-y:auto;">
    <div onclick="event.stopPropagation()" style="background:#111118;border:1px solid rgba(212,168,75,0.2);border-radius:24px;width:100%;max-width:720px;margin:0 auto 40px;animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1);">
        <div style="padding:24px 28px 18px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(135deg,rgba(212,168,75,0.05),transparent);">
            <div>
                <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 3px;">ğŸ—ºï¸ Platform Roadmap</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">What's built, what's coming, and our commitment to transparency</p>
            </div>
            <button onclick="closeRoadmap()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;">&times;</button>
        </div>
        <div style="padding:20px 28px;display:grid;gap:16px;">
            <!-- Shipped -->
            <div>
                <div style="font-size:10px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">âœ… Shipped â€” v7.0</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                    ${['Real-time market data (Finnhub)','AI Trade Coach & Bias Detection','Strategy Lab with performance tracking','Risk Guard enforcement system','Silent Focus Mode','Multi-asset trading (stocks, ETFs, crypto, forex)','Decision Timeline','Advanced Portfolio Analytics','Leaderboard with integrity scores','Emotion-tagged trade journal','Simulation modes (Conservative/Standard/Institutional)','Strategy decay detection','ATR & volume indicators','Market session visualizer','Weekly performance reports','Interactive onboarding walkthrough','Contextual tooltip system','Help Center with metric glossary'].map(f => `<div style="display:flex;align-items:flex-start;gap:7px;font-size:11px;color:#a0a0c0;padding:5px 0;">
                        <span style="color:#4ade80;flex-shrink:0;margin-top:1px;">âœ“</span>${f}
                    </div>`).join('')}
                </div>
            </div>
            <!-- In Progress -->
            <div style="padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:10px;font-weight:700;color:#f59e0b;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">ğŸš§ In Progress</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                    ${['Email notifications for rank changes','Volume profile chart overlay','Trade Replay Engine improvements','Social trade sharing','Monthly PDF export','Strategy correlation matrix','Paper portfolio contests','Mobile-optimized layout'].map(f => `<div style="display:flex;align-items:flex-start;gap:7px;font-size:11px;color:#a0a0c0;padding:5px 0;">
                        <span style="color:#f59e0b;flex-shrink:0;margin-top:1px;">â—</span>${f}
                    </div>`).join('')}
                </div>
            </div>
            <!-- Planned -->
            <div style="padding-top:12px;border-top:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:10px;font-weight:700;color:#a78bfa;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:10px;">ğŸ“‹ Planned</div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;">
                    ${['2FA authentication option','Password reset via email','Backtesting engine','Community trade feed','Institutional data feeds','AI market commentary','Cross-device sync','Educational course library'].map(f => `<div style="display:flex;align-items:flex-start;gap:7px;font-size:11px;color:#a0a0c0;padding:5px 0;">
                        <span style="color:#a78bfa;flex-shrink:0;margin-top:1px;">â—‹</span>${f}
                    </div>`).join('')}
                </div>
            </div>
            <!-- Transparency -->
            <div style="padding:14px 16px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;">
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Data Transparency</div>
                <div style="font-size:11px;color:#8888a8;line-height:1.7;">
                    <strong style="color:#c0c0d8;">Market data:</strong> Finnhub.io real-time API (requires free key) Â· Simulated data used as fallback<br>
                    <strong style="color:#c0c0d8;">Storage:</strong> All data stored in-browser (localStorage) â€” no server-side database<br>
                    <strong style="color:#c0c0d8;">Leaderboard:</strong> Shared storage via platform API when available<br>
                    <strong style="color:#c0c0d8;">Security:</strong> Passwords are hashed client-side Â· No sensitive data transmitted<br>
                    <strong style="color:#c0c0d8;">AI coaching:</strong> Rule-based analysis â€” no external AI API calls
                </div>
            </div>
            <div style="text-align:center;font-size:10px;color:#3a3a5a;">Built by <a href="mailto:arush2011jain@gmail.com" style="color:#6868a0;">arush2011jain@gmail.com</a> Â· Feedback welcome</div>
        </div>
    </div>
</div>

</body>
</html>
