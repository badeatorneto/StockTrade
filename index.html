<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestra ‚Äî Trading With No Risk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --v-bg: #0a0a0f;
            --v-surface: #111118;
            --v-card: #1a1a24;
            --v-border: rgba(255,255,255,0.12);
            --v-gold: #d4a84b;
            --v-gold-light: #f0c96a;
            --v-green: #22c55e;
            --v-red: #ef4444;
            --v-text: #f5f5fa;
            --v-muted: #a0a0b8;
            --v-serif: 'DM Serif Display', serif;
            --v-sans: 'DM Sans', sans-serif;
            --v-mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; }
        body { font-family: var(--v-sans); background: var(--v-bg); color: var(--v-text); overflow-x: hidden; }
        .vestra-brand { font-family: var(--v-serif); }

        /* ‚îÄ‚îÄ Homepage ‚îÄ‚îÄ */
        #homePage { display: block; }
        #appPage  { display: none; }

        /* Hero gradient orbs */
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); pointer-events: none;
        }

        /* Nav */
        .home-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            padding: 0 48px; height: 72px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(10,10,15,0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .home-nav .logo { font-family: var(--v-serif); font-size: 1.75rem; color: #ffffff; }
        .nav-btn {
            padding: 9px 22px; border-radius: 8px; font-family: var(--v-sans);
            font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
            border: none;
        }
        .nav-btn-ghost { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2) !important; color: #e0e0f0; }
        .nav-btn-ghost:hover { background: rgba(255,255,255,0.12); border-color: var(--v-gold) !important; color: var(--v-gold); }
        .nav-btn-gold { background: var(--v-gold); color: #0a0a0f; font-weight: 700; }
        .nav-btn-gold:hover { background: var(--v-gold-light); }

        /* Sections */
        section { position: relative; z-index: 1; }

        /* Feature cards */
        .feat-card {
            background: #1e1e2a; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 32px; transition: all 0.3s;
        }
        .feat-card h3 { color: #ffffff; }
        .feat-card p  { color: #b0b0c8; }
        .feat-card:hover { border-color: rgba(212,168,75,0.4); transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

        /* Ticker tape */
        .ticker-wrap { overflow: hidden; background: #0e0e16; border-top: 1px solid rgba(255,255,255,0.08); border-bottom: 1px solid rgba(255,255,255,0.08); }
        .ticker { display: flex; animation: tickerScroll 40s linear infinite; white-space: nowrap; }
        .ticker:hover { animation-play-state: paused; }
        @keyframes tickerScroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }

        /* Stats counter */
        .stat-num { font-family: var(--v-serif); font-size: 3rem; color: var(--v-gold); line-height: 1; }
        .stat-label { color: #9090aa; margin-top: 8px; font-size: 0.9rem; }

        /* Step circles */
        .step-num {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(212,168,75,0.1);
            border: 1.5px solid var(--v-gold); color: var(--v-gold);
            font-family: var(--v-serif); font-size: 1.25rem;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* Gold divider */
        .gold-line { height: 1px; background: linear-gradient(90deg, transparent, rgba(212,168,75,0.5), transparent); }

        /* Footer */
        footer { position: relative; z-index: 1; border-top: 1px solid rgba(255,255,255,0.08); }
        .social-link {
            display: inline-flex; align-items: center; gap: 10px;
            color: #9090aa; text-decoration: none; font-size: 0.875rem;
            transition: color 0.2s; padding: 8px 0;
        }
        .social-link:hover { color: var(--v-gold); }
        .social-icon { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); color: #b0b0c8; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .social-link:hover .social-icon { border-color: var(--v-gold); color: var(--v-gold); }

        /* ‚îÄ‚îÄ App UI ‚îÄ‚îÄ */
        .app-header {
            background: var(--v-surface); border-bottom: 1px solid var(--v-border);
            position: sticky; top: 0; z-index: 50;
        }
        .g-card {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 12px; transition: box-shadow 0.2s, border-color 0.2s, transform 0.1s;
        }
        .g-card:hover { border-color: rgba(201,168,76,0.25); box-shadow: 0 4px 24px rgba(0,0,0,0.3); }
        .search-bar {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 24px; transition: 0.2s;
        }
        .search-bar:focus-within { border-color: var(--v-gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
        .search-bar input { color: var(--v-text); }
        .search-bar input::placeholder { color: var(--v-muted); }
        .btn-google { background: var(--v-gold); color: #0a0a0f; border-radius: 8px; font-weight: 600; padding: 8px 20px; transition: 0.2s; }
        .btn-google:hover { background: var(--v-gold-light); }
        .btn-outline { border: 1px solid var(--v-border); color: var(--v-muted); border-radius: 8px; font-weight: 500; padding: 8px 20px; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--v-gold); color: var(--v-gold); }
        .change-pill { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; font-family: var(--v-mono); display: inline-flex; align-items: center; }
        .pill-up   { background: rgba(34,197,94,0.12);  color: #4ade80; }
        .pill-down { background: rgba(239,68,68,0.12);  color: #f87171; }
        .badge-live  { background: rgba(34,197,94,0.15); color: #4ade80; }
        .badge-sim   { background: var(--v-card); color: var(--v-muted); }
        .badge-stale { background: rgba(201,168,76,0.12); color: var(--v-gold); }
        .dot-live    { background: #22c55e; animation: pulse-green 2s infinite; }
        .dot-closed  { background: #ef4444; }
        .dot-unknown { background: #6b7280; }
        @keyframes pulse-green { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* Tutorial overlay */
        #tutorialOverlay { position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; }
        #tutorialOverlay.hidden { display:none; }
        .tutorial-card { background: var(--v-card); border:1px solid rgba(201,168,76,0.3); border-radius:20px; width:520px; max-width:90vw; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,0.7); animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1); }
        .tutorial-progress-bar  { height:3px; background:var(--v-border); }
        .tutorial-progress-fill { height:3px; background:linear-gradient(90deg,var(--v-gold),var(--v-gold-light)); transition:width 0.5s cubic-bezier(0.16,1,0.3,1); }

        /* App sidebar */
        #appSidebar { background: var(--v-surface); border-left: 1px solid var(--v-border); }
        #appSidebar h3 { color: var(--v-text); }
        #portfolioList .port-val { color: var(--v-text); }

        /* Scrollbar */
        .sidebar-scroll { height: calc(100vh - 200px); overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--v-border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(201,168,76,0.3); }

        /* Animations */
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
        @keyframes flash-green { 0%{background:rgba(34,197,94,0.15)} 100%{background:transparent} }
        @keyframes flash-red   { 0%{background:rgba(239,68,68,0.15)} 100%{background:transparent} }
        @keyframes heroFade { from{opacity:0;transform:translateY(32px)} to{opacity:1;transform:translateY(0)} }
        .flash-up   { animation: flash-green 0.8s ease-out; }
        .flash-down { animation: flash-red   0.8s ease-out; }
        .stock-price, .change-pill { transition: color 0.3s; }
        .anim-1 { animation: heroFade 0.8s 0.1s both; }
        .anim-2 { animation: heroFade 0.8s 0.3s both; }
        .anim-3 { animation: heroFade 0.8s 0.5s both; }
        .anim-4 { animation: heroFade 0.8s 0.7s both; }
    </style>
</head>
<body class="overflow-x-hidden">

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     VESTRA HOMEPAGE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="homePage">

  <!-- NAV -->
  <nav class="home-nav">
    <div class="logo">Vestra</div>
    <div style="display:flex;gap:12px;align-items:center;">
      <button class="nav-btn nav-btn-ghost" onclick="showAuthFromHome('login')">Log In</button>
      <button class="nav-btn nav-btn-gold" onclick="showAuthFromHome('register')">Sign Up Free</button>
    </div>
  </nav>

  <!-- HERO -->
  <section style="min-height:100vh;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:120px 24px 80px;text-align:center;overflow:hidden;">
    <!-- Orbs -->
    <div class="orb" style="width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,0.12),transparent 70%);top:-100px;left:-100px;"></div>
    <div class="orb" style="width:500px;height:500px;background:radial-gradient(circle,rgba(34,197,94,0.07),transparent 70%);bottom:0;right:-80px;"></div>

    <div style="display:inline-flex;align-items:center;gap:8px;background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.25);padding:6px 16px;border-radius:100px;margin-bottom:32px;" class="anim-1">
      <div class="orb" style="position:relative;width:6px;height:6px;background:#22c55e;border-radius:50%;filter:none;animation:pulse-green 2s infinite;flex-shrink:0;"></div>
      <span style="font-size:0.78rem;color:var(--v-gold);font-weight:600;letter-spacing:0.05em;">500+ REAL STOCKS ¬∑ LIVE PRICES</span>
    </div>

    <h1 class="anim-2" style="font-family:var(--v-serif);font-size:clamp(3rem,8vw,6.5rem);line-height:1.05;max-width:900px;margin:0 0 24px;">
      Trade Like a Pro.<br><em style="color:var(--v-gold);">Risk Nothing.</em>
    </h1>

    <p class="anim-3" style="font-size:clamp(1rem,2vw,1.25rem);color:#b0b0c8;max-width:580px;line-height:1.7;margin:0 0 48px;">
      Vestra gives you $100,000 in virtual cash and real-time market data so you can master the art of trading ‚Äî before it ever costs you a cent.
    </p>

    <div class="anim-4" style="display:flex;gap:16px;flex-wrap:wrap;justify-content:center;">
      <button class="nav-btn nav-btn-gold" style="padding:16px 40px;font-size:1rem;border-radius:12px;" onclick="showAuthFromHome('register')">
        Start Trading Free ‚Üí
      </button>
      <button class="nav-btn nav-btn-ghost" style="padding:16px 32px;font-size:1rem;border-radius:12px;" onclick="scrollToSection('how')">
        See How It Works
      </button>
    </div>

    <!-- Mock chart preview -->
    <div class="anim-4" style="margin-top:80px;width:100%;max-width:900px;background:var(--v-card);border:1px solid var(--v-border);border-radius:20px;padding:24px;box-shadow:0 40px 120px rgba(0,0,0,0.5);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div>
          <span style="font-family:var(--v-serif);font-size:1.5rem;">AAPL</span>
          <span style="color:#b0b0c8;font-size:0.875rem;margin-left:8px;">Apple Inc.</span>
        </div>
        <div style="text-align:right;">
          <div style="font-family:var(--v-mono);font-size:1.5rem;color:var(--v-text);" id="heroPrice">$214.37</div>
          <div style="color:#4ade80;font-size:0.875rem;font-family:var(--v-mono);" id="heroChange">+1.24%</div>
        </div>
      </div>
      <canvas id="heroChart" style="width:100%;height:140px;display:block;"></canvas>
    </div>
  </section>

  <!-- TICKER TAPE -->
  <div class="ticker-wrap" style="padding:12px 0;">
    <div class="ticker" id="homeTicker">
      <span id="tickerInner"></span>
      <span id="tickerInner2"></span>
    </div>
  </div>

  <!-- STATS -->
  <section style="padding:100px 24px;background:var(--v-bg);">
    <div style="max-width:1100px;margin:0 auto;">
      <div class="gold-line" style="margin-bottom:80px;"></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:48px;text-align:center;">
        <div>
          <div class="stat-num">$100K</div>
          <div style="color:#b0b0c8;margin-top:8px;font-size:0.9rem;">Virtual Cash to Start</div>
        </div>
        <div>
          <div class="stat-num">500+</div>
          <div style="color:#b0b0c8;margin-top:8px;font-size:0.9rem;">Real Stocks & ETFs</div>
        </div>
        <div>
          <div class="stat-num">Live</div>
          <div style="color:#b0b0c8;margin-top:8px;font-size:0.9rem;">Real-Time Price Data</div>
        </div>
        <div>
          <div class="stat-num">Zero</div>
          <div style="color:#b0b0c8;margin-top:8px;font-size:0.9rem;">Financial Risk</div>
        </div>
      </div>
      <div class="gold-line" style="margin-top:80px;"></div>
    </div>
  </section>

  <!-- FEATURES -->
  <section style="padding:60px 24px 100px;">
    <div style="max-width:1100px;margin:0 auto;">
      <p style="text-align:center;color:var(--v-gold);font-size:0.8rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:16px;">Everything You Need</p>
      <h2 style="font-family:var(--v-serif);font-size:clamp(2rem,5vw,3.5rem);text-align:center;margin:0 0 72px;color:#ffffff;">Built for Serious Learning</h2>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:24px;">

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">üìà</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Real-Time Market Data</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Connect your Finnhub API key and watch prices update live every few seconds. Candlestick charts, day range, volume ‚Äî all real.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">üíº</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Full Portfolio Tracking</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Realized & unrealized P&L, cost basis, sector allocation charts, and full transaction history ‚Äî just like a real brokerage.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">‚ö°</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Multiple Order Types</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Market, limit, stop-loss, take-profit orders. Practice advanced strategies with pending orders that fill automatically when price hits your target.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">üèÜ</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Global Leaderboard</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Compete with traders worldwide. Rankings by total value, profit, and shares owned. See who's on top and push to beat them.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">üéØ</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Daily Quests & Streaks</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Daily trading challenges, achievement badges, and streak tracking keep you engaged and building real discipline.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:2rem;margin-bottom:16px;">üîê</div>
          <h3 style="font-family:var(--v-serif);font-size:1.4rem;margin:0 0 10px;">Your Account, Saved</h3>
          <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Create an account and your portfolio persists between sessions. Trade today, pick up where you left off tomorrow.</p>
        </div>

      </div>
    </div>
  </section>

  <!-- HOW IT WORKS -->
  <section id="how" style="padding:80px 24px 100px;background:#0e0e18;">
    <div style="max-width:800px;margin:0 auto;">
      <p style="text-align:center;color:var(--v-gold);font-size:0.8rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:16px;">Get Started in Minutes</p>
      <h2 style="font-family:var(--v-serif);font-size:clamp(2rem,5vw,3rem);text-align:center;margin:0 0 72px;color:#ffffff;">How Vestra Works</h2>

      <div style="display:flex;flex-direction:column;gap:40px;">
        <div style="display:flex;gap:24px;align-items:flex-start;">
          <div class="step-num">1</div>
          <div>
            <h3 style="font-family:var(--v-serif);font-size:1.3rem;margin:0 0 8px;color:#f0f0fa;">Create Your Free Account</h3>
            <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Sign up in seconds ‚Äî just a username and password. You're immediately given $100,000 in virtual cash and access to the full market.</p>
          </div>
        </div>
        <div class="gold-line"></div>
        <div style="display:flex;gap:24px;align-items:flex-start;">
          <div class="step-num">2</div>
          <div>
            <h3 style="font-family:var(--v-serif);font-size:1.3rem;margin:0 0 8px;color:#f0f0fa;">Connect Live Market Data</h3>
            <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Get a free API key from <a href="https://finnhub.io" target="_blank" style="color:var(--v-gold);">finnhub.io</a> and paste it in the Live Data settings. Prices start updating in real-time instantly.</p>
          </div>
        </div>
        <div class="gold-line"></div>
        <div style="display:flex;gap:24px;align-items:flex-start;">
          <div class="step-num">3</div>
          <div>
            <h3 style="font-family:var(--v-serif);font-size:1.3rem;margin:0 0 8px;color:#f0f0fa;">Browse, Research & Trade</h3>
            <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Search 500+ stocks, study candlestick charts, and place market or limit orders. Your portfolio updates live as prices move.</p>
          </div>
        </div>
        <div class="gold-line"></div>
        <div style="display:flex;gap:24px;align-items:flex-start;">
          <div class="step-num">4</div>
          <div>
            <h3 style="font-family:var(--v-serif);font-size:1.3rem;margin:0 0 8px;color:#f0f0fa;">Grow, Compete & Learn</h3>
            <p style="color:#b0b0c8;line-height:1.7;font-size:0.9rem;">Track your P&L, climb the global leaderboard, complete daily quests, and unlock achievements as you sharpen your strategy.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA BANNER -->
  <section style="padding:120px 24px;text-align:center;position:relative;overflow:hidden;">
    <div class="orb" style="width:700px;height:700px;background:radial-gradient(circle,rgba(201,168,76,0.09),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);"></div>
    <p style="color:var(--v-gold);font-size:0.8rem;font-weight:700;letter-spacing:0.12em;text-transform:uppercase;margin-bottom:16px;">No Credit Card. No Risk. Ever.</p>
    <h2 style="font-family:var(--v-serif);font-size:clamp(2rem,6vw,4rem);margin:0 0 24px;max-width:700px;margin-left:auto;margin-right:auto;color:#ffffff;">Ready to Start Your Trading Journey?</h2>
    <p style="color:#b0b0c8;max-width:480px;margin:0 auto 48px;line-height:1.7;">Join Vestra today and start practicing with real market conditions. The only thing you'll lose is your fear of the market.</p>
    <button class="nav-btn nav-btn-gold" style="padding:18px 52px;font-size:1.1rem;border-radius:14px;" onclick="showAuthFromHome('register')">
      Create Free Account ‚Üí
    </button>
  </section>

  <!-- FOOTER -->
  <footer style="padding:60px 48px 40px;background:var(--v-surface);">
    <div style="max-width:1100px;margin:0 auto;">
      <div style="display:grid;grid-template-columns:1fr auto;gap:48px;align-items:start;margin-bottom:48px;">

        <div>
          <div class="logo" style="font-size:2rem;margin-bottom:8px;">Vestra</div>
          <p style="color:#b0b0c8;font-size:0.85rem;line-height:1.7;max-width:340px;">Trading With No Risk. Practice with real market data, build your skills, and compete with traders worldwide ‚Äî all with virtual money.</p>
        </div>

        <div>
          <p style="color:#b0b0c8;font-size:0.75rem;text-transform:uppercase;letter-spacing:0.1em;font-weight:600;margin-bottom:20px;">Connect</p>
          <div style="display:flex;flex-direction:column;gap:4px;">

            <a href="https://www.instagram.com/badeatorneto/?hl=en" target="_blank" rel="noopener noreferrer" class="social-link">
              <div class="social-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="5" ry="5"/><circle cx="12" cy="12" r="4"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg>
              </div>
              <span>Instagram</span>
            </a>

            <a href="https://www.snapchat.com/@guywholikesfifa" target="_blank" rel="noopener noreferrer" class="social-link">
              <div class="social-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.5 2 6 4.5 6 8v.5c0 .5-.3.9-.7 1.1-.4.2-.3.7.1.8.6.2 1.1.4 1.4.9.1.2.1.4 0 .6-.3.5-1.1 1.3-1.1 2.2 0 1.1.9 1.9 2 1.9.3 0 .7-.1 1-.2.5-.2 1.1.1 1.3.6.5 1.1 1.8 1.6 3 1.6s2.5-.5 3-1.6c.2-.5.8-.8 1.3-.6.3.1.7.2 1 .2 1.1 0 2-.8 2-1.9 0-.9-.8-1.7-1.1-2.2-.1-.2-.1-.4 0-.6.3-.5.8-.7 1.4-.9.4-.1.5-.6.1-.8-.4-.2-.7-.6-.7-1.1V8c0-3.5-2.5-6-6-6z"/></svg>
              </div>
              <span>Snapchat</span>
            </a>

            <a href="mailto:arush2011jain@gmail.com" class="social-link">
              <div class="social-icon">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
              </div>
              <span>arush2011jain@gmail.com</span>
            </a>

          </div>
        </div>
      </div>

      <div class="gold-line" style="margin-bottom:28px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
        <p style="color:#b0b0c8;font-size:0.78rem;">¬© 2026 Vestra. All rights reserved. For educational purposes only ‚Äî not financial advice.</p>
        <button class="nav-btn nav-btn-ghost" style="font-size:0.8rem;padding:6px 16px;" onclick="showAuthFromHome('login')">Log In to Trade ‚Üí</button>
      </div>
    </div>
  </footer>

</div><!-- end #homePage -->

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP WRAPPER
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- ‚ïê‚ïê‚ïê LOGIN / REGISTER OVERLAY ‚ïê‚ïê‚ïê -->
<div id="authOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center" style="background:rgba(0,0,0,0.92);backdrop-filter:blur(16px);display:none;">
    <div style="background:var(--v-card);border:1px solid rgba(201,168,76,0.2);border-radius:20px;width:100%;max-width:440px;padding:40px;box-shadow:0 30px 100px rgba(0,0,0,0.6);position:relative;">
        <button onclick="document.getElementById('authOverlay').style.display='none'" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--v-muted);font-size:18px;cursor:pointer;line-height:1;" title="Close">‚úï</button>
        <div class="text-center" style="margin-bottom:28px;">
            <div style="font-family:var(--v-serif);font-size:2.5rem;color:var(--v-text);margin-bottom:6px;">Vestra</div>
            <div style="font-size:10px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:600;margin-bottom:20px;">Trading With No Risk</div>
            <h2 id="authTitle" style="font-size:1.3rem;font-weight:700;color:var(--v-text);margin:0 0 4px;">Sign In</h2>
            <p id="authSubtitle" style="color:var(--v-muted);font-size:0.875rem;margin:0;">to your trading account</p>
        </div>
        <div id="authError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div id="registerNameGroup" class="hidden" style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Display Name</label>
            <input id="authName" type="text" placeholder="e.g. TradingWolf99" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Username</label>
            <input id="authUser" type="text" placeholder="username" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Password</label>
            <input id="authPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <button id="authSubmitBtn" onclick="handleAuthSubmit()" style="width:100%;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);transition:background 0.2s;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Sign In</button>
        <p style="text-align:center;font-size:13px;color:var(--v-muted);margin-top:16px;">
            <span id="authToggleText">Don't have an account?</span>
            <button onclick="toggleAuthMode()" id="authToggleBtn" style="color:var(--v-gold);font-weight:600;margin-left:4px;background:none;border:none;cursor:pointer;font-size:13px;font-family:var(--v-sans);">Create account</button>
        </p>
    </div>
</div>

<div id="appPage">



<!-- ‚ïê‚ïê‚ïê LEADERBOARD OVERLAY ‚ïê‚ïê‚ïê -->
<div id="leaderboardOverlay" class="fixed inset-0 z-[9998] hidden" style="background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);" onclick="closeLeaderboard()">
    <div onclick="event.stopPropagation()" style="position:absolute;right:0;top:0;height:100%;width:100%;max-width:480px;background:#111118;border-left:1px solid rgba(255,255,255,0.08);overflow-y:auto;display:flex;flex-direction:column;">
        <div style="position:sticky;top:0;background:#111118;border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;z-index:10;">
            <div>
                <h2 style="font-size:1.1rem;font-weight:700;color:#f0f0fa;margin:0 0 2px;">üèÜ Global Leaderboard</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">All registered traders ranked</p>
            </div>
            <button onclick="closeLeaderboard()" style="background:none;border:none;color:#8888a8;font-size:24px;cursor:pointer;line-height:1;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
        </div>
        <div style="display:flex;border-bottom:1px solid rgba(255,255,255,0.08);padding:12px 24px 0;gap:4px;">
            <button onclick="setLeaderSort('total')" id="sort-total" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:rgba(212,168,75,0.15);color:var(--v-gold);border-bottom:2px solid var(--v-gold);">üí∞ Total Value</button>
            <button onclick="setLeaderSort('profit')" id="sort-profit" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:transparent;color:#8888a8;border-bottom:2px solid transparent;">üìà Profit</button>
            <button onclick="setLeaderSort('stocks')" id="sort-stocks" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:transparent;color:#8888a8;border-bottom:2px solid transparent;">üì¶ Shares</button>
        </div>
        <div id="leaderboardList" style="flex:1;padding:20px 24px;">
            <div style="text-align:center;color:#8888a8;padding:40px 0;">Loading traders...</div>
        </div>
        <div style="border-top:1px solid rgba(255,255,255,0.08);padding:12px 24px;background:#0e0e16;font-size:11px;color:#606080;text-align:center;">Updates live after every trade</div>
    </div>
</div>

<header class="app-header">
    <div class="max-w-[1600px] mx-auto px-6 h-16 flex items-center justify-between gap-8">
        <div class="flex items-center gap-3 min-w-[160px]">
            <div>
                <div class="vestra-brand text-2xl font-bold leading-none" style="color:var(--v-text)">Vestra</div>
                <div style="font-size:9px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:600;">Trading With No Risk</div>
            </div>
        </div>
        <div class="flex-1 max-w-2xl">
            <div class="search-bar flex items-center px-4 h-11">
                <svg class="w-4 h-4 mr-3" style="color:var(--v-muted)" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" id="search" oninput="renderGrid()" placeholder="Search stocks, ETFs & more" class="bg-transparent border-none outline-none w-full text-sm">
            </div>
        </div>
        <div class="flex items-center gap-3">
            <div class="flex items-center gap-2">
                <div id="marketStatusDot" class="w-2 h-2 rounded-full bg-gray-400"></div>
                <span id="marketStatusText" class="text-xs font-medium" style="color:var(--v-muted)">Market Closed</span>
                <button onclick="openApiConfig()" id="liveDataBtn" style="font-size:11px;background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.3);color:var(--v-gold);padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;">‚ö° Live Data</button>
            </div>
            <button onclick="openLeaderboard()" style="background:rgba(201,168,76,0.1);border:1px solid rgba(201,168,76,0.25);color:var(--v-gold);padding:6px 14px;border-radius:8px;font-size:13px;font-weight:700;cursor:pointer;">üèÜ Leaderboard</button>
            <button onclick="exportPortfolioData()" class="btn-outline" style="padding:6px 12px;font-size:12px;">Export</button>
            <button onclick="document.getElementById('importFile').click()" class="btn-outline" style="padding:6px 12px;font-size:12px;">Import</button>
            <button onclick="startTutorial(true)" class="btn-outline" style="padding:6px 12px;font-size:12px;">Tutorial</button>
            <input id="importFile" type="file" accept="application/json" class="hidden" onchange="importPortfolioData(event)">
            <div id="syncBadge" style="font-size:11px;padding:4px 8px;border-radius:6px;background:var(--v-card);color:var(--v-muted);border:1px solid var(--v-border);">Sync: Local</div>
            <div style="display:flex;align-items:center;gap:10px;border-left:1px solid var(--v-border);padding-left:14px;">
                <div id="userAvatar" style="width:32px;height:32px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:13px;font-weight:700;">?</div>
                <div class="hidden md:block">
                    <div id="userDisplayName" style="font-size:13px;font-weight:600;color:var(--v-text);">‚Äî</div>
                    <button onclick="logOut()" style="font-size:11px;color:var(--v-muted);background:none;border:none;cursor:pointer;padding:0;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--v-muted)'">Sign out</button>
                </div>
            </div>
        </div>
    </div>
</header>

<!-- News banner (added for volatility headlines) -->
<div id="newsBanner" class="fixed top-16 left-0 right-0 z-40 hidden px-6 py-3 text-center font-medium text-white shadow-lg transition-all duration-400">
    <span id="newsHeadline"></span>
</div>
<main class="max-w-[1600px] mx-auto p-6 grid grid-cols-1 lg:grid-cols-4 gap-8" style="min-height:calc(100vh - 64px);">
    
    <div class="lg:col-span-3">
        <div class="flex justify-between items-end mb-6">
            <div>
                <div style="font-size:11px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.1em;margin-bottom:4px;">Market Trends</div>
                <h2 style="font-size:1.5rem;font-weight:300;color:#f0f0fa;">Most active</h2>
            </div>

        <div id="grid" class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-5 gap-4">
            </div>
    </div>

    <aside class="space-y-8">
        
        <div class="g-card p-6">
            <div class="flex justify-between items-center mb-6">
                <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;">Your Portfolio</h3>
                <span id="dataSourceBadge" style="font-size:11px;font-weight:700;color:#8888a8;background:rgba(255,255,255,0.06);padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);">SIM</span>
            </div>
            <div class="mb-6">
                <div style="font-size:12px;color:#8888a8;margin-bottom:4px;text-transform:uppercase;letter-spacing:0.05em;">Total Equity</div>
                <div style="font-size:1.9rem;font-weight:300;color:#f5f5fa;font-family:var(--v-mono);">$<span id="netWorth">100,000.00</span></div>
                <div id="plDisplay" style="font-size:0.875rem;font-weight:600;color:#4ade80;margin-top:4px;">+$0.00 (0.00%)</div>
            </div>
            <div id="portfolioList" class="space-y-0 mb-6 max-h-60 overflow-y-auto" style="border-top:1px solid rgba(255,255,255,0.06);">
                <div style="font-size:13px;color:#8888a8;padding:16px 0;text-align:center;font-style:italic;">Your portfolio is empty.</div>
            </div>
        </div>

        <div class="g-card p-6">
            <div class="flex justify-between items-center mb-3">
                <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;">Portfolio Analytics</h3>
                <span style="font-size:11px;color:#4ade80;font-weight:600;">Live</span>
            </div>
            <div class="h-44 mb-3"><canvas id="allocationChart"></canvas></div>
            <div id="sectorExposure" class="space-y-1 mb-3" style="font-size:12px;color:#b0b0c8;"></div>
            <div style="font-size:12px;color:#a0a0b8;margin-bottom:2px;">Realized P/L: <span id="realizedPL" style="font-weight:700;">$0.00</span></div>
            <div style="font-size:12px;color:#a0a0b8;">Unrealized P/L: <span id="unrealizedPL" style="font-weight:700;">$0.00</span></div>
        </div>

        <div class="g-card p-6">
            <div class="flex justify-between items-center mb-3">
                <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;">Watchlist & Alerts</h3>
                <button onclick="addCurrentToWatchlist()" style="font-size:12px;font-weight:600;color:var(--v-gold);background:none;border:none;cursor:pointer;">+ Current</button>
            </div>
            <div id="watchlistItems" class="space-y-2 mb-3" style="font-size:13px;color:#c0c0d8;"></div>
            <div class="grid grid-cols-3 gap-2 mb-2">
                <input id="alertSymbol" placeholder="SYM" style="background:#0f0f18;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px;font-size:12px;color:#e0e0f5;outline:none;">
                <select id="alertType" style="background:#0f0f18;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px;font-size:12px;color:#e0e0f5;outline:none;">
                    <option value="above">Above</option>
                    <option value="below">Below</option>
                    <option value="move">% Move</option>
                </select>
                <input id="alertValue" placeholder="Value" type="number" step="0.01" style="background:#0f0f18;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:6px 8px;font-size:12px;color:#e0e0f5;outline:none;">
            </div>
            <button onclick="createPriceAlert()" style="width:100%;background:rgba(212,168,75,0.1);color:var(--v-gold);border:1px solid rgba(212,168,75,0.25);border-radius:8px;padding:8px;font-size:12px;font-weight:700;cursor:pointer;" onmouseover="this.style.background='rgba(212,168,75,0.18)'" onmouseout="this.style.background='rgba(212,168,75,0.1)'">Create Alert</button>
            <div id="alertsList" class="mt-3 space-y-1" style="font-size:12px;color:#a0a0b8;"></div>
            <div id="alertFeed" class="mt-3 space-y-1" style="font-size:12px;"></div>
        </div>

        <div class="g-card p-6">
            <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;margin-bottom:12px;">Daily Quests & Achievements</h3>
            <div id="questList" class="space-y-1 mb-3" style="font-size:13px;color:#c0c0d8;"></div>
            <div style="font-size:12px;color:#8888a8;margin-bottom:8px;">Streak: <span id="tradeStreak" style="font-weight:700;color:#d4a84b;">0 days</span></div>
            <div id="achievementList" class="flex flex-wrap gap-2"></div>
        </div>

        <div class="g-card p-6">
            <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;margin-bottom:12px;">Transaction History</h3>
            <div id="historyList" class="space-y-2 max-h-44 overflow-y-auto" style="font-size:12px;color:#c0c0d8;"></div>
        </div>

        <div>
            <div class="flex justify-between items-center mb-4">
                <h3 style="font-size:1rem;font-weight:600;color:#e0e0f5;">Market News</h3>
                <a href="https://finance.yahoo.com/news/" target="_blank" rel="noopener noreferrer" style="font-size:13px;color:var(--v-gold);font-weight:600;text-decoration:none;" onmouseover="this.style.textDecoration='underline'" onmouseout="this.style.textDecoration='none'">More news ‚Üó</a>
            </div>
            <div id="newsFeed" class="space-y-3"></div>
        </div>

    </aside>
</main>

<div id="stockDetailPage" class="fixed inset-0 bg-[#1c1c1e] hidden z-50 overflow-y-auto">
    <div class="bg-[#1c1c1e] border-b border-gray-700 px-6 py-4 flex items-center gap-4 sticky top-0 z-10">
        <button onclick="closeStockDetail()" class="text-gray-400 hover:text-white flex items-center gap-2 text-sm font-medium transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Market
        </button>
        <span class="text-gray-600">|</span>
        <span id="detailHeaderSymbol" class="text-white font-medium"></span>
    </div>
    <div class="max-w-4xl mx-auto px-6 py-8">
        <div class="mb-6">
            <div class="text-gray-400 text-sm mb-1" id="detailName"></div>
            <div class="flex items-baseline gap-3 mb-2 flex-wrap">
                <span id="detailPrice" class="text-white font-light" style="font-size:3.5rem;line-height:1;"></span>
                <span class="text-gray-400 text-xl">USD</span>
                <button id="followBtn" onclick="toggleFollowCurrent()" class="ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium">+ Follow</button>
            </div>
            <div class="flex items-center gap-2 mb-1">
                <span id="detailChangeAmt" class="text-xl font-medium"></span>
                <span id="detailChangePct" class="text-xl font-medium"></span>
                <span id="detailArrow" class="text-xl"></span>
                <span class="text-gray-400 text-sm">today</span>
            </div>
            <div class="text-gray-500 text-xs">Closed: Feb 17, 4:05 am GMT-5</div>
            <div id="detailPremarket" class="text-[#8ab4f8] text-sm mt-1"></div>
        </div>
        <div class="flex border-b border-gray-700 mb-0">
            <button onclick="setChartPeriod('1D',this)" class="ctab active-tab text-sm font-medium px-4 py-3 border-b-2 border-[#8ab4f8] text-[#8ab4f8]">1D</button>
            <button onclick="setChartPeriod('5D',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">5D</button>
            <button onclick="setChartPeriod('1M',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">1M</button>
            <button onclick="setChartPeriod('6M',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">6M</button>
            <button onclick="setChartPeriod('YTD',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">YTD</button>
            <button onclick="setChartPeriod('1Y',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">1Y</button>
            <button onclick="setChartPeriod('5Y',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">5Y</button>
            <button onclick="setChartPeriod('Max',this)" class="ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200">Max</button>
        </div>
        <div class="relative bg-[#1c1c1e] mb-6" style="height:280px;">
            <canvas id="stockChart"></canvas>
            <div class="absolute right-2 top-4 text-xs text-gray-400 text-right leading-tight">
                <div>Previous</div><div>close</div><div id="prevCloseVal" class="text-gray-300 font-medium"></div>
            </div>
        </div>
        <div class="grid grid-cols-3 border-t border-gray-700 text-sm mb-8">
            <div class="py-4 pr-4"><div class="text-gray-400 mb-1">Open</div><div class="text-white font-medium" id="sOpen">‚Äî</div></div>
            <div class="py-4 px-4"><div class="text-gray-400 mb-1">Mkt cap</div><div class="text-white font-medium" id="sMktCap">‚Äî</div></div>
            <div class="py-4 pl-4"><div class="text-gray-400 mb-1">Dividend</div><div class="text-white font-medium" id="sDividend">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">High</div><div class="text-white font-medium" id="sHigh">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">P/E ratio</div><div class="text-white font-medium" id="sPE">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">Qtrly Div Amt</div><div class="text-white font-medium" id="sDivAmt">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">Low</div><div class="text-white font-medium" id="sLow">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">52-wk high</div><div class="text-white font-medium" id="s52H">‚Äî</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">52-wk low</div><div class="text-white font-medium" id="s52L">‚Äî</div></div>
        </div>
        <div class="bg-[#2c2c2e] rounded-2xl p-6 border border-gray-700">
            <h3 class="text-white text-lg font-medium mb-4">Trade <span id="tradeSymLabel" class="text-gray-400"></span></h3>
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Buying Power</div><div class="text-white font-semibold text-lg" id="dBuyPow">$100,000</div></div>
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Shares Owned</div><div class="text-white font-semibold text-lg" id="dShares">0</div></div>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <select id="orderType" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm">
                    <option value="market">Market</option>
                    <option value="limit">Limit</option>
                    <option value="stop-loss">Stop-loss</option>
                    <option value="take-profit">Take-profit</option>
                </select>
                <input id="orderQty" type="number" min="1" value="1" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Qty">
                <input id="orderTrigger" type="number" step="0.01" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Trigger">
            </div>
            <div class="flex gap-3">
                <button onclick="execDetailTrade('BUY')" class="flex-1 bg-[#34c759] hover:bg-[#2db34e] text-white font-semibold py-3 rounded-xl text-base transition">Buy / Place</button>
                <button onclick="execDetailTrade('SELL')" class="flex-1 bg-[#ff453a] hover:bg-[#e03d33] text-white font-semibold py-3 rounded-xl text-base transition">Sell / Place</button>
            </div>
            <div id="pendingOrdersList" class="mt-3 text-xs text-gray-300 space-y-1"></div>
            <div id="detailNews" class="mt-4 space-y-2"></div>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê IMMERSIVE TUTORIAL OVERLAY ‚ïê‚ïê‚ïê -->
<div id="tutorialOverlay" class="hidden">
    <div class="tutorial-card">
        <!-- Progress bar -->
        <div class="tutorial-progress-bar">
            <div class="tutorial-progress-fill" id="tutorialProgressFill" style="width:0%"></div>
        </div>
        <!-- Step indicator -->
        <div class="flex items-center justify-between px-8 pt-6 pb-0">
            <div class="flex gap-2" id="tutorialDots"></div>
            <button onclick="skipTutorial()" class="text-xs text-gray-500 hover:text-gray-300 transition font-medium">Skip tutorial</button>
        </div>
        <!-- Content -->
        <div class="px-8 py-6">
            <div id="tutorialIcon" class="text-5xl mb-4 text-center"></div>
            <h2 id="tutorialTitle" class="text-white text-2xl font-bold mb-3 text-center"></h2>
            <p id="tutorialDesc" class="text-gray-400 text-sm leading-relaxed text-center mb-6"></p>
            <!-- Highlight hint box -->
            <div id="tutorialHint" class="hidden rounded-xl px-4 py-3 mb-6 text-sm text-center font-medium" style="background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);color:#c4b5fd;"></div>
        </div>
        <!-- Actions -->
        <div class="px-8 pb-8 flex gap-3">
            <button id="tutorialPrevBtn" onclick="tutorialPrev()" class="hidden flex-1 border border-gray-600 text-gray-300 hover:border-gray-400 font-semibold py-3 rounded-xl text-sm transition">‚Üê Back</button>
            <button id="tutorialNextBtn" onclick="tutorialNext()" class="flex-1 font-bold py-3 rounded-xl text-sm transition text-white" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">Continue ‚Üí</button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê API CONFIG MODAL ‚ïê‚ïê‚ïê -->
<div id="apiConfigModal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);">
    <div style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,0.7);width:100%;max-width:520px;padding:36px;">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;">
            <div>
                <h2 style="font-size:1.25rem;font-weight:700;color:#f0f0fa;margin:0 0 4px;">‚ö° Real-Time Market Data</h2>
                <p style="font-size:0.85rem;color:#8888a8;margin:0;">Connect your Finnhub API key for live prices</p>
            </div>
            <button onclick="closeApiConfig()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;line-height:1;padding:0;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
        </div>
        <div style="background:rgba(99,179,237,0.08);border:1px solid rgba(99,179,237,0.2);border-radius:12px;padding:14px;margin-bottom:12px;font-size:0.875rem;color:#90cdf4;">
            <strong style="color:#bee3f8;">Free Finnhub API</strong> ‚Äî Get your key at
            <a href="https://finnhub.io/register" target="_blank" style="color:#63b3ed;font-weight:600;text-decoration:underline;">finnhub.io/register</a>
            &nbsp;(60 calls/min, no credit card needed)
        </div>
        <div style="background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);border-radius:12px;padding:14px;margin-bottom:20px;font-size:0.875rem;color:#d4a84b;">
            ‚¨áÔ∏è <strong>Important:</strong> Download this file and open it locally in your browser. Network calls are blocked in the Claude preview.
        </div>
        <div id="apiConfigError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Finnhub API Key</label>
            <input id="finnhubKeyInput" type="text" placeholder="e.g. d0abc123..." style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;font-family:var(--v-mono);outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'">
            <p style="font-size:11px;color:#606080;margin-top:6px;">Stored locally in your browser ‚Äî never sent to any server.</p>
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Update Interval</label>
            <select id="updateIntervalInput" style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;outline:none;">
                <option value="10000">Every 10 seconds (recommended)</option>
                <option value="15000">Every 15 seconds</option>
                <option value="30000">Every 30 seconds</option>
                <option value="60000">Every 60 seconds</option>
            </select>
        </div>
        <div style="display:flex;gap:12px;">
            <button onclick="saveApiConfig()" style="flex:1;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Save & Activate</button>
            <button onclick="clearApiConfig()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.background='rgba(239,68,68,0.18)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">Clear</button>
        </div>
        <div id="apiTestResult" style="margin-top:12px;font-size:13px;text-align:center;color:#8888a8;display:none;"></div>
    </div>
</div>

</div><!-- end #appPage -->

<script>
    // --- Data Setup ---
    // Full 500 Ticker List (Simulated)
    // Real stock data as of Feb 17, 2026
    // ‚îÄ‚îÄ Real prices as of Feb 17 2026 (Robinhood / Google Finance) ‚îÄ‚îÄ
    const realStockData = {
        'AAPL':  { name: 'Apple Inc.',               price: 254.86,  change: -2.27,  pe: 32.36,  mktCap: '3.76T', div: '0.41%', divAmt: '0.26', wkHigh: 288.62,  wkLow: 169.21 },
        'MSFT':  { name: 'Microsoft Corp.',           price: 400.00,  change: -0.29,  pe: 25.11,  mktCap: '2.98T', div: '0.84%', divAmt: '0.91', wkHigh: 555.45,  wkLow: 344.79 },
        'NVDA':  { name: 'NVIDIA Corp.',              price: 181.51,  change: -2.22,  pe: 49.60,  mktCap: '4.42T', div: '0.04%', divAmt: '0.01', wkHigh: 212.19,  wkLow: 86.62  },
        'GOOGL': { name: 'Alphabet Inc. Class A',     price: 305.72,  change: -1.06,  pe: 22.45,  mktCap: '3.69T', div: '0.00%', divAmt: '0.00', wkHigh: 349.00,  wkLow: 140.53 },
        'AMZN':  { name: 'Amazon.com Inc.',           price: 198.95,  change: -0.42,  pe: 41.50,  mktCap: '2.12T', div: '0.00%', divAmt: '0.00', wkHigh: 258.60,  wkLow: 161.38 },
        'META':  { name: 'Meta Platforms Inc.',       price: 638.64,  change: -1.55,  pe: 29.80,  mktCap: '1.61T', div: '0.00%', divAmt: '0.00', wkHigh: 796.25,  wkLow: 479.80 },
        'TSLA':  { name: 'Tesla Inc.',                price: 417.44,  change: -0.09,  pe: 388.17, mktCap: '1.57T', div: '0.00%', divAmt: '0.00', wkHigh: 498.83,  wkLow: 214.25 },
        'BRK.B': { name: 'Berkshire Hathaway B',      price: 488.15,  change: 0.42,   pe: 22.10,  mktCap: '1.07T', div: '0.00%', divAmt: '0.00', wkHigh: 497.20,  wkLow: 370.55 },
        'JPM':   { name: 'JPMorgan Chase & Co.',      price: 302.68,  change: 0.54,   pe: 14.20,  mktCap: '851B',  div: '2.38%', divAmt: '1.40', wkHigh: 337.25,  wkLow: 202.16 },
        'AVGO':  { name: 'Broadcom Inc.',             price: 324.96,  change: -1.82,  pe: 68.24,  mktCap: '1.54T', div: '1.24%', divAmt: '0.65', wkHigh: 414.61,  wkLow: 138.10 },
        'XOM':   { name: 'Exxon Mobil Corp.',         price: 148.70,  change: -1.90,  pe: 14.50,  mktCap: '632B',  div: '3.40%', divAmt: '0.99', wkHigh: 156.93,  wkLow: 97.80  },
        'WMT':   { name: 'Walmart Inc.',              price: 134.05,  change: 0.60,   pe: 38.90,  mktCap: '1.08T', div: '0.88%', divAmt: '0.24', wkHigh: 134.65,  wkLow: 79.81  },
        'COST':  { name: 'Costco Wholesale Corp.',    price: 1016.20, change: 1.40,   pe: 54.80,  mktCap: '441B',  div: '0.55%', divAmt: '1.16', wkHigh: 1077.49, wkLow: 844.06 },
        'V':     { name: 'Visa Inc.',                 price: 314.17,  change: -3.14,  pe: 29.76,  mktCap: '598B',  div: '0.91%', divAmt: '0.59', wkHigh: 375.51,  wkLow: 299.00 },
        'MA':    { name: 'Mastercard Inc.',           price: 571.44,  change: -0.18,  pe: 38.50,  mktCap: '527B',  div: '0.59%', divAmt: '0.76', wkHigh: 581.30,  wkLow: 440.34 },
        'LLY':   { name: 'Eli Lilly and Co.',         price: 858.60,  change: -1.20,  pe: 62.30,  mktCap: '817B',  div: '0.67%', divAmt: '1.50', wkHigh: 972.53,  wkLow: 704.17 },
        'UNH':   { name: 'UnitedHealth Group Inc.',   price: 538.22,  change: -0.44,  pe: 19.80,  mktCap: '496B',  div: '1.57%', divAmt: '2.21', wkHigh: 629.73,  wkLow: 462.86 },
        'PG':    { name: 'Procter & Gamble Co.',      price: 165.45,  change: 0.33,   pe: 25.70,  mktCap: '388B',  div: '2.43%', divAmt: '1.06', wkHigh: 177.98,  wkLow: 151.42 },
        'HD':    { name: 'Home Depot Inc.',           price: 396.56,  change: -0.55,  pe: 26.40,  mktCap: '393B',  div: '2.40%', divAmt: '2.25', wkHigh: 439.37,  wkLow: 316.90 },
        'JNJ':   { name: 'Johnson & Johnson',         price: 158.32,  change: 0.18,   pe: 22.50,  mktCap: '384B',  div: '3.07%', divAmt: '1.24', wkHigh: 168.93,  wkLow: 140.67 },
        'ORCL':  { name: 'Oracle Corp.',              price: 157.20,  change: -1.80,  pe: 29.40,  mktCap: '435B',  div: '1.02%', divAmt: '0.40', wkHigh: 345.72,  wkLow: 118.86 },
        'MRK':   { name: 'Merck & Co. Inc.',          price: 89.44,   change: -0.65,  pe: 12.10,  mktCap: '225B',  div: '3.71%', divAmt: '0.81', wkHigh: 134.63,  wkLow: 84.46  },
        'ABT':   { name: 'Abbott Laboratories',       price: 129.83,  change: 0.22,   pe: 23.10,  mktCap: '226B',  div: '1.87%', divAmt: '0.59', wkHigh: 136.15,  wkLow: 97.11  },
        'ABBV':  { name: 'AbbVie Inc.',               price: 196.24,  change: 0.41,   pe: 55.20,  mktCap: '345B',  div: '3.16%', divAmt: '1.64', wkHigh: 214.82,  wkLow: 147.35 },
        'CVX':   { name: 'Chevron Corp.',             price: 161.88,  change: -0.72,  pe: 14.90,  mktCap: '302B',  div: '4.25%', divAmt: '1.71', wkHigh: 171.69,  wkLow: 135.37 },
        'NFLX':  { name: 'Netflix Inc.',              price: 76.97,   change: 1.33,   pe: 50.40,  mktCap: '33B',   div: '0.00%', divAmt: '0.00', wkHigh: 134.12,  wkLow: 75.23  },
        'AMD':   { name: 'Advanced Micro Devices',    price: 206.82,  change: -0.69,  pe: 94.20,  mktCap: '334B',  div: '0.00%', divAmt: '0.00', wkHigh: 267.08,  wkLow: 76.48  },
        'ADBE':  { name: 'Adobe Inc.',                price: 263.93,  change: -0.50,  pe: 23.40,  mktCap: '114B',  div: '0.00%', divAmt: '0.00', wkHigh: 464.99,  wkLow: 251.10 },
        'CRM':   { name: 'Salesforce Inc.',           price: 188.40,  change: -0.50,  pe: 30.10,  mktCap: '181B',  div: '0.00%', divAmt: '0.00', wkHigh: 329.74,  wkLow: 180.24 },
        'INTC':  { name: 'Intel Corp.',               price: 46.62,   change: 0.65,   pe: 0,      mktCap: '199B',  div: '0.86%', divAmt: '0.13', wkHigh: 54.60,   wkLow: 17.67  },
        'CSCO':  { name: 'Cisco Systems Inc.',        price: 62.47,   change: 0.28,   pe: 17.20,  mktCap: '251B',  div: '2.91%', divAmt: '0.41', wkHigh: 64.72,   wkLow: 44.51  },
        'PFE':   { name: 'Pfizer Inc.',               price: 26.18,   change: -0.38,  pe: 9.60,   mktCap: '148B',  div: '6.57%', divAmt: '0.43', wkHigh: 32.44,   wkLow: 22.91  },
        'TMO':   { name: 'Thermo Fisher Scientific',  price: 547.12,  change: -0.90,  pe: 25.70,  mktCap: '213B',  div: '0.29%', divAmt: '0.39', wkHigh: 621.65,  wkLow: 478.35 },
        'DIS':   { name: 'Walt Disney Co.',           price: 111.60,  change: 1.10,   pe: 38.40,  mktCap: '202B',  div: '0.86%', divAmt: '0.50', wkHigh: 123.74,  wkLow: 83.91  },
        'KO':    { name: 'Coca-Cola Co.',             price: 71.08,   change: 0.52,   pe: 25.10,  mktCap: '306B',  div: '2.89%', divAmt: '0.51', wkHigh: 73.53,   wkLow: 56.57  },
        'PEP':   { name: 'PepsiCo Inc.',              price: 150.47,  change: -0.18,  pe: 21.40,  mktCap: '207B',  div: '3.65%', divAmt: '1.42', wkHigh: 183.41,  wkLow: 142.76 },
        'BAC':   { name: 'Bank of America Corp.',     price: 46.72,   change: 0.85,   pe: 14.10,  mktCap: '358B',  div: '2.49%', divAmt: '0.26', wkHigh: 48.08,   wkLow: 32.36  },
        'WFC':   { name: 'Wells Fargo & Co.',         price: 76.34,   change: 0.92,   pe: 13.20,  mktCap: '256B',  div: '2.36%', divAmt: '0.40', wkHigh: 81.49,   wkLow: 49.60  },
        'GS':    { name: 'Goldman Sachs Group',       price: 904.50,  change: 1.50,   pe: 17.64,  mktCap: '271B',  div: '1.50%', divAmt: '3.50', wkHigh: 984.70,  wkLow: 439.38 },
        'MS':    { name: 'Morgan Stanley',            price: 130.47,  change: 0.60,   pe: 20.80,  mktCap: '214B',  div: '3.07%', divAmt: '0.925',wkHigh: 137.00,  wkLow: 90.98  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'QCOM':  { name: 'Qualcomm Inc.',             price: 162.40,  change: -1.30,  pe: 14.30,  mktCap: '172B',  div: '2.11%', divAmt: '0.89', wkHigh: 230.63,  wkLow: 143.27 },
        'TXN':   { name: 'Texas Instruments Inc.',    price: 179.55,  change: -0.70,  pe: 28.40,  mktCap: '162B',  div: '2.95%', divAmt: '1.36', wkHigh: 220.39,  wkLow: 152.64 },
        'AMGN':  { name: 'Amgen Inc.',                price: 262.10,  change: 0.30,   pe: 17.80,  mktCap: '140B',  div: '3.51%', divAmt: '2.38', wkHigh: 329.65,  wkLow: 236.87 },
        'HON':   { name: 'Honeywell Intl. Inc.',      price: 219.66,  change: -0.42,  pe: 22.50,  mktCap: '137B',  div: '2.19%', divAmt: '1.13', wkHigh: 235.36,  wkLow: 185.33 },
        'NKE':   { name: 'Nike Inc.',                 price: 74.29,   change: -0.68,  pe: 22.10,  mktCap: '111B',  div: '2.15%', divAmt: '0.40', wkHigh: 97.67,   wkLow: 70.41  },
        'CAT':   { name: 'Caterpillar Inc.',          price: 386.30,  change: 0.55,   pe: 19.30,  mktCap: '186B',  div: '1.58%', divAmt: '1.41', wkHigh: 418.49,  wkLow: 302.40 },
        'MCD':   { name: "McDonald's Corp.",          price: 301.67,  change: 0.33,   pe: 24.50,  mktCap: '217B',  div: '2.49%', divAmt: '1.77', wkHigh: 317.90,  wkLow: 243.97 },
        'SBUX':  { name: 'Starbucks Corp.',           price: 101.29,  change: 1.50,   pe: 32.60,  mktCap: '113B',  div: '2.95%', divAmt: '0.61', wkHigh: 115.07,  wkLow: 72.91  },
        'BA':    { name: 'Boeing Co.',                price: 183.24,  change: -1.80,  pe: 0,      mktCap: '139B',  div: '0.00%', divAmt: '0.00', wkHigh: 211.03,  wkLow: 136.32 },
        'PLTR':  { name: 'Palantir Technologies',     price: 131.72,  change: -5.20,  pe: 208.59, mktCap: '313B',  div: '0.00%', divAmt: '0.00', wkHigh: 207.52,  wkLow: 66.12  },
        'PANW':  { name: 'Palo Alto Networks',        price: 192.48,  change: 0.70,   pe: 52.40,  mktCap: '120B',  div: '0.00%', divAmt: '0.00', wkHigh: 210.20,  wkLow: 152.29 },
        'NOW':   { name: 'ServiceNow Inc.',           price: 1024.35, change: -2.40,  pe: 121.30, mktCap: '207B',  div: '0.00%', divAmt: '0.00', wkHigh: 1198.09, wkLow: 738.00 },
        'ISRG':  { name: 'Intuitive Surgical Inc.',   price: 579.88,  change: -1.10,  pe: 84.60,  mktCap: '205B',  div: '0.00%', divAmt: '0.00', wkHigh: 599.09,  wkLow: 363.75 },
        'AXP':   { name: 'American Express Co.',      price: 301.44,  change: 0.40,   pe: 21.50,  mktCap: '208B',  div: '1.01%', divAmt: '0.82', wkHigh: 325.87,  wkLow: 213.08 },
        'SPGI':  { name: 'S&P Global Inc.',           price: 497.32,  change: 0.22,   pe: 34.20,  mktCap: '157B',  div: '0.81%', divAmt: '0.94', wkHigh: 574.18,  wkLow: 421.72 },
        'BLK':   { name: 'BlackRock Inc.',            price: 1068.00, change: 0.55,   pe: 24.60,  mktCap: '158B',  div: '2.17%', divAmt: '5.21', wkHigh: 1088.11, wkLow: 755.12 },
        'RTX':   { name: 'RTX Corp.',                 price: 130.80,  change: 0.33,   pe: 37.50,  mktCap: '175B',  div: '2.04%', divAmt: '0.63', wkHigh: 138.52,  wkLow: 100.18 },
        'LMT':   { name: 'Lockheed Martin Corp.',     price: 487.26,  change: 0.48,   pe: 17.80,  mktCap: '119B',  div: '2.94%', divAmt: '3.30', wkHigh: 606.99,  wkLow: 414.10 },
        'VZ':    { name: 'Verizon Communications',    price: 40.23,   change: -0.25,  pe: 9.40,   mktCap: '169B',  div: '6.56%', divAmt: '0.67', wkHigh: 44.73,   wkLow: 38.16  },
        'T':     { name: 'AT&T Inc.',                 price: 26.94,   change: 0.15,   pe: 11.80,  mktCap: '193B',  div: '4.82%', divAmt: '0.28', wkHigh: 27.91,   wkLow: 16.11  },
        'NEE':   { name: 'NextEra Energy Inc.',       price: 73.14,   change: 0.55,   pe: 22.30,  mktCap: '149B',  div: '2.87%', divAmt: '0.54', wkHigh: 84.40,   wkLow: 57.88  },
        'DHR':   { name: 'Danaher Corp.',             price: 225.60,  change: -0.82,  pe: 36.40,  mktCap: '163B',  div: '0.49%', divAmt: '0.27', wkHigh: 265.57,  wkLow: 209.72 },
        'UNP':   { name: 'Union Pacific Corp.',       price: 251.90,  change: 0.18,   pe: 21.60,  mktCap: '151B',  div: '2.30%', divAmt: '1.34', wkHigh: 269.80,  wkLow: 214.37 },
        'PM':    { name: 'Philip Morris Intl.',       price: 135.88,  change: 0.62,   pe: 22.10,  mktCap: '212B',  div: '3.72%', divAmt: '1.35', wkHigh: 137.60,  wkLow: 91.20  },
        'COP':   { name: 'ConocoPhillips',            price: 107.18,  change: -0.55,  pe: 12.40,  mktCap: '138B',  div: '2.41%', divAmt: '0.78', wkHigh: 134.80,  wkLow: 95.61  },
        'MU':    { name: 'Micron Technology Inc.',    price: 94.76,   change: -2.30,  pe: 17.20,  mktCap: '105B',  div: '0.42%', divAmt: '0.115',wkHigh: 163.94,  wkLow: 78.20  },
        'AMAT':  { name: 'Applied Materials Inc.',    price: 171.22,  change: -2.80,  pe: 22.60,  mktCap: '142B',  div: '0.93%', divAmt: '0.40', wkHigh: 261.93,  wkLow: 148.10 },
        'LRCX':  { name: 'Lam Research Corp.',        price: 720.45,  change: -3.10,  pe: 22.80,  mktCap: '94B',   div: '1.09%', divAmt: '2.30', wkHigh: 1134.34, wkLow: 648.82 },
        'ADI':   { name: 'Analog Devices Inc.',       price: 209.80,  change: -1.55,  pe: 36.40,  mktCap: '109B',  div: '1.62%', divAmt: '0.92', wkHigh: 246.59,  wkLow: 186.76 },
        'INTU':  { name: 'Intuit Inc.',               price: 571.30,  change: -1.80,  pe: 47.20,  mktCap: '160B',  div: '0.70%', divAmt: '1.04', wkHigh: 721.98,  wkLow: 522.91 },
        'SCHW':  { name: 'Charles Schwab Corp.',      price: 80.94,   change: 0.75,   pe: 28.10,  mktCap: '148B',  div: '1.34%', divAmt: '0.25', wkHigh: 85.74,   wkLow: 56.38  },
        'GILD':  { name: 'Gilead Sciences Inc.',      price: 90.72,   change: 0.35,   pe: 16.40,  mktCap: '113B',  div: '3.17%', divAmt: '0.79', wkHigh: 101.75,  wkLow: 68.70  },
        'REGN':  { name: 'Regeneron Pharmaceuticals', price: 626.82,  change: -0.82,  pe: 21.40,  mktCap: '66B',   div: '0.00%', divAmt: '0.00', wkHigh: 1191.00, wkLow: 578.41 },
        'VRTX':  { name: 'Vertex Pharmaceuticals',    price: 498.22,  change: 0.55,   pe: 32.80,  mktCap: '128B',  div: '0.00%', divAmt: '0.00', wkHigh: 535.24,  wkLow: 364.29 },
        'DE':    { name: 'Deere & Co.',               price: 476.20,  change: -0.45,  pe: 19.50,  mktCap: '129B',  div: '1.47%', divAmt: '1.75', wkHigh: 496.73,  wkLow: 339.40 },
        'ACN':   { name: 'Accenture Plc.',            price: 338.70,  change: -0.55,  pe: 27.30,  mktCap: '212B',  div: '1.77%', divAmt: '1.48', wkHigh: 383.18,  wkLow: 288.16 },
        'WM':    { name: 'Waste Management Inc.',     price: 217.40,  change: 0.28,   pe: 31.20,  mktCap: '88B',   div: '1.48%', divAmt: '0.75', wkHigh: 222.05,  wkLow: 182.72 },
        'ITW':   { name: 'Illinois Tool Works',       price: 258.35,  change: -0.35,  pe: 24.80,  mktCap: '79B',   div: '2.49%', divAmt: '1.40', wkHigh: 271.04,  wkLow: 220.29 },
        'ETN':   { name: 'Eaton Corp. Plc.',          price: 347.80,  change: 0.42,   pe: 31.60,  mktCap: '138B',  div: '0.90%', divAmt: '0.86', wkHigh: 401.83,  wkLow: 240.79 },
        'LOW':   { name: "Lowe's Companies Inc.",     price: 265.12,  change: 0.33,   pe: 23.40,  mktCap: '152B',  div: '1.80%', divAmt: '1.15', wkHigh: 289.10,  wkLow: 210.99 },
        'SYK':   { name: 'Stryker Corp.',             price: 390.55,  change: 0.45,   pe: 33.50,  mktCap: '147B',  div: '0.90%', divAmt: '0.86', wkHigh: 421.33,  wkLow: 302.09 },
        'BDX':   { name: 'Becton Dickinson & Co.',    price: 223.80,  change: -0.30,  pe: 16.80,  mktCap: '64B',   div: '1.75%', divAmt: '0.95', wkHigh: 250.68,  wkLow: 211.50 },
        'MDT':   { name: 'Medtronic Plc.',            price: 87.44,   change: 0.25,   pe: 18.20,  mktCap: '116B',  div: '3.40%', divAmt: '0.70', wkHigh: 92.51,   wkLow: 71.93  },
        'C':     { name: 'Citigroup Inc.',            price: 84.32,   change: 0.92,   pe: 11.80,  mktCap: '161B',  div: '2.85%', divAmt: '0.56', wkHigh: 87.10,   wkLow: 54.80  },
        'MMC':   { name: 'Marsh & McLennan Cos.',     price: 221.60,  change: 0.18,   pe: 28.40,  mktCap: '108B',  div: '1.44%', divAmt: '0.815',wkHigh: 232.25,  wkLow: 185.56 },
        'CB':    { name: 'Chubb Ltd.',                price: 271.50,  change: 0.33,   pe: 13.80,  mktCap: '109B',  div: '1.35%', divAmt: '0.91', wkHigh: 300.12,  wkLow: 225.36 },
        'PLD':   { name: 'Prologis Inc.',             price: 106.78,  change: -0.45,  pe: 35.60,  mktCap: '97B',   div: '3.36%', divAmt: '0.96', wkHigh: 136.80,  wkLow: 96.68  },
        'CI':    { name: 'Cigna Group',               price: 298.45,  change: -0.38,  pe: 14.60,  mktCap: '71B',   div: '1.78%', divAmt: '1.40', wkHigh: 361.78,  wkLow: 268.60 },
        'ELV':   { name: 'Elevance Health Inc.',      price: 442.20,  change: -0.55,  pe: 14.20,  mktCap: '109B',  div: '1.44%', divAmt: '1.63', wkHigh: 581.35,  wkLow: 374.50 },
        'ZTS':   { name: 'Zoetis Inc.',               price: 155.60,  change: -0.72,  pe: 28.80,  mktCap: '71B',   div: '1.10%', divAmt: '0.432',wkHigh: 192.50,  wkLow: 146.43 },
        'BSX':   { name: 'Boston Scientific Corp.',   price: 102.84,  change: 0.32,   pe: 62.30,  mktCap: '147B',  div: '0.00%', divAmt: '0.00', wkHigh: 106.08,  wkLow: 66.22  },
        'FI':    { name: 'Fiserv Inc.',               price: 224.72,  change: 0.40,   pe: 24.50,  mktCap: '137B',  div: '0.00%', divAmt: '0.00', wkHigh: 249.80,  wkLow: 167.36 },
        'LIN':   { name: 'Linde Plc.',                price: 455.30,  change: 0.18,   pe: 30.20,  mktCap: '210B',  div: '1.26%', divAmt: '1.39', wkHigh: 494.99,  wkLow: 396.79 },
        'CMCSA': { name: 'Comcast Corp.',             price: 33.18,   change: -0.30,  pe: 9.20,   mktCap: '127B',  div: '3.31%', divAmt: '0.31', wkHigh: 41.26,   wkLow: 32.24  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'TJX':   { name: 'TJX Companies Inc.',        price: 127.30,  change: 0.55,   pe: 30.40,  mktCap: '152B',  div: '1.23%', divAmt: '0.3625',wkHigh: 132.73, wkLow: 97.62  },
        'PGR':   { name: 'Progressive Corp.',         price: 262.40,  change: 0.42,   pe: 18.20,  mktCap: '153B',  div: '0.00%', divAmt: '0.00', wkHigh: 277.91,  wkLow: 175.50 },
        'MDLZ':  { name: 'Mondelez Intl. Inc.',       price: 61.34,   change: -0.18,  pe: 21.60,  mktCap: '80B',   div: '2.87%', divAmt: '0.435',wkHigh: 75.28,   wkLow: 58.54  },
        'ADP':   { name: 'ADP Inc.',                  price: 298.80,  change: 0.35,   pe: 29.30,  mktCap: '121B',  div: '2.07%', divAmt: '1.40', wkHigh: 318.53,  wkLow: 232.95 },
    };

    // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
//   NEWS-DRIVEN VOLATILITY ENGINE (added 2026)
// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

const newsHeadlines = [
    { text: "FED RAISES RATES 50 bps ‚Äì growth stocks under pressure", sector: "Technology", impact: -9 },
    { text: "TECH MEGACAP RALLY: AI spending beats expectations", sector: "Technology", impact: +13 },
    { text: "OIL SURGES 8% after OPEC+ cuts production", sector: "Energy", impact: +11 },
    { text: "FDA grants full approval to breakthrough cancer therapy", sector: "Healthcare", impact: +16 },
    { text: "Consumer confidence hits 2-year high", sector: "Consumer", impact: +8 },
    { text: "Semiconductor shortage worsens ‚Äì supply chain warning", sector: "Technology", impact: -10 },
    { text: "Crypto rebounds sharply after regulatory clarity", sector: "Financials", impact: +14 },
    { text: "Major bank reports stronger-than-expected Q4 earnings", sector: "Financials", impact: +7 },
    { text: "Global chip export restrictions tightened", sector: "Technology", impact: -12 },
    { text: "Renewable energy subsidies expanded in new bill", sector: "Energy", impact: +10 },
    { text: "Inflation cools more than expected", sector: "Consumer", impact: +6 },
    { text: "Big Tech faces new antitrust scrutiny in EU", sector: "Technology", impact: -8 }
];

let newsTimer = null;

function showNewsEvent() {
    const event = newsHeadlines[Math.floor(Math.random() * newsHeadlines.length)];
    
    const banner = document.getElementById('newsBanner');
    const headlineEl = document.getElementById('newsHeadline');
    
    headlineEl.textContent = event.text;
    banner.style.background = event.impact >= 0 ? '#065f46' : '#991b1b';
    banner.classList.remove('hidden');
    
    // Apply sector-wide movement
    stocks.forEach(stock => {
        if (stock.sector === event.sector) {
            // 70‚Äì130% of base impact + individual noise
            const move = event.impact * (0.7 + Math.random() * 0.6);
            stock.price = Math.max(0.5, stock.price * (1 + move / 100));
            stock.change = Number((move + (Math.random() - 0.5) * 4).toFixed(2));
        }
    });

    // Hide banner after 5.5 seconds
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 5500);

    // Refresh UI
    renderGrid();
    if (detailStock) {
        const updated = stocks.find(s => s.symbol === detailStock.symbol);
        if (updated) openStockDetail(updated);
    }
    updateUI();
}

function startNewsEngine() {
    if (newsTimer) clearInterval(newsTimer);
    // First event after 8‚Äì15 seconds, then every 24‚Äì36 seconds
    const firstDelay = 8000 + Math.random() * 7000;
    setTimeout(showNewsEvent, firstDelay);
    
    newsTimer = setInterval(showNewsEvent, 24000 + Math.random() * 12000);
}

    const tickers = Object.keys(realStockData);
    // Fill remaining spots to ~200 with realistic sector peers
    const extraTickers = ['PYPL','SQ','UBER','LYFT','SNAP','PINS','TWTR','RBLX','COIN','HOOD','DKNG','PENN','MGM','CZR','WYNN','LVS','NCLH','CCL','RCL','DAL','UAL','AAL','LUV','JBLU','ALK','F','GM','RIVN','LCID','NIO','LI','XPEV','BIDU','JD','PDD','BABA','TCOM','NTES','BILI','IQ','TME','FUTU','TIGR','ZM','DOCU','WORK','BOX','DBX','ESTC','MDB','DDOG','NET','FSLY','CRWD','S','OKTA','MIME','PING','SAIL','SAIL','ATEN','ALTR','CALD','FROG','SUMO','NLOK','VNET','CLDR','SPLK','ONEM','HIMS','TDOC','AMWL','ACCD','PHR','GDRX','CLOV','OSGN','SMAR','APPN','MNDY','TTWO','EA','ATVI','ZNGA','SCPL','MZOR','OMCL','NUAN','HLTH','AMPH','CHNG'];
    extraTickers.forEach(t => {
        if (!realStockData[t]) {
            realStockData[t] = { name: t + ' Corp.', price: +(50 + Math.random()*300).toFixed(2), change: +((Math.random()*6)-2.5).toFixed(2), pe: +(10+Math.random()*50).toFixed(1), mktCap: (Math.random()*200+10).toFixed(0)+'B', div: '0.00%', divAmt:'0.00', wkHigh: 0, wkLow: 0 };
            tickers.push(t);
        }
    });

    let stocks = [];
    let cash = 100000;
    let portfolio = {};
    let leverage = 1;
    let selectedStock = null;
    let watchlist = [];
    let priceAlerts = [];
    let pendingOrders = [];
    let transactions = [];
    let costBasis = {};
    let achievements = [];
    let alertEvents = [];
    let tradeStreak = { count: 0, lastDay: '' };
    let dailyQuest = { date: '', profitableTrades: 0, totalTrades: 0 };
    let tutorialState = { active: false, step: 0 };
    let allocationChart = null;
    let marketLoopStarted = false;

    // Initialize Market
    function initMarket() {
        stocks = tickers.map(symbol => {
            const d = realStockData[symbol];
            const wkHigh = d.wkHigh || +(d.price * (1.2 + Math.random()*0.3)).toFixed(2);
            const wkLow  = d.wkLow  || +(d.price * (0.65 + Math.random()*0.2)).toFixed(2);
            return {
                symbol,
                name: d.name,
                price: d.price,
                change: d.change,
                pe: d.pe,
                mktCap: d.mktCap,
                div: d.div,
                divAmt: d.divAmt,
                wkHigh,
                wkLow,
                sector: inferSector(symbol, d.name)
            };
        });
        renderGrid();
        updateUI();
        renderNews();
        if (!marketLoopStarted) {
            marketLoopStarted = true;
            setInterval(simulateMarketTick, 30000);
        }
        // Start live data if API key is already stored
        updateMarketStatus();
        updateDataSourceUI();
        if (RT.key) {
            startLiveData();
        }
    }

    // --- Rendering ---
    function renderGrid() {
        const query = document.getElementById('search').value.toUpperCase();
        const grid  = document.getElementById('grid');

        let displayList = query
            ? stocks.filter(s => s.symbol.includes(query) || s.name.toUpperCase().includes(query)).slice(0, 50)
            : stocks.slice(0, 50);

        // Build a map of existing cards by symbol so we can update in-place
        const existingCards = {};
        grid.querySelectorAll('[data-symbol]').forEach(el => {
            existingCards[el.dataset.symbol] = el;
        });

        const symbolsInDisplay = new Set(displayList.map(s => s.symbol));

        // Remove cards no longer in the list
        Object.keys(existingCards).forEach(sym => {
            if (!symbolsInDisplay.has(sym)) existingCards[sym].remove();
        });

        displayList.forEach((stock, idx) => {
            const isPos = stock.change >= 0;
            const pillClass = isPos ? 'pill-up' : 'pill-down';
            const changeStr = (isPos ? '+' : '') + stock.change.toFixed(2) + '%';
            const priceStr  = '$' + stock.price.toFixed(2);
            const freshLabel = getCardFreshnessLabel(stock.symbol);

            if (existingCards[stock.symbol]) {
                // Card exists ‚Äî update only changed text nodes (no full rebuild)
                const card = existingCards[stock.symbol];
                const pill  = card.querySelector('.change-pill');
                const price = card.querySelector('.stock-price');
                const sym   = card.querySelector('.stock-sym');
                const oldPrice = price ? parseFloat(price.textContent.replace('$','')) : null;
                if (pill)  { pill.className  = 'change-pill ' + pillClass; pill.textContent = changeStr; }
                if (price && price.textContent !== priceStr) {
                    price.textContent = priceStr;
                    // Flash card background green/red on price change
                    if (oldPrice !== null) {
                        card.classList.remove('flash-up','flash-down');
                        void card.offsetWidth; // force reflow to restart animation
                        card.classList.add(stock.price >= oldPrice ? 'flash-up' : 'flash-down');
                    }
                }
                if (sym)   sym.innerHTML = stock.symbol + freshLabel;
                // Ensure position in grid matches sorted order
                if (grid.children[idx] !== card) grid.insertBefore(card, grid.children[idx] || null);
            } else {
                // New card ‚Äî create it
                const card = document.createElement('div');
                card.className    = 'g-card p-4 cursor-pointer flex flex-col justify-between h-32';
                card.dataset.symbol = stock.symbol;
                card.onclick = () => openModal(stock);
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="font-bold stock-sym" style="color:#e8e8f5;font-size:0.95rem;letter-spacing:0.02em;">${stock.symbol}${freshLabel}</div>
                            <div class="truncate w-28" style="font-size:0.75rem;color:#8888a8;margin-top:2px;">${stock.name}</div>
                        </div>
                        <div class="change-pill ${pillClass}">${changeStr}</div>
                    </div>
                    <div>
                        <div class="stock-price" style="font-size:1.5rem;font-weight:300;color:#f0f0fa;font-family:var(--v-mono);margin-top:4px;">${priceStr}</div>
                    </div>`;
                grid.insertBefore(card, grid.children[idx] || null);
            }
        });
    }

    let sChart = null;
    let detailStock = null;

    function openModal(stock) { openStockDetail(stock); }

    function openStockDetail(stock) {
        detailStock = stock;
        // Fetch fresh quote on open, then just update the price fields in place (no recursive re-open)
        if (RT.key) {
            fetchQuote(stock.symbol).then(data => {
                if (data && detailStock && detailStock.symbol === stock.symbol) {
                    applyRealQuote(stock.symbol, data);
                    const s = getStockBySymbol(stock.symbol);
                    if (!s) return;
                    const isPos2 = s.change >= 0;
                    const changeAmt2 = s.price * Math.abs(s.change) / 100;
                    const color2 = isPos2 ? '#81c995' : '#f28b82';
                    document.getElementById('detailPrice').innerText = s.price.toFixed(2);
                    document.getElementById('detailChangeAmt').style.color = color2;
                    document.getElementById('detailChangeAmt').innerText = (isPos2?'+':'-') + changeAmt2.toFixed(2);
                    document.getElementById('detailChangePct').style.color = color2;
                    document.getElementById('detailChangePct').innerText = '(' + Math.abs(s.change).toFixed(2) + '%)';
                    document.getElementById('detailArrow').style.color = color2;
                    document.getElementById('detailArrow').innerText = isPos2 ? '‚Üë' : '‚Üì';
                    if (s.dayHigh) document.getElementById('sHigh').innerText = '$' + s.dayHigh.toFixed(2);
                    if (s.dayLow)  document.getElementById('sLow').innerText  = '$' + s.dayLow.toFixed(2);
                    if (s.dayOpen) document.getElementById('sOpen').innerText = '$' + s.dayOpen.toFixed(2);
                }
            });
        }
        document.getElementById('stockDetailPage').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const isPos = stock.change >= 0;
        const changeAmt = (stock.price * Math.abs(stock.change) / 100);
        const color = isPos ? '#81c995' : '#f28b82';
        document.getElementById('detailHeaderSymbol').innerText = stock.symbol;
        document.getElementById('detailName').innerText = stock.name;
        document.getElementById('detailPrice').innerText = stock.price.toFixed(2);
        document.getElementById('detailChangeAmt').style.color = color;
        document.getElementById('detailChangeAmt').innerText = (isPos?'+':'-') + changeAmt.toFixed(2);
        document.getElementById('detailChangePct').style.color = color;
        document.getElementById('detailChangePct').innerText = '(' + Math.abs(stock.change).toFixed(2) + '%)';
        document.getElementById('detailArrow').style.color = color;
        document.getElementById('detailArrow').innerText = isPos ? '‚Üë' : '‚Üì';
        document.getElementById('detailPremarket').innerText = 'Pre-market ' + (stock.price*0.997).toFixed(2) + ' -' + (stock.price*0.003).toFixed(2) + ' (0.35%)';
        document.getElementById('prevCloseVal').innerText = (stock.price - changeAmt*(isPos?1:-1)).toFixed(2);
        document.getElementById('sOpen').innerText = '$' + (stock.dayOpen || (stock.price * (1 + (Math.random()*0.005 - 0.002)))).toFixed(2);
        document.getElementById('sHigh').innerText = '$' + (stock.dayHigh || (stock.price * 1.008)).toFixed(2);
        document.getElementById('sLow').innerText  = '$' + (stock.dayLow  || (stock.price * 0.992)).toFixed(2);
        document.getElementById('sMktCap').innerText = stock.mktCap || '‚Äî';
        document.getElementById('sPE').innerText = stock.pe > 0 ? stock.pe.toFixed(2) : 'N/A';
        document.getElementById('s52H').innerText = '$' + (stock.wkHigh || (stock.price * 1.3)).toFixed(2);
        document.getElementById('s52L').innerText = '$' + (stock.wkLow || (stock.price * 0.7)).toFixed(2);
        document.getElementById('sDividend').innerText = stock.div || '0.00%';
        document.getElementById('sDivAmt').innerText = stock.divAmt > 0 ? '$' + stock.divAmt : '‚Äî';
        document.getElementById('tradeSymLabel').innerText = stock.symbol;
        document.getElementById('dBuyPow').innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
        document.getElementById('dShares').innerText = portfolio[stock.symbol] || 0;
        document.getElementById('alertSymbol').value = stock.symbol;
        updateFollowButton();
        renderDetailNews(stock.symbol);
        renderPendingOrders();
        onTutorialEvent('open_stock');

        // Dim trade buttons if no API key
        const buyBtn  = document.querySelector('[onclick="execDetailTrade(\'BUY\')"]');
        const sellBtn = document.querySelector('[onclick="execDetailTrade(\'SELL\')"]');
        if (buyBtn && sellBtn) {
            if (!RT.key) {
                buyBtn.style.opacity  = '0.45';
                sellBtn.style.opacity = '0.45';
                buyBtn.title  = 'Connect Live Data API to trade';
                sellBtn.title = 'Connect Live Data API to trade';
            } else {
                buyBtn.style.opacity  = '1';
                sellBtn.style.opacity = '1';
                buyBtn.title  = '';
                sellBtn.title = '';
            }
        }
        document.querySelectorAll('.ctab').forEach(b => { b.className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200'; });
        document.querySelector('.ctab').className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-[#8ab4f8] text-[#8ab4f8]';
        drawChart(stock, '1D'); // async ‚Äî fires and runs in background
    }

    function closeStockDetail() {
        document.getElementById('stockDetailPage').classList.add('hidden');
        document.body.style.overflow = '';
        detailStock = null;
        if (sChart) { sChart.destroy(); sChart = null; }
    }

    function closeModal() { closeStockDetail(); }

    async function setChartPeriod(period, btn) {
        document.querySelectorAll('.ctab').forEach(b => { b.className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200'; });
        btn.className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-[#8ab4f8] text-[#8ab4f8]';
        if (detailStock) await drawChart(detailStock, period);
    }

    // ‚îÄ‚îÄ Pure canvas candlestick renderer ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const candleCache = {};

    function periodToFinnhub(period) {
        const now = Math.floor(Date.now() / 1000);
        const DAY = 86400, MONTH = 30*DAY, YEAR = 365*DAY;
        switch (period) {
            case '1D':  return { resolution: '5',  from: now - DAY };
            case '5D':  return { resolution: '15', from: now - 5*DAY };
            case '1M':  return { resolution: '60', from: now - MONTH };
            case '6M':  return { resolution: 'D',  from: now - 6*MONTH };
            case 'YTD': return { resolution: 'D',  from: Math.floor(new Date(new Date().getFullYear(),0,1)/1000) };
            case '1Y':  return { resolution: 'W',  from: now - YEAR };
            case '5Y':  return { resolution: 'M',  from: now - 5*YEAR };
            default:    return { resolution: 'M',  from: now - 10*YEAR };
        }
    }

    function generateSimCandles(stock, period) {
        const isNeg = stock.change < 0;
        let numPts, vol, trend;
        const DAY_MS = 86400000;
        switch(period) {
            case '1D':  numPts=78;  vol=0.004; trend=isNeg?-0.0008:0.0002; break;
            case '5D':  numPts=60;  vol=0.007; trend=isNeg?-0.001:0.0005;  break;
            case '1M':  numPts=30;  vol=0.015; trend=isNeg?-0.003:0.004;   break;
            case '6M':  numPts=26;  vol=0.03;  trend=isNeg?-0.005:0.008;   break;
            case 'YTD': numPts=24;  vol=0.025; trend=isNeg?-0.004:0.007;   break;
            case '1Y':  numPts=52;  vol=0.04;  trend=isNeg?-0.003:0.006;   break;
            case '5Y':  numPts=60;  vol=0.06;  trend=0.008;                break;
            default:    numPts=120; vol=0.07;  trend=0.01;                  break;
        }
        const intervalMs = {'1D':5*60000,'5D':15*60000,'1M':3600000,'6M':DAY_MS,'YTD':DAY_MS,'1Y':7*DAY_MS,'5Y':30*DAY_MS,'Max':30*DAY_MS}[period]||DAY_MS;
        let closes=[stock.price];
        for(let i=1;i<numPts;i++) closes.push(closes[closes.length-1]/(1+trend+(Math.random()-0.5)*vol*2));
        closes.reverse();
        return closes.map((c,i)=>{
            const t=Date.now()-(numPts-1-i)*intervalMs;
            const sw=c*vol*0.8, o=c+(Math.random()-0.5)*sw;
            const h=Math.max(o,c)+Math.random()*sw*0.4;
            const l=Math.min(o,c)-Math.random()*sw*0.4;
            return {x:t,o:+o.toFixed(2),h:+h.toFixed(2),l:+l.toFixed(2),c:+c.toFixed(2)};
        });
    }

    async function fetchCandles(symbol, period) {
        const key = symbol+'_'+period;
        if (candleCache[key] && (Date.now()-candleCache[key].ts)<60000) return candleCache[key].data;
        if (!RT.key) return null;
        try {
            const {resolution,from} = periodToFinnhub(period);
            const to = Math.floor(Date.now()/1000);
            const url = `https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=${resolution}&from=${from}&to=${to}&token=${RT.key}`;
            const res = await fetch(url);
            const data = await res.json();
            if (!data||data.s!=='ok'||!data.t||data.t.length===0) return null;
            const candles = data.t.map((ts,i)=>({x:ts*1000,o:data.o[i],h:data.h[i],l:data.l[i],c:data.c[i]}));
            candleCache[key]={data:candles,ts:Date.now()};
            return candles;
        } catch(e){ return null; }
    }

    // Draw candlesticks directly on canvas ‚Äî no library needed
    function drawCandlesticks(canvas, candles) {
        const dpr = window.devicePixelRatio || 1;
        const W = canvas.clientWidth, H = canvas.clientHeight;
        canvas.width  = W * dpr;
        canvas.height = H * dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        // Padding
        const PAD = {top:16, right:56, bottom:36, left:8};
        const chartW = W - PAD.left - PAD.right;
        const chartH = H - PAD.top  - PAD.bottom;

        // Price range
        const allH = candles.map(c=>c.h), allL = candles.map(c=>c.l);
        const minP  = Math.min(...allL) * 0.999;
        const maxP  = Math.max(...allH) * 1.001;
        const priceRange = maxP - minP;

        const toY = p => PAD.top + chartH * (1 - (p-minP)/priceRange);
        const toX = i => PAD.left + (i + 0.5) * (chartW / candles.length);
        const candleW = Math.max(1, chartW / candles.length * 0.6);

        // Background
        ctx.fillStyle = '#1c1c1e';
        ctx.fillRect(0, 0, W, H);

        // Grid lines + Y labels
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.lineWidth = 1;
        ctx.fillStyle = '#9aa0a6';
        ctx.font = `${11*dpr/dpr}px Roboto, sans-serif`;
        ctx.textAlign = 'right';
        const gridLines = 5;
        for (let i=0;i<=gridLines;i++) {
            const p   = minP + priceRange * (i/gridLines);
            const y   = toY(p);
            ctx.beginPath();
            ctx.moveTo(PAD.left, y);
            ctx.lineTo(W - PAD.right, y);
            ctx.stroke();
            ctx.fillText('$'+p.toFixed(p>100?0:2), W - PAD.right + 52, y+4);
        }

        // X axis labels
        ctx.textAlign = 'center';
        const labelEvery = Math.max(1, Math.floor(candles.length / 6));
        candles.forEach((c,i)=>{
            if (i % labelEvery !== 0) return;
            const d = new Date(c.x);
            const label = candles.length <= 80
                ? d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})
                : d.toLocaleDateString([],{month:'short',day:'numeric'});
            ctx.fillStyle = '#9aa0a6';
            ctx.fillText(label, toX(i), H - PAD.bottom + 14);
        });

        // Candles
        candles.forEach((c,i)=>{
            const x   = toX(i);
            const up  = c.c >= c.o;
            const col = up ? '#26a69a' : '#ef5350';
            const yO  = toY(c.o), yC = toY(c.c);
            const yH  = toY(c.h), yL = toY(c.l);

            // Wick
            ctx.strokeStyle = col;
            ctx.lineWidth = Math.max(1, candleW * 0.15);
            ctx.beginPath();
            ctx.moveTo(x, yH);
            ctx.lineTo(x, yL);
            ctx.stroke();

            // Body
            ctx.fillStyle = col;
            const bodyTop = Math.min(yO, yC);
            const bodyH   = Math.max(1, Math.abs(yC - yO));
            ctx.fillRect(x - candleW/2, bodyTop, candleW, bodyH);
        });

        // Hover tooltip
        canvas._candles = candles;
        canvas._meta = { PAD, chartW, chartH, toX, toY, minP, maxP, priceRange, candleW, W, H, dpr };
    }

    function setupCandleHover(canvas) {
        canvas.onmousemove = function(e) {
            if (!canvas._candles) return;
            const rect = canvas.getBoundingClientRect();
            const mx = e.clientX - rect.left;
            const { PAD, chartW, W, H, candles: _, toX, dpr } = canvas._meta;
            const candles = canvas._candles;
            const idx = Math.round((mx - PAD.left) / (chartW / candles.length) - 0.5);
            if (idx < 0 || idx >= candles.length) { drawCandlesticks(canvas, candles); return; }
            drawCandlesticks(canvas, candles);

            const c   = candles[idx];
            const x   = toX(idx);
            const dpr2 = window.devicePixelRatio || 1;
            const ctx  = canvas.getContext('2d');
            ctx.scale(1,1); // already scaled

            // Crosshair
            ctx.strokeStyle = 'rgba(255,255,255,0.2)';
            ctx.lineWidth = 1;
            ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(x, PAD.top); ctx.lineTo(x, H - PAD.bottom); ctx.stroke();
            ctx.setLineDash([]);

            // Tooltip box
            const d = new Date(c.x);
            const dateStr = d.toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            const lines = [`${dateStr}`,`O: $${c.o.toFixed(2)}  H: $${c.h.toFixed(2)}`,`L: $${c.l.toFixed(2)}  C: $${c.c.toFixed(2)}`];
            const boxW = 200, boxH = 58, boxX = Math.min(x+10, W-boxW-PAD.right-4), boxY = PAD.top + 8;
            ctx.fillStyle = 'rgba(30,30,32,0.95)';
            ctx.strokeStyle = c.c >= c.o ? '#26a69a' : '#ef5350';
            ctx.lineWidth = 1;
            ctx.beginPath(); ctx.roundRect(boxX, boxY, boxW, boxH, 6); ctx.fill(); ctx.stroke();
            ctx.fillStyle = '#ebebf5'; ctx.font = '11px Roboto,sans-serif'; ctx.textAlign = 'left';
            lines.forEach((l,i) => ctx.fillText(l, boxX+10, boxY+16+i*16));
        };
        canvas.onmouseleave = function() {
            if (canvas._candles) drawCandlesticks(canvas, canvas._candles);
        };
    }

    async function drawChart(stock, period) {
        if (sChart) { sChart.destroy(); sChart = null; }
        const canvas = document.getElementById('stockChart');

        // Resize canvas to container
        canvas.style.width  = '100%';
        canvas.style.height = '100%';

        // Show loading
        const dpr = window.devicePixelRatio||1;
        canvas.width  = (canvas.clientWidth||700)*dpr;
        canvas.height = (canvas.clientHeight||280)*dpr;
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr,dpr);
        ctx.fillStyle='#1c1c1e'; ctx.fillRect(0,0,canvas.clientWidth,canvas.clientHeight);
        ctx.fillStyle='#9aa0a6'; ctx.font='13px Roboto,sans-serif'; ctx.textAlign='center';
        ctx.fillText('Loading chart‚Ä¶', canvas.clientWidth/2, canvas.clientHeight/2);

        // Fetch real candles, fall back to sim
        let candles = await fetchCandles(stock.symbol, period);
        if (!candles || candles.length < 3) candles = generateSimCandles(stock, period);

        drawCandlesticks(canvas, candles);
        setupCandleHover(canvas);
    }

    function execDetailTrade(type) {
        if (!detailStock) return;

        // Gate: require API key before trading
        if (!RT.key) {
            showNoApiToast();
            return;
        }

        const sym      = detailStock.symbol;
        const price    = detailStock.price;
        const orderType = document.getElementById('orderType').value;
        const qty      = Math.max(1, parseInt(document.getElementById('orderQty').value || '1', 10));
        const trigger  = parseFloat(document.getElementById('orderTrigger').value || '0');

        if (orderType === 'market') {
            const ok = executeOrderNow({ side: type, symbol: sym, qty, type: 'market' }, price, false);
            if (ok) {
                // Update shares owned and buying power in the detail panel immediately
                document.getElementById('dShares').innerText = portfolio[sym] || 0;
                document.getElementById('dBuyPow').innerText = '$' + (cash * leverage).toLocaleString(undefined, { maximumFractionDigits: 0 });
                showTradeToast(type, qty, sym, price);
            }
            return;
        }
        if (!Number.isFinite(trigger) || trigger <= 0) {
            alert('Enter a valid trigger price for non-market orders.');
            return;
        }
        if ((orderType === 'stop-loss' || orderType === 'take-profit') && type !== 'SELL') {
            alert(orderType + ' orders are available for SELL only.');
            return;
        }
        pendingOrders.unshift({
            id: 'ord_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
            symbol: sym, side: type, qty, type: orderType, trigger,
            createdAt: Date.now(), status: 'OPEN'
        });
        renderPendingOrders();
        updateUI();
        saveUserData(false);
        showTradeToast(type, qty, sym, trigger, true);
    }

    function showTradeToast(type, qty, sym, price, isPending) {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        const isBuy = type === 'BUY';
        const bg = isPending ? '#1a73e8' : (isBuy ? '#34c759' : '#ff453a');
        const label = isPending ? '‚è≥ Order Placed' : (isBuy ? '‚úÖ Bought' : '‚úÖ Sold');
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:${bg};color:white;padding:12px 24px;border-radius:12px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.3);
            animation:toastIn 0.25s ease-out;`;
        toast.innerHTML = `${label}: ${qty} √ó ${sym} @ $${price.toFixed(2)}`;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.4s'; setTimeout(() => toast.remove(), 400); }, 2500);
    }

    function executeTrade(type) { execDetailTrade(type); }

    function showNoApiToast() {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:#1c1c2e;color:white;padding:14px 28px;border-radius:14px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 30px rgba(0,0,0,0.4);
            border:1px solid rgba(139,92,246,0.4);animation:toastIn 0.25s ease-out;
            display:flex;align-items:center;gap:12px;`;
        toast.innerHTML = `<span style="font-size:20px">üîë</span>
            <div>
                <div>API key required to trade</div>
                <div style="font-size:11px;opacity:0.7;font-weight:400;margin-top:2px">Click <strong>‚ö° Live Data</strong> in the header to connect</div>
            </div>`;
        document.body.appendChild(toast);
        // Shake animation
        toast.animate([{transform:'translateX(-50%) translateX(-6px)'},{transform:'translateX(-50%) translateX(6px)'},{transform:'translateX(-50%) translateX(-4px)'},{transform:'translateX(-50%) translateX(0)'}], {duration:300});
        setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity 0.4s'; setTimeout(()=>toast.remove(),400); }, 3000);
    }

    function triggerCrash() {
        stocks.forEach(s => { s.price = s.price * 0.8; s.change = s.change - 20; });
        renderGrid();
        updateUI();
        saveUserData(false);
        if(detailStock) { const u=stocks.find(s=>s.symbol===detailStock.symbol); if(u) openStockDetail(u); }
        alert("MARKET CRASH INITIATED: All assets down 20%");
    }

    function updateUI() {
        const list = document.getElementById('portfolioList');
        const symsInPortfolio = Object.keys(portfolio);
        let portfolioValue = 0;

        // Clear the empty-state message if we now have holdings
        if (symsInPortfolio.length > 0 && list.querySelector('.italic')) {
            list.innerHTML = '';
        }

        // Remove rows for sold positions
        list.querySelectorAll('[data-port-sym]').forEach(el => {
            if (!portfolio[el.dataset.portSym]) el.remove();
        });

        // Add/update rows
        symsInPortfolio.forEach(symbol => {
            const qty   = portfolio[symbol];
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            const val   = qty * stock.price;
            portfolioValue += val;
            const isPos = stock.change >= 0;
            const cost  = (costBasis[symbol] ? costBasis[symbol].totalCost / costBasis[symbol].shares : stock.price);
            const gainPct = ((stock.price - cost) / cost * 100).toFixed(2);

            let row = list.querySelector(`[data-port-sym="${symbol}"]`);
            if (row) {
                row.querySelector('.port-val').textContent = '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.querySelector('.port-chg').textContent = (isPos ? '+' : '') + stock.change.toFixed(2) + '% today';
                row.querySelector('.port-chg').style.color = isPos ? '#4ade80' : '#f87171';
                row.querySelector('.port-qty').textContent = qty + ' shares ¬∑ ' + (gainPct >= 0 ? '+' : '') + gainPct + '% avg';
            } else {
                row = document.createElement('div');
                row.className       = 'py-3 flex justify-between items-center cursor-pointer rounded'; row.style.cssText = 'border-bottom:1px solid rgba(255,255,255,0.06);';
                row.dataset.portSym = symbol;
                row.innerHTML = `
                    <div>
                        <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${symbol}</div>
                        <div class="port-qty" style="font-size:11px;color:#8888a8;margin-top:2px;">${qty} shares ¬∑ ${gainPct >= 0 ? '+' : ''}${gainPct}% avg</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="port-val" style="font-weight:600;color:#f0f0fa;font-size:0.875rem;font-family:var(--v-mono);">$${val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <div class="port-chg" style="font-size:11px;color:${isPos ? '#4ade80' : '#f87171'};">${isPos ? '+' : ''}${stock.change.toFixed(2)}% today</div>
                    </div>`;
                row.onclick = () => openStockDetail(stock);
                list.appendChild(row);
            }
        });

        if (symsInPortfolio.length === 0) {
            list.innerHTML = '<div style="font-size:13px;color:#8888a8;padding:16px 0;text-align:center;font-style:italic;">Your portfolio is empty.</div>';
        }

        // Total equity + P&L
        const totalEquity = cash + portfolioValue;
        const nwEl = document.getElementById('netWorth');
        if (nwEl) nwEl.innerText = totalEquity.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const pl    = totalEquity - 100000;
        const plPct = ((pl / 100000) * 100).toFixed(2);
        const plEl  = document.getElementById('plDisplay');
        if (plEl) {
            plEl.innerText = (pl >= 0 ? '+$' : '-$') + Math.abs(pl).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' (' + (pl >= 0 ? '+' : '') + plPct + '%)';
            plEl.style.color = pl >= 0 ? '#4ade80' : '#f87171';
        }

        // Cash / buying power
        const bpEl = document.getElementById('buyingPower');
        if (bpEl) bpEl.innerText = (cash * leverage).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        renderWatchlist();
        renderAlerts();
        renderHistory();
        renderAnalytics();
        renderQuestsAndAchievements();
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  AUTH + PERSISTENT STORAGE SYSTEM
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentUser = null;  // { username, displayName }
    let authMode = 'login';  // 'login' | 'register'

    // Storage adapter: use platform storage if available, otherwise fallback to localStorage.
    window.__storageFallback = false;
    function buildStorageFallback() {
        // Prefix shared keys so they're distinguishable in localStorage
        const lsKey = (key, shared) => shared ? 'shared:' + key : 'priv:' + key;
        return {
            async get(key, shared = false) {
                try {
                    const val = localStorage.getItem(lsKey(key, shared));
                    return val == null ? null : { key, value: val, shared };
                } catch (_) { return null; }
            },
            async set(key, value, shared = false) {
                try {
                    localStorage.setItem(lsKey(key, shared), value);
                    return { key, value, shared };
                } catch (e) {
                    throw new Error('Storage unavailable: ' + (e.message || e));
                }
            },
            async delete(key, shared = false) {
                try {
                    localStorage.removeItem(lsKey(key, shared));
                    return { key, deleted: true, shared };
                } catch (_) { return null; }
            },
            async list(prefix = '', shared = false) {
                const keys = [];
                const lsPrefix = lsKey(prefix, shared);
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(lsPrefix)) {
                            // Strip the ls prefix to return the original key
                            keys.push(k.slice(shared ? 'shared:'.length : 'priv:'.length));
                        }
                    }
                } catch (_) {}
                return { keys, prefix, shared };
            }
        };
    }

    function ensureStorageAdapter() {
        const valid = window.storage
            && typeof window.storage.get === 'function'
            && typeof window.storage.set === 'function'
            && typeof window.storage.list === 'function';
        if (!valid) {
            window.__storageFallback = true;
            window.storage = buildStorageFallback();
        }
        return window.storage;
    }

    ensureStorageAdapter();

    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        const isReg = authMode === 'register';
        document.getElementById('authTitle').innerText = isReg ? 'Create account' : 'Sign in';
        document.getElementById('authSubtitle').innerText = isReg ? 'Start with $100,000 USD' : 'to your trading account';
        document.getElementById('authSubmitBtn').innerText = isReg ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').innerText = isReg ? 'Already have an account?' : "Don't have an account?";
        document.getElementById('authToggleBtn').innerText = isReg ? 'Sign in' : 'Create account';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isReg);
        document.getElementById('authError').classList.add('hidden');
    }

    function showAuthError(msg) {
        const el = document.getElementById('authError');
        el.innerText = msg;
        el.classList.remove('hidden');
    }

    async function handleAuthSubmit() {
        const username = document.getElementById('authUser').value.trim().toLowerCase();
        const password = document.getElementById('authPass').value;
        const displayName = document.getElementById('authName').value.trim();
        const storage = ensureStorageAdapter();
        if (!username || !password) return showAuthError('Please fill in all fields.');
        if (!/^[a-z0-9_]+$/.test(username)) return showAuthError('Username can use letters, numbers, and underscores only.');

        try {
            if (authMode === 'register') {
                if (!displayName) return showAuthError('Please enter a display name.');
                if (username.length < 3) return showAuthError('Username must be at least 3 characters.');
                if (password.length < 4) return showAuthError('Password must be at least 4 characters.');
                // Check if username taken
                let existing = null;
                try { existing = await storage.get('user:' + username, true); } catch(e) {}
                if (existing) return showAuthError('Username already taken. Try another.');
                // Create account with $100k
                const userData = { username, displayName, passwordHash: simpleHash(password), cash: 100000, portfolio: {}, joinedAt: Date.now(), totalTrades: 0 };
                await storage.set('user:' + username, JSON.stringify(userData), true);
                await loginAs(userData);
            } else {
                let stored = null;
                try { stored = await storage.get('user:' + username, true); } catch(e) {}
                if (!stored) return showAuthError('Account not found. Please register.');
                const userData = JSON.parse(stored.value);
                if (userData.passwordHash !== simpleHash(password)) return showAuthError('Incorrect password.');
                await loginAs(userData);
            }
        } catch(e) {
            showAuthError('Storage error: ' + e.message);
        }
    }

    async function loginAs(userData) {
        currentUser = userData || {};
        const safeName = (currentUser.displayName && String(currentUser.displayName).trim())
            ? String(currentUser.displayName).trim()
            : ((currentUser.username && String(currentUser.username).trim()) || 'Trader');
        currentUser.displayName = safeName;
        cash = Number.isFinite(currentUser.cash) ? currentUser.cash : 100000;
        portfolio = (currentUser.portfolio && typeof currentUser.portfolio === 'object') ? currentUser.portfolio : {};
        watchlist = Array.isArray(currentUser.watchlist) ? currentUser.watchlist : [];
        priceAlerts = Array.isArray(currentUser.priceAlerts) ? currentUser.priceAlerts : [];
        pendingOrders = Array.isArray(currentUser.pendingOrders) ? currentUser.pendingOrders : [];
        transactions = Array.isArray(currentUser.transactions) ? currentUser.transactions : [];
        costBasis = (currentUser.costBasis && typeof currentUser.costBasis === 'object') ? currentUser.costBasis : {};
        achievements = Array.isArray(currentUser.achievements) ? currentUser.achievements : [];
        tradeStreak = (currentUser.tradeStreak && typeof currentUser.tradeStreak === 'object') ? currentUser.tradeStreak : { count: 0, lastDay: '' };
        dailyQuest = (currentUser.dailyQuest && typeof currentUser.dailyQuest === 'object') ? currentUser.dailyQuest : { date: '', profitableTrades: 0, totalTrades: 0 };
        ensureDailyQuest();
        updateSyncBadge();
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('userAvatar').innerText = safeName[0].toUpperCase();
        document.getElementById('userDisplayName').innerText = safeName;
        // Save immediately so user appears on leaderboard right away
        await saveUserData(false);
        // Show the app and hide the homepage
        showApp();
        initMarket();
        if (!currentUser.tutorialDone) startTutorial(false);
    }

    function logOut() {
        if (!confirm('Sign out? Your progress is saved.')) return;
        currentUser = null;
        cash = 100000;
        portfolio = {};
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('authUser').value = '';
        document.getElementById('authPass').value = '';
        document.getElementById('authName').value = '';
        document.getElementById('authError').classList.add('hidden');
        authMode = 'login';
        document.getElementById('authTitle').innerText = 'Sign in';
        document.getElementById('authSubtitle').innerText = 'to your trading account';
        // Return to homepage
        showHomepage();
    }

    function simpleHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) { h = (Math.imul(31, h) + str.charCodeAt(i)) | 0; }
        return h.toString(36);
    }

    async function saveUserData(countTrade = false) {
        if (!currentUser || !currentUser.username) return false;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = stocks.find(x => x.symbol === sym);
            return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const totalShares = Object.values(portfolio).reduce((a, b) => a + b, 0);
        const season = getSeasonKey();
        currentUser.cash = cash;
        currentUser.portfolio = portfolio;
        currentUser.watchlist = watchlist;
        currentUser.priceAlerts = priceAlerts;
        currentUser.pendingOrders = pendingOrders;
        currentUser.transactions = transactions.slice(0, 200);
        currentUser.costBasis = costBasis;
        currentUser.achievements = achievements;
        currentUser.tradeStreak = tradeStreak;
        currentUser.dailyQuest = dailyQuest;
        currentUser.totalValue = cash + portfolioValue;
        currentUser.profit = (cash + portfolioValue) - 100000;
        currentUser.totalShares = totalShares;
        currentUser.realizedPL = Number(currentUser.realizedPL || 0);
        if (countTrade) currentUser.totalTrades = (currentUser.totalTrades || 0) + 1;
        currentUser.lastActive = Date.now();
        currentUser.seasonStats = currentUser.seasonStats || {};
        currentUser.seasonStats[season] = {
            totalValue: currentUser.totalValue,
            profit: currentUser.profit,
            totalShares: currentUser.totalShares,
            totalTrades: currentUser.totalTrades || 0
        };
        try {
            const storage = ensureStorageAdapter();
            await storage.set('user:' + currentUser.username, JSON.stringify(currentUser), true);
            return true;
        } catch (e) {
            console.error('Failed to save user data:', e);
            return false;
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LEADERBOARD
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let leaderSort = 'total';

    function openLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.remove('hidden');
        loadLeaderboard();
    }

    function closeLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.add('hidden');
    }

    function setLeaderSort(type) {
        leaderSort = type;
        document.querySelectorAll('.lbsort-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
            b.style.borderBottom = '2px solid transparent';
        });
        const active = document.getElementById('sort-' + type);
        if (active) {
            active.style.background = 'rgba(212,168,75,0.15)';
            active.style.color = 'var(--v-gold)';
            active.style.borderBottom = '2px solid var(--v-gold)';
        }
        loadLeaderboard();
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;">Loading traders...</div>';
        try {
            const storage = ensureStorageAdapter();
            const keys = await storage.list('user:', true);
            if (!keys || !keys.keys || keys.keys.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;">No traders yet ‚Äî be the first!</div>';
                return;
            }
            const users = [];
            for (const key of keys.keys) {
                try {
                    const r = await storage.get(key, true);
                    if (r) {
                        const u = JSON.parse(r.value);
                        if (u.displayName) users.push(u);
                    }
                } catch(e) {}
            }
            const season = getSeasonKey();
            users.forEach(u => {
                const ss = (u.seasonStats && u.seasonStats[season]) || {};
                u._seasonTotal = ss.totalValue || u.totalValue || 100000;
                u._seasonProfit = ss.profit || u.profit || 0;
                u._seasonShares = ss.totalShares || u.totalShares || 0;
            });
            if (leaderSort === 'total') users.sort((a, b) => b._seasonTotal - a._seasonTotal);
            else if (leaderSort === 'profit') users.sort((a, b) => b._seasonProfit - a._seasonProfit);
            else if (leaderSort === 'stocks') users.sort((a, b) => b._seasonShares - a._seasonShares);

            const medals = ['ü•á','ü•à','ü•â'];
            const isMe = u => currentUser && u.username === currentUser.username;

            list.innerHTML = '<div style="font-size:11px;color:#606080;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.06em;">Season: ' + season + ' ¬∑ weekly reset</div>'
            + users.map((u, i) => {
                const totalVal = u._seasonTotal || 100000;
                const profit = u._seasonProfit || 0;
                const shares = u._seasonShares || 0;
                const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
                const profitSign = profit >= 0 ? '+' : '';
                const borderStyle = isMe(u)
                    ? 'background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.25);'
                    : 'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);';
                const avatarBg = isMe(u) ? 'var(--v-gold)' : '#2a2a3a';
                const avatarColor = isMe(u) ? '#0a0a0f' : '#c0c0d8';
                const medal = medals[i] || '<span style="font-size:12px;color:#606080;font-weight:700;">#' + (i+1) + '</span>';
                return `<div style="border-radius:12px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;${borderStyle}">
                    <div style="font-size:1.4rem;width:28px;text-align:center;flex-shrink:0;">${medal}</div>
                    <div style="width:38px;height:38px;border-radius:50%;background:${avatarBg};display:flex;align-items:center;justify-content:center;color:${avatarColor};font-weight:700;font-size:14px;flex-shrink:0;">
                        ${u.displayName[0].toUpperCase()}
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            ${u.displayName} ${isMe(u) ? '<span style="font-size:10px;color:var(--v-gold);font-weight:600;">(you)</span>' : ''}
                        </div>
                        <div style="font-size:11px;color:#8888a8;margin-top:1px;">@${u.username}</div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.9rem;font-family:var(--v-mono);">$${totalVal.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        <div style="font-size:11px;color:${profitColor};font-family:var(--v-mono);">${profitSign}$${Math.abs(profit).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        <div style="font-size:10px;color:#606080;">${shares} shares</div>
                    </div>
                </div>`;
            }).join('') || '<div style="text-align:center;color:#8888a8;padding:32px 0;">No traders yet.</div>';
        } catch(e) {
            list.innerHTML = '<div style="text-align:center;color:#f87171;padding:32px 0;">Error loading leaderboard: ' + e.message + '</div>';
        }
    }


    function getSeasonKey(ts = Date.now()) {
        const d = new Date(ts);
        const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum = utc.getUTCDay() || 7;
        utc.setUTCDate(utc.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
        const weekNum = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
        return utc.getUTCFullYear() + '-W' + String(weekNum).padStart(2, '0');
    }

    function dayKey(ts = Date.now()) {
        const d = new Date(ts);
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return d.getFullYear() + '-' + m + '-' + day;
    }

    function ensureDailyQuest() {
        const today = dayKey();
        if (dailyQuest.date !== today) {
            dailyQuest = { date: today, profitableTrades: 0, totalTrades: 0 };
        }
    }

    function inferSector(symbol, name) {
        const n = (name || '').toLowerCase();
        if (n.includes('bank') || n.includes('financial') || n.includes('capital')) return 'Financials';
        if (n.includes('pharma') || n.includes('health') || n.includes('med')) return 'Healthcare';
        if (n.includes('energy') || n.includes('oil') || n.includes('gas')) return 'Energy';
        if (n.includes('retail') || n.includes('consumer') || n.includes('walmart') || n.includes('costco')) return 'Consumer';
        if (n.includes('software') || n.includes('tech') || n.includes('semiconductor') || n.includes('cloud') || ['AAPL','MSFT','NVDA','GOOGL','META','AMD','INTC'].includes(symbol)) return 'Technology';
        if (n.includes('industrial') || n.includes('air') || n.includes('aerospace') || n.includes('transport')) return 'Industrials';
        return 'Other';
    }

    function fmtMoney(v) {
        return '$' + Number(v || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getStockBySymbol(sym) { return stocks.find(s => s.symbol === sym); }

    function avgCost(sym) {
        const cb = costBasis[sym];
        if (!cb || !cb.shares) return 0;
        return cb.totalCost / cb.shares;
    }

    function updateSyncBadge() {
        const el = document.getElementById('syncBadge');
        if (!el) return;
        el.innerText = window.__storageFallback ? 'Sync: Local' : 'Sync: Cloud';
        el.className = window.__storageFallback
            ? 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 font-semibold'
            : 'text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-semibold';
    }

    function addCurrentToWatchlist() {
        if (!detailStock) return;
        if (!watchlist.includes(detailStock.symbol)) watchlist.unshift(detailStock.symbol);
        watchlist = watchlist.slice(0, 40);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function toggleFollowCurrent() {
        if (!detailStock) return;
        const sym = detailStock.symbol;
        if (watchlist.includes(sym)) watchlist = watchlist.filter(s => s !== sym);
        else watchlist.unshift(sym);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function updateFollowButton() {
        const btn = document.getElementById('followBtn');
        if (!btn || !detailStock) return;
        const followed = watchlist.includes(detailStock.symbol);
        btn.innerText = followed ? 'Following' : '+ Follow';
        btn.className = followed
            ? 'ml-auto flex items-center gap-2 border border-[#8ab4f8] text-[#8ab4f8] px-4 py-1.5 rounded-full text-sm font-medium'
            : 'ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium';
    }

    function renderWatchlist() {
        const el = document.getElementById('watchlistItems');
        if (!el) return;
        if (!watchlist.length) { el.innerHTML = '<div class="text-xs text-gray-500">No watchlist symbols yet.</div>'; return; }
        el.innerHTML = watchlist.slice(0, 10).map(sym => {
            const st = getStockBySymbol(sym);
            const p = st ? st.price.toFixed(2) : '‚Äî';
            return `<div class="flex items-center justify-between border border-gray-100 rounded px-2 py-1">
                <button class="font-semibold text-gray-700" onclick="openSymbolFromWatchlist('${sym}')">${sym}</button>
                <div class="text-gray-500">$${p}</div>
                <button class="text-red-500" onclick="removeWatchSymbol('${sym}')">√ó</button>
            </div>`;
        }).join('');
    }

    function openSymbolFromWatchlist(sym) {
        const st = getStockBySymbol(sym);
        if (st) openStockDetail(st);
    }

    function removeWatchSymbol(sym) {
        watchlist = watchlist.filter(s => s !== sym);
        renderWatchlist();
        saveUserData(false);
    }

    function createPriceAlert() {
        const symbol = (document.getElementById('alertSymbol').value || '').trim().toUpperCase();
        const type = document.getElementById('alertType').value;
        const value = parseFloat(document.getElementById('alertValue').value || '0');
        if (!symbol || !getStockBySymbol(symbol)) return alert('Enter a valid symbol for alert.');
        if (!Number.isFinite(value) || value <= 0) return alert('Enter a valid alert value.');
        priceAlerts.unshift({ id: 'al_' + Date.now(), symbol, type, value, triggered: false, createdAt: Date.now() });
        priceAlerts = priceAlerts.slice(0, 60);
        renderAlerts();
        saveUserData(false);
    }

    function renderAlerts() {
        const el = document.getElementById('alertsList');
        if (!el) return;
        el.innerHTML = priceAlerts.slice(0, 8).map(a => {
            const status = a.triggered ? '<span class="text-green-600">triggered</span>' : '<span class="text-gray-500">active</span>';
            return `<div class="flex justify-between gap-2">
                <span>${a.symbol} ${a.type} ${a.value}</span>
                <span>${status} <button class="text-red-500" onclick="removeAlert('${a.id}')">√ó</button></span>
            </div>`;
        }).join('') || '<div class="text-gray-500">No alerts yet.</div>';

        const feed = document.getElementById('alertFeed');
        if (feed) feed.innerHTML = alertEvents.slice(0, 4).map(x => '<div style="color:#4ade80;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:6px;padding:4px 8px;">' + x + '</div>').join('');
    }

    function removeAlert(id) {
        priceAlerts = priceAlerts.filter(a => a.id !== id);
        renderAlerts();
        saveUserData(false);
    }

    function renderPendingOrders() {
        const el = document.getElementById('pendingOrdersList');
        if (!el) return;
        const open = pendingOrders.filter(o => o.status === 'OPEN').slice(0, 6);
        el.innerHTML = open.map(o => '<div class="flex justify-between"><span>' + o.side + ' ' + o.qty + ' ' + o.symbol + ' (' + o.type + ')</span><span>@ ' + o.trigger.toFixed(2) + '</span></div>').join('') || '<div class="text-gray-400">No pending orders</div>';
    }

    function shouldFillOrder(order, stock) {
        if (!stock) return false;
        if (order.type === 'limit') {
            if (order.side === 'BUY') return stock.price <= order.trigger;
            return stock.price >= order.trigger;
        }
        if (order.type === 'stop-loss') return order.side === 'SELL' && stock.price <= order.trigger;
        if (order.type === 'take-profit') return order.side === 'SELL' && stock.price >= order.trigger;
        return false;
    }

    function executeOrderNow(order, fillPrice, fromPending) {
        const sym = order.symbol;
        const qty = order.qty;
        const price = fillPrice;
        const held = portfolio[sym] || 0;
        let realized = 0;

        if (order.side === 'BUY') {
            const cost = price * qty;
            if (cash * leverage < cost) { if (!fromPending) alert('Insufficient Buying Power!'); return false; }
            cash -= cost;
            portfolio[sym] = held + qty;
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.shares += qty;
            cb.totalCost += cost;
            costBasis[sym] = cb;
        } else {
            if (held < qty) { if (!fromPending) alert('Not enough shares to sell.'); return false; }
            const avg = avgCost(sym);
            realized = (price - avg) * qty;
            cash += price * qty;
            portfolio[sym] = held - qty;
            if (portfolio[sym] <= 0) delete portfolio[sym];
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.totalCost = Math.max(0, cb.totalCost - avg * qty);
            cb.shares = Math.max(0, cb.shares - qty);
            if (cb.shares === 0) delete costBasis[sym]; else costBasis[sym] = cb;
            currentUser.realizedPL = Number(currentUser.realizedPL || 0) + realized;
        }

        transactions.unshift({
            id: 'tx_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
            symbol: sym,
            side: order.side,
            qty,
            price,
            orderType: order.type,
            realizedPL: realized,
            timestamp: Date.now()
        });
        transactions = transactions.slice(0, 300);
        ensureDailyQuest();
        dailyQuest.totalTrades += 1;
        if (realized > 0) dailyQuest.profitableTrades += 1;
        updateStreak();
        checkAchievements();
        if (fromPending) {
            order.status = 'FILLED';
            order.filledAt = Date.now();
            order.fillPrice = price;
        }
        updateUI();
        renderPendingOrders();
        saveUserData(true);
        onTutorialEvent(order.side === 'BUY' ? 'buy_trade' : 'sell_trade');
        return true;
    }

    function updateStreak() {
        const today = dayKey();
        if (!tradeStreak.lastDay) { tradeStreak = { count: 1, lastDay: today }; return; }
        if (tradeStreak.lastDay === today) return;
        const prev = new Date(tradeStreak.lastDay + 'T00:00:00');
        const now = new Date(today + 'T00:00:00');
        const diff = Math.round((now - prev) / 86400000);
        tradeStreak.count = diff === 1 ? (tradeStreak.count + 1) : 1;
        tradeStreak.lastDay = today;
    }

    function checkAchievements() {
        const names = new Set(achievements.map(a => a.name));
        const totalTrades = currentUser.totalTrades || 0;
        const realized = Number(currentUser.realizedPL || 0);
        const maybeAdd = (name) => { if (!names.has(name)) achievements.unshift({ name, at: Date.now() }); };
        if (totalTrades >= 10) maybeAdd('First 10 Trades');
        if (totalTrades >= 50) maybeAdd('Active Trader');
        if (realized >= 1000) maybeAdd('Profit Hunter');
        if (tradeStreak.count >= 3) maybeAdd('3-Day Streak');
        if (dailyQuest.profitableTrades >= 3) maybeAdd('Quest: 3 Profitable Trades');
        achievements = achievements.slice(0, 20);
    }

    function renderHistory() {
        const el = document.getElementById('historyList');
        if (!el) return;
        if (transactions.length === 0) {
            el.innerHTML = '<div style="color:#8888a8;text-align:center;padding:12px 0;font-style:italic;">No trades yet.</div>';
            return;
        }
        el.innerHTML = transactions.slice(0, 20).map(t => {
            const isBuy  = t.side === 'BUY';
            const badgeStyle = isBuy
                ? 'background:rgba(34,197,94,0.15);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const plHtml = t.side === 'SELL'
                ? `<span style="font-weight:600;margin-left:6px;font-size:10px;color:${t.realizedPL >= 0 ? '#4ade80' : '#f87171'}">${t.realizedPL >= 0 ? '+' : ''}${fmtMoney(t.realizedPL)}</span>`
                : '';
            const time = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `<div data-tx-id="${t.id}" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;margin-bottom:4px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;${badgeStyle}">${t.side}</span>
                    <span style="font-size:12px;color:#c0c0d8;">${t.qty} √ó <strong style="color:#e8e8f5;">${t.symbol}</strong></span>
                    ${plHtml}
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px;font-weight:600;color:#e0e0f5;font-family:var(--v-mono);">$${t.price.toFixed(2)}</div>
                    <div style="font-size:10px;color:#606080;">${time}</div>
                </div>
            </div>`;
        }).join('');
    }

    function renderAnalytics() {
        const realized = Number(currentUser && currentUser.realizedPL || 0);
        let unrealized = 0;
        const alloc    = [];
        const sectors  = {};

        Object.keys(portfolio).forEach(sym => {
            const st = getStockBySymbol(sym);
            if (!st) return;
            const qty = portfolio[sym];
            const val = st.price * qty;
            alloc.push({ sym, val });
            const avg = avgCost(sym);
            unrealized += (st.price - avg) * qty;
            sectors[st.sector] = (sectors[st.sector] || 0) + val;
        });

        // Realized / Unrealized P&L
        const rEl = document.getElementById('realizedPL');
        const uEl = document.getElementById('unrealizedPL');
        if (rEl) {
            rEl.innerText  = (realized   >= 0 ? '+' : '') + fmtMoney(realized);
            rEl.style.color = realized   >= 0 ? '#4ade80' : '#f87171';
        }
        if (uEl) {
            uEl.innerText  = (unrealized >= 0 ? '+' : '') + fmtMoney(unrealized);
            uEl.style.color = unrealized >= 0 ? '#4ade80' : '#f87171';
        }

        // Sector exposure
        const secEl = document.getElementById('sectorExposure');
        if (secEl) {
            const total = Object.values(sectors).reduce((a,b)=>a+b,0) || 1;
            const sorted = Object.entries(sectors).sort((a,b)=>b[1]-a[1]).slice(0,5);
            if (sorted.length === 0) {
                secEl.innerHTML = '<div class="text-gray-400">No positions yet.</div>';
            } else {
                secEl.innerHTML = sorted.map(([k,v]) => {
                    const pct = ((v/total)*100).toFixed(1);
                    return `<div class="flex justify-between items-center">
                        <span class="text-gray-600">${k}</span>
                        <div class="flex items-center gap-2">
                            <div class="h-1.5 rounded-full bg-blue-400" style="width:${Math.round(pct)}px"></div>
                            <span class="font-semibold">${pct}%</span>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // Pie chart ‚Äî update data instead of destroying/recreating
        const canvas = document.getElementById('allocationChart');
        if (!canvas) return;
        const labels = alloc.slice(0,8).map(x => x.sym);
        const values = alloc.slice(0,8).map(x => x.val);
        const COLORS  = ['#1a73e8','#34a853','#fbbc05','#ea4335','#7baaf7','#81c995','#fdd663','#f28b82'];

        if (allocationChart && allocationChart.data) {
            // Update existing chart data without destroying it
            allocationChart.data.labels   = labels;
            allocationChart.data.datasets[0].data = values.length ? values : [1];
            allocationChart.data.datasets[0].backgroundColor = values.length ? COLORS : ['#e0e0e0'];
            allocationChart.update('none'); // 'none' = no animation, instant
        } else {
            if (allocationChart) allocationChart.destroy();
            allocationChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: labels.length ? labels : ['Empty'],
                    datasets: [{ data: values.length ? values : [1], backgroundColor: values.length ? COLORS : ['#e0e0e0'] }]
                },
                options: {
                    plugins: { legend: { display: false }, tooltip: {
                        callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString(undefined,{maximumFractionDigits:0})}` }
                    }},
                    maintainAspectRatio: false,
                    animation: { duration: 300 }
                }
            });
        }
    }

    function renderQuestsAndAchievements() {
        ensureDailyQuest();

        // Daily quests with progress bars
        const quest = document.getElementById('questList');
        if (quest) {
            const pTrades   = Math.min(dailyQuest.profitableTrades, 3);
            const tTrades   = Math.min(dailyQuest.totalTrades, 5);
            const pPct      = (pTrades / 3 * 100).toFixed(0);
            const tPct      = (tTrades / 5 * 100).toFixed(0);
            const pDone     = pTrades >= 3;
            const tDone     = tTrades >= 5;
            quest.innerHTML = `
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span>${pDone ? '‚úÖ' : 'üéØ'} Profitable trades</span>
                        <span class="font-bold ${pDone ? 'text-green-600' : ''}">${pTrades}/3</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${pPct}%;background:${pDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span>${tDone ? '‚úÖ' : 'üìä'} Total trades today</span>
                        <span class="font-bold ${tDone ? 'text-green-600' : ''}">${tTrades}/5</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${tPct}%;background:${tDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>`;
        }

        // Streak
        const streak = document.getElementById('tradeStreak');
        if (streak) streak.innerText = (tradeStreak.count || 0) + ' day' + (tradeStreak.count !== 1 ? 's' : '');

        // Achievements
        const ach = document.getElementById('achievementList');
        if (ach) {
            ach.innerHTML = achievements.slice(0,8).map(a =>
                `<span class="text-xs bg-yellow-50 border border-yellow-200 text-yellow-800 px-2 py-1 rounded">üèÖ ${a.name}</span>`
            ).join('') || '<span class="text-xs text-gray-400">Complete trades to earn badges.</span>';
        }
    }

    function renderNews() {
        const feed = document.getElementById('newsFeed');
        if (!feed) return;
        const movers = stocks.slice().sort((a,b)=>Math.abs(b.change)-Math.abs(a.change)).slice(0,4);
        feed.innerHTML = movers.map((s, i) => {
            const pos = s.change >= 0;
            const sentiment = pos ? 'Bullish' : 'Bearish';
            const tagStyle = pos
                ? 'background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const source = ['Reuters','Bloomberg','CNBC','WSJ'][i % 4];
            const headline = pos ? (s.symbol + ' climbs as momentum buyers step in') : (s.symbol + ' slips as sellers pressure the tape');
            return '<div style="padding:14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;background:#1a1a24;">'
                + '<div style="font-size:11px;color:#8888a8;margin-bottom:6px;"><span style="font-weight:700;color:#b0b0c8;">' + source + '</span> ¬∑ ' + (15 + i * 10) + ' min ago</div>'
                + '<div style="font-size:0.875rem;font-weight:500;color:#e0e0f5;line-height:1.4;margin-bottom:8px;">' + headline + '</div>'
                + '<div style="display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;' + tagStyle + '">' + sentiment + '</div>'
                + '</div>';
        }).join('');
    }

    function renderDetailNews(symbol) {
        const el = document.getElementById('detailNews');
        if (!el || !symbol) return;
        const st = getStockBySymbol(symbol);
        const pos = st && st.change >= 0;
        const t1 = pos ? 'Analysts raise short-term outlook for ' + symbol : 'Analysts cut near-term targets for ' + symbol;
        const t2 = pos ? symbol + ' options flow shows bullish positioning' : symbol + ' sees defensive hedging activity';
        el.innerHTML = '<div class="text-xs text-gray-300">Ticker News</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t1 + '</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t2 + '</div>';
    }

    function processPendingOrders() {
        let changed = false;
        pendingOrders.forEach(o => {
            if (o.status !== 'OPEN') return;
            const st = getStockBySymbol(o.symbol);
            if (shouldFillOrder(o, st)) {
                const ok = executeOrderNow(o, st.price, true);
                if (ok) changed = true;
            }
        });
        if (changed) saveUserData(false);
    }

    function processAlerts() {
        let fired = false;
        priceAlerts.forEach(a => {
            if (a.triggered) return;
            const st = getStockBySymbol(a.symbol);
            if (!st) return;
            const cond = (a.type === 'above' && st.price >= a.value)
                || (a.type === 'below' && st.price <= a.value)
                || (a.type === 'move' && Math.abs(st.change) >= a.value);
            if (cond) {
                a.triggered = true;
                alertEvents.unshift('Alert hit: ' + a.symbol + ' ' + a.type + ' ' + a.value);
                alertEvents = alertEvents.slice(0, 8);
                fired = true;
            }
        });
        if (fired) {
            renderAlerts();
            saveUserData(false);
        }
    }

    function simulateMarketTick() {
        stocks.forEach(s => {
            // Skip simulation for stocks that have fresh live data (< 30 sec old)
            const cached = RT.cache[s.symbol];
            if (cached && RT.key && (Date.now() - cached.ts) < 30000) return;

            const drift = (Math.random() - 0.5) * 0.018;
            s.price = Math.max(1, s.price * (1 + drift));
            s.change = Math.max(-30, Math.min(30, s.change + drift * 100));
        });
        renderGrid();
        updateUI();
        processPendingOrders();
        processAlerts();
        renderNews();
        // If detail page is open, update just the price fields ‚Äî never re-open it
        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
    }

    // Update price/change fields on the detail page without touching anything else
    function updateDetailPriceFields(s) {
        const isPos = s.change >= 0;
        const changeAmt = s.price * Math.abs(s.change) / 100;
        const color = isPos ? '#81c995' : '#f28b82';
        const priceEl = document.getElementById('detailPrice');
        if (priceEl) priceEl.innerText = s.price.toFixed(2);
        const caEl = document.getElementById('detailChangeAmt');
        if (caEl) { caEl.style.color = color; caEl.innerText = (isPos?'+':'-') + changeAmt.toFixed(2); }
        const cpEl = document.getElementById('detailChangePct');
        if (cpEl) { cpEl.style.color = color; cpEl.innerText = '(' + Math.abs(s.change).toFixed(2) + '%)'; }
        const arEl = document.getElementById('detailArrow');
        if (arEl) { arEl.style.color = color; arEl.innerText = isPos ? '‚Üë' : '‚Üì'; }
        const bpEl = document.getElementById('dBuyPow');
        if (bpEl) bpEl.innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function exportPortfolioData() {
        if (!currentUser) return;
        const payload = {
            username: currentUser.username,
            displayName: currentUser.displayName,
            cash,
            portfolio,
            watchlist,
            priceAlerts,
            pendingOrders,
            transactions,
            costBasis,
            achievements,
            tradeStreak,
            dailyQuest,
            realizedPL: Number(currentUser.realizedPL || 0)
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'portfolio-' + currentUser.username + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importPortfolioData(event) {
        const file = event.target.files && event.target.files[0];
        if (!file || !currentUser) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                cash = Number(data.cash || 100000);
                portfolio = data.portfolio || {};
                watchlist = Array.isArray(data.watchlist) ? data.watchlist : [];
                priceAlerts = Array.isArray(data.priceAlerts) ? data.priceAlerts : [];
                pendingOrders = Array.isArray(data.pendingOrders) ? data.pendingOrders : [];
                transactions = Array.isArray(data.transactions) ? data.transactions : [];
                costBasis = data.costBasis || {};
                achievements = Array.isArray(data.achievements) ? data.achievements : [];
                tradeStreak = data.tradeStreak || { count: 0, lastDay: '' };
                dailyQuest = data.dailyQuest || { date: '', profitableTrades: 0, totalTrades: 0 };
                currentUser.realizedPL = Number(data.realizedPL || 0);
                updateUI();
                saveUserData(false);
                alert('Import complete.');
            } catch (e) {
                alert('Invalid import file.');
            }
        };
        reader.readAsText(file);
    }

    const tutorialSteps = [
        {
            icon: 'üëã',
            title: 'Welcome to Vestra',
            desc: 'Your risk-free trading simulator. Practice buying and selling real stocks with $100,000 in virtual cash ‚Äî no real money, no real risk.',
            hint: null,
            event: null
        },
        {
            icon: 'üìä',
            title: 'Browse the Market',
            desc: 'The main grid shows live stock prices updating in real-time. Search for any ticker or company name in the search bar above.',
            hint: 'üëÜ Try clicking on any stock card to open its detail page',
            event: 'open_stock'
        },
        {
            icon: '‚ö°',
            title: 'Connect Live Data',
            desc: 'Click the "‚ö° Live Data" button in the header to connect your Finnhub API key. This enables real-time prices and candlestick charts. Without it, trading is disabled.',
            hint: 'You need a free API key from finnhub.io to trade',
            event: null
        },
        {
            icon: 'üí∏',
            title: 'Place Your First Buy',
            desc: 'Open any stock, set the quantity, make sure "Market" order is selected, then hit the green Buy button. Your shares and portfolio update instantly.',
            hint: 'üü¢ Market orders fill immediately at the current price',
            event: 'buy_trade'
        },
        {
            icon: 'üìà',
            title: 'Track Your Portfolio',
            desc: 'The right sidebar shows your total equity, unrealized P&L, sector exposure, and transaction history ‚Äî all updating live as prices move.',
            hint: null,
            event: null
        },
        {
            icon: 'üèÜ',
            title: 'Compete on the Leaderboard',
            desc: 'Every trade updates your rank. Click the Leaderboard button to see how you stack up against other traders globally.',
            hint: null,
            event: null
        },
        {
            icon: 'üéØ',
            title: 'You\'re Ready to Trade',
            desc: 'Complete daily quests, unlock achievements, and grow your virtual portfolio. Remember ‚Äî Vestra is trading with no risk.',
            hint: 'üöÄ Good luck, trader!',
            event: null
        }
    ];

    function renderTutorialStep() {
        const step = tutorialState.step;
        const s = tutorialSteps[step];
        const total = tutorialSteps.length;

        document.getElementById('tutorialIcon').textContent  = s.icon;
        document.getElementById('tutorialTitle').textContent = s.title;
        document.getElementById('tutorialDesc').textContent  = s.desc;

        const hintEl = document.getElementById('tutorialHint');
        if (s.hint) { hintEl.textContent = s.hint; hintEl.classList.remove('hidden'); }
        else { hintEl.classList.add('hidden'); }

        // Progress fill
        document.getElementById('tutorialProgressFill').style.width = ((step / (total - 1)) * 100) + '%';

        // Dots
        const dotsEl = document.getElementById('tutorialDots');
        dotsEl.innerHTML = tutorialSteps.map((_, i) =>
            `<div class="rounded-full transition-all duration-300" style="width:${i===step?'20px':'8px'};height:8px;background:${i===step?'#a78bfa':i<step?'rgba(167,139,250,0.5)':'rgba(255,255,255,0.15)'}"></div>`
        ).join('');

        // Back button
        const prevBtn = document.getElementById('tutorialPrevBtn');
        if (step > 0) prevBtn.classList.remove('hidden'); else prevBtn.classList.add('hidden');

        // Next button label
        const nextBtn = document.getElementById('tutorialNextBtn');
        nextBtn.textContent = step === total - 1 ? 'üöÄ Start Trading' : 'Continue ‚Üí';
    }

    function startTutorial(forceOpen) {
        if (!forceOpen && currentUser && currentUser.tutorialDone) return;
        tutorialState.active = true;
        tutorialState.step   = 0;
        document.getElementById('tutorialOverlay').classList.remove('hidden');
        renderTutorialStep();
    }

    function tutorialNext() {
        const total = tutorialSteps.length;
        if (tutorialState.step >= total - 1) { skipTutorial(); return; }
        tutorialState.step++;
        renderTutorialStep();
    }

    function tutorialPrev() {
        if (tutorialState.step <= 0) return;
        tutorialState.step--;
        renderTutorialStep();
    }

    function skipTutorial() {
        tutorialState.active = false;
        document.getElementById('tutorialOverlay').classList.add('hidden');
        if (currentUser) { currentUser.tutorialDone = true; saveUserData(false); }
    }

    function nextTutorialStep() { tutorialNext(); } // legacy alias

    function onTutorialEvent(eventName) {
        if (!tutorialState.active) return;
        const step = tutorialSteps[tutorialState.step];
        if (step && step.event === eventName) {
            setTimeout(() => tutorialNext(), 600); // slight delay so user sees the action
        }
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //   REAL-TIME DATA ENGINE ‚Äî Finnhub Integration
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    // --- Config ---
    const RT = {
        key: localStorage.getItem('finnhub_api_key') || '',
        interval: 10000,
        timer: null,
        cache: {},
        queue: [],
        queueIdx: 0,
        liveCount: 0,
        batchSize: 10,
    };

    // Priority symbols: watchlist + portfolio + top 20, then rest
    function buildQueue() {
        const priority = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const rest = stocks.filter(s => !priority.has(s.symbol)).map(s => s.symbol);
        RT.queue = [...priority, ...rest];
        // Do NOT reset queueIdx here ‚Äî we want to cycle through all stocks over time
    }

    // Fetch a single quote from Finnhub
    async function fetchQuote(symbol) {
        if (!RT.key) return null;
        try {
            const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${RT.key}`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            if (!data.c || data.c === 0) return null;
            return data;
        } catch (e) { return null; }
    }

    // Apply a real quote to our stock object
    function applyRealQuote(symbol, data) {
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const newPrice = data.c;
        if (!newPrice || newPrice <= 0) return;
        stock.price  = newPrice;
        stock.change = (data.dp != null) ? data.dp : stock.change;
        if (data.h)  stock.dayHigh   = data.h;
        if (data.l)  stock.dayLow    = data.l;
        if (data.o)  stock.dayOpen   = data.o;
        if (data.pc) stock.prevClose = data.pc;
        RT.cache[symbol] = { price: newPrice, change: stock.change, ts: Date.now() };
        RT.liveCount++;
    }

    // Batch-fetch: priority stocks every cycle, rest rotate
    async function fetchNextBatch() {
        if (!RT.key) return;

        const prioritySet = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...(detailStock ? [detailStock.symbol] : []),
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const prioritySyms = [...prioritySet];
        const restSyms = stocks.filter(s => !prioritySet.has(s.symbol)).map(s => s.symbol);

        if (RT.queueIdx >= restSyms.length) RT.queueIdx = 0;
        const rotatingBatch = restSyms.slice(RT.queueIdx, RT.queueIdx + 10);
        RT.queueIdx += 10;

        const batch = [...new Set([...prioritySyms, ...rotatingBatch])];

        RT.liveCount = 0;
        await Promise.all(batch.map(async sym => {
            const data = await fetchQuote(sym);
            if (data) applyRealQuote(sym, data);
        }));

        renderGrid();
        updateUI();

        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
        updateDataSourceUI();
    }

    // Start/stop the live data loop
    function startLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        fetchNextBatch(); // immediate first fetch
        RT.timer = setInterval(fetchNextBatch, RT.interval);
        updateMarketStatus();
    }

    function stopLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        RT.timer = null;
        RT.liveCount = 0;
        updateDataSourceUI();
    }

    // --- Market Hours (NYSE) ---
    function isMarketOpen() {
        const now = new Date();
        // Convert to Eastern Time
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay(); // 0=Sun, 6=Sat
        if (day === 0 || day === 6) return false;
        const h = et.getHours(), m = et.getMinutes();
        const mins = h * 60 + m;
        return mins >= 9 * 60 + 30 && mins < 16 * 60;
    }

    function updateMarketStatus() {
        const dot  = document.getElementById('marketStatusDot');
        const text = document.getElementById('marketStatusText');
        if (!dot || !text) return;
        if (isMarketOpen()) {
            dot.className  = 'w-2 h-2 rounded-full dot-live';
            text.textContent = 'Market Open';
            text.className   = 'text-xs text-green-600 font-semibold';
        } else {
            dot.className  = 'w-2 h-2 rounded-full dot-closed';
            text.textContent = 'Market Closed';
            text.className   = 'text-xs text-gray-500 font-medium';
        }
    }

    function updateDataSourceUI() {
        const badge = document.getElementById('dataSourceBadge');
        const btn   = document.getElementById('liveDataBtn');
        if (!badge) return;
        if (RT.key && RT.liveCount > 0) {
            badge.textContent = '‚ö° LIVE';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-live';
            if (btn) { btn.textContent = '‚ö° Live: ON'; btn.style.cssText = 'font-size:11px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.35);color:#4ade80;padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        } else if (RT.key) {
            badge.textContent = '‚Üª Fetching‚Ä¶';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-stale';
        } else {
            badge.textContent = 'SIM';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-sim';
            if (btn) { btn.textContent = '‚ö° Live Data'; btn.style.cssText = 'font-size:11px;background:rgba(212,168,75,0.12);border:1px solid rgba(212,168,75,0.3);color:var(--v-gold);padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        }
    }

    // Data freshness per card
    function getCardFreshnessLabel(symbol) {
        const cached = RT.cache[symbol];
        if (!cached || !RT.key) return '';
        const ageSec = Math.round((Date.now() - cached.ts) / 1000);
        return `<span class="text-[9px] font-semibold badge-live rounded px-1 ml-1">live¬∑${ageSec}s</span>`;
    }

    // --- API Config Modal ---
    function openApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        // Only pre-fill if the user themselves previously saved a key
        const savedKey = localStorage.getItem('finnhub_api_key') || '';
        document.getElementById('finnhubKeyInput').value = savedKey;
        document.getElementById('updateIntervalInput').value = RT.interval || 10000;
        document.getElementById('apiConfigError').style.display = 'none';
        document.getElementById('apiTestResult').style.display = 'none';
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }

    function closeApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        modal.classList.add('hidden');
        modal.style.display = '';
    }

    async function saveApiConfig() {
        const key      = document.getElementById('finnhubKeyInput').value.trim();
        const interval = Number(document.getElementById('updateIntervalInput').value);
        const errEl    = document.getElementById('apiConfigError');
        const resultEl = document.getElementById('apiTestResult');

        errEl.classList.add('hidden');
        resultEl.classList.remove('hidden');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';

        if (!key) {
            errEl.textContent = '‚ö†Ô∏è Please enter an API key.';
            errEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            return;
        }

        // Save immediately without network test (network is blocked in preview environments)
        RT.key      = key;
        RT.interval = interval;
        localStorage.setItem('finnhub_api_key', key);
        localStorage.setItem('finnhub_interval', interval);

        resultEl.style.cssText = 'margin-top:12px;font-size:13px;text-align:center;color:#4ade80;font-weight:600;display:block;';
        resultEl.textContent = '‚úÖ Key saved! Live data will activate when opened locally.';

        // Try a live test ‚Äî works when opened as a local file, silently skips if blocked
        try {
            const testUrl = `https://finnhub.io/api/v1/quote?symbol=AAPL&token=${key}`;
            const res = await fetch(testUrl);
            const data = await res.json();
            if (data.c && data.c > 0) {
                resultEl.textContent = `‚úÖ Connected! AAPL = $${data.c.toFixed(2)}`;
                startLiveData();
                setTimeout(closeApiConfig, 1800);
                return;
            }
        } catch(e) {
            // Network blocked (e.g. running in Claude preview) ‚Äî key is still saved
        }

        startLiveData(); // will gracefully no-op if network blocked
        updateDataSourceUI();
        setTimeout(closeApiConfig, 2200);
    }

    function clearApiConfig() {
        RT.key = '';
        localStorage.removeItem('finnhub_api_key');
        localStorage.removeItem('finnhub_interval');
        stopLiveData();
        document.getElementById('finnhubKeyInput').value = '';
        document.getElementById('apiTestResult').classList.add('hidden');
        const resultEl = document.getElementById('apiTestResult');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';
        resultEl.textContent = 'Live data cleared. Using simulated mode.';
        resultEl.classList.remove('hidden');
        updateDataSourceUI();
        setTimeout(closeApiConfig, 1500);
    }

    // Click outside modal to close
    document.getElementById('apiConfigModal').addEventListener('click', function(e) {
        if (e.target === this) closeApiConfig();
    });

    // Update market status every minute
    setInterval(updateMarketStatus, 60000);

    // ‚ïê‚ïê‚ïê END REAL-TIME DATA ENGINE ‚ïê‚ïê‚ïê

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //   HOMEPAGE LOGIC
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

    function showHomepage() {
        document.getElementById('homePage').style.display = 'block';
        document.getElementById('appPage').style.display  = 'none';
        document.getElementById('authOverlay').style.display = 'none';
        drawHeroChart();
        initTicker();
    }

    function showApp() {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('appPage').style.display  = 'block';
        document.getElementById('authOverlay').style.display = 'none';
    }

    function showAuthFromHome(mode) {
        authMode = mode;
        const isRegister = mode === 'register';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isRegister);
        document.getElementById('authTitle').textContent    = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authSubtitle').textContent = isRegister ? 'Join Vestra ‚Äî it\'s free' : 'to your trading account';
        document.getElementById('authSubmitBtn').textContent = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').textContent = isRegister ? 'Already have an account?' : 'Don\'t have an account?';
        document.getElementById('authToggleBtn').textContent  = isRegister ? 'Sign in' : 'Create account';
        document.getElementById('authOverlay').style.display = 'flex';
    }

    function scrollToSection(id) {
        document.getElementById(id)?.scrollIntoView({ behavior: 'smooth' });
    }

    function drawHeroChart() {
        const canvas = document.getElementById('heroChart');
        if (!canvas) return;
        const W = canvas.parentElement.clientWidth - 48;
        const H = 140;
        const dpr = window.devicePixelRatio || 1;
        canvas.width  = W * dpr;
        canvas.height = H * dpr;
        canvas.style.width  = W + 'px';
        canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const pts = 80;
        const values = [];
        let v = 180;
        for (let i = 0; i < pts; i++) { v += (Math.random() - 0.42) * 4; values.push(Math.max(140, v)); }
        const min = Math.min(...values), max = Math.max(...values);
        const toX = i => (i / (pts - 1)) * W;
        const toY = v => H - ((v - min) / (max - min + 1)) * (H - 16) - 8;

        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, 'rgba(201,168,76,0.25)');
        grad.addColorStop(1, 'rgba(201,168,76,0)');
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
        ctx.fillStyle = grad; ctx.fill();

        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.strokeStyle = '#c9a84c'; ctx.lineWidth = 2; ctx.stroke();

        let base = 214.37;
        setInterval(() => {
            base += (Math.random() - 0.48) * 0.5;
            const el = document.getElementById('heroPrice');
            const ch = document.getElementById('heroChange');
            if (el) el.textContent = '$' + base.toFixed(2);
            if (ch) {
                const pct = ((base - 211.74) / 211.74 * 100).toFixed(2);
                ch.textContent = (pct >= 0 ? '+' : '') + pct + '%';
                ch.style.color = pct >= 0 ? '#4ade80' : '#f87171';
            }
        }, 2000);
    }

    function initTicker() {
        const items = ['AAPL $214.37 +1.2%','TSLA $248.12 +0.8%','MSFT $415.23 +0.5%','NVDA $138.42 +3.1%','AMZN $224.18 -0.3%','META $612.45 +1.7%','GOOGL $198.23 +0.4%','JPM $281.43 +0.9%','V $341.27 +0.6%','WMT $98.45 +1.1%','XOM $112.34 +0.7%','HD $387.12 +0.8%'];
        const html = items.map(t => {
            const pos = t.includes('+');
            return `<span style="display:inline-block;padding:0 32px;font-family:var(--v-mono);font-size:0.8rem;color:${pos?'#4ade80':'#f87171'};">${t}</span>`;
        }).join('');
        ['tickerInner','tickerInner2'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
    }

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    initMarket();  // pre-load stock data
    showHomepage(); // start on homepage

</script>
</body>
</html>
