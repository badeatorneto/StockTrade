<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vestra â€” Trading With No Risk</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.1.1/dist/chartjs-chart-financial.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --v-bg: #0a0a0f;
            --v-surface: #111118;
            --v-card: #1a1a24;
            --v-border: rgba(255,255,255,0.12);
            --v-gold: #d4a84b;
            --v-gold-light: #f0c96a;
            --v-green: #22c55e;
            --v-red: #ef4444;
            --v-text: #f5f5fa;
            --v-muted: #a0a0b8;
            --v-serif: 'DM Serif Display', serif;
            --v-sans: 'DM Sans', sans-serif;
            --v-mono: 'JetBrains Mono', monospace;
        }
        * { box-sizing: border-box; }
        body { font-family: var(--v-sans); background: var(--v-bg); color: var(--v-text); overflow-x: hidden; }
        .vestra-brand { font-family: var(--v-serif); }

        /* â”€â”€ Homepage â”€â”€ */
        #homePage { display: block; }
        #appPage  { display: none; }

        /* Hero gradient orbs */
        .orb {
            position: absolute; border-radius: 50%; filter: blur(80px); pointer-events: none;
        }

        /* Nav */
        .home-nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            padding: 0 48px; height: 72px;
            display: flex; align-items: center; justify-content: space-between;
            background: rgba(10,10,15,0.85); backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .home-nav .logo { font-family: var(--v-serif); font-size: 1.75rem; color: #ffffff; }
        .nav-btn {
            padding: 9px 22px; border-radius: 8px; font-family: var(--v-sans);
            font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s;
            border: none;
        }
        .nav-btn-ghost { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2) !important; color: #e0e0f0; }
        .nav-btn-ghost:hover { background: rgba(255,255,255,0.12); border-color: var(--v-gold) !important; color: var(--v-gold); }
        .nav-btn-gold { background: var(--v-gold); color: #0a0a0f; font-weight: 700; }
        .nav-btn-gold:hover { background: var(--v-gold-light); }

        /* Sections */
        section { position: relative; z-index: 1; }

        /* Feature cards */
        .feat-card {
            background: #1e1e2a; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px; padding: 32px; transition: all 0.3s;
        }
        .feat-card h3 { color: #ffffff; }
        .feat-card p  { color: #b0b0c8; }
        .feat-card:hover { border-color: rgba(212,168,75,0.4); transform: translateY(-4px); box-shadow: 0 20px 60px rgba(0,0,0,0.5); }

        /* Ticker tape */
        .ticker-wrap { overflow: hidden; background: #0e0e16; border-top: 1px solid rgba(255,255,255,0.08); border-bottom: 1px solid rgba(255,255,255,0.08); }
        .ticker { display: flex; animation: tickerScroll 40s linear infinite; white-space: nowrap; }
        .ticker:hover { animation-play-state: paused; }
        @keyframes tickerScroll { from{transform:translateX(0)} to{transform:translateX(-50%)} }

        /* Stats counter */
        .stat-num { font-family: var(--v-serif); font-size: 3rem; color: var(--v-gold); line-height: 1; }
        .stat-label { color: #9090aa; margin-top: 8px; font-size: 0.9rem; }

        /* Step circles */
        .step-num {
            width: 48px; height: 48px; border-radius: 50%;
            background: rgba(212,168,75,0.1);
            border: 1.5px solid var(--v-gold); color: var(--v-gold);
            font-family: var(--v-serif); font-size: 1.25rem;
            display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }

        /* Gold divider */
        .gold-line { height: 1px; background: linear-gradient(90deg, transparent, rgba(212,168,75,0.5), transparent); }

        /* Footer */
        footer { position: relative; z-index: 1; border-top: 1px solid rgba(255,255,255,0.08); }
        .social-link {
            display: inline-flex; align-items: center; gap: 10px;
            color: #9090aa; text-decoration: none; font-size: 0.875rem;
            transition: color 0.2s; padding: 8px 0;
        }
        .social-link:hover { color: var(--v-gold); }
        .social-icon { width: 36px; height: 36px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.15); color: #b0b0c8; display: flex; align-items: center; justify-content: center; transition: border-color 0.2s; }
        .social-link:hover .social-icon { border-color: var(--v-gold); color: var(--v-gold); }

        /* â”€â”€ App UI â”€â”€ */
        .app-header {
            background: var(--v-surface); border-bottom: 1px solid var(--v-border);
            position: sticky; top: 0; z-index: 50;
        }
        .g-card {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 12px; transition: box-shadow 0.2s, border-color 0.2s, transform 0.1s;
        }
        .g-card:hover { border-color: rgba(201,168,76,0.3); box-shadow: 0 4px 20px rgba(0,0,0,0.25); }
        .search-bar {
            background: var(--v-card); border: 1px solid var(--v-border);
            border-radius: 24px; transition: 0.2s;
        }
        .search-bar:focus-within { border-color: var(--v-gold); box-shadow: 0 0 0 3px rgba(201,168,76,0.1); }
        .search-bar input { color: var(--v-text); }
        .search-bar input::placeholder { color: var(--v-muted); }
        .btn-google { background: var(--v-gold); color: #0a0a0f; border-radius: 8px; font-weight: 600; padding: 8px 20px; transition: 0.2s; }
        .btn-google:hover { background: var(--v-gold-light); }
        .btn-outline { border: 1px solid var(--v-border); color: var(--v-muted); border-radius: 8px; font-weight: 500; padding: 8px 20px; transition: 0.2s; }
        .btn-outline:hover { border-color: var(--v-gold); color: var(--v-gold); }
        .change-pill { padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; font-family: var(--v-mono); display: inline-flex; align-items: center; }
        .pill-up   { background: rgba(34,197,94,0.12);  color: #4ade80; }
        .pill-down { background: rgba(239,68,68,0.12);  color: #f87171; }
        .badge-live  { background: rgba(34,197,94,0.15); color: #4ade80; }
        .badge-sim   { background: var(--v-card); color: var(--v-muted); }
        .badge-stale { background: rgba(201,168,76,0.12); color: var(--v-gold); }
        .dot-live    { background: #22c55e; animation: pulse-green 2s infinite; }
        .dot-closed  { background: #ef4444; }
        .dot-unknown { background: #6b7280; }
        @keyframes pulse-green { 0%,100%{opacity:1} 50%{opacity:0.4} }

        /* Tutorial overlay */
        #tutorialOverlay { position:fixed; inset:0; z-index:99999; background:rgba(0,0,0,0.8); backdrop-filter:blur(8px); display:flex; align-items:center; justify-content:center; }
        #tutorialOverlay.hidden { display:none; }
        .tutorial-card { background: var(--v-card); border:1px solid rgba(201,168,76,0.3); border-radius:20px; width:520px; max-width:90vw; overflow:hidden; box-shadow:0 25px 80px rgba(0,0,0,0.7); animation:slideUp 0.35s cubic-bezier(0.16,1,0.3,1); }
        .tutorial-progress-bar  { height:3px; background:var(--v-border); }
        .tutorial-progress-fill { height:3px; background:linear-gradient(90deg,var(--v-gold),var(--v-gold-light)); transition:width 0.5s cubic-bezier(0.16,1,0.3,1); }

        /* App sidebar */
        #appSidebar { background: var(--v-surface); border-left: 1px solid var(--v-border); }
        #appSidebar h3 { color: var(--v-text); }
        #portfolioList .port-val { color: var(--v-text); }

        /* Scrollbar */
        .sidebar-scroll { height: calc(100vh - 200px); overflow-y: auto; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--v-border); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(201,168,76,0.3); }

        /* Animations */
        @keyframes fadeIn  { from{opacity:0} to{opacity:1} }
        @keyframes slideUp { from{opacity:0;transform:translateY(24px)} to{opacity:1;transform:translateY(0)} }
        @keyframes toastIn { from{opacity:0;transform:translateX(-50%) translateY(12px)} to{opacity:1;transform:translateX(-50%) translateY(0)} }
        @keyframes flash-green { 0%{background:rgba(34,197,94,0.15)} 100%{background:transparent} }
        @keyframes flash-red   { 0%{background:rgba(239,68,68,0.15)} 100%{background:transparent} }
        @keyframes heroFade { from{opacity:0;transform:translateY(32px)} to{opacity:1;transform:translateY(0)} }
        .flash-up   { animation: flash-green 0.8s ease-out; }
        .flash-down { animation: flash-red   0.8s ease-out; }
        .stock-price, .change-pill { transition: color 0.3s; }
        .anim-1 { animation: heroFade 0.8s 0.1s both; }
        .anim-2 { animation: heroFade 0.8s 0.3s both; }
        .anim-3 { animation: heroFade 0.8s 0.5s both; }
        .anim-4 { animation: heroFade 0.8s 0.7s both; }

        /* â”€â”€ Light Mode â”€â”€ */
        body.light-mode {
            --v-bg: #f0f2f5;
            --v-surface: #ffffff;
            --v-card: #ffffff;
            --v-border: rgba(0,0,0,0.09);
            --v-text: #0d0d1a;
            --v-muted: #525270;
            --v-gold: #8a6000;
            --v-gold-light: #b07800;
            --v-green: #16a34a;
            --v-red: #dc2626;
        }
        /* App shell */
        body.light-mode { background: #f0f2f5; color: #0d0d1a; }
        body.light-mode .g-card { background: #ffffff; border-color: rgba(0,0,0,0.08); box-shadow: 0 1px 6px rgba(0,0,0,0.07); }
        body.light-mode .app-header { background: #fff !important; border-color: rgba(0,0,0,0.09) !important; }
        body.light-mode .search-bar { background: #eef0f5; border-color: rgba(0,0,0,0.1); }
        body.light-mode .search-bar input { color: #0d0d1a; }
        body.light-mode input:not([type="range"]), body.light-mode select, body.light-mode textarea { background: #eef0f5 !important; color: #0d0d1a !important; border-color: rgba(0,0,0,0.12) !important; }
        /* Stock grid cards */
        body.light-mode [data-symbol] { background: #fff !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode .stock-sym { color: #1a1a2e !important; }
        body.light-mode .stock-price { color: #0d0d1a !important; }
        /* Sidebar */
        body.light-mode aside, body.light-mode #desktopSidebar { background: transparent; }
        body.light-mode #portfolioList > div { border-color: rgba(0,0,0,0.06) !important; }
        /* Headings / labels */
        body.light-mode [style*="color:#e0e0f5"], body.light-mode [style*="color:#f0f0fa"], body.light-mode [style*="color:#e8e8f5"] { color: #1a1a2e !important; }
        body.light-mode [style*="color:#c0c0d8"], body.light-mode [style*="color:#b0b0c8"], body.light-mode [style*="color:#a0a0b8"] { color: #525270 !important; }
        body.light-mode [style*="color:#8888a8"] { color: #7070a0 !important; }
        body.light-mode [style*="color:#606080"] { color: #8080a0 !important; }
        body.light-mode [style*="background:#0f0f18"], body.light-mode [style*="background:#1a1a24"], body.light-mode [style*="background:#1e1e28"] { background: #eef0f5 !important; }
        body.light-mode [style*="background:#0e0e16"] { background: #e8eaf0 !important; }
        body.light-mode [style*="background:rgba(255,255,255,0.03)"], body.light-mode [style*="background:rgba(255,255,255,0.04)"], body.light-mode [style*="background:rgba(255,255,255,0.06)"], body.light-mode [style*="background:rgba(255,255,255,0.08)"] { background: rgba(0,0,0,0.03) !important; }
        body.light-mode [style*="border:1px solid rgba(255,255,255,0.06)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.07)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.08)"], body.light-mode [style*="border:1px solid rgba(255,255,255,0.1)"] { border-color: rgba(0,0,0,0.08) !important; }
        /* Leaderboard + overlays */
        body.light-mode #leaderboardOverlay > div { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #apiConfigModal > div { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #journalModal > div { background: #fff !important; }
        body.light-mode .tutorial-card { background: #fff !important; }
        /* Stock detail page */
        body.light-mode #stockDetailPage { background: #f0f2f5 !important; }
        body.light-mode #stockDetailPage .bg-\[\#1c1c1e\] { background: #f0f2f5 !important; }
        body.light-mode #stockDetailPage .bg-\[\#2c2c2e\] { background: #ffffff !important; }
        body.light-mode #stockDetailPage .bg-\[\#1e1e28\] { background: #ffffff !important; }
        body.light-mode #stockDetailPage .border-gray-700 { border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #stockDetailPage .text-gray-400, body.light-mode #stockDetailPage .text-gray-500 { color: #6060a0 !important; }
        body.light-mode #stockDetailPage .text-white, body.light-mode #stockDetailPage .text-gray-800, body.light-mode #stockDetailPage .text-gray-900 { color: #0d0d1a !important; }
        body.light-mode #stockDetailPage select, body.light-mode #stockDetailPage input { background: #eef0f5 !important; color: #0d0d1a !important; border-color: rgba(0,0,0,0.15) !important; }
        /* Toast */
        body.light-mode #themeToggle { background: rgba(0,0,0,0.05); border-color: rgba(0,0,0,0.1); }
        /* News feed cards */
        body.light-mode #newsFeed > div { background: #fff !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode #newsFeed > div > div[style*="color:#e0e0f5"] { color: #1a1a2e !important; }
        /* Analyst cards */
        body.light-mode #analystRatings, body.light-mode #earningsData > div, body.light-mode #similarStocks button { background: #eef0f5 !important; border-color: rgba(0,0,0,0.08) !important; }
        body.light-mode .analyst-bar { background: rgba(0,0,0,0.07) !important; }
        /* Scrollbar */
        body.light-mode ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); }

        /* â”€â”€ Search Dropdown â”€â”€ */
        #searchWrap { position: relative; flex: 1; max-width: 42rem; }
        #searchDropdown {
            position: absolute; top: calc(100% + 8px); left: 0; right: 0; z-index: 999;
            background: #1a1a24; border: 1px solid rgba(255,255,255,0.12);
            border-radius: 14px; overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-height: 420px; overflow-y: auto;
        }
        body.light-mode #searchDropdown { background: #fff; border-color: rgba(0,0,0,0.1); box-shadow: 0 8px 32px rgba(0,0,0,0.15); }
        .search-result-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 12px 16px; cursor: pointer; transition: background 0.1s;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .search-result-item:last-child { border-bottom: none; }
        .search-result-item:hover { background: rgba(255,255,255,0.06); }
        body.light-mode .search-result-item:hover { background: #f4f4f8; }
        body.light-mode .search-result-item { border-color: rgba(0,0,0,0.05); }

        /* â”€â”€ Market Countdown â”€â”€ */
        #marketCountdown {
            font-size: 11px; font-weight: 700; font-family: var(--v-mono);
            color: var(--v-muted); letter-spacing: 0.03em;
        }

        /* â”€â”€ Portfolio Performance Chart â”€â”€ */
        #perfChartWrap { position: relative; height: 160px; margin-top: 8px; }

        /* â”€â”€ Mobile Layout â”€â”€ */
        #mobileNav {
            display: none; position: fixed; bottom: 0; left: 0; right: 0; z-index: 200;
            background: #111118; border-top: 1px solid rgba(255,255,255,0.08);
            padding: 8px 0 max(8px, env(safe-area-inset-bottom));
        }
        body.light-mode #mobileNav { background: #fff; border-color: rgba(0,0,0,0.1); }
        .mob-nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 3px;
            background: none; border: none; color: #8888a8; cursor: pointer;
            font-size: 10px; font-weight: 600; font-family: var(--v-sans); flex: 1;
            padding: 4px 0; transition: color 0.15s;
        }
        .mob-nav-btn.active { color: var(--v-gold); }
        .mob-nav-btn svg { width: 20px; height: 20px; }

        /* â”€â”€ Journal Modal â”€â”€ */
        #journalModal {
            position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.8);
            backdrop-filter: blur(8px); display: none;
            align-items: center; justify-content: center;
        }
        #journalModal.open { display: flex; }

        /* â”€â”€ Analyst / Similar â”€â”€ */
        .analyst-bar { height: 6px; border-radius: 3px; background: rgba(255,255,255,0.08); overflow: hidden; margin-top: 4px; }
        .analyst-fill { height: 100%; border-radius: 3px; transition: width 0.6s ease; }

        /* â”€â”€ Responsive â”€â”€ */
        @media (max-width: 900px) {
            /* Landing page */
            #heroGrid { grid-template-columns: 1fr !important; gap: 40px !important; padding: 80px 24px 40px !important; text-align: center; }
            #heroRight { display: none; }
            #heroLeft .anim-4 { justify-content: center; }
            #heroMiniStats { justify-content: center; }
            #featuresGrid { grid-template-columns: 1fr !important; }
            #featuresGrid .feat-card:first-child { grid-column: span 1 !important; }
            #howGrid { grid-template-columns: 1fr 1fr !important; }
            .home-nav { padding: 0 20px; }
            .home-nav .logo { font-size: 1.4rem; }
            footer > div > div:first-child { grid-template-columns: 1fr !important; }
        }
        @media (max-width: 900px) {
            #mobileNav { display: flex; }
            #appMain { padding-bottom: 80px !important; grid-template-columns: 1fr !important; }
            #appMain > div:first-child { border-right: none !important; }
            #desktopSidebar { display: none !important; }
        }
        @media (max-width: 768px) {
            .app-header { padding: 0 12px !important; }
            #searchWrap { max-width: 200px !important; }
            #marketCountdown { display: none; }
        }
        @media (min-width: 769px) {
            #mobilePortfolioView { display: none; }
        }
        /* light mode overrides for more menu */
        body.light-mode #moreMenu { background: #fff; border-color: rgba(0,0,0,0.1); }
        body.light-mode #moreMenu button { color: #1a1a2e; }

        /* â”€â”€ Indicator toggle buttons â”€â”€ */
        .ind-btn {
            font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;
            border:1px solid rgba(255,255,255,0.1);background:transparent;
            color:#8888a8;cursor:pointer;transition:all 0.15s;font-family:var(--v-sans);
        }
        .ind-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
        /* â”€â”€ SIP Modal styles â”€â”€ */
        #sipModal input:focus, #sipModal select:focus { border-color:var(--v-gold) !important; outline:none; }
        .sip-type-tab { transition:all 0.15s; }
        .sip-type-tab.active { background:rgba(212,168,75,0.12);color:var(--v-gold);border-bottom:2px solid var(--v-gold); }
        /* â”€â”€ Chart toolbar light mode â”€â”€ */
        body.light-mode #chartOuter { background:#ffffff; }
        body.light-mode .ctab { color:#555570; }
        /* â”€â”€ Chart indicator + interval buttons â”€â”€ */
        .ind-btn {
            font-size:9px;font-weight:700;padding:2px 7px;border-radius:4px;cursor:pointer;
            border:1px solid rgba(255,255,255,0.1);background:transparent;color:#8888a8;
            transition:all 0.15s;white-space:nowrap;
        }
        .ind-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
        .itv-btn {
            font-size:9px;font-weight:600;padding:3px 8px;cursor:pointer;
            border:none;background:transparent;color:#6868a0;
            border-radius:4px;transition:all 0.15s;white-space:nowrap;
        }
        .itv-btn:hover { color:#e0e0f5;background:rgba(255,255,255,0.06); }
        .itv-active { background:rgba(138,180,248,0.12) !important;color:#8ab4f8 !important;font-weight:700 !important; }
        body.light-mode .itv-active { background:rgba(26,115,232,0.1) !important;color:#1a73e8 !important; }
        body.light-mode .ind-btn { color:#6060a0; }
        /* â”€â”€ New Feature Modals â”€â”€ */
        #screenerModal, #calendarModal, #communityModal, #educationModal, #botModal {
            font-family: var(--v-sans);
        }
        #screenerModal > div, #calendarModal > div, #communityModal > div,
        #educationModal > div, #botModal {
            animation: slideUp 0.3s cubic-bezier(0.16,1,0.3,1);
        }
        body.light-mode #screenerModal > div,
        body.light-mode #calendarModal > div,
        body.light-mode #communityModal > div,
        body.light-mode #educationModal > div,
        body.light-mode #botModal { background: #fff !important; border-color: rgba(0,0,0,0.1) !important; }
        body.light-mode #screenerResults > div > div,
        body.light-mode #communityFeed > div,
        body.light-mode #educationContent > div > div { background: #f4f4f8 !important; border-color: rgba(0,0,0,0.07) !important; }
        /* Toolbar action buttons */
        .toolbar-btn { font-size:10px;font-weight:700;padding:4px 10px;border-radius:6px;cursor:pointer;border:1px solid rgba(255,255,255,0.08);background:rgba(255,255,255,0.04);color:#a0a0b8;transition:all 0.15s; }
        .toolbar-btn:hover { border-color:var(--v-gold);color:var(--v-gold); }
    </style>
</head>
<body class="overflow-x-hidden">

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     VESTRA HOMEPAGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="homePage">

  <!-- NAV -->
  <nav class="home-nav">
    <div class="logo">Vestra</div>
    <div style="display:flex;gap:10px;align-items:center;">
      <button class="nav-btn nav-btn-ghost" onclick="showAuthFromHome('login')">Log In</button>
      <button class="nav-btn nav-btn-gold" onclick="showAuthFromHome('register')">Sign Up Free</button>
    </div>
  </nav>

  <!-- â•â•â• HERO â€” two column â•â•â• -->
  <section style="min-height:100vh;display:flex;align-items:center;padding:80px 48px 60px;overflow:hidden;position:relative;">
    <div class="orb" style="width:800px;height:800px;background:radial-gradient(circle,rgba(201,168,76,0.1),transparent 65%);top:-300px;right:-300px;pointer-events:none;"></div>
    <div class="orb" style="width:400px;height:400px;background:radial-gradient(circle,rgba(34,197,94,0.05),transparent 70%);bottom:0;left:-80px;pointer-events:none;"></div>

    <div style="max-width:1200px;margin:0 auto;width:100%;display:grid;grid-template-columns:1fr 1fr;gap:80px;align-items:center;">

      <!-- Copy -->
      <div>
        <div style="display:inline-flex;align-items:center;gap:8px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.22);padding:5px 14px;border-radius:100px;margin-bottom:28px;" class="anim-1">
          <div style="width:6px;height:6px;background:#22c55e;border-radius:50%;flex-shrink:0;animation:pulse-green 2s infinite;"></div>
          <span style="font-size:0.7rem;color:var(--v-gold);font-weight:700;letter-spacing:0.08em;">500+ REAL STOCKS Â· LIVE PRICES</span>
        </div>

        <h1 class="anim-2" style="font-family:var(--v-serif);font-size:clamp(2.6rem,4.5vw,4.8rem);line-height:1.05;margin:0 0 22px;color:#f0f0fa;">
          Trade Like a Pro.<br><em style="color:var(--v-gold);">Risk Nothing.</em>
        </h1>

        <p class="anim-3" style="font-size:1.05rem;color:#9090b8;line-height:1.75;margin:0 0 36px;max-width:440px;">
          Start with $100,000 in virtual cash and real-time market data. Build your strategy before it ever costs you a cent.
        </p>

        <div class="anim-4" style="display:flex;gap:12px;flex-wrap:wrap;margin-bottom:44px;">
          <button class="nav-btn nav-btn-gold" style="padding:14px 34px;font-size:0.95rem;border-radius:10px;" onclick="showAuthFromHome('register')">Start Trading Free â†’</button>
          <button class="nav-btn nav-btn-ghost" style="padding:14px 26px;font-size:0.95rem;border-radius:10px;" onclick="scrollToSection('how')">How It Works</button>
        </div>

        <!-- Three stats inline -->
        <div class="anim-4" style="display:flex;gap:28px;padding-top:28px;border-top:1px solid rgba(255,255,255,0.07);">
          <div>
            <div style="font-family:var(--v-mono);font-size:1.6rem;color:var(--v-gold);line-height:1;font-weight:300;">$100K</div>
            <div style="font-size:10px;color:#6868a0;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em;">Starting cash</div>
          </div>
          <div>
            <div style="font-family:var(--v-mono);font-size:1.6rem;color:var(--v-gold);line-height:1;font-weight:300;">500+</div>
            <div style="font-size:10px;color:#6868a0;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em;">Real stocks</div>
          </div>
          <div>
            <div style="font-family:var(--v-mono);font-size:1.6rem;color:var(--v-gold);line-height:1;font-weight:300;">$0</div>
            <div style="font-size:10px;color:#6868a0;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em;">Financial risk</div>
          </div>
        </div>
      </div>

      <!-- Mock app card -->
      <div class="anim-3" style="position:relative;">
        <!-- Floating badge -->
        <div style="position:absolute;top:-14px;right:-10px;z-index:2;background:linear-gradient(135deg,#22c55e,#16a34a);color:#fff;padding:7px 13px;border-radius:9px;font-size:11px;font-weight:700;box-shadow:0 8px 28px rgba(34,197,94,0.35);white-space:nowrap;">ğŸ“ˆ +$3,241 this week</div>

        <div style="background:var(--v-card);border:1px solid rgba(255,255,255,0.09);border-radius:20px;padding:24px;box-shadow:0 32px 80px rgba(0,0,0,0.55);">
          <!-- Mini header row -->
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
            <div>
              <div style="font-family:var(--v-serif);font-size:1.2rem;color:#f0f0fa;line-height:1;">AAPL</div>
              <div style="font-size:11px;color:#8888a8;margin-top:2px;">Apple Inc.</div>
            </div>
            <div style="text-align:right;">
              <div style="font-family:var(--v-mono);font-size:1.35rem;color:#f0f0fa;" id="heroPrice">$254.86</div>
              <div style="font-size:11px;color:#4ade80;font-family:var(--v-mono);" id="heroChange">+1.24%</div>
            </div>
          </div>

          <!-- Chart -->
          <canvas id="heroChart" style="width:100%;height:110px;display:block;"></canvas>

          <!-- Portfolio row -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:16px;">
            <div style="background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:11px 13px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:5px;">Portfolio</div>
              <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;">$103,241</div>
              <div style="font-size:10px;color:#4ade80;margin-top:2px;">+3.24%</div>
            </div>
            <div style="background:rgba(255,255,255,0.035);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:11px 13px;">
              <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:5px;">Today P&amp;L</div>
              <div style="font-family:var(--v-mono);font-size:1rem;color:#f0f0fa;">+$241</div>
              <div style="font-size:10px;color:#4ade80;margin-top:2px;">+0.23%</div>
            </div>
          </div>

          <!-- Holdings list mock -->
          <div style="margin-top:14px;border-top:1px solid rgba(255,255,255,0.06);padding-top:12px;">
            <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:8px;">Holdings</div>
            <div style="display:flex;flex-direction:column;gap:6px;">
              <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:#c0c0d8;font-weight:600;">AAPL</span><span style="color:#4ade80;font-family:var(--v-mono);">+2.1%</span></div>
              <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:#c0c0d8;font-weight:600;">NVDA</span><span style="color:#4ade80;font-family:var(--v-mono);">+5.8%</span></div>
              <div style="display:flex;justify-content:space-between;font-size:11px;"><span style="color:#c0c0d8;font-weight:600;">MSFT</span><span style="color:#f87171;font-family:var(--v-mono);">âˆ’0.4%</span></div>
            </div>
          </div>
        </div>
      </div>

    </div>
  </section>

  <!-- TICKER -->
  <div class="ticker-wrap" style="padding:10px 0;">
    <div class="ticker" id="homeTicker"><span id="tickerInner"></span><span id="tickerInner2"></span></div>
  </div>

  <!-- â•â•â• FEATURES â€” bento grid â•â•â• -->
  <section style="padding:80px 48px;">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:flex;justify-content:space-between;align-items:flex-end;margin-bottom:48px;flex-wrap:wrap;gap:16px;">
        <div>
          <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.13em;text-transform:uppercase;margin:0 0 8px;">Everything You Need</p>
          <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0;color:#f0f0fa;line-height:1.15;">Built for Serious Learning</h2>
        </div>
        <button class="nav-btn nav-btn-gold" style="padding:11px 26px;font-size:0.875rem;flex-shrink:0;" onclick="showAuthFromHome('register')">Get Started â†’</button>
      </div>

      <!-- Bento: 3 columns, first card spans 2 -->
      <div style="display:grid;grid-template-columns:repeat(3,1fr);grid-template-rows:auto auto;gap:16px;">

        <div class="feat-card" style="grid-column:span 2;display:flex;gap:24px;align-items:flex-start;">
          <div style="font-size:2.2rem;flex-shrink:0;margin-top:2px;">ğŸ“ˆ</div>
          <div>
            <h3 style="font-family:var(--v-serif);font-size:1.35rem;margin:0 0 10px;color:#f0f0fa;">Real-Time Market Data</h3>
            <p style="color:#8888a8;line-height:1.7;font-size:0.875rem;margin:0;">Connect a free Finnhub API key and watch 500+ stock prices tick live every few seconds â€” candlestick charts, day range, volume, analyst ratings, all real.</p>
          </div>
        </div>

        <div class="feat-card">
          <div style="font-size:1.8rem;margin-bottom:12px;">ğŸ†</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Global Leaderboard</h3>
          <p style="color:#8888a8;line-height:1.65;font-size:0.85rem;margin:0;">Compete with traders worldwide. Rankings by total value, profit, and shares.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:1.8rem;margin-bottom:12px;">âš¡</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Order Types</h3>
          <p style="color:#8888a8;line-height:1.65;font-size:0.85rem;margin:0;">Market, limit, stop-loss, take-profit. Pending orders fill automatically.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:1.8rem;margin-bottom:12px;">ğŸ’¼</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Portfolio Tracking</h3>
          <p style="color:#8888a8;line-height:1.65;font-size:0.85rem;margin:0;">Realized & unrealized P&L, cost basis, sector allocation chart.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:1.8rem;margin-bottom:12px;">ğŸ¯</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Quests & Streaks</h3>
          <p style="color:#8888a8;line-height:1.65;font-size:0.85rem;margin:0;">Daily challenges, trading streaks, and achievement badges.</p>
        </div>

        <div class="feat-card">
          <div style="font-size:1.8rem;margin-bottom:12px;">ğŸ““</div>
          <h3 style="font-family:var(--v-serif);font-size:1.15rem;margin:0 0 8px;color:#f0f0fa;">Trade Journal</h3>
          <p style="color:#8888a8;line-height:1.65;font-size:0.85rem;margin:0;">Log your reasoning on every trade. Review what worked and what didn't.</p>
        </div>

      </div>
    </div>
  </section>

  <!-- â•â•â• HOW IT WORKS â€” horizontal 4-step â•â•â• -->
  <section id="how" style="padding:80px 48px;background:#0b0b14;">
    <div style="max-width:1100px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:56px;">
        <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.13em;text-transform:uppercase;margin:0 0 10px;">Up and running in minutes</p>
        <h2 style="font-family:var(--v-serif);font-size:clamp(1.8rem,3.5vw,2.8rem);margin:0;color:#f0f0fa;">How Vestra Works</h2>
      </div>

      <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:0;position:relative;">
        <!-- Line connecting steps -->
        <div style="position:absolute;top:22px;left:12.5%;right:12.5%;height:1px;background:linear-gradient(90deg,rgba(201,168,76,0.6),rgba(201,168,76,0.15));pointer-events:none;"></div>

        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">1</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Create Account</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Sign up in seconds. Instantly get $100K virtual cash.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">2</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Add Live Data</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Free <a href="https://finnhub.io" target="_blank" style="color:var(--v-gold);">Finnhub</a> key â€” prices go live instantly.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">3</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Research & Trade</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Charts, analyst ratings, limit orders â€” the full toolkit.</p>
        </div>
        <div style="text-align:center;padding:0 20px;position:relative;">
          <div class="step-num" style="margin:0 auto 18px;">4</div>
          <h3 style="font-family:var(--v-serif);font-size:1rem;margin:0 0 8px;color:#f0f0fa;">Climb the Ranks</h3>
          <p style="color:#8080a8;font-size:0.82rem;line-height:1.6;margin:0;">Track P&L, beat the leaderboard, unlock achievements.</p>
        </div>
      </div>
    </div>
  </section>

  <!-- CTA -->
  <section style="padding:100px 48px;text-align:center;position:relative;overflow:hidden;">
    <div class="orb" style="width:600px;height:600px;background:radial-gradient(circle,rgba(201,168,76,0.08),transparent 70%);top:50%;left:50%;transform:translate(-50%,-50%);"></div>
    <div style="max-width:600px;margin:0 auto;position:relative;z-index:1;">
      <p style="color:var(--v-gold);font-size:0.7rem;font-weight:700;letter-spacing:0.13em;text-transform:uppercase;margin:0 0 14px;">No Credit Card. No Risk. Ever.</p>
      <h2 style="font-family:var(--v-serif);font-size:clamp(2rem,5vw,3.6rem);margin:0 0 18px;color:#f0f0fa;line-height:1.1;">Ready to Start Your<br>Trading Journey?</h2>
      <p style="color:#8080a8;font-size:1rem;line-height:1.75;margin:0 0 36px;">The only thing you'll lose is your fear of the market.</p>
      <button class="nav-btn nav-btn-gold" style="padding:16px 48px;font-size:1rem;border-radius:12px;" onclick="showAuthFromHome('register')">Create Free Account â†’</button>
    </div>
  </section>

  <!-- FOOTER -->
  <footer style="padding:44px 48px 32px;background:var(--v-surface);">
    <div style="max-width:1200px;margin:0 auto;">
      <div style="display:grid;grid-template-columns:2fr 1fr;gap:40px;align-items:start;margin-bottom:32px;">
        <div>
          <div class="logo" style="font-size:1.7rem;margin-bottom:8px;">Vestra</div>
          <p style="color:#6868a0;font-size:0.85rem;line-height:1.7;max-width:360px;margin:0 0 18px;">Practice with real market data, compete worldwide, and build your edge â€” all with virtual money.</p>
          <button class="nav-btn nav-btn-ghost" style="font-size:0.82rem;padding:8px 18px;" onclick="showAuthFromHome('register')">Start for Free â†’</button>
        </div>
        <div>
          <p style="color:#6868a0;font-size:0.7rem;text-transform:uppercase;letter-spacing:0.1em;font-weight:700;margin:0 0 14px;">Connect</p>
          <div style="display:flex;flex-direction:column;gap:5px;">
            <a href="https://www.instagram.com/badeatorneto/?hl=en" target="_blank" rel="noopener noreferrer" class="social-link">
              <div class="social-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><rect x="2" y="2" width="20" height="20" rx="5"/><circle cx="12" cy="12" r="4"/><line x1="17.5" y1="6.5" x2="17.51" y2="6.5"/></svg></div>
              <span>@badeatorneto</span>
            </a>
            <a href="https://www.snapchat.com/@guywholikesfifa" target="_blank" rel="noopener noreferrer" class="social-link">
              <div class="social-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.5 2 6 4.5 6 8v.5c0 .5-.3.9-.7 1.1-.4.2-.3.7.1.8.6.2 1.1.4 1.4.9.1.2.1.4 0 .6-.3.5-1.1 1.3-1.1 2.2 0 1.1.9 1.9 2 1.9.3 0 .7-.1 1-.2.5-.2 1.1.1 1.3.6.5 1.1 1.8 1.6 3 1.6s2.5-.5 3-1.6c.2-.5.8-.8 1.3-.6.3.1.7.2 1 .2 1.1 0 2-.8 2-1.9 0-.9-.8-1.7-1.1-2.2-.1-.2-.1-.4 0-.6.3-.5.8-.7 1.4-.9.4-.1.5-.6.1-.8-.4-.2-.7-.6-.7-1.1V8c0-3.5-2.5-6-6-6z"/></svg></div>
              <span>@guywholikesfifa</span>
            </a>
            <a href="mailto:arush2011jain@gmail.com" class="social-link">
              <div class="social-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg></div>
              <span>arush2011jain@gmail.com</span>
            </a>
          </div>
        </div>
      </div>
      <div class="gold-line" style="margin-bottom:20px;"></div>
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px;">
        <p style="color:#4a4a6a;font-size:0.75rem;margin:0;">Â© 2026 Vestra. Educational use only â€” not financial advice.</p>
        <button class="nav-btn nav-btn-ghost" style="font-size:0.75rem;padding:4px 12px;" onclick="showAuthFromHome('login')">Log In â†’</button>
      </div>
    </div>
  </footer>

</div><!-- end #homePage -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP WRAPPER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<!-- â•â•â• LOGIN / REGISTER OVERLAY â•â•â• -->
<div id="authOverlay" class="fixed inset-0 z-[9999] flex items-center justify-center" style="background:rgba(0,0,0,0.92);backdrop-filter:blur(16px);display:none;">
    <div style="background:var(--v-card);border:1px solid rgba(201,168,76,0.2);border-radius:20px;width:100%;max-width:440px;padding:40px;box-shadow:0 30px 100px rgba(0,0,0,0.6);position:relative;">
        <button onclick="document.getElementById('authOverlay').style.display='none'" style="position:absolute;top:16px;right:16px;background:none;border:none;color:var(--v-muted);font-size:18px;cursor:pointer;line-height:1;" title="Close">âœ•</button>
        <div class="text-center" style="margin-bottom:28px;">
            <div style="font-family:var(--v-serif);font-size:2.5rem;color:var(--v-text);margin-bottom:6px;">Vestra</div>
            <div style="font-size:10px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:600;margin-bottom:20px;">Trading With No Risk</div>
            <h2 id="authTitle" style="font-size:1.3rem;font-weight:700;color:var(--v-text);margin:0 0 4px;">Sign In</h2>
            <p id="authSubtitle" style="color:var(--v-muted);font-size:0.875rem;margin:0;">to your trading account</p>
        </div>
        <div id="authError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.3);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div id="registerNameGroup" class="hidden" style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Display Name</label>
            <input id="authName" type="text" placeholder="e.g. TradingWolf99" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:14px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Username</label>
            <input id="authUser" type="text" placeholder="username" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:600;color:var(--v-muted);margin-bottom:6px;text-transform:uppercase;letter-spacing:0.05em;">Password</label>
            <input id="authPass" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="width:100%;background:var(--v-surface);border:1px solid var(--v-border);border-radius:10px;padding:12px 14px;font-size:14px;color:var(--v-text);outline:none;font-family:var(--v-sans);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='var(--v-border)'">
        </div>
        <button id="authSubmitBtn" onclick="handleAuthSubmit()" style="width:100%;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);transition:background 0.2s;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Sign In</button>
        <p style="text-align:center;font-size:13px;color:var(--v-muted);margin-top:16px;">
            <span id="authToggleText">Don't have an account?</span>
            <button onclick="toggleAuthMode()" id="authToggleBtn" style="color:var(--v-gold);font-weight:600;margin-left:4px;background:none;border:none;cursor:pointer;font-size:13px;font-family:var(--v-sans);">Create account</button>
        </p>
    </div>
</div>

<div id="appPage" style="width:100%;">



<!-- â•â•â• LEADERBOARD OVERLAY â•â•â• -->
<div id="leaderboardOverlay" class="fixed inset-0 z-[9998] hidden" style="background:rgba(0,0,0,0.75);backdrop-filter:blur(6px);" onclick="closeLeaderboard()">
    <div onclick="event.stopPropagation()" style="position:absolute;right:0;top:0;height:100%;width:100%;max-width:480px;background:#111118;border-left:1px solid rgba(255,255,255,0.08);overflow-y:auto;display:flex;flex-direction:column;">
        <div style="position:sticky;top:0;background:#111118;border-bottom:1px solid rgba(255,255,255,0.08);padding:20px 24px;display:flex;align-items:center;justify-content:space-between;z-index:10;">
            <div>
                <h2 style="font-size:1.1rem;font-weight:700;color:#f0f0fa;margin:0 0 2px;">ğŸ† Global Leaderboard</h2>
                <p style="font-size:11px;color:#8888a8;margin:0;">All registered traders ranked</p>
            </div>
            <button onclick="closeLeaderboard()" style="background:none;border:none;color:#8888a8;font-size:24px;cursor:pointer;line-height:1;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
        </div>
        <div style="display:flex;border-bottom:1px solid rgba(255,255,255,0.08);padding:12px 24px 0;gap:4px;">
            <button onclick="setLeaderSort('total')" id="sort-total" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:rgba(212,168,75,0.15);color:var(--v-gold);border-bottom:2px solid var(--v-gold);">ğŸ’° Total Value</button>
            <button onclick="setLeaderSort('profit')" id="sort-profit" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:transparent;color:#8888a8;border-bottom:2px solid transparent;">ğŸ“ˆ Profit</button>
            <button onclick="setLeaderSort('stocks')" id="sort-stocks" class="lbsort-btn" style="font-size:12px;font-weight:700;padding:8px 14px;border-radius:8px 8px 0 0;border:none;cursor:pointer;background:transparent;color:#8888a8;border-bottom:2px solid transparent;">ğŸ“¦ Shares</button>
        </div>
        <div id="leaderboardList" style="flex:1;padding:20px 24px;">
            <div style="text-align:center;color:#8888a8;padding:40px 0;">Loading traders...</div>
        </div>
        <div style="border-top:1px solid rgba(255,255,255,0.08);padding:12px 24px;background:#0e0e16;font-size:11px;color:#606080;text-align:center;">Updates live after every trade</div>
    </div>
</div>

<header class="app-header">
    <div style="width:100%;padding:0 28px;height:64px;display:flex;align-items:center;gap:16px;justify-content:space-between;">

        <!-- Brand -->
        <div style="flex-shrink:0;">
            <div class="vestra-brand" style="font-size:1.5rem;font-weight:700;color:var(--v-text);line-height:1;">Vestra</div>
            <div style="font-size:8px;color:var(--v-gold);letter-spacing:0.15em;text-transform:uppercase;font-weight:700;">No Risk Trading</div>
        </div>

        <!-- Search â€” takes all remaining space -->
        <div id="searchWrap" style="flex:1;max-width:520px;">
            <div class="search-bar flex items-center px-4 h-10">
                <svg class="w-4 h-4 mr-2" style="color:var(--v-muted);flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                <input type="text" id="search" oninput="handleSearch(this.value)" onfocus="showSearchDropdown()" placeholder="Search 500+ stocksâ€¦" class="bg-transparent border-none outline-none w-full text-sm" autocomplete="off" style="color:var(--v-text);">
                <button id="searchClear" onclick="clearSearch()" style="display:none;background:none;border:none;color:var(--v-muted);cursor:pointer;font-size:15px;padding:0 2px;flex-shrink:0;">âœ•</button>
            </div>
            <div id="searchDropdown" style="display:none;"></div>
        </div>

        <!-- Market status + countdown -->
        <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
            <div id="marketStatusDot" class="w-2 h-2 rounded-full" style="background:#6b7280;flex-shrink:0;"></div>
            <span id="marketStatusText" style="font-size:11px;font-weight:600;color:var(--v-muted);white-space:nowrap;">Closed</span>
            <span style="color:var(--v-border);font-size:14px;">Â·</span>
            <div id="marketCountdown" title="Time until market opens/closes" style="white-space:nowrap;"></div>
        </div>

        <!-- Action buttons -->
        <div style="display:flex;align-items:center;gap:8px;flex-shrink:0;">
            <button onclick="openApiConfig()" id="liveDataBtn" style="font-size:11px;background:rgba(201,168,76,0.12);border:1px solid rgba(201,168,76,0.3);color:var(--v-gold);padding:5px 10px;border-radius:6px;font-weight:700;cursor:pointer;white-space:nowrap;">âš¡ Live</button>
            <button onclick="openLeaderboard()" style="font-size:11px;background:rgba(201,168,76,0.08);border:1px solid rgba(201,168,76,0.2);color:var(--v-gold);padding:5px 10px;border-radius:6px;font-weight:700;cursor:pointer;">ğŸ†</button>
            <button onclick="toggleTheme()" id="themeToggle" title="Toggle theme" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 8px;cursor:pointer;font-size:13px;line-height:1;">ğŸŒ™</button>

            <!-- Overflow menu â€” export/import/tutorial/sync -->
            <div style="position:relative;" id="moreMenuWrap">
                <button onclick="toggleMoreMenu()" style="background:rgba(255,255,255,0.06);border:1px solid var(--v-border);border-radius:6px;padding:5px 9px;cursor:pointer;font-size:13px;color:var(--v-muted);">â‹¯</button>
                <div id="moreMenu" style="display:none;position:absolute;right:0;top:calc(100%+6px);background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:12px;padding:6px;min-width:160px;z-index:999;box-shadow:0 16px 40px rgba(0,0,0,0.5);">
                    <div id="syncBadge" style="font-size:11px;padding:6px 10px;color:var(--v-muted);border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:4px;">Sync: Local</div>
                    <button onclick="exportPortfolioData();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“¤ Export Portfolio</button>
                    <button onclick="document.getElementById('importFile').click();toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“¥ Import Portfolio</button>
                    <button onclick="startTutorial(true);toggleMoreMenu()" style="width:100%;text-align:left;background:none;border:none;color:#c0c0d8;font-size:12px;padding:7px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.background='rgba(255,255,255,0.06)'" onmouseout="this.style.background='none'">ğŸ“ Tutorial</button>
                </div>
            </div>
            <input id="importFile" type="file" accept="application/json" class="hidden" onchange="importPortfolioData(event)">

            <!-- Avatar + name -->
            <div style="display:flex;align-items:center;gap:8px;padding-left:10px;border-left:1px solid var(--v-border);">
                <div id="userAvatar" style="width:30px;height:30px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:12px;font-weight:700;flex-shrink:0;">?</div>
                <div style="display:flex;flex-direction:column;">
                    <div id="userDisplayName" style="font-size:12px;font-weight:600;color:var(--v-text);line-height:1.2;max-width:90px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">â€”</div>
                    <button onclick="logOut()" style="font-size:10px;color:var(--v-muted);background:none;border:none;cursor:pointer;padding:0;text-align:left;" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--v-muted)'">Sign out</button>
                </div>
            </div>
        </div>

    </div>
</header>

<!-- News banner -->
<div id="newsBanner" class="fixed top-16 left-0 right-0 z-40 hidden px-6 py-2.5 text-center font-medium text-white shadow-lg" style="font-size:13px;">
    <span id="newsHeadline"></span>
</div>

<!-- â•â•â• MAIN TRADING LAYOUT â€” full viewport width â•â•â• -->
<main id="appMain" style="width:100%;padding:0;display:grid;grid-template-columns:1fr 280px;gap:0;min-height:calc(100vh - 64px);align-items:start;">

    <!-- â”€â”€ LEFT: stock grid + news â”€â”€ -->
    <div style="padding:20px 20px 40px 28px;min-width:0;border-right:1px solid var(--v-border);">

        <!-- Toolbar -->
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div style="display:flex;align-items:baseline;gap:12px;">
                <div style="font-size:1.1rem;font-weight:300;color:#f0f0fa;letter-spacing:-0.01em;">Most Active</div>
                <div style="font-size:10px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.08em;">Market Trends</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                <button onclick="openScreener()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ” Screener</button>
                <button onclick="openCalendar()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“… Calendar</button>
                <button onclick="openCommunity()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ’¬ Community</button>
                <button onclick="openEducation()" style="font-size:10px;font-weight:700;color:#a0a0b8;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:4px 10px;border-radius:6px;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)';this.style.color='#a0a0b8'">ğŸ“ Learn</button>
                <span id="dataSourceBadge" style="font-size:10px;font-weight:700;color:#8888a8;background:rgba(255,255,255,0.05);padding:3px 8px;border-radius:4px;border:1px solid rgba(255,255,255,0.07);">SIM</span>
            </div>
        </div>

        <!-- Stock grid: wide cards, fills all available width -->
        <div id="grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:10px;margin-bottom:32px;"></div>

        <!-- News grid below -->
        <div style="border-top:1px solid var(--v-border);padding-top:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
                <div style="font-size:0.95rem;font-weight:600;color:#e0e0f5;">Market News</div>
                <a href="https://finance.yahoo.com/news/" target="_blank" rel="noopener noreferrer" style="font-size:11px;color:var(--v-gold);font-weight:600;text-decoration:none;">More â†—</a>
            </div>
            <div id="newsFeed" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;"></div>
        </div>
    </div>

    <!-- â”€â”€ RIGHT SIDEBAR â€” sticky, scrolls independently â”€â”€ -->
    <aside id="desktopSidebar" style="position:sticky;top:64px;height:calc(100vh - 64px);overflow-y:auto;padding:16px 16px 24px 16px;display:flex;flex-direction:column;gap:12px;background:var(--v-surface);">

        <!-- Equity summary â€” top of sidebar, always visible -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Portfolio</div>
                <span id="dataSourceBadge2" style="display:none;"></span>
            </div>
            <div style="font-size:1.6rem;font-weight:300;color:#f5f5fa;font-family:var(--v-mono);line-height:1;margin-bottom:4px;">$<span id="netWorth">100,000.00</span></div>
            <div id="plDisplay" style="font-size:0.78rem;font-weight:600;color:#4ade80;">+$0.00 (0.00%)</div>
            <div id="portfolioList" style="border-top:1px solid rgba(255,255,255,0.05);margin-top:10px;max-height:160px;overflow-y:auto;">
                <div style="font-size:11px;color:#6868a0;padding:10px 0;text-align:center;font-style:italic;">No holdings yet.</div>
            </div>
            <div style="display:flex;justify-content:space-between;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);font-size:10px;color:#6868a0;">
                <span>Realized: <span id="realizedPL" style="color:#a0a0b8;font-weight:600;">$0.00</span></span>
                <span>Unrealized: <span id="unrealizedPL" style="color:#a0a0b8;font-weight:600;">$0.00</span></span>
            </div>
            <!-- Portfolio analytics stats row -->
            <div id="portfolioStats" style="display:none;"></div>
        </div>

        <!-- Performance chart -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Performance</div>
                <div style="display:flex;gap:3px;">
                    <button onclick="setPerfPeriod('1D',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid var(--v-gold);background:rgba(212,168,75,0.15);color:var(--v-gold);cursor:pointer;">1D</button>
                    <button onclick="setPerfPeriod('5D',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">5D</button>
                    <button onclick="setPerfPeriod('1M',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">1M</button>
                    <button onclick="setPerfPeriod('6M',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">6M</button>
                    <button onclick="setPerfPeriod('1Y',this)" class="perf-btn" style="font-size:9px;font-weight:700;padding:1px 6px;border-radius:3px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:#8888a8;cursor:pointer;">1Y</button>
                </div>
            </div>
            <div id="perfChartWrap" style="height:110px;"><canvas id="perfChart"></canvas></div>
        </div>

        <!-- Allocation chart -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Allocation</div>
            <div style="height:120px;"><canvas id="allocationChart"></canvas></div>
            <div id="sectorExposure" style="margin-top:8px;font-size:10px;color:#8888a8;"></div>
        </div>

        <!-- Watchlist -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">Watchlist</div>
                <button onclick="addCurrentToWatchlist()" style="font-size:10px;font-weight:700;color:var(--v-gold);background:none;border:none;cursor:pointer;padding:0;">+ Add</button>
            </div>
            <div id="watchlistItems" style="font-size:11px;color:#c0c0d8;margin-bottom:10px;"></div>

            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:6px;">Price Alerts</div>
            <div style="display:grid;grid-template-columns:2fr 2fr 2fr;gap:4px;margin-bottom:5px;">
                <input id="alertSymbol" placeholder="SYM" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
                <select id="alertType" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
                    <option value="above">Above</option>
                    <option value="below">Below</option>
                    <option value="move">% Move</option>
                </select>
                <input id="alertValue" placeholder="$" type="number" step="0.01" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:5px;padding:4px 6px;font-size:10px;color:#e0e0f5;outline:none;width:100%;">
            </div>
            <button onclick="createPriceAlert()" style="width:100%;background:rgba(212,168,75,0.08);color:var(--v-gold);border:1px solid rgba(212,168,75,0.18);border-radius:6px;padding:6px;font-size:10px;font-weight:700;cursor:pointer;" onmouseover="this.style.background='rgba(212,168,75,0.14)'" onmouseout="this.style.background='rgba(212,168,75,0.08)'">Set Alert</button>
            <div id="alertsList" style="margin-top:6px;font-size:10px;color:#a0a0b8;"></div>
            <div id="alertFeed" style="margin-top:4px;font-size:10px;"></div>
        </div>

        <!-- Quests -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">Daily Quests</div>
            <div id="questList" style="font-size:11px;color:#c0c0d8;margin-bottom:6px;"></div>
            <div style="font-size:10px;color:#8888a8;margin-bottom:6px;">Streak: <span id="tradeStreak" style="font-weight:700;color:#d4a84b;">0 days</span></div>
            <div id="achievementList" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
        </div>

        <!-- SIP Plans Sidebar Widget -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;">ğŸ“… SIP Plans</div>
                <button onclick="openSIP(null)" style="font-size:9px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.18);padding:2px 7px;border-radius:4px;cursor:pointer;">+ New</button>
            </div>
            <div id="sipSidebarWidget" style="font-size:11px;color:#8888a8;">
                <div style="text-align:center;padding:4px 0;font-style:italic;color:#6868a0;">No active SIP plans.</div>
            </div>
        </div>

        <!-- History -->
        <div style="background:var(--v-card);border:1px solid var(--v-border);border-radius:12px;padding:14px;">
            <div style="font-size:11px;font-weight:700;color:#8888a8;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:8px;">History</div>
            <div id="historyList" style="font-size:10px;color:#c0c0d8;max-height:160px;overflow-y:auto;"></div>
        </div>

    </aside>
</main>

<!-- â•â•â• MOBILE BOTTOM NAV â•â•â• -->
<nav id="mobileNav">
    <button class="mob-nav-btn active" id="mnMarket" onclick="mobileTab('market')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/></svg>
        Market
    </button>
    <button class="mob-nav-btn" id="mnPortfolio" onclick="mobileTab('portfolio')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
        Portfolio
    </button>
    <button class="mob-nav-btn" id="mnSearch" onclick="mobileTab('search')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
        Search
    </button>
    <button class="mob-nav-btn" id="mnLeader" onclick="openLeaderboard()">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z"/></svg>
        Ranks
    </button>
    <button class="mob-nav-btn" id="mnProfile" onclick="mobileTab('profile')">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/></svg>
        Profile
    </button>
</nav>

<!-- â•â•â• MOBILE PORTFOLIO VIEW â•â•â• -->
<div id="mobilePortfolioView" style="display:none;padding:16px;padding-bottom:80px;"></div>

<!-- â•â•â• JOURNAL MODAL â•â•â• -->
<div id="journalModal">
    <div style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:480px;padding:32px;margin:16px;">
        <h3 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 6px;">ğŸ““ Trade Journal</h3>
        <p id="journalTradeInfo" style="font-size:13px;color:#8888a8;margin:0 0 16px;"></p>
        <textarea id="journalNote" placeholder="Why did you make this trade? What's your thesis? Any concerns?" style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;font-family:var(--v-sans);outline:none;resize:vertical;min-height:120px;line-height:1.6;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'"></textarea>
        <div style="display:flex;gap:10px;margin-top:14px;">
            <button onclick="saveJournalNote()" style="flex:1;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:12px;border-radius:10px;border:none;font-size:14px;cursor:pointer;" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Save Note</button>
            <button onclick="closeJournal()" style="background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;padding:12px 18px;border-radius:10px;font-size:14px;cursor:pointer;font-weight:600;">Skip</button>
        </div>
    </div>
</div>

<div id="stockDetailPage" class="fixed inset-0 bg-[#1c1c1e] hidden z-50 overflow-y-auto">
    <div class="bg-[#1c1c1e] border-b border-gray-700 px-6 py-4 flex items-center gap-4 sticky top-0 z-10">
        <button onclick="closeStockDetail()" class="text-gray-400 hover:text-white flex items-center gap-2 text-sm font-medium transition">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Back to Market
        </button>
        <span class="text-gray-600">|</span>
        <span id="detailHeaderSymbol" class="text-white font-medium"></span>
    </div>
    <div class="max-w-4xl mx-auto px-6 py-8">
        <div class="mb-6">
            <div class="text-gray-400 text-sm mb-1" id="detailName"></div>
            <div class="flex items-baseline gap-3 mb-2 flex-wrap">
                <span id="detailPrice" class="text-white font-light" style="font-size:3.5rem;line-height:1;"></span>
                <span class="text-gray-400 text-xl">USD</span>
                <button id="followBtn" onclick="toggleFollowCurrent()" class="ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium">+ Follow</button>
            </div>
            <div class="flex items-center gap-2 mb-1">
                <span id="detailChangeAmt" class="text-xl font-medium"></span>
                <span id="detailChangePct" class="text-xl font-medium"></span>
                <span id="detailArrow" class="text-xl"></span>
                <span class="text-gray-400 text-sm">today</span>
            </div>
            <div class="text-gray-500 text-xs">Closed: Feb 17, 4:05 am GMT-5</div>
            <div id="detailPremarket" class="text-[#8ab4f8] text-sm mt-1"></div>
        </div>
        <!-- â”€â”€ CHART TOOLBAR â”€â”€ -->
        <div style="background:#1c1c1e;border-radius:12px 12px 0 0;border:1px solid rgba(255,255,255,0.07);border-bottom:none;">
          <!-- Row 1: period tabs + indicator toggles -->
          <div style="display:flex;justify-content:space-between;align-items:center;padding:0 8px;border-bottom:1px solid rgba(255,255,255,0.05);">
            <div style="display:flex;">
              <button onclick="setChartPeriod('1D',this)"  class="ctab ctab-active" style="font-size:11px;font-weight:700;padding:9px 12px;background:none;border:none;cursor:pointer;color:#8ab4f8;border-bottom:2px solid #8ab4f8;">1D</button>
              <button onclick="setChartPeriod('5D',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">5D</button>
              <button onclick="setChartPeriod('1M',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">1M</button>
              <button onclick="setChartPeriod('6M',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">6M</button>
              <button onclick="setChartPeriod('YTD',this)" class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">YTD</button>
              <button onclick="setChartPeriod('1Y',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">1Y</button>
              <button onclick="setChartPeriod('5Y',this)"  class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">5Y</button>
              <button onclick="setChartPeriod('Max',this)" class="ctab"             style="font-size:11px;font-weight:600;padding:9px 12px;background:none;border:none;cursor:pointer;color:#6868a0;border-bottom:2px solid transparent;">Max</button>
            </div>
            <!-- Indicator toggles -->
            <div style="display:flex;gap:3px;padding:0 4px;flex-wrap:wrap;">
              <button onclick="toggleIndicator('EMA20')" id="ind-EMA20" class="ind-btn">EMA20</button>
              <button onclick="toggleIndicator('EMA50')" id="ind-EMA50" class="ind-btn">EMA50</button>
              <button onclick="toggleIndicator('BB')"    id="ind-BB"    class="ind-btn">BB</button>
              <button onclick="toggleIndicator('VWAP')"  id="ind-VWAP"  class="ind-btn">VWAP</button>
              <button onclick="toggleIndicator('RSI')"   id="ind-RSI"   class="ind-btn">RSI</button>
              <button onclick="toggleIndicator('MACD')"  id="ind-MACD"  class="ind-btn">MACD</button>
            </div>
          </div>
          <!-- Row 2: intraday interval buttons -->
          <div id="intradayRow" style="display:none;align-items:center;gap:0;padding:0 8px;border-top:1px solid rgba(255,255,255,0.04);">
            <span style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.07em;padding:6px 10px 6px 0;">Interval:</span>
            <button onclick="setIntradayInterval('1')"  id="itv-1"  class="itv-btn itv-active">1m</button>
            <button onclick="setIntradayInterval('5')"  id="itv-5"  class="itv-btn">5m</button>
            <button onclick="setIntradayInterval('15')" id="itv-15" class="itv-btn">15m</button>
            <button onclick="setIntradayInterval('60')" id="itv-60" class="itv-btn">1H</button>
            <button onclick="setIntradayInterval('D')"  id="itv-D"  class="itv-btn">1D</button>
            <button onclick="setIntradayInterval('W')"  id="itv-W"  class="itv-btn">1W</button>
            <button onclick="setIntradayInterval('M')"  id="itv-M"  class="itv-btn">1M</button>
          </div>
        </div>

        <!-- â”€â”€ CHART AREA â”€â”€ -->
        <div id="chartOuter" style="position:relative;background:#1c1c1e;border:1px solid rgba(255,255,255,0.07);border-top:none;border-radius:0 0 12px 12px;overflow:hidden;">
          <!-- Loading / error overlay -->
          <div id="chartOverlay" style="display:none;position:absolute;inset:0;z-index:20;background:rgba(20,20,28,0.88);align-items:center;justify-content:center;flex-direction:column;gap:8px;">
            <div id="chartOverlayIcon" style="font-size:1.5rem;">â³</div>
            <div id="chartOverlayText" style="font-size:12px;color:#9aa0a6;font-weight:600;">Loading chartâ€¦</div>
          </div>
          <!-- Prev close badge -->
          <div style="position:absolute;right:10px;top:8px;z-index:5;text-align:right;line-height:1.4;">
            <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.04em;">Prev close</div>
            <div id="prevCloseVal" style="font-size:11px;color:#e0e0f5;font-weight:600;font-family:var(--v-mono);"></div>
          </div>
          <!-- Candlestick canvas -->
          <div style="height:310px;position:relative;">
            <canvas id="stockChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- RSI sub-panel -->
          <div id="rsiChartWrap" style="display:none;height:80px;border-top:1px solid rgba(255,255,255,0.05);position:relative;">
            <div style="position:absolute;left:6px;top:4px;font-size:8px;color:#f59e0b;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">RSI(14)</div>
            <canvas id="rsiChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- MACD sub-panel -->
          <div id="macdChartWrap" style="display:none;height:80px;border-top:1px solid rgba(255,255,255,0.05);position:relative;">
            <div style="position:absolute;left:6px;top:4px;font-size:8px;color:#a78bfa;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">MACD</div>
            <canvas id="macdChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
          <!-- Volume panel -->
          <div style="height:64px;border-top:1px solid rgba(255,255,255,0.04);position:relative;">
            <div style="position:absolute;left:6px;top:3px;font-size:8px;color:#6868a0;font-weight:700;text-transform:uppercase;letter-spacing:0.05em;">Vol</div>
            <canvas id="volumeChart" style="width:100%;height:100%;display:block;"></canvas>
          </div>
        </div>
        <div style="margin-bottom:24px;"></div>
        <div class="grid grid-cols-3 border-t border-gray-700 text-sm mb-8">
            <div class="py-4 pr-4"><div class="text-gray-400 mb-1">Open</div><div class="text-white font-medium" id="sOpen">â€”</div></div>
            <div class="py-4 px-4"><div class="text-gray-400 mb-1">Mkt cap</div><div class="text-white font-medium" id="sMktCap">â€”</div></div>
            <div class="py-4 pl-4"><div class="text-gray-400 mb-1">Dividend</div><div class="text-white font-medium" id="sDividend">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">High</div><div class="text-white font-medium" id="sHigh">â€”</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">P/E ratio</div><div class="text-white font-medium" id="sPE">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">Qtrly Div Amt</div><div class="text-white font-medium" id="sDivAmt">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pr-4"><div class="text-gray-400 mb-1">Low</div><div class="text-white font-medium" id="sLow">â€”</div></div>
            <div class="border-t border-gray-700 py-4 px-4"><div class="text-gray-400 mb-1">52-wk high</div><div class="text-white font-medium" id="s52H">â€”</div></div>
            <div class="border-t border-gray-700 py-4 pl-4"><div class="text-gray-400 mb-1">52-wk low</div><div class="text-white font-medium" id="s52L">â€”</div></div>
        </div>

        <!-- Analyst Ratings -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ“Š Analyst Ratings</h3>
            <div id="analystRatings"></div>
        </div>

        <!-- Earnings (simulated) -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ“ˆ Earnings History</h3>
            <div id="earningsData" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;"></div>
        </div>

        <!-- Similar Stocks -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;">
            <h3 style="color:#f0f0fa;font-size:1rem;font-weight:600;margin:0 0 14px;">ğŸ”— Similar Stocks</h3>
            <div id="similarStocks" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
        </div>
        <div class="bg-[#2c2c2e] rounded-2xl p-6 border border-gray-700">
            <h3 class="text-white text-lg font-medium mb-4">Trade <span id="tradeSymLabel" class="text-gray-400"></span></h3>
            <div class="grid grid-cols-2 gap-4 mb-6 text-sm">
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Buying Power</div><div class="text-white font-semibold text-lg" id="dBuyPow">$100,000</div></div>
                <div class="bg-[#1c1c1e] rounded-xl p-4"><div class="text-gray-400 mb-1">Shares Owned</div><div class="text-white font-semibold text-lg" id="dShares">0</div></div>
            </div>
            <div class="grid grid-cols-3 gap-2 mb-3">
                <select id="orderType" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" onchange="updateOrderTypeHint(this)">
                    <option value="market">Market</option>
                    <option value="limit">Limit</option>
                    <option value="stop-loss">Stop-loss</option>
                    <option value="take-profit">Take-profit</option>
                    <option value="gtt">GTT (Good-Till-Triggered)</option>
                </select>
                <input id="orderQty" type="number" min="1" value="1" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Qty">
                <input id="orderTrigger" type="number" step="0.01" class="bg-[#1c1c1e] text-white border border-gray-600 rounded px-2 py-2 text-sm" placeholder="Trigger">
            </div>
            <div class="flex gap-3">
                <button onclick="execDetailTrade('BUY')" class="flex-1 bg-[#34c759] hover:bg-[#2db34e] text-white font-semibold py-3 rounded-xl text-base transition">Buy / Place</button>
                <button onclick="execDetailTrade('SELL')" class="flex-1 bg-[#ff453a] hover:bg-[#e03d33] text-white font-semibold py-3 rounded-xl text-base transition">Sell / Place</button>
            </div>
            <div id="pendingOrdersList" class="mt-3 text-xs text-gray-300 space-y-1"></div>
            <!-- Journal note for this stock -->
            <div id="stockJournalNote" style="margin-top:12px;display:none;background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.2);border-radius:10px;padding:12px;">
                <div style="font-size:10px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ““ Your Journal</div>
                <div id="stockJournalText" style="font-size:13px;color:#c0c0d8;line-height:1.6;"></div>
            </div>
            <div id="detailNews" class="mt-4 space-y-2"></div>
        </div>
        <!-- Fee structure panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
                <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0;">ğŸ’¸ Fee Structure</h3>
                <span style="font-size:10px;background:rgba(34,197,94,0.12);color:#4ade80;padding:2px 8px;border-radius:4px;font-weight:700;">$0 Commission</span>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Stock Trades</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">$0.00</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">No commissions</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Order Execution</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">Free</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Instant fills</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Account Fee</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">$0.00</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Forever free</div>
                </div>
                <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:10px;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;letter-spacing:0.05em;margin-bottom:4px;">Spreads</div>
                    <div style="font-size:1.1rem;font-family:var(--v-mono);color:#4ade80;">Real</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Live bid/ask</div>
                </div>
            </div>
            <p style="font-size:10px;color:#4a4a6a;margin:10px 0 0;text-align:center;">Vestra is a paper trading simulator. No real money involved.</p>
        </div>

        <!-- Auto-Bot Rules panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0;">ğŸ¤– Auto-Bot Rules</h3>
                <button onclick="openBotBuilder()" style="font-size:10px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);padding:3px 10px;border-radius:5px;cursor:pointer;">+ New Rule</button>
            </div>
            <div id="botRulesList" style="font-size:11px;color:#8888a8;min-height:32px;">
                <div style="text-align:center;padding:8px 0;font-style:italic;">No auto-rules yet. Set conditions to trade automatically.</div>
            </div>
        </div>

        <!-- SIP / Recurring Investment Panel -->
        <div style="background:#1e1e28;border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:16px;margin-top:16px;" id="sipDetailPanel">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <h3 style="color:#f0f0fa;font-size:0.875rem;font-weight:600;margin:0 0 2px;">ğŸ“… SIP / Recurring Invest</h3>
                    <div style="font-size:10px;color:#8888a8;">Dollar-cost average automatically</div>
                </div>
                <button onclick="openSIP(detailStock)" style="font-size:10px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.2);padding:3px 10px;border-radius:5px;cursor:pointer;">+ New Plan</button>
            </div>
            <div id="sipDetailList" style="font-size:11px;color:#8888a8;min-height:28px;">
                <div style="text-align:center;padding:6px 0;font-style:italic;">No active SIP plans for this stock.</div>
            </div>
            <!-- DCA stats row â€” shown when plans exist -->
            <div id="sipDcaStats" style="display:none;margin-top:10px;padding-top:10px;border-top:1px solid rgba(255,255,255,0.05);display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Avg Cost</div>
                    <div id="sipAvgCost" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">â€”</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Total Invested</div>
                    <div id="sipTotalInvested" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">â€”</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Executions</div>
                    <div id="sipExecCount" style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">0</div>
                </div>
            </div>
        </div>

        <!-- Share portfolio button -->
        <div style="text-align:center;padding:16px 0 8px;">
            <button onclick="sharePortfolio()" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#a0a0b8;padding:10px 24px;border-radius:10px;font-size:13px;font-weight:600;cursor:pointer;" onmouseover="this.style.borderColor='var(--v-gold)';this.style.color='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.1)';this.style.color='#a0a0b8'">ğŸ”— Share My Portfolio</button>
        </div>
    </div>
</div>

<!-- â•â•â• IMMERSIVE TUTORIAL OVERLAY â•â•â• -->
<div id="tutorialOverlay" class="hidden">
    <div class="tutorial-card">
        <!-- Progress bar -->
        <div class="tutorial-progress-bar">
            <div class="tutorial-progress-fill" id="tutorialProgressFill" style="width:0%"></div>
        </div>
        <!-- Step indicator -->
        <div class="flex items-center justify-between px-8 pt-6 pb-0">
            <div class="flex gap-2" id="tutorialDots"></div>
            <button onclick="skipTutorial()" class="text-xs text-gray-500 hover:text-gray-300 transition font-medium">Skip tutorial</button>
        </div>
        <!-- Content -->
        <div class="px-8 py-6">
            <div id="tutorialIcon" class="text-5xl mb-4 text-center"></div>
            <h2 id="tutorialTitle" class="text-white text-2xl font-bold mb-3 text-center"></h2>
            <p id="tutorialDesc" class="text-gray-400 text-sm leading-relaxed text-center mb-6"></p>
            <!-- Highlight hint box -->
            <div id="tutorialHint" class="hidden rounded-xl px-4 py-3 mb-6 text-sm text-center font-medium" style="background:rgba(139,92,246,0.15);border:1px solid rgba(139,92,246,0.3);color:#c4b5fd;"></div>
        </div>
        <!-- Actions -->
        <div class="px-8 pb-8 flex gap-3">
            <button id="tutorialPrevBtn" onclick="tutorialPrev()" class="hidden flex-1 border border-gray-600 text-gray-300 hover:border-gray-400 font-semibold py-3 rounded-xl text-sm transition">â† Back</button>
            <button id="tutorialNextBtn" onclick="tutorialNext()" class="flex-1 font-bold py-3 rounded-xl text-sm transition text-white" style="background:linear-gradient(135deg,#7c3aed,#a78bfa)">Continue â†’</button>
        </div>
    </div>
</div>

<!-- â•â•â• API CONFIG MODAL â•â•â• -->
<div id="apiConfigModal" class="fixed inset-0 z-[9999] hidden flex items-center justify-center" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);">
    <div style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:20px;box-shadow:0 30px 80px rgba(0,0,0,0.7);width:100%;max-width:520px;padding:36px;">
        <div style="display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:24px;">
            <div>
                <h2 style="font-size:1.25rem;font-weight:700;color:#f0f0fa;margin:0 0 4px;">âš¡ Real-Time Market Data</h2>
                <p style="font-size:0.85rem;color:#8888a8;margin:0;">Connect your Finnhub API key for live prices</p>
            </div>
            <button onclick="closeApiConfig()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;line-height:1;padding:0;" onmouseover="this.style.color='#f0f0fa'" onmouseout="this.style.color='#8888a8'">&times;</button>
        </div>
        <div style="background:rgba(99,179,237,0.08);border:1px solid rgba(99,179,237,0.2);border-radius:12px;padding:14px;margin-bottom:12px;font-size:0.875rem;color:#90cdf4;">
            <strong style="color:#bee3f8;">Free Finnhub API</strong> â€” Get your key at
            <a href="https://finnhub.io/register" target="_blank" style="color:#63b3ed;font-weight:600;text-decoration:underline;">finnhub.io/register</a>
            &nbsp;(60 calls/min, no credit card needed)
        </div>

        <div id="apiConfigError" class="hidden" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:10px 14px;border-radius:8px;font-size:13px;margin-bottom:16px;"></div>
        <div style="margin-bottom:16px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Finnhub API Key</label>
            <input id="finnhubKeyInput" type="text" placeholder="e.g. d0abc123..." style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;font-family:var(--v-mono);outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.12)'">
            <p style="font-size:11px;color:#606080;margin-top:6px;">Stored locally in your browser â€” never sent to any server.</p>
        </div>
        <div style="margin-bottom:24px;">
            <label style="display:block;font-size:12px;font-weight:700;color:#a0a0b8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Update Interval</label>
            <select id="updateIntervalInput" style="width:100%;background:#0f0f18;border:1px solid rgba(255,255,255,0.12);border-radius:10px;padding:12px 14px;font-size:14px;color:#e8e8f5;outline:none;">
                <option value="10000">Every 10 seconds (recommended)</option>
                <option value="15000">Every 15 seconds</option>
                <option value="30000">Every 30 seconds</option>
                <option value="60000">Every 60 seconds</option>
            </select>
        </div>
        <div style="display:flex;gap:12px;">
            <button onclick="saveApiConfig()" style="flex:1;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:14px;border-radius:10px;border:none;font-size:15px;cursor:pointer;font-family:var(--v-sans);" onmouseover="this.style.background='var(--v-gold-light)'" onmouseout="this.style.background='var(--v-gold)'">Save & Activate</button>
            <button onclick="clearApiConfig()" style="background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.25);color:#f87171;padding:14px 20px;border-radius:10px;font-size:14px;font-weight:600;cursor:pointer;" onmouseover="this.style.background='rgba(239,68,68,0.18)'" onmouseout="this.style.background='rgba(239,68,68,0.1)'">Clear</button>
        </div>
        <div id="apiTestResult" style="margin-top:12px;font-size:13px;text-align:center;color:#8888a8;display:none;"></div>
    </div>
</div>


<!-- â•â•â• SIP / RECURRING INVESTMENT MODAL â•â•â• -->
<div id="sipModal" style="display:none;position:fixed;inset:0;z-index:9100;background:rgba(0,0,0,0.85);backdrop-filter:blur(10px);">
  <div style="background:#14141e;border:1px solid rgba(212,168,75,0.2);border-radius:20px;width:100%;max-width:560px;margin:60px auto;padding:0;overflow:hidden;animation:slideUp 0.3s cubic-bezier(0.16,1,0.3,1);">

    <!-- Header -->
    <div style="padding:22px 26px 0;border-bottom:1px solid rgba(255,255,255,0.06);padding-bottom:18px;">
      <div style="display:flex;justify-content:space-between;align-items:flex-start;">
        <div>
          <h2 style="font-family:var(--v-serif);font-size:1.35rem;color:#f0f0fa;margin:0 0 4px;">ğŸ“… Create SIP Plan</h2>
          <p style="font-size:12px;color:#8888a8;margin:0;">Invest automatically at regular intervals â€” practice dollar-cost averaging</p>
        </div>
        <button onclick="closeSIP()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;line-height:1;">&times;</button>
      </div>
    </div>

    <!-- Type tabs -->
    <div style="display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,0.06);">
      <button onclick="setSIPType('stock')" id="sipTab-stock" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:rgba(212,168,75,0.1);color:var(--v-gold);border:none;border-bottom:2px solid var(--v-gold);cursor:pointer;">ğŸ“ˆ Stock SIP</button>
      <button onclick="setSIPType('fractional')" id="sipTab-fractional" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ”¬ Fractional</button>
      <button onclick="setSIPType('etf')" id="sipTab-etf" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ¦ ETF</button>
      <button onclick="setSIPType('drip')" id="sipTab-drip" style="flex:1;padding:11px;font-size:11px;font-weight:700;background:transparent;color:#8888a8;border:none;border-bottom:2px solid transparent;cursor:pointer;">ğŸ’° DRIP</button>
    </div>

    <!-- Body -->
    <div style="padding:20px 26px 26px;">

      <!-- Type description banner -->
      <div id="sipTypeBanner" style="background:rgba(212,168,75,0.06);border:1px solid rgba(212,168,75,0.15);border-radius:8px;padding:10px 12px;margin-bottom:16px;font-size:11px;color:#a08840;line-height:1.55;"></div>

      <!-- Fields -->
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div id="sipSymbolGroup">
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Symbol</label>
          <input id="sipSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;font-family:var(--v-mono);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
        <div>
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;" id="sipAmountLabel">Amount ($)</label>
          <input id="sipAmount" type="number" min="1" step="1" placeholder="e.g. 100" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
        <div>
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Frequency</label>
          <select id="sipFreq" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;">
            <option value="daily">Daily</option>
            <option value="weekly" selected>Weekly</option>
            <option value="biweekly">Bi-weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
        <div id="sipMaxAmountGroup">
          <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Max Total ($)</label>
          <input id="sipMaxTotal" type="number" min="0" step="100" placeholder="Unlimited" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">
        </div>
      </div>

      <!-- DRIP-specific toggle -->
      <div id="sipDripToggleGroup" style="display:none;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:10px;cursor:pointer;">
          <input type="checkbox" id="sipDripEnabled" checked style="width:14px;height:14px;accent-color:var(--v-gold);">
          <span style="font-size:12px;color:#c0c0d8;">Reinvest dividends as fractional shares</span>
        </label>
      </div>

      <!-- DCA projection (live update) -->
      <div id="sipProjection" style="background:rgba(34,197,94,0.05);border:1px solid rgba(34,197,94,0.12);border-radius:8px;padding:10px 12px;margin-bottom:14px;">
        <div style="font-size:9px;font-weight:700;color:#4ade80;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ“Š DCA Projection</div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;">
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">3-month invest</div>
            <div id="sipProj3m" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">1-year invest</div>
            <div id="sipProj1y" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:10px;color:#6868a0;margin-bottom:2px;">Est. shares (1yr)</div>
            <div id="sipProjShares" style="font-family:var(--v-mono);font-size:0.875rem;color:#e0e0f5;">â€”</div>
          </div>
        </div>
      </div>

      <div id="sipError" style="display:none;margin-bottom:10px;font-size:11px;color:#f87171;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);border-radius:6px;padding:8px 10px;"></div>
      <button onclick="saveSIPPlan()" style="width:100%;background:linear-gradient(135deg,var(--v-gold),var(--v-gold-light));color:#0a0a0f;font-weight:700;padding:13px;border-radius:9px;border:none;font-size:13px;cursor:pointer;letter-spacing:0.02em;">Activate SIP Plan â†’</button>
    </div>

  </div>
</div>

<!-- â•â•â• STOCK SCREENER MODAL â•â•â• -->
<div id="screenerModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:900px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ” Stock Screener</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Filter 500+ stocks by technical, fundamental, and market criteria</p>
      </div>
      <button onclick="closeScreener()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <!-- Filters row -->
    <div style="padding:16px 24px;border-bottom:1px solid rgba(255,255,255,0.07);display:flex;gap:10px;flex-wrap:wrap;">
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Sector</label>
        <select id="scSector" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">All Sectors</option>
          <option>Technology</option><option>Finance</option><option>Healthcare</option>
          <option>Consumer</option><option>Energy</option><option>Industrial</option>
          <option>Real Estate</option><option>Utilities</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Change %</label>
        <select id="scChange" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any</option>
          <option value="up5">Gainers &gt;5%</option>
          <option value="up2">Gainers &gt;2%</option>
          <option value="down2">Losers &lt;-2%</option>
          <option value="down5">Losers &lt;-5%</option>
          <option value="flat">Flat (Â±1%)</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">Price Range</label>
        <select id="scPrice" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any Price</option>
          <option value="0-50">Under $50</option>
          <option value="50-200">$50â€“$200</option>
          <option value="200-500">$200â€“$500</option>
          <option value="500+">Over $500</option>
        </select>
      </div>
      <div style="display:flex;flex-direction:column;gap:4px;">
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;">P/E Ratio</label>
        <select id="scPE" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:5px 8px;font-size:11px;color:#e0e0f5;outline:none;">
          <option value="">Any P/E</option>
          <option value="low">Value (&lt;15)</option>
          <option value="mid">Moderate (15â€“35)</option>
          <option value="high">Growth (&gt;35)</option>
          <option value="neg">Unprofitable</option>
        </select>
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button onclick="runScreener()" style="background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:6px 18px;border-radius:7px;border:none;font-size:11px;cursor:pointer;white-space:nowrap;">Run Screen</button>
      </div>
    </div>
    <!-- Results -->
    <div id="screenerResults" style="padding:16px 24px 24px;max-height:480px;overflow-y:auto;">
      <div style="text-align:center;color:#8888a8;padding:32px 0;font-size:13px;">Set filters above and click Run Screen</div>
    </div>
  </div>
</div>

<!-- â•â•â• ECONOMIC CALENDAR MODAL â•â•â• -->
<div id="calendarModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:700px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ“… Economic Calendar</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Upcoming market events, Fed meetings & earnings</p>
      </div>
      <button onclick="closeCalendar()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <div id="calendarContent" style="padding:20px 24px 28px;"></div>
  </div>
</div>

<!-- â•â•â• COMMUNITY FEED MODAL â•â•â• -->
<div id="communityModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:680px;height:80vh;margin:5vh auto;display:flex;flex-direction:column;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:18px 22px;border-bottom:1px solid rgba(255,255,255,0.07);flex-shrink:0;">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0 0 2px;">ğŸ’¬ Community</h2>
        <p style="font-size:11px;color:#8888a8;margin:0;">Share trade ideas and market insights</p>
      </div>
      <button onclick="closeCommunity()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <!-- Post composer -->
    <div style="padding:14px 20px;border-bottom:1px solid rgba(255,255,255,0.06);flex-shrink:0;">
      <div style="display:flex;gap:10px;align-items:flex-start;">
        <div id="communityAvatar" style="width:32px;height:32px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:13px;font-weight:700;flex-shrink:0;">?</div>
        <div style="flex:1;">
          <textarea id="communityPost" placeholder="Share your trade idea, analysis, or market thoughtsâ€¦" style="width:100%;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px 10px;font-size:12px;color:#e0e0f5;font-family:var(--v-sans);outline:none;resize:none;height:56px;line-height:1.5;" onfocus="this.style.borderColor='rgba(212,168,75,0.4)'" onblur="this.style.borderColor='rgba(255,255,255,0.08)'"></textarea>
          <div style="display:flex;justify-content:flex-end;margin-top:6px;">
            <button onclick="postCommunityIdea()" style="background:var(--v-gold);color:#0a0a0f;font-weight:700;font-size:11px;padding:5px 14px;border-radius:6px;border:none;cursor:pointer;">Post Idea</button>
          </div>
        </div>
      </div>
    </div>
    <!-- Feed -->
    <div id="communityFeed" style="flex:1;overflow-y:auto;padding:12px 20px 16px;display:flex;flex-direction:column;gap:10px;"></div>
  </div>
</div>

<!-- â•â•â• EDUCATION HUB MODAL â•â•â• -->
<div id="educationModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);overflow-y:auto;">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:780px;margin:40px auto;padding:0;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:20px 24px;border-bottom:1px solid rgba(255,255,255,0.07);">
      <div>
        <h2 style="font-family:var(--v-serif);font-size:1.4rem;color:#f0f0fa;margin:0 0 2px;">ğŸ“ Education Hub</h2>
        <p style="font-size:12px;color:#8888a8;margin:0;">Learn trading fundamentals, strategies, and technical analysis</p>
      </div>
      <button onclick="closeEducation()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <div id="educationContent" style="padding:20px 24px 28px;"></div>
  </div>
</div>

<!-- â•â•â• AUTO-BOT BUILDER MODAL â•â•â• -->
<div id="botModal" style="display:none;position:fixed;inset:0;z-index:9000;background:rgba(0,0,0,0.8);backdrop-filter:blur(8px);">
  <div style="background:#14141e;border:1px solid rgba(255,255,255,0.1);border-radius:20px;width:100%;max-width:520px;margin:60px auto;padding:28px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;">
      <h2 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0;">ğŸ¤– Create Auto-Rule</h2>
      <button onclick="closeBotBuilder()" style="background:none;border:none;color:#8888a8;font-size:22px;cursor:pointer;padding:0;">&times;</button>
    </div>
    <p style="font-size:12px;color:#8888a8;margin:0 0 18px;line-height:1.6;">Set a condition â€” when it triggers, a paper trade executes automatically.</p>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Symbol</label>
        <input id="botSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Action</label>
        <select id="botAction" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
          <option value="BUY">Buy</option>
          <option value="SELL">Sell</option>
        </select>
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Qty</label>
        <input id="botQty" type="number" min="1" value="1" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
      </div>
      <div>
        <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Condition</label>
        <select id="botCondition" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
          <option value="above">Price rises above</option>
          <option value="below">Price falls below</option>
          <option value="up_pct">% gain since open</option>
          <option value="down_pct">% drop since open</option>
        </select>
      </div>
    </div>
    <div style="margin-bottom:16px;">
      <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:4px;">Trigger Value</label>
      <input id="botTrigger" type="number" step="0.01" placeholder="e.g. 150.00" style="width:100%;background:#1a1a24;border:1px solid rgba(255,255,255,0.1);border-radius:6px;padding:7px 9px;font-size:12px;color:#e0e0f5;outline:none;">
    </div>
    <button onclick="saveBotRule()" style="width:100%;background:var(--v-gold);color:#0a0a0f;font-weight:700;padding:12px;border-radius:8px;border:none;font-size:13px;cursor:pointer;">Create Rule</button>
    <div id="botError" style="display:none;margin-top:8px;font-size:11px;color:#f87171;text-align:center;"></div>
  </div>
</div>
</div><!-- end #appPage -->

<script>
    // â”€â”€ Clear any previously hardcoded API key if it matches the old default â”€â”€
    (function() {
        const OLD_KEY = 'd6c804pr01qsiik14ah0d6c804pr01qsiik14ahg';
        const stored = localStorage.getItem('finnhub_api_key');
        if (stored === OLD_KEY) {
            localStorage.removeItem('finnhub_api_key');
            localStorage.removeItem('finnhub_interval');
        }
    })();

    // --- Data Setup ---
    // Full 500 Ticker List (Simulated)
    // Real stock data as of Feb 17, 2026
    // â”€â”€ Real prices as of Feb 17 2026 (Robinhood / Google Finance) â”€â”€
    const realStockData = {
        'AAPL':  { name: 'Apple Inc.',               price: 254.86,  change: -2.27,  pe: 32.36,  mktCap: '3.76T', div: '0.41%', divAmt: '0.26', wkHigh: 288.62,  wkLow: 169.21 },
        'MSFT':  { name: 'Microsoft Corp.',           price: 400.00,  change: -0.29,  pe: 25.11,  mktCap: '2.98T', div: '0.84%', divAmt: '0.91', wkHigh: 555.45,  wkLow: 344.79 },
        'NVDA':  { name: 'NVIDIA Corp.',              price: 181.51,  change: -2.22,  pe: 49.60,  mktCap: '4.42T', div: '0.04%', divAmt: '0.01', wkHigh: 212.19,  wkLow: 86.62  },
        'GOOGL': { name: 'Alphabet Inc. Class A',     price: 305.72,  change: -1.06,  pe: 22.45,  mktCap: '3.69T', div: '0.00%', divAmt: '0.00', wkHigh: 349.00,  wkLow: 140.53 },
        'AMZN':  { name: 'Amazon.com Inc.',           price: 198.95,  change: -0.42,  pe: 41.50,  mktCap: '2.12T', div: '0.00%', divAmt: '0.00', wkHigh: 258.60,  wkLow: 161.38 },
        'META':  { name: 'Meta Platforms Inc.',       price: 638.64,  change: -1.55,  pe: 29.80,  mktCap: '1.61T', div: '0.00%', divAmt: '0.00', wkHigh: 796.25,  wkLow: 479.80 },
        'TSLA':  { name: 'Tesla Inc.',                price: 417.44,  change: -0.09,  pe: 388.17, mktCap: '1.57T', div: '0.00%', divAmt: '0.00', wkHigh: 498.83,  wkLow: 214.25 },
        'BRK.B': { name: 'Berkshire Hathaway B',      price: 488.15,  change: 0.42,   pe: 22.10,  mktCap: '1.07T', div: '0.00%', divAmt: '0.00', wkHigh: 497.20,  wkLow: 370.55 },
        'JPM':   { name: 'JPMorgan Chase & Co.',      price: 302.68,  change: 0.54,   pe: 14.20,  mktCap: '851B',  div: '2.38%', divAmt: '1.40', wkHigh: 337.25,  wkLow: 202.16 },
        'AVGO':  { name: 'Broadcom Inc.',             price: 324.96,  change: -1.82,  pe: 68.24,  mktCap: '1.54T', div: '1.24%', divAmt: '0.65', wkHigh: 414.61,  wkLow: 138.10 },
        'XOM':   { name: 'Exxon Mobil Corp.',         price: 148.70,  change: -1.90,  pe: 14.50,  mktCap: '632B',  div: '3.40%', divAmt: '0.99', wkHigh: 156.93,  wkLow: 97.80  },
        'WMT':   { name: 'Walmart Inc.',              price: 134.05,  change: 0.60,   pe: 38.90,  mktCap: '1.08T', div: '0.88%', divAmt: '0.24', wkHigh: 134.65,  wkLow: 79.81  },
        'COST':  { name: 'Costco Wholesale Corp.',    price: 1016.20, change: 1.40,   pe: 54.80,  mktCap: '441B',  div: '0.55%', divAmt: '1.16', wkHigh: 1077.49, wkLow: 844.06 },
        'V':     { name: 'Visa Inc.',                 price: 314.17,  change: -3.14,  pe: 29.76,  mktCap: '598B',  div: '0.91%', divAmt: '0.59', wkHigh: 375.51,  wkLow: 299.00 },
        'MA':    { name: 'Mastercard Inc.',           price: 571.44,  change: -0.18,  pe: 38.50,  mktCap: '527B',  div: '0.59%', divAmt: '0.76', wkHigh: 581.30,  wkLow: 440.34 },
        'LLY':   { name: 'Eli Lilly and Co.',         price: 858.60,  change: -1.20,  pe: 62.30,  mktCap: '817B',  div: '0.67%', divAmt: '1.50', wkHigh: 972.53,  wkLow: 704.17 },
        'UNH':   { name: 'UnitedHealth Group Inc.',   price: 538.22,  change: -0.44,  pe: 19.80,  mktCap: '496B',  div: '1.57%', divAmt: '2.21', wkHigh: 629.73,  wkLow: 462.86 },
        'PG':    { name: 'Procter & Gamble Co.',      price: 165.45,  change: 0.33,   pe: 25.70,  mktCap: '388B',  div: '2.43%', divAmt: '1.06', wkHigh: 177.98,  wkLow: 151.42 },
        'HD':    { name: 'Home Depot Inc.',           price: 396.56,  change: -0.55,  pe: 26.40,  mktCap: '393B',  div: '2.40%', divAmt: '2.25', wkHigh: 439.37,  wkLow: 316.90 },
        'JNJ':   { name: 'Johnson & Johnson',         price: 158.32,  change: 0.18,   pe: 22.50,  mktCap: '384B',  div: '3.07%', divAmt: '1.24', wkHigh: 168.93,  wkLow: 140.67 },
        'ORCL':  { name: 'Oracle Corp.',              price: 157.20,  change: -1.80,  pe: 29.40,  mktCap: '435B',  div: '1.02%', divAmt: '0.40', wkHigh: 345.72,  wkLow: 118.86 },
        'MRK':   { name: 'Merck & Co. Inc.',          price: 89.44,   change: -0.65,  pe: 12.10,  mktCap: '225B',  div: '3.71%', divAmt: '0.81', wkHigh: 134.63,  wkLow: 84.46  },
        'ABT':   { name: 'Abbott Laboratories',       price: 129.83,  change: 0.22,   pe: 23.10,  mktCap: '226B',  div: '1.87%', divAmt: '0.59', wkHigh: 136.15,  wkLow: 97.11  },
        'ABBV':  { name: 'AbbVie Inc.',               price: 196.24,  change: 0.41,   pe: 55.20,  mktCap: '345B',  div: '3.16%', divAmt: '1.64', wkHigh: 214.82,  wkLow: 147.35 },
        'CVX':   { name: 'Chevron Corp.',             price: 161.88,  change: -0.72,  pe: 14.90,  mktCap: '302B',  div: '4.25%', divAmt: '1.71', wkHigh: 171.69,  wkLow: 135.37 },
        'NFLX':  { name: 'Netflix Inc.',              price: 76.97,   change: 1.33,   pe: 50.40,  mktCap: '33B',   div: '0.00%', divAmt: '0.00', wkHigh: 134.12,  wkLow: 75.23  },
        'AMD':   { name: 'Advanced Micro Devices',    price: 206.82,  change: -0.69,  pe: 94.20,  mktCap: '334B',  div: '0.00%', divAmt: '0.00', wkHigh: 267.08,  wkLow: 76.48  },
        'ADBE':  { name: 'Adobe Inc.',                price: 263.93,  change: -0.50,  pe: 23.40,  mktCap: '114B',  div: '0.00%', divAmt: '0.00', wkHigh: 464.99,  wkLow: 251.10 },
        'CRM':   { name: 'Salesforce Inc.',           price: 188.40,  change: -0.50,  pe: 30.10,  mktCap: '181B',  div: '0.00%', divAmt: '0.00', wkHigh: 329.74,  wkLow: 180.24 },
        'INTC':  { name: 'Intel Corp.',               price: 46.62,   change: 0.65,   pe: 0,      mktCap: '199B',  div: '0.86%', divAmt: '0.13', wkHigh: 54.60,   wkLow: 17.67  },
        'CSCO':  { name: 'Cisco Systems Inc.',        price: 62.47,   change: 0.28,   pe: 17.20,  mktCap: '251B',  div: '2.91%', divAmt: '0.41', wkHigh: 64.72,   wkLow: 44.51  },
        'PFE':   { name: 'Pfizer Inc.',               price: 26.18,   change: -0.38,  pe: 9.60,   mktCap: '148B',  div: '6.57%', divAmt: '0.43', wkHigh: 32.44,   wkLow: 22.91  },
        'TMO':   { name: 'Thermo Fisher Scientific',  price: 547.12,  change: -0.90,  pe: 25.70,  mktCap: '213B',  div: '0.29%', divAmt: '0.39', wkHigh: 621.65,  wkLow: 478.35 },
        'DIS':   { name: 'Walt Disney Co.',           price: 111.60,  change: 1.10,   pe: 38.40,  mktCap: '202B',  div: '0.86%', divAmt: '0.50', wkHigh: 123.74,  wkLow: 83.91  },
        'KO':    { name: 'Coca-Cola Co.',             price: 71.08,   change: 0.52,   pe: 25.10,  mktCap: '306B',  div: '2.89%', divAmt: '0.51', wkHigh: 73.53,   wkLow: 56.57  },
        'PEP':   { name: 'PepsiCo Inc.',              price: 150.47,  change: -0.18,  pe: 21.40,  mktCap: '207B',  div: '3.65%', divAmt: '1.42', wkHigh: 183.41,  wkLow: 142.76 },
        'BAC':   { name: 'Bank of America Corp.',     price: 46.72,   change: 0.85,   pe: 14.10,  mktCap: '358B',  div: '2.49%', divAmt: '0.26', wkHigh: 48.08,   wkLow: 32.36  },
        'WFC':   { name: 'Wells Fargo & Co.',         price: 76.34,   change: 0.92,   pe: 13.20,  mktCap: '256B',  div: '2.36%', divAmt: '0.40', wkHigh: 81.49,   wkLow: 49.60  },
        'GS':    { name: 'Goldman Sachs Group',       price: 904.50,  change: 1.50,   pe: 17.64,  mktCap: '271B',  div: '1.50%', divAmt: '3.50', wkHigh: 984.70,  wkLow: 439.38 },
        'MS':    { name: 'Morgan Stanley',            price: 130.47,  change: 0.60,   pe: 20.80,  mktCap: '214B',  div: '3.07%', divAmt: '0.925',wkHigh: 137.00,  wkLow: 90.98  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'QCOM':  { name: 'Qualcomm Inc.',             price: 162.40,  change: -1.30,  pe: 14.30,  mktCap: '172B',  div: '2.11%', divAmt: '0.89', wkHigh: 230.63,  wkLow: 143.27 },
        'TXN':   { name: 'Texas Instruments Inc.',    price: 179.55,  change: -0.70,  pe: 28.40,  mktCap: '162B',  div: '2.95%', divAmt: '1.36', wkHigh: 220.39,  wkLow: 152.64 },
        'AMGN':  { name: 'Amgen Inc.',                price: 262.10,  change: 0.30,   pe: 17.80,  mktCap: '140B',  div: '3.51%', divAmt: '2.38', wkHigh: 329.65,  wkLow: 236.87 },
        'HON':   { name: 'Honeywell Intl. Inc.',      price: 219.66,  change: -0.42,  pe: 22.50,  mktCap: '137B',  div: '2.19%', divAmt: '1.13', wkHigh: 235.36,  wkLow: 185.33 },
        'NKE':   { name: 'Nike Inc.',                 price: 74.29,   change: -0.68,  pe: 22.10,  mktCap: '111B',  div: '2.15%', divAmt: '0.40', wkHigh: 97.67,   wkLow: 70.41  },
        'CAT':   { name: 'Caterpillar Inc.',          price: 386.30,  change: 0.55,   pe: 19.30,  mktCap: '186B',  div: '1.58%', divAmt: '1.41', wkHigh: 418.49,  wkLow: 302.40 },
        'MCD':   { name: "McDonald's Corp.",          price: 301.67,  change: 0.33,   pe: 24.50,  mktCap: '217B',  div: '2.49%', divAmt: '1.77', wkHigh: 317.90,  wkLow: 243.97 },
        'SBUX':  { name: 'Starbucks Corp.',           price: 101.29,  change: 1.50,   pe: 32.60,  mktCap: '113B',  div: '2.95%', divAmt: '0.61', wkHigh: 115.07,  wkLow: 72.91  },
        'BA':    { name: 'Boeing Co.',                price: 183.24,  change: -1.80,  pe: 0,      mktCap: '139B',  div: '0.00%', divAmt: '0.00', wkHigh: 211.03,  wkLow: 136.32 },
        'PLTR':  { name: 'Palantir Technologies',     price: 131.72,  change: -5.20,  pe: 208.59, mktCap: '313B',  div: '0.00%', divAmt: '0.00', wkHigh: 207.52,  wkLow: 66.12  },
        'PANW':  { name: 'Palo Alto Networks',        price: 192.48,  change: 0.70,   pe: 52.40,  mktCap: '120B',  div: '0.00%', divAmt: '0.00', wkHigh: 210.20,  wkLow: 152.29 },
        'NOW':   { name: 'ServiceNow Inc.',           price: 1024.35, change: -2.40,  pe: 121.30, mktCap: '207B',  div: '0.00%', divAmt: '0.00', wkHigh: 1198.09, wkLow: 738.00 },
        'ISRG':  { name: 'Intuitive Surgical Inc.',   price: 579.88,  change: -1.10,  pe: 84.60,  mktCap: '205B',  div: '0.00%', divAmt: '0.00', wkHigh: 599.09,  wkLow: 363.75 },
        'AXP':   { name: 'American Express Co.',      price: 301.44,  change: 0.40,   pe: 21.50,  mktCap: '208B',  div: '1.01%', divAmt: '0.82', wkHigh: 325.87,  wkLow: 213.08 },
        'SPGI':  { name: 'S&P Global Inc.',           price: 497.32,  change: 0.22,   pe: 34.20,  mktCap: '157B',  div: '0.81%', divAmt: '0.94', wkHigh: 574.18,  wkLow: 421.72 },
        'BLK':   { name: 'BlackRock Inc.',            price: 1068.00, change: 0.55,   pe: 24.60,  mktCap: '158B',  div: '2.17%', divAmt: '5.21', wkHigh: 1088.11, wkLow: 755.12 },
        'RTX':   { name: 'RTX Corp.',                 price: 130.80,  change: 0.33,   pe: 37.50,  mktCap: '175B',  div: '2.04%', divAmt: '0.63', wkHigh: 138.52,  wkLow: 100.18 },
        'LMT':   { name: 'Lockheed Martin Corp.',     price: 487.26,  change: 0.48,   pe: 17.80,  mktCap: '119B',  div: '2.94%', divAmt: '3.30', wkHigh: 606.99,  wkLow: 414.10 },
        'VZ':    { name: 'Verizon Communications',    price: 40.23,   change: -0.25,  pe: 9.40,   mktCap: '169B',  div: '6.56%', divAmt: '0.67', wkHigh: 44.73,   wkLow: 38.16  },
        'T':     { name: 'AT&T Inc.',                 price: 26.94,   change: 0.15,   pe: 11.80,  mktCap: '193B',  div: '4.82%', divAmt: '0.28', wkHigh: 27.91,   wkLow: 16.11  },
        'NEE':   { name: 'NextEra Energy Inc.',       price: 73.14,   change: 0.55,   pe: 22.30,  mktCap: '149B',  div: '2.87%', divAmt: '0.54', wkHigh: 84.40,   wkLow: 57.88  },
        'DHR':   { name: 'Danaher Corp.',             price: 225.60,  change: -0.82,  pe: 36.40,  mktCap: '163B',  div: '0.49%', divAmt: '0.27', wkHigh: 265.57,  wkLow: 209.72 },
        'UNP':   { name: 'Union Pacific Corp.',       price: 251.90,  change: 0.18,   pe: 21.60,  mktCap: '151B',  div: '2.30%', divAmt: '1.34', wkHigh: 269.80,  wkLow: 214.37 },
        'PM':    { name: 'Philip Morris Intl.',       price: 135.88,  change: 0.62,   pe: 22.10,  mktCap: '212B',  div: '3.72%', divAmt: '1.35', wkHigh: 137.60,  wkLow: 91.20  },
        'COP':   { name: 'ConocoPhillips',            price: 107.18,  change: -0.55,  pe: 12.40,  mktCap: '138B',  div: '2.41%', divAmt: '0.78', wkHigh: 134.80,  wkLow: 95.61  },
        'MU':    { name: 'Micron Technology Inc.',    price: 94.76,   change: -2.30,  pe: 17.20,  mktCap: '105B',  div: '0.42%', divAmt: '0.115',wkHigh: 163.94,  wkLow: 78.20  },
        'AMAT':  { name: 'Applied Materials Inc.',    price: 171.22,  change: -2.80,  pe: 22.60,  mktCap: '142B',  div: '0.93%', divAmt: '0.40', wkHigh: 261.93,  wkLow: 148.10 },
        'LRCX':  { name: 'Lam Research Corp.',        price: 720.45,  change: -3.10,  pe: 22.80,  mktCap: '94B',   div: '1.09%', divAmt: '2.30', wkHigh: 1134.34, wkLow: 648.82 },
        'ADI':   { name: 'Analog Devices Inc.',       price: 209.80,  change: -1.55,  pe: 36.40,  mktCap: '109B',  div: '1.62%', divAmt: '0.92', wkHigh: 246.59,  wkLow: 186.76 },
        'INTU':  { name: 'Intuit Inc.',               price: 571.30,  change: -1.80,  pe: 47.20,  mktCap: '160B',  div: '0.70%', divAmt: '1.04', wkHigh: 721.98,  wkLow: 522.91 },
        'SCHW':  { name: 'Charles Schwab Corp.',      price: 80.94,   change: 0.75,   pe: 28.10,  mktCap: '148B',  div: '1.34%', divAmt: '0.25', wkHigh: 85.74,   wkLow: 56.38  },
        'GILD':  { name: 'Gilead Sciences Inc.',      price: 90.72,   change: 0.35,   pe: 16.40,  mktCap: '113B',  div: '3.17%', divAmt: '0.79', wkHigh: 101.75,  wkLow: 68.70  },
        'REGN':  { name: 'Regeneron Pharmaceuticals', price: 626.82,  change: -0.82,  pe: 21.40,  mktCap: '66B',   div: '0.00%', divAmt: '0.00', wkHigh: 1191.00, wkLow: 578.41 },
        'VRTX':  { name: 'Vertex Pharmaceuticals',    price: 498.22,  change: 0.55,   pe: 32.80,  mktCap: '128B',  div: '0.00%', divAmt: '0.00', wkHigh: 535.24,  wkLow: 364.29 },
        'DE':    { name: 'Deere & Co.',               price: 476.20,  change: -0.45,  pe: 19.50,  mktCap: '129B',  div: '1.47%', divAmt: '1.75', wkHigh: 496.73,  wkLow: 339.40 },
        'ACN':   { name: 'Accenture Plc.',            price: 338.70,  change: -0.55,  pe: 27.30,  mktCap: '212B',  div: '1.77%', divAmt: '1.48', wkHigh: 383.18,  wkLow: 288.16 },
        'WM':    { name: 'Waste Management Inc.',     price: 217.40,  change: 0.28,   pe: 31.20,  mktCap: '88B',   div: '1.48%', divAmt: '0.75', wkHigh: 222.05,  wkLow: 182.72 },
        'ITW':   { name: 'Illinois Tool Works',       price: 258.35,  change: -0.35,  pe: 24.80,  mktCap: '79B',   div: '2.49%', divAmt: '1.40', wkHigh: 271.04,  wkLow: 220.29 },
        'ETN':   { name: 'Eaton Corp. Plc.',          price: 347.80,  change: 0.42,   pe: 31.60,  mktCap: '138B',  div: '0.90%', divAmt: '0.86', wkHigh: 401.83,  wkLow: 240.79 },
        'LOW':   { name: "Lowe's Companies Inc.",     price: 265.12,  change: 0.33,   pe: 23.40,  mktCap: '152B',  div: '1.80%', divAmt: '1.15', wkHigh: 289.10,  wkLow: 210.99 },
        'SYK':   { name: 'Stryker Corp.',             price: 390.55,  change: 0.45,   pe: 33.50,  mktCap: '147B',  div: '0.90%', divAmt: '0.86', wkHigh: 421.33,  wkLow: 302.09 },
        'BDX':   { name: 'Becton Dickinson & Co.',    price: 223.80,  change: -0.30,  pe: 16.80,  mktCap: '64B',   div: '1.75%', divAmt: '0.95', wkHigh: 250.68,  wkLow: 211.50 },
        'MDT':   { name: 'Medtronic Plc.',            price: 87.44,   change: 0.25,   pe: 18.20,  mktCap: '116B',  div: '3.40%', divAmt: '0.70', wkHigh: 92.51,   wkLow: 71.93  },
        'C':     { name: 'Citigroup Inc.',            price: 84.32,   change: 0.92,   pe: 11.80,  mktCap: '161B',  div: '2.85%', divAmt: '0.56', wkHigh: 87.10,   wkLow: 54.80  },
        'MMC':   { name: 'Marsh & McLennan Cos.',     price: 221.60,  change: 0.18,   pe: 28.40,  mktCap: '108B',  div: '1.44%', divAmt: '0.815',wkHigh: 232.25,  wkLow: 185.56 },
        'CB':    { name: 'Chubb Ltd.',                price: 271.50,  change: 0.33,   pe: 13.80,  mktCap: '109B',  div: '1.35%', divAmt: '0.91', wkHigh: 300.12,  wkLow: 225.36 },
        'PLD':   { name: 'Prologis Inc.',             price: 106.78,  change: -0.45,  pe: 35.60,  mktCap: '97B',   div: '3.36%', divAmt: '0.96', wkHigh: 136.80,  wkLow: 96.68  },
        'CI':    { name: 'Cigna Group',               price: 298.45,  change: -0.38,  pe: 14.60,  mktCap: '71B',   div: '1.78%', divAmt: '1.40', wkHigh: 361.78,  wkLow: 268.60 },
        'ELV':   { name: 'Elevance Health Inc.',      price: 442.20,  change: -0.55,  pe: 14.20,  mktCap: '109B',  div: '1.44%', divAmt: '1.63', wkHigh: 581.35,  wkLow: 374.50 },
        'ZTS':   { name: 'Zoetis Inc.',               price: 155.60,  change: -0.72,  pe: 28.80,  mktCap: '71B',   div: '1.10%', divAmt: '0.432',wkHigh: 192.50,  wkLow: 146.43 },
        'BSX':   { name: 'Boston Scientific Corp.',   price: 102.84,  change: 0.32,   pe: 62.30,  mktCap: '147B',  div: '0.00%', divAmt: '0.00', wkHigh: 106.08,  wkLow: 66.22  },
        'FI':    { name: 'Fiserv Inc.',               price: 224.72,  change: 0.40,   pe: 24.50,  mktCap: '137B',  div: '0.00%', divAmt: '0.00', wkHigh: 249.80,  wkLow: 167.36 },
        'LIN':   { name: 'Linde Plc.',                price: 455.30,  change: 0.18,   pe: 30.20,  mktCap: '210B',  div: '1.26%', divAmt: '1.39', wkHigh: 494.99,  wkLow: 396.79 },
        'CMCSA': { name: 'Comcast Corp.',             price: 33.18,   change: -0.30,  pe: 9.20,   mktCap: '127B',  div: '3.31%', divAmt: '0.31', wkHigh: 41.26,   wkLow: 32.24  },
        'IBM':   { name: 'IBM Corp.',                 price: 266.41,  change: 0.45,   pe: 38.10,  mktCap: '238B',  div: '2.40%', divAmt: '1.67', wkHigh: 270.22,  wkLow: 161.71 },
        'TJX':   { name: 'TJX Companies Inc.',        price: 127.30,  change: 0.55,   pe: 30.40,  mktCap: '152B',  div: '1.23%', divAmt: '0.3625',wkHigh: 132.73, wkLow: 97.62  },
        'PGR':   { name: 'Progressive Corp.',         price: 262.40,  change: 0.42,   pe: 18.20,  mktCap: '153B',  div: '0.00%', divAmt: '0.00', wkHigh: 277.91,  wkLow: 175.50 },
        'MDLZ':  { name: 'Mondelez Intl. Inc.',       price: 61.34,   change: -0.18,  pe: 21.60,  mktCap: '80B',   div: '2.87%', divAmt: '0.435',wkHigh: 75.28,   wkLow: 58.54  },
        'ADP':   { name: 'ADP Inc.',                  price: 298.80,  change: 0.35,   pe: 29.30,  mktCap: '121B',  div: '2.07%', divAmt: '1.40', wkHigh: 318.53,  wkLow: 232.95 },
    };

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//   NEWS-DRIVEN VOLATILITY ENGINE (added 2026)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

const newsHeadlines = [
    { text: "FED RAISES RATES 50 bps â€“ growth stocks under pressure", sector: "Technology", impact: -9 },
    { text: "TECH MEGACAP RALLY: AI spending beats expectations", sector: "Technology", impact: +13 },
    { text: "OIL SURGES 8% after OPEC+ cuts production", sector: "Energy", impact: +11 },
    { text: "FDA grants full approval to breakthrough cancer therapy", sector: "Healthcare", impact: +16 },
    { text: "Consumer confidence hits 2-year high", sector: "Consumer", impact: +8 },
    { text: "Semiconductor shortage worsens â€“ supply chain warning", sector: "Technology", impact: -10 },
    { text: "Crypto rebounds sharply after regulatory clarity", sector: "Financials", impact: +14 },
    { text: "Major bank reports stronger-than-expected Q4 earnings", sector: "Financials", impact: +7 },
    { text: "Global chip export restrictions tightened", sector: "Technology", impact: -12 },
    { text: "Renewable energy subsidies expanded in new bill", sector: "Energy", impact: +10 },
    { text: "Inflation cools more than expected", sector: "Consumer", impact: +6 },
    { text: "Big Tech faces new antitrust scrutiny in EU", sector: "Technology", impact: -8 }
];

let newsTimer = null;

function showNewsEvent() {
    const event = newsHeadlines[Math.floor(Math.random() * newsHeadlines.length)];
    
    const banner = document.getElementById('newsBanner');
    const headlineEl = document.getElementById('newsHeadline');
    
    headlineEl.textContent = event.text;
    banner.style.background = event.impact >= 0 ? '#065f46' : '#991b1b';
    banner.classList.remove('hidden');
    
    // Apply sector-wide movement
    stocks.forEach(stock => {
        if (stock.sector === event.sector) {
            // 70â€“130% of base impact + individual noise
            const move = event.impact * (0.7 + Math.random() * 0.6);
            stock.price = Math.max(0.5, stock.price * (1 + move / 100));
            stock.change = Number((move + (Math.random() - 0.5) * 4).toFixed(2));
        }
    });

    // Hide banner after 5.5 seconds
    setTimeout(() => {
        banner.classList.add('hidden');
    }, 5500);

    // Refresh UI
    renderGrid();
    if (detailStock) {
        const updated = stocks.find(s => s.symbol === detailStock.symbol);
        if (updated) openStockDetail(updated);
    }
    updateUI();
}

function startNewsEngine() {
    if (newsTimer) clearInterval(newsTimer);
    // First event after 8â€“15 seconds, then every 24â€“36 seconds
    const firstDelay = 8000 + Math.random() * 7000;
    setTimeout(showNewsEvent, firstDelay);
    
    newsTimer = setInterval(showNewsEvent, 24000 + Math.random() * 12000);
}

    const tickers = Object.keys(realStockData);
    // Fill remaining spots to ~200 with realistic sector peers
    const extraTickers = ['PYPL','SQ','UBER','LYFT','SNAP','PINS','TWTR','RBLX','COIN','HOOD','DKNG','PENN','MGM','CZR','WYNN','LVS','NCLH','CCL','RCL','DAL','UAL','AAL','LUV','JBLU','ALK','F','GM','RIVN','LCID','NIO','LI','XPEV','BIDU','JD','PDD','BABA','TCOM','NTES','BILI','IQ','TME','FUTU','TIGR','ZM','DOCU','WORK','BOX','DBX','ESTC','MDB','DDOG','NET','FSLY','CRWD','S','OKTA','MIME','PING','SAIL','SAIL','ATEN','ALTR','CALD','FROG','SUMO','NLOK','VNET','CLDR','SPLK','ONEM','HIMS','TDOC','AMWL','ACCD','PHR','GDRX','CLOV','OSGN','SMAR','APPN','MNDY','TTWO','EA','ATVI','ZNGA','SCPL','MZOR','OMCL','NUAN','HLTH','AMPH','CHNG'];
    extraTickers.forEach(t => {
        if (!realStockData[t]) {
            realStockData[t] = { name: t + ' Corp.', price: +(50 + Math.random()*300).toFixed(2), change: +((Math.random()*6)-2.5).toFixed(2), pe: +(10+Math.random()*50).toFixed(1), mktCap: (Math.random()*200+10).toFixed(0)+'B', div: '0.00%', divAmt:'0.00', wkHigh: 0, wkLow: 0 };
            tickers.push(t);
        }
    });

    let stocks = [];
    let cash = 100000;
    let portfolio = {};
    let leverage = 1;
    let selectedStock = null;
    let watchlist = [];
    let priceAlerts = [];
    let pendingOrders = [];
    let transactions = [];
    let costBasis = {};
    let achievements = [];
    let alertEvents = [];
    let tradeStreak = { count: 0, lastDay: '' };
    let dailyQuest = { date: '', profitableTrades: 0, totalTrades: 0 };
    let tutorialState = { active: false, step: 0 };
    let allocationChart = null;
    let marketLoopStarted = false;

    // Initialize Market
    function initMarket() {
        stocks = tickers.map(symbol => {
            const d = realStockData[symbol];
            const wkHigh = d.wkHigh || +(d.price * (1.2 + Math.random()*0.3)).toFixed(2);
            const wkLow  = d.wkLow  || +(d.price * (0.65 + Math.random()*0.2)).toFixed(2);
            return {
                symbol,
                name: d.name,
                price: d.price,
                change: d.change,
                pe: d.pe,
                mktCap: d.mktCap,
                div: d.div,
                divAmt: d.divAmt,
                wkHigh,
                wkLow,
                sector: inferSector(symbol, d.name)
            };
        });
        renderGrid();
        updateUI();
        renderNews();
        if (!marketLoopStarted) {
            marketLoopStarted = true;
            setInterval(simulateMarketTick, 30000);
            setInterval(recordPerfSnapshot, 300000); // snapshot every 5 min
        }
        // Start live data if API key is already stored
        updateMarketStatus();
        updateDataSourceUI();
        if (RT.key) startLiveData();
        // Initial performance snapshot + chart draw
        recordPerfSnapshot();
        setTimeout(drawPerfChart, 200);
    }

    // --- Rendering ---
    function renderGrid() {
        const query = document.getElementById('search').value.toUpperCase();
        const grid  = document.getElementById('grid');

        let displayList = query
            ? stocks.filter(s => s.symbol.includes(query) || s.name.toUpperCase().includes(query)).slice(0, 50)
            : stocks.slice(0, 50);

        // Build a map of existing cards by symbol so we can update in-place
        const existingCards = {};
        grid.querySelectorAll('[data-symbol]').forEach(el => {
            existingCards[el.dataset.symbol] = el;
        });

        const symbolsInDisplay = new Set(displayList.map(s => s.symbol));

        // Remove cards no longer in the list
        Object.keys(existingCards).forEach(sym => {
            if (!symbolsInDisplay.has(sym)) existingCards[sym].remove();
        });

        displayList.forEach((stock, idx) => {
            const isPos = stock.change >= 0;
            const pillClass = isPos ? 'pill-up' : 'pill-down';
            const changeStr = (isPos ? '+' : '') + stock.change.toFixed(2) + '%';
            const priceStr  = '$' + stock.price.toFixed(2);
            const freshLabel = getCardFreshnessLabel(stock.symbol);

            if (existingCards[stock.symbol]) {
                // Card exists â€” update only changed text nodes (no full rebuild)
                const card = existingCards[stock.symbol];
                const pill  = card.querySelector('.change-pill');
                const price = card.querySelector('.stock-price');
                const sym   = card.querySelector('.stock-sym');
                const oldPrice = price ? parseFloat(price.textContent.replace('$','')) : null;
                if (pill)  { pill.className  = 'change-pill ' + pillClass; pill.textContent = changeStr; }
                if (price && price.textContent !== priceStr) {
                    price.textContent = priceStr;
                    // Flash card background green/red on price change
                    if (oldPrice !== null) {
                        card.classList.remove('flash-up','flash-down');
                        void card.offsetWidth; // force reflow to restart animation
                        card.classList.add(stock.price >= oldPrice ? 'flash-up' : 'flash-down');
                    }
                }
                if (sym)   sym.innerHTML = stock.symbol + freshLabel;
                // Ensure position in grid matches sorted order
                if (grid.children[idx] !== card) grid.insertBefore(card, grid.children[idx] || null);
            } else {
                // New card â€” create it
                const card = document.createElement('div');
                card.className    = 'g-card cursor-pointer';
                card.style.cssText = 'padding:16px;display:flex;flex-direction:column;justify-content:space-between;min-height:120px;';
                card.dataset.symbol = stock.symbol;
                card.onclick = () => openModal(stock);
                card.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:6px;">
                        <div style="min-width:0;">
                            <div class="stock-sym" style="font-weight:700;color:#e8e8f5;font-size:0.9rem;letter-spacing:0.02em;white-space:nowrap;">${stock.symbol}${freshLabel}</div>
                            <div style="font-size:0.7rem;color:#6868a0;margin-top:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${stock.name}</div>
                        </div>
                        <div class="change-pill ${pillClass}" style="flex-shrink:0;">${changeStr}</div>
                    </div>
                    <div style="margin-top:12px;">
                        <div class="stock-price" style="font-size:1.45rem;font-weight:300;color:#f0f0fa;font-family:var(--v-mono);line-height:1;">${priceStr}</div>
                        <div style="font-size:9px;color:#5858a0;margin-top:4px;text-transform:uppercase;letter-spacing:0.05em;">${stock.sector || ''}</div>
                    </div>`;
                grid.insertBefore(card, grid.children[idx] || null);
            }
        });
    }

    // sChart, volChart, detailStock, currentChartPeriod, activeIndicators declared in chart engine above
    let detailStock = null;

    function openModal(stock) { openStockDetail(stock); }

    function openStockDetail(stock) {
        detailStock = stock;
        // Fetch fresh quote on open, then just update the price fields in place (no recursive re-open)
        if (RT.key) {
            fetchQuote(stock.symbol).then(data => {
                if (data && detailStock && detailStock.symbol === stock.symbol) {
                    applyRealQuote(stock.symbol, data);
                    const s = getStockBySymbol(stock.symbol);
                    if (!s) return;
                    const isPos2 = s.change >= 0;
                    const changeAmt2 = s.price * Math.abs(s.change) / 100;
                    const color2 = isPos2 ? '#81c995' : '#f28b82';
                    document.getElementById('detailPrice').innerText = s.price.toFixed(2);
                    document.getElementById('detailChangeAmt').style.color = color2;
                    document.getElementById('detailChangeAmt').innerText = (isPos2?'+':'-') + changeAmt2.toFixed(2);
                    document.getElementById('detailChangePct').style.color = color2;
                    document.getElementById('detailChangePct').innerText = '(' + Math.abs(s.change).toFixed(2) + '%)';
                    document.getElementById('detailArrow').style.color = color2;
                    document.getElementById('detailArrow').innerText = isPos2 ? 'â†‘' : 'â†“';
                    if (s.dayHigh) document.getElementById('sHigh').innerText = '$' + s.dayHigh.toFixed(2);
                    if (s.dayLow)  document.getElementById('sLow').innerText  = '$' + s.dayLow.toFixed(2);
                    if (s.dayOpen) document.getElementById('sOpen').innerText = '$' + s.dayOpen.toFixed(2);
                }
            });
        }
        document.getElementById('stockDetailPage').classList.remove('hidden');
        document.body.style.overflow = 'hidden';
        const isPos = stock.change >= 0;
        const changeAmt = (stock.price * Math.abs(stock.change) / 100);
        const color = isPos ? '#81c995' : '#f28b82';
        document.getElementById('detailHeaderSymbol').innerText = stock.symbol;
        document.getElementById('detailName').innerText = stock.name;
        document.getElementById('detailPrice').innerText = stock.price.toFixed(2);
        document.getElementById('detailChangeAmt').style.color = color;
        document.getElementById('detailChangeAmt').innerText = (isPos?'+':'-') + changeAmt.toFixed(2);
        document.getElementById('detailChangePct').style.color = color;
        document.getElementById('detailChangePct').innerText = '(' + Math.abs(stock.change).toFixed(2) + '%)';
        document.getElementById('detailArrow').style.color = color;
        document.getElementById('detailArrow').innerText = isPos ? 'â†‘' : 'â†“';
        document.getElementById('detailPremarket').innerText = 'Pre-market ' + (stock.price*0.997).toFixed(2) + ' -' + (stock.price*0.003).toFixed(2) + ' (0.35%)';
        document.getElementById('prevCloseVal').innerText = (stock.price - changeAmt*(isPos?1:-1)).toFixed(2);
        document.getElementById('sOpen').innerText = '$' + (stock.dayOpen || (stock.price * (1 + (Math.random()*0.005 - 0.002)))).toFixed(2);
        document.getElementById('sHigh').innerText = '$' + (stock.dayHigh || (stock.price * 1.008)).toFixed(2);
        document.getElementById('sLow').innerText  = '$' + (stock.dayLow  || (stock.price * 0.992)).toFixed(2);
        document.getElementById('sMktCap').innerText = stock.mktCap || 'â€”';
        document.getElementById('sPE').innerText = stock.pe > 0 ? stock.pe.toFixed(2) : 'N/A';
        document.getElementById('s52H').innerText = '$' + (stock.wkHigh || (stock.price * 1.3)).toFixed(2);
        document.getElementById('s52L').innerText = '$' + (stock.wkLow || (stock.price * 0.7)).toFixed(2);
        document.getElementById('sDividend').innerText = stock.div || '0.00%';
        document.getElementById('sDivAmt').innerText = stock.divAmt > 0 ? '$' + stock.divAmt : 'â€”';
        document.getElementById('tradeSymLabel').innerText = stock.symbol;
        document.getElementById('dBuyPow').innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
        document.getElementById('dShares').innerText = portfolio[stock.symbol] || 0;
        document.getElementById('alertSymbol').value = stock.symbol;
        updateFollowButton();
        renderDetailNews(stock.symbol);
        renderPendingOrders();
        onTutorialEvent('open_stock');

        // Dim trade buttons if no API key
        const buyBtn  = document.querySelector('[onclick="execDetailTrade(\'BUY\')"]');
        const sellBtn = document.querySelector('[onclick="execDetailTrade(\'SELL\')"]');
        if (buyBtn && sellBtn) {
            if (!RT.key) {
                buyBtn.style.opacity  = '0.45';
                sellBtn.style.opacity = '0.45';
                buyBtn.title  = 'Connect Live Data API to trade';
                sellBtn.title = 'Connect Live Data API to trade';
            } else {
                buyBtn.style.opacity  = '1';
                sellBtn.style.opacity = '1';
                buyBtn.title  = '';
                sellBtn.title = '';
            }
        }
        document.querySelectorAll('.ctab').forEach(b => { b.className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-transparent text-gray-400 hover:text-gray-200'; });
        document.querySelector('.ctab').className = 'ctab text-sm font-medium px-4 py-3 border-b-2 border-[#8ab4f8] text-[#8ab4f8]';
        drawChart(stock, '1D');
        // New feature panels
        renderAnalystRatings(stock);
        renderEarnings(stock);
        renderSimilarStocks(stock);
        renderStockJournalNote(stock.symbol);
    }

    function closeStockDetail() {
        document.getElementById('stockDetailPage').classList.add('hidden');
        document.body.style.overflow = '';
        detailStock = null;
        destroyCharts();
        activeIndicators.clear();
        document.querySelectorAll('.ind-btn').forEach(b=>{b.style.background='transparent';b.style.color='#8888a8';b.style.borderColor='rgba(255,255,255,0.1)';});
        ['rsiChartWrap','macdChartWrap'].forEach(id=>{const el=document.getElementById(id);if(el)el.style.display='none';});
    }

    function closeModal() { closeStockDetail(); }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   CHART ENGINE â€” Chart.js Financial (proper candlestick)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    const candleCache = {};
    let   sChart       = null;   // candlestick
    let   volChart     = null;   // volume
    let   _chartFetchId = 0;     // debounce guard
    let   currentChartPeriod = '1D';

    // â”€â”€ Period â†’ Finnhub config + Chart.js time unit â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const PERIOD_CFG = {
        '1D':  { res:'5',  unit:'minute',  from: () => Math.floor(Date.now()/1000) - 86400,     maxPts:200 },
        '5D':  { res:'15', unit:'minute',  from: () => Math.floor(Date.now()/1000) - 5*86400,   maxPts:200 },
        '1M':  { res:'60', unit:'hour',    from: () => Math.floor(Date.now()/1000) - 30*86400,  maxPts:200 },
        '6M':  { res:'D',  unit:'day',     from: () => Math.floor(Date.now()/1000) - 180*86400, maxPts:180 },
        'YTD': { res:'D',  unit:'day',     from: () => Math.floor(new Date(new Date().getFullYear(),0,1)/1000), maxPts:240 },
        '1Y':  { res:'W',  unit:'week',    from: () => Math.floor(Date.now()/1000) - 365*86400, maxPts:52  },
        '5Y':  { res:'M',  unit:'month',   from: () => Math.floor(Date.now()/1000) - 5*365*86400, maxPts:60 },
        'Max': { res:'M',  unit:'month',   from: () => Math.floor(Date.now()/1000) - 10*365*86400, maxPts:120 },
    };

    function isDark() { return !document.body.classList.contains('light-mode'); }
    function themeColors() {
        return isDark()
            ? { bg:'#1c1c1e', grid:'rgba(255,255,255,0.06)', text:'#9aa0a6', tooltip:'#1e1e28' }
            : { bg:'#ffffff', grid:'rgba(0,0,0,0.07)',       text:'#555570', tooltip:'#f4f4f8' };
    }

    // â”€â”€ Simulate candles with volume â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function generateSimCandles(stock, period) {
        const cfg = PERIOD_CFG[period] || PERIOD_CFG['1M'];
        const numPts  = cfg.maxPts;
        const isNeg   = stock.change < 0;
        const volPct  = { '1D':0.004,'5D':0.007,'1M':0.015,'6M':0.03,'YTD':0.025,'1Y':0.04,'5Y':0.06,'Max':0.07 }[period] || 0.015;
        const trend   = isNeg ? -volPct*0.3 : volPct*0.15;
        const itvMs   = { '1D':5*60000,'5D':15*60000,'1M':3600000,'6M':86400000,'YTD':86400000,'1Y':7*86400000,'5Y':30*86400000,'Max':30*86400000 }[period] || 86400000;
        let closes=[stock.price];
        for(let i=1;i<numPts;i++) closes.push(closes[closes.length-1]/(1+trend+(Math.random()-0.5)*volPct*2));
        closes.reverse();
        return closes.map((cl,i)=>{
            const t=Date.now()-(numPts-1-i)*itvMs;
            const sw=cl*volPct*0.8, o=cl+(Math.random()-0.5)*sw;
            const h=Math.max(o,cl)+Math.random()*sw*0.4;
            const l=Math.min(o,cl)-Math.random()*sw*0.4;
            const vol=Math.round(stock.price*1e5*(0.8+Math.random()*0.8));
            return {x:t, o:+o.toFixed(2), h:+h.toFixed(2), l:+l.toFixed(2), c:+cl.toFixed(2), v:vol};
        });
    }

    // â”€â”€ Fetch real candles from Finnhub â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function fetchCandles(symbol, period) {
        const cacheKey = symbol+'_'+period;
        if (candleCache[cacheKey] && Date.now()-candleCache[cacheKey].ts < 60000) return candleCache[cacheKey].data;
        if (!RT.key) return null;
        try {
            const cfg = PERIOD_CFG[period] || PERIOD_CFG['1D'];
            const from = cfg.from(), to = Math.floor(Date.now()/1000);
            const url = `https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=${cfg.res}&from=${from}&to=${to}&token=${RT.key}`;
            const res  = await fetch(url);
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const data = await res.json();
            if (!data || data.s !== 'ok' || !data.t || data.t.length === 0) return null;
            // Trim to maxPts
            const total = data.t.length;
            const start = Math.max(0, total - cfg.maxPts);
            const candles = data.t.slice(start).map((ts,i) => ({
                x: ts*1000,
                o: data.o[start+i], h: data.h[start+i],
                l: data.l[start+i], c: data.c[start+i],
                v: data.v ? data.v[start+i] : Math.round(data.c[start+i]*1e5),
            }));
            candleCache[cacheKey] = { data:candles, ts:Date.now() };
            return candles;
        } catch(e) { return null; }
    }

    // â”€â”€ Show / hide loading overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function showChartOverlay(msg, icon='â³') {
        const ov = document.getElementById('chartOverlay');
        if (!ov) return;
        ov.style.display = 'flex';
        const ti = document.getElementById('chartOverlayIcon');
        const tt = document.getElementById('chartOverlayText');
        if (ti) ti.textContent = icon;
        if (tt) tt.textContent = msg;
    }
    function hideChartOverlay() {
        const ov = document.getElementById('chartOverlay');
        if (ov) ov.style.display = 'none';
    }

    // â”€â”€ Destroy both charts safely â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function destroyCharts() {
        if (sChart)   { try { sChart.destroy(); }   catch(e){} sChart   = null; }
        if (volChart) { try { volChart.destroy(); } catch(e){} volChart = null; }
    }

    // â”€â”€ Compute indicators â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function sma(arr, n) { return arr.map((_,i)=>i<n-1?null:arr.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n); }
    function ema(arr, n) {
        const k=2/(n+1); const out=[arr[0]];
        for(let i=1;i<arr.length;i++) out.push(arr[i]*k+out[i-1]*(1-k));
        return out.map((v,i)=>i<n-1?null:v);
    }
    function bollingerBands(closes, n=20, mult=2) {
        const mid=sma(closes,n);
        return closes.map((_,i)=>{
            if(i<n-1)return null;
            const sl=closes.slice(i-n+1,i+1);
            const mean=sl.reduce((a,b)=>a+b,0)/n;
            const sd=Math.sqrt(sl.reduce((s,v)=>s+(v-mean)**2,0)/n);
            return{mid:mid[i],upper:mid[i]+mult*sd,lower:mid[i]-mult*sd};
        });
    }
    function calcRSI(closes, n=14) {
        const gains=[], losses=[];
        for(let i=1;i<closes.length;i++){const d=closes[i]-closes[i-1];gains.push(Math.max(0,d));losses.push(Math.max(0,-d));}
        return gains.map((_,i)=>{
            if(i<n-1)return null;
            const ag=gains.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n;
            const al=losses.slice(i-n+1,i+1).reduce((a,b)=>a+b,0)/n;
            return al===0?100:100-100/(1+ag/al);
        });
    }
    function calcMACD(closes) {
        const ema12=ema(closes,12), ema26=ema(closes,26);
        const macdLine=closes.map((_,i)=>ema12[i]!=null&&ema26[i]!=null?ema12[i]-ema26[i]:null);
        const signal=sma(macdLine.filter(v=>v!=null),9);
        let si=0;
        const signalFull=macdLine.map(v=>v==null?null:signal[si++]||null);
        const hist=macdLine.map((v,i)=>v!=null&&signalFull[i]!=null?v-signalFull[i]:null);
        return{macdLine,signalLine:signalFull,histogram:hist};
    }
    function calcVWAP(candles) {
        let cumPV=0,cumV=0;
        return candles.map(c=>{cumPV+=((c.h+c.l+c.c)/3)*(c.v||1);cumV+=(c.v||1);return cumPV/cumV;});
    }

    // â”€â”€ MAIN: draw full chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    async function drawChart(stock, period) {
        currentChartPeriod = period;
        const fetchId = ++_chartFetchId;
        showChartOverlay('Loading chartâ€¦');

        let candles = await fetchCandles(stock.symbol, period);
        if (fetchId !== _chartFetchId) return; // stale fetch

        if (!candles || candles.length < 3) {
            candles = generateSimCandles(stock, period);
            if (!RT.key) showChartOverlay('Simulated data', 'ğŸ“Š');
            else         showChartOverlay('Live data unavailable', 'âš ï¸');
            setTimeout(hideChartOverlay, 1800);
        } else {
            hideChartOverlay();
        }

        destroyCharts();

        const tc   = themeColors();
        const cfg  = PERIOD_CFG[period] || PERIOD_CFG['1D'];
        const closes = candles.map(c=>c.c);
        const timestamps = candles.map(c=>c.x);

        // â”€â”€ Build overlay datasets from active indicators â”€â”€
        const overlayDatasets = [];
        const candleColors = candles.map(c => c.c >= c.o ? 'rgba(38,166,154,0.85)' : 'rgba(239,83,80,0.85)');

        if (activeIndicators.has('EMA20')) {
            const v=ema(closes,20);
            overlayDatasets.push({type:'line',label:'EMA20',data:timestamps.map((x,i)=>v[i]!=null?{x,y:v[i]}:null).filter(Boolean),borderColor:'#60a5fa',borderWidth:1.5,pointRadius:0,tension:0.4,order:1});
        }
        if (activeIndicators.has('EMA50')) {
            const v=ema(closes,50);
            overlayDatasets.push({type:'line',label:'EMA50',data:timestamps.map((x,i)=>v[i]!=null?{x,y:v[i]}:null).filter(Boolean),borderColor:'#f97316',borderWidth:1.5,pointRadius:0,tension:0.4,order:1});
        }
        if (activeIndicators.has('VWAP')) {
            const v=calcVWAP(candles);
            overlayDatasets.push({type:'line',label:'VWAP',data:timestamps.map((x,i)=>({x,y:v[i]})),borderColor:'#f59e0b',borderWidth:1.5,pointRadius:0,borderDash:[],tension:0.3,order:1});
        }
        if (activeIndicators.has('BB')) {
            const bb=bollingerBands(closes);
            const upper=bb.map((b,i)=>b?{x:timestamps[i],y:b.upper}:null).filter(Boolean);
            const lower=bb.map((b,i)=>b?{x:timestamps[i],y:b.lower}:null).filter(Boolean);
            const mid  =bb.map((b,i)=>b?{x:timestamps[i],y:b.mid}:null).filter(Boolean);
            overlayDatasets.push({type:'line',label:'BB Upper',data:upper,borderColor:'rgba(96,165,250,0.6)',borderWidth:1,pointRadius:0,borderDash:[3,2],order:1});
            overlayDatasets.push({type:'line',label:'BB Lower',data:lower,borderColor:'rgba(96,165,250,0.6)',borderWidth:1,pointRadius:0,borderDash:[3,2],order:1,fill:'-1',backgroundColor:'rgba(96,165,250,0.04)'});
            overlayDatasets.push({type:'line',label:'BB Mid',data:mid,borderColor:'rgba(96,165,250,0.35)',borderWidth:1,pointRadius:0,order:1});
        }

        // â”€â”€ Register financial plugin if not already â”€â”€
        if (typeof Chart !== 'undefined' && Chart.registry && !Chart.registry.controllers.get('candlestick')) {
            try { Chart.register(window['chartjs-chart-financial'] || {}); } catch(e){}
        }

        // â”€â”€ Candlestick chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const candleCanvas = document.getElementById('stockChart');
        if (!candleCanvas) return;
        candleCanvas.style.width = '100%';
        candleCanvas.style.height = '100%';

        const candleDataset = {
            label: stock.symbol,
            data: candles.map(c=>({x:c.x,o:c.o,h:c.h,l:c.l,c:c.c})),
            color: { up:'#26a69a', down:'#ef5350', unchanged:'#9aa0a6' },
        };

        // Check if financial plugin is available, else fallback to custom canvas
        const hasFinancial = typeof Chart !== 'undefined' && Chart.registry && !!Chart.registry.controllers.get?.('candlestick');

        if (hasFinancial) {
            sChart = new Chart(candleCanvas, {
                type: 'candlestick',
                data: { datasets: [candleDataset, ...overlayDatasets] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 200 },
                    interaction: { mode:'index', intersect:false },
                    plugins: {
                        legend: { display:false },
                        tooltip: {
                            backgroundColor: tc.tooltip,
                            titleColor: '#e0e0f5',
                            bodyColor: '#9aa0a6',
                            borderColor: 'rgba(255,255,255,0.1)',
                            borderWidth: 1,
                            padding: 10,
                            callbacks: {
                                title: ctx => {
                                    const d=new Date(ctx[0].parsed.x);
                                    const isIntraday = ['1D','5D','1M'].includes(period);
                                    return d.toLocaleString([],isIntraday?{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'}:{month:'short',day:'numeric',year:'numeric'});
                                },
                                label: ctx => {
                                    if (ctx.dataset.type==='line') return `${ctx.dataset.label}: $${ctx.parsed.y?.toFixed(2)||''}`;
                                    const {o,h,l,c} = ctx.raw;
                                    if (o==null) return '';
                                    const pct = ((c-o)/o*100).toFixed(2);
                                    return [`O: $${o.toFixed(2)}  H: $${h.toFixed(2)}`,`L: $${l.toFixed(2)}  C: $${c.toFixed(2)}`,`Change: ${pct>=0?'+':''}${pct}%`];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type:'time',
                            time: { unit:cfg.unit, tooltipFormat:'PPpp' },
                            grid: { color:tc.grid, drawBorder:false },
                            ticks: { color:tc.text, maxTicksLimit:8, maxRotation:0 }
                        },
                        y: {
                            position:'right',
                            grid: { color:tc.grid, drawBorder:false },
                            ticks: { color:tc.text, callback:v=>'$'+v.toLocaleString() }
                        }
                    }
                }
            });
        } else {
            // â”€â”€ Pure canvas fallback (no external plugin needed) â”€â”€
            drawCandlesFallback(candleCanvas, candles, tc, overlayDatasets, period);
        }

        // â”€â”€ Volume chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const volCanvas = document.getElementById('volumeChart');
        if (volCanvas) {
            volCanvas.style.width='100%'; volCanvas.style.height='100%';
            volChart = new Chart(volCanvas, {
                type: 'bar',
                data: { datasets:[{
                    label:'Volume',
                    data: candles.map(c=>({x:c.x, y:c.v||0})),
                    backgroundColor: candles.map(c=>c.c>=c.o?'rgba(38,166,154,0.5)':'rgba(239,83,80,0.5)'),
                    borderRadius: 1,
                    borderSkipped: 'bottom',
                }]},
                options: {
                    responsive:true, maintainAspectRatio:false, animation:{duration:0},
                    plugins:{ legend:{display:false}, tooltip:{enabled:false} },
                    scales:{
                        x:{ type:'time', time:{unit:cfg.unit}, grid:{display:false}, ticks:{display:false} },
                        y:{ position:'right', grid:{color:tc.grid,drawBorder:false}, ticks:{color:tc.text,maxTicksLimit:3,callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v} }
                    }
                }
            });
        }

        // â”€â”€ RSI sub-panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (activeIndicators.has('RSI')) drawRSIChart(candles, tc);

        // â”€â”€ MACD sub-panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        if (activeIndicators.has('MACD')) drawMACDChart(candles, tc);
    }

    // â”€â”€ Fallback pure-canvas candlestick (when plugin unavailable) â”€
    function drawCandlesFallback(canvas, candles, tc, overlayDatasets, period) {
        const dpr=window.devicePixelRatio||1;
        const W=canvas.clientWidth, H=canvas.clientHeight;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d');
        ctx.scale(dpr,dpr);
        const PAD={top:16,right:64,bottom:36,left:8};
        const cW=W-PAD.left-PAD.right, cH=H-PAD.top-PAD.bottom;
        const allH=candles.map(c=>c.h), allL=candles.map(c=>c.l);
        const minP=Math.min(...allL)*0.999, maxP=Math.max(...allH)*1.001, priceRange=maxP-minP;
        const toY=p=>PAD.top+cH*(1-(p-minP)/priceRange);
        const toX=i=>PAD.left+(i+0.5)*(cW/candles.length);
        const cw=Math.max(1,cW/candles.length*0.65);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        // Grid + y-labels
        ctx.strokeStyle=tc.grid; ctx.lineWidth=1;
        for(let i=0;i<=5;i++){
            const p=minP+priceRange*(i/5), y=toY(p);
            ctx.beginPath(); ctx.moveTo(PAD.left,y); ctx.lineTo(W-PAD.right,y); ctx.stroke();
            ctx.fillStyle=tc.text; ctx.font='10px sans-serif'; ctx.textAlign='right';
            ctx.fillText('$'+(p>100?p.toFixed(0):p.toFixed(2)), W-PAD.right+60, y+4);
        }
        // X labels
        ctx.textAlign='center';
        const lev=Math.max(1,Math.floor(candles.length/7));
        candles.forEach((c,i)=>{
            if(i%lev!==0)return;
            const d=new Date(c.x);
            const lbl=candles.length<=100?d.toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'}):d.toLocaleDateString([],{month:'short',day:'numeric'});
            ctx.fillStyle=tc.text; ctx.fillText(lbl,toX(i),H-PAD.bottom+14);
        });
        // Overlays
        function drawLine(pts,color,dash=[]) {
            ctx.save(); ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.setLineDash(dash);
            ctx.beginPath(); let s=false;
            pts.forEach(p=>{ if(!p)return; const y=toY(p.y),x=toX(candles.findIndex(c=>c.x===p.x)||0); s?(ctx.lineTo(x,y)):(ctx.moveTo(x,y),s=true); });
            ctx.stroke(); ctx.setLineDash([]); ctx.restore();
        }
        overlayDatasets.forEach(ds=>{
            if(ds.type==='line') drawLine(ds.data, ds.borderColor, ds.borderDash||[]);
        });
        // Candles
        candles.forEach((c,i)=>{
            const up=c.c>=c.o, col=up?'#26a69a':'#ef5350', x=toX(i);
            ctx.strokeStyle=col; ctx.lineWidth=Math.max(0.8,cw*0.12);
            ctx.beginPath(); ctx.moveTo(x,toY(c.h)); ctx.lineTo(x,toY(c.l)); ctx.stroke();
            ctx.fillStyle=col;
            const bT=Math.min(toY(c.o),toY(c.c)), bH=Math.max(1,Math.abs(toY(c.c)-toY(c.o)));
            ctx.fillRect(x-cw/2,bT,cw,bH);
        });
        // Save meta for hover
        canvas._candles=candles;
        canvas._meta={PAD,cW,cH,toX,toY,minP,maxP,priceRange,cw,W,H,dpr,tc};
        setupCandleHover(canvas);
    }

    function setupCandleHover(canvas) {
        canvas.onmousemove=function(e){
            if(!canvas._candles)return;
            const rect=canvas.getBoundingClientRect();
            const mx=e.clientX-rect.left;
            const {PAD,cW,W,H,toX,tc}=canvas._meta;
            const candles=canvas._candles;
            const idx=Math.round((mx-PAD.left)/(cW/candles.length)-0.5);
            if(idx<0||idx>=candles.length){drawCandlesFallback(canvas,candles,tc,[],currentChartPeriod);return;}
            drawCandlesFallback(canvas,candles,tc,[],currentChartPeriod);
            const c=candles[idx], x=toX(idx);
            const ctx=canvas.getContext('2d');
            // Crosshair
            ctx.strokeStyle='rgba(255,255,255,0.18)'; ctx.lineWidth=1; ctx.setLineDash([4,4]);
            ctx.beginPath(); ctx.moveTo(x,PAD.top); ctx.lineTo(x,H-PAD.bottom); ctx.stroke();
            ctx.setLineDash([]);
            // Tooltip
            const d=new Date(c.x);
            const ds=d.toLocaleString([],{month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});
            const pct=((c.c-c.o)/c.o*100).toFixed(2);
            const lines=[ds,`O:$${c.o.toFixed(2)} H:$${c.h.toFixed(2)}`,`L:$${c.l.toFixed(2)} C:$${c.c.toFixed(2)}`,`${pct>=0?'+':''}${pct}%`];
            const bW=190,bH=68,bX=Math.min(x+10,W-bW-PAD.right-4),bY=PAD.top+8;
            ctx.fillStyle=tc.tooltip; ctx.strokeStyle=c.c>=c.o?'#26a69a':'#ef5350'; ctx.lineWidth=1;
            ctx.beginPath(); ctx.roundRect(bX,bY,bW,bH,6); ctx.fill(); ctx.stroke();
            ctx.fillStyle=isDark()?'#ebebf5':'#1a1a2e'; ctx.font='10px sans-serif'; ctx.textAlign='left';
            lines.forEach((l,i)=>ctx.fillText(l,bX+10,bY+15+i*14));
        };
        canvas.onmouseleave=function(){
            if(canvas._candles)drawCandlesFallback(canvas,canvas._candles,themeColors(),[],currentChartPeriod);
        };
    }

    // â”€â”€ RSI sub-chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawRSIChart(candles, tc) {
        const canvas=document.getElementById('rsiChart');
        if(!canvas)return;
        const closes=candles.map(c=>c.c);
        const rsi=calcRSI(closes);
        const W=canvas.clientWidth||400, H=canvas.clientHeight||80;
        const dpr=window.devicePixelRatio||1;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        const PAD={l:4,r:46,t:4,b:14};
        const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
        const valid=rsi.map((v,i)=>v!=null?i:null).filter(x=>x!=null);
        if(!valid.length)return;
        const toX=i=>PAD.l+(i/candles.length)*cW;
        const toY=v=>PAD.t+(1-v/100)*cH;
        // OB/OS fills
        ctx.fillStyle='rgba(239,68,68,0.06)'; ctx.fillRect(PAD.l,PAD.t,cW,cH*(1-70/100));
        ctx.fillStyle='rgba(34,197,94,0.06)'; ctx.fillRect(PAD.l,toY(30),cW,cH*(30/100));
        [30,50,70].forEach(v=>{
            ctx.strokeStyle=tc.grid; ctx.lineWidth=0.5; ctx.setLineDash([2,3]);
            ctx.beginPath(); ctx.moveTo(PAD.l,toY(v)); ctx.lineTo(W-PAD.r,toY(v)); ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle=tc.text; ctx.font='8px sans-serif'; ctx.textAlign='right';
            ctx.fillText(v,W-PAD.r+42,toY(v)+3);
        });
        ctx.strokeStyle='#f59e0b'; ctx.lineWidth=1.5; ctx.beginPath();
        valid.forEach((i,n)=>{ const y=toY(rsi[i]); n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y); });
        ctx.stroke();
        // Current RSI value
        const last=rsi[valid[valid.length-1]];
        ctx.fillStyle=last>70?'#f87171':last<30?'#4ade80':'#f59e0b'; ctx.font='8px sans-serif'; ctx.textAlign='right';
        ctx.fillText(last.toFixed(1),W-PAD.r+42,toY(last)+3);
    }

    // â”€â”€ MACD sub-chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function drawMACDChart(candles, tc) {
        const canvas=document.getElementById('macdChart');
        if(!canvas)return;
        const closes=candles.map(c=>c.c);
        const {macdLine,signalLine,histogram}=calcMACD(closes);
        const timestamps=candles.map(c=>c.x);
        const valid=macdLine.map((v,i)=>v!=null?i:null).filter(x=>x!=null);
        if(!valid.length)return;
        const allVals=[...macdLine,...signalLine,...histogram].filter(v=>v!=null);
        const minV=Math.min(...allVals), maxV=Math.max(...allVals), rng=maxV-minV||1;
        const W=canvas.clientWidth||400, H=canvas.clientHeight||80;
        const dpr=window.devicePixelRatio||1;
        canvas.width=W*dpr; canvas.height=H*dpr;
        const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
        ctx.fillStyle=tc.bg; ctx.fillRect(0,0,W,H);
        const PAD={l:4,r:46,t:4,b:4};
        const cW=W-PAD.l-PAD.r, cH=H-PAD.t-PAD.b;
        const toX=i=>PAD.l+(i/candles.length)*cW;
        const toY=v=>PAD.t+(1-(v-minV)/rng)*cH;
        const zero=toY(0);
        // Zero line
        ctx.strokeStyle=tc.grid; ctx.lineWidth=0.5;
        ctx.beginPath(); ctx.moveTo(PAD.l,zero); ctx.lineTo(W-PAD.r,zero); ctx.stroke();
        // Histogram bars
        const bw=Math.max(1,cW/candles.length*0.7);
        valid.forEach(i=>{
            if(histogram[i]==null)return;
            const x=toX(i), y=toY(histogram[i]);
            ctx.fillStyle=histogram[i]>=0?'rgba(38,166,154,0.6)':'rgba(239,83,80,0.6)';
            ctx.fillRect(x-bw/2,Math.min(y,zero),bw,Math.abs(y-zero));
        });
        // MACD line
        ctx.strokeStyle='#60a5fa'; ctx.lineWidth=1.5; ctx.beginPath();
        valid.forEach((i,n)=>{ const y=toY(macdLine[i]); n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y); }); ctx.stroke();
        // Signal line
        ctx.strokeStyle='#f97316'; ctx.lineWidth=1; ctx.beginPath();
        valid.forEach((i,n)=>{ if(signalLine[i]==null)return; const y=toY(signalLine[i]); n===0?ctx.moveTo(toX(i),y):ctx.lineTo(toX(i),y); }); ctx.stroke();
        ctx.fillStyle=tc.text; ctx.font='8px sans-serif'; ctx.textAlign='left'; ctx.fillText('MACD',PAD.l+2,PAD.t+10);
    }

    // â”€â”€ setChartPeriod + indicator toggle (override previous) â”€â”€â”€â”€â”€â”€
    let _periodDebounce = null;
    async function setChartPeriod(period, btn) {
        document.querySelectorAll('.ctab').forEach(b=>{
            b.style.color='#6868a0'; b.style.borderBottomColor='transparent'; b.style.fontWeight='600';
        });
        btn.style.color='#8ab4f8'; btn.style.borderBottomColor='#8ab4f8'; btn.style.fontWeight='700';
        currentChartPeriod=period;
        clearTimeout(_periodDebounce);
        _periodDebounce=setTimeout(()=>{ if(detailStock) drawChart(detailStock,period); },80);
    }

    let activeIndicators = new Set();

    function toggleIndicator(name) {
        const btn=document.getElementById('ind-'+name);
        if(activeIndicators.has(name)){
            activeIndicators.delete(name);
            if(btn){btn.style.background='transparent';btn.style.color='#8888a8';btn.style.borderColor='rgba(255,255,255,0.1)';}
            // Hide sub-panels
            if(name==='RSI'){const w=document.getElementById('rsiChartWrap');if(w)w.style.display='none';}
            if(name==='MACD'){const w=document.getElementById('macdChartWrap');if(w)w.style.display='none';}
        } else {
            activeIndicators.add(name);
            if(btn){btn.style.background='rgba(212,168,75,0.15)';btn.style.color='var(--v-gold)';btn.style.borderColor='var(--v-gold)';}
            if(name==='RSI'){const w=document.getElementById('rsiChartWrap');if(w)w.style.display='block';}
            if(name==='MACD'){const w=document.getElementById('macdChartWrap');if(w)w.style.display='block';}
        }
        if(detailStock) drawChart(detailStock,currentChartPeriod);
    }

    // Keep old patched versions from working (they reference old vars â€” nullify gracefully)
    function drawChartWithIndicators(){}
    function drawRSI(){}

    function execDetailTrade(type) {
        if (!detailStock) return;

        // Gate: require API key before trading
        if (!RT.key) {
            showNoApiToast();
            return;
        }

        const sym      = detailStock.symbol;
        const price    = detailStock.price;
        const orderType = document.getElementById('orderType').value;
        const qty      = Math.max(1, parseInt(document.getElementById('orderQty').value || '1', 10));
        const trigger  = parseFloat(document.getElementById('orderTrigger').value || '0');

        if (orderType === 'market') {
            const ok = executeOrderNow({ side: type, symbol: sym, qty, type: 'market' }, price, false);
            if (ok) {
                document.getElementById('dShares').innerText = portfolio[sym] || 0;
                document.getElementById('dBuyPow').innerText = '$' + (cash * leverage).toLocaleString(undefined, { maximumFractionDigits: 0 });
                showTradeToast(type, qty, sym, price);
                recordPerfSnapshot();
                // Open journal after a short delay so toast is visible first
                setTimeout(() => openJournal({ side: type, symbol: sym, qty, price, ts: Date.now() }), 800);
            }
            return;
        }
        if (!Number.isFinite(trigger) || trigger <= 0) {
            alert('Enter a valid trigger price for non-market orders.');
            return;
        }
        if ((orderType === 'stop-loss' || orderType === 'take-profit') && type !== 'SELL') {
            alert(orderType + ' orders are available for SELL only.');
            return;
        }
        pendingOrders.unshift({
            id: 'ord_' + Date.now() + '_' + Math.random().toString(36).slice(2, 7),
            symbol: sym, side: type, qty, type: orderType, trigger,
            createdAt: Date.now(), status: 'OPEN'
        });
        renderPendingOrders();
        updateUI();
        saveUserData(false);
        showTradeToast(type, qty, sym, trigger, true);
    }

    function showTradeToast(type, qty, sym, price, isPending) {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        const isBuy = type === 'BUY';
        const isInfo = type === 'INFO';
        const bg = isInfo ? '#2a2a3a' : isPending ? '#1a73e8' : (isBuy ? '#34c759' : '#ff453a');
        const label = isInfo ? '' : isPending ? 'â³ Order Placed' : (isBuy ? 'âœ… Bought' : 'âœ… Sold');
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:${bg};color:white;padding:12px 24px;border-radius:12px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 20px rgba(0,0,0,0.3);
            animation:toastIn 0.25s ease-out;border:1px solid rgba(255,255,255,0.1);`;
        toast.innerHTML = isInfo ? sym : `${label}: ${qty} Ã— ${sym} @ $${price.toFixed(2)}`;
        document.body.appendChild(toast);
        setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.4s'; setTimeout(() => toast.remove(), 400); }, 2500);
    }

    function executeTrade(type) { execDetailTrade(type); }

    function showNoApiToast() {
        const existing = document.getElementById('tradeToast');
        if (existing) existing.remove();
        const toast = document.createElement('div');
        toast.id = 'tradeToast';
        toast.style.cssText = `position:fixed;bottom:32px;left:50%;transform:translateX(-50%);
            background:#1c1c2e;color:white;padding:14px 28px;border-radius:14px;
            font-weight:600;font-size:14px;z-index:99999;box-shadow:0 4px 30px rgba(0,0,0,0.4);
            border:1px solid rgba(139,92,246,0.4);animation:toastIn 0.25s ease-out;
            display:flex;align-items:center;gap:12px;`;
        toast.innerHTML = `<span style="font-size:20px">ğŸ”‘</span>
            <div>
                <div>API key required to trade</div>
                <div style="font-size:11px;opacity:0.7;font-weight:400;margin-top:2px">Click <strong>âš¡ Live Data</strong> in the header to connect</div>
            </div>`;
        document.body.appendChild(toast);
        // Shake animation
        toast.animate([{transform:'translateX(-50%) translateX(-6px)'},{transform:'translateX(-50%) translateX(6px)'},{transform:'translateX(-50%) translateX(-4px)'},{transform:'translateX(-50%) translateX(0)'}], {duration:300});
        setTimeout(() => { toast.style.opacity='0'; toast.style.transition='opacity 0.4s'; setTimeout(()=>toast.remove(),400); }, 3000);
    }

    function triggerCrash() {
        stocks.forEach(s => { s.price = s.price * 0.8; s.change = s.change - 20; });
        renderGrid();
        updateUI();
        saveUserData(false);
        if(detailStock) { const u=stocks.find(s=>s.symbol===detailStock.symbol); if(u) openStockDetail(u); }
        alert("MARKET CRASH INITIATED: All assets down 20%");
    }

    function updateUI() {
        const list = document.getElementById('portfolioList');
        const symsInPortfolio = Object.keys(portfolio);
        let portfolioValue = 0;

        // Clear the empty-state message if we now have holdings
        if (symsInPortfolio.length > 0 && list.querySelector('.italic')) {
            list.innerHTML = '';
        }

        // Remove rows for sold positions
        list.querySelectorAll('[data-port-sym]').forEach(el => {
            if (!portfolio[el.dataset.portSym]) el.remove();
        });

        // Add/update rows
        symsInPortfolio.forEach(symbol => {
            const qty   = portfolio[symbol];
            const stock = stocks.find(s => s.symbol === symbol);
            if (!stock) return;
            const val   = qty * stock.price;
            portfolioValue += val;
            const isPos = stock.change >= 0;
            const cost  = (costBasis[symbol] ? costBasis[symbol].totalCost / costBasis[symbol].shares : stock.price);
            const gainPct = ((stock.price - cost) / cost * 100).toFixed(2);

            let row = list.querySelector(`[data-port-sym="${symbol}"]`);
            if (row) {
                row.querySelector('.port-val').textContent = '$' + val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                row.querySelector('.port-chg').textContent = (isPos ? '+' : '') + stock.change.toFixed(2) + '% today';
                row.querySelector('.port-chg').style.color = isPos ? '#4ade80' : '#f87171';
                row.querySelector('.port-qty').textContent = qty + ' shares Â· ' + (gainPct >= 0 ? '+' : '') + gainPct + '% avg';
            } else {
                row = document.createElement('div');
                row.className       = 'py-3 flex justify-between items-center cursor-pointer rounded'; row.style.cssText = 'border-bottom:1px solid rgba(255,255,255,0.06);';
                row.dataset.portSym = symbol;
                row.innerHTML = `
                    <div>
                        <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${symbol}</div>
                        <div class="port-qty" style="font-size:11px;color:#8888a8;margin-top:2px;">${qty} shares Â· ${gainPct >= 0 ? '+' : ''}${gainPct}% avg</div>
                    </div>
                    <div style="text-align:right;">
                        <div class="port-val" style="font-weight:600;color:#f0f0fa;font-size:0.875rem;font-family:var(--v-mono);">$${val.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                        <div class="port-chg" style="font-size:11px;color:${isPos ? '#4ade80' : '#f87171'};">${isPos ? '+' : ''}${stock.change.toFixed(2)}% today</div>
                    </div>`;
                row.onclick = () => openStockDetail(stock);
                list.appendChild(row);
            }
        });

        if (symsInPortfolio.length === 0) {
            list.innerHTML = '<div style="font-size:13px;color:#8888a8;padding:16px 0;text-align:center;font-style:italic;">Your portfolio is empty.</div>';
        }

        // Total equity + P&L
        const totalEquity = cash + portfolioValue;
        const nwEl = document.getElementById('netWorth');
        if (nwEl) nwEl.innerText = totalEquity.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        const pl    = totalEquity - 100000;
        const plPct = ((pl / 100000) * 100).toFixed(2);
        const plEl  = document.getElementById('plDisplay');
        if (plEl) {
            plEl.innerText = (pl >= 0 ? '+$' : '-$') + Math.abs(pl).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) + ' (' + (pl >= 0 ? '+' : '') + plPct + '%)';
            plEl.style.color = pl >= 0 ? '#4ade80' : '#f87171';
        }

        // Cash / buying power
        const bpEl = document.getElementById('buyingPower');
        if (bpEl) bpEl.innerText = (cash * leverage).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        renderWatchlist();
        renderAlerts();
        renderHistory();
        renderAnalytics();
        renderQuestsAndAchievements();
        drawPerfChart();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  AUTH + PERSISTENT STORAGE SYSTEM
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let currentUser = null;  // { username, displayName }
    let authMode = 'login';  // 'login' | 'register'

    // Storage adapter: use platform storage if available, otherwise fallback to localStorage.
    window.__storageFallback = false;
    function buildStorageFallback() {
        // Prefix shared keys so they're distinguishable in localStorage
        const lsKey = (key, shared) => shared ? 'shared:' + key : 'priv:' + key;
        return {
            async get(key, shared = false) {
                try {
                    const val = localStorage.getItem(lsKey(key, shared));
                    return val == null ? null : { key, value: val, shared };
                } catch (_) { return null; }
            },
            async set(key, value, shared = false) {
                try {
                    localStorage.setItem(lsKey(key, shared), value);
                    return { key, value, shared };
                } catch (e) {
                    throw new Error('Storage unavailable: ' + (e.message || e));
                }
            },
            async delete(key, shared = false) {
                try {
                    localStorage.removeItem(lsKey(key, shared));
                    return { key, deleted: true, shared };
                } catch (_) { return null; }
            },
            async list(prefix = '', shared = false) {
                const keys = [];
                const lsPrefix = lsKey(prefix, shared);
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const k = localStorage.key(i);
                        if (k && k.startsWith(lsPrefix)) {
                            // Strip the ls prefix to return the original key
                            keys.push(k.slice(shared ? 'shared:'.length : 'priv:'.length));
                        }
                    }
                } catch (_) {}
                return { keys, prefix, shared };
            }
        };
    }

    function ensureStorageAdapter() {
        const valid = window.storage
            && typeof window.storage.get === 'function'
            && typeof window.storage.set === 'function'
            && typeof window.storage.list === 'function';
        if (!valid) {
            window.__storageFallback = true;
            window.storage = buildStorageFallback();
        }
        return window.storage;
    }

    ensureStorageAdapter();

    function toggleAuthMode() {
        authMode = authMode === 'login' ? 'register' : 'login';
        const isReg = authMode === 'register';
        document.getElementById('authTitle').innerText = isReg ? 'Create account' : 'Sign in';
        document.getElementById('authSubtitle').innerText = isReg ? 'Start with $100,000 USD' : 'to your trading account';
        document.getElementById('authSubmitBtn').innerText = isReg ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').innerText = isReg ? 'Already have an account?' : "Don't have an account?";
        document.getElementById('authToggleBtn').innerText = isReg ? 'Sign in' : 'Create account';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isReg);
        document.getElementById('authError').classList.add('hidden');
    }

    function showAuthError(msg) {
        const el = document.getElementById('authError');
        el.innerText = msg;
        el.classList.remove('hidden');
    }

    async function handleAuthSubmit() {
        const username = document.getElementById('authUser').value.trim().toLowerCase();
        const password = document.getElementById('authPass').value;
        const displayName = document.getElementById('authName').value.trim();
        const storage = ensureStorageAdapter();
        if (!username || !password) return showAuthError('Please fill in all fields.');
        if (!/^[a-z0-9_]+$/.test(username)) return showAuthError('Username can use letters, numbers, and underscores only.');

        try {
            if (authMode === 'register') {
                if (!displayName) return showAuthError('Please enter a display name.');
                if (username.length < 3) return showAuthError('Username must be at least 3 characters.');
                if (password.length < 4) return showAuthError('Password must be at least 4 characters.');
                // Check if username taken
                let existing = null;
                try { existing = await storage.get('user:' + username, true); } catch(e) {}
                if (existing) return showAuthError('Username already taken. Try another.');
                // Create account with $100k
                const userData = { username, displayName, passwordHash: simpleHash(password), cash: 100000, portfolio: {}, joinedAt: Date.now(), totalTrades: 0 };
                await storage.set('user:' + username, JSON.stringify(userData), true);
                await loginAs(userData);
            } else {
                let stored = null;
                try { stored = await storage.get('user:' + username, true); } catch(e) {}
                if (!stored) return showAuthError('Account not found. Please register.');
                const userData = JSON.parse(stored.value);
                if (userData.passwordHash !== simpleHash(password)) return showAuthError('Incorrect password.');
                await loginAs(userData);
            }
        } catch(e) {
            showAuthError('Storage error: ' + e.message);
        }
    }

    async function loginAs(userData) {
        currentUser = userData || {};
        const safeName = (currentUser.displayName && String(currentUser.displayName).trim())
            ? String(currentUser.displayName).trim()
            : ((currentUser.username && String(currentUser.username).trim()) || 'Trader');
        currentUser.displayName = safeName;
        cash = Number.isFinite(currentUser.cash) ? currentUser.cash : 100000;
        portfolio = (currentUser.portfolio && typeof currentUser.portfolio === 'object') ? currentUser.portfolio : {};
        watchlist = Array.isArray(currentUser.watchlist) ? currentUser.watchlist : [];
        priceAlerts = Array.isArray(currentUser.priceAlerts) ? currentUser.priceAlerts : [];
        pendingOrders = Array.isArray(currentUser.pendingOrders) ? currentUser.pendingOrders : [];
        transactions = Array.isArray(currentUser.transactions) ? currentUser.transactions : [];
        costBasis = (currentUser.costBasis && typeof currentUser.costBasis === 'object') ? currentUser.costBasis : {};
        achievements = Array.isArray(currentUser.achievements) ? currentUser.achievements : [];
        tradeStreak = (currentUser.tradeStreak && typeof currentUser.tradeStreak === 'object') ? currentUser.tradeStreak : { count: 0, lastDay: '' };
        dailyQuest = (currentUser.dailyQuest && typeof currentUser.dailyQuest === 'object') ? currentUser.dailyQuest : { date: '', profitableTrades: 0, totalTrades: 0 };
        perfHistory = Array.isArray(currentUser.perfHistory) ? currentUser.perfHistory : [];
        tradeJournal = (currentUser.tradeJournal && typeof currentUser.tradeJournal === 'object') ? currentUser.tradeJournal : {};
        ensureDailyQuest();
        requestNotificationPermission();
        updateSyncBadge();
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('userAvatar').innerText = safeName[0].toUpperCase();
        document.getElementById('userDisplayName').innerText = safeName;
        // Save immediately so user appears on leaderboard right away
        await saveUserData(false);
        // Show the app and hide the homepage
        showApp();
        initMarket();
        if (!currentUser.tutorialDone) startTutorial(false);
    }

    function logOut() {
        if (!confirm('Sign out? Your progress is saved.')) return;
        currentUser = null;
        cash = 100000;
        portfolio = {};
        document.getElementById('authOverlay').style.display = 'none';
        document.getElementById('authUser').value = '';
        document.getElementById('authPass').value = '';
        document.getElementById('authName').value = '';
        document.getElementById('authError').classList.add('hidden');
        authMode = 'login';
        document.getElementById('authTitle').innerText = 'Sign in';
        document.getElementById('authSubtitle').innerText = 'to your trading account';
        // Return to homepage
        showHomepage();
    }

    function simpleHash(str) {
        let h = 0;
        for (let i = 0; i < str.length; i++) { h = (Math.imul(31, h) + str.charCodeAt(i)) | 0; }
        return h.toString(36);
    }

    async function saveUserData(countTrade = false) {
        if (!currentUser || !currentUser.username) return false;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = stocks.find(x => x.symbol === sym);
            return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const totalShares = Object.values(portfolio).reduce((a, b) => a + b, 0);
        const season = getSeasonKey();
        currentUser.cash = cash;
        currentUser.portfolio = portfolio;
        currentUser.watchlist = watchlist;
        currentUser.priceAlerts = priceAlerts;
        currentUser.pendingOrders = pendingOrders;
        currentUser.transactions = transactions.slice(0, 200);
        currentUser.costBasis = costBasis;
        currentUser.achievements = achievements;
        currentUser.tradeStreak = tradeStreak;
        currentUser.dailyQuest = dailyQuest;
        currentUser.totalValue = cash + portfolioValue;
        currentUser.profit = (cash + portfolioValue) - 100000;
        currentUser.totalShares = totalShares;
        currentUser.realizedPL = Number(currentUser.realizedPL || 0);
        if (countTrade) currentUser.totalTrades = (currentUser.totalTrades || 0) + 1;
        currentUser.lastActive = Date.now();
        currentUser.seasonStats = currentUser.seasonStats || {};
        currentUser.seasonStats[season] = {
            totalValue: currentUser.totalValue,
            profit: currentUser.profit,
            totalShares: currentUser.totalShares,
            totalTrades: currentUser.totalTrades || 0
        };
        currentUser.perfHistory = perfHistory;
        currentUser.tradeJournal = tradeJournal;
        try {
            const storage = ensureStorageAdapter();
            await storage.set('user:' + currentUser.username, JSON.stringify(currentUser), true);
            return true;
        } catch (e) {
            console.error('Failed to save user data:', e);
            return false;
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  LEADERBOARD
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let leaderSort = 'total';

    function openLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.remove('hidden');
        loadLeaderboard();
    }

    function closeLeaderboard() {
        document.getElementById('leaderboardOverlay').classList.add('hidden');
    }

    function setLeaderSort(type) {
        leaderSort = type;
        document.querySelectorAll('.lbsort-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
            b.style.borderBottom = '2px solid transparent';
        });
        const active = document.getElementById('sort-' + type);
        if (active) {
            active.style.background = 'rgba(212,168,75,0.15)';
            active.style.color = 'var(--v-gold)';
            active.style.borderBottom = '2px solid var(--v-gold)';
        }
        loadLeaderboard();
    }

    async function loadLeaderboard() {
        const list = document.getElementById('leaderboardList');
        list.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;">Loading traders...</div>';
        try {
            const storage = ensureStorageAdapter();
            const keys = await storage.list('user:', true);
            if (!keys || !keys.keys || keys.keys.length === 0) {
                list.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;">No traders yet â€” be the first!</div>';
                return;
            }
            const users = [];
            for (const key of keys.keys) {
                try {
                    const r = await storage.get(key, true);
                    if (r) {
                        const u = JSON.parse(r.value);
                        if (u.displayName) users.push(u);
                    }
                } catch(e) {}
            }
            const season = getSeasonKey();
            users.forEach(u => {
                const ss = (u.seasonStats && u.seasonStats[season]) || {};
                u._seasonTotal = ss.totalValue || u.totalValue || 100000;
                u._seasonProfit = ss.profit || u.profit || 0;
                u._seasonShares = ss.totalShares || u.totalShares || 0;
            });
            if (leaderSort === 'total') users.sort((a, b) => b._seasonTotal - a._seasonTotal);
            else if (leaderSort === 'profit') users.sort((a, b) => b._seasonProfit - a._seasonProfit);
            else if (leaderSort === 'stocks') users.sort((a, b) => b._seasonShares - a._seasonShares);

            const medals = ['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
            const isMe = u => currentUser && u.username === currentUser.username;

            list.innerHTML = '<div style="font-size:11px;color:#606080;margin-bottom:12px;text-transform:uppercase;letter-spacing:0.06em;">Season: ' + season + ' Â· weekly reset</div>'
            + users.map((u, i) => {
                const totalVal = u._seasonTotal || 100000;
                const profit = u._seasonProfit || 0;
                const shares = u._seasonShares || 0;
                const profitColor = profit >= 0 ? '#4ade80' : '#f87171';
                const profitSign = profit >= 0 ? '+' : '';
                const borderStyle = isMe(u)
                    ? 'background:rgba(212,168,75,0.08);border:1px solid rgba(212,168,75,0.25);'
                    : 'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);';
                const avatarBg = isMe(u) ? 'var(--v-gold)' : '#2a2a3a';
                const avatarColor = isMe(u) ? '#0a0a0f' : '#c0c0d8';
                const medal = medals[i] || '<span style="font-size:12px;color:#606080;font-weight:700;">#' + (i+1) + '</span>';
                return `<div style="border-radius:12px;padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:12px;${borderStyle}">
                    <div style="font-size:1.4rem;width:28px;text-align:center;flex-shrink:0;">${medal}</div>
                    <div style="width:38px;height:38px;border-radius:50%;background:${avatarBg};display:flex;align-items:center;justify-content:center;color:${avatarColor};font-weight:700;font-size:14px;flex-shrink:0;">
                        ${u.displayName[0].toUpperCase()}
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                            ${u.displayName} ${isMe(u) ? '<span style="font-size:10px;color:var(--v-gold);font-weight:600;">(you)</span>' : ''}
                        </div>
                        <div style="font-size:11px;color:#8888a8;margin-top:1px;">@${u.username}</div>
                    </div>
                    <div style="text-align:right;flex-shrink:0;">
                        <div style="font-weight:700;color:#f0f0fa;font-size:0.9rem;font-family:var(--v-mono);">$${totalVal.toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        <div style="font-size:11px;color:${profitColor};font-family:var(--v-mono);">${profitSign}$${Math.abs(profit).toLocaleString(undefined,{maximumFractionDigits:0})}</div>
                        <div style="font-size:10px;color:#606080;">${shares} shares</div>
                    </div>
                </div>`;
            }).join('') || '<div style="text-align:center;color:#8888a8;padding:32px 0;">No traders yet.</div>';
        } catch(e) {
            list.innerHTML = '<div style="text-align:center;color:#f87171;padding:32px 0;">Error loading leaderboard: ' + e.message + '</div>';
        }
    }


    function getSeasonKey(ts = Date.now()) {
        const d = new Date(ts);
        const utc = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        const dayNum = utc.getUTCDay() || 7;
        utc.setUTCDate(utc.getUTCDate() + 4 - dayNum);
        const yearStart = new Date(Date.UTC(utc.getUTCFullYear(), 0, 1));
        const weekNum = Math.ceil((((utc - yearStart) / 86400000) + 1) / 7);
        return utc.getUTCFullYear() + '-W' + String(weekNum).padStart(2, '0');
    }

    function dayKey(ts = Date.now()) {
        const d = new Date(ts);
        const m = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return d.getFullYear() + '-' + m + '-' + day;
    }

    function ensureDailyQuest() {
        const today = dayKey();
        if (dailyQuest.date !== today) {
            dailyQuest = { date: today, profitableTrades: 0, totalTrades: 0 };
        }
    }

    function inferSector(symbol, name) {
        const n = (name || '').toLowerCase();
        if (n.includes('bank') || n.includes('financial') || n.includes('capital')) return 'Financials';
        if (n.includes('pharma') || n.includes('health') || n.includes('med')) return 'Healthcare';
        if (n.includes('energy') || n.includes('oil') || n.includes('gas')) return 'Energy';
        if (n.includes('retail') || n.includes('consumer') || n.includes('walmart') || n.includes('costco')) return 'Consumer';
        if (n.includes('software') || n.includes('tech') || n.includes('semiconductor') || n.includes('cloud') || ['AAPL','MSFT','NVDA','GOOGL','META','AMD','INTC'].includes(symbol)) return 'Technology';
        if (n.includes('industrial') || n.includes('air') || n.includes('aerospace') || n.includes('transport')) return 'Industrials';
        return 'Other';
    }

    function fmtMoney(v) {
        return '$' + Number(v || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    }

    function getStockBySymbol(sym) { return stocks.find(s => s.symbol === sym); }

    function avgCost(sym) {
        const cb = costBasis[sym];
        if (!cb || !cb.shares) return 0;
        return cb.totalCost / cb.shares;
    }

    function updateSyncBadge() {
        const el = document.getElementById('syncBadge');
        if (!el) return;
        el.innerText = window.__storageFallback ? 'Sync: Local' : 'Sync: Cloud';
        el.className = window.__storageFallback
            ? 'text-xs px-2 py-1 rounded bg-gray-100 text-gray-600 font-semibold'
            : 'text-xs px-2 py-1 rounded bg-green-100 text-green-700 font-semibold';
    }

    function addCurrentToWatchlist() {
        if (!detailStock) return;
        if (!watchlist.includes(detailStock.symbol)) watchlist.unshift(detailStock.symbol);
        watchlist = watchlist.slice(0, 40);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function toggleFollowCurrent() {
        if (!detailStock) return;
        const sym = detailStock.symbol;
        if (watchlist.includes(sym)) watchlist = watchlist.filter(s => s !== sym);
        else watchlist.unshift(sym);
        renderWatchlist();
        updateFollowButton();
        saveUserData(false);
    }

    function updateFollowButton() {
        const btn = document.getElementById('followBtn');
        if (!btn || !detailStock) return;
        const followed = watchlist.includes(detailStock.symbol);
        btn.innerText = followed ? 'Following' : '+ Follow';
        btn.className = followed
            ? 'ml-auto flex items-center gap-2 border border-[#8ab4f8] text-[#8ab4f8] px-4 py-1.5 rounded-full text-sm font-medium'
            : 'ml-auto flex items-center gap-2 border border-gray-500 text-gray-300 hover:border-gray-200 px-4 py-1.5 rounded-full text-sm font-medium';
    }

    function renderWatchlist() {
        const el = document.getElementById('watchlistItems');
        if (!el) return;
        if (!watchlist.length) { el.innerHTML = '<div class="text-xs text-gray-500">No watchlist symbols yet.</div>'; return; }
        el.innerHTML = watchlist.slice(0, 10).map(sym => {
            const st = getStockBySymbol(sym);
            const p = st ? st.price.toFixed(2) : 'â€”';
            return `<div class="flex items-center justify-between border border-gray-100 rounded px-2 py-1">
                <button class="font-semibold text-gray-700" onclick="openSymbolFromWatchlist('${sym}')">${sym}</button>
                <div class="text-gray-500">$${p}</div>
                <button class="text-red-500" onclick="removeWatchSymbol('${sym}')">Ã—</button>
            </div>`;
        }).join('');
    }

    function openSymbolFromWatchlist(sym) {
        const st = getStockBySymbol(sym);
        if (st) openStockDetail(st);
    }

    function removeWatchSymbol(sym) {
        watchlist = watchlist.filter(s => s !== sym);
        renderWatchlist();
        saveUserData(false);
    }

    function createPriceAlert() {
        const symbol = (document.getElementById('alertSymbol').value || '').trim().toUpperCase();
        const type = document.getElementById('alertType').value;
        const value = parseFloat(document.getElementById('alertValue').value || '0');
        if (!symbol || !getStockBySymbol(symbol)) return alert('Enter a valid symbol for alert.');
        if (!Number.isFinite(value) || value <= 0) return alert('Enter a valid alert value.');
        priceAlerts.unshift({ id: 'al_' + Date.now(), symbol, type, value, triggered: false, createdAt: Date.now() });
        priceAlerts = priceAlerts.slice(0, 60);
        renderAlerts();
        saveUserData(false);
    }

    function renderAlerts() {
        const el = document.getElementById('alertsList');
        if (!el) return;
        el.innerHTML = priceAlerts.slice(0, 8).map(a => {
            const status = a.triggered ? '<span class="text-green-600">triggered</span>' : '<span class="text-gray-500">active</span>';
            return `<div class="flex justify-between gap-2">
                <span>${a.symbol} ${a.type} ${a.value}</span>
                <span>${status} <button class="text-red-500" onclick="removeAlert('${a.id}')">Ã—</button></span>
            </div>`;
        }).join('') || '<div class="text-gray-500">No alerts yet.</div>';

        const feed = document.getElementById('alertFeed');
        if (feed) feed.innerHTML = alertEvents.slice(0, 4).map(x => '<div style="color:#4ade80;background:rgba(34,197,94,0.1);border:1px solid rgba(34,197,94,0.2);border-radius:6px;padding:4px 8px;">' + x + '</div>').join('');
    }

    function removeAlert(id) {
        priceAlerts = priceAlerts.filter(a => a.id !== id);
        renderAlerts();
        saveUserData(false);
    }

    function renderPendingOrders() {
        const el = document.getElementById('pendingOrdersList');
        if (!el) return;
        const open = pendingOrders.filter(o => o.status === 'OPEN').slice(0, 6);
        el.innerHTML = open.map(o => '<div class="flex justify-between"><span>' + o.side + ' ' + o.qty + ' ' + o.symbol + ' (' + o.type + ')</span><span>@ ' + o.trigger.toFixed(2) + '</span></div>').join('') || '<div class="text-gray-400">No pending orders</div>';
    }

    function shouldFillOrder(order, stock) {
        if (!stock) return false;
        if (order.type === 'limit') {
            if (order.side === 'BUY') return stock.price <= order.trigger;
            return stock.price >= order.trigger;
        }
        if (order.type === 'stop-loss') return order.side === 'SELL' && stock.price <= order.trigger;
        if (order.type === 'take-profit') return order.side === 'SELL' && stock.price >= order.trigger;
        return false;
    }

    function executeOrderNow(order, fillPrice, fromPending) {
        const sym = order.symbol;
        const qty = order.qty;
        const price = fillPrice;
        const held = portfolio[sym] || 0;
        let realized = 0;

        if (order.side === 'BUY') {
            const cost = price * qty;
            if (cash * leverage < cost) { if (!fromPending) alert('Insufficient Buying Power!'); return false; }
            cash -= cost;
            portfolio[sym] = held + qty;
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.shares += qty;
            cb.totalCost += cost;
            costBasis[sym] = cb;
        } else {
            if (held < qty) { if (!fromPending) alert('Not enough shares to sell.'); return false; }
            const avg = avgCost(sym);
            realized = (price - avg) * qty;
            cash += price * qty;
            portfolio[sym] = held - qty;
            if (portfolio[sym] <= 0) delete portfolio[sym];
            const cb = costBasis[sym] || { shares: 0, totalCost: 0 };
            cb.totalCost = Math.max(0, cb.totalCost - avg * qty);
            cb.shares = Math.max(0, cb.shares - qty);
            if (cb.shares === 0) delete costBasis[sym]; else costBasis[sym] = cb;
            currentUser.realizedPL = Number(currentUser.realizedPL || 0) + realized;
        }

        transactions.unshift({
            id: 'tx_' + Date.now() + '_' + Math.random().toString(36).slice(2,6),
            symbol: sym,
            side: order.side,
            qty,
            price,
            orderType: order.type,
            realizedPL: realized,
            timestamp: Date.now()
        });
        transactions = transactions.slice(0, 300);
        ensureDailyQuest();
        dailyQuest.totalTrades += 1;
        if (realized > 0) dailyQuest.profitableTrades += 1;
        updateStreak();
        checkAchievements();
        if (fromPending) {
            order.status = 'FILLED';
            order.filledAt = Date.now();
            order.fillPrice = price;
        }
        updateUI();
        renderPendingOrders();
        saveUserData(true);
        onTutorialEvent(order.side === 'BUY' ? 'buy_trade' : 'sell_trade');
        return true;
    }

    function updateStreak() {
        const today = dayKey();
        if (!tradeStreak.lastDay) { tradeStreak = { count: 1, lastDay: today }; return; }
        if (tradeStreak.lastDay === today) return;
        const prev = new Date(tradeStreak.lastDay + 'T00:00:00');
        const now = new Date(today + 'T00:00:00');
        const diff = Math.round((now - prev) / 86400000);
        tradeStreak.count = diff === 1 ? (tradeStreak.count + 1) : 1;
        tradeStreak.lastDay = today;
    }

    function checkAchievements() {
        const names = new Set(achievements.map(a => a.name));
        const totalTrades = currentUser.totalTrades || 0;
        const realized = Number(currentUser.realizedPL || 0);
        const maybeAdd = (name) => { if (!names.has(name)) achievements.unshift({ name, at: Date.now() }); };
        if (totalTrades >= 10) maybeAdd('First 10 Trades');
        if (totalTrades >= 50) maybeAdd('Active Trader');
        if (realized >= 1000) maybeAdd('Profit Hunter');
        if (tradeStreak.count >= 3) maybeAdd('3-Day Streak');
        if (dailyQuest.profitableTrades >= 3) maybeAdd('Quest: 3 Profitable Trades');
        achievements = achievements.slice(0, 20);
    }

    function renderHistory() {
        const el = document.getElementById('historyList');
        if (!el) return;
        if (transactions.length === 0) {
            el.innerHTML = '<div style="color:#8888a8;text-align:center;padding:12px 0;font-style:italic;">No trades yet.</div>';
            return;
        }
        el.innerHTML = transactions.slice(0, 20).map(t => {
            const isBuy  = t.side === 'BUY';
            const badgeStyle = isBuy
                ? 'background:rgba(34,197,94,0.15);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.15);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const plHtml = t.side === 'SELL'
                ? `<span style="font-weight:600;margin-left:6px;font-size:10px;color:${t.realizedPL >= 0 ? '#4ade80' : '#f87171'}">${t.realizedPL >= 0 ? '+' : ''}${fmtMoney(t.realizedPL)}</span>`
                : '';
            const time = new Date(t.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            return `<div data-tx-id="${t.id}" style="display:flex;align-items:center;justify-content:space-between;padding:8px 10px;margin-bottom:4px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);">
                <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                    <span style="font-size:10px;font-weight:700;padding:2px 7px;border-radius:4px;${badgeStyle}">${t.side}</span>
                    <span style="font-size:12px;color:#c0c0d8;">${t.qty} Ã— <strong style="color:#e8e8f5;">${t.symbol}</strong></span>
                    ${plHtml}
                    ${(tradeJournal[t.symbol]||[]).length ? '<span title="Has journal note" style="font-size:10px;">ğŸ““</span>' : ''}
                </div>
                <div style="text-align:right;">
                    <div style="font-size:12px;font-weight:600;color:#e0e0f5;font-family:var(--v-mono);">$${t.price.toFixed(2)}</div>
                    <div style="font-size:10px;color:#606080;">${time}</div>
                </div>
            </div>`;
        }).join('');
    }

    function renderAnalytics() {
        const realized = Number(currentUser && currentUser.realizedPL || 0);
        let unrealized = 0;
        const alloc    = [];
        const sectors  = {};

        Object.keys(portfolio).forEach(sym => {
            const st = getStockBySymbol(sym);
            if (!st) return;
            const qty = portfolio[sym];
            const val = st.price * qty;
            alloc.push({ sym, val });
            const avg = avgCost(sym);
            unrealized += (st.price - avg) * qty;
            sectors[st.sector] = (sectors[st.sector] || 0) + val;
        });

        // Realized / Unrealized P&L
        const rEl = document.getElementById('realizedPL');
        const uEl = document.getElementById('unrealizedPL');
        if (rEl) {
            rEl.innerText  = (realized   >= 0 ? '+' : '') + fmtMoney(realized);
            rEl.style.color = realized   >= 0 ? '#4ade80' : '#f87171';
        }
        if (uEl) {
            uEl.innerText  = (unrealized >= 0 ? '+' : '') + fmtMoney(unrealized);
            uEl.style.color = unrealized >= 0 ? '#4ade80' : '#f87171';
        }

        // Sector exposure
        const secEl = document.getElementById('sectorExposure');
        if (secEl) {
            const total = Object.values(sectors).reduce((a,b)=>a+b,0) || 1;
            const sorted = Object.entries(sectors).sort((a,b)=>b[1]-a[1]).slice(0,5);
            if (sorted.length === 0) {
                secEl.innerHTML = '<div class="text-gray-400">No positions yet.</div>';
            } else {
                secEl.innerHTML = sorted.map(([k,v]) => {
                    const pct = ((v/total)*100).toFixed(1);
                    return `<div class="flex justify-between items-center">
                        <span class="text-gray-600">${k}</span>
                        <div class="flex items-center gap-2">
                            <div class="h-1.5 rounded-full bg-blue-400" style="width:${Math.round(pct)}px"></div>
                            <span class="font-semibold">${pct}%</span>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        // Pie chart â€” update data instead of destroying/recreating
        const canvas = document.getElementById('allocationChart');
        if (!canvas) return;
        const labels = alloc.slice(0,8).map(x => x.sym);
        const values = alloc.slice(0,8).map(x => x.val);
        const COLORS  = ['#1a73e8','#34a853','#fbbc05','#ea4335','#7baaf7','#81c995','#fdd663','#f28b82'];

        if (allocationChart && allocationChart.data) {
            // Update existing chart data without destroying it
            allocationChart.data.labels   = labels;
            allocationChart.data.datasets[0].data = values.length ? values : [1];
            allocationChart.data.datasets[0].backgroundColor = values.length ? COLORS : ['#e0e0e0'];
            allocationChart.update('none'); // 'none' = no animation, instant
        } else {
            if (allocationChart) allocationChart.destroy();
            allocationChart = new Chart(canvas, {
                type: 'pie',
                data: {
                    labels: labels.length ? labels : ['Empty'],
                    datasets: [{ data: values.length ? values : [1], backgroundColor: values.length ? COLORS : ['#e0e0e0'] }]
                },
                options: {
                    plugins: { legend: { display: false }, tooltip: {
                        callbacks: { label: ctx => `${ctx.label}: $${ctx.parsed.toLocaleString(undefined,{maximumFractionDigits:0})}` }
                    }},
                    maintainAspectRatio: false,
                    animation: { duration: 300 }
                }
            });
        }
    }

    function renderQuestsAndAchievements() {
        ensureDailyQuest();

        // Daily quests with progress bars
        const quest = document.getElementById('questList');
        if (quest) {
            const pTrades   = Math.min(dailyQuest.profitableTrades, 3);
            const tTrades   = Math.min(dailyQuest.totalTrades, 5);
            const pPct      = (pTrades / 3 * 100).toFixed(0);
            const tPct      = (tTrades / 5 * 100).toFixed(0);
            const pDone     = pTrades >= 3;
            const tDone     = tTrades >= 5;
            quest.innerHTML = `
                <div class="mb-2">
                    <div class="flex justify-between text-xs mb-1">
                        <span>${pDone ? 'âœ…' : 'ğŸ¯'} Profitable trades</span>
                        <span class="font-bold ${pDone ? 'text-green-600' : ''}">${pTrades}/3</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${pPct}%;background:${pDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between text-xs mb-1">
                        <span>${tDone ? 'âœ…' : 'ğŸ“Š'} Total trades today</span>
                        <span class="font-bold ${tDone ? 'text-green-600' : ''}">${tTrades}/5</span>
                    </div>
                    <div class="h-1.5 bg-gray-100 rounded-full overflow-hidden">
                        <div class="h-full rounded-full transition-all duration-500" style="width:${tPct}%;background:${tDone?'#34a853':'#1a73e8'}"></div>
                    </div>
                </div>`;
        }

        // Streak
        const streak = document.getElementById('tradeStreak');
        if (streak) streak.innerText = (tradeStreak.count || 0) + ' day' + (tradeStreak.count !== 1 ? 's' : '');

        // Achievements
        const ach = document.getElementById('achievementList');
        if (ach) {
            ach.innerHTML = achievements.slice(0,8).map(a =>
                `<span class="text-xs bg-yellow-50 border border-yellow-200 text-yellow-800 px-2 py-1 rounded">ğŸ… ${a.name}</span>`
            ).join('') || '<span class="text-xs text-gray-400">Complete trades to earn badges.</span>';
        }
    }

    function renderNews() {
        const feed = document.getElementById('newsFeed');
        if (!feed) return;
        const movers = stocks.slice().sort((a,b)=>Math.abs(b.change)-Math.abs(a.change)).slice(0,4);
        feed.innerHTML = movers.map((s, i) => {
            const pos = s.change >= 0;
            const sentiment = pos ? 'Bullish' : 'Bearish';
            const tagStyle = pos
                ? 'background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.25);'
                : 'background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.25);';
            const source = ['Reuters','Bloomberg','CNBC','WSJ'][i % 4];
            const headline = pos ? (s.symbol + ' climbs as momentum buyers step in') : (s.symbol + ' slips as sellers pressure the tape');
            return '<div style="padding:14px;border:1px solid rgba(255,255,255,0.08);border-radius:10px;background:#1a1a24;">'
                + '<div style="font-size:11px;color:#8888a8;margin-bottom:6px;"><span style="font-weight:700;color:#b0b0c8;">' + source + '</span> Â· ' + (15 + i * 10) + ' min ago</div>'
                + '<div style="font-size:0.875rem;font-weight:500;color:#e0e0f5;line-height:1.4;margin-bottom:8px;">' + headline + '</div>'
                + '<div style="display:inline-block;font-size:10px;font-weight:700;padding:2px 8px;border-radius:4px;' + tagStyle + '">' + sentiment + '</div>'
                + '</div>';
        }).join('');
    }

    function renderDetailNews(symbol) {
        const el = document.getElementById('detailNews');
        if (!el || !symbol) return;
        const st = getStockBySymbol(symbol);
        const pos = st && st.change >= 0;
        const t1 = pos ? 'Analysts raise short-term outlook for ' + symbol : 'Analysts cut near-term targets for ' + symbol;
        const t2 = pos ? symbol + ' options flow shows bullish positioning' : symbol + ' sees defensive hedging activity';
        el.innerHTML = '<div class="text-xs text-gray-300">Ticker News</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t1 + '</div>'
            + '<div class="text-xs text-gray-300 border border-gray-700 rounded p-2">' + t2 + '</div>';
    }

    function processPendingOrders() {
        let changed = false;
        pendingOrders.forEach(o => {
            if (o.status !== 'OPEN') return;
            const st = getStockBySymbol(o.symbol);
            if (shouldFillOrder(o, st)) {
                const ok = executeOrderNow(o, st.price, true);
                if (ok) changed = true;
            }
        });
        if (changed) saveUserData(false);
    }

    // processAlerts is defined later with notification support

    function simulateMarketTick() {
        stocks.forEach(s => {
            // Skip simulation for stocks that have fresh live data (< 30 sec old)
            const cached = RT.cache[s.symbol];
            if (cached && RT.key && (Date.now() - cached.ts) < 30000) return;

            const drift = (Math.random() - 0.5) * 0.018;
            s.price = Math.max(1, s.price * (1 + drift));
            s.change = Math.max(-30, Math.min(30, s.change + drift * 100));
        });
        renderGrid();
        updateUI();
        processPendingOrders();
        processAlerts();
        renderNews();
        // If detail page is open, update just the price fields â€” never re-open it
        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
    }

    // Update price/change fields on the detail page without touching anything else
    function updateDetailPriceFields(s) {
        const isPos = s.change >= 0;
        const changeAmt = s.price * Math.abs(s.change) / 100;
        const color = isPos ? '#81c995' : '#f28b82';
        const priceEl = document.getElementById('detailPrice');
        if (priceEl) priceEl.innerText = s.price.toFixed(2);
        const caEl = document.getElementById('detailChangeAmt');
        if (caEl) { caEl.style.color = color; caEl.innerText = (isPos?'+':'-') + changeAmt.toFixed(2); }
        const cpEl = document.getElementById('detailChangePct');
        if (cpEl) { cpEl.style.color = color; cpEl.innerText = '(' + Math.abs(s.change).toFixed(2) + '%)'; }
        const arEl = document.getElementById('detailArrow');
        if (arEl) { arEl.style.color = color; arEl.innerText = isPos ? 'â†‘' : 'â†“'; }
        const bpEl = document.getElementById('dBuyPow');
        if (bpEl) bpEl.innerText = '$' + (cash*leverage).toLocaleString(undefined,{maximumFractionDigits:0});
    }

    function exportPortfolioData() {
        if (!currentUser) return;
        const payload = {
            username: currentUser.username,
            displayName: currentUser.displayName,
            cash,
            portfolio,
            watchlist,
            priceAlerts,
            pendingOrders,
            transactions,
            costBasis,
            achievements,
            tradeStreak,
            dailyQuest,
            realizedPL: Number(currentUser.realizedPL || 0)
        };
        const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'portfolio-' + currentUser.username + '.json';
        a.click();
        URL.revokeObjectURL(a.href);
    }

    function importPortfolioData(event) {
        const file = event.target.files && event.target.files[0];
        if (!file || !currentUser) return;
        const reader = new FileReader();
        reader.onload = () => {
            try {
                const data = JSON.parse(reader.result);
                cash = Number(data.cash || 100000);
                portfolio = data.portfolio || {};
                watchlist = Array.isArray(data.watchlist) ? data.watchlist : [];
                priceAlerts = Array.isArray(data.priceAlerts) ? data.priceAlerts : [];
                pendingOrders = Array.isArray(data.pendingOrders) ? data.pendingOrders : [];
                transactions = Array.isArray(data.transactions) ? data.transactions : [];
                costBasis = data.costBasis || {};
                achievements = Array.isArray(data.achievements) ? data.achievements : [];
                tradeStreak = data.tradeStreak || { count: 0, lastDay: '' };
                dailyQuest = data.dailyQuest || { date: '', profitableTrades: 0, totalTrades: 0 };
                currentUser.realizedPL = Number(data.realizedPL || 0);
                updateUI();
                saveUserData(false);
                alert('Import complete.');
            } catch (e) {
                alert('Invalid import file.');
            }
        };
        reader.readAsText(file);
    }

    const tutorialSteps = [
        {
            icon: 'ğŸ‘‹',
            title: 'Welcome to Vestra',
            desc: 'Your risk-free trading simulator. Practice buying and selling real stocks with $100,000 in virtual cash â€” no real money, no real risk.',
            hint: null,
            event: null
        },
        {
            icon: 'ğŸ“Š',
            title: 'Browse the Market',
            desc: 'The main grid shows live stock prices updating in real-time. Search for any ticker or company name in the search bar above.',
            hint: 'ğŸ‘† Try clicking on any stock card to open its detail page',
            event: 'open_stock'
        },
        {
            icon: 'âš¡',
            title: 'Connect Live Data',
            desc: 'Click the "âš¡ Live Data" button in the header to connect your Finnhub API key. This enables real-time prices and candlestick charts. Without it, trading is disabled.',
            hint: 'You need a free API key from finnhub.io to trade',
            event: null
        },
        {
            icon: 'ğŸ’¸',
            title: 'Place Your First Buy',
            desc: 'Open any stock, set the quantity, make sure "Market" order is selected, then hit the green Buy button. Your shares and portfolio update instantly.',
            hint: 'ğŸŸ¢ Market orders fill immediately at the current price',
            event: 'buy_trade'
        },
        {
            icon: 'ğŸ“ˆ',
            title: 'Track Your Portfolio',
            desc: 'The right sidebar shows your total equity, unrealized P&L, sector exposure, and transaction history â€” all updating live as prices move.',
            hint: null,
            event: null
        },
        {
            icon: 'ğŸ†',
            title: 'Compete on the Leaderboard',
            desc: 'Every trade updates your rank. Click the Leaderboard button to see how you stack up against other traders globally.',
            hint: null,
            event: null
        },
        {
            icon: 'ğŸ¯',
            title: 'You\'re Ready to Trade',
            desc: 'Complete daily quests, unlock achievements, and grow your virtual portfolio. Remember â€” Vestra is trading with no risk.',
            hint: 'ğŸš€ Good luck, trader!',
            event: null
        }
    ];

    function renderTutorialStep() {
        const step = tutorialState.step;
        const s = tutorialSteps[step];
        const total = tutorialSteps.length;

        document.getElementById('tutorialIcon').textContent  = s.icon;
        document.getElementById('tutorialTitle').textContent = s.title;
        document.getElementById('tutorialDesc').textContent  = s.desc;

        const hintEl = document.getElementById('tutorialHint');
        if (s.hint) { hintEl.textContent = s.hint; hintEl.classList.remove('hidden'); }
        else { hintEl.classList.add('hidden'); }

        // Progress fill
        document.getElementById('tutorialProgressFill').style.width = ((step / (total - 1)) * 100) + '%';

        // Dots
        const dotsEl = document.getElementById('tutorialDots');
        dotsEl.innerHTML = tutorialSteps.map((_, i) =>
            `<div class="rounded-full transition-all duration-300" style="width:${i===step?'20px':'8px'};height:8px;background:${i===step?'#a78bfa':i<step?'rgba(167,139,250,0.5)':'rgba(255,255,255,0.15)'}"></div>`
        ).join('');

        // Back button
        const prevBtn = document.getElementById('tutorialPrevBtn');
        if (step > 0) prevBtn.classList.remove('hidden'); else prevBtn.classList.add('hidden');

        // Next button label
        const nextBtn = document.getElementById('tutorialNextBtn');
        nextBtn.textContent = step === total - 1 ? 'ğŸš€ Start Trading' : 'Continue â†’';
    }

    function startTutorial(forceOpen) {
        if (!forceOpen && currentUser && currentUser.tutorialDone) return;
        tutorialState.active = true;
        tutorialState.step   = 0;
        document.getElementById('tutorialOverlay').classList.remove('hidden');
        renderTutorialStep();
    }

    function tutorialNext() {
        const total = tutorialSteps.length;
        if (tutorialState.step >= total - 1) { skipTutorial(); return; }
        tutorialState.step++;
        renderTutorialStep();
    }

    function tutorialPrev() {
        if (tutorialState.step <= 0) return;
        tutorialState.step--;
        renderTutorialStep();
    }

    function skipTutorial() {
        tutorialState.active = false;
        document.getElementById('tutorialOverlay').classList.add('hidden');
        if (currentUser) { currentUser.tutorialDone = true; saveUserData(false); }
    }

    function nextTutorialStep() { tutorialNext(); } // legacy alias

    function onTutorialEvent(eventName) {
        if (!tutorialState.active) return;
        const step = tutorialSteps[tutorialState.step];
        if (step && step.event === eventName) {
            setTimeout(() => tutorialNext(), 600); // slight delay so user sees the action
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   REAL-TIME DATA ENGINE â€” Finnhub Integration
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // --- Config ---
    const RT = {
        key: localStorage.getItem('finnhub_api_key') || '',
        interval: 10000,
        timer: null,
        cache: {},
        queue: [],
        queueIdx: 0,
        liveCount: 0,
        batchSize: 10,
    };

    // Priority symbols: watchlist + portfolio + top 20, then rest
    function buildQueue() {
        const priority = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const rest = stocks.filter(s => !priority.has(s.symbol)).map(s => s.symbol);
        RT.queue = [...priority, ...rest];
        // Do NOT reset queueIdx here â€” we want to cycle through all stocks over time
    }

    // Fetch a single quote from Finnhub
    async function fetchQuote(symbol) {
        if (!RT.key) return null;
        try {
            const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${RT.key}`;
            const res = await fetch(url);
            if (!res.ok) return null;
            const data = await res.json();
            if (!data.c || data.c === 0) return null;
            return data;
        } catch (e) { return null; }
    }

    // Apply a real quote to our stock object
    function applyRealQuote(symbol, data) {
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const newPrice = data.c;
        if (!newPrice || newPrice <= 0) return;
        stock.price  = newPrice;
        stock.change = (data.dp != null) ? data.dp : stock.change;
        if (data.h)  stock.dayHigh   = data.h;
        if (data.l)  stock.dayLow    = data.l;
        if (data.o)  stock.dayOpen   = data.o;
        if (data.pc) stock.prevClose = data.pc;
        RT.cache[symbol] = { price: newPrice, change: stock.change, ts: Date.now() };
        RT.liveCount++;
    }

    // Batch-fetch: priority stocks every cycle, rest rotate
    async function fetchNextBatch() {
        if (!RT.key) return;

        const prioritySet = new Set([
            ...Object.keys(portfolio),
            ...watchlist,
            ...(detailStock ? [detailStock.symbol] : []),
            ...stocks.slice(0, 20).map(s => s.symbol)
        ]);
        const prioritySyms = [...prioritySet];
        const restSyms = stocks.filter(s => !prioritySet.has(s.symbol)).map(s => s.symbol);

        if (RT.queueIdx >= restSyms.length) RT.queueIdx = 0;
        const rotatingBatch = restSyms.slice(RT.queueIdx, RT.queueIdx + 10);
        RT.queueIdx += 10;

        const batch = [...new Set([...prioritySyms, ...rotatingBatch])];

        RT.liveCount = 0;
        await Promise.all(batch.map(async sym => {
            const data = await fetchQuote(sym);
            if (data) applyRealQuote(sym, data);
        }));

        renderGrid();
        updateUI();

        if (detailStock) {
            const s = getStockBySymbol(detailStock.symbol);
            if (s) updateDetailPriceFields(s);
        }
        updateDataSourceUI();
    }

    // Start/stop the live data loop
    function startLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        fetchNextBatch(); // immediate first fetch
        RT.timer = setInterval(fetchNextBatch, RT.interval);
        updateMarketStatus();
    }

    function stopLiveData() {
        if (RT.timer) clearInterval(RT.timer);
        RT.timer = null;
        RT.liveCount = 0;
        updateDataSourceUI();
    }

    // --- Market Hours (NYSE) ---
    function isMarketOpen() {
        const now = new Date();
        // Convert to Eastern Time
        const et = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = et.getDay(); // 0=Sun, 6=Sat
        if (day === 0 || day === 6) return false;
        const h = et.getHours(), m = et.getMinutes();
        const mins = h * 60 + m;
        return mins >= 9 * 60 + 30 && mins < 16 * 60;
    }

    function updateMarketStatus() {
        const dot  = document.getElementById('marketStatusDot');
        const text = document.getElementById('marketStatusText');
        if (!dot || !text) return;
        if (isMarketOpen()) {
            dot.className  = 'w-2 h-2 rounded-full dot-live';
            text.textContent = 'Market Open';
            text.className   = 'text-xs text-green-600 font-semibold';
        } else {
            dot.className  = 'w-2 h-2 rounded-full dot-closed';
            text.textContent = 'Market Closed';
            text.className   = 'text-xs text-gray-500 font-medium';
        }
    }

    function updateDataSourceUI() {
        const badge = document.getElementById('dataSourceBadge');
        const btn   = document.getElementById('liveDataBtn');
        if (!badge) return;
        if (RT.key && RT.liveCount > 0) {
            badge.textContent = 'âš¡ LIVE';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-live';
            if (btn) { btn.textContent = 'âš¡ Live: ON'; btn.style.cssText = 'font-size:11px;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.35);color:#4ade80;padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        } else if (RT.key) {
            badge.textContent = 'â†» Fetchingâ€¦';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-stale';
        } else {
            badge.textContent = 'SIM';
            badge.className = 'text-xs font-bold px-2 py-1 rounded badge-sim';
            if (btn) { btn.textContent = 'âš¡ Live Data'; btn.style.cssText = 'font-size:11px;background:rgba(212,168,75,0.12);border:1px solid rgba(212,168,75,0.3);color:var(--v-gold);padding:4px 10px;border-radius:6px;font-weight:700;cursor:pointer;'; }
        }
    }

    // Data freshness per card
    function getCardFreshnessLabel(symbol) {
        const cached = RT.cache[symbol];
        if (!cached || !RT.key) return '';
        const ageSec = Math.round((Date.now() - cached.ts) / 1000);
        return `<span class="text-[9px] font-semibold badge-live rounded px-1 ml-1">liveÂ·${ageSec}s</span>`;
    }

    // --- API Config Modal ---
    function openApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        // Only pre-fill if the user themselves previously saved a key
        const savedKey = localStorage.getItem('finnhub_api_key') || '';
        document.getElementById('finnhubKeyInput').value = savedKey;
        document.getElementById('updateIntervalInput').value = RT.interval || 10000;
        document.getElementById('apiConfigError').style.display = 'none';
        document.getElementById('apiTestResult').style.display = 'none';
        modal.classList.remove('hidden');
        modal.style.display = 'flex';
    }

    function closeApiConfig() {
        const modal = document.getElementById('apiConfigModal');
        modal.classList.add('hidden');
        modal.style.display = '';
    }

    async function saveApiConfig() {
        const key      = document.getElementById('finnhubKeyInput').value.trim();
        const interval = Number(document.getElementById('updateIntervalInput').value);
        const errEl    = document.getElementById('apiConfigError');
        const resultEl = document.getElementById('apiTestResult');

        errEl.classList.add('hidden');
        resultEl.classList.remove('hidden');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';

        if (!key) {
            errEl.textContent = 'âš ï¸ Please enter an API key.';
            errEl.classList.remove('hidden');
            resultEl.classList.add('hidden');
            return;
        }

        // Save immediately without network test (network is blocked in preview environments)
        RT.key      = key;
        RT.interval = interval;
        localStorage.setItem('finnhub_api_key', key);
        localStorage.setItem('finnhub_interval', interval);

        resultEl.style.cssText = 'margin-top:12px;font-size:13px;text-align:center;color:#4ade80;font-weight:600;display:block;';
        resultEl.textContent = 'âœ… Key saved! Live data will activate when opened locally.';

        // Try a live test â€” works when opened as a local file, silently skips if blocked
        try {
            const testUrl = `https://finnhub.io/api/v1/quote?symbol=AAPL&token=${key}`;
            const res = await fetch(testUrl);
            const data = await res.json();
            if (data.c && data.c > 0) {
                resultEl.textContent = `âœ… Connected! AAPL = $${data.c.toFixed(2)}`;
                startLiveData();
                setTimeout(closeApiConfig, 1800);
                return;
            }
        } catch(e) {
            // Network blocked (e.g. running in Claude preview) â€” key is still saved
        }

        startLiveData(); // will gracefully no-op if network blocked
        updateDataSourceUI();
        setTimeout(closeApiConfig, 2200);
    }

    function clearApiConfig() {
        RT.key = '';
        localStorage.removeItem('finnhub_api_key');
        localStorage.removeItem('finnhub_interval');
        stopLiveData();
        document.getElementById('finnhubKeyInput').value = '';
        document.getElementById('apiTestResult').classList.add('hidden');
        const resultEl = document.getElementById('apiTestResult');
        resultEl.className = 'mt-3 text-sm text-center text-gray-500';
        resultEl.textContent = 'Live data cleared. Using simulated mode.';
        resultEl.classList.remove('hidden');
        updateDataSourceUI();
        setTimeout(closeApiConfig, 1500);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: LIVE SEARCH DROPDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let searchTimeout = null;
    function handleSearch(val) {
        document.getElementById('searchClear').style.display = val ? 'block' : 'none';
        renderGrid(); // keep grid filtering
        clearTimeout(searchTimeout);
        if (!val.trim()) { hideSearchDropdown(); return; }
        searchTimeout = setTimeout(() => showSearchDropdown(val), 80);
    }
    function showSearchDropdown(val) {
        const q = (val || document.getElementById('search').value || '').toUpperCase().trim();
        const drop = document.getElementById('searchDropdown');
        if (!q) { drop.style.display = 'none'; return; }
        const matches = stocks.filter(s =>
            s.symbol.startsWith(q) || s.symbol.includes(q) || s.name.toUpperCase().includes(q)
        ).slice(0, 12);
        if (!matches.length) { drop.style.display = 'none'; return; }
        drop.innerHTML = matches.map(s => {
            const pos = s.change >= 0;
            const col = pos ? '#4ade80' : '#f87171';
            const sign = pos ? '+' : '';
            return `<div class="search-result-item" onclick="selectSearchResult('${s.symbol}')">
                <div>
                    <div style="font-weight:700;color:#e8e8f5;font-size:0.9rem;">${s.symbol}</div>
                    <div style="font-size:11px;color:#8888a8;margin-top:1px;">${s.name}</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-family:var(--v-mono);font-size:0.9rem;color:#f0f0fa;">$${s.price.toFixed(2)}</div>
                    <div style="font-size:11px;color:${col};font-family:var(--v-mono);">${sign}${s.change.toFixed(2)}%</div>
                </div>
            </div>`;
        }).join('');
        drop.style.display = 'block';
    }
    function hideSearchDropdown() {
        document.getElementById('searchDropdown').style.display = 'none';
    }
    function selectSearchResult(symbol) {
        const stock = getStockBySymbol(symbol);
        if (stock) { hideSearchDropdown(); openStockDetail(stock); }
    }
    function clearSearch() {
        document.getElementById('search').value = '';
        document.getElementById('searchClear').style.display = 'none';
        hideSearchDropdown();
        renderGrid();
    }
    document.addEventListener('click', e => {
        if (!document.getElementById('searchWrap')?.contains(e.target)) hideSearchDropdown();
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: DESKTOP PRICE ALERT NOTIFICATIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function requestNotificationPermission() {
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    }
    function fireAlertNotification(symbol, type, value, price) {
        const title = `ğŸ”” Vestra Alert: ${symbol}`;
        const body = `${symbol} is ${type} $${value} â€” now at $${price.toFixed(2)}`;
        if ('Notification' in window && Notification.permission === 'granted') {
            const n = new Notification(title, { body, icon: '' });
            setTimeout(() => n.close(), 6000);
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: MARKET OPEN/CLOSE COUNTDOWN
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateCountdown() {
        const el = document.getElementById('marketCountdown');
        if (!el) return;
        const now = new Date();
        const ny = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const day = ny.getDay();
        const h = ny.getHours(), m = ny.getMinutes(), s = ny.getSeconds();
        const totalSec = h * 3600 + m * 60 + s;
        const openSec = 9 * 3600 + 30 * 60;
        const closeSec = 16 * 3600;
        const isWeekday = day >= 1 && day <= 5;
        const marketOpen = isWeekday && totalSec >= openSec && totalSec < closeSec;

        let diff, label;
        if (!isWeekday || (!marketOpen && totalSec >= closeSec)) {
            // Weekend or after close â€” count to next Monday or tomorrow open
            let daysToOpen = day === 6 ? 2 : (day === 0 ? 1 : (day === 5 ? 3 : 1));
            diff = daysToOpen * 86400 - totalSec + openSec;
            label = 'Opens in';
        } else if (marketOpen) {
            diff = closeSec - totalSec;
            label = 'Closes in';
        } else {
            diff = openSec - totalSec;
            label = 'Opens in';
        }
        const hh = Math.floor(diff / 3600);
        const mm = Math.floor((diff % 3600) / 60);
        const ss = diff % 60;
        const pad = n => String(n).padStart(2, '0');
        el.textContent = `${label} ${hh > 0 ? hh + 'h ' : ''}${pad(mm)}m ${pad(ss)}s`;
        el.style.color = marketOpen ? '#4ade80' : 'var(--v-muted)';
    }
    setInterval(updateCountdown, 1000);
    updateCountdown();

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: DARK / LIGHT MODE TOGGLE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function toggleMoreMenu() {
        const m = document.getElementById('moreMenu');
        if (m) m.style.display = m.style.display === 'none' ? 'block' : 'none';
    }
    document.addEventListener('click', e => {
        const wrap = document.getElementById('moreMenuWrap');
        if (wrap && !wrap.contains(e.target)) {
            const m = document.getElementById('moreMenu');
            if (m) m.style.display = 'none';
        }
    }, true);

    function toggleTheme() {
        const isLight = document.body.classList.toggle('light-mode');
        document.getElementById('themeToggle').textContent = isLight ? 'ğŸŒ™' : 'â˜€ï¸';
        localStorage.setItem('vestra_theme', isLight ? 'light' : 'dark');
    }
    // Restore saved theme
    if (localStorage.getItem('vestra_theme') === 'light') {
        document.body.classList.add('light-mode');
        document.addEventListener('DOMContentLoaded', () => {
            const btn = document.getElementById('themeToggle');
            if (btn) btn.textContent = 'â˜€ï¸';
        });
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: PORTFOLIO PERFORMANCE CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let perfHistory = []; // [{ts, value}]
    let perfChart = null;
    let perfPeriod = '1D';

    function recordPerfSnapshot() {
        if (!currentUser) return;
        const val = cash + Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym);
            return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const now = Date.now();
        // Only add a snapshot every 5 minutes at most
        if (perfHistory.length && now - perfHistory[perfHistory.length - 1].ts < 300000) {
            perfHistory[perfHistory.length - 1].value = val; // update last
        } else {
            perfHistory.push({ ts: now, value: val });
        }
        // Keep max 365 days of data
        const cutoff = now - 365 * 86400000;
        perfHistory = perfHistory.filter(p => p.ts > cutoff);
        if (currentUser) currentUser.perfHistory = perfHistory;
        drawPerfChart();
    }

    function setPerfPeriod(p, btn) {
        perfPeriod = p;
        document.querySelectorAll('.perf-btn').forEach(b => {
            b.style.background = 'transparent';
            b.style.color = '#8888a8';
            b.style.borderColor = 'rgba(255,255,255,0.1)';
        });
        // If btn not passed, find it by text
        if (!btn) {
            document.querySelectorAll('.perf-btn').forEach(b => {
                if (b.textContent.trim() === p) btn = b;
            });
        }
        if (btn) {
            btn.style.background = 'rgba(212,168,75,0.15)';
            btn.style.color = 'var(--v-gold)';
            btn.style.borderColor = 'var(--v-gold)';
        }
        drawPerfChart();
    }

    function drawPerfChart() {
        const canvas = document.getElementById('perfChart');
        if (!canvas) return;
        const wrap = document.getElementById('perfChartWrap');
        if (!wrap) return;

        // Filter by period
        const now = Date.now();
        const cutoffs = { '1D': 86400000, '5D': 5*86400000, '1M': 30*86400000, '6M': 182*86400000, '1Y': 365*86400000 };
        const cutoff = now - (cutoffs[perfPeriod] || cutoffs['1D']);
        let data = perfHistory.filter(p => p.ts >= cutoff);

        // Seed simulated history if not enough real points
        if (data.length < 3) {
            const cutMs = cutoffs[perfPeriod] || 86400000;
            const pts = perfPeriod === '1D' ? 24 : perfPeriod === '5D' ? 30 : perfPeriod === '1M' ? 30 : perfPeriod === '6M' ? 26 : 52;
            const interval = cutMs / pts;
            const startVal = 100000;
            const endVal = cash + Object.keys(portfolio).reduce((s,sym) => { const st=getStockBySymbol(sym); return s+(st?st.price*portfolio[sym]:0); }, 0);
            // Merge with real data
            const seed2 = (currentUser?.username||'x').charCodeAt(0);
            let v = startVal;
            const generated = [];
            for (let i = 0; i <= pts; i++) {
                const t = now - cutMs + i * interval;
                // only add if no real point nearby
                const hasReal = perfHistory.some(p => Math.abs(p.ts - t) < interval * 0.8);
                if (!hasReal) {
                    const drift = (Math.sin(i * 0.7 + seed2) * 0.008) + ((endVal - startVal) / startVal / pts);
                    v = Math.max(50000, v * (1 + drift));
                    generated.push({ ts: t, value: v });
                }
            }
            // Force the last real point to match current equity
            generated.push({ ts: now, value: endVal });
            // Merge and sort
            data = [...perfHistory.filter(p => p.ts >= now - cutMs), ...generated]
                .sort((a, b) => a.ts - b.ts);
        }

        const W = wrap.clientWidth || 260;
        const H = 150;
        const dpr = window.devicePixelRatio || 1;
        canvas.width = W * dpr; canvas.height = H * dpr;
        canvas.style.width = W + 'px'; canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const vals = data.map(d => d.value);
        const minV = Math.min(...vals) * 0.998;
        const maxV = Math.max(...vals) * 1.002;
        const toX = i => (i / (data.length - 1)) * W;
        const toY = v => H - ((v - minV) / (maxV - minV || 1)) * (H - 20) - 10;

        const isPos = data[data.length - 1].value >= data[0].value;
        const lineColor = isPos ? '#4ade80' : '#f87171';
        const fillColor = isPos ? 'rgba(74,222,128,0.12)' : 'rgba(248,113,113,0.12)';

        // Baseline at 100k
        const baseY = toY(100000);
        ctx.beginPath();
        ctx.setLineDash([4, 4]);
        ctx.moveTo(0, baseY); ctx.lineTo(W, baseY);
        ctx.strokeStyle = 'rgba(255,255,255,0.15)'; ctx.lineWidth = 1; ctx.stroke();
        ctx.setLineDash([]);

        // Fill
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(data[0].value));
        data.forEach((d, i) => ctx.lineTo(toX(i), toY(d.value)));
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
        ctx.fillStyle = fillColor; ctx.fill();

        // Line
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(data[0].value));
        data.forEach((d, i) => ctx.lineTo(toX(i), toY(d.value)));
        ctx.strokeStyle = lineColor; ctx.lineWidth = 2; ctx.stroke();

        // Current value label
        const cur = data[data.length - 1].value;
        const pct = ((cur - 100000) / 100000 * 100).toFixed(2);
        ctx.font = `bold ${11 * dpr / dpr}px DM Sans, sans-serif`;
        ctx.fillStyle = lineColor;
        ctx.fillText(`${isPos ? '+' : ''}${pct}%`, 4, 14);

        if (perfChart) { try { perfChart.destroy(); } catch(e){} perfChart = null; }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: PAPER TRADING JOURNAL
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let journalPendingTx = null;
    let tradeJournal = {}; // { symbol: [{ ts, side, qty, price, note }] }

    function openJournal(tx) {
        journalPendingTx = tx;
        const modal = document.getElementById('journalModal');
        const info = document.getElementById('journalTradeInfo');
        const note = document.getElementById('journalNote');
        info.textContent = `${tx.side} ${tx.qty}Ã— ${tx.symbol} @ $${tx.price.toFixed(2)}`;
        // Pre-fill with previous note if any
        const prev = (tradeJournal[tx.symbol] || []).slice(-1)[0];
        note.value = prev ? prev.note : '';
        note.placeholder = tx.side === 'BUY'
            ? 'Why are you buying? What\'s your target price? Time horizon?'
            : 'Why selling? Taking profit or cutting loss?';
        modal.classList.add('open');
        setTimeout(() => note.focus(), 100);
    }

    function saveJournalNote() {
        if (!journalPendingTx) { closeJournal(); return; }
        const note = document.getElementById('journalNote').value.trim();
        const tx = journalPendingTx;
        if (!tradeJournal[tx.symbol]) tradeJournal[tx.symbol] = [];
        tradeJournal[tx.symbol].push({ ts: tx.ts || Date.now(), side: tx.side, qty: tx.qty, price: tx.price, note });
        if (currentUser) currentUser.tradeJournal = tradeJournal;
        closeJournal();
        renderHistory(); // refresh to show note indicator
        if (tx.symbol === detailStock?.symbol) renderStockJournalNote(tx.symbol);
    }

    function closeJournal() {
        document.getElementById('journalModal').classList.remove('open');
        journalPendingTx = null;
    }

    function renderStockJournalNote(symbol) {
        const wrap = document.getElementById('stockJournalNote');
        const txt = document.getElementById('stockJournalText');
        if (!wrap || !txt) return;
        const entries = (tradeJournal[symbol] || []).slice(-3);
        if (!entries.length) { wrap.style.display = 'none'; return; }
        wrap.style.display = 'block';
        txt.innerHTML = entries.map(e => {
            const d = new Date(e.ts).toLocaleDateString([], { month:'short', day:'numeric' });
            return `<div style="margin-bottom:6px;"><span style="font-size:10px;color:${e.side==='BUY'?'#4ade80':'#f87171'};font-weight:700;">${e.side} ${d}</span><br>${e.note || '<em style="color:#606080;">No note</em>'}</div>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: STOCK DETAIL ENRICHMENT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function renderAnalystRatings(stock) {
        const el = document.getElementById('analystRatings');
        if (!el) return;
        // Generate deterministic simulated ratings from stock data
        const seed = stock.symbol.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        const rng = (min, max) => { const x = Math.sin(seed * 9301 + 49297) * 233280; return Math.floor((x - Math.floor(x)) * (max - min + 1)) + min; };
        const buy = rng(35, 70), hold = rng(15, 35), sell = 100 - buy - Math.min(hold, 100 - buy);
        const total = buy + hold + Math.max(0, sell);
        const consensus = buy > 55 ? 'Strong Buy' : buy > 40 ? 'Buy' : buy > 30 ? 'Hold' : 'Underperform';
        const consColor = buy > 55 ? '#4ade80' : buy > 40 ? '#a3e635' : buy > 30 ? '#facc15' : '#f87171';
        const targetSeed = (seed % 30) / 100;
        const target = (stock.price * (1 + targetSeed + 0.05)).toFixed(2);
        const upside = ((target - stock.price) / stock.price * 100).toFixed(1);

        el.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <div>
                    <div style="font-size:1.1rem;font-weight:700;color:${consColor};">${consensus}</div>
                    <div style="font-size:11px;color:#8888a8;">Based on ${rng(12,40)} analysts</div>
                </div>
                <div style="text-align:right;">
                    <div style="font-size:13px;color:#f0f0fa;font-weight:600;">Target: $${target}</div>
                    <div style="font-size:11px;color:${upside >= 0 ? '#4ade80' : '#f87171'};">${upside >= 0 ? '+' : ''}${upside}% upside</div>
                </div>
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;">
                ${[['Buy', buy, '#4ade80'], ['Hold', hold, '#facc15'], ['Sell', Math.max(0,sell), '#f87171']].map(([label, pct, color]) => `
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="width:40px;font-size:11px;color:#8888a8;">${label}</div>
                    <div class="analyst-bar" style="flex:1;"><div class="analyst-fill" style="width:${pct}%;background:${color};"></div></div>
                    <div style="width:32px;font-size:11px;font-weight:700;color:#c0c0d8;text-align:right;">${pct}%</div>
                </div>`).join('')}
            </div>`;
    }

    function renderEarnings(stock) {
        const el = document.getElementById('earningsData');
        if (!el) return;
        const seed = stock.symbol.split('').reduce((a, c) => a + c.charCodeAt(0), 0);
        const quarters = ['Q1 2025','Q4 2024','Q3 2024','Q2 2024'];
        el.innerHTML = quarters.map((q, i) => {
            const base = stock.price * (0.04 + (seed % 7) * 0.01);
            const est = (base + i * 0.02).toFixed(2);
            const beat = (seed + i) % 3 !== 0;
            const actual = beat ? (parseFloat(est) + Math.random() * 0.15).toFixed(2) : (parseFloat(est) - Math.random() * 0.08).toFixed(2);
            const diff = ((actual - est) / est * 100).toFixed(1);
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:10px;">
                <div style="font-size:11px;color:#8888a8;margin-bottom:4px;">${q}</div>
                <div style="font-size:13px;font-weight:700;color:#f0f0fa;">$${actual} <span style="font-size:10px;color:${beat?'#4ade80':'#f87171'};font-weight:600;">${beat?'BEAT':'MISS'} ${diff}%</span></div>
                <div style="font-size:11px;color:#606080;">Est. $${est}</div>
            </div>`;
        }).join('');
    }

    function renderSimilarStocks(stock) {
        const el = document.getElementById('similarStocks');
        if (!el) return;
        const sector = stock.sector || inferSector(stock.symbol, stock.name);
        const similar = stocks.filter(s => s.symbol !== stock.symbol && inferSector(s.symbol, s.name) === sector).slice(0, 6);
        if (!similar.length) { el.innerHTML = '<div style="color:#8888a8;font-size:13px;">No similar stocks found.</div>'; return; }
        el.innerHTML = similar.map(s => {
            const pos = s.change >= 0;
            return `<button onclick="openStockDetail(getStockBySymbol('${s.symbol}'))" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);border-radius:10px;padding:8px 12px;cursor:pointer;text-align:left;transition:border-color 0.2s;" onmouseover="this.style.borderColor='var(--v-gold)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.08)'">
                <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${s.symbol}</div>
                <div style="font-size:11px;color:${pos?'#4ade80':'#f87171'};font-family:var(--v-mono);">${pos?'+':''}${s.change.toFixed(2)}%</div>
            </button>`;
        }).join('');
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: SHAREABLE PORTFOLIO
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function sharePortfolio() {
        if (!currentUser) return;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym); return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const total = cash + portfolioValue;
        const pl = total - 100000;
        const plPct = (pl / 100000 * 100).toFixed(2);
        const holdings = Object.keys(portfolio).slice(0, 5).map(sym => {
            const s = getStockBySymbol(sym);
            return s ? `${sym} Ã—${portfolio[sym]}` : sym;
        }).join(', ');

        const shareText = `ğŸ“Š My Vestra Portfolio\nğŸ‘¤ ${currentUser.displayName}\nğŸ’° $${total.toLocaleString(undefined,{maximumFractionDigits:0})} total equity\n${pl >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${pl >= 0 ? '+' : ''}$${Math.abs(pl).toLocaleString(undefined,{maximumFractionDigits:0})} (${pl >= 0 ? '+' : ''}${plPct}%)\nğŸ¦ Holdings: ${holdings || 'None yet'}\n\nTry Vestra â€” risk-free trading!`;

        if (navigator.share) {
            navigator.share({ title: 'My Vestra Portfolio', text: shareText }).catch(() => {});
        } else {
            navigator.clipboard.writeText(shareText).then(() => {
                showTradeToast('INFO', 0, 'Portfolio stats copied to clipboard!', 0, false);
            }).catch(() => {
                // fallback: show in a prompt
                prompt('Copy your portfolio summary:', shareText);
            });
        }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  FEATURE: MOBILE TABS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function mobileTab(tab) {
        document.querySelectorAll('.mob-nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById('mn' + tab.charAt(0).toUpperCase() + tab.slice(1))?.classList.add('active');

        const grid = document.querySelector('#grid')?.parentElement;
        const sidebar = document.getElementById('desktopSidebar');
        const mobPortfolio = document.getElementById('mobilePortfolioView');
        const searchWrap = document.getElementById('searchWrap');

        if (tab === 'market') {
            if (grid) grid.style.display = '';
            if (mobPortfolio) mobPortfolio.style.display = 'none';
        } else if (tab === 'portfolio') {
            if (grid) grid.style.display = 'none';
            if (mobPortfolio) {
                mobPortfolio.style.display = 'block';
                renderMobilePortfolio();
            }
        } else if (tab === 'search') {
            if (grid) grid.style.display = '';
            const inp = document.getElementById('search');
            if (inp) { inp.focus(); }
        } else if (tab === 'profile') {
            if (grid) grid.style.display = 'none';
            if (mobPortfolio) {
                mobPortfolio.style.display = 'block';
                mobPortfolio.innerHTML = `<div style="padding:20px 0;">
                    <div style="font-family:var(--v-serif);font-size:1.5rem;color:#f0f0fa;margin-bottom:4px;">${currentUser?.displayName || 'â€”'}</div>
                    <div style="font-size:13px;color:#8888a8;margin-bottom:20px;">@${currentUser?.username || 'â€”'}</div>
                    <button onclick="sharePortfolio()" style="width:100%;background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.25);color:var(--v-gold);padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">ğŸ”— Share Portfolio</button>
                    <button onclick="openApiConfig()" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#c0c0d8;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">âš¡ Live Data Settings</button>
                    <button onclick="toggleTheme()" style="width:100%;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#c0c0d8;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;margin-bottom:10px;">ğŸŒ™ Toggle Theme</button>
                    <button onclick="logOut()" style="width:100%;background:rgba(239,68,68,0.1);border:1px solid rgba(239,68,68,0.2);color:#f87171;padding:12px;border-radius:10px;font-weight:700;cursor:pointer;">Sign Out</button>
                </div>`;
            }
        }
    }

    function renderMobilePortfolio() {
        const el = document.getElementById('mobilePortfolioView');
        if (!el) return;
        const portfolioValue = Object.keys(portfolio).reduce((sum, sym) => {
            const s = getStockBySymbol(sym); return sum + (s ? s.price * portfolio[sym] : 0);
        }, 0);
        const total = cash + portfolioValue;
        const pl = total - 100000;
        const plPct = (pl / 100000 * 100).toFixed(2);
        const plColor = pl >= 0 ? '#4ade80' : '#f87171';
        let holdingsHtml = '<div style="color:#8888a8;font-size:13px;padding:16px 0;">No holdings yet.</div>';
        if (Object.keys(portfolio).length) {
            holdingsHtml = Object.keys(portfolio).map(sym => {
                const s = getStockBySymbol(sym);
                if (!s) return '';
                const val = s.price * portfolio[sym];
                const pos = s.change >= 0;
                return `<div onclick="openStockDetail(getStockBySymbol('${sym}'))" style="display:flex;justify-content:space-between;padding:14px 0;border-bottom:1px solid rgba(255,255,255,0.06);cursor:pointer;">
                    <div><div style="font-weight:700;color:#e8e8f5;">${sym}</div><div style="font-size:11px;color:#8888a8;">${portfolio[sym]} shares</div></div>
                    <div style="text-align:right;"><div style="font-family:var(--v-mono);color:#f0f0fa;">$${val.toFixed(2)}</div><div style="font-size:11px;color:${pos?'#4ade80':'#f87171'};">${pos?'+':''}${s.change.toFixed(2)}% today</div></div>
                </div>`;
            }).join('');
        }
        el.innerHTML = `<div style="margin-bottom:20px;">
            <div style="font-size:11px;color:#8888a8;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:4px;">Total Equity</div>
            <div style="font-size:2.2rem;font-weight:300;color:#f5f5fa;font-family:var(--v-mono);">$${total.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
            <div style="font-size:1rem;font-weight:600;color:${plColor};">${pl>=0?'+':''}$${Math.abs(pl).toFixed(2)} (${pl>=0?'+':''}${plPct}%)</div>
        </div>
        <div style="font-size:0.9rem;font-weight:600;color:#e0e0f5;margin-bottom:8px;">Holdings</div>
        ${holdingsHtml}`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HOOK: Patch processAlerts to fire notifications
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function processAlerts() {
        let fired = false;
        priceAlerts.forEach(a => {
            if (a.triggered) return;
            const st = getStockBySymbol(a.symbol);
            if (!st) return;
            const cond = (a.type === 'above' && st.price >= a.value)
                || (a.type === 'below' && st.price <= a.value)
                || (a.type === 'move' && Math.abs(st.change) >= a.value);
            if (cond) {
                a.triggered = true;
                alertEvents.unshift(`Alert: ${a.symbol} ${a.type} $${a.value} â†’ $${st.price.toFixed(2)}`);
                alertEvents = alertEvents.slice(0, 8);
                fireAlertNotification(a.symbol, a.type, a.value, st.price);
                fired = true;
            }
        });
        if (fired) { renderAlerts(); saveUserData(false); }
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //  HOOK: Patch execDetailTrade to open journal
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Update market status every minute
    setInterval(updateMarketStatus, 60000);

    // â•â•â• END REAL-TIME DATA ENGINE â•â•â•

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   HOMEPAGE LOGIC
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    function showHomepage() {
        document.getElementById('homePage').style.display = 'block';
        document.getElementById('appPage').style.display  = 'none';
        document.getElementById('authOverlay').style.display = 'none';
        drawHeroChart();
        initTicker();
    }

    function showApp() {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('appPage').style.display  = 'block';
        document.getElementById('authOverlay').style.display = 'none';
    }

    function showAuthFromHome(mode) {
        authMode = mode;
        const isRegister = mode === 'register';
        document.getElementById('registerNameGroup').classList.toggle('hidden', !isRegister);
        document.getElementById('authTitle').textContent    = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authSubtitle').textContent = isRegister ? 'Join Vestra â€” it\'s free' : 'to your trading account';
        document.getElementById('authSubmitBtn').textContent = isRegister ? 'Create Account' : 'Sign In';
        document.getElementById('authToggleText').textContent = isRegister ? 'Already have an account?' : 'Don\'t have an account?';
        document.getElementById('authToggleBtn').textContent  = isRegister ? 'Sign in' : 'Create account';
        document.getElementById('authOverlay').style.display = 'flex';
    }

    function scrollToSection(id) {
        document.getElementById(id)?.scrollIntoView({ behavior: 'smooth' });
    }

    function drawHeroChart() {
        const canvas = document.getElementById('heroChart');
        if (!canvas) return;
        const W = canvas.parentElement.clientWidth - 48;
        const H = 140;
        const dpr = window.devicePixelRatio || 1;
        canvas.width  = W * dpr;
        canvas.height = H * dpr;
        canvas.style.width  = W + 'px';
        canvas.style.height = H + 'px';
        const ctx = canvas.getContext('2d');
        ctx.scale(dpr, dpr);

        const pts = 80;
        const values = [];
        let v = 180;
        for (let i = 0; i < pts; i++) { v += (Math.random() - 0.42) * 4; values.push(Math.max(140, v)); }
        const min = Math.min(...values), max = Math.max(...values);
        const toX = i => (i / (pts - 1)) * W;
        const toY = v => H - ((v - min) / (max - min + 1)) * (H - 16) - 8;

        const grad = ctx.createLinearGradient(0, 0, 0, H);
        grad.addColorStop(0, 'rgba(201,168,76,0.25)');
        grad.addColorStop(1, 'rgba(201,168,76,0)');
        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.lineTo(W, H); ctx.lineTo(0, H); ctx.closePath();
        ctx.fillStyle = grad; ctx.fill();

        ctx.beginPath();
        ctx.moveTo(toX(0), toY(values[0]));
        for (let i = 1; i < pts; i++) ctx.lineTo(toX(i), toY(values[i]));
        ctx.strokeStyle = '#c9a84c'; ctx.lineWidth = 2; ctx.stroke();

        let base = 214.37;
        setInterval(() => {
            base += (Math.random() - 0.48) * 0.5;
            const el = document.getElementById('heroPrice');
            const ch = document.getElementById('heroChange');
            if (el) el.textContent = '$' + base.toFixed(2);
            if (ch) {
                const pct = ((base - 211.74) / 211.74 * 100).toFixed(2);
                ch.textContent = (pct >= 0 ? '+' : '') + pct + '%';
                ch.style.color = pct >= 0 ? '#4ade80' : '#f87171';
            }
        }, 2000);
    }

    function initTicker() {
        const items = ['AAPL $214.37 +1.2%','TSLA $248.12 +0.8%','MSFT $415.23 +0.5%','NVDA $138.42 +3.1%','AMZN $224.18 -0.3%','META $612.45 +1.7%','GOOGL $198.23 +0.4%','JPM $281.43 +0.9%','V $341.27 +0.6%','WMT $98.45 +1.1%','XOM $112.34 +0.7%','HD $387.12 +0.8%'];
        const html = items.map(t => {
            const pos = t.includes('+');
            return `<span style="display:inline-block;padding:0 32px;font-family:var(--v-mono);font-size:0.8rem;color:${pos?'#4ade80':'#f87171'};">${t}</span>`;
        }).join('');
        ['tickerInner','tickerInner2'].forEach(id => { const el = document.getElementById(id); if (el) el.innerHTML = html; });
    }




    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   ORDER TYPE HINT
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function updateOrderTypeHint(sel) {
        const hints = {
            market: 'Executes immediately at current market price.',
            limit: 'Fills only at your specified price or better.',
            'stop-loss': 'Sells automatically if price drops to trigger.',
            'take-profit': 'Sells automatically when price hits your target.',
            gtt: 'Good-Till-Triggered: persists until price condition is met.'
        };
        // Show toast-style hint
        showTradeToast('INFO', 0, hints[sel.value] || '', 0, false);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   STOCK SCREENER
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openScreener() { document.getElementById('screenerModal').style.display='block'; }
    function closeScreener() { document.getElementById('screenerModal').style.display='none'; }

    function runScreener() {
        const sector = document.getElementById('scSector').value;
        const change = document.getElementById('scChange').value;
        const price  = document.getElementById('scPrice').value;
        const pe     = document.getElementById('scPE').value;
        const res    = document.getElementById('screenerResults');

        let filtered = stocks.slice();
        if (sector)  filtered = filtered.filter(s => s.sector === sector);
        if (change === 'up5')   filtered = filtered.filter(s => s.change > 5);
        else if (change === 'up2')   filtered = filtered.filter(s => s.change > 2);
        else if (change === 'down2') filtered = filtered.filter(s => s.change < -2);
        else if (change === 'down5') filtered = filtered.filter(s => s.change < -5);
        else if (change === 'flat')  filtered = filtered.filter(s => Math.abs(s.change) <= 1);
        if (price === '0-50')   filtered = filtered.filter(s => s.price < 50);
        else if (price === '50-200')  filtered = filtered.filter(s => s.price >= 50 && s.price < 200);
        else if (price === '200-500') filtered = filtered.filter(s => s.price >= 200 && s.price < 500);
        else if (price === '500+')    filtered = filtered.filter(s => s.price >= 500);
        if (pe === 'low')  filtered = filtered.filter(s => s.pe > 0 && s.pe < 15);
        else if (pe === 'mid')  filtered = filtered.filter(s => s.pe >= 15 && s.pe <= 35);
        else if (pe === 'high') filtered = filtered.filter(s => s.pe > 35);
        else if (pe === 'neg')  filtered = filtered.filter(s => s.pe < 0);

        filtered = filtered.slice(0, 100);
        if (filtered.length === 0) {
            res.innerHTML = '<div style="text-align:center;color:#8888a8;padding:32px 0;font-size:13px;">No stocks match these criteria.</div>';
            return;
        }

        res.innerHTML = `
            <div style="font-size:11px;color:#6868a0;margin-bottom:10px;">${filtered.length} results</div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:8px;">
                ${filtered.map(s => {
                    const isPos = s.change >= 0;
                    return `<div onclick="closeScreener();openStockDetail(getStockBySymbol('${s.symbol}'))" style="background:#1a1a24;border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px;cursor:pointer;transition:border-color 0.2s;" onmouseover="this.style.borderColor='rgba(212,168,75,0.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.07)'">
                        <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:6px;">
                            <div>
                                <div style="font-weight:700;color:#e8e8f5;font-size:0.875rem;">${s.symbol}</div>
                                <div style="font-size:10px;color:#6868a0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:110px;">${s.name}</div>
                            </div>
                            <span style="font-size:10px;font-weight:700;padding:2px 6px;border-radius:3px;${isPos?'background:rgba(34,197,94,0.12);color:#4ade80':'background:rgba(239,68,68,0.12);color:#f87171'}">${isPos?'+':''}${s.change.toFixed(2)}%</span>
                        </div>
                        <div style="font-family:var(--v-mono);font-size:1.1rem;color:#f0f0fa;">$${s.price.toFixed(2)}</div>
                        <div style="font-size:9px;color:#6868a0;margin-top:3px;">P/E: ${s.pe>0?s.pe.toFixed(1):'â€”'} Â· ${s.sector||'â€”'}</div>
                    </div>`;
                }).join('')}
            </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   ECONOMIC CALENDAR
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function openCalendar() {
        document.getElementById('calendarModal').style.display = 'block';
        renderCalendar();
    }
    function closeCalendar() { document.getElementById('calendarModal').style.display='none'; }

    function renderCalendar() {
        const el = document.getElementById('calendarContent');
        const now = Date.now();
        const day = 86400000;
        const events = [
            { ts: now + 1*day,  type:'fed',      impact:'high',   title:'FOMC Meeting Minutes',            detail:'Federal Reserve publishes meeting minutes. Watch for rate guidance language.' },
            { ts: now + 2*day,  type:'earnings', impact:'high',   title:'NVDA Earnings Report Q4 2025',    detail:'NVIDIA Q4 earnings. Analysts expect EPS of $0.84 on revenue of $38.0B.' },
            { ts: now + 3*day,  type:'data',     impact:'medium', title:'US CPI Inflation Data',           detail:'Consumer Price Index for January. Core CPI expected at 3.1% YoY.' },
            { ts: now + 4*day,  type:'earnings', impact:'high',   title:'AAPL Earnings Report Q1 2026',    detail:'Apple Q1 FY2026 results. iPhone 17 cycle in focus. EPS est. $2.26.' },
            { ts: now + 5*day,  type:'data',     impact:'high',   title:'US Non-Farm Payrolls',            detail:'January jobs report. Consensus forecast: +195K jobs, unemployment 4.1%.' },
            { ts: now + 6*day,  type:'earnings', impact:'medium', title:'MSFT Earnings Report Q2 FY26',    detail:'Microsoft Q2 FY2026. Azure cloud growth in focus. EPS est. $3.12.' },
            { ts: now + 8*day,  type:'fed',      impact:'high',   title:'Fed Chair Powell Speech',         detail:'Jerome Powell speaks at the Economic Club of New York on monetary policy outlook.' },
            { ts: now + 9*day,  type:'data',     impact:'medium', title:'US Retail Sales MoM',             detail:'January retail sales data. Previous: +0.4%. Consensus: +0.3%.' },
            { ts: now + 11*day, type:'earnings', impact:'high',   title:'GOOGL Earnings Report Q4 2025',   detail:'Alphabet Q4 results. AI-driven search monetization and cloud revenue in focus.' },
            { ts: now + 12*day, type:'data',     impact:'high',   title:'Fed Rate Decision',               detail:'FOMC rate decision. Markets pricing 88% probability of hold at 4.25â€“4.50%.' },
            { ts: now + 14*day, type:'earnings', impact:'medium', title:'META Earnings Report Q4 2025',    detail:'Meta Q4 2025 results. AI advertising tools and Reality Labs losses in focus.' },
            { ts: now + 18*day, type:'data',     impact:'medium', title:'US GDP Q4 2025 Preliminary',      detail:'Q4 GDP growth estimate. Previous: +2.8% annualized. Est: +2.5%.' },
        ];
        const typeColor = { fed:'rgba(139,92,246,0.12)', earnings:'rgba(212,168,75,0.10)', data:'rgba(34,197,94,0.08)' };
        const typeText  = { fed:'#a78bfa', earnings:'var(--v-gold)', data:'#4ade80' };
        const typeLabel = { fed:'ğŸ¦ Fed', earnings:'ğŸ“Š Earnings', data:'ğŸ“ˆ Economic' };
        const impactDot = { high:'#ef4444', medium:'var(--v-gold)', low:'#4ade80' };

        el.innerHTML = `<div style="display:flex;flex-direction:column;gap:8px;">
            ${events.map(ev => {
                const d = new Date(ev.ts);
                const dateStr = d.toLocaleDateString([], {weekday:'short', month:'short', day:'numeric'});
                return `<div style="background:${typeColor[ev.type]};border:1px solid rgba(255,255,255,0.07);border-radius:10px;padding:12px 14px;display:flex;gap:12px;align-items:flex-start;">
                    <div style="width:52px;flex-shrink:0;text-align:center;">
                        <div style="font-size:9px;color:#6868a0;text-transform:uppercase;font-weight:700;">${d.toLocaleDateString([],{month:'short'})}</div>
                        <div style="font-family:var(--v-mono);font-size:1.3rem;color:#f0f0fa;line-height:1;">${d.getDate()}</div>
                        <div style="font-size:9px;color:#6868a0;">${d.toLocaleDateString([],{weekday:'short'})}</div>
                    </div>
                    <div style="flex:1;min-width:0;">
                        <div style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
                            <span style="font-size:9px;font-weight:700;color:${typeText[ev.type]};text-transform:uppercase;letter-spacing:0.05em;">${typeLabel[ev.type]}</span>
                            <span style="width:5px;height:5px;border-radius:50%;background:${impactDot[ev.impact]};flex-shrink:0;"></span>
                            <span style="font-size:9px;color:#6868a0;text-transform:capitalize;">${ev.impact} impact</span>
                        </div>
                        <div style="font-weight:600;color:#e0e0f5;font-size:0.875rem;margin-bottom:3px;">${ev.title}</div>
                        <div style="font-size:11px;color:#8888a8;line-height:1.5;">${ev.detail}</div>
                    </div>
                </div>`;
            }).join('')}
        </div>`;
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   COMMUNITY / SOCIAL TRADING
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const communityPosts = [
        { user:'TradingWolf', avatar:'TW', ts: Date.now()-3600000,  text:'Watching $NVDA closely â€” the AI datacenter narrative is still strong. Buying dips under $175. ğŸ¯', likes:12, sym:'NVDA' },
        { user:'BullRunner99', avatar:'BR', ts: Date.now()-7200000,  text:'$AAPL looking bearish short-term after the iPhone 17 leak disappointment. Set a stop at $248. ğŸ“‰', likes:8, sym:'AAPL' },
        { user:'QuantEdge',    avatar:'QE', ts: Date.now()-14400000, text:'RSI on $META just hit oversold territory (28). Historically this has been a great entry. Long here. ğŸ”¥', likes:19, sym:'META' },
        { user:'ValueHunter',  avatar:'VH', ts: Date.now()-21600000, text:'$JPM P/E at 14x with 2.4% dividend yield â€” classic value. Adding to position today. ğŸ¦', likes:6, sym:'JPM' },
        { user:'SwingKing',    avatar:'SK', ts: Date.now()-43200000, text:'Fed minutes tomorrow could be a catalyst. $SPY calls cheap right now. Risk/reward looks good. âš¡', likes:23, sym:'SPY' },
    ];

    function openCommunity() {
        document.getElementById('communityModal').style.display = 'block';
        const av = document.getElementById('communityAvatar');
        if (av && currentUser) { av.textContent = (currentUser.displayName||currentUser.username||'?')[0].toUpperCase(); }
        renderCommunityFeed();
    }
    function closeCommunity() { document.getElementById('communityModal').style.display='none'; }

    function renderCommunityFeed() {
        const feed = document.getElementById('communityFeed');
        if (!feed) return;
        feed.innerHTML = communityPosts.slice().sort((a,b)=>b.ts-a.ts).map((p, idx) => {
            const rel = relativeTime(p.ts);
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:12px 14px;">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
                    <div style="width:28px;height:28px;border-radius:50%;background:var(--v-gold);display:flex;align-items:center;justify-content:center;color:#0a0a0f;font-size:11px;font-weight:700;flex-shrink:0;">${p.avatar}</div>
                    <div>
                        <div style="font-weight:700;color:#e0e0f5;font-size:12px;">${p.user}</div>
                        <div style="font-size:10px;color:#6868a0;">${rel}</div>
                    </div>
                    ${p.sym ? `<span onclick="closeCommunity();openStockDetail(getStockBySymbol('${p.sym}'))" style="margin-left:auto;font-size:9px;font-weight:700;color:var(--v-gold);background:rgba(212,168,75,0.1);border:1px solid rgba(212,168,75,0.2);padding:2px 7px;border-radius:4px;cursor:pointer;">$${p.sym}</span>` : ''}
                </div>
                <p style="font-size:12px;color:#c0c0d8;line-height:1.6;margin:0 0 8px;">${p.text}</p>
                <button onclick="communityLike(${idx})" style="font-size:10px;color:#6868a0;background:none;border:none;cursor:pointer;padding:0;" onmouseover="this.style.color='var(--v-gold)'" onmouseout="this.style.color='#6868a0'">â¤ï¸ ${p.likes}</button>
            </div>`;
        }).join('');
    }

    function communityLike(idx) {
        communityPosts[idx].likes++;
        renderCommunityFeed();
    }

    function postCommunityIdea() {
        const ta = document.getElementById('communityPost');
        const text = ta.value.trim();
        if (!text) return;
        const name = currentUser?.displayName || currentUser?.username || 'You';
        const initials = name.slice(0,2).toUpperCase();
        // Extract $TICKER mentions
        const syms = text.match(/\$[A-Z]{1,5}/g);
        const sym = syms ? syms[0].replace('$','') : '';
        communityPosts.unshift({ user:name, avatar:initials, ts:Date.now(), text, likes:0, sym });
        ta.value = '';
        renderCommunityFeed();
    }

    function relativeTime(ts) {
        const diff = Date.now() - ts;
        if (diff < 60000) return 'just now';
        if (diff < 3600000) return Math.floor(diff/60000)+'m ago';
        if (diff < 86400000) return Math.floor(diff/3600000)+'h ago';
        return Math.floor(diff/86400000)+'d ago';
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   EDUCATION HUB
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const eduLessons = [
        { emoji:'ğŸ“Š', cat:'Basics', title:'What is a Stock?', read:'3 min', content:`A stock represents ownership in a company. When you buy a share of Apple (AAPL), you own a small piece of Apple Inc. Companies issue stock to raise money for growth, and shareholders can profit through price appreciation and dividends.<br><br><strong>Key concepts:</strong><br>â€¢ <em>Market cap</em> = share price Ã— total shares<br>â€¢ <em>P/E ratio</em> = price Ã· annual earnings per share<br>â€¢ <em>Dividend yield</em> = annual dividend Ã· share price<br><br>Vestra tip: Start by researching companies you already know and use every day.` },
        { emoji:'ğŸ“ˆ', cat:'Charting', title:'Reading Candlestick Charts', read:'5 min', content:`Candlestick charts show four data points for each time period: Open, High, Low, Close (OHLC).<br><br><strong>Green candle (bullish)</strong>: price closed higher than it opened<br><strong>Red candle (bearish)</strong>: price closed lower than it opened<br><br>The thin lines (wicks) show the highest and lowest prices hit. A long upper wick means sellers pushed price down from the high. A long lower wick means buyers stepped in at the low.<br><br>Common patterns: Doji (indecision), Hammer (reversal signal), Engulfing (trend change).` },
        { emoji:'ğŸ“‰', cat:'Charting', title:'Moving Averages Explained', read:'4 min', content:`A Moving Average (MA) smooths price data to identify trends by calculating the average closing price over N periods.<br><br><strong>SMA (Simple Moving Average)</strong>: equal weight to all periods. Common: 20-day, 50-day, 200-day.<br><strong>EMA (Exponential MA)</strong>: more weight to recent prices, reacts faster.<br><br><em>Golden Cross</em>: 50-day MA crosses above 200-day â†’ bullish signal<br><em>Death Cross</em>: 50-day MA crosses below 200-day â†’ bearish signal<br><br>Try toggling MA on in Vestra's chart to see it in action.` },
        { emoji:'âš¡', cat:'Technical', title:'RSI â€” Relative Strength Index', read:'4 min', content:`RSI measures the speed and magnitude of recent price changes to evaluate if a stock is overbought or oversold. It ranges from 0 to 100.<br><br><strong>Rules of thumb:</strong><br>â€¢ RSI above 70 â†’ potentially overbought (may pull back)<br>â€¢ RSI below 30 â†’ potentially oversold (may bounce)<br>â€¢ RSI at 50 â†’ neutral / trend confirmation<br><br>Important: RSI is a momentum indicator, not a buy/sell signal on its own. A stock can stay overbought for extended periods in a strong uptrend. Always confirm with price action.` },
        { emoji:'ğŸ¯', cat:'Strategy', title:'Position Sizing & Risk Management', read:'5 min', content:`How much you trade matters more than what you trade. Professional traders typically risk no more than 1â€“2% of their total portfolio on any single trade.<br><br><strong>Example:</strong> $100,000 portfolio Ã— 1% risk = $1,000 max loss per trade.<br>If your stop-loss is 5% below entry, your position size = $1,000 Ã· 5% = $20,000 max position.<br><br><em>Kelly Criterion</em>: advanced formula to optimize position sizing based on win rate and payoff ratio.<br><br>Vestra tip: Use stop-loss orders on every trade. Practice sizing in simulation before real money.` },
        { emoji:'ğŸ¦', cat:'Fundamentals', title:'How to Read an Earnings Report', read:'6 min', content:`Quarterly earnings reports are the most important events for individual stocks. Key metrics to watch:<br><br><strong>EPS (Earnings Per Share)</strong>: net income divided by shares outstanding. Compare to analyst consensus estimate.<br><strong>Revenue</strong>: total sales. Growth rate matters as much as the number itself.<br><strong>Guidance</strong>: management's forecast for next quarter. Often more important than actual results.<br><br>A stock can beat EPS estimates and still fall if guidance disappoints â€” this is called "sell the news." Markets are forward-looking.` },
        { emoji:'ğŸ”„', cat:'Strategy', title:'Understanding Order Types', read:'4 min', content:`<strong>Market Order</strong>: executes immediately at the best available price. Use when you need certainty of execution, not price.<br><br><strong>Limit Order</strong>: only fills at your specified price or better. Protects you from bad fills but may not execute.<br><br><strong>Stop-Loss</strong>: automatically sells if price drops to your trigger. Essential risk management tool.<br><br><strong>Take-Profit</strong>: automatically sells when your price target is hit. Locks in gains without watching the screen.<br><br><strong>GTT (Good-Till-Triggered)</strong>: like a limit order that stays active indefinitely until the condition is met.` },
    ];

    let eduFilter = 'All';

    function openEducation() {
        document.getElementById('educationModal').style.display = 'block';
        renderEducation();
    }
    function closeEducation() { document.getElementById('educationModal').style.display='none'; }

    function renderEducation(openIdx = null) {
        const el = document.getElementById('educationContent');
        if (!el) return;
        if (openIdx !== null) {
            const l = eduLessons[openIdx];
            el.innerHTML = `
                <button onclick="renderEducation()" style="font-size:12px;color:var(--v-gold);background:none;border:none;cursor:pointer;padding:0;margin-bottom:16px;">â† Back to lessons</button>
                <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
                    <div style="font-size:2rem;">${l.emoji}</div>
                    <div>
                        <div style="font-size:9px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.08em;margin-bottom:3px;">${l.cat} Â· ${l.read} read</div>
                        <h3 style="font-family:var(--v-serif);font-size:1.3rem;color:#f0f0fa;margin:0;">${l.title}</h3>
                    </div>
                </div>
                <div style="font-size:13px;color:#c0c0d8;line-height:1.8;">${l.content}</div>`;
            return;
        }

        const cats = ['All', ...new Set(eduLessons.map(l => l.cat))];
        el.innerHTML = `
            <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:18px;">
                ${cats.map(cat => `<button onclick="setEduFilter('${cat}')" id="edu-${cat}" style="font-size:10px;font-weight:700;padding:3px 10px;border-radius:5px;cursor:pointer;border:1px solid ${cat===eduFilter?'var(--v-gold)':'rgba(255,255,255,0.1)'};background:${cat===eduFilter?'rgba(212,168,75,0.15)':'transparent'};color:${cat===eduFilter?'var(--v-gold)':'#8888a8'};">${cat}</button>`).join('')}
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;">
                ${eduLessons.map((l, i) => (eduFilter==='All'||l.cat===eduFilter) ? `
                    <div onclick="renderEducation(${i})" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07);border-radius:12px;padding:16px;cursor:pointer;transition:border-color 0.2s;" onmouseover="this.style.borderColor='rgba(212,168,75,0.3)'" onmouseout="this.style.borderColor='rgba(255,255,255,0.07)'">
                        <div style="font-size:1.8rem;margin-bottom:8px;">${l.emoji}</div>
                        <div style="font-size:9px;font-weight:700;color:var(--v-gold);text-transform:uppercase;letter-spacing:0.07em;margin-bottom:4px;">${l.cat} Â· ${l.read}</div>
                        <div style="font-weight:600;color:#e0e0f5;font-size:0.875rem;">${l.title}</div>
                    </div>` : '').join('')}
            </div>`;
    }

    function setEduFilter(cat) {
        eduFilter = cat;
        renderEducation();
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   AUTO-BOT RULES ENGINE
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let botRules = [];

    function openBotBuilder() {
        document.getElementById('botModal').style.display = 'block';
        document.getElementById('botError').style.display = 'none';
        // Pre-fill symbol from current detail stock
        if (detailStock) document.getElementById('botSymbol').value = detailStock.symbol;
    }
    function closeBotBuilder() { document.getElementById('botModal').style.display='none'; }

    function saveBotRule() {
        const sym  = document.getElementById('botSymbol').value.trim().toUpperCase();
        const action = document.getElementById('botAction').value;
        const qty  = parseInt(document.getElementById('botQty').value);
        const cond = document.getElementById('botCondition').value;
        const trig = parseFloat(document.getElementById('botTrigger').value);
        const errEl = document.getElementById('botError');

        if (!sym || isNaN(qty) || qty < 1 || isNaN(trig)) {
            errEl.style.display='block'; errEl.textContent='Please fill in all fields with valid values.'; return;
        }
        const stock = getStockBySymbol(sym);
        if (!stock) {
            errEl.style.display='block'; errEl.textContent=`Symbol "${sym}" not found in the market.`; return;
        }
        botRules.push({ id: Date.now(), sym, action, qty, cond, trig, active: true, created: Date.now() });
        renderBotRules();
        closeBotBuilder();
        showTradeToast('INFO', qty, sym, trig, true);
    }

    function renderBotRules() {
        const el = document.getElementById('botRulesList');
        if (!el) return;
        if (botRules.length === 0) {
            el.innerHTML = '<div style="text-align:center;padding:8px 0;font-style:italic;">No auto-rules yet. Set conditions to trade automatically.</div>';
            return;
        }
        const condLabel = { above:'rises above', below:'falls below', up_pct:'gains â‰¥', down_pct:'drops â‰¥' };
        el.innerHTML = botRules.map((r, i) => `
            <div style="display:flex;align-items:center;justify-content:space-between;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.05);">
                <div style="font-size:11px;color:#c0c0d8;">
                    <span style="font-weight:700;color:${r.action==='BUY'?'#4ade80':'#f87171'}">${r.action}</span>
                    <span style="color:#e0e0f5;"> ${r.qty}Ã— ${r.sym}</span>
                    <span style="color:#8888a8;"> if price ${condLabel[r.cond]} $${r.trig}</span>
                </div>
                <button onclick="removeBotRule(${i})" style="font-size:10px;color:#8888a8;background:none;border:none;cursor:pointer;padding:0 0 0 8px;" onmouseover="this.style.color='#f87171'" onmouseout="this.style.color='#8888a8'">âœ•</button>
            </div>`).join('');
    }

    function removeBotRule(idx) {
        botRules.splice(idx, 1);
        renderBotRules();
    }

    // Process bot rules on every market tick
    const _origSimulateTick = simulateMarketTick;
    simulateMarketTick = function() {
        _origSimulateTick();
        processBotRules();
    };

    function processBotRules() {
        botRules.forEach((rule, idx) => {
            if (!rule.active) return;
            const stock = getStockBySymbol(rule.sym);
            if (!stock) return;
            let triggered = false;
            if (rule.cond === 'above'    && stock.price >= rule.trig) triggered = true;
            if (rule.cond === 'below'    && stock.price <= rule.trig) triggered = true;
            if (rule.cond === 'up_pct'   && stock.change >= rule.trig) triggered = true;
            if (rule.cond === 'down_pct' && stock.change <= -Math.abs(rule.trig)) triggered = true;
            if (triggered) {
                rule.active = false; // fire once
                // Execute the trade
                const qty = rule.qty;
                const type = rule.action;
                if (type === 'BUY') {
                    const cost = stock.price * qty;
                    if (cash >= cost) {
                        cash -= cost;
                        portfolio[rule.sym] = (portfolio[rule.sym] || 0) + qty;
                        if (!costBasis[rule.sym]) costBasis[rule.sym] = [];
                        costBasis[rule.sym].push({ qty, price: stock.price });
                        transactions.unshift({ type:'BUY', symbol:rule.sym, qty, price:stock.price, ts:Date.now(), note:'ğŸ¤– Auto-rule' });
                        showTradeToast('BUY', qty, rule.sym, stock.price, false);
                        updateUI();
                        saveUserData(true);
                    }
                } else {
                    const owned = portfolio[rule.sym] || 0;
                    const sellQty = Math.min(qty, owned);
                    if (sellQty > 0) {
                        cash += stock.price * sellQty;
                        portfolio[rule.sym] -= sellQty;
                        if (portfolio[rule.sym] <= 0) delete portfolio[rule.sym];
                        const avg = avgCost(rule.sym);
                        if (currentUser) currentUser.realizedPL = (currentUser.realizedPL||0) + (stock.price-avg)*sellQty;
                        transactions.unshift({ type:'SELL', symbol:rule.sym, qty:sellQty, price:stock.price, ts:Date.now(), note:'ğŸ¤– Auto-rule' });
                        showTradeToast('SELL', sellQty, rule.sym, stock.price, false);
                        updateUI();
                        saveUserData(true);
                    }
                }
                renderBotRules();
            }
        });
    }


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   SIP / RECURRING INVESTMENT ENGINE
    //   Supports: Stock SIP, Fractional, ETF, DRIP
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•


    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   INTRADAY INTERVAL SYSTEM (Finnhub resolution mapping)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    // Maps period â†’ which interval buttons to show and default resolution
    const PERIOD_INTRADAY_MAP = {
        '1D':  { showItv:true,  defaultItv:'5'  },
        '5D':  { showItv:true,  defaultItv:'15' },
        '1M':  { showItv:true,  defaultItv:'60' },
        '6M':  { showItv:false, defaultItv:'D'  },
        'YTD': { showItv:false, defaultItv:'D'  },
        '1Y':  { showItv:false, defaultItv:'W'  },
        '5Y':  { showItv:false, defaultItv:'M'  },
        'Max': { showItv:false, defaultItv:'M'  },
    };

    // Interval â†’ Chart.js time unit
    const ITV_TO_UNIT = {
        '1':'minute','5':'minute','15':'minute','60':'hour',
        'D':'day','W':'week','M':'month'
    };

    let _currentIntradayItv = '5'; // default

    function setIntradayInterval(res) {
        _currentIntradayItv = res;
        // Update active button style
        document.querySelectorAll('.itv-btn').forEach(b => b.classList.remove('itv-active'));
        const btn = document.getElementById('itv-' + res);
        if (btn) btn.classList.add('itv-active');
        // Patch PERIOD_CFG to use new resolution
        const period = currentChartPeriod || '1D';
        if (PERIOD_CFG[period]) {
            PERIOD_CFG[period].res  = res;
            PERIOD_CFG[period].unit = ITV_TO_UNIT[res] || 'minute';
        }
        // Bust cache for this period and redraw
        if (detailStock) {
            delete candleCache[detailStock.symbol + '_' + period];
            drawChart(detailStock, period);
        }
    }

    // Patch setChartPeriod to show/hide intraday row + set default interval
    const _baseSetChartPeriod = setChartPeriod;
    setChartPeriod = async function(period, btn) {
        const cfg = PERIOD_INTRADAY_MAP[period] || { showItv:false, defaultItv:'D' };
        const itvRow = document.getElementById('intradayRow');
        if (itvRow) itvRow.style.display = cfg.showItv ? 'flex' : 'none';
        if (cfg.showItv) {
            _currentIntradayItv = cfg.defaultItv;
            document.querySelectorAll('.itv-btn').forEach(b => b.classList.remove('itv-active'));
            const db = document.getElementById('itv-' + cfg.defaultItv);
            if (db) db.classList.add('itv-active');
        }
        await _baseSetChartPeriod(period, btn);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   SLIPPAGE & SPREAD SIMULATION
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    let slippageEnabled = true;
    let spreadEnabled   = true;

    function applySlippage(price, type) {
        if (!slippageEnabled) return price;
        // 0â€“0.05% random slippage + 0.01% base spread
        const slip = price * (0.0001 + Math.random() * 0.0005);
        return type === 'BUY' ? price + slip : price - slip;
    }

    // Patch execDetailTrade to apply slippage on market orders
    const _origExecDetailTrade = execDetailTrade;
    execDetailTrade = function(type) {
        // For market orders, briefly show effective price
        const ot = document.getElementById('orderType');
        if (ot && ot.value === 'market' && detailStock && slippageEnabled) {
            const eff = applySlippage(detailStock.price, type);
            showTradeToast('INFO', 0, `Effective price: $${eff.toFixed(2)} (slippage applied)`, eff, true);
        }
        _origExecDetailTrade(type);
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   RISK SCORE METER  
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function calcRiskScore(stock) {
        if (!stock) return { score:50, label:'Medium', color:'var(--v-gold)' };
        const pct = Math.abs(stock.change);
        const pe  = stock.pe || 25;
        // Heuristic: volatility + P/E extremes = higher risk
        let score = 50;
        score += pct * 4;                          // daily move contribution
        if (pe > 50) score += 15;
        if (pe < 0)  score += 20;                  // unprofitable
        if (pe < 15 && pe > 0) score -= 10;        // value = lower risk
        score = Math.min(100, Math.max(0, score));
        const label = score < 30 ? 'Low' : score < 60 ? 'Medium' : score < 80 ? 'High' : 'Very High';
        const color = score < 30 ? '#4ade80' : score < 60 ? 'var(--v-gold)' : score < 80 ? '#f97316' : '#ef4444';
        return { score: Math.round(score), label, color };
    }

    function calcVolatilityMeter(stock) {
        if (!stock) return { pct:0, label:'â€”' };
        const pct = Math.abs(stock.change);
        const label = pct < 1 ? 'Low' : pct < 3 ? 'Moderate' : pct < 6 ? 'High' : 'Extreme';
        return { pct: Math.min(100, pct * 10), label };
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   KEYBOARD SHORTCUTS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    document.addEventListener('keydown', function(e) {
        const inInput = ['INPUT','TEXTAREA','SELECT'].includes(document.activeElement?.tagName);
        if (inInput) return;
        const detail = document.getElementById('stockDetailPage');
        const isDetailOpen = detail && !detail.classList.contains('hidden');

        if (isDetailOpen) {
            if (e.key === 'b' || e.key === 'B') { e.preventDefault(); execDetailTrade('BUY'); }
            if (e.key === 's' || e.key === 'S') { e.preventDefault(); execDetailTrade('SELL'); }
            if (e.key === '1') { e.preventDefault(); const btn=document.querySelector('.ctab'); if(btn)setChartPeriod('1D',btn); }
            if (e.key === 'd' || e.key === 'D') { e.preventDefault(); const btns=document.querySelectorAll('.ctab'); btns.forEach(b=>{if(b.textContent==='1D')setChartPeriod('1D',b);}); }
            if (e.key === 'Escape') closeStockDetail();
        }

        // Keyboard shortcut hint toast
        if (e.key === '?' && !inInput) {
            showTradeToast('INFO',0,'Shortcuts: B=Buy S=Sell 1=1D D=Daily Esc=Close',0,true);
        }
    });

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   EARNINGS + NEWS MARKERS ON CHART
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function getEarningsMarkers(symbol) {
        // Simulated earnings dates (one per quarter, backdated)
        const now = Date.now();
        const q = 90 * 86400000;
        return [
            { ts: now - q,     label:'Q3E', color:'#f59e0b' },
            { ts: now - 2*q,   label:'Q2E', color:'#f59e0b' },
            { ts: now - 3*q,   label:'Q1E', color:'#f59e0b' },
            { ts: now - 4*q,   label:'Q4E', color:'#a78bfa' },
        ];
    }

    // Patch drawCandlesFallback to overlay earnings markers
    const _origDrawFallback = drawCandlesFallback;
    drawCandlesFallback = function(canvas, candles, tc, overlayDatasets, period) {
        _origDrawFallback(canvas, candles, tc, overlayDatasets, period);
        if (!detailStock || !canvas._meta) return;
        const { PAD, toX, cW, H, W } = canvas._meta;
        const ctx = canvas.getContext('2d');
        const markers = getEarningsMarkers(detailStock.symbol);
        const earliest = candles[0]?.x;
        const latest   = candles[candles.length-1]?.x;
        markers.forEach(m => {
            if (m.ts < earliest || m.ts > latest) return;
            // Find closest candle
            const idx = candles.reduce((ci,c,i)=>Math.abs(c.x-m.ts)<Math.abs(candles[ci].x-m.ts)?i:ci,0);
            const x = toX(idx);
            ctx.save();
            ctx.strokeStyle = m.color;
            ctx.lineWidth = 1;
            ctx.setLineDash([2,3]);
            ctx.beginPath(); ctx.moveTo(x, PAD.top); ctx.lineTo(x, H-PAD.bottom); ctx.stroke();
            ctx.setLineDash([]);
            ctx.fillStyle = m.color;
            ctx.font = 'bold 8px sans-serif'; ctx.textAlign = 'center';
            ctx.fillText(m.label, x, PAD.top - 3);
            ctx.restore();
        });
    };

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   RENDER RISK METER in stock detail page
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origOpenStockDetailRisk = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetailRisk(stock);
        setTimeout(() => renderRiskMeter(stock), 200);
    };

    function renderRiskMeter(stock) {
        const container = document.getElementById('analystRatings');
        if (!container) return;
        const risk = calcRiskScore(stock);
        const vol  = calcVolatilityMeter(stock);
        // Append below existing analyst content
        const existing = container.querySelector('.risk-meter-row');
        if (existing) existing.remove();
        const div = document.createElement('div');
        div.className = 'risk-meter-row';
        div.style.cssText = 'margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.07);display:grid;grid-template-columns:1fr 1fr;gap:10px;';
        div.innerHTML = `
            <div>
                <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">âš¡ Risk Score</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                        <div style="height:100%;width:${risk.score}%;background:${risk.color};border-radius:3px;transition:width 0.5s;"></div>
                    </div>
                    <span style="font-size:11px;font-weight:700;color:${risk.color};min-width:30px;">${risk.score}</span>
                </div>
                <div style="font-size:10px;color:${risk.color};margin-top:3px;">${risk.label}</div>
            </div>
            <div>
                <div style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;margin-bottom:6px;">ğŸ“Š Volatility</div>
                <div style="display:flex;align-items:center;gap:8px;">
                    <div style="flex:1;height:6px;background:rgba(255,255,255,0.08);border-radius:3px;overflow:hidden;">
                        <div style="height:100%;width:${vol.pct}%;background:#a78bfa;border-radius:3px;transition:width 0.5s;"></div>
                    </div>
                    <span style="font-size:11px;font-weight:700;color:#a78bfa;min-width:30px;">${Math.abs(stock.change).toFixed(1)}%</span>
                </div>
                <div style="font-size:10px;color:#a78bfa;margin-top:3px;">${vol.label} today</div>
            </div>`;
        container.appendChild(div);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   "WHY DID THIS STOCK MOVE?" BUTTON
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    const _origRenderDetailNews = renderDetailNews;
    renderDetailNews = function(symbol) {
        _origRenderDetailNews(symbol);
        // Append "Why did this move?" button if we have a change
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const dn = document.getElementById('detailNews');
        if (!dn) return;
        // Remove existing why-btn
        dn.querySelector('.why-btn-row')?.remove();
        const div = document.createElement('div');
        div.className = 'why-btn-row';
        div.style.cssText = 'margin-top:8px;';
        div.innerHTML = `<button onclick="showWhyMoved('${symbol}')" style="width:100%;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.2);color:#93c5fd;font-size:11px;font-weight:700;padding:8px;border-radius:7px;cursor:pointer;" onmouseover="this.style.background='rgba(96,165,250,0.14)'" onmouseout="this.style.background='rgba(96,165,250,0.08)'">ğŸ’¡ Why did ${symbol} move today?</button>`;
        dn.appendChild(div);
    };

    function showWhyMoved(symbol) {
        const stock = getStockBySymbol(symbol);
        if (!stock) return;
        const isPos = stock.change >= 0;
        const reasons = isPos ? [
            `${symbol} gained ${stock.change.toFixed(2)}% â€” possibly driven by sector rotation into ${stock.sector||'this sector'}.`,
            `Analyst upgrades or positive earnings guidance may be driving bullish momentum.`,
            `Broad market strength (S&P 500 up today) is lifting most large-caps.`,
            `Technical breakout above key resistance level â€” momentum traders following.`
        ] : [
            `${symbol} dropped ${Math.abs(stock.change).toFixed(2)}% â€” profit-taking after recent gains.`,
            `Macro headwinds: rising yields or USD strength pressuring growth stocks today.`,
            `Weak sector sentiment in ${stock.sector||'this space'} following peer earnings misses.`,
            `Risk-off environment ahead of economic data â€” investors rotating to safety.`
        ];
        const msg = reasons[Math.floor(Math.random()*reasons.length)];
        // Display as a temporary overlay card
        const dn = document.getElementById('detailNews');
        if (!dn) return;
        const existing = dn.querySelector('.why-result');
        if (existing) existing.remove();
        const d = document.createElement('div');
        d.className='why-result';
        d.style.cssText=`background:rgba(96,165,250,0.06);border:1px solid rgba(96,165,250,0.18);border-radius:8px;padding:10px 12px;margin-top:6px;font-size:11px;color:#bfdbfe;line-height:1.6;animation:slideUp 0.3s ease-out;`;
        d.innerHTML = `<strong style="color:#93c5fd;">ğŸ’¡ Analysis:</strong> ${msg} <em style="display:block;margin-top:4px;color:#6868a0;font-size:10px;">Note: This is a simulated analysis for educational purposes.</em>`;
        dn.appendChild(d);
    }

    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    //   PORTFOLIO ANALYTICS UPGRADES
    //   Win rate, avg hold time, Sharpe ratio, vs S&P
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function calcPortfolioStats() {
        if (!transactions || transactions.length < 2) return null;
        const sells = transactions.filter(t => t.type==='SELL');
        if (sells.length === 0) return null;
        const wins = sells.filter(t => {
            const buy = transactions.filter(b=>b.type==='BUY'&&b.symbol===t.symbol&&b.ts<t.ts);
            if (!buy.length) return false;
            const avgBuy = buy.reduce((s,b)=>s+b.price*b.qty,0)/buy.reduce((s,b)=>s+b.qty,0);
            return t.price > avgBuy;
        });
        const winRate = (wins.length / sells.length * 100).toFixed(1);
        // Avg hold time (ms)
        let holdTimes = [];
        sells.forEach(s => {
            const buy = transactions.filter(b=>b.type==='BUY'&&b.symbol===s.symbol&&b.ts<s.ts);
            if (buy.length) holdTimes.push(s.ts - buy[buy.length-1].ts);
        });
        const avgHold = holdTimes.length ? holdTimes.reduce((a,b)=>a+b,0)/holdTimes.length : 0;
        const avgHoldStr = avgHold > 86400000 ? (avgHold/86400000).toFixed(1)+'d' : (avgHold/3600000).toFixed(1)+'h';
        return { winRate, avgHoldStr, tradeCount:sells.length };
    }

    // Patch renderAnalytics to include stats
    const _origRenderAnalytics = renderAnalytics;
    renderAnalytics = function() {
        _origRenderAnalytics();
        const stats = calcPortfolioStats();
        const statsEl = document.getElementById('portfolioStats');
        if (!statsEl || !stats) return;
        statsEl.innerHTML = `
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-top:8px;padding-top:8px;border-top:1px solid rgba(255,255,255,0.04);">
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Win Rate</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#4ade80;">${stats.winRate}%</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Avg Hold</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">${stats.avgHoldStr}</div>
                </div>
                <div style="text-align:center;">
                    <div style="font-size:9px;color:#6868a0;text-transform:uppercase;margin-bottom:2px;">Trades</div>
                    <div style="font-family:var(--v-mono);font-size:0.875rem;color:#f0f0fa;">${stats.tradeCount}</div>
                </div>
            </div>`;
        statsEl.style.display = 'block';
    };

    let sipPlans = [];       // all active plans
    let sipHistory = [];     // execution log
    let _sipIntervalId = null;

    // ETF catalogue
    const ETF_CATALOGUE = [
        { symbol:'SPY',  name:'S&P 500 ETF (SPDR)',         price:590,  expense:0.0945 },
        { symbol:'QQQ',  name:'Nasdaq-100 ETF (Invesco)',    price:500,  expense:0.20  },
        { symbol:'VTI',  name:'Total Stock Mkt ETF (Vanguard)', price:285, expense:0.03 },
        { symbol:'VOO',  name:'Vanguard S&P 500 ETF',        price:540,  expense:0.03  },
        { symbol:'IWM',  name:'Russell 2000 ETF (iShares)',  price:228,  expense:0.19  },
        { symbol:'DIA',  name:'Dow Jones ETF (SPDR)',        price:440,  expense:0.16  },
        { symbol:'GLD',  name:'Gold ETF (SPDR)',             price:250,  expense:0.40  },
        { symbol:'TLT',  name:'20yr Treasury ETF (iShares)', price:94,   expense:0.15  },
        { symbol:'ARKK', name:'ARK Innovation ETF',          price:72,   expense:0.75  },
        { symbol:'XLK',  name:'Technology Select SPDR ETF',  price:226,  expense:0.09  },
    ];

    // Interval â†’ ms multiplier (simulated â€” 1 real second = 1 simulated day)
    const SIP_INTERVAL_MS = { daily:1000*30, weekly:1000*210, biweekly:1000*420, monthly:1000*900 };

    // â”€â”€ Type descriptions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const SIP_TYPE_INFO = {
        stock:      'ğŸ“ˆ <b>Stock SIP</b> â€” Buy a fixed dollar amount of a specific stock at regular intervals. You always own individual shares directly. Dollar-cost averaging helps smooth out price volatility over time.',
        fractional: 'ğŸ”¬ <b>Fractional Investing</b> â€” Invest a set dollar amount regardless of share price. Receive fractional shares (e.g. 0.38 of AAPL). Perfect for high-priced stocks like BRK.B or COST.',
        etf:        'ğŸ¦ <b>ETF Auto-Invest</b> â€” Recurring investment into a diversified ETF (S&P 500, Nasdaq, etc.). Provides instant diversification like a mutual fund SIP but with stock-like liquidity.',
        drip:       'ğŸ’° <b>DRIP (Dividend Reinvestment)</b> â€” Automatically reinvest dividends received from dividend-paying stocks back into more shares. Passive compounding with zero extra cash outlay.',
    };

    // â”€â”€ Open/close modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function openSIP(stock) {
        const modal = document.getElementById('sipModal');
        if (!modal) return;
        modal.style.display = 'block';
        // Pre-fill from current stock
        const sym = stock ? stock.symbol : '';
        document.getElementById('sipSymbol').value = sym;
        document.getElementById('sipAmount').value = 100;
        document.getElementById('sipFreq').value = 'weekly';
        document.getElementById('sipMaxTotal').value = '';
        document.getElementById('sipError').style.display = 'none';
        setSIPType('stock');
        updateSIPProjection();
    }
    function closeSIP() {
        const modal = document.getElementById('sipModal');
        if (modal) modal.style.display = 'none';
    }

    // â”€â”€ SIP type tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let _sipCurrentType = 'stock';

    function setSIPType(type) {
        _sipCurrentType = type;
        ['stock','fractional','etf','drip'].forEach(t => {
            const btn = document.getElementById('sipTab-'+t);
            if (!btn) return;
            if (t === type) {
                btn.style.background = 'rgba(212,168,75,0.1)';
                btn.style.color      = 'var(--v-gold)';
                btn.style.borderBottom = '2px solid var(--v-gold)';
                btn.style.fontWeight = '700';
            } else {
                btn.style.background = 'transparent';
                btn.style.color      = '#8888a8';
                btn.style.borderBottom = '2px solid transparent';
                btn.style.fontWeight = '600';
            }
        });
        // Show/hide DRIP toggle
        const dripGroup = document.getElementById('sipDripToggleGroup');
        if (dripGroup) dripGroup.style.display = type === 'drip' ? 'block' : 'none';
        // Swap ETF selector
        const symGroup = document.getElementById('sipSymbolGroup');
        if (type === 'etf') {
            symGroup.innerHTML = `
                <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">ETF</label>
                <select id="sipSymbol" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;">
                    ${ETF_CATALOGUE.map(e=>`<option value="${e.symbol}">${e.symbol} â€” ${e.name}</option>`).join('')}
                </select>`;
        } else {
            symGroup.innerHTML = `
                <label style="font-size:9px;font-weight:700;color:#6868a0;text-transform:uppercase;letter-spacing:0.06em;display:block;margin-bottom:5px;">Symbol</label>
                <input id="sipSymbol" placeholder="e.g. AAPL" style="width:100%;background:#1a1a28;border:1px solid rgba(255,255,255,0.1);border-radius:7px;padding:8px 10px;font-size:12px;color:#e0e0f5;outline:none;font-family:var(--v-mono);" onfocus="this.style.borderColor='var(--v-gold)'" onblur="this.style.borderColor='rgba(255,255,255,0.1)'">`;
            if (detailStock) document.getElementById('sipSymbol').value = detailStock.symbol;
        }
        // Update label
        const amtLabel = document.getElementById('sipAmountLabel');
        if (amtLabel) amtLabel.textContent = type === 'drip' ? 'Dividend Yield est. (%)' : 'Amount ($)';
        // Show banner
        const banner = document.getElementById('sipTypeBanner');
        if (banner) banner.innerHTML = SIP_TYPE_INFO[type] || '';
        updateSIPProjection();
    }

    // â”€â”€ DCA projection â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function updateSIPProjection() {
        const amount = parseFloat(document.getElementById('sipAmount')?.value || 0);
        const freq   = document.getElementById('sipFreq')?.value || 'weekly';
        const sym    = document.getElementById('sipSymbol')?.value?.trim().toUpperCase();
        const freqPerYear = { daily:252, weekly:52, biweekly:26, monthly:12 }[freq] || 52;
        const freq3m = Math.ceil(freqPerYear/4);

        const proj3m  = document.getElementById('sipProj3m');
        const proj1y  = document.getElementById('sipProj1y');
        const projSh  = document.getElementById('sipProjShares');

        if (!amount || amount <= 0) {
            if(proj3m) proj3m.textContent='â€”';
            if(proj1y) proj1y.textContent='â€”';
            if(projSh) projSh.textContent='â€”';
            return;
        }

        const total3m = amount * freq3m;
        const total1y = amount * freqPerYear;

        let price = 100;
        if (_sipCurrentType === 'etf') {
            const etf = ETF_CATALOGUE.find(e=>e.symbol===sym);
            if (etf) price = etf.price;
        } else {
            const stock = sym ? getStockBySymbol(sym) : null;
            if (stock) price = stock.price;
        }

        const shares1y = total1y / price;

        if(proj3m) proj3m.textContent = '$'+total3m.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
        if(proj1y) proj1y.textContent = '$'+total1y.toLocaleString(undefined,{minimumFractionDigits:0,maximumFractionDigits:0});
        if(projSh) projSh.textContent = shares1y < 1 ? shares1y.toFixed(4) : shares1y.toFixed(2);
    }

    // Attach live update to amount/freq inputs
    setTimeout(()=>{
        ['sipAmount','sipFreq'].forEach(id=>{
            const el=document.getElementById(id);
            if(el) el.addEventListener('input', updateSIPProjection);
            if(el) el.addEventListener('change',updateSIPProjection);
        });
    }, 1000);

    // â”€â”€ Save a new SIP plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function saveSIPPlan() {
        const errEl  = document.getElementById('sipError');
        errEl.style.display = 'none';
        const sym    = (document.getElementById('sipSymbol')?.value || '').trim().toUpperCase();
        const amount = parseFloat(document.getElementById('sipAmount')?.value);
        const freq   = document.getElementById('sipFreq')?.value;
        const maxTot = parseFloat(document.getElementById('sipMaxTotal')?.value) || Infinity;
        const dripOn = document.getElementById('sipDripEnabled')?.checked ?? true;

        if (!sym) { errEl.textContent='Enter a symbol.'; errEl.style.display='block'; return; }
        if (_sipCurrentType !== 'drip' && (!amount || amount < 1)) {
            errEl.textContent='Enter a valid dollar amount (min $1).'; errEl.style.display='block'; return;
        }

        // Validate symbol
        let stockRef = null;
        if (_sipCurrentType === 'etf') {
            const etf = ETF_CATALOGUE.find(e=>e.symbol===sym);
            if (!etf) { errEl.textContent='ETF not found in our catalogue.'; errEl.style.display='block'; return; }
            // Add ETF as a simulated stock if needed
            if (!getStockBySymbol(sym)) {
                stocks.push({ symbol:sym, name:etf.name, price:etf.price, change:0.1, pe:20, mktCap:'â€”', div:'0.00%', divAmt:0, wkHigh:etf.price*1.2, wkLow:etf.price*0.8, sector:'ETF' });
            }
            stockRef = getStockBySymbol(sym);
        } else if (_sipCurrentType === 'drip') {
            stockRef = getStockBySymbol(sym);
            if (!stockRef) { errEl.textContent=`Symbol "${sym}" not found.`; errEl.style.display='block'; return; }
            if (!stockRef.divAmt || stockRef.divAmt <= 0) {
                errEl.textContent=`${sym} doesn't pay a dividend. DRIP requires a dividend-paying stock.`;
                errEl.style.display='block'; return;
            }
        } else {
            stockRef = getStockBySymbol(sym);
            if (!stockRef) { errEl.textContent=`Symbol "${sym}" not found. Use the screener to find valid tickers.`; errEl.style.display='block'; return; }
        }

        const plan = {
            id: 'sip_'+Date.now(),
            type: _sipCurrentType,
            sym, amount, freq, maxTotal: maxTot,
            dripOn, active: true,
            totalInvested: 0, execCount: 0,
            created: Date.now(),
            nextExec: Date.now() + (SIP_INTERVAL_MS[freq] || 30000),
        };

        sipPlans.push(plan);
        renderSIPDetailPanel(sym);
        renderSIPSidebarWidget();
        closeSIP();
        showTradeToast('INFO', 0, `ğŸ“… SIP Plan: ${sym} ${freq} $${amount}`, 0, false);
        startSIPEngine();
    }

    // â”€â”€ Render SIP panel on stock detail page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSIPDetailPanel(sym) {
        const listEl = document.getElementById('sipDetailList');
        if (!listEl) return;
        const plans = sipPlans.filter(p=>p.sym===sym&&p.active);
        if (plans.length === 0) {
            listEl.innerHTML = '<div style="text-align:center;padding:6px 0;font-style:italic;color:#6868a0;">No active SIP plans for this stock.</div>';
            return;
        }
        const freqLabel = { daily:'Daily', weekly:'Weekly', biweekly:'Bi-weekly', monthly:'Monthly' };
        const typeEmoji = { stock:'ğŸ“ˆ', fractional:'ğŸ”¬', etf:'ğŸ¦', drip:'ğŸ’°' };
        listEl.innerHTML = plans.map(p => {
            const totalSpent = p.totalInvested;
            const stock = getStockBySymbol(p.sym);
            const currentVal = stock ? (totalSpent / (stock.price || 1)) * stock.price : totalSpent;
            const roi = totalSpent > 0 ? ((currentVal-totalSpent)/totalSpent*100).toFixed(1) : '0.0';
            return `<div style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:10px 12px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-size:11px;font-weight:700;color:#e0e0f5;">${typeEmoji[p.type]||''} ${freqLabel[p.freq]||p.freq} Â· $${p.amount}</div>
                    <div style="font-size:10px;color:#8888a8;margin-top:2px;">Invested: $${p.totalInvested.toFixed(2)} Â· ${p.execCount} executions</div>
                </div>
                <button onclick="cancelSIPPlan('${p.id}')" style="font-size:10px;color:#8888a8;background:none;border:1px solid rgba(255,255,255,0.08);padding:3px 8px;border-radius:5px;cursor:pointer;" onmouseover="this.style.color='#f87171';this.style.borderColor='rgba(239,68,68,0.3)'" onmouseout="this.style.color='#8888a8';this.style.borderColor='rgba(255,255,255,0.08)'">Cancel</button>
            </div>`;
        }).join('');
        // Update DCA stats
        const statsEl = document.getElementById('sipDcaStats');
        if (statsEl) statsEl.style.display = plans.length > 0 ? 'grid' : 'none';
        const stock = getStockBySymbol(sym);
        const totalInv = plans.reduce((a,p)=>a+p.totalInvested,0);
        const totalExec = plans.reduce((a,p)=>a+p.execCount,0);
        const avg = stock && totalExec > 0 ? (totalInv / (plans.reduce((a,p)=>a+(p.execCount),0)||1)).toFixed(2) : 'â€”';
        const avgEl=document.getElementById('sipAvgCost'); if(avgEl) avgEl.textContent = avg!=='â€”'?'$'+avg:'â€”';
        const invEl=document.getElementById('sipTotalInvested'); if(invEl) invEl.textContent = '$'+totalInv.toFixed(0);
        const excEl=document.getElementById('sipExecCount'); if(excEl) excEl.textContent = totalExec;
    }

    // â”€â”€ Render SIP sidebar widget â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderSIPSidebarWidget() {
        const el = document.getElementById('sipSidebarWidget');
        if (!el) return;
        const active = sipPlans.filter(p=>p.active);
        if (active.length === 0) {
            el.innerHTML = '<div style="font-size:11px;color:#6868a0;text-align:center;padding:4px 0;font-style:italic;">No active SIP plans.</div>';
            return;
        }
        const typeEmoji = { stock:'ğŸ“ˆ', fractional:'ğŸ”¬', etf:'ğŸ¦', drip:'ğŸ’°' };
        el.innerHTML = active.slice(0,4).map(p => {
            const pct = p.maxTotal < Infinity ? Math.min(100,(p.totalInvested/p.maxTotal*100)).toFixed(0) : null;
            return `<div style="display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.04);">
                <div style="font-size:11px;">
                    <span style="font-weight:700;color:#e0e0f5;">${typeEmoji[p.type]||''} ${p.sym}</span>
                    <span style="color:#8888a8;font-size:10px;"> $${p.amount} ${p.freq}</span>
                </div>
                <div style="text-align:right;font-size:10px;">
                    ${pct!=null?`<div style="color:#6868a0;">${pct}% used</div>`:''}
                    <div style="color:#4ade80;">$${p.totalInvested.toFixed(0)} invested</div>
                </div>
            </div>`;
        }).join('');
    }

    // â”€â”€ SIP execution engine â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function startSIPEngine() {
        if (_sipIntervalId) return; // already running
        _sipIntervalId = setInterval(executeDueSIPs, 5000); // check every 5s
    }

    function executeDueSIPs() {
        const now = Date.now();
        let didExecute = false;

        sipPlans.forEach(plan => {
            if (!plan.active) return;
            if (now < plan.nextExec) return;

            const stock = getStockBySymbol(plan.sym);
            if (!stock) return;

            // Check max total
            if (plan.totalInvested >= plan.maxTotal) {
                plan.active = false;
                showTradeToast('INFO', 0, `ğŸ“… SIP for ${plan.sym} reached max total â€” completed`, 0, false);
                return;
            }

            const price = stock.price;
            let dollarAmount = plan.amount;

            if (plan.type === 'drip') {
                // Simulate quarterly dividend payout
                const owned = portfolio[plan.sym] || 0;
                if (owned === 0) { reschedule(plan); return; }
                const divAmt = (stock.divAmt || 0) * owned;
                if (divAmt <= 0) { reschedule(plan); return; }
                dollarAmount = divAmt;
            }

            // Fractional shares â€” dollar amount always goes through
            const fractionalShares = dollarAmount / price; // e.g. 0.38 shares
            const wholeShares = plan.type === 'stock' ? Math.floor(fractionalShares) : fractionalShares;
            if (wholeShares <= 0 && plan.type === 'stock') {
                // Not enough for even 1 share â€” accumulate and skip
                showTradeToast('INFO', 0, `SIP: ${plan.sym} insufficient for 1 share at $${price.toFixed(2)} â€” accumulating`, 0, false);
                reschedule(plan);
                return;
            }

            const actualShares = plan.type === 'stock' ? wholeShares : fractionalShares;
            const actualCost   = actualShares * price;

            if (cash < actualCost) {
                showTradeToast('INFO', 0, `ğŸ“… SIP ${plan.sym}: insufficient cash â€” paused`, 0, false);
                plan.active = false;
                return;
            }

            // Execute
            cash -= actualCost;
            portfolio[plan.sym] = (portfolio[plan.sym] || 0) + actualShares;
            if (!costBasis[plan.sym]) costBasis[plan.sym] = [];
            costBasis[plan.sym].push({ qty:actualShares, price });
            plan.totalInvested += actualCost;
            plan.execCount++;
            plan.lastExecPrice = price;

            const note = `ğŸ“… SIP (${plan.type}) Â· ${plan.freq}`;
            transactions.unshift({ type:'BUY', symbol:plan.sym, qty:+actualShares.toFixed(6), price, ts:Date.now(), note });
            sipHistory.push({ planId:plan.id, sym:plan.sym, shares:actualShares, price, cost:actualCost, ts:Date.now() });

            showTradeToast('BUY', +actualShares.toFixed(4), plan.sym, price, false);
            updateUI();
            saveUserData(true);
            didExecute = true;

            reschedule(plan);
        });

        if (didExecute) {
            if (detailStock) renderSIPDetailPanel(detailStock.symbol);
            renderSIPSidebarWidget();
        }
    }

    function reschedule(plan) {
        plan.nextExec = Date.now() + (SIP_INTERVAL_MS[plan.freq] || 900000);
    }

    // â”€â”€ Cancel a plan â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function cancelSIPPlan(id) {
        const plan = sipPlans.find(p=>p.id===id);
        if (!plan) return;
        plan.active = false;
        if (detailStock) renderSIPDetailPanel(detailStock.symbol);
        renderSIPSidebarWidget();
        showTradeToast('INFO', 0, `ğŸ“… SIP for ${plan.sym} cancelled`, 0, false);
    }

    // â”€â”€ Hook openStockDetail to render SIP panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const _origOpenStockDetail = openStockDetail;
    openStockDetail = function(stock) {
        _origOpenStockDetail(stock);
        renderSIPDetailPanel(stock.symbol);
    };

    // â”€â”€ Init â”€â”€
    initMarket();  // pre-load stock data
    showHomepage(); // start on homepage

</script>
</body>
</html>
